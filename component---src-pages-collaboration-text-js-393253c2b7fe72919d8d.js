(window.webpackJsonp=window.webpackJsonp||[]).push([[10,7],{"+80P":function(e,t,n){"use strict";function r(e){return Array.prototype.slice.call(arguments,1).forEach((function(t){t&&Object.keys(t).forEach((function(n){e[n]=t[n]}))})),e}function i(e){return Object.prototype.toString.call(e)}function o(e){return"[object Function]"===i(e)}function a(e){return e.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}n("zGcK"),n("MIFh"),n("sc67"),n("sPse"),n("OeI1"),n("AqHK"),n("HQhv"),n("Ll4R"),n("klQ5"),n("U6Bt"),n("sC2a"),n("q8oJ"),n("C9fy"),n("rzGZ"),n("Dq+y"),n("8npG"),n("Ggvi"),n("JHok");var s={fuzzyLink:!0,fuzzyEmail:!0,fuzzyIP:!1};var u={"http:":{validate:function(e,t,n){var r=e.slice(t);return n.re.http||(n.re.http=new RegExp("^\\/\\/"+n.re.src_auth+n.re.src_host_port_strict+n.re.src_path,"i")),n.re.http.test(r)?r.match(n.re.http)[0].length:0}},"https:":"http:","ftp:":"http:","//":{validate:function(e,t,n){var r=e.slice(t);return n.re.no_http||(n.re.no_http=new RegExp("^"+n.re.src_auth+"(?:localhost|(?:(?:"+n.re.src_domain+")\\.)+"+n.re.src_domain_root+")"+n.re.src_port+n.re.src_host_terminator+n.re.src_path,"i")),n.re.no_http.test(r)?t>=3&&":"===e[t-3]?0:t>=3&&"/"===e[t-3]?0:r.match(n.re.no_http)[0].length:0}},"mailto:":{validate:function(e,t,n){var r=e.slice(t);return n.re.mailto||(n.re.mailto=new RegExp("^"+n.re.src_email_name+"@"+n.re.src_host_strict,"i")),n.re.mailto.test(r)?r.match(n.re.mailto)[0].length:0}}},c="a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]",l="biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|рф".split("|");function h(e){var t=e.re=n("sRdV")(e.__opts__),r=e.__tlds__.slice();function s(e){return e.replace("%TLDS%",t.src_tlds)}e.onCompile(),e.__tlds_replaced__||r.push(c),r.push(t.src_xn),t.src_tlds=r.join("|"),t.email_fuzzy=RegExp(s(t.tpl_email_fuzzy),"i"),t.link_fuzzy=RegExp(s(t.tpl_link_fuzzy),"i"),t.link_no_ip_fuzzy=RegExp(s(t.tpl_link_no_ip_fuzzy),"i"),t.host_fuzzy_test=RegExp(s(t.tpl_host_fuzzy_test),"i");var u=[];function l(e,t){throw new Error('(LinkifyIt) Invalid schema "'+e+'": '+t)}e.__compiled__={},Object.keys(e.__schemas__).forEach((function(t){var n=e.__schemas__[t];if(null!==n){var r={validate:null,link:null};if(e.__compiled__[t]=r,"[object Object]"===i(n))return!function(e){return"[object RegExp]"===i(e)}(n.validate)?o(n.validate)?r.validate=n.validate:l(t,n):r.validate=function(e){return function(t,n){var r=t.slice(n);return e.test(r)?r.match(e)[0].length:0}}(n.validate),void(o(n.normalize)?r.normalize=n.normalize:n.normalize?l(t,n):r.normalize=function(e,t){t.normalize(e)});!function(e){return"[object String]"===i(e)}(n)?l(t,n):u.push(t)}})),u.forEach((function(t){e.__compiled__[e.__schemas__[t]]&&(e.__compiled__[t].validate=e.__compiled__[e.__schemas__[t]].validate,e.__compiled__[t].normalize=e.__compiled__[e.__schemas__[t]].normalize)})),e.__compiled__[""]={validate:null,normalize:function(e,t){t.normalize(e)}};var h=Object.keys(e.__compiled__).filter((function(t){return t.length>0&&e.__compiled__[t]})).map(a).join("|");e.re.schema_test=RegExp("(^|(?!_)(?:[><｜]|"+t.src_ZPCc+"))("+h+")","i"),e.re.schema_search=RegExp("(^|(?!_)(?:[><｜]|"+t.src_ZPCc+"))("+h+")","ig"),e.re.pretest=RegExp("("+e.re.schema_test.source+")|("+e.re.host_fuzzy_test.source+")|@","i"),function(e){e.__index__=-1,e.__text_cache__=""}(e)}function d(e,t){var n=e.__index__,r=e.__last_index__,i=e.__text_cache__.slice(n,r);this.schema=e.__schema__.toLowerCase(),this.index=n+t,this.lastIndex=r+t,this.raw=i,this.text=i,this.url=i}function p(e,t){var n=new d(e,t);return e.__compiled__[n.schema].normalize(n,e),n}function f(e,t){if(!(this instanceof f))return new f(e,t);var n;t||(n=e,Object.keys(n||{}).reduce((function(e,t){return e||s.hasOwnProperty(t)}),!1)&&(t=e,e={})),this.__opts__=r({},s,t),this.__index__=-1,this.__last_index__=-1,this.__schema__="",this.__text_cache__="",this.__schemas__=r({},u,e),this.__compiled__={},this.__tlds__=l,this.__tlds_replaced__=!1,this.re={},h(this)}f.prototype.add=function(e,t){return this.__schemas__[e]=t,h(this),this},f.prototype.set=function(e){return this.__opts__=r(this.__opts__,e),this},f.prototype.test=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return!1;var t,n,r,i,o,a,s,u;if(this.re.schema_test.test(e))for((s=this.re.schema_search).lastIndex=0;null!==(t=s.exec(e));)if(i=this.testSchemaAt(e,t[2],s.lastIndex)){this.__schema__=t[2],this.__index__=t.index+t[1].length,this.__last_index__=t.index+t[0].length+i;break}return this.__opts__.fuzzyLink&&this.__compiled__["http:"]&&(u=e.search(this.re.host_fuzzy_test))>=0&&(this.__index__<0||u<this.__index__)&&null!==(n=e.match(this.__opts__.fuzzyIP?this.re.link_fuzzy:this.re.link_no_ip_fuzzy))&&(o=n.index+n[1].length,(this.__index__<0||o<this.__index__)&&(this.__schema__="",this.__index__=o,this.__last_index__=n.index+n[0].length)),this.__opts__.fuzzyEmail&&this.__compiled__["mailto:"]&&e.indexOf("@")>=0&&null!==(r=e.match(this.re.email_fuzzy))&&(o=r.index+r[1].length,a=r.index+r[0].length,(this.__index__<0||o<this.__index__||o===this.__index__&&a>this.__last_index__)&&(this.__schema__="mailto:",this.__index__=o,this.__last_index__=a)),this.__index__>=0},f.prototype.pretest=function(e){return this.re.pretest.test(e)},f.prototype.testSchemaAt=function(e,t,n){return this.__compiled__[t.toLowerCase()]?this.__compiled__[t.toLowerCase()].validate(e,n,this):0},f.prototype.match=function(e){var t=0,n=[];this.__index__>=0&&this.__text_cache__===e&&(n.push(p(this,t)),t=this.__last_index__);for(var r=t?e.slice(t):e;this.test(r);)n.push(p(this,t)),r=r.slice(this.__last_index__),t+=this.__last_index__;return n.length?n:null},f.prototype.tlds=function(e,t){return e=Array.isArray(e)?e:[e],t?(this.__tlds__=this.__tlds__.concat(e).sort().filter((function(e,t,n){return e!==n[t-1]})).reverse(),h(this),this):(this.__tlds__=e.slice(),this.__tlds_replaced__=!0,h(this),this)},f.prototype.normalize=function(e){e.schema||(e.url="http://"+e.url),"mailto:"!==e.schema||/^mailto:/i.test(e.url)||(e.url="mailto:"+e.url)},f.prototype.onCompile=function(){},e.exports=f},"+ar0":function(e,t,n){var r=n("P8UN");r(r.S+r.F*!n("QPJK"),"Object",{defineProperties:n("YmeT")})},"1/Ks":function(e,t,n){"use strict";n("EU/P")("trimLeft",(function(e){return function(){return e(this,1)}}),"trimStart")},"25EJ":function(e,t){e.exports="require(\"core-js/modules/es6.regexp.split\");require(\"core-js/modules/es6.string.strike\");require(\"core-js/modules/es6.string.bold\");require(\"core-js/modules/es6.regexp.match\");require(\"core-js/modules/es6.regexp.constructor\");require(\"core-js/modules/es6.array.find\");require(\"core-js/modules/es6.array.sort\");require(\"core-js/modules/es6.number.constructor\");require(\"core-js/modules/es6.date.to-json\");require(\"core-js/modules/es6.regexp.to-string\");require(\"core-js/modules/es6.object.to-string\");require(\"core-js/modules/es6.regexp.replace\");/* eslint-disable */ /*!\n * Firepad is an open-source, collaborative code and text editor. It was designed\n * to be embedded inside larger applications. Since it uses Firebase as a backend,\n * it requires no server-side code and can be added to any web app simply by\n * including a couple JavaScript files.\n *\n * Firepad 1.4.0\n * http://www.firepad.io/\n * License: MIT\n * Copyright: 2014 Firebase\n * With code from ot.js (Copyright 2012-2013 Tim Baumann)\n */(function(name,definition,context){//try CommonJS, then AMD (require.js), then use global.\nif(typeof module!='undefined'&&module.exports)module.exports=definition();else if(typeof context['define']=='function'&&context['define']['amd'])define(definition);else context[name]=definition();})('Firepad',function(){var firepad=firepad||{};firepad.utils={};firepad.utils.makeEventEmitter=function(clazz,opt_allowedEVents){clazz.prototype.allowedEvents_=opt_allowedEVents;clazz.prototype.on=function(eventType,callback,context){this.validateEventType_(eventType);this.eventListeners_=this.eventListeners_||{};this.eventListeners_[eventType]=this.eventListeners_[eventType]||[];this.eventListeners_[eventType].push({callback:callback,context:context});};clazz.prototype.off=function(eventType,callback){this.validateEventType_(eventType);this.eventListeners_=this.eventListeners_||{};var listeners=this.eventListeners_[eventType]||[];for(var i=0;i<listeners.length;i++){if(listeners[i].callback===callback){listeners.splice(i,1);return;}}};clazz.prototype.trigger=function(eventType/*, args ... */){this.eventListeners_=this.eventListeners_||{};var listeners=this.eventListeners_[eventType]||[];for(var i=0;i<listeners.length;i++){listeners[i].callback.apply(listeners[i].context,Array.prototype.slice.call(arguments,1));}};clazz.prototype.validateEventType_=function(eventType){if(this.allowedEvents_){var allowed=false;for(var i=0;i<this.allowedEvents_.length;i++){if(this.allowedEvents_[i]===eventType){allowed=true;break;}}if(!allowed){throw new Error('Unknown event \"'+eventType+'\"');}}};};firepad.utils.elt=function(tag,content,attrs){var e=document.createElement(tag);if(typeof content===\"string\"){firepad.utils.setTextContent(e,content);}else if(content){for(var i=0;i<content.length;++i){e.appendChild(content[i]);}}for(var attr in attrs||{}){e.setAttribute(attr,attrs[attr]);}return e;};firepad.utils.setTextContent=function(e,str){e.innerHTML=\"\";e.appendChild(document.createTextNode(str));};firepad.utils.on=function(emitter,type,f,capture){if(emitter.addEventListener){emitter.addEventListener(type,f,capture||false);}else if(emitter.attachEvent){emitter.attachEvent(\"on\"+type,f);}};firepad.utils.off=function(emitter,type,f,capture){if(emitter.removeEventListener){emitter.removeEventListener(type,f,capture||false);}else if(emitter.detachEvent){emitter.detachEvent(\"on\"+type,f);}};firepad.utils.preventDefault=function(e){if(e.preventDefault){e.preventDefault();}else{e.returnValue=false;}};firepad.utils.stopPropagation=function(e){if(e.stopPropagation){e.stopPropagation();}else{e.cancelBubble=true;}};firepad.utils.stopEvent=function(e){firepad.utils.preventDefault(e);firepad.utils.stopPropagation(e);};firepad.utils.stopEventAnd=function(fn){return function(e){fn(e);firepad.utils.stopEvent(e);return false;};};firepad.utils.trim=function(str){return str.replace(/^\\s+/g,'').replace(/\\s+$/g,'');};firepad.utils.stringEndsWith=function(str,suffix){var list=typeof suffix=='string'?[suffix]:suffix;for(var i=0;i<list.length;i++){var suffix=list[i];if(str.indexOf(suffix,str.length-suffix.length)!==-1)return true;}return false;};firepad.utils.assert=function assert(b,msg){if(!b){throw new Error(msg||\"assertion error\");}};firepad.utils.log=function(){if(typeof console!=='undefined'&&typeof console.log!=='undefined'){var args=['Firepad:'];for(var i=0;i<arguments.length;i++){args.push(arguments[i]);}console.log.apply(console,args);}};var firepad=firepad||{};firepad.Span=function(){function Span(pos,length){this.pos=pos;this.length=length;}Span.prototype.end=function(){return this.pos+this.length;};return Span;}();var firepad=firepad||{};firepad.TextOp=function(){var utils=firepad.utils;// Operation are essentially lists of ops. There are three types of ops:\n//\n// * Retain ops: Advance the cursor position by a given number of characters.\n//   Represented by positive ints.\n// * Insert ops: Insert a given string at the current cursor position.\n//   Represented by strings.\n// * Delete ops: Delete the next n characters. Represented by negative ints.\nfunction TextOp(type){this.type=type;this.chars=null;this.text=null;this.attributes=null;if(type==='insert'){this.text=arguments[1];utils.assert(typeof this.text==='string');this.attributes=arguments[2]||{};utils.assert(typeof this.attributes==='object');}else if(type==='delete'){this.chars=arguments[1];utils.assert(typeof this.chars==='number');}else if(type==='retain'){this.chars=arguments[1];utils.assert(typeof this.chars==='number');this.attributes=arguments[2]||{};utils.assert(typeof this.attributes==='object');}}TextOp.prototype.isInsert=function(){return this.type==='insert';};TextOp.prototype.isDelete=function(){return this.type==='delete';};TextOp.prototype.isRetain=function(){return this.type==='retain';};TextOp.prototype.equals=function(other){return this.type===other.type&&this.text===other.text&&this.chars===other.chars&&this.attributesEqual(other.attributes);};TextOp.prototype.attributesEqual=function(otherAttributes){for(var attr in this.attributes){if(this.attributes[attr]!==otherAttributes[attr]){return false;}}for(attr in otherAttributes){if(this.attributes[attr]!==otherAttributes[attr]){return false;}}return true;};TextOp.prototype.hasEmptyAttributes=function(){var empty=true;for(var attr in this.attributes){empty=false;break;}return empty;};return TextOp;}();var firepad=firepad||{};firepad.TextOperation=function(){'use strict';var TextOp=firepad.TextOp;var utils=firepad.utils;// Constructor for new operations.\nfunction TextOperation(){if(!this||this.constructor!==TextOperation){// => function was called without 'new'\nreturn new TextOperation();}// When an operation is applied to an input string, you can think of this as\n// if an imaginary cursor runs over the entire string and skips over some\n// parts, deletes some parts and inserts characters at some positions. These\n// actions (skip/delete/insert) are stored as an array in the \"ops\" property.\nthis.ops=[];// An operation's baseLength is the length of every string the operation\n// can be applied to.\nthis.baseLength=0;// The targetLength is the length of every string that results from applying\n// the operation on a valid input string.\nthis.targetLength=0;}TextOperation.prototype.equals=function(other){if(this.baseLength!==other.baseLength){return false;}if(this.targetLength!==other.targetLength){return false;}if(this.ops.length!==other.ops.length){return false;}for(var i=0;i<this.ops.length;i++){if(!this.ops[i].equals(other.ops[i])){return false;}}return true;};// After an operation is constructed, the user of the library can specify the\n// actions of an operation (skip/insert/delete) with these three builder\n// methods. They all return the operation for convenient chaining.\n// Skip over a given number of characters.\nTextOperation.prototype.retain=function(n,attributes){if(typeof n!=='number'||n<0){throw new Error(\"retain expects a positive integer.\");}if(n===0){return this;}this.baseLength+=n;this.targetLength+=n;attributes=attributes||{};var prevOp=this.ops.length>0?this.ops[this.ops.length-1]:null;if(prevOp&&prevOp.isRetain()&&prevOp.attributesEqual(attributes)){// The last op is a retain op with the same attributes => we can merge them into one op.\nprevOp.chars+=n;}else{// Create a new op.\nthis.ops.push(new TextOp('retain',n,attributes));}return this;};// Insert a string at the current position.\nTextOperation.prototype.insert=function(str,attributes){if(typeof str!=='string'){throw new Error(\"insert expects a string\");}if(str===''){return this;}attributes=attributes||{};this.targetLength+=str.length;var prevOp=this.ops.length>0?this.ops[this.ops.length-1]:null;var prevPrevOp=this.ops.length>1?this.ops[this.ops.length-2]:null;if(prevOp&&prevOp.isInsert()&&prevOp.attributesEqual(attributes)){// Merge insert op.\nprevOp.text+=str;}else if(prevOp&&prevOp.isDelete()){// It doesn't matter when an operation is applied whether the operation\n// is delete(3), insert(\"something\") or insert(\"something\"), delete(3).\n// Here we enforce that in this case, the insert op always comes first.\n// This makes all operations that have the same effect when applied to\n// a document of the right length equal in respect to the `equals` method.\nif(prevPrevOp&&prevPrevOp.isInsert()&&prevPrevOp.attributesEqual(attributes)){prevPrevOp.text+=str;}else{this.ops[this.ops.length-1]=new TextOp('insert',str,attributes);this.ops.push(prevOp);}}else{this.ops.push(new TextOp('insert',str,attributes));}return this;};// Delete a string at the current position.\nTextOperation.prototype['delete']=function(n){if(typeof n==='string'){n=n.length;}if(typeof n!=='number'||n<0){throw new Error(\"delete expects a positive integer or a string\");}if(n===0){return this;}this.baseLength+=n;var prevOp=this.ops.length>0?this.ops[this.ops.length-1]:null;if(prevOp&&prevOp.isDelete()){prevOp.chars+=n;}else{this.ops.push(new TextOp('delete',n));}return this;};// Tests whether this operation has no effect.\nTextOperation.prototype.isNoop=function(){return this.ops.length===0||this.ops.length===1&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes();};TextOperation.prototype.clone=function(){var clone=new TextOperation();for(var i=0;i<this.ops.length;i++){if(this.ops[i].isRetain()){clone.retain(this.ops[i].chars,this.ops[i].attributes);}else if(this.ops[i].isInsert()){clone.insert(this.ops[i].text,this.ops[i].attributes);}else{clone['delete'](this.ops[i].chars);}}return clone;};// Pretty printing.\nTextOperation.prototype.toString=function(){// map: build a new array by applying a function to every element in an old\n// array.\nvar map=Array.prototype.map||function(fn){var arr=this;var newArr=[];for(var i=0,l=arr.length;i<l;i++){newArr[i]=fn(arr[i]);}return newArr;};return map.call(this.ops,function(op){if(op.isRetain()){return\"retain \"+op.chars;}else if(op.isInsert()){return\"insert '\"+op.text+\"'\";}else{return\"delete \"+op.chars;}}).join(', ');};// Converts operation into a JSON value.\nTextOperation.prototype.toJSON=function(){var ops=[];for(var i=0;i<this.ops.length;i++){// We prefix ops with their attributes if non-empty.\nif(!this.ops[i].hasEmptyAttributes()){ops.push(this.ops[i].attributes);}if(this.ops[i].type==='retain'){ops.push(this.ops[i].chars);}else if(this.ops[i].type==='insert'){ops.push(this.ops[i].text);}else if(this.ops[i].type==='delete'){ops.push(-this.ops[i].chars);}}// Return an array with /something/ in it, since an empty array will be treated as null by Firebase.\nif(ops.length===0){ops.push(0);}return ops;};// Converts a plain JS object into an operation and validates it.\nTextOperation.fromJSON=function(ops){var o=new TextOperation();for(var i=0,l=ops.length;i<l;i++){var op=ops[i];var attributes={};if(typeof op==='object'){attributes=op;i++;op=ops[i];}if(typeof op==='number'){if(op>0){o.retain(op,attributes);}else{o['delete'](-op);}}else{utils.assert(typeof op==='string');o.insert(op,attributes);}}return o;};// Apply an operation to a string, returning a new string. Throws an error if\n// there's a mismatch between the input string and the operation.\nTextOperation.prototype.apply=function(str,oldAttributes,newAttributes){var operation=this;oldAttributes=oldAttributes||[];newAttributes=newAttributes||[];if(str.length!==operation.baseLength){throw new Error(\"The operation's base length must be equal to the string's length.\");}var newStringParts=[],j=0,k,attr;var oldIndex=0;var ops=this.ops;for(var i=0,l=ops.length;i<l;i++){var op=ops[i];if(op.isRetain()){if(oldIndex+op.chars>str.length){throw new Error(\"Operation can't retain more characters than are left in the string.\");}// Copy skipped part of the retained string.\nnewStringParts[j++]=str.slice(oldIndex,oldIndex+op.chars);// Copy (and potentially update) attributes for each char in retained string.\nfor(k=0;k<op.chars;k++){var currAttributes=oldAttributes[oldIndex+k]||{},updatedAttributes={};for(attr in currAttributes){updatedAttributes[attr]=currAttributes[attr];utils.assert(updatedAttributes[attr]!==false);}for(attr in op.attributes){if(op.attributes[attr]===false){delete updatedAttributes[attr];}else{updatedAttributes[attr]=op.attributes[attr];}utils.assert(updatedAttributes[attr]!==false);}newAttributes.push(updatedAttributes);}oldIndex+=op.chars;}else if(op.isInsert()){// Insert string.\nnewStringParts[j++]=op.text;// Insert attributes for each char.\nfor(k=0;k<op.text.length;k++){var insertedAttributes={};for(attr in op.attributes){insertedAttributes[attr]=op.attributes[attr];utils.assert(insertedAttributes[attr]!==false);}newAttributes.push(insertedAttributes);}}else{// delete op\noldIndex+=op.chars;}}if(oldIndex!==str.length){throw new Error(\"The operation didn't operate on the whole string.\");}var newString=newStringParts.join('');utils.assert(newString.length===newAttributes.length);return newString;};// Computes the inverse of an operation. The inverse of an operation is the\n// operation that reverts the effects of the operation, e.g. when you have an\n// operation 'insert(\"hello \"); skip(6);' then the inverse is 'delete(\"hello \");\n// skip(6);'. The inverse should be used for implementing undo.\nTextOperation.prototype.invert=function(str){var strIndex=0;var inverse=new TextOperation();var ops=this.ops;for(var i=0,l=ops.length;i<l;i++){var op=ops[i];if(op.isRetain()){inverse.retain(op.chars);strIndex+=op.chars;}else if(op.isInsert()){inverse['delete'](op.text.length);}else{// delete op\ninverse.insert(str.slice(strIndex,strIndex+op.chars));strIndex+=op.chars;}}return inverse;};// Compose merges two consecutive operations into one operation, that\n// preserves the changes of both. Or, in other words, for each input string S\n// and a pair of consecutive operations A and B,\n// apply(apply(S, A), B) = apply(S, compose(A, B)) must hold.\nTextOperation.prototype.compose=function(operation2){var operation1=this;if(operation1.targetLength!==operation2.baseLength){throw new Error(\"The base length of the second operation has to be the target length of the first operation\");}function composeAttributes(first,second,firstOpIsInsert){var merged={},attr;for(attr in first){merged[attr]=first[attr];}for(attr in second){if(firstOpIsInsert&&second[attr]===false){delete merged[attr];}else{merged[attr]=second[attr];}}return merged;}var operation=new TextOperation();// the combined operation\nvar ops1=operation1.clone().ops,ops2=operation2.clone().ops;var i1=0,i2=0;// current index into ops1 respectively ops2\nvar op1=ops1[i1++],op2=ops2[i2++];// current ops\nvar attributes;while(true){// Dispatch on the type of op1 and op2\nif(typeof op1==='undefined'&&typeof op2==='undefined'){// end condition: both ops1 and ops2 have been processed\nbreak;}if(op1&&op1.isDelete()){operation['delete'](op1.chars);op1=ops1[i1++];continue;}if(op2&&op2.isInsert()){operation.insert(op2.text,op2.attributes);op2=ops2[i2++];continue;}if(typeof op1==='undefined'){throw new Error(\"Cannot compose operations: first operation is too short.\");}if(typeof op2==='undefined'){throw new Error(\"Cannot compose operations: first operation is too long.\");}if(op1.isRetain()&&op2.isRetain()){attributes=composeAttributes(op1.attributes,op2.attributes);if(op1.chars>op2.chars){operation.retain(op2.chars,attributes);op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){operation.retain(op1.chars,attributes);op1=ops1[i1++];op2=ops2[i2++];}else{operation.retain(op1.chars,attributes);op2.chars-=op1.chars;op1=ops1[i1++];}}else if(op1.isInsert()&&op2.isDelete()){if(op1.text.length>op2.chars){op1.text=op1.text.slice(op2.chars);op2=ops2[i2++];}else if(op1.text.length===op2.chars){op1=ops1[i1++];op2=ops2[i2++];}else{op2.chars-=op1.text.length;op1=ops1[i1++];}}else if(op1.isInsert()&&op2.isRetain()){attributes=composeAttributes(op1.attributes,op2.attributes,/*firstOpIsInsert=*/true);if(op1.text.length>op2.chars){operation.insert(op1.text.slice(0,op2.chars),attributes);op1.text=op1.text.slice(op2.chars);op2=ops2[i2++];}else if(op1.text.length===op2.chars){operation.insert(op1.text,attributes);op1=ops1[i1++];op2=ops2[i2++];}else{operation.insert(op1.text,attributes);op2.chars-=op1.text.length;op1=ops1[i1++];}}else if(op1.isRetain()&&op2.isDelete()){if(op1.chars>op2.chars){operation['delete'](op2.chars);op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){operation['delete'](op2.chars);op1=ops1[i1++];op2=ops2[i2++];}else{operation['delete'](op1.chars);op2.chars-=op1.chars;op1=ops1[i1++];}}else{throw new Error(\"This shouldn't happen: op1: \"+JSON.stringify(op1)+\", op2: \"+JSON.stringify(op2));}}return operation;};function getSimpleOp(operation){var ops=operation.ops;switch(ops.length){case 1:return ops[0];case 2:return ops[0].isRetain()?ops[1]:ops[1].isRetain()?ops[0]:null;case 3:if(ops[0].isRetain()&&ops[2].isRetain()){return ops[1];}}return null;}function getStartIndex(operation){if(operation.ops[0].isRetain()){return operation.ops[0].chars;}return 0;}// When you use ctrl-z to undo your latest changes, you expect the program not\n// to undo every single keystroke but to undo your last sentence you wrote at\n// a stretch or the deletion you did by holding the backspace key down. This\n// This can be implemented by composing operations on the undo stack. This\n// method can help decide whether two operations should be composed. It\n// returns true if the operations are consecutive insert operations or both\n// operations delete text at the same position. You may want to include other\n// factors like the time since the last change in your decision.\nTextOperation.prototype.shouldBeComposedWith=function(other){if(this.isNoop()||other.isNoop()){return true;}var startA=getStartIndex(this),startB=getStartIndex(other);var simpleA=getSimpleOp(this),simpleB=getSimpleOp(other);if(!simpleA||!simpleB){return false;}if(simpleA.isInsert()&&simpleB.isInsert()){return startA+simpleA.text.length===startB;}if(simpleA.isDelete()&&simpleB.isDelete()){// there are two possibilities to delete: with backspace and with the\n// delete key.\nreturn startB+simpleB.chars===startA||startA===startB;}return false;};// Decides whether two operations should be composed with each other\n// if they were inverted, that is\n// `shouldBeComposedWith(a, b) = shouldBeComposedWithInverted(b^{-1}, a^{-1})`.\nTextOperation.prototype.shouldBeComposedWithInverted=function(other){if(this.isNoop()||other.isNoop()){return true;}var startA=getStartIndex(this),startB=getStartIndex(other);var simpleA=getSimpleOp(this),simpleB=getSimpleOp(other);if(!simpleA||!simpleB){return false;}if(simpleA.isInsert()&&simpleB.isInsert()){return startA+simpleA.text.length===startB||startA===startB;}if(simpleA.isDelete()&&simpleB.isDelete()){return startB+simpleB.chars===startA;}return false;};TextOperation.transformAttributes=function(attributes1,attributes2){var attributes1prime={},attributes2prime={};var attr,allAttrs={};for(attr in attributes1){allAttrs[attr]=true;}for(attr in attributes2){allAttrs[attr]=true;}for(attr in allAttrs){var attr1=attributes1[attr],attr2=attributes2[attr];utils.assert(attr1!=null||attr2!=null);if(attr1==null){// Only modified by attributes2; keep it.\nattributes2prime[attr]=attr2;}else if(attr2==null){// only modified by attributes1; keep it\nattributes1prime[attr]=attr1;}else if(attr1===attr2){// Both set it to the same value.  Nothing to do.\n}else{// attr1 and attr2 are different. Prefer attr1.\nattributes1prime[attr]=attr1;}}return[attributes1prime,attributes2prime];};// Transform takes two operations A and B that happened concurrently and\n// produces two operations A' and B' (in an array) such that\n// `apply(apply(S, A), B') = apply(apply(S, B), A')`. This function is the\n// heart of OT.\nTextOperation.transform=function(operation1,operation2){if(operation1.baseLength!==operation2.baseLength){throw new Error(\"Both operations have to have the same base length\");}var operation1prime=new TextOperation();var operation2prime=new TextOperation();var ops1=operation1.clone().ops,ops2=operation2.clone().ops;var i1=0,i2=0;var op1=ops1[i1++],op2=ops2[i2++];while(true){// At every iteration of the loop, the imaginary cursor that both\n// operation1 and operation2 have that operates on the input string must\n// have the same position in the input string.\nif(typeof op1==='undefined'&&typeof op2==='undefined'){// end condition: both ops1 and ops2 have been processed\nbreak;}// next two cases: one or both ops are insert ops\n// => insert the string in the corresponding prime operation, skip it in\n// the other one. If both op1 and op2 are insert ops, prefer op1.\nif(op1&&op1.isInsert()){operation1prime.insert(op1.text,op1.attributes);operation2prime.retain(op1.text.length);op1=ops1[i1++];continue;}if(op2&&op2.isInsert()){operation1prime.retain(op2.text.length);operation2prime.insert(op2.text,op2.attributes);op2=ops2[i2++];continue;}if(typeof op1==='undefined'){throw new Error(\"Cannot transform operations: first operation is too short.\");}if(typeof op2==='undefined'){throw new Error(\"Cannot transform operations: first operation is too long.\");}var minl;if(op1.isRetain()&&op2.isRetain()){// Simple case: retain/retain\nvar attributesPrime=TextOperation.transformAttributes(op1.attributes,op2.attributes);if(op1.chars>op2.chars){minl=op2.chars;op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){minl=op2.chars;op1=ops1[i1++];op2=ops2[i2++];}else{minl=op1.chars;op2.chars-=op1.chars;op1=ops1[i1++];}operation1prime.retain(minl,attributesPrime[0]);operation2prime.retain(minl,attributesPrime[1]);}else if(op1.isDelete()&&op2.isDelete()){// Both operations delete the same string at the same position. We don't\n// need to produce any operations, we just skip over the delete ops and\n// handle the case that one operation deletes more than the other.\nif(op1.chars>op2.chars){op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){op1=ops1[i1++];op2=ops2[i2++];}else{op2.chars-=op1.chars;op1=ops1[i1++];}// next two cases: delete/retain and retain/delete\n}else if(op1.isDelete()&&op2.isRetain()){if(op1.chars>op2.chars){minl=op2.chars;op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){minl=op2.chars;op1=ops1[i1++];op2=ops2[i2++];}else{minl=op1.chars;op2.chars-=op1.chars;op1=ops1[i1++];}operation1prime['delete'](minl);}else if(op1.isRetain()&&op2.isDelete()){if(op1.chars>op2.chars){minl=op2.chars;op1.chars-=op2.chars;op2=ops2[i2++];}else if(op1.chars===op2.chars){minl=op1.chars;op1=ops1[i1++];op2=ops2[i2++];}else{minl=op1.chars;op2.chars-=op1.chars;op1=ops1[i1++];}operation2prime['delete'](minl);}else{throw new Error(\"The two operations aren't compatible\");}}return[operation1prime,operation2prime];};// convenience method to write transform(a, b) as a.transform(b)\nTextOperation.prototype.transform=function(other){return TextOperation.transform(this,other);};return TextOperation;}();var firepad=firepad||{};// TODO: Rewrite this (probably using a splay tree) to be efficient.  Right now it's based on a linked list\n// so all operations are O(n), where n is the number of spans in the list.\nfirepad.AnnotationList=function(){var Span=firepad.Span;function assert(bool,text){if(!bool){throw new Error('AnnotationList assertion failed'+(text?': '+text:''));}}function OldAnnotatedSpan(pos,node){this.pos=pos;this.length=node.length;this.annotation=node.annotation;this.attachedObject_=node.attachedObject;}OldAnnotatedSpan.prototype.getAttachedObject=function(){return this.attachedObject_;};function NewAnnotatedSpan(pos,node){this.pos=pos;this.length=node.length;this.annotation=node.annotation;this.node_=node;}NewAnnotatedSpan.prototype.attachObject=function(object){this.node_.attachedObject=object;};var NullAnnotation={equals:function equals(){return false;}};function AnnotationList(changeHandler){// There's always a head node; to avoid special cases.\nthis.head_=new Node(0,NullAnnotation);this.changeHandler_=changeHandler;}AnnotationList.prototype.insertAnnotatedSpan=function(span,annotation){this.wrapOperation_(new Span(span.pos,0),function(oldPos,old){assert(!old||old.next===null);// should be 0 or 1 nodes.\nvar toInsert=new Node(span.length,annotation);if(!old){return toInsert;}else{assert(span.pos>oldPos&&span.pos<oldPos+old.length);var newNodes=new Node(0,NullAnnotation);// Insert part of old before insertion point.\nnewNodes.next=new Node(span.pos-oldPos,old.annotation);// Insert new node.\nnewNodes.next.next=toInsert;// Insert part of old after insertion point.\ntoInsert.next=new Node(oldPos+old.length-span.pos,old.annotation);return newNodes.next;}});};AnnotationList.prototype.removeSpan=function(removeSpan){if(removeSpan.length===0){return;}this.wrapOperation_(removeSpan,function(oldPos,old){assert(old!==null);var newNodes=new Node(0,NullAnnotation),current=newNodes;// Add new node for part before the removed span (if any).\nif(removeSpan.pos>oldPos){current.next=new Node(removeSpan.pos-oldPos,old.annotation);current=current.next;}// Skip over removed nodes.\nwhile(removeSpan.end()>oldPos+old.length){oldPos+=old.length;old=old.next;}// Add new node for part after the removed span (if any).\nvar afterChars=oldPos+old.length-removeSpan.end();if(afterChars>0){current.next=new Node(afterChars,old.annotation);}return newNodes.next;});};AnnotationList.prototype.updateSpan=function(span,updateFn){if(span.length===0){return;}this.wrapOperation_(span,function(oldPos,old){assert(old!==null);var newNodes=new Node(0,NullAnnotation),current=newNodes,currentPos=oldPos;// Add node for any characters before the span we're updating.\nvar beforeChars=span.pos-currentPos;assert(beforeChars<old.length);if(beforeChars>0){current.next=new Node(beforeChars,old.annotation);current=current.next;currentPos+=current.length;}// Add updated nodes for entirely updated nodes.\nwhile(old!==null&&span.end()>=oldPos+old.length){var length=oldPos+old.length-currentPos;current.next=new Node(length,updateFn(old.annotation,length));current=current.next;oldPos+=old.length;old=old.next;currentPos=oldPos;}// Add updated nodes for last node.\nvar updateChars=span.end()-currentPos;if(updateChars>0){assert(updateChars<old.length);current.next=new Node(updateChars,updateFn(old.annotation,updateChars));current=current.next;currentPos+=current.length;// Add non-updated remaining part of node.\ncurrent.next=new Node(oldPos+old.length-currentPos,old.annotation);}return newNodes.next;});};AnnotationList.prototype.wrapOperation_=function(span,operationFn){if(span.pos<0){throw new Error('Span start cannot be negative.');}var oldNodes=[],newNodes=[];var res=this.getAffectedNodes_(span);var tail;if(res.start!==null){tail=res.end.next;// Temporarily truncate list so we can pass it to operationFn.  We'll splice it back in later.\nres.end.next=null;}else{// start and end are null, because span is empty and lies on the border of two nodes.\ntail=res.succ;}// Create a new segment to replace the affected nodes.\nvar newSegment=operationFn(res.startPos,res.start);var includePredInOldNodes=false,includeSuccInOldNodes=false;if(newSegment){this.mergeNodesWithSameAnnotations_(newSegment);var newPos;if(res.pred&&res.pred.annotation.equals(newSegment.annotation)){// We can merge the pred node with newSegment's first node.\nincludePredInOldNodes=true;newSegment.length+=res.pred.length;// Splice newSegment in after beforePred.\nres.beforePred.next=newSegment;newPos=res.predPos;}else{// Splice newSegment in after beforeStart.\nres.beforeStart.next=newSegment;newPos=res.startPos;}// Generate newNodes, but not the last one (since we may be able to merge it with succ).\nwhile(newSegment.next){newNodes.push(new NewAnnotatedSpan(newPos,newSegment));newPos+=newSegment.length;newSegment=newSegment.next;}if(res.succ&&res.succ.annotation.equals(newSegment.annotation)){// We can merge newSegment's last node with the succ node.\nnewSegment.length+=res.succ.length;includeSuccInOldNodes=true;// Splice rest of list after succ after newSegment.\nnewSegment.next=res.succ.next;}else{// Splice tail after newSegment.\nnewSegment.next=tail;}// Add last newSegment node to newNodes.\nnewNodes.push(new NewAnnotatedSpan(newPos,newSegment));}else{// newList is empty.  Try to merge pred and succ.\nif(res.pred&&res.succ&&res.pred.annotation.equals(res.succ.annotation)){includePredInOldNodes=true;includeSuccInOldNodes=true;// Create succ + pred merged node and splice list together.\nnewSegment=new Node(res.pred.length+res.succ.length,res.pred.annotation);res.beforePred.next=newSegment;newSegment.next=res.succ.next;newNodes.push(new NewAnnotatedSpan(res.startPos-res.pred.length,newSegment));}else{// Just splice list back together.\nres.beforeStart.next=tail;}}// Build list of oldNodes.\nif(includePredInOldNodes){oldNodes.push(new OldAnnotatedSpan(res.predPos,res.pred));}var oldPos=res.startPos,oldSegment=res.start;while(oldSegment!==null){oldNodes.push(new OldAnnotatedSpan(oldPos,oldSegment));oldPos+=oldSegment.length;oldSegment=oldSegment.next;}if(includeSuccInOldNodes){oldNodes.push(new OldAnnotatedSpan(oldPos,res.succ));}this.changeHandler_(oldNodes,newNodes);};AnnotationList.prototype.getAffectedNodes_=function(span){// We want to find nodes 'start', 'end', 'beforeStart', 'pred', and 'succ' where:\n//  - 'start' contains the first character in span.\n//  - 'end' contains the last character in span.\n//  - 'beforeStart' is the node before 'start'.\n//  - 'beforePred' is the node before 'pred'.\n//  - 'succ' contains the node after 'end' if span.end() was on a node boundary, else null.\n//  - 'pred' contains the node before 'start' if span.pos was on a node boundary, else null.\nvar result={};var prevprev=null,prev=this.head_,current=prev.next,currentPos=0;while(current!==null&&span.pos>=currentPos+current.length){currentPos+=current.length;prevprev=prev;prev=current;current=current.next;}if(current===null&&!(span.length===0&&span.pos===currentPos)){throw new Error('Span start exceeds the bounds of the AnnotationList.');}result.startPos=currentPos;// Special case if span is empty and on the border of two nodes\nif(span.length===0&&span.pos===currentPos){result.start=null;}else{result.start=current;}result.beforeStart=prev;if(currentPos===span.pos&&currentPos>0){result.pred=prev;result.predPos=currentPos-prev.length;result.beforePred=prevprev;}else{result.pred=null;}while(current!==null&&span.end()>currentPos){currentPos+=current.length;prev=current;current=current.next;}if(span.end()>currentPos){throw new Error('Span end exceeds the bounds of the AnnotationList.');}// Special case if span is empty and on the border of two nodes.\nif(span.length===0&&span.end()===currentPos){result.end=null;}else{result.end=prev;}result.succ=currentPos===span.end()?current:null;return result;};AnnotationList.prototype.mergeNodesWithSameAnnotations_=function(list){if(!list){return;}var prev=null,curr=list;while(curr){if(prev&&prev.annotation.equals(curr.annotation)){prev.length+=curr.length;prev.next=curr.next;}else{prev=curr;}curr=curr.next;}};AnnotationList.prototype.forEach=function(callback){var current=this.head_.next;while(current!==null){callback(current.length,current.annotation,current.attachedObject);current=current.next;}};AnnotationList.prototype.getAnnotatedSpansForPos=function(pos){var currentPos=0;var current=this.head_.next,prev=null;while(current!==null&&currentPos+current.length<=pos){currentPos+=current.length;prev=current;current=current.next;}if(current===null&&currentPos!==pos){throw new Error('pos exceeds the bounds of the AnnotationList');}var res=[];if(currentPos===pos&&prev){res.push(new OldAnnotatedSpan(currentPos-prev.length,prev));}if(current){res.push(new OldAnnotatedSpan(currentPos,current));}return res;};AnnotationList.prototype.getAnnotatedSpansForSpan=function(span){if(span.length===0){return[];}var oldSpans=[];var res=this.getAffectedNodes_(span);var currentPos=res.startPos,current=res.start;while(current!==null&&currentPos<span.end()){var start=Math.max(currentPos,span.pos),end=Math.min(currentPos+current.length,span.end());var oldSpan=new Span(start,end-start);oldSpan.annotation=current.annotation;oldSpans.push(oldSpan);currentPos+=current.length;current=current.next;}return oldSpans;};// For testing.\nAnnotationList.prototype.count=function(){var count=0;var current=this.head_.next,prev=null;while(current!==null){if(prev){assert(!prev.annotation.equals(current.annotation));}prev=current;current=current.next;count++;}return count;};function Node(length,annotation){this.length=length;this.annotation=annotation;this.attachedObject=null;this.next=null;}Node.prototype.clone=function(){var node=new Node(this.spanLength,this.annotation);node.next=this.next;return node;};return AnnotationList;}();var firepad=firepad||{};firepad.Cursor=function(){'use strict';// A cursor has a `position` and a `selectionEnd`. Both are zero-based indexes\n// into the document. When nothing is selected, `selectionEnd` is equal to\n// `position`. When there is a selection, `position` is always the side of the\n// selection that would move if you pressed an arrow key.\nfunction Cursor(position,selectionEnd){this.position=position;this.selectionEnd=selectionEnd;}Cursor.fromJSON=function(obj){return new Cursor(obj.position,obj.selectionEnd);};Cursor.prototype.equals=function(other){return this.position===other.position&&this.selectionEnd===other.selectionEnd;};// Return the more current cursor information.\nCursor.prototype.compose=function(other){return other;};// Update the cursor with respect to an operation.\nCursor.prototype.transform=function(other){function transformIndex(index){var newIndex=index;var ops=other.ops;for(var i=0,l=other.ops.length;i<l;i++){if(ops[i].isRetain()){index-=ops[i].chars;}else if(ops[i].isInsert()){newIndex+=ops[i].text.length;}else{newIndex-=Math.min(index,ops[i].chars);index-=ops[i].chars;}if(index<0){break;}}return newIndex;}var newPosition=transformIndex(this.position);if(this.position===this.selectionEnd){return new Cursor(newPosition,newPosition);}return new Cursor(newPosition,transformIndex(this.selectionEnd));};return Cursor;}();var firepad=firepad||{};firepad.FirebaseAdapter=function(global){if(window.firebase===undefined&&typeof require==='function'&&typeof Firebase!=='function'){firebase=require('firebase');}var TextOperation=firepad.TextOperation;var utils=firepad.utils;// Save a checkpoint every 100 edits.\nvar CHECKPOINT_FREQUENCY=100;function FirebaseAdapter(ref,userId,userColor){this.ref_=ref;this.ready_=false;this.firebaseCallbacks_=[];this.zombie_=false;// We store the current document state as a TextOperation so we can write checkpoints to Firebase occasionally.\n// TODO: Consider more efficient ways to do this. (composing text operations is ~linear in the length of the document).\nthis.document_=new TextOperation();// The next expected revision.\nthis.revision_=0;// This is used for two purposes:\n// 1) On initialization, we fill this with the latest checkpoint and any subsequent operations and then\n//      process them all together.\n// 2) If we ever receive revisions out-of-order (e.g. rev 5 before rev 4), we queue them here until it's time\n//    for them to be handled. [this should never happen with well-behaved clients; but if it /does/ happen we want\n//    to handle it gracefully.]\nthis.pendingReceivedRevisions_={};var self=this;if(userId){this.setUserId(userId);this.setColor(userColor);var connectedRef=ref.root.child('.info/connected');this.firebaseOn_(connectedRef,'value',function(snapshot){if(snapshot.val()===true){self.initializeUserData_();}},this);// Once we're initialized, start tracking users' cursors.\nthis.on('ready',function(){self.monitorCursors_();});}else{this.userId_=ref.push().key;}// Avoid triggering any events until our callers have had a chance to attach their listeners.\nsetTimeout(function(){self.monitorHistory_();},0);}utils.makeEventEmitter(FirebaseAdapter,['ready','cursor','operation','ack','retry']);FirebaseAdapter.prototype.dispose=function(){var self=this;if(!this.ready_){// TODO: this completes loading the text even though we're no longer interested in it.\nthis.on('ready',function(){self.dispose();});return;}this.removeFirebaseCallbacks_();if(this.userRef_){this.userRef_.child('cursor').remove();this.userRef_.child('color').remove();}this.ref_=null;this.document_=null;this.zombie_=true;};FirebaseAdapter.prototype.setUserId=function(userId){if(this.userRef_){// Clean up existing data.  Avoid nuking another user's data\n// (if a future user takes our old name).\nthis.userRef_.child('cursor').remove();this.userRef_.child('cursor').onDisconnect().cancel();this.userRef_.child('color').remove();this.userRef_.child('color').onDisconnect().cancel();}this.userId_=userId;this.userRef_=this.ref_.child('users').child(userId);this.initializeUserData_();};FirebaseAdapter.prototype.isHistoryEmpty=function(){assert(this.ready_,\"Not ready yet.\");return this.revision_===0;};/*\n   * Send operation, retrying on connection failure. Takes an optional callback with signature:\n   * function(error, committed).\n   * An exception will be thrown on transaction failure, which should only happen on\n   * catastrophic failure like a security rule violation.\n   */FirebaseAdapter.prototype.sendOperation=function(operation,callback){var self=this;// If we're not ready yet, do nothing right now, and trigger a retry when we're ready.\nif(!this.ready_){this.on('ready',function(){self.trigger('retry');});return;}// Sanity check that this operation is valid.\nassert(this.document_.targetLength===operation.baseLength,\"sendOperation() called with invalid operation.\");// Convert revision into an id that will sort properly lexicographically.\nvar revisionId=revisionToId(this.revision_);function doTransaction(revisionId,revisionData){self.ref_.child('history').child(revisionId).transaction(function(current){if(current===null){return revisionData;}},function(error,committed,snapshot){if(error){if(error.message==='disconnect'){if(self.sent_&&self.sent_.id===revisionId){// We haven't seen our transaction succeed or fail.  Send it again.\nsetTimeout(function(){doTransaction(revisionId,revisionData);},0);}else if(callback){callback(error,false);}}else{utils.log('Transaction failure!',error);throw error;}}else{if(callback)callback(null,committed);}},/*applyLocally=*/false);}this.sent_={id:revisionId,op:operation};doTransaction(revisionId,{a:self.userId_,o:operation.toJSON(),t:firebase.database.ServerValue.TIMESTAMP});};FirebaseAdapter.prototype.sendCursor=function(obj){this.userRef_.child('cursor').set(obj);this.cursor_=obj;};FirebaseAdapter.prototype.setColor=function(color){this.userRef_.child('color').set(color);this.color_=color;};FirebaseAdapter.prototype.getDocument=function(){return this.document_;};FirebaseAdapter.prototype.registerCallbacks=function(callbacks){for(var eventType in callbacks){this.on(eventType,callbacks[eventType]);}};FirebaseAdapter.prototype.initializeUserData_=function(){this.userRef_.child('cursor').onDisconnect().remove();this.userRef_.child('color').onDisconnect().remove();this.sendCursor(this.cursor_||null);this.setColor(this.color_||null);};FirebaseAdapter.prototype.monitorCursors_=function(){var usersRef=this.ref_.child('users'),self=this;function childChanged(childSnap){var userId=childSnap.key;var userData=childSnap.val();self.trigger('cursor',userId,userData.cursor,userData.color);}this.firebaseOn_(usersRef,'child_added',childChanged);this.firebaseOn_(usersRef,'child_changed',childChanged);this.firebaseOn_(usersRef,'child_removed',function(childSnap){var userId=childSnap.key;self.trigger('cursor',userId,null);});};FirebaseAdapter.prototype.monitorHistory_=function(){var self=this;// Get the latest checkpoint as a starting point so we don't have to re-play entire history.\nthis.ref_.child('checkpoint').once('value',function(s){if(self.zombie_){return;}// just in case we were cleaned up before we got the checkpoint data.\nvar revisionId=s.child('id').val(),op=s.child('o').val(),author=s.child('a').val();if(op!=null&&revisionId!=null&&author!==null){self.pendingReceivedRevisions_[revisionId]={o:op,a:author};self.checkpointRevision_=revisionFromId(revisionId);self.monitorHistoryStartingAt_(self.checkpointRevision_+1);}else{self.checkpointRevision_=0;self.monitorHistoryStartingAt_(self.checkpointRevision_);}});};FirebaseAdapter.prototype.monitorHistoryStartingAt_=function(revision){var historyRef=this.ref_.child('history').startAt(null,revisionToId(revision));var self=this;setTimeout(function(){self.firebaseOn_(historyRef,'child_added',function(revisionSnapshot){var revisionId=revisionSnapshot.key;self.pendingReceivedRevisions_[revisionId]=revisionSnapshot.val();if(self.ready_){self.handlePendingReceivedRevisions_();}});historyRef.once('value',function(){self.handleInitialRevisions_();});},0);};FirebaseAdapter.prototype.handleInitialRevisions_=function(){assert(!this.ready_,\"Should not be called multiple times.\");// Compose the checkpoint and all subsequent revisions into a single operation to apply at once.\nthis.revision_=this.checkpointRevision_;var revisionId=revisionToId(this.revision_),pending=this.pendingReceivedRevisions_;while(pending[revisionId]!=null){var revision=this.parseRevision_(pending[revisionId]);if(!revision){// If a misbehaved client adds a bad operation, just ignore it.\nutils.log('Invalid operation.',this.ref_.toString(),revisionId,pending[revisionId]);}else{this.document_=this.document_.compose(revision.operation);}delete pending[revisionId];this.revision_++;revisionId=revisionToId(this.revision_);}this.trigger('operation',this.document_);this.ready_=true;var self=this;setTimeout(function(){self.trigger('ready');},0);};FirebaseAdapter.prototype.handlePendingReceivedRevisions_=function(){var pending=this.pendingReceivedRevisions_;var revisionId=revisionToId(this.revision_);var triggerRetry=false;while(pending[revisionId]!=null){this.revision_++;var revision=this.parseRevision_(pending[revisionId]);if(!revision){// If a misbehaved client adds a bad operation, just ignore it.\nutils.log('Invalid operation.',this.ref_.toString(),revisionId,pending[revisionId]);}else{this.document_=this.document_.compose(revision.operation);if(this.sent_&&revisionId===this.sent_.id){// We have an outstanding change at this revision id.\nif(this.sent_.op.equals(revision.operation)&&revision.author===this.userId_){// This is our change; it succeeded.\nif(this.revision_%CHECKPOINT_FREQUENCY===0){this.saveCheckpoint_();}this.sent_=null;this.trigger('ack');}else{// our op failed.  Trigger a retry after we're done catching up on any incoming ops.\ntriggerRetry=true;this.trigger('operation',revision.operation);}}else{this.trigger('operation',revision.operation);}}delete pending[revisionId];revisionId=revisionToId(this.revision_);}if(triggerRetry){this.sent_=null;this.trigger('retry');}};FirebaseAdapter.prototype.parseRevision_=function(data){// We could do some of this validation via security rules.  But it's nice to be robust, just in case.\nif(typeof data!=='object'){return null;}if(typeof data.a!=='string'||typeof data.o!=='object'){return null;}var op=null;try{op=TextOperation.fromJSON(data.o);}catch(e){return null;}if(op.baseLength!==this.document_.targetLength){return null;}return{author:data.a,operation:op};};FirebaseAdapter.prototype.saveCheckpoint_=function(){this.ref_.child('checkpoint').set({a:this.userId_,o:this.document_.toJSON(),id:revisionToId(this.revision_-1)// use the id for the revision we just wrote.\n});};FirebaseAdapter.prototype.firebaseOn_=function(ref,eventType,callback,context){this.firebaseCallbacks_.push({ref:ref,eventType:eventType,callback:callback,context:context});ref.on(eventType,callback,context);return callback;};FirebaseAdapter.prototype.firebaseOff_=function(ref,eventType,callback,context){ref.off(eventType,callback,context);for(var i=0;i<this.firebaseCallbacks_.length;i++){var l=this.firebaseCallbacks_[i];if(l.ref===ref&&l.eventType===eventType&&l.callback===callback&&l.context===context){this.firebaseCallbacks_.splice(i,1);break;}}};FirebaseAdapter.prototype.removeFirebaseCallbacks_=function(){for(var i=0;i<this.firebaseCallbacks_.length;i++){var l=this.firebaseCallbacks_[i];l.ref.off(l.eventType,l.callback,l.context);}this.firebaseCallbacks_=[];};// Throws an error if the first argument is falsy. Useful for debugging.\nfunction assert(b,msg){if(!b){throw new Error(msg||\"assertion error\");}}// Based off ideas from http://www.zanopha.com/docs/elen.pdf\nvar characters='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';function revisionToId(revision){if(revision===0){return'A0';}var str='';while(revision>0){var digit=revision%characters.length;str=characters[digit]+str;revision-=digit;revision/=characters.length;}// Prefix with length (starting at 'A' for length 1) to ensure the id's sort lexicographically.\nvar prefix=characters[str.length+9];return prefix+str;}function revisionFromId(revisionId){assert(revisionId.length>0&&revisionId[0]===characters[revisionId.length+8]);var revision=0;for(var i=1;i<revisionId.length;i++){revision*=characters.length;revision+=characters.indexOf(revisionId[i]);}return revision;}return FirebaseAdapter;}();var firepad=firepad||{};firepad.RichTextToolbar=function(global){var utils=firepad.utils;function RichTextToolbar(imageInsertionUI){this.imageInsertionUI=imageInsertionUI;this.element_=this.makeElement_();}utils.makeEventEmitter(RichTextToolbar,['bold','italic','underline','strike','font','font-size','color','left','center','right','unordered-list','ordered-list','todo-list','indent-increase','indent-decrease','undo','redo','insert-image']);RichTextToolbar.prototype.element=function(){return this.element_;};RichTextToolbar.prototype.makeButton_=function(eventName,iconName){var self=this;iconName=iconName||eventName;var btn=utils.elt('a',[utils.elt('span','',{'class':'firepad-tb-'+iconName})],{'class':'firepad-btn'});utils.on(btn,'click',utils.stopEventAnd(function(){self.trigger(eventName);}));return btn;};RichTextToolbar.prototype.makeElement_=function(){var self=this;var font=this.makeFontDropdown_();var fontSize=this.makeFontSizeDropdown_();var color=this.makeColorDropdown_();var toolbarOptions=[utils.elt('div',[font],{'class':'firepad-btn-group'}),utils.elt('div',[fontSize],{'class':'firepad-btn-group'}),utils.elt('div',[color],{'class':'firepad-btn-group'}),utils.elt('div',[self.makeButton_('bold'),self.makeButton_('italic'),self.makeButton_('underline'),self.makeButton_('strike','strikethrough')],{'class':'firepad-btn-group'}),utils.elt('div',[self.makeButton_('unordered-list','list-2'),self.makeButton_('ordered-list','numbered-list'),self.makeButton_('todo-list','list')],{'class':'firepad-btn-group'}),utils.elt('div',[self.makeButton_('indent-decrease'),self.makeButton_('indent-increase')],{'class':'firepad-btn-group'}),utils.elt('div',[self.makeButton_('left','paragraph-left'),self.makeButton_('center','paragraph-center'),self.makeButton_('right','paragraph-right')],{'class':'firepad-btn-group'}),utils.elt('div',[self.makeButton_('undo'),self.makeButton_('redo')],{'class':'firepad-btn-group'})];if(self.imageInsertionUI){toolbarOptions.push(utils.elt('div',[self.makeButton_('insert-image')],{'class':'firepad-btn-group'}));}var toolbarWrapper=utils.elt('div',toolbarOptions,{'class':'firepad-toolbar-wrapper'});var toolbar=utils.elt('div',null,{'class':'firepad-toolbar'});toolbar.appendChild(toolbarWrapper);return toolbar;};RichTextToolbar.prototype.makeFontDropdown_=function(){// NOTE: There must be matching .css styles in firepad.css.\nvar fonts=['Arial','Comic Sans MS','Courier New','Impact','Times New Roman','Verdana'];var items=[];for(var i=0;i<fonts.length;i++){var content=utils.elt('span',fonts[i]);content.setAttribute('style','font-family:'+fonts[i]);items.push({content:content,value:fonts[i]});}return this.makeDropdown_('Font','font',items);};RichTextToolbar.prototype.makeFontSizeDropdown_=function(){// NOTE: There must be matching .css styles in firepad.css.\nvar sizes=[9,10,12,14,18,24,32,42];var items=[];for(var i=0;i<sizes.length;i++){var content=utils.elt('span',sizes[i].toString());content.setAttribute('style','font-size:'+sizes[i]+'px; line-height:'+(sizes[i]-6)+'px;');items.push({content:content,value:sizes[i]});}return this.makeDropdown_('Size','font-size',items,'px');};RichTextToolbar.prototype.makeColorDropdown_=function(){var colors=['black','red','green','blue','yellow','cyan','magenta','grey'];var items=[];for(var i=0;i<colors.length;i++){var content=utils.elt('div');content.className='firepad-color-dropdown-item';content.setAttribute('style','background-color:'+colors[i]);items.push({content:content,value:colors[i]});}return this.makeDropdown_('Color','color',items);};RichTextToolbar.prototype.makeDropdown_=function(title,eventName,items,value_suffix){value_suffix=value_suffix||\"\";var self=this;var button=utils.elt('a',title+\" \\u25BE\",{'class':'firepad-btn firepad-dropdown'});var list=utils.elt('ul',[],{'class':'firepad-dropdown-menu'});button.appendChild(list);var isShown=false;function showDropdown(){if(!isShown){list.style.display='block';utils.on(document,'click',hideDropdown,/*capture=*/true);isShown=true;}}var justDismissed=false;function hideDropdown(){if(isShown){list.style.display='';utils.off(document,'click',hideDropdown,/*capture=*/true);isShown=false;}// HACK so we can avoid re-showing the dropdown if you click on the dropdown header to dismiss it.\njustDismissed=true;setTimeout(function(){justDismissed=false;},0);}function addItem(content,value){if(typeof content!=='object'){content=document.createTextNode(String(content));}var element=utils.elt('a',[content]);utils.on(element,'click',utils.stopEventAnd(function(){hideDropdown();self.trigger(eventName,value+value_suffix);}));list.appendChild(element);}for(var i=0;i<items.length;i++){var content=items[i].content,value=items[i].value;addItem(content,value);}utils.on(button,'click',utils.stopEventAnd(function(){if(!justDismissed){showDropdown();}}));return button;};return RichTextToolbar;}();var firepad=firepad||{};firepad.WrappedOperation=function(global){'use strict';// A WrappedOperation contains an operation and corresponing metadata.\nfunction WrappedOperation(operation,meta){this.wrapped=operation;this.meta=meta;}WrappedOperation.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments);};WrappedOperation.prototype.invert=function(){var meta=this.meta;return new WrappedOperation(this.wrapped.invert.apply(this.wrapped,arguments),meta&&typeof meta==='object'&&typeof meta.invert==='function'?meta.invert.apply(meta,arguments):meta);};// Copy all properties from source to target.\nfunction copy(source,target){for(var key in source){if(source.hasOwnProperty(key)){target[key]=source[key];}}}function composeMeta(a,b){if(a&&typeof a==='object'){if(typeof a.compose==='function'){return a.compose(b);}var meta={};copy(a,meta);copy(b,meta);return meta;}return b;}WrappedOperation.prototype.compose=function(other){return new WrappedOperation(this.wrapped.compose(other.wrapped),composeMeta(this.meta,other.meta));};function transformMeta(meta,operation){if(meta&&typeof meta==='object'){if(typeof meta.transform==='function'){return meta.transform(operation);}}return meta;}WrappedOperation.transform=function(a,b){var pair=a.wrapped.transform(b.wrapped);return[new WrappedOperation(pair[0],transformMeta(a.meta,b.wrapped)),new WrappedOperation(pair[1],transformMeta(b.meta,a.wrapped))];};// convenience method to write transform(a, b) as a.transform(b)\nWrappedOperation.prototype.transform=function(other){return WrappedOperation.transform(this,other);};return WrappedOperation;}();var firepad=firepad||{};firepad.UndoManager=function(){'use strict';var NORMAL_STATE='normal';var UNDOING_STATE='undoing';var REDOING_STATE='redoing';// Create a new UndoManager with an optional maximum history size.\nfunction UndoManager(maxItems){this.maxItems=maxItems||50;this.state=NORMAL_STATE;this.dontCompose=false;this.undoStack=[];this.redoStack=[];}// Add an operation to the undo or redo stack, depending on the current state\n// of the UndoManager. The operation added must be the inverse of the last\n// edit. When `compose` is true, compose the operation with the last operation\n// unless the last operation was alread pushed on the redo stack or was hidden\n// by a newer operation on the undo stack.\nUndoManager.prototype.add=function(operation,compose){if(this.state===UNDOING_STATE){this.redoStack.push(operation);this.dontCompose=true;}else if(this.state===REDOING_STATE){this.undoStack.push(operation);this.dontCompose=true;}else{var undoStack=this.undoStack;if(!this.dontCompose&&compose&&undoStack.length>0){undoStack.push(operation.compose(undoStack.pop()));}else{undoStack.push(operation);if(undoStack.length>this.maxItems){undoStack.shift();}}this.dontCompose=false;this.redoStack=[];}};function transformStack(stack,operation){var newStack=[];var Operation=operation.constructor;for(var i=stack.length-1;i>=0;i--){var pair=Operation.transform(stack[i],operation);if(typeof pair[0].isNoop!=='function'||!pair[0].isNoop()){newStack.push(pair[0]);}operation=pair[1];}return newStack.reverse();}// Transform the undo and redo stacks against a operation by another client.\nUndoManager.prototype.transform=function(operation){this.undoStack=transformStack(this.undoStack,operation);this.redoStack=transformStack(this.redoStack,operation);};// Perform an undo by calling a function with the latest operation on the undo\n// stack. The function is expected to call the `add` method with the inverse\n// of the operation, which pushes the inverse on the redo stack.\nUndoManager.prototype.performUndo=function(fn){this.state=UNDOING_STATE;if(this.undoStack.length===0){throw new Error(\"undo not possible\");}fn(this.undoStack.pop());this.state=NORMAL_STATE;};// The inverse of `performUndo`.\nUndoManager.prototype.performRedo=function(fn){this.state=REDOING_STATE;if(this.redoStack.length===0){throw new Error(\"redo not possible\");}fn(this.redoStack.pop());this.state=NORMAL_STATE;};// Is the undo stack not empty?\nUndoManager.prototype.canUndo=function(){return this.undoStack.length!==0;};// Is the redo stack not empty?\nUndoManager.prototype.canRedo=function(){return this.redoStack.length!==0;};// Whether the UndoManager is currently performing an undo.\nUndoManager.prototype.isUndoing=function(){return this.state===UNDOING_STATE;};// Whether the UndoManager is currently performing a redo.\nUndoManager.prototype.isRedoing=function(){return this.state===REDOING_STATE;};return UndoManager;}();var firepad=firepad||{};firepad.Client=function(){'use strict';// Client constructor\nfunction Client(){this.state=synchronized_;// start state\n}Client.prototype.setState=function(state){this.state=state;};// Call this method when the user changes the document.\nClient.prototype.applyClient=function(operation){this.setState(this.state.applyClient(this,operation));};// Call this method with a new operation from the server\nClient.prototype.applyServer=function(operation){this.setState(this.state.applyServer(this,operation));};Client.prototype.serverAck=function(){this.setState(this.state.serverAck(this));};Client.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this));};// Override this method.\nClient.prototype.sendOperation=function(operation){throw new Error(\"sendOperation must be defined in child class\");};// Override this method.\nClient.prototype.applyOperation=function(operation){throw new Error(\"applyOperation must be defined in child class\");};// In the 'Synchronized' state, there is no pending operation that the client\n// has sent to the server.\nfunction Synchronized(){}Client.Synchronized=Synchronized;Synchronized.prototype.applyClient=function(client,operation){// When the user makes an edit, send the operation to the server and\n// switch to the 'AwaitingConfirm' state\nclient.sendOperation(operation);return new AwaitingConfirm(operation);};Synchronized.prototype.applyServer=function(client,operation){// When we receive a new operation from the server, the operation can be\n// simply applied to the current document\nclient.applyOperation(operation);return this;};Synchronized.prototype.serverAck=function(client){throw new Error(\"There is no pending operation.\");};Synchronized.prototype.serverRetry=function(client){throw new Error(\"There is no pending operation.\");};// Singleton\nvar synchronized_=new Synchronized();// In the 'AwaitingConfirm' state, there's one operation the client has sent\n// to the server and is still waiting for an acknowledgement.\nfunction AwaitingConfirm(outstanding){// Save the pending operation\nthis.outstanding=outstanding;}Client.AwaitingConfirm=AwaitingConfirm;AwaitingConfirm.prototype.applyClient=function(client,operation){// When the user makes an edit, don't send the operation immediately,\n// instead switch to 'AwaitingWithBuffer' state\nreturn new AwaitingWithBuffer(this.outstanding,operation);};AwaitingConfirm.prototype.applyServer=function(client,operation){// This is another client's operation. Visualization:\n//\n//                   /\\\n// this.outstanding /  \\ operation\n//                 /    \\\n//                 \\    /\n//  pair[1]         \\  / pair[0] (new outstanding)\n//  (can be applied  \\/\n//  to the client's\n//  current document)\nvar pair=this.outstanding.transform(operation);client.applyOperation(pair[1]);return new AwaitingConfirm(pair[0]);};AwaitingConfirm.prototype.serverAck=function(client){// The client's operation has been acknowledged\n// => switch to synchronized state\nreturn synchronized_;};AwaitingConfirm.prototype.serverRetry=function(client){client.sendOperation(this.outstanding);return this;};// In the 'AwaitingWithBuffer' state, the client is waiting for an operation\n// to be acknowledged by the server while buffering the edits the user makes\nfunction AwaitingWithBuffer(outstanding,buffer){// Save the pending operation and the user's edits since then\nthis.outstanding=outstanding;this.buffer=buffer;}Client.AwaitingWithBuffer=AwaitingWithBuffer;AwaitingWithBuffer.prototype.applyClient=function(client,operation){// Compose the user's changes onto the buffer\nvar newBuffer=this.buffer.compose(operation);return new AwaitingWithBuffer(this.outstanding,newBuffer);};AwaitingWithBuffer.prototype.applyServer=function(client,operation){// Operation comes from another client\n//\n//                       /\\\n//     this.outstanding /  \\ operation\n//                     /    \\\n//                    /\\    /\n//       this.buffer /  \\* / pair1[0] (new outstanding)\n//                  /    \\/\n//                  \\    /\n//          pair2[1] \\  / pair2[0] (new buffer)\n// the transformed    \\/\n// operation -- can\n// be applied to the\n// client's current\n// document\n//\n// * pair1[1]\nvar pair1=this.outstanding.transform(operation);var pair2=this.buffer.transform(pair1[1]);client.applyOperation(pair2[1]);return new AwaitingWithBuffer(pair1[0],pair2[0]);};AwaitingWithBuffer.prototype.serverRetry=function(client){// Merge with our buffer and resend.\nvar outstanding=this.outstanding.compose(this.buffer);client.sendOperation(outstanding);return new AwaitingConfirm(outstanding);};AwaitingWithBuffer.prototype.serverAck=function(client){// The pending operation has been acknowledged\n// => send buffer\nclient.sendOperation(this.buffer);return new AwaitingConfirm(this.buffer);};return Client;}();var firepad=firepad||{};firepad.EditorClient=function(){'use strict';var Client=firepad.Client;var Cursor=firepad.Cursor;var UndoManager=firepad.UndoManager;var WrappedOperation=firepad.WrappedOperation;function SelfMeta(cursorBefore,cursorAfter){this.cursorBefore=cursorBefore;this.cursorAfter=cursorAfter;}SelfMeta.prototype.invert=function(){return new SelfMeta(this.cursorAfter,this.cursorBefore);};SelfMeta.prototype.compose=function(other){return new SelfMeta(this.cursorBefore,other.cursorAfter);};SelfMeta.prototype.transform=function(operation){return new SelfMeta(this.cursorBefore?this.cursorBefore.transform(operation):null,this.cursorAfter?this.cursorAfter.transform(operation):null);};function OtherClient(id,editorAdapter){this.id=id;this.editorAdapter=editorAdapter;}OtherClient.prototype.setColor=function(color){this.color=color;};OtherClient.prototype.updateCursor=function(cursor){this.removeCursor();this.cursor=cursor;this.mark=this.editorAdapter.setOtherCursor(cursor,this.color,this.id);};OtherClient.prototype.removeCursor=function(){if(this.mark){this.mark.clear();}};function EditorClient(serverAdapter,editorAdapter){Client.call(this);this.serverAdapter=serverAdapter;this.editorAdapter=editorAdapter;this.undoManager=new UndoManager();this.clients={};var self=this;this.editorAdapter.registerCallbacks({change:function change(operation,inverse){self.onChange(operation,inverse);},cursorActivity:function cursorActivity(){self.onCursorActivity();},blur:function blur(){self.onBlur();},focus:function focus(){self.onFocus();}});this.editorAdapter.registerUndo(function(){self.undo();});this.editorAdapter.registerRedo(function(){self.redo();});this.serverAdapter.registerCallbacks({ack:function ack(){self.serverAck();if(self.focused&&self.state instanceof Client.Synchronized){self.updateCursor();self.sendCursor(self.cursor);}self.emitStatus();},retry:function retry(){self.serverRetry();},operation:function operation(_operation){self.applyServer(_operation);},cursor:function cursor(clientId,_cursor,color){if(self.serverAdapter.userId_===clientId||!(self.state instanceof Client.Synchronized)){return;}var client=self.getClientObject(clientId);if(_cursor){if(color)client.setColor(color);client.updateCursor(Cursor.fromJSON(_cursor));}else{client.removeCursor();}}});}inherit(EditorClient,Client);EditorClient.prototype.getClientObject=function(clientId){var client=this.clients[clientId];if(client){return client;}return this.clients[clientId]=new OtherClient(clientId,this.editorAdapter);};EditorClient.prototype.applyUnredo=function(operation){this.undoManager.add(this.editorAdapter.invertOperation(operation));this.editorAdapter.applyOperation(operation.wrapped);this.cursor=operation.meta.cursorAfter;if(this.cursor)this.editorAdapter.setCursor(this.cursor);this.applyClient(operation.wrapped);};EditorClient.prototype.undo=function(){var self=this;if(!this.undoManager.canUndo()){return;}this.undoManager.performUndo(function(o){self.applyUnredo(o);});};EditorClient.prototype.redo=function(){var self=this;if(!this.undoManager.canRedo()){return;}this.undoManager.performRedo(function(o){self.applyUnredo(o);});};EditorClient.prototype.onChange=function(textOperation,inverse){var cursorBefore=this.cursor;this.updateCursor();var compose=this.undoManager.undoStack.length>0&&inverse.shouldBeComposedWithInverted(last(this.undoManager.undoStack).wrapped);var inverseMeta=new SelfMeta(this.cursor,cursorBefore);this.undoManager.add(new WrappedOperation(inverse,inverseMeta),compose);this.applyClient(textOperation);};EditorClient.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor();};EditorClient.prototype.onCursorActivity=function(){var oldCursor=this.cursor;this.updateCursor();if(!this.focused||oldCursor&&this.cursor.equals(oldCursor)){return;}this.sendCursor(this.cursor);};EditorClient.prototype.onBlur=function(){this.cursor=null;this.sendCursor(null);this.focused=false;};EditorClient.prototype.onFocus=function(){this.focused=true;this.onCursorActivity();};EditorClient.prototype.sendCursor=function(cursor){if(this.state instanceof Client.AwaitingWithBuffer){return;}this.serverAdapter.sendCursor(cursor);};EditorClient.prototype.sendOperation=function(operation){this.serverAdapter.sendOperation(operation);this.emitStatus();};EditorClient.prototype.applyOperation=function(operation){this.editorAdapter.applyOperation(operation);this.updateCursor();this.undoManager.transform(new WrappedOperation(operation,null));};EditorClient.prototype.emitStatus=function(){var self=this;setTimeout(function(){self.trigger('synced',self.state instanceof Client.Synchronized);},0);};// Set Const.prototype.__proto__ to Super.prototype\nfunction inherit(Const,Super){function F(){}F.prototype=Super.prototype;Const.prototype=new F();Const.prototype.constructor=Const;}function last(arr){return arr[arr.length-1];}return EditorClient;}();firepad.utils.makeEventEmitter(firepad.EditorClient,['synced']);var firepad,__bind=function __bind(fn,me){return function(){return fn.apply(me,arguments);};},__slice=[].slice;if(typeof firepad===\"undefined\"||firepad===null){firepad={};}firepad.ACEAdapter=function(){ACEAdapter.prototype.ignoreChanges=false;function ACEAdapter(aceInstance){this.onCursorActivity=__bind(this.onCursorActivity,this);this.onFocus=__bind(this.onFocus,this);this.onBlur=__bind(this.onBlur,this);this.onChange=__bind(this.onChange,this);var _ref;this.ace=aceInstance;this.aceSession=this.ace.getSession();this.aceDoc=this.aceSession.getDocument();this.aceDoc.setNewLineMode('unix');this.grabDocumentState();this.ace.on('change',this.onChange);this.ace.on('blur',this.onBlur);this.ace.on('focus',this.onFocus);this.aceSession.selection.on('changeCursor',this.onCursorActivity);if(this.aceRange==null){this.aceRange=((_ref=ace.require)!=null?_ref:require)(\"ace/range\").Range;}}ACEAdapter.prototype.grabDocumentState=function(){this.lastDocLines=this.aceDoc.getAllLines();return this.lastCursorRange=this.aceSession.selection.getRange();};ACEAdapter.prototype.detach=function(){this.ace.removeListener('change',this.onChange);this.ace.removeListener('blur',this.onBlur);this.ace.removeListener('focus',this.onCursorActivity);return this.aceSession.selection.removeListener('changeCursor',this.onCursorActivity);};ACEAdapter.prototype.onChange=function(change){var pair;if(!this.ignoreChanges){pair=this.operationFromACEChange(change);this.trigger.apply(this,['change'].concat(__slice.call(pair)));return this.grabDocumentState();}};ACEAdapter.prototype.onBlur=function(){if(this.ace.selection.isEmpty()){return this.trigger('blur');}};ACEAdapter.prototype.onFocus=function(){return this.trigger('focus');};ACEAdapter.prototype.onCursorActivity=function(){var _this=this;return setTimeout(function(){return _this.trigger('cursorActivity');},0);};ACEAdapter.prototype.operationFromACEChange=function(change){var action,delete_op,delta,insert_op,restLength,start,text,_ref;if(change.data){delta=change.data;if((_ref=delta.action)==='insertLines'||_ref==='removeLines'){text=delta.lines.join('\\n')+'\\n';action=delta.action.replace('Lines','');}else{text=delta.text.replace(this.aceDoc.getNewLineCharacter(),'\\n');action=delta.action.replace('Text','');}start=this.indexFromPos(delta.range.start);}else{text=change.lines.join('\\n');start=this.indexFromPos(change.start);}restLength=this.lastDocLines.join('\\n').length-start;if(change.action==='remove'){restLength-=text.length;}insert_op=new firepad.TextOperation().retain(start).insert(text).retain(restLength);delete_op=new firepad.TextOperation().retain(start)[\"delete\"](text).retain(restLength);if(change.action==='remove'){return[delete_op,insert_op];}else{return[insert_op,delete_op];}};ACEAdapter.prototype.applyOperationToACE=function(operation){var from,index,op,range,to,_i,_len,_ref;index=0;_ref=operation.ops;for(_i=0,_len=_ref.length;_i<_len;_i++){op=_ref[_i];if(op.isRetain()){index+=op.chars;}else if(op.isInsert()){this.aceDoc.insert(this.posFromIndex(index),op.text);index+=op.text.length;}else if(op.isDelete()){from=this.posFromIndex(index);to=this.posFromIndex(index+op.chars);range=this.aceRange.fromPoints(from,to);this.aceDoc.remove(range);}}return this.grabDocumentState();};ACEAdapter.prototype.posFromIndex=function(index){var line,row,_i,_len,_ref;_ref=this.aceDoc.$lines;for(row=_i=0,_len=_ref.length;_i<_len;row=++_i){line=_ref[row];if(index<=line.length){break;}index-=line.length+1;}return{row:row,column:index};};ACEAdapter.prototype.indexFromPos=function(pos,lines){var i,index,_i,_ref;if(lines==null){lines=this.lastDocLines;}index=0;for(i=_i=0,_ref=pos.row;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){index+=this.lastDocLines[i].length+1;}return index+=pos.column;};ACEAdapter.prototype.getValue=function(){return this.aceDoc.getValue();};ACEAdapter.prototype.getCursor=function(){var e,e2,end,start,_ref,_ref1;try{start=this.indexFromPos(this.aceSession.selection.getRange().start,this.aceDoc.$lines);end=this.indexFromPos(this.aceSession.selection.getRange().end,this.aceDoc.$lines);}catch(_error){e=_error;try{start=this.indexFromPos(this.lastCursorRange.start);end=this.indexFromPos(this.lastCursorRange.end);}catch(_error){e2=_error;console.log(\"Couldn't figure out the cursor range:\",e2,\"-- setting it to 0:0.\");_ref=[0,0],start=_ref[0],end=_ref[1];}}if(start>end){_ref1=[end,start],start=_ref1[0],end=_ref1[1];}return new firepad.Cursor(start,end);};ACEAdapter.prototype.setCursor=function(cursor){var end,start,_ref;start=this.posFromIndex(cursor.position);end=this.posFromIndex(cursor.selectionEnd);if(cursor.position>cursor.selectionEnd){_ref=[end,start],start=_ref[0],end=_ref[1];}return this.aceSession.selection.setSelectionRange(new this.aceRange(start.row,start.column,end.row,end.column));};ACEAdapter.prototype.setOtherCursor=function(cursor,color,clientId){var clazz,css,cursorRange,end,justCursor,self,start,_ref,_this=this;if(this.otherCursors==null){this.otherCursors={};}cursorRange=this.otherCursors[clientId];if(cursorRange){cursorRange.start.detach();cursorRange.end.detach();this.aceSession.removeMarker(cursorRange.id);}start=this.posFromIndex(cursor.position);end=this.posFromIndex(cursor.selectionEnd);if(cursor.selectionEnd<cursor.position){_ref=[end,start],start=_ref[0],end=_ref[1];}clazz=\"other-client-selection-\"+color.replace('#','');justCursor=cursor.position===cursor.selectionEnd;if(justCursor){clazz=clazz.replace('selection','cursor');}css=\".\"+clazz+\" {\\n  position: absolute;\\n  background-color: \"+(justCursor?'transparent':color)+\";\\n  border-left: 2px solid \"+color+\";\\n}\";this.addStyleRule(css);this.otherCursors[clientId]=cursorRange=new this.aceRange(start.row,start.column,end.row,end.column);self=this;cursorRange.clipRows=function(){var range;range=self.aceRange.prototype.clipRows.apply(this,arguments);range.isEmpty=function(){return false;};return range;};cursorRange.start=this.aceDoc.createAnchor(cursorRange.start);cursorRange.end=this.aceDoc.createAnchor(cursorRange.end);cursorRange.id=this.aceSession.addMarker(cursorRange,clazz,\"text\");return{clear:function clear(){cursorRange.start.detach();cursorRange.end.detach();return _this.aceSession.removeMarker(cursorRange.id);}};};ACEAdapter.prototype.addStyleRule=function(css){var styleElement;if(typeof document===\"undefined\"||document===null){return;}if(!this.addedStyleRules){this.addedStyleRules={};styleElement=document.createElement('style');document.documentElement.getElementsByTagName('head')[0].appendChild(styleElement);this.addedStyleSheet=styleElement.sheet;}if(this.addedStyleRules[css]){return;}this.addedStyleRules[css]=true;return this.addedStyleSheet.insertRule(css,0);};ACEAdapter.prototype.registerCallbacks=function(callbacks){this.callbacks=callbacks;};ACEAdapter.prototype.trigger=function(){var args,event,_ref,_ref1;event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];return(_ref=this.callbacks)!=null?(_ref1=_ref[event])!=null?_ref1.apply(this,args):void 0:void 0;};ACEAdapter.prototype.applyOperation=function(operation){if(!operation.isNoop()){this.ignoreChanges=true;}this.applyOperationToACE(operation);return this.ignoreChanges=false;};ACEAdapter.prototype.registerUndo=function(undoFn){return this.ace.undo=undoFn;};ACEAdapter.prototype.registerRedo=function(redoFn){return this.ace.redo=redoFn;};ACEAdapter.prototype.invertOperation=function(operation){return operation.invert(this.getValue());};return ACEAdapter;}();var firepad=firepad||{};firepad.AttributeConstants={BOLD:'b',ITALIC:'i',UNDERLINE:'u',STRIKE:'s',FONT:'f',FONT_SIZE:'fs',COLOR:'c',BACKGROUND_COLOR:'bc',ENTITY_SENTINEL:'ent',// Line Attributes\nLINE_SENTINEL:'l',LINE_INDENT:'li',LINE_ALIGN:'la',LIST_TYPE:'lt'};firepad.sentinelConstants={// A special character we insert at the beginning of lines so we can attach attributes to it to represent\n// \"line attributes.\"  E000 is from the unicode \"private use\" range.\nLINE_SENTINEL_CHARACTER:\"\\uE000\",// A special character used to represent any \"entity\" inserted into the document (e.g. an image).\nENTITY_SENTINEL_CHARACTER:\"\\uE001\"};var firepad=firepad||{};firepad.EntityManager=function(){var utils=firepad.utils;function EntityManager(){this.entities_={};var attrs=['src','alt','width','height','style','class'];this.register('img',{render:function render(info){utils.assert(info.src,\"image entity should have 'src'!\");var attrs=['src','alt','width','height','style','class'];var html='<img ';for(var i=0;i<attrs.length;i++){var attr=attrs[i];if(attr in info){html+=' '+attr+'=\"'+info[attr]+'\"';}}html+=\">\";return html;},fromElement:function fromElement(element){var info={};for(var i=0;i<attrs.length;i++){var attr=attrs[i];if(element.hasAttribute(attr)){info[attr]=element.getAttribute(attr);}}return info;}});}EntityManager.prototype.register=function(type,options){firepad.utils.assert(options.render,\"Entity options should include a 'render' function!\");firepad.utils.assert(options.fromElement,\"Entity options should include a 'fromElement' function!\");this.entities_[type]=options;};EntityManager.prototype.renderToElement=function(entity,entityHandle){return this.tryRenderToElement_(entity,'render',entityHandle);};EntityManager.prototype.exportToElement=function(entity){// Turns out 'export' is a reserved keyword, so 'getHtml' is preferable.\nvar elt=this.tryRenderToElement_(entity,'export')||this.tryRenderToElement_(entity,'getHtml')||this.tryRenderToElement_(entity,'render');elt.setAttribute('data-firepad-entity',entity.type);return elt;};/* Updates a DOM element to reflect the given entity.\n     If the entity doesn't support the update method, it is fully\n     re-rendered.\n  */EntityManager.prototype.updateElement=function(entity,element){var type=entity.type;var info=entity.info;if(this.entities_[type]&&typeof this.entities_[type].update!='undefined'){this.entities_[type].update(info,element);}};EntityManager.prototype.fromElement=function(element){var type=element.getAttribute('data-firepad-entity');// HACK.  This should be configurable through entity registration.\nif(!type)type=element.nodeName.toLowerCase();if(type&&this.entities_[type]){var info=this.entities_[type].fromElement(element);return new firepad.Entity(type,info);}};EntityManager.prototype.tryRenderToElement_=function(entity,renderFn,entityHandle){var type=entity.type,info=entity.info;if(this.entities_[type]&&this.entities_[type][renderFn]){var windowDocument=firepad.document||window&&window.document;var res=this.entities_[type][renderFn](info,entityHandle,windowDocument);if(res){if(typeof res==='string'){var div=(firepad.document||document).createElement('div');div.innerHTML=res;return div.childNodes[0];}else if(typeof res==='object'){firepad.utils.assert(typeof res.nodeType!=='undefined','Error rendering '+type+' entity.  render() function'+' must return an html string or a DOM element.');return res;}}}};EntityManager.prototype.entitySupportsUpdate=function(entityType){return this.entities_[entityType]&&this.entities_[entityType]['update'];};return EntityManager;}();var firepad=firepad||{};/**\n * Object to represent an Entity.\n */firepad.Entity=function(){var ATTR=firepad.AttributeConstants;var SENTINEL=ATTR.ENTITY_SENTINEL;var PREFIX=SENTINEL+'_';function Entity(type,info){// Allow calling without new.\nif(!(this instanceof Entity)){return new Entity(type,info);}this.type=type;this.info=info||{};}Entity.prototype.toAttributes=function(){var attrs={};attrs[SENTINEL]=this.type;for(var attr in this.info){attrs[PREFIX+attr]=this.info[attr];}return attrs;};Entity.fromAttributes=function(attributes){var type=attributes[SENTINEL];var info={};for(var attr in attributes){if(attr.indexOf(PREFIX)===0){info[attr.substr(PREFIX.length)]=attributes[attr];}}return new Entity(type,info);};return Entity;}();var firepad=firepad||{};firepad.RichTextCodeMirror=function(){var AnnotationList=firepad.AnnotationList;var Span=firepad.Span;var utils=firepad.utils;var ATTR=firepad.AttributeConstants;var RichTextClassPrefixDefault='cmrt-';var RichTextOriginPrefix='cmrt-';// These attributes will have styles generated dynamically in the page.\nvar DynamicStyleAttributes={'c':'color','bc':'background-color','fs':'font-size','li':function li(indent){return'padding-left: '+indent*40+'px';}};// A cache of dynamically-created styles so we can re-use them.\nvar StyleCache_={};function RichTextCodeMirror(codeMirror,entityManager,options){this.codeMirror=codeMirror;this.options_=options||{};this.entityManager_=entityManager;this.currentAttributes_=null;var self=this;this.annotationList_=new AnnotationList(function(oldNodes,newNodes){self.onAnnotationsChanged_(oldNodes,newNodes);});// Ensure annotationList is in sync with any existing codemirror contents.\nthis.initAnnotationList_();bind(this,'onCodeMirrorBeforeChange_');bind(this,'onCodeMirrorChange_');bind(this,'onCursorActivity_');if(parseInt(CodeMirror.version)>=4){this.codeMirror.on('changes',this.onCodeMirrorChange_);}else{this.codeMirror.on('change',this.onCodeMirrorChange_);}this.codeMirror.on('beforeChange',this.onCodeMirrorBeforeChange_);this.codeMirror.on('cursorActivity',this.onCursorActivity_);this.changeId_=0;this.outstandingChanges_={};this.dirtyLines_=[];}utils.makeEventEmitter(RichTextCodeMirror,['change','attributesChange','newLine']);var LineSentinelCharacter=firepad.sentinelConstants.LINE_SENTINEL_CHARACTER;var EntitySentinelCharacter=firepad.sentinelConstants.ENTITY_SENTINEL_CHARACTER;RichTextCodeMirror.prototype.detach=function(){this.codeMirror.off('beforeChange',this.onCodeMirrorBeforeChange_);this.codeMirror.off('change',this.onCodeMirrorChange_);this.codeMirror.off('changes',this.onCodeMirrorChange_);this.codeMirror.off('cursorActivity',this.onCursorActivity_);this.clearAnnotations_();};RichTextCodeMirror.prototype.toggleAttribute=function(attribute,value){var trueValue=value||true;if(this.emptySelection_()){var attrs=this.getCurrentAttributes_();if(attrs[attribute]===trueValue){delete attrs[attribute];}else{attrs[attribute]=trueValue;}this.currentAttributes_=attrs;}else{var attributes=this.getCurrentAttributes_();var newValue=attributes[attribute]!==trueValue?trueValue:false;this.setAttribute(attribute,newValue);}};RichTextCodeMirror.prototype.setAttribute=function(attribute,value){var cm=this.codeMirror;if(this.emptySelection_()){var attrs=this.getCurrentAttributes_();if(value===false){delete attrs[attribute];}else{attrs[attribute]=value;}this.currentAttributes_=attrs;}else{this.updateTextAttributes(cm.indexFromPos(cm.getCursor('start')),cm.indexFromPos(cm.getCursor('end')),function(attributes){if(value===false){delete attributes[attribute];}else{attributes[attribute]=value;}});this.updateCurrentAttributes_();}};RichTextCodeMirror.prototype.updateTextAttributes=function(start,end,updateFn,origin,doLineAttributes){var newChanges=[];var pos=start,self=this;this.annotationList_.updateSpan(new Span(start,end-start),function(annotation,length){var attributes={};for(var attr in annotation.attributes){attributes[attr]=annotation.attributes[attr];}// Don't modify if this is a line sentinel.\nif(!attributes[ATTR.LINE_SENTINEL]||doLineAttributes)updateFn(attributes);// changedAttributes will be the attributes we changed, with their new values.\n// changedAttributesInverse will be the attributes we changed, with their old values.\nvar changedAttributes={},changedAttributesInverse={};self.computeChangedAttributes_(annotation.attributes,attributes,changedAttributes,changedAttributesInverse);if(!emptyAttributes(changedAttributes)){newChanges.push({start:pos,end:pos+length,attributes:changedAttributes,attributesInverse:changedAttributesInverse,origin:origin});}pos+=length;return new RichTextAnnotation(attributes);});if(newChanges.length>0){this.trigger('attributesChange',this,newChanges);}};RichTextCodeMirror.prototype.computeChangedAttributes_=function(oldAttrs,newAttrs,changed,inverseChanged){var attrs={},attr;for(attr in oldAttrs){attrs[attr]=true;}for(attr in newAttrs){attrs[attr]=true;}for(attr in attrs){if(!(attr in newAttrs)){// it was removed.\nchanged[attr]=false;inverseChanged[attr]=oldAttrs[attr];}else if(!(attr in oldAttrs)){// it was added.\nchanged[attr]=newAttrs[attr];inverseChanged[attr]=false;}else if(oldAttrs[attr]!==newAttrs[attr]){// it was changed.\nchanged[attr]=newAttrs[attr];inverseChanged[attr]=oldAttrs[attr];}}};RichTextCodeMirror.prototype.toggleLineAttribute=function(attribute,value){var currentAttributes=this.getCurrentLineAttributes_();var newValue;if(!(attribute in currentAttributes)||currentAttributes[attribute]!==value){newValue=value;}else{newValue=false;}this.setLineAttribute(attribute,newValue);};RichTextCodeMirror.prototype.setLineAttribute=function(attribute,value){this.updateLineAttributesForSelection(function(attributes){if(value===false){delete attributes[attribute];}else{attributes[attribute]=value;}});};RichTextCodeMirror.prototype.updateLineAttributesForSelection=function(updateFn){var cm=this.codeMirror;var start=cm.getCursor('start'),end=cm.getCursor('end');var startLine=start.line,endLine=end.line;var endLineText=cm.getLine(endLine);var endsAtBeginningOfLine=this.areLineSentinelCharacters_(endLineText.substr(0,end.ch));if(endLine>startLine&&endsAtBeginningOfLine){// If the selection ends at the beginning of a line, don't include that line.\nendLine--;}this.updateLineAttributes(startLine,endLine,updateFn);};RichTextCodeMirror.prototype.updateLineAttributes=function(startLine,endLine,updateFn){// TODO: Batch this into a single operation somehow.\nfor(var line=startLine;line<=endLine;line++){var text=this.codeMirror.getLine(line);var lineStartIndex=this.codeMirror.indexFromPos({line:line,ch:0});// Create line sentinel character if necessary.\nif(text[0]!==LineSentinelCharacter){var attributes={};attributes[ATTR.LINE_SENTINEL]=true;updateFn(attributes);this.insertText(lineStartIndex,LineSentinelCharacter,attributes);}else{this.updateTextAttributes(lineStartIndex,lineStartIndex+1,updateFn,/*origin=*/null,/*doLineAttributes=*/true);}}};RichTextCodeMirror.prototype.replaceText=function(start,end,text,attributes,origin){this.changeId_++;var newOrigin=RichTextOriginPrefix+this.changeId_;this.outstandingChanges_[newOrigin]={origOrigin:origin,attributes:attributes};var cm=this.codeMirror;var from=cm.posFromIndex(start);var to=typeof end==='number'?cm.posFromIndex(end):null;cm.replaceRange(text,from,to,newOrigin);};RichTextCodeMirror.prototype.insertText=function(index,text,attributes,origin){var cm=this.codeMirror;var cursor=cm.getCursor();var resetCursor=origin=='RTCMADAPTER'&&!cm.somethingSelected()&&index==cm.indexFromPos(cursor);this.replaceText(index,null,text,attributes,origin);if(resetCursor)cm.setCursor(cursor);};RichTextCodeMirror.prototype.removeText=function(start,end,origin){var cm=this.codeMirror;cm.replaceRange(\"\",cm.posFromIndex(start),cm.posFromIndex(end),origin);};RichTextCodeMirror.prototype.insertEntityAtCursor=function(type,info,origin){var cm=this.codeMirror;var index=cm.indexFromPos(cm.getCursor('head'));this.insertEntityAt(index,type,info,origin);};RichTextCodeMirror.prototype.insertEntityAt=function(index,type,info,origin){var cm=this.codeMirror;this.insertEntity_(index,new firepad.Entity(type,info),origin);};RichTextCodeMirror.prototype.insertEntity_=function(index,entity,origin){this.replaceText(index,null,EntitySentinelCharacter,entity.toAttributes(),origin);};RichTextCodeMirror.prototype.getAttributeSpans=function(start,end){var spans=[];var annotatedSpans=this.annotationList_.getAnnotatedSpansForSpan(new Span(start,end-start));for(var i=0;i<annotatedSpans.length;i++){spans.push({length:annotatedSpans[i].length,attributes:annotatedSpans[i].annotation.attributes});}return spans;};RichTextCodeMirror.prototype.end=function(){var lastLine=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:lastLine,ch:this.codeMirror.getLine(lastLine).length});};RichTextCodeMirror.prototype.getRange=function(start,end){var from=this.codeMirror.posFromIndex(start),to=this.codeMirror.posFromIndex(end);return this.codeMirror.getRange(from,to);};RichTextCodeMirror.prototype.initAnnotationList_=function(){// Insert empty annotation span for existing content.\nvar end=this.end();if(end!==0){this.annotationList_.insertAnnotatedSpan(new Span(0,end),new RichTextAnnotation());}};/**\n   * Updates the nodes of an Annotation.\n   * @param {Array.<OldAnnotatedSpan>} oldNodes The list of nodes to replace.\n   * @param {Array.<NewAnnotatedSpan>} newNodes The new list of nodes.\n   */RichTextCodeMirror.prototype.onAnnotationsChanged_=function(oldNodes,newNodes){var marker;var linesToReMark={};// Update any entities in-place that we can.  This will remove them from the oldNodes/newNodes lists\n// so we don't remove and recreate them below.\nthis.tryToUpdateEntitiesInPlace(oldNodes,newNodes);for(var i=0;i<oldNodes.length;i++){var attributes=oldNodes[i].annotation.attributes;if(ATTR.LINE_SENTINEL in attributes){linesToReMark[this.codeMirror.posFromIndex(oldNodes[i].pos).line]=true;}marker=oldNodes[i].getAttachedObject();if(marker){marker.clear();}}for(i=0;i<newNodes.length;i++){var annotation=newNodes[i].annotation;var forLine=ATTR.LINE_SENTINEL in annotation.attributes;var entity=ATTR.ENTITY_SENTINEL in annotation.attributes;var from=this.codeMirror.posFromIndex(newNodes[i].pos);if(forLine){linesToReMark[from.line]=true;}else if(entity){this.markEntity_(newNodes[i]);}else{var className=this.getClassNameForAttributes_(annotation.attributes);if(className!==''){var to=this.codeMirror.posFromIndex(newNodes[i].pos+newNodes[i].length);marker=this.codeMirror.markText(from,to,{className:className});newNodes[i].attachObject(marker);}}}for(var line in linesToReMark){this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(line)));this.queueLineMarking_();}};RichTextCodeMirror.prototype.tryToUpdateEntitiesInPlace=function(oldNodes,newNodes){// Loop over nodes in reverse order so we can easily splice them out as necessary.\nvar oldNodesLen=oldNodes.length;while(oldNodesLen--){var oldNode=oldNodes[oldNodesLen];var newNodesLen=newNodes.length;while(newNodesLen--){var newNode=newNodes[newNodesLen];if(oldNode.pos==newNode.pos&&oldNode.length==newNode.length&&oldNode.annotation.attributes['ent']&&oldNode.annotation.attributes['ent']==newNode.annotation.attributes['ent']){var entityType=newNode.annotation.attributes['ent'];if(this.entityManager_.entitySupportsUpdate(entityType)){// Update it in place and remove the change from oldNodes / newNodes so we don't process it below.\noldNodes.splice(oldNodesLen,1);newNodes.splice(newNodesLen,1);var marker=oldNode.getAttachedObject();marker.update(newNode.annotation.attributes);newNode.attachObject(marker);}}}}};RichTextCodeMirror.prototype.queueLineMarking_=function(){if(this.lineMarkTimeout_!=null)return;var self=this;this.lineMarkTimeout_=setTimeout(function(){self.lineMarkTimeout_=null;var dirtyLineNumbers=[];for(var i=0;i<self.dirtyLines_.length;i++){var lineNum=self.codeMirror.getLineNumber(self.dirtyLines_[i]);dirtyLineNumbers.push(Number(lineNum));}self.dirtyLines_=[];dirtyLineNumbers.sort(function(a,b){return a-b;});var lastLineMarked=-1;for(i=0;i<dirtyLineNumbers.length;i++){var lineNumber=dirtyLineNumbers[i];if(lineNumber>lastLineMarked){lastLineMarked=self.markLineSentinelCharactersForChangedLines_(lineNumber,lineNumber);}}},0);};RichTextCodeMirror.prototype.addStyleWithCSS_=function(css){var head=document.getElementsByTagName('head')[0],style=document.createElement('style');style.type='text/css';if(style.styleSheet){style.styleSheet.cssText=css;}else{style.appendChild(document.createTextNode(css));}head.appendChild(style);};RichTextCodeMirror.prototype.getClassNameForAttributes_=function(attributes){var globalClassName='';for(var attr in attributes){var val=attributes[attr];if(attr===ATTR.LINE_SENTINEL){firepad.utils.assert(val===true,\"LINE_SENTINEL attribute should be true if it exists.\");}else{var className=(this.options_['cssPrefix']||RichTextClassPrefixDefault)+attr;if(val!==true){// Append \"px\" to font size if it's missing.\n// Probably could be removed now as parseHtml automatically adds px when required\nif(attr===ATTR.FONT_SIZE&&typeof val!==\"string\"){val=val+\"px\";}var classVal=val.toString().toLowerCase().replace(/[^a-z0-9-_]/g,'-');className+='-'+classVal;if(DynamicStyleAttributes[attr]){if(!StyleCache_[attr])StyleCache_[attr]={};if(!StyleCache_[attr][classVal]){StyleCache_[attr][classVal]=true;var dynStyle=DynamicStyleAttributes[attr];var css=typeof dynStyle==='function'?dynStyle(val):dynStyle+\": \"+val;var selector=attr==ATTR.LINE_INDENT?'pre.'+className:'.'+className;this.addStyleWithCSS_(selector+' { '+css+' }');}}}globalClassName=globalClassName+' '+className;}}return globalClassName;};RichTextCodeMirror.prototype.markEntity_=function(annotationNode){var attributes=annotationNode.annotation.attributes;var entity=firepad.Entity.fromAttributes(attributes);var cm=this.codeMirror;var self=this;var markers=[];for(var i=0;i<annotationNode.length;i++){var from=cm.posFromIndex(annotationNode.pos+i);var to=cm.posFromIndex(annotationNode.pos+i+1);var options={collapsed:true,atomic:true,inclusiveLeft:false,inclusiveRight:false};var entityHandle=this.createEntityHandle_(entity,annotationNode.pos);var element=this.entityManager_.renderToElement(entity,entityHandle);if(element){options.replacedWith=element;}var marker=cm.markText(from,to,options);markers.push(marker);entityHandle.setMarker(marker);}annotationNode.attachObject({clear:function clear(){for(var i=0;i<markers.length;i++){markers[i].clear();}},/**\n       * Updates the attributes of all the AnnotationNode entities.\n       * @param {Object.<string, string>} info The full list of new\n       *     attributes to apply.\n       */update:function update(info){var entity=firepad.Entity.fromAttributes(info);for(var i=0;i<markers.length;i++){self.entityManager_.updateElement(entity,markers[i].replacedWith);}}});// This probably shouldn't be necessary.  There must be a lurking CodeMirror bug.\nthis.queueRefresh_();};RichTextCodeMirror.prototype.queueRefresh_=function(){var self=this;if(!this.refreshTimer_){this.refreshTimer_=setTimeout(function(){self.codeMirror.refresh();self.refreshTimer_=null;},0);}};RichTextCodeMirror.prototype.createEntityHandle_=function(entity,location){var marker=null;var self=this;function find(){if(marker){var where=marker.find();return where?self.codeMirror.indexFromPos(where.from):null;}else{return location;}}function remove(){var at=find();if(at!=null){self.codeMirror.focus();self.removeText(at,at+1);}}/**\n     * Updates the attributes of an Entity.  Will call .update() if the entity supports it,\n     * else it'll just remove / re-create the entity.\n     * @param {Object.<string, string>} info The full list of new\n     *     attributes to apply.\n     */function replace(info){var ATTR=firepad.AttributeConstants;var SENTINEL=ATTR.ENTITY_SENTINEL;var PREFIX=SENTINEL+'_';var at=find();self.updateTextAttributes(at,at+1,function(attrs){for(var member in attrs){delete attrs[member];}attrs[SENTINEL]=entity.type;for(var attr in info){attrs[PREFIX+attr]=info[attr];}});}function setMarker(m){marker=m;}return{find:find,remove:remove,replace:replace,setMarker:setMarker};};RichTextCodeMirror.prototype.lineClassRemover_=function(lineNum){var cm=this.codeMirror;var lineHandle=cm.getLineHandle(lineNum);return{clear:function clear(){// HACK to remove all classes (since CodeMirror treats this as a regex internally).\ncm.removeLineClass(lineHandle,\"text\",\".*\");}};};RichTextCodeMirror.prototype.emptySelection_=function(){var start=this.codeMirror.getCursor('start'),end=this.codeMirror.getCursor('end');return start.line===end.line&&start.ch===end.ch;};RichTextCodeMirror.prototype.onCodeMirrorBeforeChange_=function(cm,change){// Remove LineSentinelCharacters from incoming input (e.g copy/pasting)\nif(change.origin==='+input'||change.origin==='paste'){var newText=[];for(var i=0;i<change.text.length;i++){var t=change.text[i];t=t.replace(new RegExp('['+LineSentinelCharacter+EntitySentinelCharacter+']','g'),'');newText.push(t);}change.update(change.from,change.to,newText);}};function cmpPos(a,b){return a.line-b.line||a.ch-b.ch;}function posEq(a,b){return cmpPos(a,b)===0;}function posLe(a,b){return cmpPos(a,b)<=0;}function last(arr){return arr[arr.length-1];}function sumLengths(strArr){if(strArr.length===0){return 0;}var sum=0;for(var i=0;i<strArr.length;i++){sum+=strArr[i].length;}return sum+strArr.length-1;}RichTextCodeMirror.prototype.onCodeMirrorChange_=function(cm,cmChanges){// Handle single change objects and linked lists of change objects.\nif(typeof cmChanges.from==='object'){var changeArray=[];while(cmChanges){changeArray.push(cmChanges);cmChanges=cmChanges.next;}cmChanges=changeArray;}var changes=this.convertCoordinateSystemForChanges_(cmChanges);var newChanges=[];for(var i=0;i<changes.length;i++){var change=changes[i];var start=change.start,end=change.end,text=change.text,removed=change.removed,origin=change.origin;// When text with multiple sets of attributes on it is removed, we need to split it into separate remove changes.\nif(removed.length>0){var oldAnnotationSpans=this.annotationList_.getAnnotatedSpansForSpan(new Span(start,removed.length));var removedPos=0;for(var j=0;j<oldAnnotationSpans.length;j++){var span=oldAnnotationSpans[j];newChanges.push({start:start,end:start+span.length,removedAttributes:span.annotation.attributes,removed:removed.substr(removedPos,span.length),attributes:{},text:\"\",origin:change.origin});removedPos+=span.length;}this.annotationList_.removeSpan(new Span(start,removed.length));}if(text.length>0){var attributes;// TODO: Handle 'paste' differently?\nif(change.origin==='+input'||change.origin==='paste'){attributes=this.currentAttributes_||{};}else if(origin in this.outstandingChanges_){attributes=this.outstandingChanges_[origin].attributes;origin=this.outstandingChanges_[origin].origOrigin;delete this.outstandingChanges_[origin];}else{attributes={};}this.annotationList_.insertAnnotatedSpan(new Span(start,text.length),new RichTextAnnotation(attributes));newChanges.push({start:start,end:start,removedAttributes:{},removed:\"\",text:text,attributes:attributes,origin:origin});}}this.markLineSentinelCharactersForChanges_(cmChanges);if(newChanges.length>0){this.trigger('change',this,newChanges);}};RichTextCodeMirror.prototype.convertCoordinateSystemForChanges_=function(changes){// We have to convert the positions in the pre-change coordinate system to indexes.\n// CodeMirror's `indexFromPos` method does this for the current state of the editor.\n// We can use the information of a single change object to convert a post-change\n// coordinate system to a pre-change coordinate system. We can now proceed inductively\n// to get a pre-change coordinate system for all changes in the linked list.  A\n// disadvantage of this approach is its complexity `O(n^2)` in the length of the\n// linked list of changes.\nvar self=this;var indexFromPos=function indexFromPos(pos){return self.codeMirror.indexFromPos(pos);};function updateIndexFromPos(indexFromPos,change){return function(pos){if(posLe(pos,change.from)){return indexFromPos(pos);}if(posLe(change.to,pos)){return indexFromPos({line:pos.line+change.text.length-1-(change.to.line-change.from.line),ch:change.to.line<pos.line?pos.ch:change.text.length<=1?pos.ch-(change.to.ch-change.from.ch)+sumLengths(change.text):pos.ch-change.to.ch+last(change.text).length})+sumLengths(change.removed)-sumLengths(change.text);}if(change.from.line===pos.line){return indexFromPos(change.from)+pos.ch-change.from.ch;}return indexFromPos(change.from)+sumLengths(change.removed.slice(0,pos.line-change.from.line))+1+pos.ch;};}var newChanges=[];for(var i=changes.length-1;i>=0;i--){var change=changes[i];indexFromPos=updateIndexFromPos(indexFromPos,change);var start=indexFromPos(change.from);var removedText=change.removed.join('\\n');var text=change.text.join('\\n');newChanges.unshift({start:start,end:start+removedText.length,removed:removedText,text:text,origin:change.origin});}return newChanges;};/**\n   * Detects whether any line sentinel characters were added or removed by the change and if so,\n   * re-marks line sentinel characters on the affected range of lines.\n   * @param changes\n   * @private\n   */RichTextCodeMirror.prototype.markLineSentinelCharactersForChanges_=function(changes){// TODO: This doesn't handle multiple changes correctly (overlapping, out-of-oder, etc.).\n// But In practice, people using firepad for rich-text editing don't batch multiple changes\n// together, so this isn't quite as bad as it seems.\nvar startLine=Number.MAX_VALUE,endLine=-1;for(var i=0;i<changes.length;i++){var change=changes[i];var line=change.from.line,ch=change.from.ch;if(change.removed.length>1||change.removed[0].indexOf(LineSentinelCharacter)>=0){// We removed 1+ newlines or line sentinel characters.\nstartLine=Math.min(startLine,line);endLine=Math.max(endLine,line);}if(change.text.length>1){// 1+ newlines\nstartLine=Math.min(startLine,line);endLine=Math.max(endLine,line+change.text.length-1);}else if(change.text[0].indexOf(LineSentinelCharacter)>=0){startLine=Math.min(startLine,line);endLine=Math.max(endLine,line);}}// HACK: Because the above code doesn't handle multiple changes correctly, endLine might be invalid.  To\n// avoid crashing, we just cap it at the line count.\nendLine=Math.min(endLine,this.codeMirror.lineCount()-1);this.markLineSentinelCharactersForChangedLines_(startLine,endLine);};RichTextCodeMirror.prototype.markLineSentinelCharactersForChangedLines_=function(startLine,endLine){// Back up to first list item.\nif(startLine<Number.MAX_VALUE){while(startLine>0&&this.lineIsListItemOrIndented_(startLine-1)){startLine--;}}// Advance to last list item.\nif(endLine>-1){var lineCount=this.codeMirror.lineCount();while(endLine+1<lineCount&&this.lineIsListItemOrIndented_(endLine+1)){endLine++;}}// keeps track of the list number at each indent level.\nvar listNumber=[];var cm=this.codeMirror;for(var line=startLine;line<=endLine;line++){var text=cm.getLine(line);// Remove any existing line classes.\nvar lineHandle=cm.getLineHandle(line);cm.removeLineClass(lineHandle,\"text\",\".*\");if(text.length>0){var markIndex=text.indexOf(LineSentinelCharacter);while(markIndex>=0){var markStartIndex=markIndex;// Find the end of this series of sentinel characters, and remove any existing markers.\nwhile(markIndex<text.length&&text[markIndex]===LineSentinelCharacter){var marks=cm.findMarksAt({line:line,ch:markIndex});for(var i=0;i<marks.length;i++){if(marks[i].isForLineSentinel){marks[i].clear();}}markIndex++;}this.markLineSentinelCharacters_(line,markStartIndex,markIndex,listNumber);markIndex=text.indexOf(LineSentinelCharacter,markIndex);}}else{// Reset all indents.\nlistNumber=[];}}return endLine;};RichTextCodeMirror.prototype.markLineSentinelCharacters_=function(line,startIndex,endIndex,listNumber){var cm=this.codeMirror;// If the mark is at the beginning of the line and it represents a list element, we need to replace it with\n// the appropriate html element for the list heading.\nvar element=null;var marker=null;var getMarkerLine=function getMarkerLine(){var span=marker.find();return span?span.from.line:null;};if(startIndex===0){var attributes=this.getLineAttributes_(line);var listType=attributes[ATTR.LIST_TYPE];var indent=attributes[ATTR.LINE_INDENT]||0;if(listType&&indent===0){indent=1;}while(indent>=listNumber.length){listNumber.push(1);}if(listType==='o'){element=this.makeOrderedListElement_(listNumber[indent]);listNumber[indent]++;}else if(listType==='u'){element=this.makeUnorderedListElement_();listNumber[indent]=1;}else if(listType==='t'){element=this.makeTodoListElement_(false,getMarkerLine);listNumber[indent]=1;}else if(listType==='tc'){element=this.makeTodoListElement_(true,getMarkerLine);listNumber[indent]=1;}var className=this.getClassNameForAttributes_(attributes);if(className!==''){this.codeMirror.addLineClass(line,\"text\",className);}// Reset deeper indents back to 1.\nlistNumber=listNumber.slice(0,indent+1);}// Create a marker to cover this series of sentinel characters.\n// NOTE: The reason we treat them as a group (one marker for all subsequent sentinel characters instead of\n// one marker for each sentinel character) is that CodeMirror seems to get angry if we don't.\nvar markerOptions={inclusiveLeft:true,collapsed:true};if(element){markerOptions.replacedWith=element;}var marker=cm.markText({line:line,ch:startIndex},{line:line,ch:endIndex},markerOptions);// track that it's a line-sentinel character so we can identify it later.\nmarker.isForLineSentinel=true;};RichTextCodeMirror.prototype.makeOrderedListElement_=function(number){return utils.elt('div',number+'.',{'class':'firepad-list-left'});};RichTextCodeMirror.prototype.makeUnorderedListElement_=function(){return utils.elt('div',\"\\u2022\",{'class':'firepad-list-left'});};RichTextCodeMirror.prototype.toggleTodo=function(noRemove){var attribute=ATTR.LIST_TYPE;var currentAttributes=this.getCurrentLineAttributes_();var newValue;if(!(attribute in currentAttributes)||currentAttributes[attribute]!=='t'&&currentAttributes[attribute]!=='tc'){newValue='t';}else if(currentAttributes[attribute]==='t'){newValue='tc';}else if(currentAttributes[attribute]==='tc'){newValue=noRemove?'t':false;}this.setLineAttribute(attribute,newValue);};RichTextCodeMirror.prototype.makeTodoListElement_=function(checked,getMarkerLine){var params={'type':\"checkbox\",'class':'firepad-todo-left'};if(checked)params['checked']=true;var el=utils.elt('input',false,params);var self=this;utils.on(el,'click',utils.stopEventAnd(function(e){self.codeMirror.setCursor({line:getMarkerLine(),ch:1});self.toggleTodo(true);}));return el;};RichTextCodeMirror.prototype.lineIsListItemOrIndented_=function(lineNum){var attrs=this.getLineAttributes_(lineNum);return(attrs[ATTR.LIST_TYPE]||false)!==false||(attrs[ATTR.LINE_INDENT]||0)!==0;};RichTextCodeMirror.prototype.onCursorActivity_=function(){var self=this;setTimeout(function(){self.updateCurrentAttributes_();},1);};RichTextCodeMirror.prototype.getCurrentAttributes_=function(){if(!this.currentAttributes_){this.updateCurrentAttributes_();}return this.currentAttributes_;};RichTextCodeMirror.prototype.updateCurrentAttributes_=function(){var cm=this.codeMirror;var anchor=cm.indexFromPos(cm.getCursor('anchor')),head=cm.indexFromPos(cm.getCursor('head'));var pos=head;if(anchor>head){// backwards selection\n// Advance past any newlines or line sentinels.\nwhile(pos<this.end()){var c=this.getRange(pos,pos+1);if(c!=='\\n'&&c!==LineSentinelCharacter)break;pos++;}if(pos<this.end())pos++;// since we're going to look at the annotation span to the left to decide what attributes to use.\n}else{// Back up before any newlines or line sentinels.\nwhile(pos>0){c=this.getRange(pos-1,pos);if(c!=='\\n'&&c!==LineSentinelCharacter)break;pos--;}}var spans=this.annotationList_.getAnnotatedSpansForPos(pos);this.currentAttributes_={};var attributes={};// Use the attributes to the left unless they're line attributes (in which case use the ones to the right.\nif(spans.length>0&&!(ATTR.LINE_SENTINEL in spans[0].annotation.attributes)){attributes=spans[0].annotation.attributes;}else if(spans.length>1){firepad.utils.assert(!(ATTR.LINE_SENTINEL in spans[1].annotation.attributes),\"Cursor can't be between two line sentinel characters.\");attributes=spans[1].annotation.attributes;}for(var attr in attributes){// Don't copy line or entity attributes.\nif(attr!=='l'&&attr!=='lt'&&attr!=='li'&&attr.indexOf(ATTR.ENTITY_SENTINEL)!==0){this.currentAttributes_[attr]=attributes[attr];}}};RichTextCodeMirror.prototype.getCurrentLineAttributes_=function(){var cm=this.codeMirror;var anchor=cm.getCursor('anchor'),head=cm.getCursor('head');var line=head.line;// If it's a forward selection and the cursor is at the beginning of a line, use the previous line.\nif(head.ch===0&&anchor.line<head.line){line--;}return this.getLineAttributes_(line);};RichTextCodeMirror.prototype.getLineAttributes_=function(lineNum){var attributes={};var line=this.codeMirror.getLine(lineNum);if(line.length>0&&line[0]===LineSentinelCharacter){var lineStartIndex=this.codeMirror.indexFromPos({line:lineNum,ch:0});var spans=this.annotationList_.getAnnotatedSpansForSpan(new Span(lineStartIndex,1));firepad.utils.assert(spans.length===1);for(var attr in spans[0].annotation.attributes){attributes[attr]=spans[0].annotation.attributes[attr];}}return attributes;};RichTextCodeMirror.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new Span(0,this.end()),function(annotation,length){return new RichTextAnnotation({});});};RichTextCodeMirror.prototype.newline=function(){var cm=this.codeMirror;var self=this;if(!this.emptySelection_()){cm.replaceSelection('\\n','end','+input');}else{var cursorLine=cm.getCursor('head').line;var lineAttributes=this.getLineAttributes_(cursorLine);var listType=lineAttributes[ATTR.LIST_TYPE];if(listType&&cm.getLine(cursorLine).length===1){// They hit enter on a line with just a list heading.  Just remove the list heading.\nthis.updateLineAttributes(cursorLine,cursorLine,function(attributes){delete attributes[ATTR.LIST_TYPE];delete attributes[ATTR.LINE_INDENT];});}else{cm.replaceSelection('\\n','end','+input');// Copy line attributes forward.\nthis.updateLineAttributes(cursorLine+1,cursorLine+1,function(attributes){for(var attr in lineAttributes){attributes[attr]=lineAttributes[attr];}// Don't mark new todo items as completed.\nif(listType==='tc')attributes[ATTR.LIST_TYPE]='t';self.trigger('newLine',{line:cursorLine+1,attr:attributes});});}}};RichTextCodeMirror.prototype.deleteLeft=function(){var cm=this.codeMirror;var cursorPos=cm.getCursor('head');var lineAttributes=this.getLineAttributes_(cursorPos.line);var listType=lineAttributes[ATTR.LIST_TYPE];var indent=lineAttributes[ATTR.LINE_INDENT];var backspaceAtStartOfLine=this.emptySelection_()&&cursorPos.ch===1;if(backspaceAtStartOfLine&&listType){// They hit backspace at the beginning of a line with a list heading.  Just remove the list heading.\nthis.updateLineAttributes(cursorPos.line,cursorPos.line,function(attributes){delete attributes[ATTR.LIST_TYPE];delete attributes[ATTR.LINE_INDENT];});}else if(backspaceAtStartOfLine&&indent&&indent>0){this.unindent();}else{cm.deleteH(-1,\"char\");}};RichTextCodeMirror.prototype.deleteRight=function(){var cm=this.codeMirror;var cursorPos=cm.getCursor('head');var text=cm.getLine(cursorPos.line);var emptyLine=this.areLineSentinelCharacters_(text);var nextLineText=cursorPos.line+1<cm.lineCount()?cm.getLine(cursorPos.line+1):\"\";if(this.emptySelection_()&&emptyLine&&nextLineText[0]===LineSentinelCharacter){// Delete the empty line but not the line sentinel character on the next line.\ncm.replaceRange('',{line:cursorPos.line,ch:0},{line:cursorPos.line+1,ch:0},'+input');// HACK: Once we've deleted this line, the cursor will be between the newline on the previous\n// line and the line sentinel character on the next line, which is an invalid position.\n// CodeMirror tends to therefore move it to the end of the previous line, which is undesired.\n// So we explicitly set it to ch: 0 on the current line, which seems to move it after the line\n// sentinel character(s) as desired.\n// (see https://github.com/firebase/firepad/issues/209).\ncm.setCursor({line:cursorPos.line,ch:0});}else{cm.deleteH(1,\"char\");}};RichTextCodeMirror.prototype.indent=function(){this.updateLineAttributesForSelection(function(attributes){var indent=attributes[ATTR.LINE_INDENT];var listType=attributes[ATTR.LIST_TYPE];if(indent){attributes[ATTR.LINE_INDENT]++;}else if(listType){// lists are implicitly already indented once.\nattributes[ATTR.LINE_INDENT]=2;}else{attributes[ATTR.LINE_INDENT]=1;}});};RichTextCodeMirror.prototype.unindent=function(){this.updateLineAttributesForSelection(function(attributes){var indent=attributes[ATTR.LINE_INDENT];if(indent&&indent>1){attributes[ATTR.LINE_INDENT]=indent-1;}else{delete attributes[ATTR.LIST_TYPE];delete attributes[ATTR.LINE_INDENT];}});};RichTextCodeMirror.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(LineSentinelCharacter,\"g\"),'');};RichTextCodeMirror.prototype.areLineSentinelCharacters_=function(text){for(var i=0;i<text.length;i++){if(text[i]!==LineSentinelCharacter)return false;}return true;};/**\n   * Used for the annotations we store in our AnnotationList.\n   * @param attributes\n   * @constructor\n   */function RichTextAnnotation(attributes){this.attributes=attributes||{};}RichTextAnnotation.prototype.equals=function(other){if(!(other instanceof RichTextAnnotation)){return false;}var attr;for(attr in this.attributes){if(other.attributes[attr]!==this.attributes[attr]){return false;}}for(attr in other.attributes){if(other.attributes[attr]!==this.attributes[attr]){return false;}}return true;};function emptyAttributes(attributes){for(var attr in attributes){return false;}return true;}// Bind a method to an object, so it doesn't matter whether you call\n// object.method() directly or pass object.method as a reference to another\n// function.\nfunction bind(obj,method){var fn=obj[method];obj[method]=function(){fn.apply(obj,arguments);};}return RichTextCodeMirror;}();var firepad=firepad||{};// TODO: Can this derive from CodeMirrorAdapter or similar?\nfirepad.RichTextCodeMirrorAdapter=function(){'use strict';var TextOperation=firepad.TextOperation;var WrappedOperation=firepad.WrappedOperation;var Cursor=firepad.Cursor;function RichTextCodeMirrorAdapter(rtcm){this.rtcm=rtcm;this.cm=rtcm.codeMirror;bind(this,'onChange');bind(this,'onAttributesChange');bind(this,'onCursorActivity');bind(this,'onFocus');bind(this,'onBlur');this.rtcm.on('change',this.onChange);this.rtcm.on('attributesChange',this.onAttributesChange);this.cm.on('cursorActivity',this.onCursorActivity);this.cm.on('focus',this.onFocus);this.cm.on('blur',this.onBlur);}// Removes all event listeners from the CodeMirror instance.\nRichTextCodeMirrorAdapter.prototype.detach=function(){this.rtcm.off('change',this.onChange);this.rtcm.off('attributesChange',this.onAttributesChange);this.cm.off('cursorActivity',this.onCursorActivity);this.cm.off('focus',this.onFocus);this.cm.off('blur',this.onBlur);};function cmpPos(a,b){if(a.line<b.line){return-1;}if(a.line>b.line){return 1;}if(a.ch<b.ch){return-1;}if(a.ch>b.ch){return 1;}return 0;}function posEq(a,b){return cmpPos(a,b)===0;}function posLe(a,b){return cmpPos(a,b)<=0;}function codemirrorLength(cm){var lastLine=cm.lineCount()-1;return cm.indexFromPos({line:lastLine,ch:cm.getLine(lastLine).length});}// Converts a CodeMirror change object into a TextOperation and its inverse\n// and returns them as a two-element array.\nRichTextCodeMirrorAdapter.operationFromCodeMirrorChanges=function(changes,cm){// Approach: Replay the changes, beginning with the most recent one, and\n// construct the operation and its inverse. We have to convert the position\n// in the pre-change coordinate system to an index. We have a method to\n// convert a position in the coordinate system after all changes to an index,\n// namely CodeMirror's `indexFromPos` method. We can use the information of\n// a single change object to convert a post-change coordinate system to a\n// pre-change coordinate system. We can now proceed inductively to get a\n// pre-change coordinate system for all changes in the linked list.\n// A disadvantage of this approach is its complexity `O(n^2)` in the length\n// of the linked list of changes.\nvar docEndLength=codemirrorLength(cm);var operation=new TextOperation().retain(docEndLength);var inverse=new TextOperation().retain(docEndLength);for(var i=changes.length-1;i>=0;i--){var change=changes[i];var fromIndex=change.start;var restLength=docEndLength-fromIndex-change.text.length;operation=new TextOperation().retain(fromIndex)['delete'](change.removed.length).insert(change.text,change.attributes).retain(restLength).compose(operation);inverse=inverse.compose(new TextOperation().retain(fromIndex)['delete'](change.text.length).insert(change.removed,change.removedAttributes).retain(restLength));docEndLength+=change.removed.length-change.text.length;}return[operation,inverse];};// Converts an attributes changed object to an operation and its inverse.\nRichTextCodeMirrorAdapter.operationFromAttributesChanges=function(changes,cm){var docEndLength=codemirrorLength(cm);var operation=new TextOperation(),inverse=new TextOperation();var pos=0;for(var i=0;i<changes.length;i++){var change=changes[i];var toRetain=change.start-pos;assert(toRetain>=0);// changes should be in order and non-overlapping.\noperation.retain(toRetain);inverse.retain(toRetain);var length=change.end-change.start;operation.retain(length,change.attributes);inverse.retain(length,change.attributesInverse);pos=change.start+length;}operation.retain(docEndLength-pos);inverse.retain(docEndLength-pos);return[operation,inverse];};RichTextCodeMirrorAdapter.prototype.registerCallbacks=function(cb){this.callbacks=cb;};RichTextCodeMirrorAdapter.prototype.onChange=function(_,changes){if(changes[0].origin!=='RTCMADAPTER'){var pair=RichTextCodeMirrorAdapter.operationFromCodeMirrorChanges(changes,this.cm);this.trigger('change',pair[0],pair[1]);}};RichTextCodeMirrorAdapter.prototype.onAttributesChange=function(_,changes){if(changes[0].origin!=='RTCMADAPTER'){var pair=RichTextCodeMirrorAdapter.operationFromAttributesChanges(changes,this.cm);this.trigger('change',pair[0],pair[1]);}};RichTextCodeMirrorAdapter.prototype.onCursorActivity=function(){// We want to push cursor changes to Firebase AFTER edits to the history,\n// because the cursor coordinates will already be in post-change units.\n// Sleeping for 1ms ensures that sendCursor happens after sendOperation.\nvar self=this;setTimeout(function(){self.trigger('cursorActivity');},1);};RichTextCodeMirrorAdapter.prototype.onFocus=function(){this.trigger('focus');};RichTextCodeMirrorAdapter.prototype.onBlur=function(){if(!this.cm.somethingSelected()){this.trigger('blur');}};RichTextCodeMirrorAdapter.prototype.getValue=function(){return this.cm.getValue();};RichTextCodeMirrorAdapter.prototype.getCursor=function(){var cm=this.cm;var cursorPos=cm.getCursor();var position=cm.indexFromPos(cursorPos);var selectionEnd;if(cm.somethingSelected()){var startPos=cm.getCursor(true);var selectionEndPos=posEq(cursorPos,startPos)?cm.getCursor(false):startPos;selectionEnd=cm.indexFromPos(selectionEndPos);}else{selectionEnd=position;}return new Cursor(position,selectionEnd);};RichTextCodeMirrorAdapter.prototype.setCursor=function(cursor){this.cm.setSelection(this.cm.posFromIndex(cursor.position),this.cm.posFromIndex(cursor.selectionEnd));};RichTextCodeMirrorAdapter.prototype.addStyleRule=function(css){if(typeof document===\"undefined\"||document===null){return;}if(!this.addedStyleRules){this.addedStyleRules={};var styleElement=document.createElement('style');document.documentElement.getElementsByTagName('head')[0].appendChild(styleElement);this.addedStyleSheet=styleElement.sheet;}if(this.addedStyleRules[css]){return;}this.addedStyleRules[css]=true;return this.addedStyleSheet.insertRule(css,0);};RichTextCodeMirrorAdapter.prototype.setOtherCursor=function(cursor,color,clientId){var cursorPos=this.cm.posFromIndex(cursor.position);if(typeof color!=='string'||!color.match(/^#[a-fA-F0-9]{3,6}$/)){return;}var end=this.rtcm.end();if(typeof cursor!=='object'||typeof cursor.position!=='number'||typeof cursor.selectionEnd!=='number'){return;}if(cursor.position<0||cursor.position>end||cursor.selectionEnd<0||cursor.selectionEnd>end){return;}if(cursor.position===cursor.selectionEnd){// show cursor\nvar cursorCoords=this.cm.cursorCoords(cursorPos);var cursorEl=document.createElement('span');cursorEl.className='other-client';cursorEl.style.borderLeftWidth='2px';cursorEl.style.borderLeftStyle='solid';cursorEl.style.borderLeftColor=color;cursorEl.style.marginLeft=cursorEl.style.marginRight='-1px';cursorEl.style.height=(cursorCoords.bottom-cursorCoords.top)*0.9+'px';cursorEl.setAttribute('data-clientid',clientId);cursorEl.style.zIndex=0;return this.cm.setBookmark(cursorPos,{widget:cursorEl,insertLeft:true});}else{// show selection\nvar selectionClassName='selection-'+color.replace('#','');var transparency=0.4;var rule='.'+selectionClassName+' {'+// fallback for browsers w/out rgba (rgb w/ transparency)\n' background: '+hex2rgb(color)+';\\n'+// rule with alpha takes precedence if supported\n' background: '+hex2rgb(color,transparency)+';'+'}';this.addStyleRule(rule);var fromPos,toPos;if(cursor.selectionEnd>cursor.position){fromPos=cursorPos;toPos=this.cm.posFromIndex(cursor.selectionEnd);}else{fromPos=this.cm.posFromIndex(cursor.selectionEnd);toPos=cursorPos;}return this.cm.markText(fromPos,toPos,{className:selectionClassName});}};RichTextCodeMirrorAdapter.prototype.trigger=function(event){var args=Array.prototype.slice.call(arguments,1);var action=this.callbacks&&this.callbacks[event];if(action){action.apply(this,args);}};// Apply an operation to a CodeMirror instance.\nRichTextCodeMirrorAdapter.prototype.applyOperation=function(operation){// HACK: If there are a lot of operations; hide CodeMirror so that it doesn't re-render constantly.\nif(operation.ops.length>10)this.rtcm.codeMirror.getWrapperElement().setAttribute('style','display: none');var ops=operation.ops;var index=0;// holds the current index into CodeMirror's content\nfor(var i=0,l=ops.length;i<l;i++){var op=ops[i];if(op.isRetain()){if(!emptyAttributes(op.attributes)){this.rtcm.updateTextAttributes(index,index+op.chars,function(attributes){for(var attr in op.attributes){if(op.attributes[attr]===false){delete attributes[attr];}else{attributes[attr]=op.attributes[attr];}}},'RTCMADAPTER',/*doLineAttributes=*/true);}index+=op.chars;}else if(op.isInsert()){this.rtcm.insertText(index,op.text,op.attributes,'RTCMADAPTER');index+=op.text.length;}else if(op.isDelete()){this.rtcm.removeText(index,index+op.chars,'RTCMADAPTER');}}if(operation.ops.length>10){this.rtcm.codeMirror.getWrapperElement().setAttribute('style','');this.rtcm.codeMirror.refresh();}};RichTextCodeMirrorAdapter.prototype.registerUndo=function(undoFn){this.cm.undo=undoFn;};RichTextCodeMirrorAdapter.prototype.registerRedo=function(redoFn){this.cm.redo=redoFn;};RichTextCodeMirrorAdapter.prototype.invertOperation=function(operation){var pos=0,cm=this.rtcm.codeMirror,spans,i;var inverse=new TextOperation();for(var opIndex=0;opIndex<operation.wrapped.ops.length;opIndex++){var op=operation.wrapped.ops[opIndex];if(op.isRetain()){if(emptyAttributes(op.attributes)){inverse.retain(op.chars);pos+=op.chars;}else{spans=this.rtcm.getAttributeSpans(pos,pos+op.chars);for(i=0;i<spans.length;i++){var inverseAttributes={};for(var attr in op.attributes){var opValue=op.attributes[attr];var curValue=spans[i].attributes[attr];if(opValue===false){if(curValue){inverseAttributes[attr]=curValue;}}else if(opValue!==curValue){inverseAttributes[attr]=curValue||false;}}inverse.retain(spans[i].length,inverseAttributes);pos+=spans[i].length;}}}else if(op.isInsert()){inverse['delete'](op.text.length);}else if(op.isDelete()){var text=cm.getRange(cm.posFromIndex(pos),cm.posFromIndex(pos+op.chars));spans=this.rtcm.getAttributeSpans(pos,pos+op.chars);var delTextPos=0;for(i=0;i<spans.length;i++){inverse.insert(text.substr(delTextPos,spans[i].length),spans[i].attributes);delTextPos+=spans[i].length;}pos+=op.chars;}}return new WrappedOperation(inverse,operation.meta.invert());};// Throws an error if the first argument is falsy. Useful for debugging.\nfunction assert(b,msg){if(!b){throw new Error(msg||\"assertion error\");}}// Bind a method to an object, so it doesn't matter whether you call\n// object.method() directly or pass object.method as a reference to another\n// function.\nfunction bind(obj,method){var fn=obj[method];obj[method]=function(){fn.apply(obj,arguments);};}function emptyAttributes(attrs){for(var attr in attrs){return false;}return true;}function hex2rgb(hex,transparency){if(typeof hex!=='string'){throw new TypeError('Expected a string');}hex=hex.replace(/^#/,'');if(hex.length===3){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];}var num=parseInt(hex,16);var rgb=[num>>16,num>>8&255,num&255];var type='rgb';if(exists(transparency)){type='rgba';rgb.push(transparency);}// rgb(r, g, b) or rgba(r, g, b, t)\nreturn type+'('+rgb.join(',')+')';}function exists(val){return val!==null&&val!==undefined;}return RichTextCodeMirrorAdapter;}();var firepad=firepad||{};/**\n * Immutable object to represent text formatting.  Formatting can be modified by chaining method calls.\n *\n * @constructor\n * @type {Function}\n */firepad.Formatting=function(){var ATTR=firepad.AttributeConstants;function Formatting(attributes){// Allow calling without new.\nif(!(this instanceof Formatting)){return new Formatting(attributes);}this.attributes=attributes||{};}Formatting.prototype.cloneWithNewAttribute_=function(attribute,value){var attributes={};// Copy existing.\nfor(var attr in this.attributes){attributes[attr]=this.attributes[attr];}// Add new one.\nif(value===false){delete attributes[attribute];}else{attributes[attribute]=value;}return new Formatting(attributes);};Formatting.prototype.bold=function(val){return this.cloneWithNewAttribute_(ATTR.BOLD,val);};Formatting.prototype.italic=function(val){return this.cloneWithNewAttribute_(ATTR.ITALIC,val);};Formatting.prototype.underline=function(val){return this.cloneWithNewAttribute_(ATTR.UNDERLINE,val);};Formatting.prototype.strike=function(val){return this.cloneWithNewAttribute_(ATTR.STRIKE,val);};Formatting.prototype.font=function(font){return this.cloneWithNewAttribute_(ATTR.FONT,font);};Formatting.prototype.fontSize=function(size){return this.cloneWithNewAttribute_(ATTR.FONT_SIZE,size);};Formatting.prototype.color=function(color){return this.cloneWithNewAttribute_(ATTR.COLOR,color);};Formatting.prototype.backgroundColor=function(color){return this.cloneWithNewAttribute_(ATTR.BACKGROUND_COLOR,color);};return Formatting;}();var firepad=firepad||{};/**\n * Object to represent Formatted text.\n *\n * @type {Function}\n */firepad.Text=function(){function Text(text,formatting){// Allow calling without new.\nif(!(this instanceof Text)){return new Text(text,formatting);}this.text=text;this.formatting=formatting||firepad.Formatting();}return Text;}();var firepad=firepad||{};/**\n * Immutable object to represent line formatting.  Formatting can be modified by chaining method calls.\n *\n * @constructor\n * @type {Function}\n */firepad.LineFormatting=function(){var ATTR=firepad.AttributeConstants;function LineFormatting(attributes){// Allow calling without new.\nif(!(this instanceof LineFormatting)){return new LineFormatting(attributes);}this.attributes=attributes||{};this.attributes[ATTR.LINE_SENTINEL]=true;}LineFormatting.LIST_TYPE={NONE:false,ORDERED:'o',UNORDERED:'u',TODO:'t',TODOCHECKED:'tc'};LineFormatting.prototype.cloneWithNewAttribute_=function(attribute,value){var attributes={};// Copy existing.\nfor(var attr in this.attributes){attributes[attr]=this.attributes[attr];}// Add new one.\nif(value===false){delete attributes[attribute];}else{attributes[attribute]=value;}return new LineFormatting(attributes);};LineFormatting.prototype.indent=function(indent){return this.cloneWithNewAttribute_(ATTR.LINE_INDENT,indent);};LineFormatting.prototype.align=function(align){return this.cloneWithNewAttribute_(ATTR.LINE_ALIGN,align);};LineFormatting.prototype.listItem=function(val){firepad.utils.assert(val===false||val==='u'||val==='o'||val==='t'||val==='tc');return this.cloneWithNewAttribute_(ATTR.LIST_TYPE,val);};LineFormatting.prototype.getIndent=function(){return this.attributes[ATTR.LINE_INDENT]||0;};LineFormatting.prototype.getAlign=function(){return this.attributes[ATTR.LINE_ALIGN]||0;};LineFormatting.prototype.getListItem=function(){return this.attributes[ATTR.LIST_TYPE]||false;};return LineFormatting;}();var firepad=firepad||{};/**\n * Object to represent Formatted line.\n *\n * @type {Function}\n */firepad.Line=function(){function Line(textPieces,formatting){// Allow calling without new.\nif(!(this instanceof Line)){return new Line(textPieces,formatting);}if(Object.prototype.toString.call(textPieces)!=='[object Array]'){if(typeof textPieces==='undefined'){textPieces=[];}else{textPieces=[textPieces];}}this.textPieces=textPieces;this.formatting=formatting||firepad.LineFormatting();}return Line;}();var firepad=firepad||{};/**\n * Helper to parse html into Firepad-compatible lines / text.\n * @type {*}\n */firepad.ParseHtml=function(){var LIST_TYPE=firepad.LineFormatting.LIST_TYPE;/**\n   * Represents the current parse state as an immutable structure.  To create a new ParseState, use\n   * the withXXX methods.\n   *\n   * @param opt_listType\n   * @param opt_lineFormatting\n   * @param opt_textFormatting\n   * @constructor\n   */function ParseState(opt_listType,opt_lineFormatting,opt_textFormatting){this.listType=opt_listType||LIST_TYPE.UNORDERED;this.lineFormatting=opt_lineFormatting||firepad.LineFormatting();this.textFormatting=opt_textFormatting||firepad.Formatting();}ParseState.prototype.withTextFormatting=function(textFormatting){return new ParseState(this.listType,this.lineFormatting,textFormatting);};ParseState.prototype.withLineFormatting=function(lineFormatting){return new ParseState(this.listType,lineFormatting,this.textFormatting);};ParseState.prototype.withListType=function(listType){return new ParseState(listType,this.lineFormatting,this.textFormatting);};ParseState.prototype.withIncreasedIndent=function(){var lineFormatting=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new ParseState(this.listType,lineFormatting,this.textFormatting);};ParseState.prototype.withAlign=function(align){var lineFormatting=this.lineFormatting.align(align);return new ParseState(this.listType,lineFormatting,this.textFormatting);};/**\n   * Mutable structure representing the current parse output.\n   * @constructor\n   */function ParseOutput(){this.lines=[];this.currentLine=[];this.currentLineListItemType=null;}ParseOutput.prototype.newlineIfNonEmpty=function(state){this.cleanLine_();if(this.currentLine.length>0){this.newline(state);}};ParseOutput.prototype.newlineIfNonEmptyOrListItem=function(state){this.cleanLine_();if(this.currentLine.length>0||this.currentLineListItemType!==null){this.newline(state);}};ParseOutput.prototype.newline=function(state){this.cleanLine_();var lineFormatting=state.lineFormatting;if(this.currentLineListItemType!==null){lineFormatting=lineFormatting.listItem(this.currentLineListItemType);this.currentLineListItemType=null;}this.lines.push(firepad.Line(this.currentLine,lineFormatting));this.currentLine=[];};ParseOutput.prototype.makeListItem=function(type){this.currentLineListItemType=type;};ParseOutput.prototype.cleanLine_=function(){// Kinda' a hack, but we remove leading and trailing spaces (since these aren't significant in html) and\n// replaces nbsp's with normal spaces.\nif(this.currentLine.length>0){var last=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,'');this.currentLine[last].text=this.currentLine[last].text.replace(/ +$/g,'');for(var i=0;i<this.currentLine.length;i++){this.currentLine[i].text=this.currentLine[i].text.replace(/\\u00a0/g,' ');}}// If after stripping trailing whitespace, there's nothing left, clear currentLine out.\nif(this.currentLine.length===1&&this.currentLine[0].text===''){this.currentLine=[];}};var entityManager_;function parseHtml(html,entityManager){// Create DIV with HTML (as a convenient way to parse it).\nvar div=(firepad.document||document).createElement('div');div.innerHTML=html;// HACK until I refactor this.\nentityManager_=entityManager;var output=new ParseOutput();var state=new ParseState();parseNode(div,state,output);return output.lines;}// Fix IE8.\nvar Node=Node||{ELEMENT_NODE:1,TEXT_NODE:3};function parseNode(node,state,output){// Give entity manager first crack at it.\nif(node.nodeType===Node.ELEMENT_NODE){var entity=entityManager_.fromElement(node);if(entity){output.currentLine.push(new firepad.Text(firepad.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new firepad.Formatting(entity.toAttributes())));return;}}switch(node.nodeType){case Node.TEXT_NODE:// This probably isn't exactly right, but mostly works...\nvar text=node.nodeValue.replace(/[ \\n\\t]+/g,' ');output.currentLine.push(firepad.Text(text,state.textFormatting));break;case Node.ELEMENT_NODE:var style=node.getAttribute('style')||'';state=parseStyle(state,style);switch(node.nodeName.toLowerCase()){case'div':case'h1':case'h2':case'h3':case'p':output.newlineIfNonEmpty(state);parseChildren(node,state,output);output.newlineIfNonEmpty(state);break;case'center':state=state.withAlign('center');output.newlineIfNonEmpty(state);parseChildren(node,state.withAlign('center'),output);output.newlineIfNonEmpty(state);break;case'b':case'strong':parseChildren(node,state.withTextFormatting(state.textFormatting.bold(true)),output);break;case'u':parseChildren(node,state.withTextFormatting(state.textFormatting.underline(true)),output);break;case'i':case'em':parseChildren(node,state.withTextFormatting(state.textFormatting.italic(true)),output);break;case's':parseChildren(node,state.withTextFormatting(state.textFormatting.strike(true)),output);break;case'font':var face=node.getAttribute('face');var color=node.getAttribute('color');var size=parseInt(node.getAttribute('size'));if(face){state=state.withTextFormatting(state.textFormatting.font(face));}if(color){state=state.withTextFormatting(state.textFormatting.color(color));}if(size){state=state.withTextFormatting(state.textFormatting.fontSize(size));}parseChildren(node,state,output);break;case'br':output.newline(state);break;case'ul':output.newlineIfNonEmptyOrListItem(state);var listType=node.getAttribute('class')==='firepad-todo'?LIST_TYPE.TODO:LIST_TYPE.UNORDERED;parseChildren(node,state.withListType(listType).withIncreasedIndent(),output);output.newlineIfNonEmpty(state);break;case'ol':output.newlineIfNonEmptyOrListItem(state);parseChildren(node,state.withListType(LIST_TYPE.ORDERED).withIncreasedIndent(),output);output.newlineIfNonEmpty(state);break;case'li':parseListItem(node,state,output);break;case'style':// ignore.\nbreak;default:parseChildren(node,state,output);break;}break;default:// Ignore other nodes (comments, etc.)\nbreak;}}function parseChildren(node,state,output){if(node.hasChildNodes()){for(var i=0;i<node.childNodes.length;i++){parseNode(node.childNodes[i],state,output);}}}function parseListItem(node,state,output){// Note: <li> is weird:\n// * Only the first line in the <li> tag should be a list item (i.e. with a bullet or number next to it).\n// * <li></li> should create an empty list item line; <li><ol><li></li></ol></li> should create two.\noutput.newlineIfNonEmptyOrListItem(state);var listType=node.getAttribute('class')==='firepad-checked'?LIST_TYPE.TODOCHECKED:state.listType;output.makeListItem(listType);var oldLine=output.currentLine;parseChildren(node,state,output);if(oldLine===output.currentLine||output.currentLine.length>0){output.newline(state);}}function parseStyle(state,styleString){var textFormatting=state.textFormatting;var lineFormatting=state.lineFormatting;var styles=styleString.split(';');for(var i=0;i<styles.length;i++){var stylePieces=styles[i].split(':');if(stylePieces.length!==2)continue;var prop=firepad.utils.trim(stylePieces[0]).toLowerCase();var val=firepad.utils.trim(stylePieces[1]).toLowerCase();switch(prop){case'text-decoration':var underline=val.indexOf('underline')>=0;var strike=val.indexOf('line-through')>=0;textFormatting=textFormatting.underline(underline).strike(strike);break;case'font-weight':var bold=val==='bold'||parseInt(val)>=600;textFormatting=textFormatting.bold(bold);break;case'font-style':var italic=val==='italic'||val==='oblique';textFormatting=textFormatting.italic(italic);break;case'color':textFormatting=textFormatting.color(val);break;case'background-color':textFormatting=textFormatting.backgroundColor(val);break;case'text-align':lineFormatting=lineFormatting.align(val);break;case'font-size':var size=null;var allowedValues=['px','pt','%','em','xx-small','x-small','small','medium','large','x-large','xx-large','smaller','larger'];if(firepad.utils.stringEndsWith(val,allowedValues)){size=val;}else if(parseInt(val)){size=parseInt(val)+'px';}if(size){textFormatting=textFormatting.fontSize(size);}break;case'font-family':var font=firepad.utils.trim(val.split(',')[0]);// get first font.\nfont=font.replace(/['\"]/g,'');// remove quotes.\nfont=font.replace(/\\w\\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase();});textFormatting=textFormatting.font(font);break;}}return state.withLineFormatting(lineFormatting).withTextFormatting(textFormatting);}return parseHtml;}();var firepad=firepad||{};/**\n * Helper to turn Firebase contents into HMTL.\n * Takes a doc and an entity manager\n */firepad.SerializeHtml=function(){var utils=firepad.utils;var ATTR=firepad.AttributeConstants;var LIST_TYPE=firepad.LineFormatting.LIST_TYPE;var TODO_STYLE='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: \"\\\\2610\"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: \"\\\\2611\"; padding-right: 5px; }</style>\\n';function open(listType){return listType===LIST_TYPE.ORDERED?'<ol>':listType===LIST_TYPE.UNORDERED?'<ul>':'<ul class=\"firepad-todo\">';}function close(listType){return listType===LIST_TYPE.ORDERED?'</ol>':'</ul>';}function compatibleListType(l1,l2){return l1===l2||l1===LIST_TYPE.TODO&&l2===LIST_TYPE.TODOCHECKED||l1===LIST_TYPE.TODOCHECKED&&l2===LIST_TYPE.TODO;}function textToHtml(text){return text.replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\u00a0/g,'&nbsp;');}function serializeHtml(doc,entityManager){var html='';var newLine=true;var listTypeStack=[];var inListItem=false;var firstLine=true;var emptyLine=true;var i=0,op=doc.ops[i];var usesTodo=false;while(op){utils.assert(op.isInsert());var attrs=op.attributes;if(newLine){newLine=false;var indent=0,listType=null,lineAlign='left';if(ATTR.LINE_SENTINEL in attrs){indent=attrs[ATTR.LINE_INDENT]||0;listType=attrs[ATTR.LIST_TYPE]||null;lineAlign=attrs[ATTR.LINE_ALIGN]||'left';}if(listType){indent=indent||1;// lists are automatically indented at least 1.\n}if(inListItem){html+='</li>';inListItem=false;}else if(!firstLine){if(emptyLine){html+='<br/>';}html+='</div>';}firstLine=false;// Close any extra lists.\nutils.assert(indent>=0,\"Indent must not be negative.\");while(listTypeStack.length>indent||indent===listTypeStack.length&&listType!==null&&!compatibleListType(listType,listTypeStack[listTypeStack.length-1])){html+=close(listTypeStack.pop());}// Open any needed lists.\nwhile(listTypeStack.length<indent){var toOpen=listType||LIST_TYPE.UNORDERED;// default to unordered lists for indenting non-list-item lines.\nusesTodo=listType==LIST_TYPE.TODO||listType==LIST_TYPE.TODOCHECKED||usesTodo;html+=open(toOpen);listTypeStack.push(toOpen);}var style=lineAlign!=='left'?' style=\"text-align:'+lineAlign+'\"':'';if(listType){var clazz='';switch(listType){case LIST_TYPE.TODOCHECKED:clazz=' class=\"firepad-checked\"';break;case LIST_TYPE.TODO:clazz=' class=\"firepad-unchecked\"';break;}html+=\"<li\"+clazz+style+\">\";inListItem=true;}else{// start line div.\nhtml+='<div'+style+'>';}emptyLine=true;}if(ATTR.LINE_SENTINEL in attrs){op=doc.ops[++i];continue;}if(ATTR.ENTITY_SENTINEL in attrs){for(var j=0;j<op.text.length;j++){var entity=firepad.Entity.fromAttributes(attrs);var element=entityManager.exportToElement(entity);html+=element.outerHTML;}op=doc.ops[++i];continue;}var prefix='',suffix='';for(var attr in attrs){var value=attrs[attr];var start,end;if(attr===ATTR.BOLD||attr===ATTR.ITALIC||attr===ATTR.UNDERLINE||attr===ATTR.STRIKE){utils.assert(value===true);start=end=attr;}else if(attr===ATTR.FONT_SIZE){start='span style=\"font-size: '+value;start+=typeof value!==\"string\"||value.indexOf(\"px\",value.length-2)===-1?'px\"':'\"';end='span';}else if(attr===ATTR.FONT){start='span style=\"font-family: '+value+'\"';end='span';}else if(attr===ATTR.COLOR){start='span style=\"color: '+value+'\"';end='span';}else if(attr===ATTR.BACKGROUND_COLOR){start='span style=\"background-color: '+value+'\"';end='span';}else{utils.log(false,\"Encountered unknown attribute while rendering html: \"+attr);}if(start)prefix+='<'+start+'>';if(end)suffix='</'+end+'>'+suffix;}var text=op.text;var newLineIndex=text.indexOf('\\n');if(newLineIndex>=0){newLine=true;if(newLineIndex<text.length-1){// split op.\nop=new firepad.TextOp('insert',text.substr(newLineIndex+1),attrs);}else{op=doc.ops[++i];}text=text.substr(0,newLineIndex);}else{op=doc.ops[++i];}// Replace leading, trailing, and consecutive spaces with nbsp's to make sure they're preserved.\ntext=text.replace(/  +/g,function(str){return new Array(str.length+1).join(\"\\xA0\");}).replace(/^ /,\"\\xA0\").replace(/ $/,\"\\xA0\");if(text.length>0){emptyLine=false;}html+=prefix+textToHtml(text)+suffix;}if(inListItem){html+='</li>';}else if(!firstLine){if(emptyLine){html+='&nbsp;';}html+='</div>';}// Close any extra lists.\nwhile(listTypeStack.length>0){html+=close(listTypeStack.pop());}if(usesTodo){html=TODO_STYLE+html;}return html;}return serializeHtml;}();var firepad=firepad||{};/**\n * Helper to turn pieces of text into insertable operations\n */firepad.textPiecesToInserts=function(atNewLine,textPieces){var inserts=[];function insert(string,attributes){if(string instanceof firepad.Text){attributes=string.formatting.attributes;string=string.text;}inserts.push({string:string,attributes:attributes});atNewLine=string[string.length-1]==='\\n';}function insertLine(line,withNewline){// HACK: We should probably force a newline if there isn't one already.  But due to\n// the way this is used for inserting HTML, we end up inserting a \"line\" in the middle\n// of text, in which case we don't want to actually insert a newline.\nif(atNewLine){insert(firepad.sentinelConstants.LINE_SENTINEL_CHARACTER,line.formatting.attributes);}for(var i=0;i<line.textPieces.length;i++){insert(line.textPieces[i]);}if(withNewline)insert('\\n');}for(var i=0;i<textPieces.length;i++){if(textPieces[i]instanceof firepad.Line){insertLine(textPieces[i],i<textPieces.length-1);}else{insert(textPieces[i]);}}return inserts;};var firepad=firepad||{};/**\n * Instance of headless Firepad for use in NodeJS. Supports get/set on text/html.\n */firepad.Headless=function(){var TextOperation=firepad.TextOperation;var FirebaseAdapter=firepad.FirebaseAdapter;var EntityManager=firepad.EntityManager;var ParseHtml=firepad.ParseHtml;function Headless(refOrPath){// Allow calling without new.\nif(!(this instanceof Headless)){return new Headless(refOrPath);}var firebase,ref;if(typeof refOrPath==='string'){if(window.firebase===undefined&&typeof firebase!=='object'){console.log(\"REQUIRING\");firebase=require('firebase');}else{firebase=window.firebase;}ref=firebase.database().refFromURL(refOrPath);}else{ref=refOrPath;}this.entityManager_=new EntityManager();this.firebaseAdapter_=new FirebaseAdapter(ref);this.ready_=false;this.zombie_=false;}Headless.prototype.getDocument=function(callback){var self=this;if(self.ready_){return callback(self.firebaseAdapter_.getDocument());}self.firebaseAdapter_.on('ready',function(){self.ready_=true;callback(self.firebaseAdapter_.getDocument());});};Headless.prototype.getText=function(callback){if(this.zombie_){throw new Error('You can\\'t use a firepad.Headless after calling dispose()!');}this.getDocument(function(doc){var text=doc.apply('');// Strip out any special characters from Rich Text formatting\nfor(key in firepad.sentinelConstants){text=text.replace(new RegExp(firepad.sentinelConstants[key],'g'),'');}callback(text);});};Headless.prototype.setText=function(text,callback){if(this.zombie_){throw new Error('You can\\'t use a firepad.Headless after calling dispose()!');}var op=TextOperation().insert(text);this.sendOperationWithRetry(op,callback);};Headless.prototype.initializeFakeDom=function(callback){if(typeof document==='object'||typeof firepad.document==='object'){callback();}else{require('jsdom').env('<head></head><body></body>',function(err,window){if(firepad.document){// Return if we've already made a jsdom to avoid making more than one\n// This would be easier with promises but we want to avoid introducing\n// another dependency for just headless mode.\nwindow.close();return callback();}firepad.document=window.document;callback();});}};Headless.prototype.getHtml=function(callback){var self=this;if(this.zombie_){throw new Error('You can\\'t use a firepad.Headless after calling dispose()!');}self.initializeFakeDom(function(){self.getDocument(function(doc){callback(firepad.SerializeHtml(doc,self.entityManager_));});});};Headless.prototype.setHtml=function(html,callback){var self=this;if(this.zombie_){throw new Error('You can\\'t use a firepad.Headless after calling dispose()!');}self.initializeFakeDom(function(){var textPieces=ParseHtml(html,self.entityManager_);var inserts=firepad.textPiecesToInserts(true,textPieces);var op=new TextOperation();for(var i=0;i<inserts.length;i++){op.insert(inserts[i].string,inserts[i].attributes);}self.sendOperationWithRetry(op,callback);});};Headless.prototype.sendOperationWithRetry=function(operation,callback){var self=this;self.getDocument(function(doc){var op=operation.clone()['delete'](doc.targetLength);self.firebaseAdapter_.sendOperation(op,function(err,committed){if(committed){if(typeof callback!==\"undefined\"){callback(null,committed);}}else{self.sendOperationWithRetry(operation,callback);}});});};Headless.prototype.dispose=function(){this.zombie_=true;// We've been disposed.  No longer valid to do anything.\nthis.firebaseAdapter_.dispose();};return Headless;}();var firepad=firepad||{};firepad.Firepad=function(global){if(!firepad.RichTextCodeMirrorAdapter){throw new Error(\"Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.\");}var RichTextCodeMirrorAdapter=firepad.RichTextCodeMirrorAdapter;var RichTextCodeMirror=firepad.RichTextCodeMirror;var RichTextToolbar=firepad.RichTextToolbar;var ACEAdapter=firepad.ACEAdapter;var FirebaseAdapter=firepad.FirebaseAdapter;var EditorClient=firepad.EditorClient;var EntityManager=firepad.EntityManager;var ATTR=firepad.AttributeConstants;var utils=firepad.utils;var LIST_TYPE=firepad.LineFormatting.LIST_TYPE;var CodeMirror=global.CodeMirror;var ace=global.ace;function Firepad(ref,place,options){if(!(this instanceof Firepad)){return new Firepad(ref,place,options);}if(!CodeMirror&&!ace){throw new Error('Couldn\\'t find CodeMirror or ACE.  Did you forget to include codemirror.js or ace.js?');}this.zombie_=false;if(CodeMirror&&place instanceof CodeMirror){this.codeMirror_=this.editor_=place;var curValue=this.codeMirror_.getValue();if(curValue!==''){throw new Error(\"Can't initialize Firepad with a CodeMirror instance that already contains text.\");}}else if(ace&&place&&place.session instanceof ace.EditSession){this.ace_=this.editor_=place;curValue=this.ace_.getValue();if(curValue!==''){throw new Error(\"Can't initialize Firepad with an ACE instance that already contains text.\");}}else{this.codeMirror_=this.editor_=new CodeMirror(place);}var editorWrapper=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_.container;this.firepadWrapper_=utils.elt(\"div\",null,{'class':'firepad'});editorWrapper.parentNode.replaceChild(this.firepadWrapper_,editorWrapper);this.firepadWrapper_.appendChild(editorWrapper);// Don't allow drag/drop because it causes issues.  See https://github.com/firebase/firepad/issues/36\nutils.on(editorWrapper,'dragstart',utils.stopEvent);// Provide an easy way to get the firepad instance associated with this CodeMirror instance.\nthis.editor_.firepad=this;this.options_=options||{};if(this.getOption('richTextShortcuts',false)){if(!CodeMirror.keyMap['richtext']){this.initializeKeyMap_();}this.codeMirror_.setOption('keyMap','richtext');this.firepadWrapper_.className+=' firepad-richtext';}this.imageInsertionUI=this.getOption('imageInsertionUI',true);if(this.getOption('richTextToolbar',false)){this.addToolbar_();this.firepadWrapper_.className+=' firepad-richtext firepad-with-toolbar';}this.addPoweredByLogo_();// Now that we've mucked with CodeMirror, refresh it.\nif(this.codeMirror_)this.codeMirror_.refresh();var userId=this.getOption('userId',ref.push().key);var userColor=this.getOption('userColor',colorFromUserId(userId));this.entityManager_=new EntityManager();this.firebaseAdapter_=new FirebaseAdapter(ref,userId,userColor);if(this.codeMirror_){this.richTextCodeMirror_=new RichTextCodeMirror(this.codeMirror_,this.entityManager_,{cssPrefix:'firepad-'});this.editorAdapter_=new RichTextCodeMirrorAdapter(this.richTextCodeMirror_);}else{this.editorAdapter_=new ACEAdapter(this.ace_);}this.client_=new EditorClient(this.firebaseAdapter_,this.editorAdapter_);var self=this;this.firebaseAdapter_.on('cursor',function(){self.trigger.apply(self,['cursor'].concat([].slice.call(arguments)));});if(this.codeMirror_){this.richTextCodeMirror_.on('newLine',function(){self.trigger.apply(self,['newLine'].concat([].slice.call(arguments)));});}this.firebaseAdapter_.on('ready',function(){self.ready_=true;if(this.ace_){this.editorAdapter_.grabDocumentState();}var defaultText=self.getOption('defaultText',null);if(defaultText&&self.isHistoryEmpty()){self.setText(defaultText);}self.trigger('ready');});this.client_.on('synced',function(isSynced){self.trigger('synced',isSynced);});// Hack for IE8 to make font icons work more reliably.\n// http://stackoverflow.com/questions/9809351/ie8-css-font-face-fonts-only-working-for-before-content-on-over-and-sometimes\nif(navigator.appName=='Microsoft Internet Explorer'&&navigator.userAgent.match(/MSIE 8\\./)){window.onload=function(){var head=document.getElementsByTagName('head')[0],style=document.createElement('style');style.type='text/css';style.styleSheet.cssText=':before,:after{content:none !important;}';head.appendChild(style);setTimeout(function(){head.removeChild(style);},0);};}}utils.makeEventEmitter(Firepad);// For readability, these are the primary \"constructors\", even though right now they're just aliases for Firepad.\nFirepad.fromCodeMirror=Firepad;Firepad.fromACE=Firepad;Firepad.prototype.dispose=function(){this.zombie_=true;// We've been disposed.  No longer valid to do anything.\n// Unwrap the editor.\nvar editorWrapper=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_.container;this.firepadWrapper_.removeChild(editorWrapper);this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_);this.editor_.firepad=null;if(this.codeMirror_&&this.codeMirror_.getOption('keyMap')==='richtext'){this.codeMirror_.setOption('keyMap','default');}this.firebaseAdapter_.dispose();this.editorAdapter_.detach();if(this.richTextCodeMirror_)this.richTextCodeMirror_.detach();};Firepad.prototype.setUserId=function(userId){this.firebaseAdapter_.setUserId(userId);};Firepad.prototype.setUserColor=function(color){this.firebaseAdapter_.setColor(color);};Firepad.prototype.getText=function(){this.assertReady_('getText');if(this.codeMirror_)return this.richTextCodeMirror_.getText();else return this.ace_.getSession().getDocument().getValue();};Firepad.prototype.setText=function(textPieces){this.assertReady_('setText');if(this.ace_){return this.ace_.getSession().getDocument().setValue(textPieces);}else{// HACK: Hide CodeMirror during setText to prevent lots of extra renders.\nthis.codeMirror_.getWrapperElement().setAttribute('style','display: none');this.codeMirror_.setValue(\"\");this.insertText(0,textPieces);this.codeMirror_.getWrapperElement().setAttribute('style','');this.codeMirror_.refresh();}this.editorAdapter_.setCursor({position:0,selectionEnd:0});};Firepad.prototype.insertTextAtCursor=function(textPieces){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),textPieces);};Firepad.prototype.insertText=function(index,textPieces){utils.assert(!this.ace_,\"Not supported for ace yet.\");this.assertReady_('insertText');// Wrap it in an array if it's not already.\nif(Object.prototype.toString.call(textPieces)!=='[object Array]'){textPieces=[textPieces];}var self=this;self.codeMirror_.operation(function(){// HACK: We should check if we're actually at the beginning of a line; but checking for index == 0 is sufficient\n// for the setText() case.\nvar atNewLine=index===0;var inserts=firepad.textPiecesToInserts(atNewLine,textPieces);for(var i=0;i<inserts.length;i++){var string=inserts[i].string;var attributes=inserts[i].attributes;self.richTextCodeMirror_.insertText(index,string,attributes);index+=string.length;}});};Firepad.prototype.getOperationForSpan=function(start,end){var text=this.richTextCodeMirror_.getRange(start,end);var spans=this.richTextCodeMirror_.getAttributeSpans(start,end);var pos=0;var op=new firepad.TextOperation();for(var i=0;i<spans.length;i++){op.insert(text.substr(pos,spans[i].length),spans[i].attributes);pos+=spans[i].length;}return op;};Firepad.prototype.getHtml=function(){return this.getHtmlFromRange(null,null);};Firepad.prototype.getHtmlFromSelection=function(){var startPos=this.codeMirror_.getCursor('start'),endPos=this.codeMirror_.getCursor('end');var startIndex=this.codeMirror_.indexFromPos(startPos),endIndex=this.codeMirror_.indexFromPos(endPos);return this.getHtmlFromRange(startIndex,endIndex);};Firepad.prototype.getHtmlFromRange=function(start,end){this.assertReady_('getHtmlFromRange');var doc=start!=null&&end!=null?this.getOperationForSpan(start,end):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return firepad.SerializeHtml(doc,this.entityManager_);};Firepad.prototype.insertHtml=function(index,html){var lines=firepad.ParseHtml(html,this.entityManager_);this.insertText(index,lines);};Firepad.prototype.insertHtmlAtCursor=function(html){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),html);};Firepad.prototype.setHtml=function(html){var lines=firepad.ParseHtml(html,this.entityManager_);this.setText(lines);};Firepad.prototype.isHistoryEmpty=function(){this.assertReady_('isHistoryEmpty');return this.firebaseAdapter_.isHistoryEmpty();};Firepad.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(ATTR.BOLD);this.codeMirror_.focus();};Firepad.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(ATTR.ITALIC);this.codeMirror_.focus();};Firepad.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(ATTR.UNDERLINE);this.codeMirror_.focus();};Firepad.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(ATTR.STRIKE);this.codeMirror_.focus();};Firepad.prototype.fontSize=function(size){this.richTextCodeMirror_.setAttribute(ATTR.FONT_SIZE,size);this.codeMirror_.focus();};Firepad.prototype.font=function(font){this.richTextCodeMirror_.setAttribute(ATTR.FONT,font);this.codeMirror_.focus();};Firepad.prototype.color=function(color){this.richTextCodeMirror_.setAttribute(ATTR.COLOR,color);this.codeMirror_.focus();};Firepad.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(ATTR.BACKGROUND_COLOR,'rgba(255,255,0,.65)');this.codeMirror_.focus();};Firepad.prototype.align=function(alignment){if(alignment!=='left'&&alignment!=='center'&&alignment!=='right'){throw new Error('align() must be passed \"left\", \"center\", or \"right\".');}this.richTextCodeMirror_.setLineAttribute(ATTR.LINE_ALIGN,alignment);this.codeMirror_.focus();};Firepad.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(ATTR.LIST_TYPE,'o');this.codeMirror_.focus();};Firepad.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(ATTR.LIST_TYPE,'u');this.codeMirror_.focus();};Firepad.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo();this.codeMirror_.focus();};Firepad.prototype.newline=function(){this.richTextCodeMirror_.newline();};Firepad.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft();};Firepad.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight();};Firepad.prototype.indent=function(){this.richTextCodeMirror_.indent();this.codeMirror_.focus();};Firepad.prototype.unindent=function(){this.richTextCodeMirror_.unindent();this.codeMirror_.focus();};Firepad.prototype.undo=function(){this.codeMirror_.undo();};Firepad.prototype.redo=function(){this.codeMirror_.redo();};Firepad.prototype.insertEntity=function(type,info,origin){this.richTextCodeMirror_.insertEntityAtCursor(type,info,origin);};Firepad.prototype.insertEntityAt=function(index,type,info,origin){this.richTextCodeMirror_.insertEntityAt(index,type,info,origin);};Firepad.prototype.registerEntity=function(type,options){this.entityManager_.register(type,options);};Firepad.prototype.getOption=function(option,def){return option in this.options_?this.options_[option]:def;};Firepad.prototype.assertReady_=function(funcName){if(!this.ready_){throw new Error('You must wait for the \"ready\" event before calling '+funcName+'.');}if(this.zombie_){throw new Error('You can\\'t use a Firepad after calling dispose()!  [called '+funcName+']');}};Firepad.prototype.makeImageDialog_=function(){this.makeDialog_('img','Insert image url');};Firepad.prototype.makeDialog_=function(id,placeholder){var self=this;var hideDialog=function hideDialog(){var dialog=document.getElementById('overlay');dialog.style.visibility=\"hidden\";self.firepadWrapper_.removeChild(dialog);};var cb=function cb(){var dialog=document.getElementById('overlay');dialog.style.visibility=\"hidden\";var src=document.getElementById(id).value;if(src!==null)self.insertEntity(id,{'src':src});self.firepadWrapper_.removeChild(dialog);};var input=utils.elt('input',null,{'class':'firepad-dialog-input','id':id,'type':'text','placeholder':placeholder,'autofocus':'autofocus'});var submit=utils.elt('a','Submit',{'class':'firepad-btn','id':'submitbtn'});utils.on(submit,'click',utils.stopEventAnd(cb));var cancel=utils.elt('a','Cancel',{'class':'firepad-btn'});utils.on(cancel,'click',utils.stopEventAnd(hideDialog));var buttonsdiv=utils.elt('div',[submit,cancel],{'class':'firepad-btn-group'});var div=utils.elt('div',[input,buttonsdiv],{'class':'firepad-dialog-div'});var dialog=utils.elt('div',[div],{'class':'firepad-dialog',id:'overlay'});this.firepadWrapper_.appendChild(dialog);};Firepad.prototype.addToolbar_=function(){this.toolbar=new RichTextToolbar(this.imageInsertionUI);this.toolbar.on('undo',this.undo,this);this.toolbar.on('redo',this.redo,this);this.toolbar.on('bold',this.bold,this);this.toolbar.on('italic',this.italic,this);this.toolbar.on('underline',this.underline,this);this.toolbar.on('strike',this.strike,this);this.toolbar.on('font-size',this.fontSize,this);this.toolbar.on('font',this.font,this);this.toolbar.on('color',this.color,this);this.toolbar.on('left',function(){this.align('left');},this);this.toolbar.on('center',function(){this.align('center');},this);this.toolbar.on('right',function(){this.align('right');},this);this.toolbar.on('ordered-list',this.orderedList,this);this.toolbar.on('unordered-list',this.unorderedList,this);this.toolbar.on('todo-list',this.todo,this);this.toolbar.on('indent-increase',this.indent,this);this.toolbar.on('indent-decrease',this.unindent,this);this.toolbar.on('insert-image',this.makeImageDialog_,this);this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild);};Firepad.prototype.addPoweredByLogo_=function(){var poweredBy=utils.elt('a',null,{'class':'powered-by-firepad'});poweredBy.setAttribute('href','http://www.firepad.io/');poweredBy.setAttribute('target','_blank');this.firepadWrapper_.appendChild(poweredBy);};Firepad.prototype.initializeKeyMap_=function(){function binder(fn){return function(cm){// HACK: CodeMirror will often call our key handlers within a cm.operation(), and that\n// can mess us up (we rely on events being triggered synchronously when we make CodeMirror\n// edits).  So to escape any cm.operation(), we do a setTimeout.\nsetTimeout(function(){fn.call(cm.firepad);},0);};}CodeMirror.keyMap[\"richtext\"]={\"Ctrl-B\":binder(this.bold),\"Cmd-B\":binder(this.bold),\"Ctrl-I\":binder(this.italic),\"Cmd-I\":binder(this.italic),\"Ctrl-U\":binder(this.underline),\"Cmd-U\":binder(this.underline),\"Ctrl-H\":binder(this.highlight),\"Cmd-H\":binder(this.highlight),\"Enter\":binder(this.newline),\"Delete\":binder(this.deleteRight),\"Backspace\":binder(this.deleteLeft),\"Tab\":binder(this.indent),\"Shift-Tab\":binder(this.unindent),fallthrough:['default']};};function colorFromUserId(userId){var a=1;for(var i=0;i<userId.length;i++){a=17*(a+userId.charCodeAt(i))%360;}var hue=a/360;return hsl2hex(hue,1,0.75);}function rgb2hex(r,g,b){function digits(n){var m=Math.round(255*n).toString(16);return m.length===1?'0'+m:m;}return'#'+digits(r)+digits(g)+digits(b);}function hsl2hex(h,s,l){if(s===0){return rgb2hex(l,l,l);}var var2=l<0.5?l*(1+s):l+s-s*l;var var1=2*l-var2;var hue2rgb=function hue2rgb(hue){if(hue<0){hue+=1;}if(hue>1){hue-=1;}if(6*hue<1){return var1+(var2-var1)*6*hue;}if(2*hue<1){return var2;}if(3*hue<2){return var1+(var2-var1)*6*(2/3-hue);}return var1;};return rgb2hex(hue2rgb(h+1/3),hue2rgb(h),hue2rgb(h-1/3));}return Firepad;}(this);// Export Text classes\nfirepad.Firepad.Formatting=firepad.Formatting;firepad.Firepad.Text=firepad.Text;firepad.Firepad.Entity=firepad.Entity;firepad.Firepad.LineFormatting=firepad.LineFormatting;firepad.Firepad.Line=firepad.Line;firepad.Firepad.TextOperation=firepad.TextOperation;firepad.Firepad.Headless=firepad.Headless;// Export adapters\nfirepad.Firepad.RichTextCodeMirrorAdapter=firepad.RichTextCodeMirrorAdapter;firepad.Firepad.ACEAdapter=firepad.ACEAdapter;return firepad.Firepad;},this);"},"4w6A":function(e,t,n){var r,i;n("HXzo"),n("HQhv"),n("sc67"),n("sC2a"),n("n7j8"),r=this,i=function(e){var t=function e(t){return new e.lib.init(t)};function n(e,t){return!(!e||"string"!=typeof t||!(e.className&&e.className.trim().split(/\s+/gi).indexOf(t)>-1))}return t.lib=t.prototype={toastify:"1.6.1",constructor:t,init:function(e){return e||(e={}),this.options={},this.toastElement=null,this.options.text=e.text||"Hi there!",this.options.duration=e.duration||3e3,this.options.selector=e.selector,this.options.callback=e.callback||function(){},this.options.destination=e.destination,this.options.newWindow=e.newWindow||!1,this.options.close=e.close||!1,this.options.gravity="bottom"==e.gravity?"toastify-bottom":"toastify-top",this.options.positionLeft=e.positionLeft||!1,this.options.position=e.position||"",this.options.backgroundColor=e.backgroundColor,this.options.avatar=e.avatar||"",this.options.className=e.className||"",this.options.stopOnFocus=void 0===e.stopOnFocus||e.stopOnFocus,this},buildToast:function(){if(!this.options)throw"Toastify is not initialized";var e=document.createElement("div");if(e.className="toastify on "+this.options.className,this.options.position?e.className+=" toastify-"+this.options.position:!0===this.options.positionLeft?(e.className+=" toastify-left",console.warn("Property `positionLeft` will be depreciated in further versions. Please use `position` instead.")):e.className+=" toastify-right",e.className+=" "+this.options.gravity,this.options.backgroundColor&&(e.style.background=this.options.backgroundColor),e.innerHTML=this.options.text,""!==this.options.avatar){var t=document.createElement("img");t.src=this.options.avatar,t.className="toastify-avatar","left"==this.options.position||!0===this.options.positionLeft?e.appendChild(t):e.insertAdjacentElement("beforeend",t)}if(!0===this.options.close){var n=document.createElement("span");if(n.innerHTML="&#10006;",n.className="toast-close",n.addEventListener("click",function(e){e.stopPropagation(),this.removeElement(e.target.parentElement),window.clearTimeout(e.target.parentElement.timeOutValue)}.bind(this)),this.options.stopOnFocus&&this.options.duration>0){var r=this;e.addEventListener("mouseover",(function(t){window.clearTimeout(e.timeOutValue)})),e.addEventListener("mouseleave",(function(){e.timeOutValue=window.setTimeout((function(){r.removeElement(e)}),r.options.duration)}))}var i=window.innerWidth>0?window.innerWidth:screen.width;("left"==this.options.position||!0===this.options.positionLeft)&&i>360?e.insertAdjacentElement("afterbegin",n):e.appendChild(n)}return void 0!==this.options.destination&&e.addEventListener("click",function(e){e.stopPropagation(),!0===this.options.newWindow?window.open(this.options.destination,"_blank"):window.location=this.options.destination}.bind(this)),e},showToast:function(){var e;if(this.toastElement=this.buildToast(),!(e=void 0===this.options.selector?document.body:document.getElementById(this.options.selector)))throw"Root element is not defined";return e.insertBefore(this.toastElement,e.firstChild),t.reposition(),this.options.duration>0&&(this.toastElement.timeOutValue=window.setTimeout(function(){this.removeElement(this.toastElement)}.bind(this),this.options.duration)),this},hideToast:function(){this.toastElement.timeOutValue&&clearTimeout(this.toastElement.timeOutValue),this.removeElement(this.toastElement)},removeElement:function(e){e.className=e.className.replace(" on",""),window.setTimeout(function(){e.parentNode.removeChild(e),this.options.callback.call(e),t.reposition()}.bind(this),400)}},t.reposition=function(){for(var e,t={top:15,bottom:15},r={top:15,bottom:15},i={top:15,bottom:15},o=document.getElementsByClassName("toastify"),a=0;a<o.length;a++){e=!0===n(o[a],"toastify-top")?"toastify-top":"toastify-bottom";var s=o[a].offsetHeight;e=e.substr(9,e.length-1),(window.innerWidth>0?window.innerWidth:screen.width)<=360?(o[a].style[e]=i[e]+"px",i[e]+=s+15):!0===n(o[a],"toastify-left")?(o[a].style[e]=t[e]+"px",t[e]+=s+15):(o[a].style[e]=r[e]+"px",r[e]+=s+15)}return this},t.lib.init.prototype=t.lib,t},e.exports?e.exports=i():r.Toastify=i()},"5x/H":function(e,t,n){"use strict";n("6Joi")},"6Joi":function(e,t,n){"use strict";(function(e){n("m210"),n("4DPX"),n("iuFa"),n("sPse"),n("pQ2P"),n("klQ5"),n("cxuS"),n("ToIb"),n("MIFh"),n("pncC"),n("m5Zt"),n("R0hF"),n("v9g0"),n("YbXK"),n("xJgp"),n("WevN"),n("TAD1"),n("Ll4R"),n("U6Bt"),n("rzGZ"),n("Dq+y"),n("zGcK"),n("1dPr"),n("n7j8"),n("6kNP"),n("sC2a"),n("HQhv"),n("OeI1"),n("JHok"),n("CtJk"),n("sc67"),n("wZFJ"),n("YBKJ"),n("q8oJ"),n("C9fy"),n("8npG"),n("pJf4"),n("AqHK"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r,i,o=(r=n("wj3C"))&&"object"==typeof r&&"default"in r?r.default:r,a=n("mrSG"),s=n("q/0M"),u=n("zVF4"),c=n("S+S0"),l=n("x7I3"),h=o.SDK_VERSION,d=new s.Logger("@firebase/firestore");function p(){return d.logLevel===s.LogLevel.DEBUG?i.DEBUG:d.logLevel===s.LogLevel.SILENT?i.SILENT:i.ERROR}function f(e){switch(e){case i.DEBUG:d.logLevel=s.LogLevel.DEBUG;break;case i.ERROR:d.logLevel=s.LogLevel.ERROR;break;case i.SILENT:d.logLevel=s.LogLevel.SILENT;break;default:d.error("Firestore ("+h+"): Invalid value passed to `setLogLevel`")}}function m(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(d.logLevel<=s.LogLevel.DEBUG){var i=n.map(v);d.debug.apply(d,a.__spreadArrays(["Firestore ("+h+") ["+e+"]: "+t],i))}}function g(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(d.logLevel<=s.LogLevel.ERROR){var r=t.map(v);d.error.apply(d,a.__spreadArrays(["Firestore ("+h+"): "+e],r))}}function v(e){if("string"==typeof e)return e;var t=w.getPlatform();try{return t.formatJSON(e)}catch(n){return e}}function y(e){var t="FIRESTORE ("+h+") INTERNAL ASSERTION FAILED: "+e;throw g(t),new Error(t)}function b(e,t){e||y(t)}!function(e){e[e.DEBUG=0]="DEBUG",e[e.ERROR=1]="ERROR",e[e.SILENT=2]="SILENT"}(i||(i={}));var w=function(){function e(){}return e.setPlatform=function(t){e.platform&&y("Platform already defined"),e.platform=t},e.getPlatform=function(){return e.platform||y("Platform not set"),e.platform},e}();function _(){return w.getPlatform().emptyByteString}var C={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},T=function(e){function t(t,n){var r=e.call(this,n)||this;return r.code=t,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return a.__extends(t,e),t}(Error);function S(e,t){function n(){var e="This constructor is private.";throw t&&(e+=" ",e+=t),new T(C.INVALID_ARGUMENT,e)}for(var r in n.prototype=e.prototype,e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}function E(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function x(e,t){return void 0!==e?e:t}function I(e,t){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=Number(n);isNaN(r)||t(r,e[n])}}function k(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function A(e){for(var t in b(null!=e&&"object"==typeof e,"isEmpty() expects object parameter."),e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function N(e,t){if(0!==t.length)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() does not support arguments, but was called with "+$(t.length,"argument")+".")}function L(e,t,n){if(t.length!==n)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires "+$(n,"argument")+", but was called with "+$(t.length,"argument")+".")}function D(e,t,n){if(t.length<n)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires at least "+$(n,"argument")+", but was called with "+$(t.length,"argument")+".")}function O(e,t,n,r){if(t.length<n||t.length>r)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires between "+n+" and "+r+" arguments, but was called with "+$(t.length,"argument")+".")}function M(e,t,n,r){W(e,t,Q(n)+" argument",r)}function R(e,t,n,r){void 0!==r&&M(e,t,n,r)}function P(e,t,n,r){W(e,t,n+" option",r)}function F(e,t,n,r){void 0!==r&&P(e,t,n,r)}function j(e,t,n,r,i){void 0!==r&&function(e,t,n,r,i){if(!(r instanceof Array))throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires its "+t+" option to be an array, but it was: "+H(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires all "+t+" elements to be "+n+", but the value at index "+o+" was: "+H(r[o]))}(e,t,n,r,i)}function B(e,t,n,r,i){void 0!==r&&function(e,t,n,r,i){for(var o=[],a=0,s=i;a<s.length;a++){var u=s[a];if(u===r)return;o.push(H(u))}var c=H(r);throw new T(C.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+e+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(e,0,n,r,i)}function V(e,t,n,r){if(!t.some((function(e){return e===r})))throw new T(C.INVALID_ARGUMENT,"Invalid value "+H(r)+" provided to function "+e+"() for its "+Q(n)+" argument. Acceptable values: "+t.join(", "))}function W(e,t,n,r){if(!("object"===t?U(r):"non-empty string"===t?"string"==typeof r&&""!==r:typeof r===t)){var i=H(r);throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" to be of type "+t+", but it was: "+i)}}function U(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function H(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";var t=function(e){if(e.constructor){var t=/function\s+([^\s(]+)\s*\(/.exec(e.constructor.toString());if(t&&t.length>1)return t[1]}return null}(e);return t?"a custom "+t+" object":"an object"}return"function"==typeof e?"a function":y("Unknown wrong type: "+typeof e)}function z(e,t,n){if(void 0===n)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires a valid "+Q(t)+" argument, but it was undefined.")}function q(e,t,n){k(t,(function(t,r){if(n.indexOf(t)<0)throw new T(C.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+e+"(). Available options: "+n.join(", "))}))}function K(e,t,n,r){var i=H(r);return new T(C.INVALID_ARGUMENT,"Function "+e+"() requires its "+Q(n)+" argument to be a "+t+", but it was: "+i)}function G(e,t,n){if(n<=0)throw new T(C.INVALID_ARGUMENT,'Function "'+e+'()" requires its '+Q(t)+" argument to be a positive number, but it was: "+n+".")}function Q(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";default:return e+"th"}}function $(e,t){return e+" "+t+(1===e?"":"s")}var Y=function(){function e(){}return e.newId=function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;n<20;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return b(20===t.length,"Invalid auto ID: "+t),t},e}();function X(e,t){return e<t?-1:e>t?1:0}function J(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!e[n].isEqual(t[n]))return!1;return!0}function Z(e){return e+"\0"}function ee(){if("undefined"==typeof Uint8Array)throw new T(C.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function te(){if(!w.getPlatform().base64Available)throw new T(C.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var ne,re=function(){function e(e){te(),this._binaryString=e}return e.fromBase64String=function(t){L("Blob.fromBase64String",arguments,1),M("Blob.fromBase64String","string",1,t),te();try{var n=w.getPlatform().atob(t);return new e(n)}catch(r){throw new T(C.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+r)}},e.fromUint8Array=function(t){if(L("Blob.fromUint8Array",arguments,1),ee(),!(t instanceof Uint8Array))throw K("Blob.fromUint8Array","Uint8Array",1,t);var n=Array.prototype.map.call(t,(function(e){return String.fromCharCode(e)})).join("");return new e(n)},e.prototype.toBase64=function(){return L("Blob.toBase64",arguments,0),te(),w.getPlatform().btoa(this._binaryString)},e.prototype.toUint8Array=function(){L("Blob.toUint8Array",arguments,0),ee();for(var e=new Uint8Array(this._binaryString.length),t=0;t<this._binaryString.length;t++)e[t]=this._binaryString.charCodeAt(t);return e},e.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},e.prototype.isEqual=function(e){return this._binaryString===e._binaryString},e.prototype._compareTo=function(e){return X(this._binaryString,e._binaryString)},e}(),ie=S(re,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),oe=function(e,t,n,r,i){this.databaseId=e,this.persistenceKey=t,this.host=n,this.ssl=r,this.forceLongPolling=i},ae="(default)",se=function(){function e(e,t){this.projectId=e,this.database=t||ae}return Object.defineProperty(e.prototype,"isDefaultDatabase",{get:function(){return this.database===ae},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.projectId===this.projectId&&t.database===this.database},e.prototype.compareTo=function(e){return X(this.projectId,e.projectId)||X(this.database,e.database)},e}(),ue=function(){function e(e,t){var n=this;this.previousValue=e,t&&(t.sequenceNumberHandler=function(e){return n.setPreviousValue(e)},this.writeNewSequenceNumber=function(e){return t.writeSequenceNumber(e)})}return e.prototype.setPreviousValue=function(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue},e.prototype.next=function(){var e=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(e),e},e.INVALID=-1,e}(),ce=function(){function e(e,t,n){void 0===t?t=0:t>e.length&&y("offset "+t+" out of range "+e.length),void 0===n?n=e.length-t:n>e.length-t&&y("length "+n+" out of range "+(e.length-t)),this.segments=e,this.offset=t,this.len=n}return Object.defineProperty(e.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return 0===e.comparator(this,t)},e.prototype.child=function(t){var n=this.segments.slice(this.offset,this.limit());return t instanceof e?t.forEach((function(e){n.push(e)})):n.push(t),this.construct(n)},e.prototype.limit=function(){return this.offset+this.length},e.prototype.popFirst=function(e){return e=void 0===e?1:e,b(this.length>=e,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+e,this.length-e)},e.prototype.popLast=function(){return b(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},e.prototype.firstSegment=function(){return b(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},e.prototype.lastSegment=function(){return this.get(this.length-1)},e.prototype.get=function(e){return b(e<this.length,"Index out of range"),this.segments[this.offset+e]},e.prototype.isEmpty=function(){return 0===this.length},e.prototype.isPrefixOf=function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},e.prototype.isImmediateParentOf=function(e){if(this.length+1!==e.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},e.prototype.forEach=function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])},e.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},e.comparator=function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=e.get(r),o=t.get(r);if(i<o)return-1;if(i>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0},e}(),le=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.construct=function(e,n,r){return new t(e,n,r)},t.prototype.canonicalString=function(){return this.toArray().join("/")},t.prototype.toString=function(){return this.canonicalString()},t.fromString=function(e){if(e.indexOf("//")>=0)throw new T(C.INVALID_ARGUMENT,"Invalid path ("+e+"). Paths must not contain // in them.");return new t(e.split("/").filter((function(e){return e.length>0})))},t.EMPTY_PATH=new t([]),t}(ce),he=/^[_a-zA-Z][_a-zA-Z0-9]*$/,de=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.construct=function(e,n,r){return new t(e,n,r)},t.isValidIdentifier=function(e){return he.test(e)},t.prototype.canonicalString=function(){return this.toArray().map((function(e){return e=e.replace("\\","\\\\").replace("`","\\`"),t.isValidIdentifier(e)||(e="`"+e+"`"),e})).join(".")},t.prototype.toString=function(){return this.canonicalString()},t.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},t.keyField=function(){return new t(["__name__"])},t.fromServerFormat=function(e){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new T(C.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},a=!1;i<e.length;){var s=e[i];if("\\"===s){if(i+1===e.length)throw new T(C.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var u=e[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new T(C.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else"`"===s?(a=!a,i++):"."!==s||a?(r+=s,i++):(o(),i++)}if(o(),a)throw new T(C.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new t(n)},t.EMPTY_PATH=new t([]),t}(ce),pe=function(){function e(t){this.path=t,b(e.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}return e.prototype.hasCollectionId=function(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e},e.prototype.isEqual=function(e){return null!==e&&0===le.comparator(this.path,e.path)},e.prototype.toString=function(){return this.path.toString()},e.comparator=function(e,t){return le.comparator(e.path,t.path)},e.isDocumentKey=function(e){return e.length%2==0},e.fromSegments=function(t){return new e(new le(t.slice()))},e.fromPathString=function(t){return new e(le.fromString(t))},e.EMPTY=new e(new le([])),e}(),fe=function(){var e=this;this.promise=new Promise((function(t,n){e.resolve=t,e.reject=n}))};!function(e){e.All="all",e.ListenStreamIdle="listen_stream_idle",e.ListenStreamConnectionBackoff="listen_stream_connection_backoff",e.WriteStreamIdle="write_stream_idle",e.WriteStreamConnectionBackoff="write_stream_connection_backoff",e.OnlineStateTimeout="online_state_timeout",e.ClientMetadataRefresh="client_metadata_refresh",e.LruGarbageCollection="lru_garbage_collection",e.RetryTransaction="retry_transaction"}(ne||(ne={}));var me=function(){function e(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new fe,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch((function(e){}))}return e.createAndSchedule=function(t,n,r,i,o){var a=new e(t,n,Date.now()+r,i,o);return a.start(r),a},e.prototype.start=function(e){var t=this;this.timerHandle=setTimeout((function(){return t.handleDelayElapsed()}),e)},e.prototype.skipDelay=function(){return this.handleDelayElapsed()},e.prototype.cancel=function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new T(C.CANCELLED,"Operation cancelled"+(e?": "+e:""))))},e.prototype.handleDelayElapsed=function(){var e=this;this.asyncQueue.enqueueAndForget((function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then((function(t){return e.deferred.resolve(t)}))):Promise.resolve()}))},e.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},e}(),ge=function(){function e(){this.tail=Promise.resolve(),this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[]}return Object.defineProperty(e.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!0,configurable:!0}),e.prototype.enqueueAndForget=function(e){this.enqueue(e)},e.prototype.enqueueAndForgetEvenAfterShutdown=function(e){this.verifyNotFailed(),this.enqueueInternal(e)},e.prototype.enqueueEvenAfterShutdown=function(e){return this.verifyNotFailed(),this.enqueueInternal(e)},e.prototype.enqueueAndInitiateShutdown=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){switch(t.label){case 0:return this.verifyNotFailed(),this._isShuttingDown?[3,2]:(this._isShuttingDown=!0,[4,this.enqueueEvenAfterShutdown(e)]);case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},e.prototype.enqueue=function(e){return this.verifyNotFailed(),this._isShuttingDown?new Promise((function(e){})):this.enqueueInternal(e)},e.prototype.enqueueInternal=function(e){var t=this,n=this.tail.then((function(){return t.operationInProgress=!0,e().catch((function(e){t.failure=e,t.operationInProgress=!1;var n=e.stack||e.message||"";throw g("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout((function(){throw e}),0),e})).then((function(e){return t.operationInProgress=!1,e}))}));return this.tail=n,n},e.prototype.enqueueAfterDelay=function(e,t,n){var r=this;this.verifyNotFailed(),b(t>=0,"Attempted to schedule an operation with a negative delay of "+t),this.timerIdsToSkip.indexOf(e)>-1&&(t=0);var i=me.createAndSchedule(this,e,t,n,(function(e){return r.removeDelayedOperation(e)}));return this.delayedOperations.push(i),i},e.prototype.verifyNotFailed=function(){this.failure&&y("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},e.prototype.verifyOperationInProgress=function(){b(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},e.prototype.drain=function(){return this.enqueueEvenAfterShutdown((function(){return Promise.resolve()}))},e.prototype.containsDelayedOperation=function(e){for(var t=0,n=this.delayedOperations;t<n.length;t++){if(n[t].timerId===e)return!0}return!1},e.prototype.runDelayedOperationsEarly=function(e){var t=this;return this.drain().then((function(){b(e===ne.All||t.containsDelayedOperation(e),"Attempted to drain to missing operation "+e),t.delayedOperations.sort((function(e,t){return e.targetTimeMs-t.targetTimeMs}));for(var n=0,r=t.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),e!==ne.All&&i.timerId===e)break}return t.drain()}))},e.prototype.skipDelaysForTimerId=function(e){this.timerIdsToSkip.push(e)},e.prototype.removeDelayedOperation=function(e){var t=this.delayedOperations.indexOf(e);b(t>=0,"Delayed operation not found."),this.delayedOperations.splice(t,1)},e}(),ve="",ye="",be="",we="";function _e(e){for(var t="",n=0;n<e.length;n++)t.length>0&&(t=Te(t)),t=Ce(e.get(n),t);return Te(t)}function Ce(e,t){for(var n=t,r=e.length,i=0;i<r;i++){var o=e.charAt(i);switch(o){case"\0":n+=ve+be;break;case ve:n+=ve+we;break;default:n+=o}}return n}function Te(e){return e+ve+ye}function Se(e){var t=e.length;if(b(t>=2,"Invalid path "+e),2===t)return b(e.charAt(0)===ve&&e.charAt(1)===ye,"Non-empty path "+e+" had length 2"),le.EMPTY_PATH;for(var n=t-2,r=[],i="",o=0;o<t;){var a=e.indexOf(ve,o);switch((a<0||a>n)&&y('Invalid encoded resource path: "'+e+'"'),e.charAt(a+1)){case ye:var s=e.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case be:i+=e.substring(o,a),i+="\0";break;case we:i+=e.substring(o,a+1);break;default:y('Invalid encoded resource path: "'+e+'"')}o=a+2}return new le(r)}var Ee=function(){function e(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new T(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new T(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new T(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new T(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}return e.now=function(){return e.fromMillis(Date.now())},e.fromDate=function(t){return e.fromMillis(t.getTime())},e.fromMillis=function(t){var n=Math.floor(t/1e3);return new e(n,1e6*(t-1e3*n))},e.prototype.toDate=function(){return new Date(this.toMillis())},e.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},e.prototype._compareTo=function(e){return this.seconds===e.seconds?X(this.nanoseconds,e.nanoseconds):X(this.seconds,e.seconds)},e.prototype.isEqual=function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds},e.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},e}(),xe=function(){function e(e){this.timestamp=e}return e.fromMicroseconds=function(t){var n=Math.floor(t/1e6);return new e(new Ee(n,t%1e6*1e3))},e.fromTimestamp=function(t){return new e(t)},e.forDeletedDoc=function(){return e.MIN},e.prototype.compareTo=function(e){return this.timestamp._compareTo(e.timestamp)},e.prototype.isEqual=function(e){return this.timestamp.isEqual(e.timestamp)},e.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},e.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},e.prototype.toTimestamp=function(){return this.timestamp},e.MIN=new e(new Ee(0,0)),e}(),Ie=function(){function e(e,t){this.comparator=e,this.root=t||Ae.EMPTY}return e.prototype.insert=function(t,n){return new e(this.comparator,this.root.insert(t,n,this.comparator).copy(null,null,Ae.BLACK,null,null))},e.prototype.remove=function(t){return new e(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ae.BLACK,null,null))},e.prototype.get=function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null},e.prototype.indexOf=function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1},e.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(e.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),e.prototype.minKey=function(){return this.root.minKey()},e.prototype.maxKey=function(){return this.root.maxKey()},e.prototype.inorderTraversal=function(e){return this.root.inorderTraversal(e)},e.prototype.forEach=function(e){this.inorderTraversal((function(t,n){return e(t,n),!1}))},e.prototype.toString=function(){var e=[];return this.inorderTraversal((function(t,n){return e.push(t+":"+n),!1})),"{"+e.join(", ")+"}"},e.prototype.reverseTraversal=function(e){return this.root.reverseTraversal(e)},e.prototype.getIterator=function(){return new ke(this.root,null,this.comparator,!1)},e.prototype.getIteratorFrom=function(e){return new ke(this.root,e,this.comparator,!1)},e.prototype.getReverseIterator=function(){return new ke(this.root,null,this.comparator,!0)},e.prototype.getReverseIteratorFrom=function(e){return new ke(this.root,e,this.comparator,!0)},e}(),ke=function(){function e(e,t,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!e.isEmpty();)if(i=t?n(e.key,t):1,r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}return e.prototype.getNext=function(){b(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t},e.prototype.hasNext=function(){return this.nodeStack.length>0},e.prototype.peek=function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}},e}(),Ae=function(){function e(t,n,r,i,o){this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=i?i:e.EMPTY,this.right=null!=o?o:e.EMPTY,this.size=this.left.size+1+this.right.size}return e.prototype.copy=function(t,n,r,i,o){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},e.prototype.isEmpty=function(){return!1},e.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},e.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},e.prototype.minKey=function(){return this.min().key},e.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},e.prototype.insert=function(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()},e.prototype.removeMin=function(){if(this.left.isEmpty())return e.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()},e.prototype.remove=function(t,n){var r,i=this;if(n(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(t,i.key)){if(i.right.isEmpty())return e.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,n))}return i.fixUp()},e.prototype.isRed=function(){return this.color},e.prototype.fixUp=function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e},e.prototype.moveRedLeft=function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e},e.prototype.moveRedRight=function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e},e.prototype.rotateLeft=function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},e.prototype.rotateRight=function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},e.prototype.colorFlip=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},e.prototype.checkMaxDepth=function(){var e=this.check();return Math.pow(2,e)<=this.size+1},e.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw y("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw y("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check();if(e!==this.right.check())throw y("Black depths differ");return e+(this.isRed()?0:1)},e.EMPTY=null,e.RED=!0,e.BLACK=!1,e}(),Ne=function(){function e(){this.size=0}return Object.defineProperty(e.prototype,"key",{get:function(){throw y("LLRBEmptyNode has no key.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){throw y("LLRBEmptyNode has no value.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){throw y("LLRBEmptyNode has no color.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"left",{get:function(){throw y("LLRBEmptyNode has no left child.")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"right",{get:function(){throw y("LLRBEmptyNode has no right child.")},enumerable:!0,configurable:!0}),e.prototype.copy=function(e,t,n,r,i){return this},e.prototype.insert=function(e,t,n){return new Ae(e,t)},e.prototype.remove=function(e,t){return this},e.prototype.isEmpty=function(){return!0},e.prototype.inorderTraversal=function(e){return!1},e.prototype.reverseTraversal=function(e){return!1},e.prototype.minKey=function(){return null},e.prototype.maxKey=function(){return null},e.prototype.isRed=function(){return!1},e.prototype.checkMaxDepth=function(){return!0},e.prototype.check=function(){return 0},e}();Ae.EMPTY=new Ne;var Le=function(){function e(e){this.comparator=e,this.data=new Ie(this.comparator)}return e.fromMapKeys=function(t){var n=new e(t.comparator);return t.forEach((function(e){n=n.add(e)})),n},e.prototype.has=function(e){return null!==this.data.get(e)},e.prototype.first=function(){return this.data.minKey()},e.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(e.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),e.prototype.indexOf=function(e){return this.data.indexOf(e)},e.prototype.forEach=function(e){this.data.inorderTraversal((function(t,n){return e(t),!1}))},e.prototype.forEachInRange=function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}},e.prototype.forEachWhile=function(e,t){var n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();){if(!e(n.getNext().key))return}},e.prototype.firstAfterOrEqual=function(e){var t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null},e.prototype.getIterator=function(){return new De(this.data.getIterator())},e.prototype.getIteratorFrom=function(e){return new De(this.data.getIteratorFrom(e))},e.prototype.add=function(e){return this.copy(this.data.remove(e).insert(e,!0))},e.prototype.delete=function(e){return this.has(e)?this.copy(this.data.remove(e)):this},e.prototype.isEmpty=function(){return this.data.isEmpty()},e.prototype.unionWith=function(e){var t=this;return e.forEach((function(e){t=t.add(e)})),t},e.prototype.isEqual=function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.data.getIterator(),r=t.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},e.prototype.toArray=function(){var e=[];return this.forEach((function(t){e.push(t)})),e},e.prototype.toString=function(){var e=[];return this.forEach((function(t){return e.push(t)})),"SortedSet("+e.toString()+")"},e.prototype.copy=function(t){var n=new e(this.comparator);return n.data=t,n},e}(),De=function(){function e(e){this.iter=e}return e.prototype.getNext=function(){return this.iter.getNext().key},e.prototype.hasNext=function(){return this.iter.hasNext()},e}(),Oe=new Ie(pe.comparator);function Me(){return Oe}function Re(){return Me()}var Pe=new Ie(pe.comparator);function Fe(){return Pe}var je=new Ie(pe.comparator);function Be(){return je}var Ve=new Le(pe.comparator);function We(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=Ve,r=0,i=e;r<i.length;r++){var o=i[r];n=n.add(o)}return n}var Ue=new Le(X);function He(){return Ue}var ze=function(){function e(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r,b(r.length>0,"Cannot create an empty mutation batch")}return e.prototype.applyToRemoteDocument=function(e,t,n){t&&b(t.key.isEqual(e),"applyToRemoteDocument: key "+e+" should match maybeDoc key\n        "+t.key);var r=n.mutationResults;b(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(e)){var a=r[i];t=o.applyToRemoteDocument(t,a)}}return t},e.prototype.applyToLocalView=function(e,t){t&&b(t.key.isEqual(e),"applyToLocalDocument: key "+e+" should match maybeDoc key\n        "+t.key);for(var n=0,r=this.baseMutations;n<r.length;n++){(s=r[n]).key.isEqual(e)&&(t=s.applyToLocalView(t,t,this.localWriteTime))}for(var i=t,o=0,a=this.mutations;o<a.length;o++){var s;(s=a[o]).key.isEqual(e)&&(t=s.applyToLocalView(t,i,this.localWriteTime))}return t},e.prototype.applyToLocalDocumentSet=function(e){var t=this,n=e;return this.mutations.forEach((function(r){var i=t.applyToLocalView(r.key,e.get(r.key));i&&(n=n.insert(r.key,i))})),n},e.prototype.keys=function(){return this.mutations.reduce((function(e,t){return e.add(t.key)}),We())},e.prototype.isEqual=function(e){return this.batchId===e.batchId&&J(this.mutations,e.mutations)&&J(this.baseMutations,e.baseMutations)},e}(),qe=function(){function e(e,t,n,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return e.from=function(t,n,r,i){b(t.mutations.length===r.length,"Mutations sent "+t.mutations.length+" must equal results received "+r.length);for(var o=Be(),a=t.mutations,s=0;s<a.length;s++)o=o.insert(a[s].key,r[s].version);return new e(t,n,r,i,o)},e}(),Ke=function(){function e(e){var t=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((function(e){t.isDone=!0,t.result=e,t.nextCallback&&t.nextCallback(e)}),(function(e){t.isDone=!0,t.error=e,t.catchCallback&&t.catchCallback(e)}))}return e.prototype.catch=function(e){return this.next(void 0,e)},e.prototype.next=function(t,n){var r=this;return this.callbackAttached&&y("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(t,this.result):new e((function(e,i){r.nextCallback=function(n){r.wrapSuccess(t,n).next(e,i)},r.catchCallback=function(t){r.wrapFailure(n,t).next(e,i)}}))},e.prototype.toPromise=function(){var e=this;return new Promise((function(t,n){e.next(t,n)}))},e.prototype.wrapUserFunction=function(t){try{var n=t();return n instanceof e?n:e.resolve(n)}catch(r){return e.reject(r)}},e.prototype.wrapSuccess=function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.resolve(n)},e.prototype.wrapFailure=function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.reject(n)},e.resolve=function(t){return new e((function(e,n){e(t)}))},e.reject=function(t){return new e((function(e,n){n(t)}))},e.waitFor=function(t){return new e((function(e,n){var r=0,i=0,o=!1;t.forEach((function(t){++r,t.next((function(){++i,o&&i===r&&e()}),(function(e){return n(e)}))})),o=!0,i===r&&e()}))},e.or=function(t){for(var n=e.resolve(!1),r=function(t){n=n.next((function(n){return n?e.resolve(n):t()}))},i=0,o=t;i<o.length;i++){r(o[i])}return n},e.forEach=function(e,t){var n=this,r=[];return e.forEach((function(e,i){r.push(t.call(n,e,i))})),this.waitFor(r)},e}(),Ge="SimpleDb",Qe=function(){function t(e){this.db=e,12.2===t.getIOSVersion(u.getUA())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return t.openOrCreate=function(e,n,r){return b(t.isAvailable(),"IndexedDB not supported in current environment."),m(Ge,"Opening database:",e),new Ke((function(i,o){var a=window.indexedDB.open(e,n);a.onsuccess=function(e){var n=e.target.result;i(new t(n))},a.onblocked=function(){o(new T(C.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},a.onerror=function(e){var t=e.target.error;"VersionError"===t.name?o(new T(C.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o(t)},a.onupgradeneeded=function(t){m(Ge,'Database "'+e+'" requires upgrade from version:',t.oldVersion);var n=t.target.result;r.createOrUpgrade(n,a.transaction,t.oldVersion,rn).next((function(){m(Ge,"Database upgrade to version "+rn+" complete")}))}})).toPromise()},t.delete=function(e){return m(Ge,"Removing database:",e),Je(window.indexedDB.deleteDatabase(e)).toPromise()},t.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(t.isMockPersistence())return!0;if(void 0===window.navigator)return!1;var e=u.getUA(),n=t.getIOSVersion(e),r=0<n&&n<10,i=t.getAndroidVersion(e),o=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||o)},t.isMockPersistence=function(){var t;return void 0!==e&&"YES"===(null===(t={})||void 0===t?void 0:t.USE_MOCK_PERSISTENCE)},t.getStore=function(e,t){return e.store(t)},t.getIOSVersion=function(e){var t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)},t.getAndroidVersion=function(e){var t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)},t.prototype.setVersionChangeListener=function(e){this.db.onversionchange=function(t){return e(t)}},t.prototype.runTransaction=function(e,t,n){return a.__awaiter(this,void 0,void 0,(function(){var r,i,o,s,u,c;return a.__generator(this,(function(l){switch(l.label){case 0:r=e.startsWith("readonly"),i=e.endsWith("idempotent"),o=0,s=function(){var e,s,c,l;return a.__generator(this,(function(a){switch(a.label){case 0:++o,e=Ye.open(u.db,r?"readonly":"readwrite",t),a.label=1;case 1:return a.trys.push([1,3,,4]),(s=n(e).catch((function(t){return e.abort(t),Ke.reject(t)})).toPromise()).catch((function(){})),[4,e.completionPromise];case 2:return a.sent(),[2,{value:s}];case 3:return c=a.sent(),l=i&&"FirebaseError"!==c.name&&o<3,m(Ge,"Transaction failed with error: %s. Retrying: %s.",c.message,l),l?[3,4]:[2,{value:Promise.reject(c)}];case 4:return[2]}}))},u=this,l.label=1;case 1:return[5,s()];case 2:return"object"==typeof(c=l.sent())?[2,c.value]:[3,1];case 3:return[2]}}))}))},t.prototype.close=function(){this.db.close()},t}(),$e=function(){function e(e){this.dbCursor=e,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(e.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cursor",{set:function(e){this.dbCursor=e},enumerable:!0,configurable:!0}),e.prototype.done=function(){this.shouldStop=!0},e.prototype.skip=function(e){this.nextKey=e},e.prototype.delete=function(){return Je(this.dbCursor.delete())},e}(),Ye=function(){function e(e){var t=this;this.transaction=e,this.aborted=!1,this.completionDeferred=new fe,this.transaction.oncomplete=function(){t.completionDeferred.resolve()},this.transaction.onabort=function(){e.error?t.completionDeferred.reject(e.error):t.completionDeferred.resolve()},this.transaction.onerror=function(e){var n=et(e.target.error);t.completionDeferred.reject(n)}}return e.open=function(t,n,r){return new e(t.transaction(r,n))},Object.defineProperty(e.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),e.prototype.abort=function(e){e&&this.completionDeferred.reject(e),this.aborted||(m(Ge,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},e.prototype.store=function(e){var t=this.transaction.objectStore(e);return b(!!t,"Object store not part of transaction: "+e),new Xe(t)},e}(),Xe=function(){function e(e){this.store=e}return e.prototype.put=function(e,t){var n;return void 0!==t?(m(Ge,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(m(Ge,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Je(n)},e.prototype.add=function(e){return m(Ge,"ADD",this.store.name,e,e),Je(this.store.add(e))},e.prototype.get=function(e){var t=this;return Je(this.store.get(e)).next((function(n){return void 0===n&&(n=null),m(Ge,"GET",t.store.name,e,n),n}))},e.prototype.delete=function(e){return m(Ge,"DELETE",this.store.name,e),Je(this.store.delete(e))},e.prototype.count=function(){return m(Ge,"COUNT",this.store.name),Je(this.store.count())},e.prototype.loadAll=function(e,t){var n=this.cursor(this.options(e,t)),r=[];return this.iterateCursor(n,(function(e,t){r.push(t)})).next((function(){return r}))},e.prototype.deleteAll=function(e,t){m(Ge,"DELETE ALL",this.store.name);var n=this.options(e,t);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,(function(e,t,n){return n.delete()}))},e.prototype.iterate=function(e,t){var n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.iterateCursor(r,t)},e.prototype.iterateSerial=function(e){var t=this.cursor({});return new Ke((function(n,r){t.onerror=function(e){var t=et(e.target.error);r(t)},t.onsuccess=function(t){var r=t.target.result;r?e(r.primaryKey,r.value).next((function(e){e?r.continue():n()})):n()}}))},e.prototype.iterateCursor=function(e,t){var n=[];return new Ke((function(r,i){e.onerror=function(e){i(e.target.error)},e.onsuccess=function(e){var i=e.target.result;if(i){var o=new $e(i),a=t(i.primaryKey,i.value,o);if(a instanceof Ke){var s=a.catch((function(e){return o.done(),Ke.reject(e)}));n.push(s)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}})).next((function(){return Ke.waitFor(n)}))},e.prototype.options=function(e,t){var n=void 0;return void 0!==e&&("string"==typeof e?n=e:(b(void 0===t,"3rd argument must not be defined if 2nd is a range."),t=e)),{index:n,range:t}},e.prototype.cursor=function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.keysOnly?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)},e}();function Je(e){return new Ke((function(t,n){e.onsuccess=function(e){var n=e.target.result;t(n)},e.onerror=function(e){var t=et(e.target.error);n(t)}}))}var Ze=!1;function et(e){var t=Qe.getIOSVersion(u.getUA());if(t>=12.2&&t<13){var n="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(n)>=0){var r=new T("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+n+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return Ze||(Ze=!0,setTimeout((function(){throw r}),0)),r}}return e}var tt=function(){function e(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}return e.forUser=function(t,n,r,i){return b(""!==t.uid,"UserID must not be an empty string."),new e(t.isAuthenticated()?t.uid:"",n,r,i)},e.prototype.checkEmpty=function(e){var t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ot(e).iterate({index:cn.userMutationsIndex,range:n},(function(e,n,r){t=!1,r.done()})).next((function(){return t}))},e.prototype.acknowledgeBatch=function(e,t,n){return this.getMutationQueueMetadata(e).next((function(t){return t.lastStreamToken=it(n),st(e).put(t)}))},e.prototype.getLastStreamToken=function(e){return this.getMutationQueueMetadata(e).next((function(e){return e.lastStreamToken}))},e.prototype.setLastStreamToken=function(e,t){return this.getMutationQueueMetadata(e).next((function(n){return n.lastStreamToken=it(t),st(e).put(n)}))},e.prototype.addMutationBatch=function(e,t,n,r){var i=this,o=at(e),a=ot(e);return a.add({}).next((function(s){b("number"==typeof s,"Auto-generated key is not a number");for(var u=new ze(s,t,n,r),c=i.serializer.toDbMutationBatch(i.userId,u),l=[],h=new Le((function(e,t){return X(e.canonicalString(),t.canonicalString())})),d=0,p=r;d<p.length;d++){var f=p[d],m=ln.key(i.userId,f.key.path,s);h=h.add(f.key.path.popLast()),l.push(a.put(c)),l.push(o.put(m,ln.PLACEHOLDER))}return h.forEach((function(t){l.push(i.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((function(){i.documentKeysByBatchId[s]=u.keys()})),Ke.waitFor(l).next((function(){return u}))}))},e.prototype.lookupMutationBatch=function(e,t){var n=this;return ot(e).get(t).next((function(e){return e?(b(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),n.serializer.fromDbMutationBatch(e)):null}))},e.prototype.lookupMutationKeys=function(e,t){var n=this;return this.documentKeysByBatchId[t]?Ke.resolve(this.documentKeysByBatchId[t]):this.lookupMutationBatch(e,t).next((function(e){if(e){var r=e.keys();return n.documentKeysByBatchId[t]=r,r}return null}))},e.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=this,r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),o=null;return ot(e).iterate({index:cn.userMutationsIndex,range:i},(function(e,t,i){t.userId===n.userId&&(b(t.batchId>=r,"Should have found mutation after "+r),o=n.serializer.fromDbMutationBatch(t)),i.done()})).next((function(){return o}))},e.prototype.getHighestUnacknowledgedBatchId=function(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return ot(e).iterate({index:cn.userMutationsIndex,range:t,reverse:!0},(function(e,t,r){n=t.batchId,r.done()})).next((function(){return n}))},e.prototype.getAllMutationBatches=function(e){var t=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ot(e).loadAll(cn.userMutationsIndex,n).next((function(e){return e.map((function(e){return t.serializer.fromDbMutationBatch(e)}))}))},e.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=ln.prefixForPath(this.userId,t.path),i=IDBKeyRange.lowerBound(r),o=[];return at(e).iterate({range:i},(function(r,i,a){var s=r[0],u=r[1],c=r[2],l=Se(u);if(s===n.userId&&t.path.isEqual(l))return ot(e).get(c).next((function(e){if(!e)throw y("Dangling document-mutation reference found: "+r+" which points to "+c);b(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+c),o.push(n.serializer.fromDbMutationBatch(e))}));a.done()})).next((function(){return o}))},e.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var n=this,r=new Le(X),i=[];return t.forEach((function(t){var o=ln.prefixForPath(n.userId,t.path),a=IDBKeyRange.lowerBound(o),s=at(e).iterate({range:a},(function(e,i,o){var a=e[0],s=e[1],u=e[2],c=Se(s);a===n.userId&&t.path.isEqual(c)?r=r.add(u):o.done()}));i.push(s)})),Ke.waitFor(i).next((function(){return n.lookupMutationBatches(e,r)}))},e.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var n=this;b(!t.isDocumentQuery(),"Document queries shouldn't go down this path"),b(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var r=t.path,i=r.length+1,o=ln.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(o),s=new Le(X);return at(e).iterate({range:a},(function(e,t,o){var a=e[0],u=e[1],c=e[2],l=Se(u);a===n.userId&&r.isPrefixOf(l)?l.length===i&&(s=s.add(c)):o.done()})).next((function(){return n.lookupMutationBatches(e,s)}))},e.prototype.lookupMutationBatches=function(e,t){var n=this,r=[],i=[];return t.forEach((function(t){i.push(ot(e).get(t).next((function(e){if(null===e)throw y("Dangling document-mutation reference found, which points to "+t);b(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),r.push(n.serializer.fromDbMutationBatch(e))})))})),Ke.waitFor(i).next((function(){return r}))},e.prototype.removeMutationBatch=function(e,t){var n=this;return rt(e.simpleDbTransaction,this.userId,t).next((function(r){return e.addOnCommittedListener((function(){n.removeCachedMutationKeys(t.batchId)})),Ke.forEach(r,(function(t){return n.referenceDelegate.removeMutationReference(e,t)}))}))},e.prototype.removeCachedMutationKeys=function(e){delete this.documentKeysByBatchId[e]},e.prototype.performConsistencyCheck=function(e){var t=this;return this.checkEmpty(e).next((function(n){if(!n)return Ke.resolve();var r=IDBKeyRange.lowerBound(ln.prefixForUser(t.userId)),i=[];return at(e).iterate({range:r},(function(e,n,r){if(e[0]===t.userId){var o=Se(e[1]);i.push(o)}else r.done()})).next((function(){b(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map((function(e){return e.canonicalString()})))}))}))},e.prototype.containsKey=function(e,t){return nt(e,this.userId,t)},e.prototype.getMutationQueueMetadata=function(e){var t=this;return st(e).get(this.userId).next((function(e){return e||new un(t.userId,-1,"")}))},e}();function nt(e,t,n){var r=ln.prefixForPath(t,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),a=!1;return at(e).iterate({range:o,keysOnly:!0},(function(e,n,r){var o=e[0],s=e[1];e[2];o===t&&s===i&&(a=!0),r.done()})).next((function(){return a}))}function rt(e,t,n){var r=e.store(cn.store),i=e.store(ln.store),o=[],a=IDBKeyRange.only(n.batchId),s=0,u=r.iterate({range:a},(function(e,t,n){return s++,n.delete()}));o.push(u.next((function(){b(1===s,"Dangling document-mutation reference found: Missing batch "+n.batchId)})));for(var c=[],l=0,h=n.mutations;l<h.length;l++){var d=h[l],p=ln.key(t,d.key.path,n.batchId);o.push(i.delete(p)),c.push(d.key)}return Ke.waitFor(o).next((function(){return c}))}function it(e){return e instanceof Uint8Array?(b(Qe.isMockPersistence(),"Persisting non-string stream tokens is only supported with mock persistence."),e.toString()):e}function ot(e){return Wn.getStore(e,cn.store)}function at(e){return Wn.getStore(e,ln.store)}function st(e){return Wn.getStore(e,un.store)}var ut,ct=1;!function(e){e[e.QueryCache=0]="QueryCache",e[e.SyncEngine=1]="SyncEngine"}(ut||(ut={}));var lt=function(){function e(e,t){this.generatorId=e,b((e&ct)===e,"Generator ID "+e+" contains more than "+ct+" reserved bits"),this.seek(void 0!==t?t:this.generatorId)}return e.prototype.next=function(){var e=this.nextId;return this.nextId+=1<<ct,e},e.prototype.after=function(e){return this.seek(e+(1<<ct)),this.next()},e.prototype.seek=function(e){b((e&ct)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=e},e.forTargetCache=function(){return new e(ut.QueryCache,2)},e.forSyncEngine=function(){return new e(ut.SyncEngine)},e}(),ht=function(){function e(e,t){this.referenceDelegate=e,this.serializer=t,this.targetIdGenerator=lt.forTargetCache()}return e.prototype.allocateTargetId=function(e){var t=this;return this.retrieveMetadata(e).next((function(n){return n.highestTargetId=t.targetIdGenerator.after(n.highestTargetId),t.saveMetadata(e,n).next((function(){return n.highestTargetId}))}))},e.prototype.getLastRemoteSnapshotVersion=function(e){return this.retrieveMetadata(e).next((function(e){return xe.fromTimestamp(new Ee(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))}))},e.prototype.getHighestSequenceNumber=function(e){return ft(e.simpleDbTransaction)},e.prototype.setTargetsMetadata=function(e,t,n){var r=this;return this.retrieveMetadata(e).next((function(i){return i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),r.saveMetadata(e,i)}))},e.prototype.addTargetData=function(e,t){var n=this;return this.saveTargetData(e,t).next((function(){return n.retrieveMetadata(e).next((function(r){return r.targetCount+=1,n.updateMetadataFromTargetData(t,r),n.saveMetadata(e,r)}))}))},e.prototype.updateTargetData=function(e,t){return this.saveTargetData(e,t)},e.prototype.removeTargetData=function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next((function(){return dt(e).delete(t.targetId)})).next((function(){return n.retrieveMetadata(e)})).next((function(t){return b(t.targetCount>0,"Removing from an empty target cache"),t.targetCount-=1,n.saveMetadata(e,t)}))},e.prototype.removeTargets=function(e,t,n){var r=this,i=0,o=[];return dt(e).iterate((function(a,s){var u=r.serializer.fromDbTarget(s);u.sequenceNumber<=t&&null===n.get(u.targetId)&&(i++,o.push(r.removeTargetData(e,u)))})).next((function(){return Ke.waitFor(o)})).next((function(){return i}))},e.prototype.forEachTarget=function(e,t){var n=this;return dt(e).iterate((function(e,r){var i=n.serializer.fromDbTarget(r);t(i)}))},e.prototype.retrieveMetadata=function(e){return pt(e.simpleDbTransaction)},e.prototype.saveMetadata=function(e,t){return(n=e,Wn.getStore(n,vn.store)).put(vn.key,t);var n},e.prototype.saveTargetData=function(e,t){return dt(e).put(this.serializer.toDbTarget(t))},e.prototype.updateMetadataFromTargetData=function(e,t){var n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n},e.prototype.getTargetCount=function(e){return this.retrieveMetadata(e).next((function(e){return e.targetCount}))},e.prototype.getTargetData=function(e,t){var n=this,r=t.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return dt(e).iterate({range:i,index:mn.queryTargetsIndexName},(function(e,r,i){var a=n.serializer.fromDbTarget(r);t.isEqual(a.target)&&(o=a,i.done())})).next((function(){return o}))},e.prototype.addMatchingKeys=function(e,t,n){var r=this,i=[],o=mt(e);return t.forEach((function(t){var a=_e(t.path);i.push(o.put(new gn(n,a))),i.push(r.referenceDelegate.addReference(e,t))})),Ke.waitFor(i)},e.prototype.removeMatchingKeys=function(e,t,n){var r=this,i=mt(e);return Ke.forEach(t,(function(t){var o=_e(t.path);return Ke.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(e,t)])}))},e.prototype.removeMatchingKeysForTargetId=function(e,t){var n=mt(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)},e.prototype.getMatchingKeysForTargetId=function(e,t){var n=IDBKeyRange.bound([t],[t+1],!1,!0),r=mt(e),i=We();return r.iterate({range:n,keysOnly:!0},(function(e,t,n){var r=Se(e[1]),o=new pe(r);i=i.add(o)})).next((function(){return i}))},e.prototype.containsKey=function(e,t){var n=_e(t.path),r=IDBKeyRange.bound([n],[Z(n)],!1,!0),i=0;return mt(e).iterate({index:gn.documentTargetsIndex,keysOnly:!0,range:r},(function(e,t,n){var r=e[0];e[1];0!==r&&(i++,n.done())})).next((function(){return i>0}))},e.prototype.getTargetDataForTarget=function(e,t){var n=this;return dt(e).get(t).next((function(e){return e?n.serializer.fromDbTarget(e):null}))},e}();function dt(e){return Wn.getStore(e,mn.store)}function pt(e){return Qe.getStore(e,vn.store).get(vn.key).next((function(e){return b(null!==e,"Missing metadata row."),e}))}function ft(e){return pt(e).next((function(e){return e.highestListenSequenceNumber}))}function mt(e){return Wn.getStore(e,gn.store)}var gt,vt=function(){function e(e){this.fields=e}return e.fromSet=function(t){return new e(t)},e.fromArray=function(t){var n=new Le(de.comparator);return t.forEach((function(e){return n=n.add(e)})),new e(n)},e.prototype.covers=function(e){var t=!1;return this.fields.forEach((function(n){n.isPrefixOf(e)&&(t=!0)})),t},e.prototype.isEqual=function(e){return this.fields.isEqual(e.fields)},e}(),yt=function(){function e(e,t){this.field=e,this.transform=t}return e.prototype.isEqual=function(e){return this.field.isEqual(e.field)&&this.transform.isEqual(e.transform)},e}(),bt=function(e,t){this.version=e,this.transformResults=t};!function(e){e[e.Set=0]="Set",e[e.Patch=1]="Patch",e[e.Transform=2]="Transform",e[e.Delete=3]="Delete"}(gt||(gt={}));var wt,_t,Ct=function(){function e(e,t){this.updateTime=e,this.exists=t,b(void 0===e||void 0===t,'Precondition can specify "exists" or "updateTime" but not both')}return e.exists=function(t){return new e(void 0,t)},e.updateTime=function(t){return new e(t)},Object.defineProperty(e.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),e.prototype.isValidFor=function(e){return void 0!==this.updateTime?e instanceof qt&&e.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===e instanceof qt:(b(this.isNone,"Precondition should be empty"),!0)},e.prototype.isEqual=function(e){return t=this.updateTime,n=e.updateTime,(null!=t?!(!n||!t.isEqual(n)):t===n)&&this.exists===e.exists;var t,n},e.NONE=new e,e}(),Tt=function(){function e(){}return e.prototype.verifyKeyMatches=function(e){null!=e&&b(e.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},e.getPostMutationVersion=function(e){return e instanceof qt?e.version:xe.MIN},e}(),St=function(e){function t(t,n,r){var i=e.call(this)||this;return i.key=t,i.value=n,i.precondition=r,i.type=gt.Set,i}return a.__extends(t,e),t.prototype.applyToRemoteDocument=function(e,t){this.verifyKeyMatches(e),b(null==t.transformResults,"Transform results received by SetMutation.");var n=t.version;return new qt(this.key,n,{hasCommittedMutations:!0},this.value)},t.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=Tt.getPostMutationVersion(e);return new qt(this.key,r,{hasLocalMutations:!0},this.value)},t.prototype.extractBaseValue=function(e){return null},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&this.value.isEqual(e.value)&&this.precondition.isEqual(e.precondition)},t}(Tt),Et=function(e){function t(t,n,r,i){var o=e.call(this)||this;return o.key=t,o.data=n,o.fieldMask=r,o.precondition=i,o.type=gt.Patch,o}return a.__extends(t,e),t.prototype.applyToRemoteDocument=function(e,t){if(this.verifyKeyMatches(e),b(null==t.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(e))return new Gt(this.key,t.version);var n=this.patchDocument(e);return new qt(this.key,t.version,{hasCommittedMutations:!0},n)},t.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=Tt.getPostMutationVersion(e),i=this.patchDocument(e);return new qt(this.key,r,{hasLocalMutations:!0},i)},t.prototype.extractBaseValue=function(e){return null},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&this.fieldMask.isEqual(e.fieldMask)&&this.precondition.isEqual(e.precondition)},t.prototype.patchDocument=function(e){var t;return t=e instanceof qt?e.data():Ut.EMPTY,this.patchObject(t)},t.prototype.patchObject=function(e){var t=this;return this.fieldMask.fields.forEach((function(n){if(!n.isEmpty()){var r=t.data.field(n);e=null!==r?e.set(n,r):e.delete(n)}})),e},t}(Tt),xt=function(e){function t(t,n){var r=e.call(this)||this;return r.key=t,r.fieldTransforms=n,r.type=gt.Transform,r.precondition=Ct.exists(!0),r}return a.__extends(t,e),t.prototype.applyToRemoteDocument=function(e,t){if(this.verifyKeyMatches(e),b(null!=t.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(e))return new Gt(this.key,t.version);var n=this.requireDocument(e),r=this.serverTransformResults(e,t.transformResults),i=t.version,o=this.transformObject(n.data(),r);return new qt(this.key,i,{hasCommittedMutations:!0},o)},t.prototype.applyToLocalView=function(e,t,n){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var r=this.requireDocument(e),i=this.localTransformResults(n,e,t),o=this.transformObject(r.data(),i);return new qt(this.key,r.version,{hasLocalMutations:!0},o)},t.prototype.extractBaseValue=function(e){for(var t=null,n=0,r=this.fieldTransforms;n<r.length;n++){var i=r[n],o=e instanceof qt?e.field(i.field):void 0,a=i.transform.computeBaseValue(o||null);null!=a&&(t=null==t?Ut.EMPTY.set(i.field,a):t.set(i.field,a))}return t},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&J(this.fieldTransforms,e.fieldTransforms)&&this.precondition.isEqual(e.precondition)},t.prototype.requireDocument=function(e){return b(e instanceof qt,"Unknown MaybeDocument type "+e),b(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},t.prototype.serverTransformResults=function(e,t){var n=[];b(this.fieldTransforms.length===t.length,"server transform result count ("+t.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<t.length;r++){var i=this.fieldTransforms[r],o=i.transform,a=null;e instanceof qt&&(a=e.field(i.field)),n.push(o.applyToRemoteDocument(a,t[r]))}return n},t.prototype.localTransformResults=function(e,t,n){for(var r=[],i=0,o=this.fieldTransforms;i<o.length;i++){var a=o[i],s=a.transform,u=null;t instanceof qt&&(u=t.field(a.field)),null===u&&n instanceof qt&&(u=n.field(a.field)),r.push(s.applyToLocalView(u,e))}return r},t.prototype.transformObject=function(e,t){b(t.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n].field;e=e.set(r,t[n])}return e},t}(Tt),It=function(e){function t(t,n){var r=e.call(this)||this;return r.key=t,r.precondition=n,r.type=gt.Delete,r}return a.__extends(t,e),t.prototype.applyToRemoteDocument=function(e,t){return this.verifyKeyMatches(e),b(null==t.transformResults,"Transform results received by DeleteMutation."),new Kt(this.key,t.version,{hasCommittedMutations:!0})},t.prototype.applyToLocalView=function(e,t,n){return this.verifyKeyMatches(e),this.precondition.isValidFor(e)?(e&&b(e.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Kt(this.key,xe.forDeletedDoc())):e},t.prototype.extractBaseValue=function(e){return null},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&this.precondition.isEqual(e.precondition)},t}(Tt);!function(e){e[e.NullValue=0]="NullValue",e[e.BooleanValue=1]="BooleanValue",e[e.NumberValue=2]="NumberValue",e[e.TimestampValue=3]="TimestampValue",e[e.StringValue=4]="StringValue",e[e.BlobValue=5]="BlobValue",e[e.RefValue=6]="RefValue",e[e.GeoPointValue=7]="GeoPointValue",e[e.ArrayValue=8]="ArrayValue",e[e.ObjectValue=9]="ObjectValue"}(wt||(wt={})),function(e){e[e.Default=0]="Default",e[e.Estimate=1]="Estimate",e[e.Previous=2]="Previous"}(_t||(_t={}));var kt=function(){function e(e,t){this.serverTimestampBehavior=e,this.timestampsInSnapshots=t}return e.fromSnapshotOptions=function(t,n){switch(t.serverTimestamps){case"estimate":return new e(_t.Estimate,n);case"previous":return new e(_t.Previous,n);case"none":case void 0:return new e(_t.Default,n);default:return y("fromSnapshotOptions() called with invalid options.")}},e}(),At=function(){function e(){}return e.prototype.toString=function(){var e=this.value();return null===e?"null":e.toString()},e.prototype.defaultCompareTo=function(e){return b(this.typeOrder!==e.typeOrder,"Default compareTo should not be used for values of same type."),X(this.typeOrder,e.typeOrder)},e}(),Nt=function(e){function t(){var t=e.call(this)||this;return t.typeOrder=wt.NullValue,t.internalValue=null,t}return a.__extends(t,e),t.prototype.value=function(e){return null},t.prototype.isEqual=function(e){return e instanceof t},t.prototype.compareTo=function(e){return e instanceof t?0:this.defaultCompareTo(e)},t.INSTANCE=new t,t}(At),Lt=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.BooleanValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue},t.prototype.isEqual=function(e){return e instanceof t&&this.internalValue===e.internalValue},t.prototype.compareTo=function(e){return e instanceof t?X(this,e):this.defaultCompareTo(e)},t.of=function(e){return e?t.TRUE:t.FALSE},t.TRUE=new t(!0),t.FALSE=new t(!1),t}(At),Dt=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.NumberValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue},t.prototype.compareTo=function(e){return e instanceof t?(n=this.internalValue,r=e.internalValue,n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1):this.defaultCompareTo(e);var n,r},t}(At);function Ot(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}var Mt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.isEqual=function(e){return e instanceof t&&Ot(this.internalValue,e.internalValue)},t}(Dt),Rt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.isEqual=function(e){return e instanceof t&&Ot(this.internalValue,e.internalValue)},t.NAN=new t(NaN),t.POSITIVE_INFINITY=new t(1/0),t.NEGATIVE_INFINITY=new t(-1/0),t}(Dt),Pt=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.StringValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue},t.prototype.isEqual=function(e){return e instanceof t&&this.internalValue===e.internalValue},t.prototype.compareTo=function(e){return e instanceof t?X(this.internalValue,e.internalValue):this.defaultCompareTo(e)},t}(At),Ft=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.TimestampValue,n}return a.__extends(t,e),t.prototype.value=function(e){return!e||e.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},t.prototype.isEqual=function(e){return e instanceof t&&this.internalValue.isEqual(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue._compareTo(e.internalValue):e instanceof jt?-1:this.defaultCompareTo(e)},t}(At),jt=function(e){function t(t,n){var r=e.call(this)||this;return r.localWriteTime=t,r.previousValue=n,r.typeOrder=wt.TimestampValue,r}return a.__extends(t,e),t.prototype.value=function(e){return e&&e.serverTimestampBehavior===_t.Estimate?new Ft(this.localWriteTime).value(e):e&&e.serverTimestampBehavior===_t.Previous&&this.previousValue?this.previousValue.value(e):null},t.prototype.isEqual=function(e){return e instanceof t&&this.localWriteTime.isEqual(e.localWriteTime)},t.prototype.compareTo=function(e){return e instanceof t?this.localWriteTime._compareTo(e.localWriteTime):e instanceof Ft?1:this.defaultCompareTo(e)},t.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},t}(At),Bt=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.BlobValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue},t.prototype.isEqual=function(e){return e instanceof t&&this.internalValue.isEqual(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},t}(At),Vt=function(e){function t(t,n){var r=e.call(this)||this;return r.databaseId=t,r.key=n,r.typeOrder=wt.RefValue,r}return a.__extends(t,e),t.prototype.value=function(e){return this.key},t.prototype.isEqual=function(e){return e instanceof t&&(this.key.isEqual(e.key)&&this.databaseId.isEqual(e.databaseId))},t.prototype.compareTo=function(e){if(e instanceof t){var n=this.databaseId.compareTo(e.databaseId);return 0!==n?n:pe.comparator(this.key,e.key)}return this.defaultCompareTo(e)},t}(At),Wt=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.GeoPointValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue},t.prototype.isEqual=function(e){return e instanceof t&&this.internalValue.isEqual(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},t}(At),Ut=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.ObjectValue,n}return a.__extends(t,e),t.prototype.value=function(e){var t={};return this.internalValue.inorderTraversal((function(n,r){t[n]=r.value(e)})),t},t.prototype.forEach=function(e){this.internalValue.inorderTraversal(e)},t.prototype.isEqual=function(e){if(e instanceof t){for(var n=this.internalValue.getIterator(),r=e.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext();if(i.key!==o.key||!i.value.isEqual(o.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},t.prototype.compareTo=function(e){if(e instanceof t){for(var n=this.internalValue.getIterator(),r=e.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext(),a=X(i.key,o.key)||i.value.compareTo(o.value);if(a)return a}return X(n.hasNext(),r.hasNext())}return this.defaultCompareTo(e)},t.prototype.set=function(e,n){if(b(!e.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===e.length)return this.setChild(e.firstSegment(),n);var r=this.child(e.firstSegment());r instanceof t||(r=t.EMPTY);var i=r.set(e.popFirst(),n);return this.setChild(e.firstSegment(),i)},t.prototype.delete=function(e){if(b(!e.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===e.length)return new t(this.internalValue.remove(e.firstSegment()));var n=this.child(e.firstSegment());if(n instanceof t){var r=n.delete(e.popFirst());return new t(this.internalValue.insert(e.firstSegment(),r))}return this},t.prototype.contains=function(e){return null!==this.field(e)},t.prototype.field=function(e){b(!e.isEmpty(),"Can't get field of empty path");var n=this;return e.forEach((function(e){n=n instanceof t?n.internalValue.get(e):null})),n},t.prototype.fieldMask=function(){var e=new Le(de.comparator);return this.internalValue.forEach((function(n,r){var i=new de([n]);if(r instanceof t){var o=r.fieldMask().fields;o.isEmpty()?e=e.add(i):o.forEach((function(t){e=e.add(i.child(t))}))}else e=e.add(i)})),vt.fromSet(e)},t.prototype.toString=function(){return this.internalValue.toString()},t.prototype.child=function(e){return this.internalValue.get(e)||void 0},t.prototype.setChild=function(e,n){return new t(this.internalValue.insert(e,n))},t.EMPTY=new t(new Ie(X)),t}(At),Ht=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=wt.ArrayValue,n}return a.__extends(t,e),t.prototype.value=function(e){return this.internalValue.map((function(t){return t.value(e)}))},t.prototype.contains=function(e){for(var t=0,n=this.internalValue;t<n.length;t++){if(n[t].isEqual(e))return!0}return!1},t.prototype.forEach=function(e){this.internalValue.forEach(e)},t.prototype.isEqual=function(e){if(e instanceof t){if(this.internalValue.length!==e.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].isEqual(e.internalValue[n]))return!1;return!0}return!1},t.prototype.compareTo=function(e){if(e instanceof t){for(var n=Math.min(this.internalValue.length,e.internalValue.length),r=0;r<n;r++){var i=this.internalValue[r].compareTo(e.internalValue[r]);if(i)return i}return X(this.internalValue.length,e.internalValue.length)}return this.defaultCompareTo(e)},t.prototype.toString=function(){return"["+this.internalValue.map((function(e){return e.toString()})).join(",")+"]"},t}(At),zt=function(){function e(e,t){this.key=e,this.version=t}return e.compareByKey=function(e,t){return pe.comparator(e.key,t.key)},e}(),qt=function(e){function t(t,n,r,i,o,a){var s=e.call(this,t,n)||this;return s.objectValue=i,s.proto=o,s.converter=a,b(void 0!==s.objectValue||void 0!==s.proto&&void 0!==s.converter,"If objectValue is not defined, proto and converter need to be set."),s.hasLocalMutations=!!r.hasLocalMutations,s.hasCommittedMutations=!!r.hasCommittedMutations,s}return a.__extends(t,e),t.prototype.field=function(e){if(this.objectValue)return this.objectValue.field(e);this.fieldValueCache||(this.fieldValueCache=new Map);var t=e.canonicalString(),n=this.fieldValueCache.get(t);if(void 0===n){var r=this.getProtoField(e);n=void 0===r?null:this.converter(r),this.fieldValueCache.set(t,n)}return n},t.prototype.data=function(){var e=this;if(!this.objectValue){var t=Ut.EMPTY;k(this.proto.fields||{},(function(n,r){t=t.set(new de([n]),e.converter(r))})),this.objectValue=t,this.fieldValueCache=void 0}return this.objectValue},t.prototype.value=function(){return this.data().value()},t.prototype.isEqual=function(e){return e instanceof t&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.hasLocalMutations===e.hasLocalMutations&&this.hasCommittedMutations===e.hasCommittedMutations&&this.data().isEqual(e.data())},t.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data().toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),t.prototype.getProtoField=function(e){b(void 0!==this.proto,"Can only call getProtoField() when proto is defined");for(var t=this.proto.fields?this.proto.fields[e.firstSegment()]:void 0,n=1;n<e.length;++n){if(!t||!t.mapValue||!t.mapValue.fields)return;t=t.mapValue.fields[e.get(n)]}return t},t.compareByField=function(e,t,n){var r=t.field(e),i=n.field(e);return null!==r&&null!==i?r.compareTo(i):y("Trying to compare documents on fields that don't exist")},t}(zt),Kt=function(e){function t(t,n,r){var i=e.call(this,t,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return a.__extends(t,e),t.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.hasCommittedMutations===this.hasCommittedMutations&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},t}(zt),Gt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},t}(zt),Qt=function(){function e(e){this.mapKeyFn=e,this.inner={}}return e.prototype.get=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];if(a.isEqual(e))return s}},e.prototype.has=function(e){return void 0!==this.get(e)},e.prototype.set=function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(e))return void(r[i]=[e,t]);r.push([e,t])}else this.inner[n]=[[e,t]]},e.prototype.delete=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1},e.prototype.forEach=function(e){k(this.inner,(function(t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=o[0],s=o[1];e(a,s)}}))},e.prototype.isEmpty=function(){return A(this.inner)},e}(),$t=function(){function e(){this.changes=new Qt((function(e){return e.toString()})),this.changesApplied=!1}return Object.defineProperty(e.prototype,"readTime",{get:function(){return b(void 0!==this._readTime,"Read time is not set. All removeEntry() calls must include a readTime if `trackRemovals` is used."),this._readTime},set:function(e){b(void 0===this._readTime||this._readTime.isEqual(e),"All changes in a RemoteDocumentChangeBuffer must have the same read time"),this._readTime=e},enumerable:!0,configurable:!0}),e.prototype.addEntry=function(e,t){this.assertNotApplied(),this.readTime=t,this.changes.set(e.key,e)},e.prototype.removeEntry=function(e,t){this.assertNotApplied(),t&&(this.readTime=t),this.changes.set(e,null)},e.prototype.getEntry=function(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Ke.resolve(n):this.getFromCache(e,t)},e.prototype.getEntries=function(e,t){return this.getAllFromCache(e,t)},e.prototype.apply=function(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)},e.prototype.assertNotApplied=function(){b(!this.changesApplied,"Changes have already been applied.")},e}(),Yt=function(){function e(e,t){this.serializer=e,this.indexManager=t}return e.prototype.addEntry=function(e,t,n){return Jt(e).put(Zt(t),n)},e.prototype.removeEntry=function(e,t){var n=Jt(e),r=Zt(t);return n.delete(r)},e.prototype.updateMetadata=function(e,t){var n=this;return this.getMetadata(e).next((function(r){return r.byteSize+=t,n.setMetadata(e,r)}))},e.prototype.getEntry=function(e,t){var n=this;return Jt(e).get(Zt(t)).next((function(e){return n.maybeDecodeDocument(e)}))},e.prototype.getSizedEntry=function(e,t){var n=this;return Jt(e).get(Zt(t)).next((function(e){var t=n.maybeDecodeDocument(e);return t?{maybeDocument:t,size:en(e)}:null}))},e.prototype.getEntries=function(e,t){var n=this,r=Re();return this.forEachDbEntry(e,t,(function(e,t){var i=n.maybeDecodeDocument(t);r=r.insert(e,i)})).next((function(){return r}))},e.prototype.getSizedEntries=function(e,t){var n=this,r=Re(),i=new Ie(pe.comparator);return this.forEachDbEntry(e,t,(function(e,t){var o=n.maybeDecodeDocument(t);o?(r=r.insert(e,o),i=i.insert(e,en(t))):(r=r.insert(e,null),i=i.insert(e,0))})).next((function(){return{maybeDocuments:r,sizeMap:i}}))},e.prototype.forEachDbEntry=function(e,t,n){if(t.isEmpty())return Ke.resolve();var r=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),i=t.getIterator(),o=i.getNext();return Jt(e).iterate({range:r},(function(e,t,r){for(var a=pe.fromSegments(e);o&&pe.comparator(o,a)<0;)n(o,null),o=i.getNext();o&&o.isEqual(a)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()})).next((function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))},e.prototype.getDocumentsMatchingQuery=function(e,t,n){var r=this;b(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var i=Fe(),o=t.path.length+1,a={};if(n.isEqual(xe.MIN)){var s=t.path.toArray();a.range=IDBKeyRange.lowerBound(s)}else{var u=t.path.toArray(),c=this.serializer.toDbTimestampKey(n);a.range=IDBKeyRange.lowerBound([u,c],!0),a.index=pn.collectionReadTimeIndex}return Jt(e).iterate(a,(function(e,n,a){if(e.length===o){var s=r.serializer.fromDbRemoteDocument(n);t.path.isPrefixOf(s.key.path)?s instanceof qt&&t.matches(s)&&(i=i.insert(s.key,s)):a.done()}})).next((function(){return i}))},e.prototype.getNewDocumentChanges=function(e,t){var n=this,r=Me(),i=this.serializer.toDbTimestampKey(t),o=Jt(e),a=IDBKeyRange.lowerBound(i,!0);return o.iterate({index:pn.readTimeIndex,range:a},(function(e,t){var o=n.serializer.fromDbRemoteDocument(t);r=r.insert(o.key,o),i=t.readTime})).next((function(){return{changedDocs:r,readTime:n.serializer.fromDbTimestampKey(i)}}))},e.prototype.getLastDocumentChange=function(e){var t,n=this,r=Jt(e),i=xe.MIN;return r.iterate({index:pn.readTimeIndex,reverse:!0},(function(e,r,o){t=n.serializer.fromDbRemoteDocument(r),r.readTime&&(i=n.serializer.fromDbTimestampKey(r.readTime)),o.done()})).next((function(){return{changedDoc:t,readTime:i}}))},e.prototype.newChangeBuffer=function(t){return new e.RemoteDocumentChangeBuffer(this,!!t&&t.trackRemovals)},e.prototype.getSize=function(e){return this.getMetadata(e).next((function(e){return e.byteSize}))},e.prototype.getMetadata=function(e){return Xt(e).get(fn.key).next((function(e){return b(!!e,"Missing document cache metadata"),e}))},e.prototype.setMetadata=function(e,t){return Xt(e).put(fn.key,t)},e.prototype.maybeDecodeDocument=function(e){if(e){var t=this.serializer.fromDbRemoteDocument(e);return t instanceof Kt&&t.version.isEqual(xe.forDeletedDoc())?null:t}return null},e.RemoteDocumentChangeBuffer=function(e){function t(t,n){var r=e.call(this)||this;return r.documentCache=t,r.trackRemovals=n,r.documentSizes=new Qt((function(e){return e.toString()})),r}return a.__extends(t,e),t.prototype.applyChanges=function(e){var t=this,n=[],r=0,i=new Le((function(e,t){return X(e.canonicalString(),t.canonicalString())}));return this.changes.forEach((function(o,a){var s=t.documentSizes.get(o);if(b(void 0!==s,"Cannot modify a document that wasn't read (for "+o+")"),a){b(!t.readTime.isEqual(xe.MIN),"Cannot add a document with a read time of zero");var u=t.documentCache.serializer.toDbRemoteDocument(a,t.readTime);i=i.add(o.path.popLast());var c=en(u);r+=c-s,n.push(t.documentCache.addEntry(e,o,u))}else if(r-=s,t.trackRemovals){var l=t.documentCache.serializer.toDbRemoteDocument(new Kt(o,xe.forDeletedDoc()),t.readTime);n.push(t.documentCache.addEntry(e,o,l))}else n.push(t.documentCache.removeEntry(e,o))})),i.forEach((function(r){n.push(t.documentCache.indexManager.addToCollectionParentIndex(e,r))})),n.push(this.documentCache.updateMetadata(e,r)),Ke.waitFor(n)},t.prototype.getFromCache=function(e,t){var n=this;return this.documentCache.getSizedEntry(e,t).next((function(e){return null===e?(n.documentSizes.set(t,0),null):(n.documentSizes.set(t,e.size),e.maybeDocument)}))},t.prototype.getAllFromCache=function(e,t){var n=this;return this.documentCache.getSizedEntries(e,t).next((function(e){var t=e.maybeDocuments;return e.sizeMap.forEach((function(e,t){n.documentSizes.set(e,t)})),t}))},t}($t),e}();function Xt(e){return Wn.getStore(e,fn.store)}function Jt(e){return Wn.getStore(e,pn.store)}function Zt(e){return e.path.toArray()}function en(e){var t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw y("Unknown remote document type");t=e.noDocument}return JSON.stringify(t).length}var tn=function(){function e(){this.collectionParentIndex=new nn}return e.prototype.addToCollectionParentIndex=function(e,t){return this.collectionParentIndex.add(t),Ke.resolve()},e.prototype.getCollectionParents=function(e,t){return Ke.resolve(this.collectionParentIndex.getEntries(t))},e}(),nn=function(){function e(){this.index={}}return e.prototype.add=function(e){b(e.length%2==1,"Expected a collection path.");var t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Le(le.comparator),i=!r.has(n);return this.index[t]=r.add(n),i},e.prototype.has=function(e){var t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)},e.prototype.getEntries=function(e){return(this.index[e]||new Le(le.comparator)).toArray()},e}(),rn=9,on=function(){function e(e){this.serializer=e}return e.prototype.createOrUpgrade=function(e,t,n,r){var i=this;b(n<r&&n>=0&&r<=rn,"Unexpected schema upgrade from v"+n+" to v{toVersion}.");var o=new Ye(t);n<1&&r>=1&&(function(e){e.createObjectStore(sn.store)}(e),function(e){e.createObjectStore(un.store,{keyPath:un.keyPath}),e.createObjectStore(cn.store,{keyPath:cn.keyPath,autoIncrement:!0}).createIndex(cn.userMutationsIndex,cn.userMutationsKeyPath,{unique:!0}),e.createObjectStore(ln.store)}(e),bn(e),function(e){e.createObjectStore(pn.store)}(e));var a=Ke.resolve();return n<3&&r>=3&&(0!==n&&(!function(e){e.deleteObjectStore(gn.store),e.deleteObjectStore(mn.store),e.deleteObjectStore(vn.store)}(e),bn(e)),a=a.next((function(){return function(e){var t=e.store(vn.store),n=new vn(0,0,xe.MIN.toTimestamp(),0);return t.put(vn.key,n)}(o)}))),n<4&&r>=4&&(0!==n&&(a=a.next((function(){return function(e,t){return t.store(cn.store).loadAll().next((function(n){e.deleteObjectStore(cn.store),e.createObjectStore(cn.store,{keyPath:cn.keyPath,autoIncrement:!0}).createIndex(cn.userMutationsIndex,cn.userMutationsKeyPath,{unique:!0});var r=t.store(cn.store),i=n.map((function(e){return r.put(e)}));return Ke.waitFor(i)}))}(e,o)}))),a=a.next((function(){!function(e){e.createObjectStore(wn.store,{keyPath:wn.keyPath})}(e)}))),n<5&&r>=5&&(a=a.next((function(){return i.removeAcknowledgedMutations(o)}))),n<6&&r>=6&&(a=a.next((function(){return function(e){e.createObjectStore(fn.store)}(e),i.addDocumentGlobal(o)}))),n<7&&r>=7&&(a=a.next((function(){return i.ensureSequenceNumbers(o)}))),n<8&&r>=8&&(a=a.next((function(){return i.createCollectionParentIndex(e,o)}))),n<9&&r>=9&&(a=a.next((function(){!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e),function(e){var t=e.objectStore(pn.store);t.createIndex(pn.readTimeIndex,pn.readTimeIndexPath,{unique:!1}),t.createIndex(pn.collectionReadTimeIndex,pn.collectionReadTimeIndexPath,{unique:!1})}(t)}))),a},e.prototype.addDocumentGlobal=function(e){var t=0;return e.store(pn.store).iterate((function(e,n){t+=en(n)})).next((function(){var n=new fn(t);return e.store(fn.store).put(fn.key,n)}))},e.prototype.removeAcknowledgedMutations=function(e){var t=this,n=e.store(un.store),r=e.store(cn.store);return n.loadAll().next((function(n){return Ke.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(cn.userMutationsIndex,i).next((function(r){return Ke.forEach(r,(function(r){b(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=t.serializer.fromDbMutationBatch(r);return rt(e,n.userId,i).next((function(){}))}))}))}))}))},e.prototype.ensureSequenceNumbers=function(e){var t=e.store(gn.store),n=e.store(pn.store);return ft(e).next((function(e){var r=[];return n.iterate((function(n,i){var o=new le(n),a=function(e){return[0,_e(e)]}(o);r.push(t.get(a).next((function(n){return n?Ke.resolve():function(n){return t.put(new gn(0,_e(n),e))}(o)})))})).next((function(){return Ke.waitFor(r)}))}))},e.prototype.createCollectionParentIndex=function(e,t){e.createObjectStore(yn.store,{keyPath:yn.keyPath});var n=t.store(yn.store),r=new nn,i=function(e){if(r.add(e)){var t=e.lastSegment(),i=e.popLast();return n.put({collectionId:t,parent:_e(i)})}};return t.store(pn.store).iterate({keysOnly:!0},(function(e,t){var n=new le(e);return i(n.popLast())})).next((function(){return t.store(ln.store).iterate({keysOnly:!0},(function(e,t){e[0];var n=e[1],r=(e[2],Se(n));return i(r.popLast())}))}))},e}();var an=function(e,t){this.seconds=e,this.nanoseconds=t},sn=function(){function e(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}return e.store="owner",e.key="owner",e}();var un=function(){function e(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}return e.store="mutationQueues",e.keyPath="userId",e}(),cn=function(){function e(e,t,n,r,i){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i}return e.store="mutations",e.keyPath="batchId",e.userMutationsIndex="userMutationsIndex",e.userMutationsKeyPath=["userId","batchId"],e}();var ln=function(){function e(){}return e.prefixForUser=function(e){return[e]},e.prefixForPath=function(e,t){return[e,_e(t)]},e.key=function(e,t,n){return[e,_e(t),n]},e.store="documentMutations",e.PLACEHOLDER=new e,e}();var hn=function(e,t){this.path=e,this.readTime=t},dn=function(e,t){this.path=e,this.version=t},pn=function(){function e(e,t,n,r,i,o){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=o}return e.store="remoteDocuments",e.readTimeIndex="readTimeIndex",e.readTimeIndexPath="readTime",e.collectionReadTimeIndex="collectionReadTimeIndex",e.collectionReadTimeIndexPath=["parentPath","readTime"],e}(),fn=function(){function e(e){this.byteSize=e}return e.store="remoteDocumentGlobal",e.key="remoteDocumentGlobalKey",e}();var mn=function(){function e(e,t,n,r,i,o,a){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=o,this.query=a}return e.store="targets",e.keyPath="targetId",e.queryTargetsIndexName="queryTargetsIndex",e.queryTargetsKeyPath=["canonicalId","targetId"],e}(),gn=function(){function e(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n,b(0===e==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return e.store="targetDocuments",e.keyPath=["targetId","path"],e.documentTargetsIndex="documentTargetsIndex",e.documentTargetsKeyPath=["path","targetId"],e}(),vn=function(){function e(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return e.key="targetGlobalKey",e.store="targetGlobal",e}(),yn=function(){function e(e,t){this.collectionId=e,this.parent=t}return e.store="collectionParents",e.keyPath=["collectionId","parent"],e}();function bn(e){e.createObjectStore(gn.store,{keyPath:gn.keyPath}).createIndex(gn.documentTargetsIndex,gn.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(mn.store,{keyPath:mn.keyPath}).createIndex(mn.queryTargetsIndexName,mn.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(vn.store)}var wn=function(){function e(e,t,n,r){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r}return e.store="clientMetadata",e.keyPath="clientId",e}();var _n,Cn=[un.store,cn.store,ln.store,pn.store,mn.store,sn.store,vn.store,gn.store],Tn=a.__spreadArrays(Cn,[wn.store]),Sn=a.__spreadArrays(Tn,[fn.store]),En=a.__spreadArrays(Sn,[yn.store]),xn=function(){function e(){this.collectionParentsCache=new nn}return e.prototype.addToCollectionParentIndex=function(e,t){var n=this;if(b(t.length%2==1,"Expected a collection path."),!this.collectionParentsCache.has(t)){var r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener((function(){n.collectionParentsCache.add(t)}));var o={collectionId:r,parent:_e(i)};return In(e).put(o)}return Ke.resolve()},e.prototype.getCollectionParents=function(e,t){var n=[],r=IDBKeyRange.bound([t,""],[Z(t),""],!1,!0);return In(e).loadAll(r).next((function(e){for(var r=0,i=e;r<i.length;r++){var o=i[r];if(o.collectionId!==t)break;n.push(Se(o.parent))}return n}))},e}();function In(e){return Wn.getStore(e,yn.store)}!function(e){e[e.Listen=0]="Listen",e[e.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",e[e.LimboResolution=2]="LimboResolution"}(_n||(_n={}));var kn=function(){function e(e,t,n,r,i,o,a){void 0===i&&(i=xe.MIN),void 0===o&&(o=xe.MIN),void 0===a&&(a=_()),this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a}return e.prototype.withSequenceNumber=function(t){return new e(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},e.prototype.withResumeToken=function(t,n){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,n,this.lastLimboFreeSnapshotVersion,t)},e.prototype.withLastLimboFreeSnapshotVersion=function(t){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)},e.prototype.isEqual=function(e){return this.targetId===e.targetId&&this.purpose===e.purpose&&this.sequenceNumber===e.sequenceNumber&&this.snapshotVersion.isEqual(e.snapshotVersion)&&this.lastLimboFreeSnapshotVersion.isEqual(e.lastLimboFreeSnapshotVersion)&&this.resumeToken===e.resumeToken&&this.target.isEqual(e.target)},e}(),An=function(){function e(e){this.remoteSerializer=e}return e.prototype.fromDbRemoteDocument=function(e){if(e.document)return this.remoteSerializer.fromDocument(e.document,!!e.hasCommittedMutations);if(e.noDocument){var t=pe.fromSegments(e.noDocument.path),n=this.fromDbTimestamp(e.noDocument.readTime);return new Kt(t,n,{hasCommittedMutations:!!e.hasCommittedMutations})}if(e.unknownDocument){t=pe.fromSegments(e.unknownDocument.path),n=this.fromDbTimestamp(e.unknownDocument.version);return new Gt(t,n)}return y("Unexpected DbRemoteDocument")},e.prototype.toDbRemoteDocument=function(e,t){var n=this.toDbTimestampKey(t),r=e.key.path.popLast().toArray();if(e instanceof qt){var i=e.proto?e.proto:this.remoteSerializer.toDocument(e),o=e.hasCommittedMutations;return new pn(null,null,i,o,n,r)}if(e instanceof Kt){var a=e.key.path.toArray(),s=this.toDbTimestamp(e.version);o=e.hasCommittedMutations;return new pn(null,new hn(a,s),null,o,n,r)}if(e instanceof Gt){a=e.key.path.toArray();var u=this.toDbTimestamp(e.version);return new pn(new dn(a,u),null,null,!0,n,r)}return y("Unexpected MaybeDocument")},e.prototype.toDbTimestampKey=function(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]},e.prototype.fromDbTimestampKey=function(e){var t=new Ee(e[0],e[1]);return xe.fromTimestamp(t)},e.prototype.toDbTimestamp=function(e){var t=e.toTimestamp();return new an(t.seconds,t.nanoseconds)},e.prototype.fromDbTimestamp=function(e){var t=new Ee(e.seconds,e.nanoseconds);return xe.fromTimestamp(t)},e.prototype.toDbMutationBatch=function(e,t){var n=this,r=t.baseMutations.map((function(e){return n.remoteSerializer.toMutation(e)})),i=t.mutations.map((function(e){return n.remoteSerializer.toMutation(e)}));return new cn(e,t.batchId,t.localWriteTime.toMillis(),r,i)},e.prototype.fromDbMutationBatch=function(e){var t=this,n=(e.baseMutations||[]).map((function(e){return t.remoteSerializer.fromMutation(e)})),r=e.mutations.map((function(e){return t.remoteSerializer.fromMutation(e)})),i=Ee.fromMillis(e.localWriteTimeMs);return new ze(e.batchId,i,n,r)},e.prototype.toDbResourcePaths=function(e){var t=[];return e.forEach((function(e){t.push(_e(e.path))})),t},e.prototype.fromDbResourcePaths=function(e){for(var t=We(),n=0,r=e;n<r.length;n++){var i=r[n];t=t.add(new pe(Se(i)))}return t},e.prototype.fromDbTarget=function(e){var t,n=this.fromDbTimestamp(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?this.fromDbTimestamp(e.lastLimboFreeSnapshotVersion):xe.MIN,i=e.resumeToken;return t=void 0!==e.query.documents?this.remoteSerializer.fromDocumentsTarget(e.query):this.remoteSerializer.fromQueryTarget(e.query),new kn(t,e.targetId,_n.Listen,e.lastListenSequenceNumber,n,r,i)},e.prototype.toDbTarget=function(e){b(_n.Listen===e.purpose,"Only queries with purpose "+_n.Listen+" may be stored, got "+e.purpose);var t,n,r=this.toDbTimestamp(e.snapshotVersion),i=this.toDbTimestamp(e.lastLimboFreeSnapshotVersion);return t=e.target.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(e.target):this.remoteSerializer.toQueryTarget(e.target),e.resumeToken instanceof Uint8Array?(b(Qe.isMockPersistence(),"Persisting non-string stream tokens is only supported with mock persistence ."),n=e.resumeToken.toString()):n=e.resumeToken,new mn(e.targetId,e.target.canonicalId(),r,n,e.sequenceNumber,i,t)},e}();function Nn(e,t){var n=e[0],r=e[1],i=t[0],o=t[1],a=X(n,i);return 0===a?X(r,o):a}var Ln=function(){function e(e){this.maxElements=e,this.buffer=new Le(Nn),this.previousIndex=0}return e.prototype.nextIndex=function(){return++this.previousIndex},e.prototype.addElement=function(e){var t=[e,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(t);else{var n=this.buffer.last();Nn(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}},Object.defineProperty(e.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),e}(),Dn={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},On=function(){function e(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}return e.withCacheSize=function(t){return new e(t,e.DEFAULT_COLLECTION_PERCENTILE,e.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},e.COLLECTION_DISABLED=-1,e.MINIMUM_CACHE_SIZE_BYTES=1048576,e.DEFAULT_CACHE_SIZE_BYTES=41943040,e.DEFAULT_COLLECTION_PERCENTILE=10,e.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,e.DEFAULT=new e(e.DEFAULT_CACHE_SIZE_BYTES,e.DEFAULT_COLLECTION_PERCENTILE,e.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),e.DISABLED=new e(e.COLLECTION_DISABLED,0,0),e}(),Mn=function(){function e(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.hasRun=!1,this.gcTask=null}return e.prototype.start=function(){b(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==On.COLLECTION_DISABLED&&this.scheduleGC()},e.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(e.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),e.prototype.scheduleGC=function(){var e=this;b(null===this.gcTask,"Cannot schedule GC while a task is pending");var t=this.hasRun?3e5:6e4;m("LruGarbageCollector","Garbage collection scheduled in "+t+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(ne.LruGarbageCollection,t,(function(){return e.gcTask=null,e.hasRun=!0,e.localStore.collectGarbage(e.garbageCollector).then((function(){return e.scheduleGC()})).catch(Un)}))},e}(),Rn=function(){function e(e,t){this.delegate=e,this.params=t}return e.prototype.calculateTargetCount=function(e,t){return this.delegate.getSequenceNumberCount(e).next((function(e){return Math.floor(t/100*e)}))},e.prototype.nthSequenceNumber=function(e,t){var n=this;if(0===t)return Ke.resolve(ue.INVALID);var r=new Ln(t);return this.delegate.forEachTarget(e,(function(e){return r.addElement(e.sequenceNumber)})).next((function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(e,(function(e){return r.addElement(e)}))})).next((function(){return r.maxValue}))},e.prototype.removeTargets=function(e,t,n){return this.delegate.removeTargets(e,t,n)},e.prototype.removeOrphanedDocuments=function(e,t){return this.delegate.removeOrphanedDocuments(e,t)},e.prototype.collect=function(e,t){var n=this;return this.params.cacheSizeCollectionThreshold===On.COLLECTION_DISABLED?(m("LruGarbageCollector","Garbage collection skipped; disabled"),Ke.resolve(Dn)):this.getCacheSize(e).next((function(r){return r<n.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),Dn):n.runGarbageCollection(e,t)}))},e.prototype.getCacheSize=function(e){return this.delegate.getCacheSize(e)},e.prototype.runGarbageCollection=function(e,t){var n,r,o,a,s,u,c,l=this,h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((function(t){return t>l.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+l.params.maximumSequenceNumbersToCollect+" from "+t),r=l.params.maximumSequenceNumbersToCollect):r=t,a=Date.now(),l.nthSequenceNumber(e,r)})).next((function(r){return n=r,s=Date.now(),l.removeTargets(e,n,t)})).next((function(t){return o=t,u=Date.now(),l.removeOrphanedDocuments(e,n)})).next((function(e){(c=Date.now(),p()<=i.DEBUG)&&m("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-h)+"ms\n\tDetermined least recently used "+r+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+e+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-h)+"ms");return Ke.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:o,documentsRemoved:e})}))},e}(),Pn=function(){function e(){this.onCommittedListeners=[]}return e.prototype.addOnCommittedListener=function(e){this.onCommittedListeners.push(e)},e.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach((function(e){return e()}))},e}(),Fn="IndexedDbPersistence",jn="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Bn="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",Vn=function(e){function t(t,n){var r=e.call(this)||this;return r.simpleDbTransaction=t,r.currentSequenceNumber=n,r}return a.__extends(t,e),t}(Pn),Wn=function(){function e(t,n,r,i,o,a,s,u){if(this.allowTabSynchronization=t,this.persistenceKey=n,this.clientId=r,this.queue=a,this.sequenceNumberSyncer=u,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(e){return Promise.resolve()},this.referenceDelegate=new qn(this,o),this.dbName=n+e.MAIN_DATABASE,this.serializer=new An(s),this.document=i.document,this.targetCache=new ht(this.referenceDelegate,this.serializer),this.indexManager=new xn,this.remoteDocumentCache=new Yt(this.serializer,this.indexManager),!i.window||!i.window.localStorage)throw new T(C.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=i.window,this.webStorage=this.window.localStorage}return e.getStore=function(e,t){if(e instanceof Vn)return Qe.getStore(e.simpleDbTransaction,t);throw y("IndexedDbPersistence must use instances of IndexedDbTransaction")},e.createIndexedDbPersistence=function(t){return a.__awaiter(this,void 0,void 0,(function(){var n;return a.__generator(this,(function(r){switch(r.label){case 0:if(!e.isAvailable())throw new T(C.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");return[4,(n=new e(t.allowTabSynchronization,t.persistenceKey,t.clientId,t.platform,t.lruParams,t.queue,t.serializer,t.sequenceNumberSyncer)).start()];case 1:return r.sent(),[2,n]}}))}))},e.prototype.start=function(){var e=this;return b(!this.started,"IndexedDbPersistence double-started!"),b(null!==this.window,"Expected 'window' to be defined"),Qe.openOrCreate(this.dbName,rn,new on(this.serializer)).then((function(t){return e.simpleDb=t,e.updateClientMetadataAndTryBecomePrimary()})).then((function(){return e.attachVisibilityHandler(),e.attachWindowUnloadHook(),e.scheduleClientMetadataAndPrimaryLeaseRefreshes(),e.simpleDb.runTransaction("readonly-idempotent",[vn.store],(function(e){return ft(e)}))})).then((function(t){e.listenSequence=new ue(t,e.sequenceNumberSyncer)})).then((function(){e._started=!0})).catch((function(t){return e.simpleDb&&e.simpleDb.close(),Promise.reject(t)}))},e.prototype.setPrimaryStateListener=function(e){var t=this;return this.primaryStateListener=function(n){return a.__awaiter(t,void 0,void 0,(function(){return a.__generator(this,(function(t){return this.started?[2,e(n)]:[2]}))}))},e(this.isPrimary)},e.prototype.setDatabaseDeletedListener=function(e){var t=this;this.simpleDb.setVersionChangeListener((function(n){return a.__awaiter(t,void 0,void 0,(function(){return a.__generator(this,(function(t){switch(t.label){case 0:return null!==n.newVersion?[3,2]:[4,e()];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))},e.prototype.setNetworkEnabled=function(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.queue.enqueueAndForget((function(){return a.__awaiter(t,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))})))},e.prototype.updateClientMetadataAndTryBecomePrimary=function(){var e=this;return this.simpleDb.runTransaction("readwrite-idempotent",En,(function(t){return zn(t).put(new wn(e.clientId,Date.now(),e.networkEnabled,e.inForeground)).next((function(){if(e.isPrimary)return e.verifyPrimaryLease(t).next((function(t){t||(e.isPrimary=!1,e.queue.enqueueAndForget((function(){return e.primaryStateListener(!1)})))}))})).next((function(){return e.canActAsPrimary(t)})).next((function(n){return e.isPrimary&&!n?e.releasePrimaryLeaseIfHeld(t).next((function(){return!1})):!!n&&e.acquireOrExtendPrimaryLease(t).next((function(){return!0}))}))})).catch((function(t){if(!e.allowTabSynchronization)throw t;return m(Fn,"Releasing owner lease after error during lease refresh",t),!1})).then((function(t){e.isPrimary!==t&&e.queue.enqueueAndForget((function(){return e.primaryStateListener(t)})),e.isPrimary=t}))},e.prototype.verifyPrimaryLease=function(e){var t=this;return Hn(e).get(sn.key).next((function(e){return Ke.resolve(t.isLocalClient(e))}))},e.prototype.removeClientMetadata=function(e){return zn(e).delete(this.clientId)},e.prototype.maybeGarbageCollectMultiClientState=function(){return a.__awaiter(this,void 0,void 0,(function(){var t=this;return a.__generator(this,(function(n){switch(n.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary-idempotent",(function(n){var r=e.getStore(n,wn.store);return r.loadAll().next((function(e){var n=t.filterActiveClients(e,18e5),i=e.filter((function(e){return-1===n.indexOf(e)}));return Ke.forEach(i,(function(e){return r.delete(e.clientId)})).next((function(){return i}))}))}))]);case 1:n.sent().forEach((function(e){t.window.localStorage.removeItem(t.zombiedClientLocalStorageKey(e.clientId))})),n.label=2;case 2:return[2]}}))}))},e.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var e=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(ne.ClientMetadataRefresh,4e3,(function(){return e.updateClientMetadataAndTryBecomePrimary().then((function(){return e.maybeGarbageCollectMultiClientState()})).then((function(){return e.scheduleClientMetadataAndPrimaryLeaseRefreshes()}))}))},e.prototype.isLocalClient=function(e){return!!e&&e.ownerId===this.clientId},e.prototype.canActAsPrimary=function(e){var t=this;return Hn(e).get(sn.key).next((function(n){if(null!==n&&t.isWithinAge(n.leaseTimestampMs,5e3)&&!t.isClientZombied(n.ownerId)){if(t.isLocalClient(n)&&t.networkEnabled)return!0;if(!t.isLocalClient(n)){if(!n.allowTabSynchronization)throw new T(C.FAILED_PRECONDITION,Bn);return!1}}return!(!t.networkEnabled||!t.inForeground)||zn(e).loadAll().next((function(e){return void 0===t.filterActiveClients(e,5e3).find((function(e){if(t.clientId!==e.clientId){var n=!t.networkEnabled&&e.networkEnabled,r=!t.inForeground&&e.inForeground,i=t.networkEnabled===e.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(e){return t.isPrimary!==e&&m(Fn,"Client "+(e?"is":"is not")+" eligible for a primary lease."),e}))},e.prototype.shutdown=function(){return a.__awaiter(this,void 0,void 0,(function(){var e=this;return a.__generator(this,(function(t){switch(t.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite-idempotent",[sn.store,wn.store],(function(t){return e.releasePrimaryLeaseIfHeld(t).next((function(){return e.removeClientMetadata(t)}))}))];case 1:return t.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}}))}))},e.prototype.filterActiveClients=function(e,t){var n=this;return e.filter((function(e){return n.isWithinAge(e.updateTimeMs,t)&&!n.isClientZombied(e.clientId)}))},e.prototype.getActiveClients=function(){var e=this;return this.simpleDb.runTransaction("readonly-idempotent",[wn.store],(function(t){return zn(t).loadAll().next((function(t){return e.filterActiveClients(t,18e5).map((function(e){return e.clientId}))}))}))},e.clearPersistence=function(t){return a.__awaiter(this,void 0,void 0,(function(){var n;return a.__generator(this,(function(r){switch(r.label){case 0:return e.isAvailable()?(n=t+e.MAIN_DATABASE,[4,Qe.delete(n)]):[2,Promise.resolve()];case 1:return r.sent(),[2]}}))}))},Object.defineProperty(e.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),e.prototype.getMutationQueue=function(e){return b(this.started,"Cannot initialize MutationQueue before persistence is started."),tt.forUser(e,this.serializer,this.indexManager,this.referenceDelegate)},e.prototype.getTargetCache=function(){return b(this.started,"Cannot initialize TargetCache before persistence is started."),this.targetCache},e.prototype.getRemoteDocumentCache=function(){return b(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},e.prototype.getIndexManager=function(){return b(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},e.prototype.runTransaction=function(e,t,n){var r=this;m(Fn,"Starting transaction:",e);var i,o=t.endsWith("idempotent"),a=t.startsWith("readonly")?o?"readonly-idempotent":"readonly":o?"readwrite-idempotent":"readwrite";return this.simpleDb.runTransaction(a,En,(function(o){return i=new Vn(o,r.listenSequence.next()),"readwrite-primary"===t||"readwrite-primary-idempotent"===t?r.verifyPrimaryLease(o).next((function(e){return!!e||r.canActAsPrimary(o)})).next((function(t){if(!t)throw g("Failed to obtain primary lease for action '"+e+"'."),r.isPrimary=!1,r.queue.enqueueAndForget((function(){return r.primaryStateListener(!1)})),new T(C.FAILED_PRECONDITION,jn);return n(i)})).next((function(e){return r.acquireOrExtendPrimaryLease(o).next((function(){return e}))})):r.verifyAllowTabSynchronization(o).next((function(){return n(i)}))})).then((function(e){return i.raiseOnCommittedEvent(),e}))},e.prototype.verifyAllowTabSynchronization=function(e){var t=this;return Hn(e).get(sn.key).next((function(e){if(null!==e&&t.isWithinAge(e.leaseTimestampMs,5e3)&&!t.isClientZombied(e.ownerId)&&!t.isLocalClient(e)&&!e.allowTabSynchronization)throw new T(C.FAILED_PRECONDITION,Bn)}))},e.prototype.acquireOrExtendPrimaryLease=function(e){var t=new sn(this.clientId,this.allowTabSynchronization,Date.now());return Hn(e).put(sn.key,t)},e.isAvailable=function(){return Qe.isAvailable()},e.buildStoragePrefix=function(e){var t=e.databaseId.projectId;return e.databaseId.isDefaultDatabase||(t+="."+e.databaseId.database),"firestore/"+e.persistenceKey+"/"+t+"/"},e.prototype.releasePrimaryLeaseIfHeld=function(e){var t=this,n=Hn(e);return n.get(sn.key).next((function(e){return t.isLocalClient(e)?(m(Fn,"Releasing primary lease."),n.delete(sn.key)):Ke.resolve()}))},e.prototype.isWithinAge=function(e,t){var n=Date.now();return!(e<n-t)&&(!(e>n)||(g("Detected an update time that is in the future: "+e+" > "+n),!1))},e.prototype.attachVisibilityHandler=function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){e.queue.enqueueAndForget((function(){return e.inForeground="visible"===e.document.visibilityState,e.updateClientMetadataAndTryBecomePrimary()}))},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},e.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(b(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},e.prototype.attachWindowUnloadHook=function(){var e=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){e.markClientZombied(),e.queue.enqueueAndForget((function(){return e.shutdown()}))},this.window.addEventListener("unload",this.windowUnloadHandler))},e.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(b("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},e.prototype.isClientZombied=function(e){try{var t=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(e));return m(Fn,"Client '"+e+"' "+(t?"is":"is not")+" zombied in LocalStorage"),t}catch(n){return g(Fn,"Failed to get zombied client id.",n),!1}},e.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}},e.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}},e.prototype.zombiedClientLocalStorageKey=function(e){return"firestore_zombie_"+this.persistenceKey+"_"+e},e.MAIN_DATABASE="main",e}();function Un(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){if(!function(e){return e.code===C.FAILED_PRECONDITION&&e.message===jn}(e))throw e;return m(Fn,"Unexpectedly lost primary lease"),[2]}))}))}function Hn(e){return e.store(sn.store)}function zn(e){return e.store(wn.store)}var qn=function(){function e(e,t){this.db=e,this.inMemoryPins=null,this.garbageCollector=new Rn(this,t)}return e.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocmentCount(e);return this.db.getTargetCache().getTargetCount(e).next((function(e){return t.next((function(t){return e+t}))}))},e.prototype.orphanedDocmentCount=function(e){var t=0;return this.forEachOrphanedDocumentSequenceNumber(e,(function(e){t++})).next((function(){return t}))},e.prototype.forEachTarget=function(e,t){return this.db.getTargetCache().forEachTarget(e,t)},e.prototype.forEachOrphanedDocumentSequenceNumber=function(e,t){return this.forEachOrphanedDocument(e,(function(e,n){return t(n)}))},e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.addReference=function(e,t){return Kn(e,t)},e.prototype.removeReference=function(e,t){return Kn(e,t)},e.prototype.removeTargets=function(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)},e.prototype.removeMutationReference=function(e,t){return Kn(e,t)},e.prototype.isPinned=function(e,t){return this.inMemoryPins.containsKey(t)?Ke.resolve(!0):function(e,t){var n=!1;return st(e).iterateSerial((function(r){return nt(e,r,t).next((function(e){return e&&(n=!0),Ke.resolve(!e)}))})).next((function(){return n}))}(e,t)},e.prototype.removeOrphanedDocuments=function(e,t){var n=this,r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],o=0;return this.forEachOrphanedDocument(e,(function(a,s){if(s<=t){var u=n.isPinned(e,a).next((function(t){if(!t)return o++,r.getEntry(e,a).next((function(){return r.removeEntry(a),mt(e).delete([0,_e(a.path)])}))}));i.push(u)}})).next((function(){return Ke.waitFor(i)})).next((function(){return r.apply(e)})).next((function(){return o}))},e.prototype.removeTarget=function(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)},e.prototype.updateLimboDocument=function(e,t){return Kn(e,t)},e.prototype.forEachOrphanedDocument=function(e,t){var n,r=mt(e),i=ue.INVALID;return r.iterate({index:gn.documentTargetsIndex},(function(e,r){var o=e[0],a=(e[1],r.path),s=r.sequenceNumber;0===o?(i!==ue.INVALID&&t(new pe(Se(n)),i),i=s,n=a):i=ue.INVALID})).next((function(){i!==ue.INVALID&&t(new pe(Se(n)),i)}))},e.prototype.getCacheSize=function(e){return this.db.getRemoteDocumentCache().getSize(e)},e}();function Kn(e,t){return mt(e).put(function(e,t){return new gn(0,_e(e.path),t)}(t,e.currentSequenceNumber))}var Gn=Number,Qn=Gn.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),$n=Gn.MAX_SAFE_INTEGER||Math.pow(2,53)-1,Yn=Gn.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e};function Xn(e){return null==e}function Jn(e){return Yn(e)&&e<=$n&&e>=Qn}var Zn,er=function(){function e(e,t,n,r,i,o,a){void 0===t&&(t=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null}return e.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var e=this.path.canonicalString();null!==this.collectionGroup&&(e+="|cg:"+this.collectionGroup),e+="|f:";for(var t=0,n=this.filters;t<n.length;t++){e+=n[t].canonicalId(),e+=","}e+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){e+=i[r].canonicalId(),e+=","}Xn(this.limit)||(e+="|l:",e+=this.limit),this.startAt&&(e+="|lb:",e+=this.startAt.canonicalId()),this.endAt&&(e+="|ub:",e+=this.endAt.canonicalId()),this.memoizedCanonicalId=e}return this.memoizedCanonicalId},e.prototype.toString=function(){var e=this.path.canonicalString();return null!==this.collectionGroup&&(e+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(e+=", filters: ["+this.filters.join(", ")+"]"),Xn(this.limit)||(e+=", limit: "+this.limit),this.orderBy.length>0&&(e+=", orderBy: ["+this.orderBy.join(", ")+"]"),this.startAt&&(e+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(e+=", endAt: "+this.endAt.canonicalId()),"Target("+e+")"},e.prototype.isEqual=function(e){if(this.limit!==e.limit)return!1;if(this.orderBy.length!==e.orderBy.length)return!1;for(var t=0;t<this.orderBy.length;t++)if(!this.orderBy[t].isEqual(e.orderBy[t]))return!1;if(this.filters.length!==e.filters.length)return!1;for(t=0;t<this.filters.length;t++)if(!this.filters[t].isEqual(e.filters[t]))return!1;return this.collectionGroup===e.collectionGroup&&(!!this.path.isEqual(e.path)&&(!(null!==this.startAt?!this.startAt.isEqual(e.startAt):null!==e.startAt)&&(null!==this.endAt?this.endAt.isEqual(e.endAt):null===e.endAt)))},e.prototype.isDocumentQuery=function(){return pe.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},e}();!function(e){e.First="F",e.Last="L"}(Zn||(Zn={}));var tr=function(){function e(e,t,n,r,i,o,a,s){void 0===t&&(t=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=Zn.First),void 0===a&&(a=null),void 0===s&&(s=null),this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=o,this.startAt=a,this.endAt=s,this.memoizedOrderBy=null,this.memoizedTarget=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return e.atPath=function(t){return new e(t)},Object.defineProperty(e.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var e=this.getInequalityFilterField(),t=this.getFirstOrderByField();if(null!==e&&null===t)e.isKeyField()?this.memoizedOrderBy=[pr]:this.memoizedOrderBy=[new dr(e),pr];else{b(null===e||null!==t&&e.isEqual(t),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){var a=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:lr.ASCENDING;this.memoizedOrderBy.push(a===lr.ASCENDING?pr:fr)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),e.prototype.addFilter=function(t){b(null==this.getInequalityFilterField()||!(t instanceof ir)||!t.isInequality()||t.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),b(!this.isDocumentQuery(),"No filtering allowed for document query");var n=this.filters.concat([t]);return new e(this.path,this.collectionGroup,this.explicitOrderBy.slice(),n,this.limit,this.limitType,this.startAt,this.endAt)},e.prototype.addOrderBy=function(t){b(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([t]);return new e(this.path,this.collectionGroup,n,this.filters.slice(),this.limit,this.limitType,this.startAt,this.endAt)},e.prototype.withLimitToFirst=function(t){return new e(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,Zn.First,this.startAt,this.endAt)},e.prototype.withLimitToLast=function(t){return new e(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),t,Zn.Last,this.startAt,this.endAt)},e.prototype.withStartAt=function(t){return new e(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,t,this.endAt)},e.prototype.withEndAt=function(t){return new e(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,this.startAt,t)},e.prototype.asCollectionQueryAtPath=function(t){return new e(t,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.limitType,this.startAt,this.endAt)},e.prototype.matchesAllDocuments=function(){return 0===this.filters.length&&null===this.limit&&null==this.startAt&&null==this.endAt&&(0===this.explicitOrderBy.length||1===this.explicitOrderBy.length&&this.explicitOrderBy[0].field.isKeyField())},e.prototype.canonicalId=function(){return this.toTarget().canonicalId()+"|lt:"+this.limitType},e.prototype.toString=function(){return"Query(target="+this.toTarget().toString()+"; limitType="+this.limitType+")"},e.prototype.isEqual=function(e){return this.toTarget().isEqual(e.toTarget())&&this.limitType===e.limitType},e.prototype.docComparator=function(e,t){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],a=o.compare(e,t);if(0!==a)return a;n=n||o.field.isKeyField()}return b(n,"orderBy used that doesn't compare on key field"),0},e.prototype.matches=function(e){return this.matchesPathAndCollectionGroup(e)&&this.matchesOrderBy(e)&&this.matchesFilters(e)&&this.matchesBounds(e)},e.prototype.hasLimitToFirst=function(){return!Xn(this.limit)&&this.limitType===Zn.First},e.prototype.hasLimitToLast=function(){return!Xn(this.limit)&&this.limitType===Zn.Last},e.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},e.prototype.getInequalityFilterField=function(){for(var e=0,t=this.filters;e<t.length;e++){var n=t[e];if(n instanceof ir&&n.isInequality())return n.field}return null},e.prototype.findFilterOperator=function(e){for(var t=0,n=this.filters;t<n.length;t++){var r=n[t];if(r instanceof ir&&e.indexOf(r.op)>=0)return r.op}return null},e.prototype.isDocumentQuery=function(){return this.toTarget().isDocumentQuery()},e.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},e.prototype.toTarget=function(){if(!this.memoizedTarget)if(this.limitType===Zn.First)this.memoizedTarget=new er(this.path,this.collectionGroup,this.orderBy,this.filters,this.limit,this.startAt,this.endAt);else{for(var e=[],t=0,n=this.orderBy;t<n.length;t++){var r=n[t],i=r.dir===lr.DESCENDING?lr.ASCENDING:lr.DESCENDING;e.push(new dr(r.field,i))}var o=this.endAt?new hr(this.endAt.position,!this.endAt.before):null,a=this.startAt?new hr(this.startAt.position,!this.startAt.before):null;this.memoizedTarget=new er(this.path,this.collectionGroup,e,this.filters,this.limit,o,a)}return this.memoizedTarget},e.prototype.matchesPathAndCollectionGroup=function(e){var t=e.key.path;return null!==this.collectionGroup?e.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(t):pe.isDocumentKey(this.path)?this.path.isEqual(t):this.path.isImmediateParentOf(t)},e.prototype.matchesOrderBy=function(e){for(var t=0,n=this.explicitOrderBy;t<n.length;t++){var r=n[t];if(!r.field.isKeyField()&&null===e.field(r.field))return!1}return!0},e.prototype.matchesFilters=function(e){for(var t=0,n=this.filters;t<n.length;t++){if(!n[t].matches(e))return!1}return!0},e.prototype.matchesBounds=function(e){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,e))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,e))},e.prototype.assertValidBound=function(e){b(e.position.length<=this.orderBy.length,"Bound is longer than orderBy")},e}(),nr=function(){},rr=function(){function e(e){this.name=e}return e.fromString=function(t){switch(t){case"<":return e.LESS_THAN;case"<=":return e.LESS_THAN_OR_EQUAL;case"==":return e.EQUAL;case">=":return e.GREATER_THAN_OR_EQUAL;case">":return e.GREATER_THAN;case"array-contains":return e.ARRAY_CONTAINS;case"in":return e.IN;case"array-contains-any":return e.ARRAY_CONTAINS_ANY;default:return y("Unknown FieldFilter operator: "+t)}},e.prototype.toString=function(){return this.name},e.prototype.isEqual=function(e){return this.name===e.name},e.LESS_THAN=new e("<"),e.LESS_THAN_OR_EQUAL=new e("<="),e.EQUAL=new e("=="),e.GREATER_THAN=new e(">"),e.GREATER_THAN_OR_EQUAL=new e(">="),e.ARRAY_CONTAINS=new e("array-contains"),e.IN=new e("in"),e.ARRAY_CONTAINS_ANY=new e("array-contains-any"),e}(),ir=function(e){function t(t,n,r){var i=e.call(this)||this;return i.field=t,i.op=n,i.value=r,i}return a.__extends(t,e),t.create=function(e,n,r){if(e.isKeyField())return n===rr.IN?(b(r instanceof Ht,"Comparing on key with IN, but filter value not an ArrayValue"),b(r.internalValue.every((function(e){return e instanceof Vt})),"Comparing on key with IN, but an array value was not a RefValue"),new ar(e,r)):(b(r instanceof Vt,"Comparing on key, but filter value not a RefValue"),b(n!==rr.ARRAY_CONTAINS&&n!==rr.ARRAY_CONTAINS_ANY,"'"+n.toString()+"' queries don't make sense on document keys."),new or(e,n,r));if(r.isEqual(Nt.INSTANCE)){if(n!==rr.EQUAL)throw new T(C.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new t(e,n,r)}if(r.isEqual(Rt.NAN)){if(n!==rr.EQUAL)throw new T(C.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new t(e,n,r)}return n===rr.ARRAY_CONTAINS?new sr(e,r):n===rr.IN?(b(r instanceof Ht,"IN filter has invalid value: "+r.toString()),new ur(e,r)):n===rr.ARRAY_CONTAINS_ANY?(b(r instanceof Ht,"ARRAY_CONTAINS_ANY filter has invalid value: "+r.toString()),new cr(e,r)):new t(e,n,r)},t.prototype.matches=function(e){var t=e.field(this.field);return null!==t&&this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},t.prototype.matchesComparison=function(e){switch(this.op){case rr.LESS_THAN:return e<0;case rr.LESS_THAN_OR_EQUAL:return e<=0;case rr.EQUAL:return 0===e;case rr.GREATER_THAN:return e>0;case rr.GREATER_THAN_OR_EQUAL:return e>=0;default:return y("Unknown FieldFilter operator: "+this.op)}},t.prototype.isInequality=function(){return[rr.LESS_THAN,rr.LESS_THAN_OR_EQUAL,rr.GREATER_THAN,rr.GREATER_THAN_OR_EQUAL].indexOf(this.op)>=0},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},t.prototype.isEqual=function(e){return e instanceof t&&(this.op.isEqual(e.op)&&this.field.isEqual(e.field)&&this.value.isEqual(e.value))},t.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},t}(nr),or=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.matches=function(e){var t=this.value,n=pe.comparator(e.key,t.key);return this.matchesComparison(n)},t}(ir),ar=function(e){function t(t,n){var r=e.call(this,t,rr.IN,n)||this;return r.value=n,r}return a.__extends(t,e),t.prototype.matches=function(e){return this.value.internalValue.some((function(t){return e.key.isEqual(t.key)}))},t}(ir),sr=function(e){function t(t,n){return e.call(this,t,rr.ARRAY_CONTAINS,n)||this}return a.__extends(t,e),t.prototype.matches=function(e){var t=e.field(this.field);return t instanceof Ht&&t.contains(this.value)},t}(ir),ur=function(e){function t(t,n){var r=e.call(this,t,rr.IN,n)||this;return r.value=n,r}return a.__extends(t,e),t.prototype.matches=function(e){var t=this.value,n=e.field(this.field);return null!==n&&t.contains(n)},t}(ir),cr=function(e){function t(t,n){var r=e.call(this,t,rr.ARRAY_CONTAINS_ANY,n)||this;return r.value=n,r}return a.__extends(t,e),t.prototype.matches=function(e){var t=this,n=e.field(this.field);return n instanceof Ht&&n.internalValue.some((function(e){return t.value.contains(e)}))},t}(ir),lr=function(){function e(e){this.name=e}return e.prototype.toString=function(){return this.name},e.ASCENDING=new e("asc"),e.DESCENDING=new e("desc"),e}(),hr=function(){function e(e,t){this.position=e,this.before=t}return e.prototype.canonicalId=function(){for(var e=this.before?"b:":"a:",t=0,n=this.position;t<n.length;t++){e+=n[t].toString()}return e},e.prototype.sortsBeforeDocument=function(e,t){b(this.position.length<=e.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=e[r],o=this.position[r];if(i.field.isKeyField())b(o instanceof Vt,"Bound has a non-key value where the key path is being used."),n=pe.comparator(o.key,t.key);else{var a=t.field(i.field);b(null!==a,"Field should exist since document matched the orderBy already."),n=o.compareTo(a)}if(i.dir===lr.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},e.prototype.isEqual=function(e){if(null===e)return!1;if(this.before!==e.before||this.position.length!==e.position.length)return!1;for(var t=0;t<this.position.length;t++){var n=this.position[t],r=e.position[t];if(!n.isEqual(r))return!1}return!0},e}(),dr=function(){function e(e,t){this.field=e,void 0===t&&(t=lr.ASCENDING),this.dir=t,this.isKeyOrderBy=e.isKeyField()}return e.prototype.compare=function(e,t){var n=this.isKeyOrderBy?qt.compareByKey(e,t):qt.compareByField(this.field,e,t);switch(this.dir){case lr.ASCENDING:return n;case lr.DESCENDING:return-1*n;default:return y("Unknown direction: "+this.dir)}},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},e.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},e.prototype.isEqual=function(e){return this.dir===e.dir&&this.field.isEqual(e.field)},e}(),pr=new dr(de.keyField(),lr.ASCENDING),fr=new dr(de.keyField(),lr.DESCENDING),mr=function(){function e(){}return e.prototype.setLocalDocumentsView=function(e){this.localDocumentsView=e},e.prototype.getDocumentsMatchingQuery=function(e,t,n,r){var o=this;return b(void 0!==this.localDocumentsView,"setLocalDocumentsView() not called"),t.matchesAllDocuments()?this.executeFullCollectionScan(e,t):n.isEqual(xe.MIN)?this.executeFullCollectionScan(e,t):this.localDocumentsView.getDocuments(e,r).next((function(a){var s=o.applyQuery(t,a);return(t.hasLimitToFirst()||t.hasLimitToLast())&&o.needsRefill(t.limitType,s,r,n)?o.executeFullCollectionScan(e,t):(p()<=i.DEBUG&&m("IndexFreeQueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),t.toString()),o.localDocumentsView.getDocumentsMatchingQuery(e,t,n).next((function(e){return s.forEach((function(t){e=e.insert(t.key,t)})),e})))}))},e.prototype.applyQuery=function(e,t){var n=new Le((function(t,n){return e.docComparator(t,n)}));return t.forEach((function(t,r){r instanceof qt&&e.matches(r)&&(n=n.add(r))})),n},e.prototype.needsRefill=function(e,t,n,r){if(n.size!==t.size)return!0;var i=e===Zn.First?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)},e.prototype.executeFullCollectionScan=function(e,t){return p()<=i.DEBUG&&m("IndexFreeQueryEngine","Using full collection scan to execute query: %s",t.toString()),this.localDocumentsView.getDocumentsMatchingQuery(e,t,xe.MIN)},e}(),gr=function(){function e(e,t,n){this.remoteDocumentCache=e,this.mutationQueue=t,this.indexManager=n}return e.prototype.getDocument=function(e,t){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,t).next((function(r){return n.getDocumentInternal(e,t,r)}))},e.prototype.getDocumentInternal=function(e,t,n){return this.remoteDocumentCache.getEntry(e,t).next((function(e){for(var r=0,i=n;r<i.length;r++){e=i[r].applyToLocalView(t,e)}return e}))},e.prototype.applyLocalMutationsToDocuments=function(e,t,n){var r=Re();return t.forEach((function(e,t){for(var i=0,o=n;i<o.length;i++){t=o[i].applyToLocalView(e,t)}r=r.insert(e,t)})),r},e.prototype.getDocuments=function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next((function(t){return n.getLocalViewOfDocuments(e,t)}))},e.prototype.getLocalViewOfDocuments=function(e,t){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((function(r){var i=n.applyLocalMutationsToDocuments(e,t,r),o=Me();return i.forEach((function(e,t){t||(t=new Kt(e,xe.forDeletedDoc())),o=o.insert(e,t)})),o}))},e.prototype.getDocumentsMatchingQuery=function(e,t,n){return t.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(e,t.path):t.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)},e.prototype.getDocumentsMatchingDocumentQuery=function(e,t){return this.getDocument(e,new pe(t)).next((function(e){var t=Fe();return e instanceof qt&&(t=t.insert(e.key,e)),t}))},e.prototype.getDocumentsMatchingCollectionGroupQuery=function(e,t,n){var r=this;b(t.path.isEmpty(),"Currently we only support collection group queries at the root.");var i=t.collectionGroup,o=Fe();return this.indexManager.getCollectionParents(e,i).next((function(a){return Ke.forEach(a,(function(a){var s=t.asCollectionQueryAtPath(a.child(i));return r.getDocumentsMatchingCollectionQuery(e,s,n).next((function(e){e.forEach((function(e,t){o=o.insert(e,t)}))}))})).next((function(){return o}))}))},e.prototype.getDocumentsMatchingCollectionQuery=function(e,t,n){var r,i,o=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n).next((function(n){return r=n,o.mutationQueue.getAllMutationBatchesAffectingQuery(e,t)})).next((function(t){return i=t,o.addMissingBaseDocuments(e,i,r).next((function(e){r=e;for(var t=0,n=i;t<n.length;t++)for(var o=n[t],a=0,s=o.mutations;a<s.length;a++){var u=s[a],c=u.key,l=r.get(c),h=u.applyToLocalView(l,l,o.localWriteTime);r=h instanceof qt?r.insert(c,h):r.remove(c)}}))})).next((function(){return r.forEach((function(e,n){t.matches(n)||(r=r.remove(e))})),r}))},e.prototype.addMissingBaseDocuments=function(e,t,n){for(var r=We(),i=0,o=t;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof Et&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(e,r).next((function(e){return e.forEach((function(e,t){null!==t&&t instanceof qt&&(c=c.insert(e,t))})),c}))},e}(),vr=function(){function e(){this.refsByKey=new Le(yr.compareByKey),this.refsByTarget=new Le(yr.compareByTargetId)}return e.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},e.prototype.addReference=function(e,t){var n=new yr(e,t);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},e.prototype.addReferences=function(e,t){var n=this;e.forEach((function(e){return n.addReference(e,t)}))},e.prototype.removeReference=function(e,t){this.removeRef(new yr(e,t))},e.prototype.removeReferences=function(e,t){var n=this;e.forEach((function(e){return n.removeReference(e,t)}))},e.prototype.removeReferencesForId=function(e){var t=this,n=pe.EMPTY,r=new yr(n,e),i=new yr(n,e+1),o=[];return this.refsByTarget.forEachInRange([r,i],(function(e){t.removeRef(e),o.push(e.key)})),o},e.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach((function(t){return e.removeRef(t)}))},e.prototype.removeRef=function(e){this.refsByKey=this.refsByKey.delete(e),this.refsByTarget=this.refsByTarget.delete(e)},e.prototype.referencesForId=function(e){var t=pe.EMPTY,n=new yr(t,e),r=new yr(t,e+1),i=We();return this.refsByTarget.forEachInRange([n,r],(function(e){i=i.add(e.key)})),i},e.prototype.containsKey=function(e){var t=new yr(e,0),n=this.refsByKey.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)},e}(),yr=function(){function e(e,t){this.key=e,this.targetOrBatchId=t}return e.compareByKey=function(e,t){return pe.comparator(e.key,t.key)||X(e.targetOrBatchId,t.targetOrBatchId)},e.compareByTargetId=function(e,t){return X(e.targetOrBatchId,t.targetOrBatchId)||pe.comparator(e.key,t.key)},e}(),br=function(){function e(e,t,n){this.persistence=e,this.queryEngine=t,this.localViewReferences=new vr,this.targetDataByTarget=new Ie(X),this.targetIdByTarget=new Qt((function(e){return e.canonicalId()})),this.lastDocumentChangeReadTime=xe.MIN,b(e.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=e.getMutationQueue(n),this.remoteDocuments=e.getRemoteDocumentCache(),this.targetCache=e.getTargetCache(),this.localDocuments=new gr(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager()),this.queryEngine.setLocalDocumentsView(this.localDocuments)}return e.prototype.start=function(){return this.synchronizeLastDocumentChangeReadTime()},e.prototype.handleUserChange=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r,i=this;return a.__generator(this,(function(o){switch(o.label){case 0:return t=this.mutationQueue,n=this.localDocuments,[4,this.persistence.runTransaction("Handle user change","readonly-idempotent",(function(r){var o;return i.mutationQueue.getAllMutationBatches(r).next((function(a){return o=a,t=i.persistence.getMutationQueue(e),n=new gr(i.remoteDocuments,t,i.persistence.getIndexManager()),t.getAllMutationBatches(r)})).next((function(e){for(var t=[],i=[],a=We(),s=0,u=o;s<u.length;s++){var c=u[s];t.push(c.batchId);for(var l=0,h=c.mutations;l<h.length;l++){var d=h[l];a=a.add(d.key)}}for(var p=0,f=e;p<f.length;p++){c=f[p];i.push(c.batchId);for(var m=0,g=c.mutations;m<g.length;m++){d=g[m];a=a.add(d.key)}}return n.getDocuments(r,a).next((function(e){return{affectedDocuments:e,removedBatchIds:t,addedBatchIds:i}}))}))}))];case 1:return r=o.sent(),this.mutationQueue=t,this.localDocuments=n,this.queryEngine.setLocalDocumentsView(this.localDocuments),[2,r]}}))}))},e.prototype.localWrite=function(e){var t,n=this,r=Ee.now(),i=e.reduce((function(e,t){return e.add(t.key)}),We());return this.persistence.runTransaction("Locally write mutations","readwrite-idempotent",(function(o){return n.localDocuments.getDocuments(o,i).next((function(i){t=i;for(var a=[],s=0,u=e;s<u.length;s++){var c=u[s],l=c.extractBaseValue(t.get(c.key));null!=l&&a.push(new Et(c.key,l,l.fieldMask(),Ct.exists(!0)))}return n.mutationQueue.addMutationBatch(o,r,a,e)}))})).then((function(e){var n=e.applyToLocalDocumentSet(t);return{batchId:e.batchId,changes:n}}))},e.prototype.lookupMutationDocuments=function(e){var t=this;return this.persistence.runTransaction("Lookup mutation documents","readonly-idempotent",(function(n){return t.mutationQueue.lookupMutationKeys(n,e).next((function(e){return e?t.localDocuments.getDocuments(n,e):Ke.resolve(null)}))}))},e.prototype.acknowledgeBatch=function(e){var t=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary-idempotent",(function(n){var r=e.batch.keys(),i=t.remoteDocuments.newChangeBuffer({trackRemovals:!0});return t.mutationQueue.acknowledgeBatch(n,e.batch,e.streamToken).next((function(){return t.applyWriteToRemoteDocuments(n,e,i)})).next((function(){return i.apply(n)})).next((function(){return t.mutationQueue.performConsistencyCheck(n)})).next((function(){return t.localDocuments.getDocuments(n,r)}))}))},e.prototype.rejectBatch=function(e){var t=this;return this.persistence.runTransaction("Reject batch","readwrite-primary-idempotent",(function(n){var r;return t.mutationQueue.lookupMutationBatch(n,e).next((function(e){return b(null!==e,"Attempt to reject nonexistent batch!"),r=e.keys(),t.mutationQueue.removeMutationBatch(n,e)})).next((function(){return t.mutationQueue.performConsistencyCheck(n)})).next((function(){return t.localDocuments.getDocuments(n,r)}))}))},e.prototype.getHighestUnacknowledgedBatchId=function(){var e=this;return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly-idempotent",(function(t){return e.mutationQueue.getHighestUnacknowledgedBatchId(t)}))},e.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token","readonly-idempotent",(function(t){return e.mutationQueue.getLastStreamToken(t)}))},e.prototype.setLastStreamToken=function(e){var t=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary-idempotent",(function(n){return t.mutationQueue.setLastStreamToken(n,e)}))},e.prototype.getLastRemoteSnapshotVersion=function(){var e=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly-idempotent",(function(t){return e.targetCache.getLastRemoteSnapshotVersion(t)}))},e.prototype.applyRemoteEvent=function(t){var n=this,r=t.snapshotVersion,i=this.targetDataByTarget;return this.persistence.runTransaction("Apply remote event","readwrite-primary-idempotent",(function(o){var a=n.remoteDocuments.newChangeBuffer({trackRemovals:!0});i=n.targetDataByTarget;var s=[];I(t.targetChanges,(function(t,a){var u=i.get(t);if(u){s.push(n.targetCache.removeMatchingKeys(o,a.removedDocuments,t).next((function(){return n.targetCache.addMatchingKeys(o,a.addedDocuments,t)})));var c=a.resumeToken;if(c.length>0){var l=u.withResumeToken(c,r).withSequenceNumber(o.currentSequenceNumber);i=i.insert(t,l),e.shouldPersistTargetData(u,l,a)&&s.push(n.targetCache.updateTargetData(o,l))}}}));var u=Me(),c=We();if(t.documentUpdates.forEach((function(e,t){c=c.add(e)})),s.push(a.getEntries(o,c).next((function(e){t.documentUpdates.forEach((function(i,c){var l=e.get(i);c instanceof Kt&&c.version.isEqual(xe.MIN)?(a.removeEntry(i,r),u=u.insert(i,c)):null==l||c.version.compareTo(l.version)>0||0===c.version.compareTo(l.version)&&l.hasPendingWrites?(b(!xe.MIN.isEqual(r),"Cannot add a document when the remote version is zero"),a.addEntry(c,r),u=u.insert(i,c)):m("LocalStore","Ignoring outdated watch update for ",i,". Current version:",l.version," Watch version:",c.version),t.resolvedLimboDocuments.has(i)&&s.push(n.persistence.referenceDelegate.updateLimboDocument(o,i))}))}))),!r.isEqual(xe.MIN)){var l=n.targetCache.getLastRemoteSnapshotVersion(o).next((function(e){return b(r.compareTo(e)>=0,"Watch stream reverted to previous snapshot?? "+r+" < "+e),n.targetCache.setTargetsMetadata(o,o.currentSequenceNumber,r)}));s.push(l)}return Ke.waitFor(s).next((function(){return a.apply(o)})).next((function(){return n.localDocuments.getLocalViewOfDocuments(o,u)}))})).then((function(e){return n.targetDataByTarget=i,e}))},e.shouldPersistTargetData=function(e,t,n){return b(t.resumeToken.length>0,"Attempted to persist target data with no resume token"),0===e.resumeToken.length||(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)},e.prototype.notifyLocalViewChanges=function(e){for(var t=this,n=0,r=e;n<r.length;n++){var i=r[n],o=i.targetId;if(this.localViewReferences.addReferences(i.addedKeys,o),this.localViewReferences.removeReferences(i.removedKeys,o),!i.fromCache){var a=this.targetDataByTarget.get(o);b(null!==a,"Can't set limbo-free snapshot version for unknown target: "+o);var s=a.snapshotVersion,u=a.withLastLimboFreeSnapshotVersion(s);this.targetDataByTarget=this.targetDataByTarget.insert(o,u)}}return this.persistence.runTransaction("notifyLocalViewChanges","readwrite-idempotent",(function(n){return Ke.forEach(e,(function(e){return Ke.forEach(e.removedKeys,(function(e){return t.persistence.referenceDelegate.removeReference(n,e)}))}))}))},e.prototype.nextMutationBatch=function(e){var t=this;return this.persistence.runTransaction("Get next mutation batch","readonly-idempotent",(function(n){return void 0===e&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(n,e)}))},e.prototype.readDocument=function(e){var t=this;return this.persistence.runTransaction("read document","readonly-idempotent",(function(n){return t.localDocuments.getDocument(n,e)}))},e.prototype.allocateTarget=function(e){var t=this;return this.persistence.runTransaction("Allocate target","readwrite-idempotent",(function(n){var r;return t.targetCache.getTargetData(n,e).next((function(i){return i?(r=i,Ke.resolve(r)):t.targetCache.allocateTargetId(n).next((function(i){return r=new kn(e,i,_n.Listen,n.currentSequenceNumber),t.targetCache.addTargetData(n,r).next((function(){return r}))}))}))})).then((function(n){return null===t.targetDataByTarget.get(n.targetId)&&(t.targetDataByTarget=t.targetDataByTarget.insert(n.targetId,n),t.targetIdByTarget.set(e,n.targetId)),n}))},e.prototype.getTargetData=function(e,t){var n=this.targetIdByTarget.get(t);return void 0!==n?Ke.resolve(this.targetDataByTarget.get(n)):this.targetCache.getTargetData(e,t)},e.prototype.releaseTarget=function(e,t){var n=this,r=this.targetDataByTarget.get(e);b(null!==r,"Tried to release nonexistent target: "+e);var i=t?"readwrite-idempotent":"readwrite-primary-idempotent";return this.persistence.runTransaction("Release target",i,(function(i){var o=n.localViewReferences.removeReferencesForId(e);return t?Ke.resolve():Ke.forEach(o,(function(e){return n.persistence.referenceDelegate.removeReference(i,e)})).next((function(){n.persistence.referenceDelegate.removeTarget(i,r)}))})).then((function(){n.targetDataByTarget=n.targetDataByTarget.remove(e),n.targetIdByTarget.delete(r.target)}))},e.prototype.executeQuery=function(e,t){var n=this,r=xe.MIN,i=We();return this.persistence.runTransaction("Execute query","readonly-idempotent",(function(o){return n.getTargetData(o,e.toTarget()).next((function(e){if(e)return r=e.lastLimboFreeSnapshotVersion,n.targetCache.getMatchingKeysForTargetId(o,e.targetId).next((function(e){i=e}))})).next((function(){return n.queryEngine.getDocumentsMatchingQuery(o,e,t?r:xe.MIN,t?i:We())})).next((function(e){return{documents:e,remoteKeys:i}}))}))},e.prototype.remoteDocumentKeys=function(e){var t=this;return this.persistence.runTransaction("Remote document keys","readonly-idempotent",(function(n){return t.targetCache.getMatchingKeysForTargetId(n,e)}))},e.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},e.prototype.removeCachedMutationBatchMetadata=function(e){this.mutationQueue.removeCachedMutationKeys(e)},e.prototype.setNetworkEnabled=function(e){this.persistence.setNetworkEnabled(e)},e.prototype.applyWriteToRemoteDocuments=function(e,t,n){var r=this,i=t.batch,o=i.keys(),a=Ke.resolve();return o.forEach((function(r){a=a.next((function(){return n.getEntry(e,r)})).next((function(e){var o=e,a=t.docVersions.get(r);b(null!==a,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(a)<0)&&((o=i.applyToRemoteDocument(r,o,t))?n.addEntry(o,t.commitVersion):b(!e,"Mutation batch "+i+" applied to document "+e+" resulted in null"))}))})),a.next((function(){return r.mutationQueue.removeMutationBatch(e,i)}))},e.prototype.collectGarbage=function(e){var t=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary-idempotent",(function(n){return e.collect(n,t.targetDataByTarget)}))},e.prototype.getTarget=function(e){var t=this,n=this.targetDataByTarget.get(e);return n?Promise.resolve(n.target):this.persistence.runTransaction("Get target data","readonly-idempotent",(function(n){return t.targetCache.getTargetDataForTarget(n,e).next((function(e){return e?e.target:null}))}))},e.prototype.getNewDocumentChanges=function(){var e=this;return this.persistence.runTransaction("Get new document changes","readonly-idempotent",(function(t){return e.remoteDocuments.getNewDocumentChanges(t,e.lastDocumentChangeReadTime)})).then((function(t){var n=t.changedDocs,r=t.readTime;return e.lastDocumentChangeReadTime=r,n}))},e.prototype.synchronizeLastDocumentChangeReadTime=function(){return a.__awaiter(this,void 0,void 0,(function(){var e,t=this;return a.__generator(this,(function(n){return this.remoteDocuments instanceof Yt?(e=this.remoteDocuments,[2,this.persistence.runTransaction("Synchronize last document change read time","readonly-idempotent",(function(t){return e.getLastDocumentChange(t)})).then((function(e){var n=e.readTime;t.lastDocumentChangeReadTime=n}))]):[2]}))}))},e.RESUME_TOKEN_MAX_AGE_MICROS=3e8,e}(),wr=function(){function e(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=_(),this.batchesByDocumentKey=new Le(yr.compareByKey)}return e.prototype.checkEmpty=function(e){return Ke.resolve(0===this.mutationQueue.length)},e.prototype.acknowledgeBatch=function(e,t,n){var r=t.batchId,i=this.indexOfExistingBatchId(r,"acknowledged");b(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return b(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.lastStreamToken=n,Ke.resolve()},e.prototype.getLastStreamToken=function(e){return Ke.resolve(this.lastStreamToken)},e.prototype.setLastStreamToken=function(e,t){return this.lastStreamToken=t,Ke.resolve()},e.prototype.addMutationBatch=function(e,t,n,r){b(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;(this.nextBatchId++,this.mutationQueue.length>0)&&b(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");var o=new ze(i,t,n,r);this.mutationQueue.push(o);for(var a=0,s=r;a<s.length;a++){var u=s[a];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new yr(u.key,i)),this.indexManager.addToCollectionParentIndex(e,u.key.path.popLast())}return Ke.resolve(o)},e.prototype.lookupMutationBatch=function(e,t){return Ke.resolve(this.findMutationBatch(t))},e.prototype.lookupMutationKeys=function(e,t){var n=this.findMutationBatch(t);return b(null!=n,"Failed to find local mutation batch."),Ke.resolve(n.keys())},e.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=t+1,r=this.indexOfBatchId(n),i=r<0?0:r;return Ke.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},e.prototype.getHighestUnacknowledgedBatchId=function(){return Ke.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},e.prototype.getAllMutationBatches=function(e){return Ke.resolve(this.mutationQueue.slice())},e.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=new yr(t,0),i=new yr(t,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],(function(e){b(t.isEqual(e.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(e.targetOrBatchId);b(null!==r,"Batches in the index must exist in the main table"),o.push(r)})),Ke.resolve(o)},e.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var n=this,r=new Le(X);return t.forEach((function(e){var t=new yr(e,0),i=new yr(e,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([t,i],(function(t){b(e.isEqual(t.key),"For each key, should only iterate over a single key's batches"),r=r.add(t.targetOrBatchId)}))})),Ke.resolve(this.findMutationBatches(r))},e.prototype.getAllMutationBatchesAffectingQuery=function(e,t){b(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var n=t.path,r=n.length+1,i=n;pe.isDocumentKey(i)||(i=i.child(""));var o=new yr(new pe(i),0),a=new Le(X);return this.batchesByDocumentKey.forEachWhile((function(e){var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.targetOrBatchId)),!0)}),o),Ke.resolve(this.findMutationBatches(a))},e.prototype.findMutationBatches=function(e){var t=this,n=[];return e.forEach((function(e){var r=t.findMutationBatch(e);null!==r&&n.push(r)})),n},e.prototype.removeMutationBatch=function(e,t){var n=this;b(0===this.indexOfExistingBatchId(t.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return Ke.forEach(t.mutations,(function(i){var o=new yr(i.key,t.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(e,i.key)})).next((function(){n.batchesByDocumentKey=r}))},e.prototype.removeCachedMutationKeys=function(e){},e.prototype.containsKey=function(e,t){var n=new yr(t,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return Ke.resolve(t.isEqual(r&&r.key))},e.prototype.performConsistencyCheck=function(e){return 0===this.mutationQueue.length&&b(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),Ke.resolve()},e.prototype.indexOfExistingBatchId=function(e,t){var n=this.indexOfBatchId(e);return b(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+t),n},e.prototype.indexOfBatchId=function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId},e.prototype.findMutationBatch=function(e){var t=this.indexOfBatchId(e);if(t<0||t>=this.mutationQueue.length)return null;var n=this.mutationQueue[t];return b(n.batchId===e,"If found batch must match"),n},e}();var _r,Cr=function(){function e(e,t){this.indexManager=e,this.sizer=t,this.docs=new Ie(pe.comparator),this.size=0}return e.prototype.addEntry=function(e,t,n){b(!n.isEqual(xe.MIN),"Cannot add a document with a read time of zero");var r=t.key,i=this.docs.get(r),o=i?i.size:0,a=this.sizer(t);return this.docs=this.docs.insert(r,{maybeDocument:t,size:a,readTime:n}),this.size+=a-o,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())},e.prototype.removeEntry=function(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)},e.prototype.getEntry=function(e,t){var n=this.docs.get(t);return Ke.resolve(n?n.maybeDocument:null)},e.prototype.getEntries=function(e,t){var n=this,r=Re();return t.forEach((function(e){var t=n.docs.get(e);r=r.insert(e,t?t.maybeDocument:null)})),Ke.resolve(r)},e.prototype.getDocumentsMatchingQuery=function(e,t,n){b(!t.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var r=Fe(),i=new pe(t.path.child("")),o=this.docs.getIteratorFrom(i);o.hasNext();){var a=o.getNext(),s=a.key,u=a.value,c=u.maybeDocument,l=u.readTime;if(!t.path.isPrefixOf(s.path))break;l.compareTo(n)<=0||c instanceof qt&&t.matches(c)&&(r=r.insert(c.key,c))}return Ke.resolve(r)},e.prototype.forEachDocumentKey=function(e,t){return Ke.forEach(this.docs,(function(e){return t(e)}))},e.prototype.getNewDocumentChanges=function(e,t){throw new Error("getNewDocumentChanges() is not supported with MemoryPersistence")},e.prototype.newChangeBuffer=function(t){return new e.RemoteDocumentChangeBuffer(this)},e.prototype.getSize=function(e){return Ke.resolve(this.size)},e.RemoteDocumentChangeBuffer=function(e){function t(t){var n=e.call(this)||this;return n.documentCache=t,n}return a.__extends(t,e),t.prototype.applyChanges=function(e){var t=this,n=[];return this.changes.forEach((function(r,i){i?n.push(t.documentCache.addEntry(e,i,t.readTime)):t.documentCache.removeEntry(r)})),Ke.waitFor(n)},t.prototype.getFromCache=function(e,t){return this.documentCache.getEntry(e,t)},t.prototype.getAllFromCache=function(e,t){return this.documentCache.getEntries(e,t)},t}($t),e}(),Tr=function(){function e(e){this.persistence=e,this.targets=new Qt((function(e){return e.canonicalId()})),this.lastRemoteSnapshotVersion=xe.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new vr,this.targetCount=0,this.targetIdGenerator=lt.forTargetCache()}return e.prototype.forEachTarget=function(e,t){return this.targets.forEach((function(e,n){return t(n)})),Ke.resolve()},e.prototype.getLastRemoteSnapshotVersion=function(e){return Ke.resolve(this.lastRemoteSnapshotVersion)},e.prototype.getHighestSequenceNumber=function(e){return Ke.resolve(this.highestSequenceNumber)},e.prototype.allocateTargetId=function(e){var t=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=t,Ke.resolve(t)},e.prototype.setTargetsMetadata=function(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.highestSequenceNumber&&(this.highestSequenceNumber=t),Ke.resolve()},e.prototype.saveTargetData=function(e){this.targets.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.highestTargetId=t),e.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=e.sequenceNumber)},e.prototype.addTargetData=function(e,t){return b(!this.targets.has(t.target),"Adding a target that already exists"),this.saveTargetData(t),this.targetCount+=1,Ke.resolve()},e.prototype.updateTargetData=function(e,t){return b(this.targets.has(t.target),"Updating a non-existent target"),this.saveTargetData(t),Ke.resolve()},e.prototype.removeTargetData=function(e,t){return b(this.targetCount>0,"Removing a target from an empty cache"),b(this.targets.has(t.target),"Removing a non-existent target from the cache"),this.targets.delete(t.target),this.references.removeReferencesForId(t.targetId),this.targetCount-=1,Ke.resolve()},e.prototype.removeTargets=function(e,t,n){var r=this,i=0,o=[];return this.targets.forEach((function(a,s){s.sequenceNumber<=t&&null===n.get(s.targetId)&&(r.targets.delete(a),o.push(r.removeMatchingKeysForTargetId(e,s.targetId)),i++)})),Ke.waitFor(o).next((function(){return i}))},e.prototype.getTargetCount=function(e){return Ke.resolve(this.targetCount)},e.prototype.getTargetData=function(e,t){var n=this.targets.get(t)||null;return Ke.resolve(n)},e.prototype.getTargetDataForTarget=function(e,t){return y("Not yet implemented.")},e.prototype.addMatchingKeys=function(e,t,n){this.references.addReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((function(t){i.push(r.addReference(e,t))})),Ke.waitFor(i)},e.prototype.removeMatchingKeys=function(e,t,n){this.references.removeReferences(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((function(t){i.push(r.removeReference(e,t))})),Ke.waitFor(i)},e.prototype.removeMatchingKeysForTargetId=function(e,t){return this.references.removeReferencesForId(t),Ke.resolve()},e.prototype.getMatchingKeysForTargetId=function(e,t){var n=this.references.referencesForId(t);return Ke.resolve(n)},e.prototype.containsKey=function(e,t){return Ke.resolve(this.references.containsKey(t))},e}(),Sr=function(){function e(e,t){var n=this;this.clientId=e,this.mutationQueues={},this.listenSequence=new ue(0),this._started=!1,this._started=!0,this.referenceDelegate=t(this),this.targetCache=new Tr(this);this.indexManager=new tn,this.remoteDocumentCache=new Cr(this.indexManager,(function(e){return n.referenceDelegate.documentSize(e)}))}return e.createLruPersistence=function(t,n,r){return new e(t,(function(e){return new Ir(e,new An(n),r)}))},e.createEagerPersistence=function(t){return new e(t,(function(e){return new xr(e)}))},e.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(e.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),e.prototype.getActiveClients=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){return[2,[this.clientId]]}))}))},e.prototype.setPrimaryStateListener=function(e){return e(!0)},e.prototype.setDatabaseDeletedListener=function(){},e.prototype.setNetworkEnabled=function(e){},e.prototype.getIndexManager=function(){return this.indexManager},e.prototype.getMutationQueue=function(e){var t=this.mutationQueues[e.toKey()];return t||(t=new wr(this.indexManager,this.referenceDelegate),this.mutationQueues[e.toKey()]=t),t},e.prototype.getTargetCache=function(){return this.targetCache},e.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},e.prototype.runTransaction=function(e,t,n){var r=this;m("MemoryPersistence","Starting transaction:",e);var i=new Er(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next((function(e){return r.referenceDelegate.onTransactionCommitted(i).next((function(){return e}))})).toPromise().then((function(e){return i.raiseOnCommittedEvent(),e}))},e.prototype.mutationQueuesContainKey=function(e,t){return Ke.or((n=this.mutationQueues,r=[],k(n,(function(e,t){return r.push(t)})),r).map((function(n){return function(){return n.containsKey(e,t)}})));var n,r},e}(),Er=function(e){function t(t){var n=e.call(this)||this;return n.currentSequenceNumber=t,n}return a.__extends(t,e),t}(Pn),xr=function(){function e(e){this.persistence=e,this.inMemoryPins=null,this._orphanedDocuments=null}return Object.defineProperty(e.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw y("orphanedDocuments is only valid during a transaction.")},enumerable:!0,configurable:!0}),e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.addReference=function(e,t){return this.orphanedDocuments.delete(t),Ke.resolve()},e.prototype.removeReference=function(e,t){return this.orphanedDocuments.add(t),Ke.resolve()},e.prototype.removeMutationReference=function(e,t){return this.orphanedDocuments.add(t),Ke.resolve()},e.prototype.removeTarget=function(e,t){var n=this,r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next((function(e){e.forEach((function(e){return n.orphanedDocuments.add(e)}))})).next((function(){return r.removeTargetData(e,t)}))},e.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},e.prototype.onTransactionCommitted=function(e){var t=this,n=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ke.forEach(this.orphanedDocuments,(function(r){return t.isReferenced(e,r).next((function(e){e||n.removeEntry(r)}))})).next((function(){return t._orphanedDocuments=null,n.apply(e)}))},e.prototype.updateLimboDocument=function(e,t){var n=this;return this.isReferenced(e,t).next((function(e){e?n.orphanedDocuments.delete(t):n.orphanedDocuments.add(t)}))},e.prototype.documentSize=function(e){return 0},e.prototype.isReferenced=function(e,t){var n=this;return Ke.or([function(){return n.persistence.getTargetCache().containsKey(e,t)},function(){return n.persistence.mutationQueuesContainKey(e,t)},function(){return Ke.resolve(n.inMemoryPins.containsKey(t))}])},e}(),Ir=function(){function e(e,t,n){this.persistence=e,this.serializer=t,this.inMemoryPins=null,this.orphanedSequenceNumbers=new Qt((function(e){return _e(e.path)})),this.garbageCollector=new Rn(this,n)}return e.prototype.onTransactionStarted=function(){},e.prototype.onTransactionCommitted=function(e){return Ke.resolve()},e.prototype.forEachTarget=function(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)},e.prototype.getSequenceNumberCount=function(e){var t=this.orphanedDocumentCount(e);return this.persistence.getTargetCache().getTargetCount(e).next((function(e){return t.next((function(t){return e+t}))}))},e.prototype.orphanedDocumentCount=function(e){var t=0;return this.forEachOrphanedDocumentSequenceNumber(e,(function(e){t++})).next((function(){return t}))},e.prototype.forEachOrphanedDocumentSequenceNumber=function(e,t){var n=this;return Ke.forEach(this.orphanedSequenceNumbers,(function(r,i){return n.isPinned(e,r,i).next((function(e){return e?Ke.resolve():t(i)}))}))},e.prototype.setInMemoryPins=function(e){this.inMemoryPins=e},e.prototype.removeTargets=function(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)},e.prototype.removeOrphanedDocuments=function(e,t){var n=this,r=0,i=this.persistence.getRemoteDocumentCache(),o=i.newChangeBuffer();return i.forEachDocumentKey(e,(function(i){return n.isPinned(e,i,t).next((function(e){e||(r++,o.removeEntry(i))}))})).next((function(){return o.apply(e)})).next((function(){return r}))},e.prototype.removeMutationReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),Ke.resolve()},e.prototype.removeTarget=function(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)},e.prototype.addReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),Ke.resolve()},e.prototype.removeReference=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),Ke.resolve()},e.prototype.updateLimboDocument=function(e,t){return this.orphanedSequenceNumbers.set(t,e.currentSequenceNumber),Ke.resolve()},e.prototype.documentSize=function(e){var t,n=this.serializer.toDbRemoteDocument(e,e.version);if(n.document)t=n.document;else if(n.unknownDocument)t=n.unknownDocument;else{if(!n.noDocument)throw y("Unknown remote document type");t=n.noDocument}return JSON.stringify(t).length},e.prototype.isPinned=function(e,t,n){var r=this;return Ke.or([function(){return r.persistence.mutationQueuesContainKey(e,t)},function(){return Ke.resolve(r.inMemoryPins.containsKey(t))},function(){return r.persistence.getTargetCache().containsKey(e,t)},function(){var e=r.orphanedSequenceNumbers.get(t);return Ke.resolve(void 0!==e&&e>n)}])},e.prototype.getCacheSize=function(e){return this.persistence.getRemoteDocumentCache().getSize(e)},e}(),kr=1e3,Ar=1.5,Nr=6e4,Lr=function(){function e(e,t,n,r,i){void 0===n&&(n=kr),void 0===r&&(r=Ar),void 0===i&&(i=Nr),this.queue=e,this.timerId=t,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return e.prototype.reset=function(){this.currentBaseMs=0},e.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},e.prototype.backoffAndRun=function(e){var t=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&m("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,(function(){return t.lastAttemptTime=Date.now(),e()})),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},e.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},e.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},e}();!function(e){e[e.Initial=0]="Initial",e[e.Starting=1]="Starting",e[e.Open=2]="Open",e[e.Error=3]="Error",e[e.Backoff=4]="Backoff"}(_r||(_r={}));var Dr,Or,Mr=function(){function e(e,t,n,r,i,o){this.queue=e,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=_r.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Lr(e,t)}return e.prototype.isStarted=function(){return this.state===_r.Starting||this.state===_r.Open||this.state===_r.Backoff},e.prototype.isOpen=function(){return this.state===_r.Open},e.prototype.start=function(){this.state!==_r.Error?(b(this.state===_r.Initial,"Already started"),this.auth()):this.performBackoff()},e.prototype.stop=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.isStarted()?[4,this.close(_r.Initial)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.inhibitBackoff=function(){b(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=_r.Initial,this.backoff.reset()},e.prototype.markIdle=function(){var e=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,(function(){return e.handleIdleCloseTimer()})))},e.prototype.sendRequest=function(e){this.cancelIdleCheck(),this.stream.send(e)},e.prototype.handleIdleCloseTimer=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){return this.isOpen()?[2,this.close(_r.Initial)]:[2]}))}))},e.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},e.prototype.close=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(n){switch(n.label){case 0:return b(this.isStarted(),"Only started streams should be closed."),b(e===_r.Error||Xn(t),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,e!==_r.Error?this.backoff.reset():t&&t.code===C.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):t&&t.code===C.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e,[4,this.listener.onClose(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.tearDown=function(){},e.prototype.auth=function(){var e=this;b(this.state===_r.Initial,"Must be in initial state to auth"),this.state=_r.Starting;var t=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then((function(t){e.closeCount===n&&e.startStream(t)}),(function(n){t((function(){var t=new T(C.UNKNOWN,"Fetching auth token failed: "+n.message);return e.handleStreamClose(t)}))}))},e.prototype.startStream=function(e){var t=this;b(this.state===_r.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(e),this.stream.onOpen((function(){n((function(){return b(t.state===_r.Starting,"Expected stream to be in state Starting, but was "+t.state),t.state=_r.Open,t.listener.onOpen()}))})),this.stream.onClose((function(e){n((function(){return t.handleStreamClose(e)}))})),this.stream.onMessage((function(e){n((function(){return t.onMessage(e)}))}))},e.prototype.performBackoff=function(){var e=this;b(this.state===_r.Error,"Should only perform backoff when in Error state"),this.state=_r.Backoff,this.backoff.backoffAndRun((function(){return a.__awaiter(e,void 0,void 0,(function(){return a.__generator(this,(function(e){return b(this.state===_r.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=_r.Initial,this.start(),b(this.isStarted(),"PersistentStream should have started"),[2]}))}))}))},e.prototype.handleStreamClose=function(e){return b(this.isStarted(),"Can't handle server close on non-started stream"),m("PersistentStream","close with error: "+e),this.stream=null,this.close(_r.Error,e)},e.prototype.getCloseGuardedDispatcher=function(e){var t=this;return function(n){t.queue.enqueueAndForget((function(){return t.closeCount===e?n():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}},e}(),Rr=function(e){function t(t,n,r,i,o){var a=e.call(this,t,ne.ListenStreamConnectionBackoff,ne.ListenStreamIdle,n,r,o)||this;return a.serializer=i,a}return a.__extends(t,e),t.prototype.startRpc=function(e){return this.connection.openStream("Listen",e)},t.prototype.onMessage=function(e){this.backoff.reset();var t=this.serializer.fromWatchChange(e),n=this.serializer.versionFromListenResponse(e);return this.listener.onWatchChange(t,n)},t.prototype.watch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.addTarget=this.serializer.toTarget(e);var n=this.serializer.toListenRequestLabels(e);n&&(t.labels=n),this.sendRequest(t)},t.prototype.unwatch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.removeTarget=e,this.sendRequest(t)},t}(Mr),Pr=function(e){function t(t,n,r,i,o){var a=e.call(this,t,ne.WriteStreamConnectionBackoff,ne.WriteStreamIdle,n,r,o)||this;return a.serializer=i,a.handshakeComplete_=!1,a.lastStreamToken=_(),a}return a.__extends(t,e),Object.defineProperty(t.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),t.prototype.start=function(){this.handshakeComplete_=!1,e.prototype.start.call(this)},t.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},t.prototype.startRpc=function(e){return this.connection.openStream("Write",e)},t.prototype.onMessage=function(e){if(b(!!e.streamToken,"Got a write response without a stream token"),this.lastStreamToken=e.streamToken,this.handshakeComplete_){this.backoff.reset();var t=this.serializer.fromWriteResults(e.writeResults,e.commitTime),n=this.serializer.fromVersion(e.commitTime);return this.listener.onMutationResult(n,t)}return b(!e.writeResults||0===e.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},t.prototype.writeHandshake=function(){b(this.isOpen(),"Writing handshake requires an opened stream"),b(!this.handshakeComplete_,"Handshake already completed");var e={};e.database=this.serializer.encodedDatabaseId,this.sendRequest(e)},t.prototype.writeMutations=function(e){var t=this;b(this.isOpen(),"Writing mutations requires an opened stream"),b(this.handshakeComplete_,"Handshake must be complete before writing mutations"),b(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:e.map((function(e){return t.serializer.toMutation(e)}))};this.sendRequest(n)},t}(Mr),Fr=function(){function e(e,t,n,r){this.queue=e,this.connection=t,this.credentials=n,this.serializer=r}return e.prototype.newPersistentWriteStream=function(e){return new Pr(this.queue,this.connection,this.credentials,this.serializer,e)},e.prototype.newPersistentWatchStream=function(e){return new Rr(this.queue,this.connection,this.credentials,this.serializer,e)},e.prototype.commit=function(e){var t=this,n={database:this.serializer.encodedDatabaseId,writes:e.map((function(e){return t.serializer.toMutation(e)}))};return this.invokeRPC("Commit",n).then((function(e){return t.serializer.fromWriteResults(e.writeResults,e.commitTime)}))},e.prototype.lookup=function(e){var t=this,n={database:this.serializer.encodedDatabaseId,documents:e.map((function(e){return t.serializer.toName(e)}))};return this.invokeStreamingRPC("BatchGetDocuments",n).then((function(n){var r=Me();n.forEach((function(e){var n=t.serializer.fromMaybeDocument(e);r=r.insert(n.key,n)}));var i=[];return e.forEach((function(e){var t=r.get(e);b(!!t,"Missing entity in write response for "+e),i.push(t)})),i}))},e.prototype.invokeRPC=function(e,t){var n=this;return this.credentials.getToken().then((function(r){return n.connection.invokeRPC(e,t,r)})).catch((function(e){throw e.code===C.UNAUTHENTICATED&&n.credentials.invalidateToken(),e}))},e.prototype.invokeStreamingRPC=function(e,t){var n=this;return this.credentials.getToken().then((function(r){return n.connection.invokeStreamingRPC(e,t,r)})).catch((function(e){throw e.code===C.UNAUTHENTICATED&&n.credentials.invalidateToken(),e}))},e}(),jr=function(){function e(e){this.datastore=e,this.readVersions=Be(),this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}return e.prototype.lookup=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n=this;return a.__generator(this,(function(r){switch(r.label){case 0:if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new T(C.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,this.datastore.lookup(e)];case 1:return(t=r.sent()).forEach((function(e){e instanceof Kt||e instanceof qt?n.recordVersion(e):y("Document in a transaction was a "+e.constructor.name)})),[2,t]}}))}))},e.prototype.set=function(e,t){this.write(t.toMutations(e,this.precondition(e))),this.writtenDocs.add(e)},e.prototype.update=function(e,t){try{this.write(t.toMutations(e,this.preconditionForUpdate(e)))}catch(n){this.lastWriteError=n}this.writtenDocs.add(e)},e.prototype.delete=function(e){this.write([new It(e,this.precondition(e))]),this.writtenDocs.add(e)},e.prototype.commit=function(){return a.__awaiter(this,void 0,void 0,(function(){var e;return a.__generator(this,(function(t){switch(t.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;if(e=this.readVersions,this.mutations.forEach((function(t){e=e.remove(t.key)})),!e.isEmpty())throw new T(C.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return[4,this.datastore.commit(this.mutations)];case 1:return t.sent(),this.committed=!0,[2]}}))}))},e.prototype.recordVersion=function(e){var t;if(e instanceof qt)t=e.version;else{if(!(e instanceof Kt))throw y("Document in a transaction was a "+e.constructor.name);t=xe.forDeletedDoc()}var n=this.readVersions.get(e.key);if(null!==n){if(!t.isEqual(n))throw new T(C.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(e.key,t)},e.prototype.precondition=function(e){var t=this.readVersions.get(e);return!this.writtenDocs.has(e)&&t?Ct.updateTime(t):Ct.NONE},e.prototype.preconditionForUpdate=function(e){var t=this.readVersions.get(e);if(!this.writtenDocs.has(e)&&t){if(t.isEqual(xe.forDeletedDoc()))throw new T(C.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ct.updateTime(t)}return Ct.exists(!0)},e.prototype.write=function(e){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(e)},e.prototype.ensureCommitNotCalled=function(){b(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},e}();!function(e){e[e.Unknown=0]="Unknown",e[e.Online=1]="Online",e[e.Offline=2]="Offline"}(Dr||(Dr={})),function(e){e[e.RemoteStore=0]="RemoteStore",e[e.SharedClientState=1]="SharedClientState"}(Or||(Or={}));var Br,Vr=function(){function e(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state=Dr.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return e.prototype.handleWatchStreamStart=function(){var e=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Dr.Unknown),b(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(ne.OnlineStateTimeout,1e4,(function(){return e.onlineStateTimer=null,b(e.state===Dr.Unknown,"Timer should be canceled if we transitioned to a different state."),e.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),e.setAndBroadcast(Dr.Offline),Promise.resolve()})))},e.prototype.handleWatchStreamFailure=function(e){this.state===Dr.Online?(this.setAndBroadcast(Dr.Unknown),b(0===this.watchStreamFailures,"watchStreamFailures must be 0"),b(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+e.toString()),this.setAndBroadcast(Dr.Offline)))},e.prototype.set=function(e){this.clearOnlineStateTimer(),this.watchStreamFailures=0,e===Dr.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(e)},e.prototype.setAndBroadcast=function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))},e.prototype.logClientOfflineWarningIfNecessary=function(e){var t="Could not reach Cloud Firestore backend. "+e+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(g(t),this.shouldWarnClientIsOffline=!1):m("OnlineStateTracker",t)},e.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},e}();function Wr(e){switch(e){case C.OK:return y("Treated status OK as error");case C.CANCELLED:case C.UNKNOWN:case C.DEADLINE_EXCEEDED:case C.RESOURCE_EXHAUSTED:case C.INTERNAL:case C.UNAVAILABLE:case C.UNAUTHENTICATED:return!1;case C.INVALID_ARGUMENT:case C.NOT_FOUND:case C.ALREADY_EXISTS:case C.PERMISSION_DENIED:case C.FAILED_PRECONDITION:case C.ABORTED:case C.OUT_OF_RANGE:case C.UNIMPLEMENTED:case C.DATA_LOSS:return!0;default:return y("Unknown status code: "+e)}}function Ur(e){if(void 0===e)return g("GRPC error has no .code"),C.UNKNOWN;switch(e){case Br.OK:return C.OK;case Br.CANCELLED:return C.CANCELLED;case Br.UNKNOWN:return C.UNKNOWN;case Br.DEADLINE_EXCEEDED:return C.DEADLINE_EXCEEDED;case Br.RESOURCE_EXHAUSTED:return C.RESOURCE_EXHAUSTED;case Br.INTERNAL:return C.INTERNAL;case Br.UNAVAILABLE:return C.UNAVAILABLE;case Br.UNAUTHENTICATED:return C.UNAUTHENTICATED;case Br.INVALID_ARGUMENT:return C.INVALID_ARGUMENT;case Br.NOT_FOUND:return C.NOT_FOUND;case Br.ALREADY_EXISTS:return C.ALREADY_EXISTS;case Br.PERMISSION_DENIED:return C.PERMISSION_DENIED;case Br.FAILED_PRECONDITION:return C.FAILED_PRECONDITION;case Br.ABORTED:return C.ABORTED;case Br.OUT_OF_RANGE:return C.OUT_OF_RANGE;case Br.UNIMPLEMENTED:return C.UNIMPLEMENTED;case Br.DATA_LOSS:return C.DATA_LOSS;default:return y("Unknown status code: "+e)}}function Hr(e){if(void 0===e)return Br.OK;switch(e){case C.OK:return Br.OK;case C.CANCELLED:return Br.CANCELLED;case C.UNKNOWN:return Br.UNKNOWN;case C.DEADLINE_EXCEEDED:return Br.DEADLINE_EXCEEDED;case C.RESOURCE_EXHAUSTED:return Br.RESOURCE_EXHAUSTED;case C.INTERNAL:return Br.INTERNAL;case C.UNAVAILABLE:return Br.UNAVAILABLE;case C.UNAUTHENTICATED:return Br.UNAUTHENTICATED;case C.INVALID_ARGUMENT:return Br.INVALID_ARGUMENT;case C.NOT_FOUND:return Br.NOT_FOUND;case C.ALREADY_EXISTS:return Br.ALREADY_EXISTS;case C.PERMISSION_DENIED:return Br.PERMISSION_DENIED;case C.FAILED_PRECONDITION:return Br.FAILED_PRECONDITION;case C.ABORTED:return Br.ABORTED;case C.OUT_OF_RANGE:return Br.OUT_OF_RANGE;case C.UNIMPLEMENTED:return Br.UNIMPLEMENTED;case C.DATA_LOSS:return Br.DATA_LOSS;default:return y("Unknown status code: "+e)}}!function(e){e[e.OK=0]="OK",e[e.CANCELLED=1]="CANCELLED",e[e.UNKNOWN=2]="UNKNOWN",e[e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",e[e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",e[e.NOT_FOUND=5]="NOT_FOUND",e[e.ALREADY_EXISTS=6]="ALREADY_EXISTS",e[e.PERMISSION_DENIED=7]="PERMISSION_DENIED",e[e.UNAUTHENTICATED=16]="UNAUTHENTICATED",e[e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",e[e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",e[e.ABORTED=10]="ABORTED",e[e.OUT_OF_RANGE=11]="OUT_OF_RANGE",e[e.UNIMPLEMENTED=12]="UNIMPLEMENTED",e[e.INTERNAL=13]="INTERNAL",e[e.UNAVAILABLE=14]="UNAVAILABLE",e[e.DATA_LOSS=15]="DATA_LOSS"}(Br||(Br={}));var zr,qr,Kr=function(){function e(e){this.comparator=e?function(t,n){return e(t,n)||pe.comparator(t.key,n.key)}:function(e,t){return pe.comparator(e.key,t.key)},this.keyedMap=Fe(),this.sortedSet=new Ie(this.comparator)}return e.emptySet=function(t){return new e(t.comparator)},e.prototype.has=function(e){return null!=this.keyedMap.get(e)},e.prototype.get=function(e){return this.keyedMap.get(e)},e.prototype.first=function(){return this.sortedSet.minKey()},e.prototype.last=function(){return this.sortedSet.maxKey()},e.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},e.prototype.indexOf=function(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(e.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){this.sortedSet.inorderTraversal((function(t,n){return e(t),!1}))},e.prototype.add=function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))},e.prototype.delete=function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this},e.prototype.isEqual=function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},e.prototype.toString=function(){var e=[];return this.forEach((function(t){e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},e.prototype.copy=function(t,n){var r=new e;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=n,r},e}();!function(e){e[e.Added=0]="Added",e[e.Removed=1]="Removed",e[e.Modified=2]="Modified",e[e.Metadata=3]="Metadata"}(zr||(zr={})),function(e){e[e.Local=0]="Local",e[e.Synced=1]="Synced"}(qr||(qr={}));var Gr,Qr=function(){function e(){this.changeMap=new Ie(pe.comparator)}return e.prototype.track=function(e){var t=e.doc.key,n=this.changeMap.get(t);n?e.type!==zr.Added&&n.type===zr.Metadata?this.changeMap=this.changeMap.insert(t,e):e.type===zr.Metadata&&n.type!==zr.Removed?this.changeMap=this.changeMap.insert(t,{type:n.type,doc:e.doc}):e.type===zr.Modified&&n.type===zr.Modified?this.changeMap=this.changeMap.insert(t,{type:zr.Modified,doc:e.doc}):e.type===zr.Modified&&n.type===zr.Added?this.changeMap=this.changeMap.insert(t,{type:zr.Added,doc:e.doc}):e.type===zr.Removed&&n.type===zr.Added?this.changeMap=this.changeMap.remove(t):e.type===zr.Removed&&n.type===zr.Modified?this.changeMap=this.changeMap.insert(t,{type:zr.Removed,doc:n.doc}):e.type===zr.Added&&n.type===zr.Removed?this.changeMap=this.changeMap.insert(t,{type:zr.Modified,doc:e.doc}):y("unsupported combination of changes: "+JSON.stringify(e)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(t,e)},e.prototype.getChanges=function(){var e=[];return this.changeMap.inorderTraversal((function(t,n){e.push(n)})),e},e}(),$r=function(){function e(e,t,n,r,i,o,a,s){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}return e.fromInitialDocuments=function(t,n,r,i){var o=[];return n.forEach((function(e){o.push({type:zr.Added,doc:e})})),new e(t,n,Kr.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&this.query.isEqual(e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0},e}(),Yr=function(){function e(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return e.createSynthesizedRemoteEventForCurrentChange=function(t,n){var r,i=((r={})[t]=Xr.createSynthesizedTargetChangeForCurrentChange(t,n),r);return new e(xe.MIN,i,He(),Me(),We())},e}(),Xr=function(){function e(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return e.createSynthesizedTargetChangeForCurrentChange=function(t,n){return new e(_(),n,We(),We(),We())},e}(),Jr=function(e,t,n,r){this.updatedTargetIds=e,this.removedTargetIds=t,this.key=n,this.newDoc=r},Zr=function(e,t){this.targetId=e,this.existenceFilter=t};!function(e){e[e.NoChange=0]="NoChange",e[e.Added=1]="Added",e[e.Removed=2]="Removed",e[e.Current=3]="Current",e[e.Reset=4]="Reset"}(Gr||(Gr={}));var ei=function(e,t,n,r){void 0===n&&(n=_()),void 0===r&&(r=null),this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r},ti=function(){function e(){this.pendingResponses=0,this.documentChanges=ii(),this._resumeToken=_(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),e.prototype.updateResumeToken=function(e){e.length>0&&(this._hasPendingChanges=!0,this._resumeToken=e)},e.prototype.toTargetChange=function(){var e=We(),t=We(),n=We();return this.documentChanges.forEach((function(r,i){switch(i){case zr.Added:e=e.add(r);break;case zr.Modified:t=t.add(r);break;case zr.Removed:n=n.add(r);break;default:y("Encountered invalid change type: "+i)}})),new Xr(this._resumeToken,this._current,e,t,n)},e.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=ii()},e.prototype.addDocumentChange=function(e,t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(e,t)},e.prototype.removeDocumentChange=function(e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(e)},e.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},e.prototype.recordTargetResponse=function(){this.pendingResponses-=1},e.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},e}(),ni=function(){function e(e){this.metadataProvider=e,this.targetStates={},this.pendingDocumentUpdates=Me(),this.pendingDocumentTargetMapping=ri(),this.pendingTargetResets=new Le(X)}return e.prototype.handleDocumentChange=function(e){for(var t=0,n=e.updatedTargetIds;t<n.length;t++){var r=n[t];e.newDoc instanceof qt?this.addDocumentToTarget(r,e.newDoc):e.newDoc instanceof Kt&&this.removeDocumentFromTarget(r,e.key,e.newDoc)}for(var i=0,o=e.removedTargetIds;i<o.length;i++){r=o[i];this.removeDocumentFromTarget(r,e.key,e.newDoc)}},e.prototype.handleTargetChange=function(e){var t=this;this.forEachTarget(e,(function(n){var r=t.ensureTargetState(n);switch(e.state){case Gr.NoChange:t.isActiveTarget(n)&&r.updateResumeToken(e.resumeToken);break;case Gr.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(e.resumeToken);break;case Gr.Removed:r.recordTargetResponse(),r.isPending||t.removeTarget(n),b(!e.cause,"WatchChangeAggregator does not handle errored targets");break;case Gr.Current:t.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(e.resumeToken));break;case Gr.Reset:t.isActiveTarget(n)&&(t.resetTarget(n),r.updateResumeToken(e.resumeToken));break;default:y("Unknown target watch change state: "+e.state)}}))},e.prototype.forEachTarget=function(e,t){e.targetIds.length>0?e.targetIds.forEach(t):I(this.targetStates,t)},e.prototype.handleExistenceFilter=function(e){var t=e.targetId,n=e.existenceFilter.count,r=this.targetDataForActiveTarget(t);if(r){var i=r.target;if(i.isDocumentQuery())if(0===n){var o=new pe(i.path);this.removeDocumentFromTarget(t,o,new Kt(o,xe.forDeletedDoc()))}else b(1===n,"Single document existence filter with count: "+n);else this.getCurrentDocumentCountForTarget(t)!==n&&(this.resetTarget(t),this.pendingTargetResets=this.pendingTargetResets.add(t))}},e.prototype.createRemoteEvent=function(e){var t=this,n={};I(this.targetStates,(function(r,i){var o=t.targetDataForActiveTarget(r);if(o){if(i.current&&o.target.isDocumentQuery()){var a=new pe(o.target.path);null!==t.pendingDocumentUpdates.get(a)||t.targetContainsDocument(r,a)||t.removeDocumentFromTarget(r,a,new Kt(a,e))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}}));var r=We();this.pendingDocumentTargetMapping.forEach((function(e,n){var i=!0;n.forEachWhile((function(e){var n=t.targetDataForActiveTarget(e);return!n||n.purpose===_n.LimboResolution||(i=!1,!1)})),i&&(r=r.add(e))}));var i=new Yr(e,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=Me(),this.pendingDocumentTargetMapping=ri(),this.pendingTargetResets=new Le(X),i},e.prototype.addDocumentToTarget=function(e,t){if(this.isActiveTarget(e)){var n=this.targetContainsDocument(e,t.key)?zr.Modified:zr.Added;this.ensureTargetState(e).addDocumentChange(t.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t.key,t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t.key,this.ensureDocumentTargetMapping(t.key).add(e))}},e.prototype.removeDocumentFromTarget=function(e,t,n){if(this.isActiveTarget(e)){var r=this.ensureTargetState(e);this.targetContainsDocument(e,t)?r.addDocumentChange(t,zr.Removed):r.removeDocumentChange(t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,this.ensureDocumentTargetMapping(t).delete(e)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t,n))}},e.prototype.removeTarget=function(e){delete this.targetStates[e]},e.prototype.getCurrentDocumentCountForTarget=function(e){var t=this.ensureTargetState(e).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size},e.prototype.recordPendingTargetRequest=function(e){this.ensureTargetState(e).recordPendingTargetRequest()},e.prototype.ensureTargetState=function(e){return this.targetStates[e]||(this.targetStates[e]=new ti),this.targetStates[e]},e.prototype.ensureDocumentTargetMapping=function(e){var t=this.pendingDocumentTargetMapping.get(e);return t||(t=new Le(X),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,t)),t},e.prototype.isActiveTarget=function(e){var t=null!==this.targetDataForActiveTarget(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t},e.prototype.targetDataForActiveTarget=function(e){var t=this.targetStates[e];return t&&t.isPending?null:this.metadataProvider.getTargetDataForTarget(e)},e.prototype.resetTarget=function(e){var t=this;b(!this.targetStates[e].isPending,"Should only reset active targets"),this.targetStates[e]=new ti,this.metadataProvider.getRemoteKeysForTarget(e).forEach((function(n){t.removeDocumentFromTarget(e,n,null)}))},e.prototype.targetContainsDocument=function(e,t){return this.metadataProvider.getRemoteKeysForTarget(e).has(t)},e}();function ri(){return new Ie(pe.comparator)}function ii(){return new Ie(pe.comparator)}var oi="RemoteStore",ai=function(){function e(e,t,n,r,i){var o=this;this.localStore=e,this.datastore=t,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=i,this.connectivityMonitor.addCallback((function(e){n.enqueueAndForget((function(){return a.__awaiter(o,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.canUseNetwork()?(m(oi,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}))})),this.onlineStateTracker=new Vr(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return e.prototype.start=function(){return this.enableNetwork()},e.prototype.enableNetwork=function(){return a.__awaiter(this,void 0,void 0,(function(){var e;return a.__generator(this,(function(t){switch(t.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(e=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return e.lastStreamToken=t.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Dr.Unknown),[4,this.fillWritePipeline()];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},e.prototype.disableNetwork=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Dr.Offline),[2]}}))}))},e.prototype.disableNetworkInternal=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return[4,this.writeStream.stop()];case 1:return e.sent(),[4,this.watchStream.stop()];case 2:return e.sent(),this.writePipeline.length>0&&(m(oi,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}}))}))},e.prototype.shutdown=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return m(oi,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(Dr.Unknown),[2]}}))}))},e.prototype.listen=function(e){E(this.listenTargets,e.targetId)||(this.listenTargets[e.targetId]=e,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(e))},e.prototype.unlisten=function(e){b(E(this.listenTargets,e),"unlisten called on target no currently watched: "+e),delete this.listenTargets[e],this.watchStream.isOpen()&&this.sendUnwatchRequest(e),A(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Dr.Unknown))},e.prototype.getTargetDataForTarget=function(e){return this.listenTargets[e]||null},e.prototype.getRemoteKeysForTarget=function(e){return this.syncEngine.getRemoteKeysForTarget(e)},e.prototype.sendWatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e.targetId),this.watchStream.watch(e)},e.prototype.sendUnwatchRequest=function(e){this.watchChangeAggregator.recordPendingTargetRequest(e),this.watchStream.unwatch(e)},e.prototype.startWatchStream=function(){b(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new ni(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},e.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!A(this.listenTargets)},e.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},e.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},e.prototype.onWatchStreamOpen=function(){return a.__awaiter(this,void 0,void 0,(function(){var e=this;return a.__generator(this,(function(t){return I(this.listenTargets,(function(t,n){e.sendWatchRequest(n)})),[2]}))}))},e.prototype.onWatchStreamClose=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){return void 0===e&&b(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(e),this.startWatchStream()):this.onlineStateTracker.set(Dr.Unknown),[2]}))}))},e.prototype.onWatchStreamChange=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n;return a.__generator(this,(function(r){switch(r.label){case 0:return this.onlineStateTracker.set(Dr.Online),e instanceof ei&&e.state===Gr.Removed&&e.cause?[2,this.handleTargetError(e)]:(e instanceof Jr?this.watchChangeAggregator.handleDocumentChange(e):e instanceof Zr?this.watchChangeAggregator.handleExistenceFilter(e):(b(e instanceof ei,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(e)),t.isEqual(xe.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),t.compareTo(n)>=0?[4,this.raiseWatchSnapshot(t)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},e.prototype.raiseWatchSnapshot=function(e){var t=this;b(!e.isEqual(xe.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(e);return I(n.targetChanges,(function(n,r){if(r.resumeToken.length>0){var i=t.listenTargets[n];i&&(t.listenTargets[n]=i.withResumeToken(r.resumeToken,e))}})),n.targetMismatches.forEach((function(e){var n=t.listenTargets[e];if(n){t.listenTargets[e]=n.withResumeToken(_(),n.snapshotVersion),t.sendUnwatchRequest(e);var r=new kn(n.target,e,_n.ExistenceFilterMismatch,n.sequenceNumber);t.sendWatchRequest(r)}})),this.syncEngine.applyRemoteEvent(n)},e.prototype.handleTargetError=function(e){var t=this;b(!!e.cause,"Handling target error without a cause");var n=e.cause,r=Promise.resolve();return e.targetIds.forEach((function(e){r=r.then((function(){return a.__awaiter(t,void 0,void 0,(function(){return a.__generator(this,(function(t){return E(this.listenTargets,e)?(delete this.listenTargets[e],this.watchChangeAggregator.removeTarget(e),[2,this.syncEngine.rejectListen(e,n)]):[2]}))}))}))})),r},e.prototype.fillWritePipeline=function(){return a.__awaiter(this,void 0,void 0,(function(){var e,t;return a.__generator(this,(function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(e=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(e)]):[3,4];case 1:return null!==(t=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(t),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}}))}))},e.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},e.prototype.outstandingWrites=function(){return this.writePipeline.length},e.prototype.addToWritePipeline=function(e){b(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(e),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(e.mutations)},e.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},e.prototype.startWriteStream=function(){b(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},e.prototype.onWriteStreamOpen=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){return this.writeStream.writeHandshake(),[2]}))}))},e.prototype.onWriteHandshakeComplete=function(){var e=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then((function(){for(var t=0,n=e.writePipeline;t<n.length;t++){var r=n[t];e.writeStream.writeMutations(r.mutations)}})).catch(Un)},e.prototype.onMutationResult=function(e,t){var n=this;b(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=qe.from(r,e,t,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then((function(){return n.fillWritePipeline()}))},e.prototype.onWriteStreamClose=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t=this;return a.__generator(this,(function(n){return void 0===e&&b(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),e&&this.writePipeline.length>0?(void 0,[2,(this.writeStream.handshakeComplete?this.handleWriteError(e):this.handleHandshakeError(e)).then((function(){t.shouldStartWriteStream()&&t.startWriteStream()}))]):[2]}))}))},e.prototype.handleHandshakeError=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){return Wr(e.code)?(m(oi,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=_(),[2,this.localStore.setLastStreamToken(_()).catch(Un)]):[2]}))}))},e.prototype.handleWriteError=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n=this;return a.__generator(this,(function(r){return Wr(i=e.code)&&i!==C.ABORTED?(t=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(t.batchId,e).then((function(){return n.fillWritePipeline()}))]):[2];var i}))}))},e.prototype.createTransaction=function(){return new jr(this.datastore)},e.prototype.restartNetwork=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return e.sent(),this.onlineStateTracker.set(Dr.Unknown),[4,this.enableNetwork()];case 2:return e.sent(),[2]}}))}))},e.prototype.handleCredentialChange=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.canUseNetwork()?(m(oi,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.applyPrimaryState=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){switch(t.label){case 0:return this.isPrimary=e,e&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return t.sent(),[3,4];case 2:return e?[3,4]:[4,this.disableNetworkInternal()];case 3:t.sent(),this.onlineStateTracker.set(Dr.Unknown),t.label=4;case 4:return[2]}}))}))},e}(),si=function(){function e(e,t){if(L("GeoPoint",arguments,2),M("GeoPoint","number",1,e),M("GeoPoint","number",2,t),!isFinite(e)||e<-90||e>90)throw new T(C.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new T(C.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}return Object.defineProperty(e.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(e){return this._lat===e._lat&&this._long===e._long},e.prototype._compareTo=function(e){return X(this._lat,e._lat)||X(this._long,e._long)},e}(),ui=function(){function e(){}return e.prototype.applyToLocalView=function(e,t){return new jt(t,e)},e.prototype.applyToRemoteDocument=function(e,t){return t},e.prototype.computeBaseValue=function(e){return null},e.prototype.isEqual=function(t){return t instanceof e},e.instance=new e,e}(),ci=function(){function e(e){this.elements=e}return e.prototype.applyToLocalView=function(e,t){return this.apply(e)},e.prototype.applyToRemoteDocument=function(e,t){return this.apply(e)},e.prototype.apply=function(e){for(var t=di(e),n=function(e){t.find((function(t){return t.isEqual(e)}))||t.push(e)},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new Ht(t)},e.prototype.computeBaseValue=function(e){return null},e.prototype.isEqual=function(t){return t instanceof e&&J(t.elements,this.elements)},e}(),li=function(){function e(e){this.elements=e}return e.prototype.applyToLocalView=function(e,t){return this.apply(e)},e.prototype.applyToRemoteDocument=function(e,t){return this.apply(e)},e.prototype.apply=function(e){for(var t=di(e),n=function(e){t=t.filter((function(t){return!t.isEqual(e)}))},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new Ht(t)},e.prototype.computeBaseValue=function(e){return null},e.prototype.isEqual=function(t){return t instanceof e&&J(t.elements,this.elements)},e}(),hi=function(){function e(e){this.operand=e}return e.prototype.applyToLocalView=function(e,t){var n=this.computeBaseValue(e);if(n instanceof Mt&&this.operand instanceof Mt){var r=n.internalValue+this.operand.internalValue;return new Mt(r)}r=n.internalValue+this.operand.internalValue;return new Rt(r)},e.prototype.applyToRemoteDocument=function(e,t){return b(null!==t,"Didn't receive transformResult for NUMERIC_ADD transform"),t},e.prototype.computeBaseValue=function(e){return e instanceof Dt?e:new Mt(0)},e.prototype.isEqual=function(t){return t instanceof e&&this.operand.isEqual(t.operand)},e}();function di(e){return e instanceof Ht?e.internalValue.slice():[]}var pi,fi,mi=function(){function e(e){this.count=e}return e.prototype.isEqual=function(e){return e&&e.count===this.count},e}(),gi=((pi={})[lr.ASCENDING.name]="ASCENDING",pi[lr.DESCENDING.name]="DESCENDING",pi),vi=((fi={})[rr.LESS_THAN.name]="LESS_THAN",fi[rr.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",fi[rr.GREATER_THAN.name]="GREATER_THAN",fi[rr.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",fi[rr.EQUAL.name]="EQUAL",fi[rr.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",fi[rr.IN.name]="IN",fi[rr.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",fi),yi=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function bi(e,t){b(!Xn(e),t+" is missing")}function wi(e){return"number"==typeof e?e:"string"==typeof e?Number(e):y("can't parse "+e)}var _i=function(){function e(e,t){this.databaseId=e,this.options=t}return e.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},e.prototype.unsafeCastProtoByteString=function(e){return e},e.prototype.fromRpcStatus=function(e){var t=void 0===e.code?C.UNKNOWN:Ur(e.code);return new T(t,e.message||"")},e.prototype.toInt32Value=function(e){return this.options.useProto3Json||Xn(e)?e:{value:e}},e.prototype.fromInt32Value=function(e){var t;return Xn(t="object"==typeof e?e.value:e)?null:t},e.prototype.toTimestamp=function(e){return this.options.useProto3Json?new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+e.nanoseconds).slice(-9)+"Z":{seconds:""+e.seconds,nanos:e.nanoseconds}},e.prototype.fromTimestamp=function(e){if("string"==typeof e)return this.fromIso8601String(e);b(!!e,"Cannot deserialize null or undefined timestamp.");var t=wi(e.seconds||"0"),n=e.nanos||0;return new Ee(t,n)},e.prototype.fromIso8601String=function(e){var t=0,n=yi.exec(e);if(b(!!n,"invalid timestamp: "+e),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),t=Number(r)}var i=new Date(e),o=Math.floor(i.getTime()/1e3);return new Ee(o,t)},e.prototype.toBytes=function(e){return this.options.useProto3Json?e.toBase64():this.unsafeCastProtoByteString(e.toUint8Array())},e.prototype.fromBlob=function(e){return"string"==typeof e?(b(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),re.fromBase64String(e)):(b(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),re.fromUint8Array(e))},e.prototype.toVersion=function(e){return this.toTimestamp(e.toTimestamp())},e.prototype.fromVersion=function(e){return b(!!e,"Trying to deserialize version that isn't set"),xe.fromTimestamp(this.fromTimestamp(e))},e.prototype.toResourceName=function(e,t){return this.fullyQualifiedPrefixPath(e).child("documents").child(t).canonicalString()},e.prototype.fromResourceName=function(e){var t=le.fromString(e);return b(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},e.prototype.toName=function(e){return this.toResourceName(this.databaseId,e.path)},e.prototype.fromName=function(e){var t=this.fromResourceName(e);return b(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),b(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new pe(this.extractLocalPathFromResourceName(t))},e.prototype.toQueryPath=function(e){return this.toResourceName(this.databaseId,e)},e.prototype.fromQueryPath=function(e){var t=this.fromResourceName(e);return 4===t.length?le.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty(e.prototype,"encodedDatabaseId",{get:function(){return new le(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),e.prototype.fullyQualifiedPrefixPath=function(e){return new le(["projects",e.projectId,"databases",e.database])},e.prototype.extractLocalPathFromResourceName=function(e){return b(e.length>4&&"documents"===e.get(4),"tried to deserialize invalid key "+e.toString()),e.popFirst(5)},e.prototype.isValidResourceName=function(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)},e.prototype.toValue=function(e){if(e instanceof Nt)return{nullValue:"NULL_VALUE"};if(e instanceof Lt)return{booleanValue:e.value()};if(e instanceof Mt)return{integerValue:""+e.value()};if(e instanceof Rt){var t=e.value();if(this.options.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e.value()}}return e instanceof Pt?{stringValue:e.value()}:e instanceof Ut?{mapValue:this.toMapValue(e)}:e instanceof Ht?{arrayValue:this.toArrayValue(e)}:e instanceof Ft?{timestampValue:this.toTimestamp(e.internalValue)}:e instanceof Wt?{geoPointValue:{latitude:e.value().latitude,longitude:e.value().longitude}}:e instanceof Bt?{bytesValue:this.toBytes(e.value())}:e instanceof Vt?{referenceValue:this.toResourceName(e.databaseId,e.key.path)}:y("Unknown FieldValue "+JSON.stringify(e))},e.prototype.fromValue=function(e){var t=this;if("nullValue"in e)return Nt.INSTANCE;if("booleanValue"in e)return Lt.of(e.booleanValue);if("integerValue"in e)return new Mt(wi(e.integerValue));if("doubleValue"in e){if(this.options.useProto3Json){if("NaN"===e.doubleValue)return Rt.NAN;if("Infinity"===e.doubleValue)return Rt.POSITIVE_INFINITY;if("-Infinity"===e.doubleValue)return Rt.NEGATIVE_INFINITY}return new Rt(e.doubleValue)}if("stringValue"in e)return new Pt(e.stringValue);if("mapValue"in e)return this.fromFields(e.mapValue.fields||{});if("arrayValue"in e){bi(e.arrayValue,"arrayValue");var n=e.arrayValue.values||[];return new Ht(n.map((function(e){return t.fromValue(e)})))}if("timestampValue"in e)return bi(e.timestampValue,"timestampValue"),new Ft(this.fromTimestamp(e.timestampValue));if("geoPointValue"in e){bi(e.geoPointValue,"geoPointValue");var r=e.geoPointValue.latitude||0,i=e.geoPointValue.longitude||0;return new Wt(new si(r,i))}if("bytesValue"in e){bi(e.bytesValue,"bytesValue");var o=this.fromBlob(e.bytesValue);return new Bt(o)}if("referenceValue"in e){bi(e.referenceValue,"referenceValue");var a=this.fromResourceName(e.referenceValue),s=new se(a.get(1),a.get(3)),u=new pe(this.extractLocalPathFromResourceName(a));return new Vt(s,u)}return y("Unknown Value proto "+JSON.stringify(e))},e.prototype.toMutationDocument=function(e,t){return{name:this.toName(e),fields:this.toFields(t)}},e.prototype.toDocument=function(e){return b(!e.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(e.key),fields:this.toFields(e.data()),updateTime:this.toTimestamp(e.version.toTimestamp())}},e.prototype.fromDocument=function(e,t){var n=this,r=this.fromName(e.name),i=this.fromVersion(e.updateTime);return new qt(r,i,{hasCommittedMutations:!!t},void 0,e,(function(e){return n.fromValue(e)}))},e.prototype.toFields=function(e){var t=this,n={};return e.forEach((function(e,r){n[e]=t.toValue(r)})),n},e.prototype.fromFields=function(e){var t=this,n=e,r=Ut.EMPTY;return k(n,(function(e,n){r=r.set(new de([e]),t.fromValue(n))})),r},e.prototype.toMapValue=function(e){return{fields:this.toFields(e)}},e.prototype.toArrayValue=function(e){var t=this,n=[];return e.forEach((function(e){n.push(t.toValue(e))})),{values:n}},e.prototype.fromFound=function(e){var t=this;b(!!e.found,"Tried to deserialize a found document from a missing document."),bi(e.found.name,"doc.found.name"),bi(e.found.updateTime,"doc.found.updateTime");var n=this.fromName(e.found.name),r=this.fromVersion(e.found.updateTime);return new qt(n,r,{},void 0,e.found,(function(e){return t.fromValue(e)}))},e.prototype.fromMissing=function(e){b(!!e.missing,"Tried to deserialize a missing document from a found document."),b(!!e.readTime,"Tried to deserialize a missing document without a read time.");var t=this.fromName(e.missing),n=this.fromVersion(e.readTime);return new Kt(t,n)},e.prototype.fromMaybeDocument=function(e){return"found"in e?this.fromFound(e):"missing"in e?this.fromMissing(e):y("invalid batch get response: "+JSON.stringify(e))},e.prototype.toWatchTargetChangeState=function(e){switch(e){case Gr.Added:return"ADD";case Gr.Current:return"CURRENT";case Gr.NoChange:return"NO_CHANGE";case Gr.Removed:return"REMOVE";case Gr.Reset:return"RESET";default:return y("Unknown WatchTargetChangeState: "+e)}},e.prototype.toTestWatchChange=function(e){if(e instanceof Zr)return{filter:{count:e.existenceFilter.count,targetId:e.targetId}};if(e instanceof Jr){if(e.newDoc instanceof qt){var t=e.newDoc;return{documentChange:{document:{name:this.toName(t.key),fields:this.toFields(t.data()),updateTime:this.toVersion(t.version)},targetIds:e.updatedTargetIds,removedTargetIds:e.removedTargetIds}}}if(e.newDoc instanceof Kt){t=e.newDoc;return{documentDelete:{document:this.toName(t.key),readTime:this.toVersion(t.version),removedTargetIds:e.removedTargetIds}}}if(null===e.newDoc)return{documentRemove:{document:this.toName(e.key),removedTargetIds:e.removedTargetIds}}}if(e instanceof ei){var n=void 0;return e.cause&&(n={code:Hr(e.cause.code),message:e.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(e.state),targetIds:e.targetIds,resumeToken:this.unsafeCastProtoByteString(e.resumeToken),cause:n}}}return y("Unrecognized watch change: "+JSON.stringify(e))},e.prototype.fromWatchChange=function(e){var t,n=this;if("targetChange"in e){bi(e.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],o=e.targetChange.resumeToken||this.emptyByteString(),a=e.targetChange.cause,s=a&&this.fromRpcStatus(a);t=new ei(r,i,o,s||null)}else if("documentChange"in e){bi(e.documentChange,"documentChange");var u=e.documentChange;bi(u.document,"documentChange.name"),bi(u.document.name,"documentChange.document.name"),bi(u.document.updateTime,"documentChange.document.updateTime");var c=this.fromName(u.document.name),l=this.fromVersion(u.document.updateTime),h=new qt(c,l,{},void 0,u.document,(function(e){return n.fromValue(e)})),d=u.targetIds||[],p=u.removedTargetIds||[];t=new Jr(d,p,h.key,h)}else if("documentDelete"in e){bi(e.documentDelete,"documentDelete");var f=e.documentDelete;bi(f.document,"documentDelete.document");c=this.fromName(f.document),l=f.readTime?this.fromVersion(f.readTime):xe.forDeletedDoc(),h=new Kt(c,l),p=f.removedTargetIds||[];t=new Jr([],p,h.key,h)}else if("documentRemove"in e){bi(e.documentRemove,"documentRemove");var m=e.documentRemove;bi(m.document,"documentRemove");c=this.fromName(m.document),p=m.removedTargetIds||[];t=new Jr([],p,c,null)}else{if(!("filter"in e))return y("Unknown change type "+JSON.stringify(e));bi(e.filter,"filter");var g=e.filter;bi(g.targetId,"filter.targetId");var v=g.count||0,b=new mi(v),w=g.targetId;t=new Zr(w,b)}return t},e.prototype.fromWatchTargetChangeState=function(e){return"NO_CHANGE"===e?Gr.NoChange:"ADD"===e?Gr.Added:"REMOVE"===e?Gr.Removed:"CURRENT"===e?Gr.Current:"RESET"===e?Gr.Reset:y("Got unexpected TargetChange.state: "+e)},e.prototype.versionFromListenResponse=function(e){if(!("targetChange"in e))return xe.MIN;var t=e.targetChange;return t.targetIds&&t.targetIds.length?xe.MIN:t.readTime?this.fromVersion(t.readTime):xe.MIN},e.prototype.toMutation=function(e){var t,n=this;if(e instanceof St)t={update:this.toMutationDocument(e.key,e.value)};else if(e instanceof It)t={delete:this.toName(e.key)};else if(e instanceof Et)t={update:this.toMutationDocument(e.key,e.data),updateMask:this.toDocumentMask(e.fieldMask)};else{if(!(e instanceof xt))return y("Unknown mutation type "+e.type);t={transform:{document:this.toName(e.key),fieldTransforms:e.fieldTransforms.map((function(e){return n.toFieldTransform(e)}))}}}return e.precondition.isNone||(t.currentDocument=this.toPrecondition(e.precondition)),t},e.prototype.fromMutation=function(e){var t=this,n=e.currentDocument?this.fromPrecondition(e.currentDocument):Ct.NONE;if(e.update){bi(e.update.name,"name");var r=this.fromName(e.update.name),i=this.fromFields(e.update.fields||{});if(e.updateMask){var o=this.fromDocumentMask(e.updateMask);return new Et(r,i,o,n)}return new St(r,i,n)}if(e.delete){r=this.fromName(e.delete);return new It(r,n)}if(e.transform){r=this.fromName(e.transform.document);var a=e.transform.fieldTransforms.map((function(e){return t.fromFieldTransform(e)}));return b(!0===n.exists,'Transforms only support precondition "exists == true"'),new xt(r,a)}return y("unknown mutation proto: "+JSON.stringify(e))},e.prototype.toPrecondition=function(e){return b(!e.isNone,"Can't serialize an empty precondition"),void 0!==e.updateTime?{updateTime:this.toVersion(e.updateTime)}:void 0!==e.exists?{exists:e.exists}:y("Unknown precondition")},e.prototype.fromPrecondition=function(e){return void 0!==e.updateTime?Ct.updateTime(this.fromVersion(e.updateTime)):void 0!==e.exists?Ct.exists(e.exists):Ct.NONE},e.prototype.fromWriteResult=function(e,t){var n=this,r=e.updateTime?this.fromVersion(e.updateTime):this.fromVersion(t);r.isEqual(xe.MIN)&&(r=this.fromVersion(t));var i=null;return e.transformResults&&e.transformResults.length>0&&(i=e.transformResults.map((function(e){return n.fromValue(e)}))),new bt(r,i)},e.prototype.fromWriteResults=function(e,t){var n=this;return e&&e.length>0?(b(void 0!==t,"Received a write result without a commit time"),e.map((function(e){return n.fromWriteResult(e,t)}))):[]},e.prototype.toFieldTransform=function(e){var t=this,n=e.transform;if(n instanceof ui)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ci)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements.map((function(e){return t.toValue(e)}))}};if(n instanceof li)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements.map((function(e){return t.toValue(e)}))}};if(n instanceof hi)return{fieldPath:e.field.canonicalString(),increment:this.toValue(n.operand)};throw y("Unknown transform: "+e.transform)},e.prototype.fromFieldTransform=function(e){var t=this,n=null;if("setToServerValue"in e)b("REQUEST_TIME"===e.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(e)),n=ui.instance;else if("appendMissingElements"in e){var r=e.appendMissingElements.values||[];n=new ci(r.map((function(e){return t.fromValue(e)})))}else if("removeAllFromArray"in e){r=e.removeAllFromArray.values||[];n=new li(r.map((function(e){return t.fromValue(e)})))}else if("increment"in e){var i=this.fromValue(e.increment);b(i instanceof Dt,"NUMERIC_ADD transform requires a NumberValue"),n=new hi(i)}else y("Unknown transform proto: "+JSON.stringify(e));var o=de.fromServerFormat(e.fieldPath);return new yt(o,n)},e.prototype.toDocumentsTarget=function(e){return{documents:[this.toQueryPath(e.path)]}},e.prototype.fromDocumentsTarget=function(e){var t=e.documents.length;b(1===t,"DocumentsTarget contained other than 1 document: "+t);var n=e.documents[0];return tr.atPath(this.fromQueryPath(n)).toTarget()},e.prototype.toQueryTarget=function(e){var t={structuredQuery:{}},n=e.path;null!==e.collectionGroup?(b(n.length%2==0,"Collection Group queries should be within a document path or root."),t.parent=this.toQueryPath(n),t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(b(n.length%2!=0,"Document queries with filters are not supported."),t.parent=this.toQueryPath(n.popLast()),t.structuredQuery.from=[{collectionId:n.lastSegment()}]);var r=this.toFilter(e.filters);r&&(t.structuredQuery.where=r);var i=this.toOrder(e.orderBy);i&&(t.structuredQuery.orderBy=i);var o=this.toInt32Value(e.limit);return null!==o&&(t.structuredQuery.limit=o),e.startAt&&(t.structuredQuery.startAt=this.toCursor(e.startAt)),e.endAt&&(t.structuredQuery.endAt=this.toCursor(e.endAt)),t},e.prototype.fromQueryTarget=function(e){var t=this.fromQueryPath(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){b(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];o.allDescendants?i=o.collectionId:t=t.child(o.collectionId)}var a=[];n.where&&(a=this.fromFilter(n.where));var s=[];n.orderBy&&(s=this.fromOrder(n.orderBy));var u=null;n.limit&&(u=this.fromInt32Value(n.limit));var c=null;n.startAt&&(c=this.fromCursor(n.startAt));var l=null;return n.endAt&&(l=this.fromCursor(n.endAt)),new tr(t,i,s,a,u,Zn.First,c,l).toTarget()},e.prototype.toListenRequestLabels=function(e){var t=this.toLabel(e.purpose);return null==t?null:{"goog-listen-tags":t}},e.prototype.toLabel=function(e){switch(e){case _n.Listen:return null;case _n.ExistenceFilterMismatch:return"existence-filter-mismatch";case _n.LimboResolution:return"limbo-document";default:return y("Unrecognized query purpose: "+e)}},e.prototype.toTarget=function(e){var t,n=e.target;return(t=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)}).targetId=e.targetId,e.resumeToken.length>0&&(t.resumeToken=this.unsafeCastProtoByteString(e.resumeToken)),t},e.prototype.toFilter=function(e){var t=this;if(0!==e.length){var n=e.map((function(e){return e instanceof ir?t.toUnaryOrFieldFilter(e):y("Unrecognized filter: "+JSON.stringify(e))}));return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},e.prototype.fromFilter=function(e){var t=this;return e?void 0!==e.unaryFilter?[this.fromUnaryFilter(e)]:void 0!==e.fieldFilter?[this.fromFieldFilter(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((function(e){return t.fromFilter(e)})).reduce((function(e,t){return e.concat(t)})):y("Unknown filter: "+JSON.stringify(e)):[]},e.prototype.toOrder=function(e){var t=this;if(0!==e.length)return e.map((function(e){return t.toPropertyOrder(e)}))},e.prototype.fromOrder=function(e){var t=this;return e.map((function(e){return t.fromPropertyOrder(e)}))},e.prototype.toCursor=function(e){var t=this;return{before:e.before,values:e.position.map((function(e){return t.toValue(e)}))}},e.prototype.fromCursor=function(e){var t=this,n=!!e.before,r=e.values.map((function(e){return t.fromValue(e)}));return new hr(r,n)},e.prototype.toDirection=function(e){return gi[e.name]},e.prototype.fromDirection=function(e){switch(e){case"ASCENDING":return lr.ASCENDING;case"DESCENDING":return lr.DESCENDING;default:return}},e.prototype.toOperatorName=function(e){return vi[e.name]},e.prototype.fromOperatorName=function(e){switch(e){case"EQUAL":return rr.EQUAL;case"GREATER_THAN":return rr.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return rr.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return rr.LESS_THAN;case"LESS_THAN_OR_EQUAL":return rr.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return rr.ARRAY_CONTAINS;case"IN":return rr.IN;case"ARRAY_CONTAINS_ANY":return rr.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return y("Unspecified operator");default:return y("Unknown operator")}},e.prototype.toFieldPathReference=function(e){return{fieldPath:e.canonicalString()}},e.prototype.fromFieldPathReference=function(e){return de.fromServerFormat(e.fieldPath)},e.prototype.toPropertyOrder=function(e){return{field:this.toFieldPathReference(e.field),direction:this.toDirection(e.dir)}},e.prototype.fromPropertyOrder=function(e){return new dr(this.fromFieldPathReference(e.field),this.fromDirection(e.direction))},e.prototype.fromFieldFilter=function(e){return ir.create(this.fromFieldPathReference(e.fieldFilter.field),this.fromOperatorName(e.fieldFilter.op),this.fromValue(e.fieldFilter.value))},e.prototype.toUnaryOrFieldFilter=function(e){if(e.op===rr.EQUAL){if(e.value.isEqual(Rt.NAN))return{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NAN"}};if(e.value.isEqual(Nt.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(e.field),op:this.toOperatorName(e.op),value:this.toValue(e.value)}}},e.prototype.fromUnaryFilter=function(e){switch(e.unaryFilter.op){case"IS_NAN":var t=this.fromFieldPathReference(e.unaryFilter.field);return ir.create(t,rr.EQUAL,Rt.NAN);case"IS_NULL":var n=this.fromFieldPathReference(e.unaryFilter.field);return ir.create(n,rr.EQUAL,Nt.INSTANCE);case"OPERATOR_UNSPECIFIED":return y("Unspecified filter");default:return y("Unknown filter")}},e.prototype.toDocumentMask=function(e){var t=[];return e.fields.forEach((function(e){return t.push(e.canonicalString())})),{fieldPaths:t}},e.prototype.fromDocumentMask=function(e){var t=(e.fieldPaths||[]).map((function(e){return de.fromServerFormat(e)}));return vt.fromArray(t)},e}(),Ci=function(){this.viewSnap=null,this.targetId=0,this.listeners=[]},Ti=function(){function e(e){this.syncEngine=e,this.queries=new Qt((function(e){return e.canonicalId()})),this.onlineState=Dr.Unknown,this.snapshotsInSyncListeners=new Set,this.syncEngine.subscribe(this)}return e.prototype.listen=function(e){var t=e.query,n=!1,r=this.queries.get(t);(r||(n=!0,r=new Ci,this.queries.set(t,r)),r.listeners.push(e),b(!e.applyOnlineStateChange(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),r.viewSnap)&&(e.onViewSnapshot(r.viewSnap)&&this.raiseSnapshotsInSyncEvent());return n?this.syncEngine.listen(t).then((function(e){return r.targetId=e,e})):Promise.resolve(r.targetId)},e.prototype.unlisten=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r,i;return a.__generator(this,(function(o){return t=e.query,n=!1,(r=this.queries.get(t))&&(i=r.listeners.indexOf(e))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(t),[2,this.syncEngine.unlisten(t)]):[2]}))}))},e.prototype.onWatchChange=function(e){for(var t=!1,n=0,r=e;n<r.length;n++){var i=r[n],o=i.query,a=this.queries.get(o);if(a){for(var s=0,u=a.listeners;s<u.length;s++){u[s].onViewSnapshot(i)&&(t=!0)}a.viewSnap=i}}t&&this.raiseSnapshotsInSyncEvent()},e.prototype.onWatchError=function(e,t){var n=this.queries.get(e);if(n)for(var r=0,i=n.listeners;r<i.length;r++){i[r].onError(t)}this.queries.delete(e)},e.prototype.onOnlineStateChange=function(e){this.onlineState=e;var t=!1;this.queries.forEach((function(n,r){for(var i=0,o=r.listeners;i<o.length;i++){o[i].applyOnlineStateChange(e)&&(t=!0)}})),t&&this.raiseSnapshotsInSyncEvent()},e.prototype.addSnapshotsInSyncListener=function(e){this.snapshotsInSyncListeners.add(e),e.next()},e.prototype.removeSnapshotsInSyncListener=function(e){this.snapshotsInSyncListeners.delete(e)},e.prototype.raiseSnapshotsInSyncEvent=function(){this.snapshotsInSyncListeners.forEach((function(e){e.next()}))},e}(),Si=function(){function e(e,t,n){this.query=e,this.queryObserver=t,this.raisedInitialEvent=!1,this.snap=null,this.onlineState=Dr.Unknown,this.options=n||{}}return e.prototype.onViewSnapshot=function(e){if(b(e.docChanges.length>0||e.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var t=[],n=0,r=e.docChanges;n<r.length;n++){var i=r[n];i.type!==zr.Metadata&&t.push(i)}e=new $r(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(e)&&(this.queryObserver.next(e),o=!0):this.shouldRaiseInitialEvent(e,this.onlineState)&&(this.raiseInitialEvent(e),o=!0),this.snap=e,o},e.prototype.onError=function(e){this.queryObserver.error(e)},e.prototype.applyOnlineStateChange=function(e){this.onlineState=e;var t=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,e)&&(this.raiseInitialEvent(this.snap),t=!0),t},e.prototype.shouldRaiseInitialEvent=function(e,t){if(b(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!e.fromCache)return!0;var n=t!==Dr.Offline;return this.options.waitForSyncWhenOnline&&n?(b(e.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!e.docs.isEmpty()||t===Dr.Offline},e.prototype.shouldRaiseEvent=function(e){if(e.docChanges.length>0)return!0;var t=this.snap&&this.snap.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges},e.prototype.raiseInitialEvent=function(e){b(!this.raisedInitialEvent,"Trying to raise initial events for second time"),e=$r.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(e)},e}(),Ei=function(){function e(e,t,n,r){this.targetId=e,this.fromCache=t,this.addedKeys=n,this.removedKeys=r}return e.fromSnapshot=function(t,n){for(var r=We(),i=We(),o=0,a=n.docChanges;o<a.length;o++){var s=a[o];switch(s.type){case zr.Added:r=r.add(s.doc.key);break;case zr.Removed:i=i.add(s.doc.key)}}return new e(t,n.fromCache,r,i)},e}(),xi=function(e){this.key=e},Ii=function(e){this.key=e},ki=function(){function e(e,t){this.query=e,this._syncedDocuments=t,this.syncState=null,this.current=!1,this.limboDocuments=We(),this.mutatedKeys=We(),this.documentSet=new Kr(e.docComparator.bind(e))}return Object.defineProperty(e.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),e.prototype.computeDocChanges=function(e,t){var n=this,r=t?t.changeSet:new Qr,i=t?t.documentSet:this.documentSet,o=t?t.mutatedKeys:this.mutatedKeys,a=i,s=!1,u=this.query.hasLimitToFirst()&&i.size===this.query.limit?i.last():null,c=this.query.hasLimitToLast()&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((function(e,t){var l=i.get(e),h=t instanceof qt?t:null;h&&(b(e.isEqual(h.key),"Mismatching keys found in document changes: "+e+" != "+h.key),h=n.query.matches(h)?h:null);var d=!!l&&n.mutatedKeys.has(l.key),p=!!h&&(h.hasLocalMutations||n.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;l&&h?l.data().isEqual(h.data())?d!==p&&(r.track({type:zr.Metadata,doc:h}),f=!0):n.shouldWaitForSyncedDocument(l,h)||(r.track({type:zr.Modified,doc:h}),f=!0,(u&&n.query.docComparator(h,u)>0||c&&n.query.docComparator(h,c)<0)&&(s=!0)):!l&&h?(r.track({type:zr.Added,doc:h}),f=!0):l&&!h&&(r.track({type:zr.Removed,doc:l}),f=!0,(u||c)&&(s=!0));f&&(h?(a=a.add(h),o=p?o.add(e):o.delete(e)):(a=a.delete(e),o=o.delete(e)))})),this.query.hasLimitToFirst()||this.query.hasLimitToLast())for(;a.size>this.query.limit;){var l=this.query.hasLimitToFirst()?a.last():a.first();a=a.delete(l.key),o=o.delete(l.key),r.track({type:zr.Removed,doc:l})}return b(!s||!t,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:o}},e.prototype.shouldWaitForSyncedDocument=function(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations},e.prototype.applyChanges=function(e,t,n){var r=this;b(!e.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=e.documentSet,this.mutatedKeys=e.mutatedKeys;var o=e.changeSet.getChanges();o.sort((function(e,t){return function(e,t){var n=function(e){switch(e){case zr.Added:return 1;case zr.Modified:case zr.Metadata:return 2;case zr.Removed:return 0;default:return y("Unknown ChangeType: "+e)}};return n(e)-n(t)}(e.type,t.type)||r.query.docComparator(e.doc,t.doc)})),this.applyTargetChange(n);var a=t?this.updateLimboDocuments():[],s=0===this.limboDocuments.size&&this.current?qr.Synced:qr.Local,u=s!==this.syncState;return this.syncState=s,0!==o.length||u?{snapshot:new $r(this.query,e.documentSet,i,o,e.mutatedKeys,s===qr.Local,u,!1),limboChanges:a}:{limboChanges:a}},e.prototype.applyOnlineStateChange=function(e){return this.current&&e===Dr.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Qr,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},e.prototype.shouldBeInLimbo=function(e){return!this._syncedDocuments.has(e)&&(!!this.documentSet.has(e)&&!this.documentSet.get(e).hasLocalMutations)},e.prototype.applyTargetChange=function(e){var t=this;e&&(e.addedDocuments.forEach((function(e){return t._syncedDocuments=t._syncedDocuments.add(e)})),e.modifiedDocuments.forEach((function(e){return b(t._syncedDocuments.has(e),"Modified document "+e+" not found in view.")})),e.removedDocuments.forEach((function(e){return t._syncedDocuments=t._syncedDocuments.delete(e)})),this.current=e.current)},e.prototype.updateLimboDocuments=function(){var e=this;if(!this.current)return[];var t=this.limboDocuments;this.limboDocuments=We(),this.documentSet.forEach((function(t){e.shouldBeInLimbo(t.key)&&(e.limboDocuments=e.limboDocuments.add(t.key))}));var n=[];return t.forEach((function(t){e.limboDocuments.has(t)||n.push(new Ii(t))})),this.limboDocuments.forEach((function(e){t.has(e)||n.push(new xi(e))})),n},e.prototype.synchronizeWithPersistedState=function(e){this._syncedDocuments=e.remoteKeys,this.limboDocuments=We();var t=this.computeDocChanges(e.documents);return this.applyChanges(t,!0)},e.prototype.computeInitialSnapshot=function(){return $r.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===qr.Local)},e}();var Ai=5,Ni=function(){function e(e,t,n,r){this.asyncQueue=e,this.remoteStore=t,this.updateFunction=n,this.deferred=r,this.retries=Ai,this.backoff=new Lr(this.asyncQueue,ne.RetryTransaction)}return e.prototype.run=function(){this.runWithBackOff()},e.prototype.runWithBackOff=function(){var e=this;this.backoff.backoffAndRun((function(){return a.__awaiter(e,void 0,void 0,(function(){var e,t,n=this;return a.__generator(this,(function(r){return e=this.remoteStore.createTransaction(),(t=this.tryRunUpdateFunction(e))&&t.then((function(t){n.asyncQueue.enqueueAndForget((function(){return e.commit().then((function(){n.deferred.resolve(t)})).catch((function(e){n.handleTransactionError(e)}))}))})).catch((function(e){n.handleTransactionError(e)})),[2]}))}))}))},e.prototype.tryRunUpdateFunction=function(e){try{var t=this.updateFunction(e);return!Xn(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(g){return this.deferred.reject(g),null}},e.prototype.handleTransactionError=function(e){var t=this;this.retries>0&&this.isRetryableTransactionError(e)?(this.retries-=1,this.asyncQueue.enqueueAndForget((function(){return t.runWithBackOff(),Promise.resolve()}))):this.deferred.reject(e)},e.prototype.isRetryableTransactionError=function(e){if("FirebaseError"===e.name){var t=e.code;return"aborted"===t||"failed-precondition"===t||!Wr(t)}return!1},e}(),Li=function(e,t,n){this.query=e,this.targetId=t,this.view=n},Di=function(e){this.key=e,this.receivedDocument=!1},Oi=function(){function e(e,t,n,r){this.localStore=e,this.remoteStore=t,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new Qt((function(e){return e.canonicalId()})),this.queriesByTarget={},this.limboTargetsByKey=new Ie(pe.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new vr,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=lt.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Dr.Unknown}return Object.defineProperty(e.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e){b(null!==e,"SyncEngine listener cannot be null"),b(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=e},e.prototype.listen=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r,i,o;return a.__generator(this,(function(a){switch(a.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(e))?(t=r.targetId,this.sharedClientState.addLocalQueryTarget(t),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateTarget(e.toTarget())];case 2:return i=a.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),t=i.targetId,[4,this.initializeViewAndComputeSnapshot(e,t,"current"===o)];case 3:n=a.sent(),this.isPrimary&&this.remoteStore.listen(i),a.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,t]}}))}))},e.prototype.initializeViewAndComputeSnapshot=function(e,t,n){return a.__awaiter(this,void 0,void 0,(function(){var r,i,o,s,u,c;return a.__generator(this,(function(a){switch(a.label){case 0:return[4,this.localStore.executeQuery(e,!0)];case 1:return r=a.sent(),i=new ki(e,r.remoteKeys),o=i.computeDocChanges(r.documents),s=Xr.createSynthesizedTargetChangeForCurrentChange(t,n&&this.onlineState!==Dr.Offline),b(0===(u=i.applyChanges(o,!0===this.isPrimary,s)).limboChanges.length,"View returned limbo docs before target ack from the server."),b(!!u.snapshot,"applyChanges for new view should always return a snapshot"),c=new Li(e,t,i),this.queryViewsByQuery.set(e,c),this.queriesByTarget[t]||(this.queriesByTarget[t]=[]),this.queriesByTarget[t].push(e),[2,u.snapshot]}}))}))},e.prototype.synchronizeViewAndComputeSnapshot=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n;return a.__generator(this,(function(r){switch(r.label){case 0:return[4,this.localStore.executeQuery(e.query,!0)];case 1:return t=r.sent(),n=e.view.synchronizeWithPersistedState(t),this.isPrimary&&this.updateTrackedLimbos(e.targetId,n.limboChanges),[2,n]}}))}))},e.prototype.unlisten=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r=this;return a.__generator(this,(function(i){switch(i.label){case 0:return this.assertSubscribed("unlisten()"),b(!!(t=this.queryViewsByQuery.get(e)),"Trying to unlisten on query not found:"+e),(n=this.queriesByTarget[t.targetId]).length>1?(this.queriesByTarget[t.targetId]=n.filter((function(t){return!t.isEqual(e)})),this.queryViewsByQuery.delete(e),[2]):this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.sharedClientState.isActiveQueryTarget(t.targetId)?[3,2]:[4,this.localStore.releaseTarget(t.targetId,!1).then((function(){r.sharedClientState.clearQueryState(t.targetId),r.remoteStore.unlisten(t.targetId),r.removeAndCleanupTarget(t.targetId)})).catch(Un)]):[3,3];case 1:i.sent(),i.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupTarget(t.targetId),[4,this.localStore.releaseTarget(t.targetId,!0)];case 4:i.sent(),i.label=5;case 5:return[2]}}))}))},e.prototype.write=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n;return a.__generator(this,(function(r){switch(r.label){case 0:return this.assertSubscribed("write()"),[4,this.localStore.localWrite(e)];case 1:return n=r.sent(),this.sharedClientState.addPendingMutation(n.batchId),this.addMutationCallback(n.batchId,t),[4,this.emitNewSnapsAndNotifyLocalStore(n.changes)];case 2:return r.sent(),[4,this.remoteStore.fillWritePipeline()];case 3:return r.sent(),[2]}}))}))},e.prototype.runTransaction=function(e,t,n){new Ni(e,this.remoteStore,t,n).run()},e.prototype.applyRemoteEvent=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n=this;return a.__generator(this,(function(r){switch(r.label){case 0:this.assertSubscribed("applyRemoteEvent()"),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.applyRemoteEvent(e)];case 2:return t=r.sent(),k(e.targetChanges,(function(e,t){var r=n.limboResolutionsByTarget[Number(e)];r&&(b(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),t.addedDocuments.size>0?r.receivedDocument=!0:t.modifiedDocuments.size>0?b(r.receivedDocument,"Received change for limbo target document without add."):t.removedDocuments.size>0&&(b(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))})),[4,this.emitNewSnapsAndNotifyLocalStore(t,e)];case 3:return r.sent(),[3,6];case 4:return[4,Un(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},e.prototype.applyOnlineStateChange=function(e,t){if(this.isPrimary&&t===Or.RemoteStore||!this.isPrimary&&t===Or.SharedClientState){this.assertSubscribed("applyOnlineStateChange()");var n=[];this.queryViewsByQuery.forEach((function(t,r){var i=r.view.applyOnlineStateChange(e);b(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)})),this.syncEngineListener.onOnlineStateChange(e),this.syncEngineListener.onWatchChange(n),this.onlineState=e,this.isPrimary&&this.sharedClientState.setOnlineState(e)}},e.prototype.rejectListen=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n,r,i,o,s,u=this;return a.__generator(this,(function(a){switch(a.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(e,"rejected",t),n=this.limboResolutionsByTarget[e],(r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[e],i=(i=new Ie(pe.comparator)).insert(r,new Kt(r,xe.forDeletedDoc())),o=We().add(r),s=new Yr(xe.MIN,{},new Le(X),i,o),[2,this.applyRemoteEvent(s)]):[3,1];case 1:return[4,this.localStore.releaseTarget(e,!1).then((function(){return u.removeAndCleanupTarget(e,t)})).catch(Un)];case 2:a.sent(),a.label=3;case 3:return[2]}}))}))},e.prototype.applyBatchState=function(e,t,n){return a.__awaiter(this,void 0,void 0,(function(){var r;return a.__generator(this,(function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(e)];case 1:return null===(r=i.sent())?(m("SyncEngine","Cannot apply mutation batch with id: "+e),[2]):"pending"!==t?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===t||"rejected"===t?(this.processUserCallback(e,n||null),this.localStore.removeCachedMutationBatchMetadata(e)):y("Unknown batchState: "+t),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}}))}))},e.prototype.applySuccessfulWrite=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n;return a.__generator(this,(function(r){switch(r.label){case 0:this.assertSubscribed("applySuccessfulWrite()"),t=e.batch.batchId,this.processUserCallback(t,null),this.triggerPendingWritesCallbacks(t),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.acknowledgeBatch(e)];case 2:return n=r.sent(),this.sharedClientState.updateMutationState(t,"acknowledged"),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return r.sent(),[3,6];case 4:return[4,Un(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},e.prototype.rejectFailedWrite=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n;return a.__generator(this,(function(r){switch(r.label){case 0:this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(e,t),this.triggerPendingWritesCallbacks(e),r.label=1;case 1:return r.trys.push([1,4,,6]),[4,this.localStore.rejectBatch(e)];case 2:return n=r.sent(),this.sharedClientState.updateMutationState(e,"rejected",t),[4,this.emitNewSnapsAndNotifyLocalStore(n)];case 3:return r.sent(),[3,6];case 4:return[4,Un(r.sent())];case 5:return r.sent(),[3,6];case 6:return[2]}}))}))},e.prototype.registerPendingWritesCallback=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n;return a.__generator(this,(function(r){switch(r.label){case 0:return this.remoteStore.canUseNetwork()||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),[4,this.localStore.getHighestUnacknowledgedBatchId()];case 1:return-1===(t=r.sent())?(e.resolve(),[2]):((n=this.pendingWritesCallbacks.get(t)||[]).push(e),this.pendingWritesCallbacks.set(t,n),[2])}}))}))},e.prototype.triggerPendingWritesCallbacks=function(e){(this.pendingWritesCallbacks.get(e)||[]).forEach((function(e){e.resolve()})),this.pendingWritesCallbacks.delete(e)},e.prototype.rejectOutstandingPendingWritesCallbacks=function(e){this.pendingWritesCallbacks.forEach((function(t){t.forEach((function(t){t.reject(new T(C.CANCELLED,e))}))})),this.pendingWritesCallbacks.clear()},e.prototype.addMutationCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new Ie(X)),n=n.insert(e,t),this.mutationUserCallbacks[this.currentUser.toKey()]=n},e.prototype.processUserCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(e);r&&(b(e===n.minKey(),"Mutation callbacks processed out-of-order?"),t?r.reject(t):r.resolve(),n=n.remove(e)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},e.prototype.removeAndCleanupTarget=function(e,t){var n=this;void 0===t&&(t=null),this.sharedClientState.removeLocalQueryTarget(e),b(this.queriesByTarget[e]&&0!==this.queriesByTarget[e].length,"There are no queries mapped to target id "+e);for(var r=0,i=this.queriesByTarget[e];r<i.length;r++){var o=i[r];this.queryViewsByQuery.delete(o),t&&this.syncEngineListener.onWatchError(o,t)}if(delete this.queriesByTarget[e],this.isPrimary){var a=this.limboDocumentRefs.referencesForId(e);this.limboDocumentRefs.removeReferencesForId(e),a.forEach((function(e){n.limboDocumentRefs.containsKey(e)||n.removeLimboTarget(e)}))}},e.prototype.removeLimboTarget=function(e){var t=this.limboTargetsByKey.get(e);null!==t&&(this.remoteStore.unlisten(t),this.limboTargetsByKey=this.limboTargetsByKey.remove(e),delete this.limboResolutionsByTarget[t])},e.prototype.updateTrackedLimbos=function(e,t){for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i instanceof xi)this.limboDocumentRefs.addReference(i.key,e),this.trackLimboChange(i);else if(i instanceof Ii){m("SyncEngine","Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,e),this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)}else y("Unknown limbo change: "+JSON.stringify(i))}},e.prototype.trackLimboChange=function(e){var t=e.key;if(!this.limboTargetsByKey.get(t)){m("SyncEngine","New document in limbo: "+t);var n=this.limboTargetIdGenerator.next(),r=tr.atPath(t.path);this.limboResolutionsByTarget[n]=new Di(t),this.remoteStore.listen(new kn(r.toTarget(),n,_n.LimboResolution,ue.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(t,n)}},e.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},e.prototype.emitNewSnapsAndNotifyLocalStore=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n,r,i,o=this;return a.__generator(this,(function(a){switch(a.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach((function(a,s){i.push(Promise.resolve().then((function(){var t=s.view.computeDocChanges(e);return t.needsRefill?o.localStore.executeQuery(s.query,!1).then((function(e){var n=e.documents;return s.view.computeDocChanges(n,t)})):t})).then((function(e){var i=t&&t.targetChanges[s.targetId],a=s.view.applyChanges(e,!0===o.isPrimary,i);if(o.updateTrackedLimbos(s.targetId,a.limboChanges),a.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(s.targetId,a.snapshot.fromCache?"not-current":"current"),n.push(a.snapshot);var u=Ei.fromSnapshot(s.targetId,a.snapshot);r.push(u)}})))})),[4,Promise.all(i)];case 1:return a.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return a.sent(),[2]}}))}))},e.prototype.assertSubscribed=function(e){b(null!==this.syncEngineListener,"Trying to call "+e+" before calling subscribe().")},e.prototype.handleCredentialChange=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n;return a.__generator(this,(function(r){switch(r.label){case 0:return t=!this.currentUser.isEqual(e),this.currentUser=e,t?(this.rejectOutstandingPendingWritesCallbacks("'waitForPendingWrites' promise is rejected due to a user change."),[4,this.localStore.handleUserChange(e)]):[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(e,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}}))}))},e.prototype.applyPrimaryState=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r,i,o,s,u,c=this;return a.__generator(this,(function(a){switch(a.label){case 0:return!0!==e||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return a.sent(),t=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(t.toArray())];case 2:for(n=a.sent(),r=0,i=n;r<i.length;r++)o=i[r],this.remoteStore.listen(o);return[3,7];case 3:return!1!==e||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,s=[],u=Promise.resolve(),I(this.queriesByTarget,(function(e,t){c.sharedClientState.isLocalQueryTarget(e)?s.push(e):u=u.then((function(){return c.removeAndCleanupTarget(e),c.localStore.releaseTarget(e,!0)})),c.remoteStore.unlisten(e)})),[4,u]);case 4:return a.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(s)];case 5:return a.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:a.sent(),a.label=7;case 7:return[2]}}))}))},e.prototype.resetLimboDocuments=function(){var e=this;I(this.limboResolutionsByTarget,(function(t){e.remoteStore.unlisten(t)})),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Ie(pe.comparator)},e.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(e){return a.__awaiter(this,void 0,void 0,(function(){var t,n,r,i,o,s,u,c,l,h,d,p,f;return a.__generator(this,(function(a){switch(a.label){case 0:t=[],n=[],r=0,i=e,a.label=1;case 1:return r<i.length?(o=i[r],s=void 0,(u=this.queriesByTarget[o])&&0!==u.length?[4,this.localStore.releaseTarget(o,!0)]:[3,8]):[3,14];case 2:return a.sent(),[4,this.localStore.allocateTarget(u[0].toTarget())];case 3:s=a.sent(),c=0,l=u,a.label=4;case 4:return c<l.length?(h=l[c],b(!!(d=this.queryViewsByQuery.get(h)),"No query view found for "+h),[4,this.synchronizeViewAndComputeSnapshot(d)]):[3,7];case 5:(p=a.sent()).snapshot&&n.push(p.snapshot),a.label=6;case 6:return c++,[3,4];case 7:return[3,12];case 8:return b(!0===this.isPrimary,"A secondary tab should never have an active target without an active query."),[4,this.localStore.getTarget(o)];case 9:return b(!!(f=a.sent()),"Target for id "+o+" not found"),[4,this.localStore.allocateTarget(f)];case 10:return s=a.sent(),[4,this.initializeViewAndComputeSnapshot(this.synthesizeTargetToQuery(f),o,!1)];case 11:a.sent(),a.label=12;case 12:t.push(s),a.label=13;case 13:return r++,[3,1];case 14:return this.syncEngineListener.onWatchChange(n),[2,t]}}))}))},e.prototype.synthesizeTargetToQuery=function(e){return new tr(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,Zn.First,e.startAt,e.endAt)},e.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},e.prototype.applyTargetState=function(e,t,n){return a.__awaiter(this,void 0,void 0,(function(){var r,i;return a.__generator(this,(function(o){switch(o.label){case 0:if(this.isPrimary)return m("SyncEngine","Ignoring unexpected query state notification."),[2];if(!this.queriesByTarget[e])return[3,7];switch(t){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,this.localStore.getNewDocumentChanges()];case 2:return r=o.sent(),i=Yr.createSynthesizedRemoteEventForCurrentChange(e,"current"===t),[4,this.emitNewSnapsAndNotifyLocalStore(r,i)];case 3:return o.sent(),[3,7];case 4:return[4,this.localStore.releaseTarget(e,!0)];case 5:return o.sent(),this.removeAndCleanupTarget(e,n),[3,7];case 6:y("Unexpected target state: "+t),o.label=7;case 7:return[2]}}))}))},e.prototype.applyActiveTargetsChange=function(e,t){return a.__awaiter(this,void 0,void 0,(function(){var n,r,i,o,s,u,c,l,h,d=this;return a.__generator(this,(function(p){switch(p.label){case 0:if(!this.isPrimary)return[2];n=0,r=e,p.label=1;case 1:return n<r.length?(h=r[n],b(!this.queriesByTarget[h],"Trying to add an already active target"),[4,this.localStore.getTarget(h)]):[3,6];case 2:return b(!!(i=p.sent()),"Query data for active target "+h+" not found"),[4,this.localStore.allocateTarget(i)];case 3:return o=p.sent(),[4,this.initializeViewAndComputeSnapshot(this.synthesizeTargetToQuery(i),o.targetId,!1)];case 4:p.sent(),this.remoteStore.listen(o),p.label=5;case 5:return n++,[3,1];case 6:s=function(e){return a.__generator(this,(function(t){switch(t.label){case 0:return u.queriesByTarget[e]?[4,u.localStore.releaseTarget(e,!1).then((function(){d.remoteStore.unlisten(e),d.removeAndCleanupTarget(e)})).catch(Un)]:[2,"continue"];case 1:return t.sent(),[2]}}))},u=this,c=0,l=t,p.label=7;case 7:return c<l.length?(h=l[c],[5,s(h)]):[3,10];case 8:p.sent(),p.label=9;case 9:return c++,[3,7];case 10:return[2]}}))}))},e.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},e.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},e.prototype.getRemoteKeysForTarget=function(e){var t=this.limboResolutionsByTarget[e];if(t&&t.receivedDocument)return We().add(t.key);var n=We(),r=this.queriesByTarget[e];if(!r)return n;for(var i=0,o=r;i<o.length;i++){var a=o[i],s=this.queryViewsByQuery.get(a);b(!!s,"No query view found for "+a),n=n.unionWith(s.view.syncedDocuments)}return n},e}(),Mi=function(){function e(e){this.uid=e}return e.prototype.isAuthenticated=function(){return null!=this.uid},e.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},e.prototype.isEqual=function(e){return e.uid===this.uid},e.UNAUTHENTICATED=new e(null),e.GOOGLE_CREDENTIALS=new e("google-credentials-uid"),e.FIRST_PARTY=new e("first-party-uid"),e}(),Ri="firestore_clients";function Pi(e,t){return b(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),Ri+"_"+e+"_"+t}var Fi="firestore_mutations";function ji(e,t,n){var r=Fi+"_"+e+"_"+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}var Bi="firestore_targets";function Vi(e,t){return Bi+"_"+e+"_"+t}var Wi="firestore_online_state";var Ui="firestore_sequence_number";var Hi="SharedClientState",zi=function(){function e(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r,b(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return e.fromWebStorageEntry=function(t,n,r){var i=JSON.parse(r),o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),a=void 0;return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(a=new T(i.error.code,i.error.message)),o?new e(t,n,i.state,a):(g(Hi,"Failed to parse mutation state for ID '"+n+"': "+r),null)},e.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},e}(),qi=function(){function e(e,t,n){this.targetId=e,this.state=t,this.error=n,b(void 0!==n==("rejected"===t),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return e.fromWebStorageEntry=function(t,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new T(r.error.code,r.error.message)),i?new e(t,r.state,o):(g(Hi,"Failed to parse target state for ID '"+t+"': "+n),null)},e.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},e}(),Ki=function(){function e(e,t){this.clientId=e,this.activeTargetIds=t}return e.fromWebStorageEntry=function(t,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=He(),a=0;i&&a<r.activeTargetIds.length;++a)i=Jn(r.activeTargetIds[a]),o=o.add(r.activeTargetIds[a]);return i?new e(t,o):(g(Hi,"Failed to parse client data for instance '"+t+"': "+n),null)},e}(),Gi=function(){function e(e,t){this.clientId=e,this.onlineState=t}return e.fromWebStorageEntry=function(t){var n=JSON.parse(t);return"object"==typeof n&&n.onlineState in Dr&&"string"==typeof n.clientId?new e(n.clientId,Dr[n.onlineState]):(g(Hi,"Failed to parse online state: "+t),null)},e}(),Qi=function(){function e(){this.activeTargetIds=He()}return e.prototype.addQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.add(e)},e.prototype.removeQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.delete(e)},e.prototype.toWebStorageJSON=function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)},e}(),$i=function(){function e(t,n,r,i,o){if(this.queue=t,this.platform=n,this.persistenceKey=r,this.localClientId=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!e.isAvailable(this.platform))throw new T(C.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var a=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=o,this.localClientStorageKey=Pi(this.persistenceKey,this.localClientId),this.sequenceNumberKey=function(e){return Ui+"_"+e}(this.persistenceKey),this.activeClients[this.localClientId]=new Qi,this.clientStateKeyRe=new RegExp("^"+Ri+"_"+a+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Fi+"_"+a+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Bi+"_"+a+"_(\\d+)$"),this.onlineStateKey=function(e){return Wi+"_"+e}(this.persistenceKey),this.platform.window.addEventListener("storage",this.storageListener)}return e.isAvailable=function(e){return!(!e.window||null==e.window.localStorage)},e.prototype.start=function(){return a.__awaiter(this,void 0,void 0,(function(){var e,t,n,r,i,o,s,u,c,l,h,d=this;return a.__generator(this,(function(a){switch(a.label){case 0:return b(!this.started,"WebStorageSharedClientState already started"),b(null!==this.syncEngine,"syncEngine property must be set before calling start()"),b(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(e=a.sent(),t=0,n=e;t<n.length;t++)(r=n[t])!==this.localClientId&&(i=this.getItem(Pi(this.persistenceKey,r)))&&(o=Ki.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(s=this.storage.getItem(this.onlineStateKey))&&(u=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(u),c=0,l=this.earlyEvents;c<l.length;c++)h=l[c],this.handleWebStorageEvent(h);return this.earlyEvents=[],this.platform.window.addEventListener("unload",(function(){return d.shutdown()})),this.started=!0,[2]}}))}))},e.prototype.writeSequenceNumber=function(e){this.setItem(this.sequenceNumberKey,JSON.stringify(e))},e.prototype.getAllActiveQueryTargets=function(){var e=He();return k(this.activeClients,(function(t,n){e=e.unionWith(n.activeTargetIds)})),e},e.prototype.isActiveQueryTarget=function(e){for(var t in this.activeClients)if(this.activeClients.hasOwnProperty(t)&&this.activeClients[t].activeTargetIds.has(e))return!0;return!1},e.prototype.addPendingMutation=function(e){this.persistMutationState(e,"pending")},e.prototype.updateMutationState=function(e,t,n){this.persistMutationState(e,t,n),this.removeMutationState(e)},e.prototype.addLocalQueryTarget=function(e){var t="not-current";if(this.isActiveQueryTarget(e)){var n=this.storage.getItem(Vi(this.persistenceKey,e));if(n){var r=qi.fromWebStorageEntry(e,n);r&&(t=r.state)}}return this.localClientState.addQueryTarget(e),this.persistClientState(),t},e.prototype.removeLocalQueryTarget=function(e){this.localClientState.removeQueryTarget(e),this.persistClientState()},e.prototype.isLocalQueryTarget=function(e){return this.localClientState.activeTargetIds.has(e)},e.prototype.clearQueryState=function(e){this.removeItem(Vi(this.persistenceKey,e))},e.prototype.updateQueryState=function(e,t,n){this.persistQueryTargetState(e,t,n)},e.prototype.handleUserChange=function(e,t,n){var r=this;t.forEach((function(e){r.removeMutationState(e)})),this.currentUser=e,n.forEach((function(e){r.addPendingMutation(e)}))},e.prototype.setOnlineState=function(e){this.persistOnlineState(e)},e.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},e.prototype.getItem=function(e){var t=this.storage.getItem(e);return m(Hi,"READ",e,t),t},e.prototype.setItem=function(e,t){m(Hi,"SET",e,t),this.storage.setItem(e,t)},e.prototype.removeItem=function(e){m(Hi,"REMOVE",e),this.storage.removeItem(e)},e.prototype.handleWebStorageEvent=function(e){var t=this;if(e.storageArea===this.storage){if(m(Hi,"EVENT",e.key,e.newValue),e.key===this.localClientStorageKey)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget((function(){return a.__awaiter(t,void 0,void 0,(function(){var t,n,r,i,o,s;return a.__generator(this,(function(a){if(!this.started)return this.earlyEvents.push(e),[2];if(null===e.key)return[2];if(this.clientStateKeyRe.test(e.key)){if(null==e.newValue)return n=this.fromWebStorageClientStateKey(e.key),[2,this.handleClientStateEvent(n,null)];if(t=this.fromWebStorageClientState(e.key,e.newValue))return[2,this.handleClientStateEvent(t.clientId,t)]}else if(this.mutationBatchKeyRe.test(e.key)){if(null!==e.newValue&&(r=this.fromWebStorageMutationMetadata(e.key,e.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(e.key)){if(null!==e.newValue&&(i=this.fromWebStorageQueryTargetMetadata(e.key,e.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(e.key===this.onlineStateKey){if(null!==e.newValue&&(o=this.fromWebStorageOnlineState(e.newValue)))return[2,this.handleOnlineStateEvent(o)]}else e.key===this.sequenceNumberKey&&(b(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(s=function(e){var t=ue.INVALID;if(null!=e)try{var n=JSON.parse(e);b("number"==typeof n,"Found non-numeric sequence number"),t=n}catch(r){g(Hi,"Failed to read sequence number from WebStorage",r)}return t}(e.newValue))!==ue.INVALID&&this.sequenceNumberHandler(s));return[2]}))}))}))}},Object.defineProperty(e.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),e.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},e.prototype.persistMutationState=function(e,t,n){var r=new zi(this.currentUser,e,t,n),i=ji(this.persistenceKey,this.currentUser,e);this.setItem(i,r.toWebStorageJSON())},e.prototype.removeMutationState=function(e){var t=ji(this.persistenceKey,this.currentUser,e);this.removeItem(t)},e.prototype.persistOnlineState=function(e){var t={clientId:this.localClientId,onlineState:Dr[e]};this.storage.setItem(this.onlineStateKey,JSON.stringify(t))},e.prototype.persistQueryTargetState=function(e,t,n){var r=Vi(this.persistenceKey,e),i=new qi(e,t,n);this.setItem(r,i.toWebStorageJSON())},e.prototype.fromWebStorageClientStateKey=function(e){var t=this.clientStateKeyRe.exec(e);return t?t[1]:null},e.prototype.fromWebStorageClientState=function(e,t){var n=this.fromWebStorageClientStateKey(e);return b(null!==n,"Cannot parse client state key '"+e+"'"),Ki.fromWebStorageEntry(n,t)},e.prototype.fromWebStorageMutationMetadata=function(e,t){var n=this.mutationBatchKeyRe.exec(e);b(null!==n,"Cannot parse mutation batch key '"+e+"'");var r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return zi.fromWebStorageEntry(new Mi(i),r,t)},e.prototype.fromWebStorageQueryTargetMetadata=function(e,t){var n=this.queryTargetKeyRe.exec(e);b(null!==n,"Cannot parse query target key '"+e+"'");var r=Number(n[1]);return qi.fromWebStorageEntry(r,t)},e.prototype.fromWebStorageOnlineState=function(e){return Gi.fromWebStorageEntry(e)},e.prototype.handleMutationBatchEvent=function(e){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(t){return e.user.uid!==this.currentUser.uid?(m(Hi,"Ignoring mutation for non-active user "+e.user.uid),[2]):[2,this.syncEngine.applyBatchState(e.batchId,e.state,e.error)]}))}))},e.prototype.handleQueryTargetEvent=function(e){return this.syncEngine.applyTargetState(e.targetId,e.state,e.error)},e.prototype.handleClientStateEvent=function(e,t){var n=this,r=this.getAllActiveQueryTargets();t?this.activeClients[e]=t:delete this.activeClients[e];var i=this.getAllActiveQueryTargets(),o=[],s=[];return i.forEach((function(e){return a.__awaiter(n,void 0,void 0,(function(){return a.__generator(this,(function(t){return r.has(e)||o.push(e),[2]}))}))})),r.forEach((function(e){return a.__awaiter(n,void 0,void 0,(function(){return a.__generator(this,(function(t){return i.has(e)||s.push(e),[2]}))}))})),this.syncEngine.applyActiveTargetsChange(o,s)},e.prototype.handleOnlineStateEvent=function(e){this.activeClients[e.clientId]&&this.onlineStateHandler(e.onlineState)},e}();var Yi=function(){function e(){this.localState=new Qi,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return e.prototype.addPendingMutation=function(e){},e.prototype.updateMutationState=function(e,t,n){},e.prototype.addLocalQueryTarget=function(e){return this.localState.addQueryTarget(e),this.queryState[e]||"not-current"},e.prototype.updateQueryState=function(e,t,n){this.queryState[e]=t},e.prototype.removeLocalQueryTarget=function(e){this.localState.removeQueryTarget(e)},e.prototype.isLocalQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},e.prototype.clearQueryState=function(e){delete this.queryState[e]},e.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},e.prototype.isActiveQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},e.prototype.start=function(){return this.localState=new Qi,Promise.resolve()},e.prototype.handleUserChange=function(e,t,n){},e.prototype.setOnlineState=function(e){},e.prototype.shutdown=function(){},e.prototype.writeSequenceNumber=function(e){},e}(),Xi=function(){function e(e,t){this.cacheSizeBytes=e,this.synchronizeTabs=t}return e.prototype.lruParams=function(){return On.withCacheSize(this.cacheSizeBytes)},e}(),Ji=function(){},Zi=function(){function e(e,t,n,r){this.platform=e,this.databaseInfo=t,this.credentials=n,this.asyncQueue=r,this.clientId=Y.newId()}return e.prototype.start=function(e){var t=this;this.verifyNotTerminated();var n=new fe,r=new fe,i=!1;return this.credentials.setChangeListener((function(o){i?t.asyncQueue.enqueueAndForget((function(){return t.handleCredentialChange(o)})):(i=!0,t.initializePersistence(e,r,o).then((function(e){return t.initializeRest(o,e)})).then(n.resolve,n.reject))})),this.asyncQueue.enqueueAndForget((function(){return n.promise})),r.promise},e.prototype.enableNetwork=function(){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return e.syncEngine.enableNetwork()}))},e.prototype.initializePersistence=function(e,t,n){var r=this;return e instanceof Xi?this.startIndexedDbPersistence(n,e).then((function(e){return t.resolve(),e})).catch((function(e){if(t.reject(e),!r.canFallback(e))throw e;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),r.startMemoryPersistence()})):(t.resolve(),this.startMemoryPersistence())},e.prototype.canFallback=function(e){return e instanceof T?e.code===C.FAILED_PRECONDITION||e.code===C.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)},e.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new T(C.FAILED_PRECONDITION,"The client has already been terminated.")},e.prototype.startIndexedDbPersistence=function(e,t){var n=this,r=Wn.buildStoragePrefix(this.databaseInfo),i=new _i(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then((function(){return a.__awaiter(n,void 0,void 0,(function(){var n,o;return a.__generator(this,(function(a){switch(a.label){case 0:if(t.synchronizeTabs&&!$i.isAvailable(this.platform))throw new T(C.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return n=t.lruParams(),this.sharedClientState=t.synchronizeTabs?new $i(this.asyncQueue,this.platform,r,this.clientId,e):new Yi,[4,Wn.createIndexedDbPersistence({allowTabSynchronization:t.synchronizeTabs,persistenceKey:r,clientId:this.clientId,platform:this.platform,queue:this.asyncQueue,serializer:i,lruParams:n,sequenceNumberSyncer:this.sharedClientState})];case 1:return o=a.sent(),this.persistence=o,[2,o.referenceDelegate.garbageCollector]}}))}))}))},e.prototype.startMemoryPersistence=function(){return this.persistence=Sr.createEagerPersistence(this.clientId),this.sharedClientState=new Yi,Promise.resolve(null)},e.prototype.initializeRest=function(e,t){var n=this;return m("FirestoreClient","Initializing. user=",e.uid),this.platform.loadConnection(this.databaseInfo).then((function(r){return a.__awaiter(n,void 0,void 0,(function(){var n,i,o,s,u,c,l=this;return a.__generator(this,(function(h){switch(h.label){case 0:return n=new mr,this.localStore=new br(this.persistence,n,e),[4,this.localStore.start()];case 1:return h.sent(),t&&(this.lruScheduler=new Mn(t,this.asyncQueue,this.localStore)),i=this.platform.newConnectivityMonitor(),o=this.platform.newSerializer(this.databaseInfo.databaseId),s=new Fr(this.asyncQueue,r,this.credentials,o),u=function(e){return l.syncEngine.applyOnlineStateChange(e,Or.RemoteStore)},c=function(e){return l.syncEngine.applyOnlineStateChange(e,Or.SharedClientState)},this.remoteStore=new ai(this.localStore,s,this.asyncQueue,u,i),this.syncEngine=new Oi(this.localStore,this.remoteStore,this.sharedClientState,e),this.sharedClientState.onlineStateHandler=c,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Ti(this.syncEngine),[4,this.sharedClientState.start()];case 2:return h.sent(),[4,this.remoteStore.start()];case 3:return h.sent(),[4,this.persistence.setPrimaryStateListener((function(e){return a.__awaiter(l,void 0,void 0,(function(){return a.__generator(this,(function(t){switch(t.label){case 0:return[4,this.syncEngine.applyPrimaryState(e)];case 1:return t.sent(),this.lruScheduler&&(e&&!this.lruScheduler.started?this.lruScheduler.start():e||this.lruScheduler.stop()),[2]}}))}))}))];case 4:return h.sent(),[4,this.persistence.setDatabaseDeletedListener((function(){return a.__awaiter(l,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return[4,this.terminate()];case 1:return e.sent(),[2]}}))}))}))];case 5:return h.sent(),[2]}}))}))}))},e.prototype.handleCredentialChange=function(e){return this.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Credential Changed. Current user: "+e.uid),this.syncEngine.handleCredentialChange(e)},e.prototype.disableNetwork=function(){var e=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return e.syncEngine.disableNetwork()}))},e.prototype.terminate=function(){var e=this;return this.asyncQueue.enqueueAndInitiateShutdown((function(){return a.__awaiter(e,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return e.sent(),[4,this.sharedClientState.shutdown()];case 2:return e.sent(),[4,this.persistence.shutdown()];case 3:return e.sent(),this.credentials.removeChangeListener(),[2]}}))}))}))},e.prototype.waitForPendingWrites=function(){var e=this;this.verifyNotTerminated();var t=new fe;return this.asyncQueue.enqueueAndForget((function(){return e.syncEngine.registerPendingWritesCallback(t)})),t.promise},e.prototype.listen=function(e,t,n){var r=this;this.verifyNotTerminated();var i=new Si(e,t,n);return this.asyncQueue.enqueueAndForget((function(){return r.eventMgr.listen(i)})),i},e.prototype.unlisten=function(e){var t=this;this.clientTerminated||this.asyncQueue.enqueueAndForget((function(){return t.eventMgr.unlisten(e)}))},e.prototype.getDocumentFromLocalCache=function(e){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return t.localStore.readDocument(e)})).then((function(e){if(e instanceof qt)return e;if(e instanceof Kt)return null;throw new T(C.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")}))},e.prototype.getDocumentsFromLocalCache=function(e){var t=this;return this.verifyNotTerminated(),this.asyncQueue.enqueue((function(){return a.__awaiter(t,void 0,void 0,(function(){var t,n,r;return a.__generator(this,(function(i){switch(i.label){case 0:return[4,this.localStore.executeQuery(e,!0)];case 1:return t=i.sent(),n=new ki(e,t.remoteKeys),r=n.computeDocChanges(t.documents),[2,n.applyChanges(r,!1).snapshot]}}))}))}))},e.prototype.write=function(e){var t=this;this.verifyNotTerminated();var n=new fe;return this.asyncQueue.enqueueAndForget((function(){return t.syncEngine.write(e,n)})),n.promise},e.prototype.databaseId=function(){return this.databaseInfo.databaseId},e.prototype.addSnapshotsInSyncListener=function(e){var t=this;this.verifyNotTerminated(),this.asyncQueue.enqueueAndForget((function(){return t.eventMgr.addSnapshotsInSyncListener(e),Promise.resolve()}))},e.prototype.removeSnapshotsInSyncListener=function(e){this.clientTerminated||this.eventMgr.removeSnapshotsInSyncListener(e)},Object.defineProperty(e.prototype,"clientTerminated",{get:function(){return this.asyncQueue.isShuttingDown},enumerable:!0,configurable:!0}),e.prototype.transaction=function(e){var t=this;this.verifyNotTerminated();var n=new fe;return this.asyncQueue.enqueueAndForget((function(){return t.syncEngine.runTransaction(t.asyncQueue,e,n),Promise.resolve()})),n.promise},e}(),eo=function(){function e(e){this.observer=e,this.muted=!1}return e.prototype.next=function(e){this.scheduleEvent(this.observer.next,e)},e.prototype.error=function(e){this.scheduleEvent(this.observer.error,e)},e.prototype.mute=function(){this.muted=!0},e.prototype.scheduleEvent=function(e,t){var n=this;this.muted||setTimeout((function(){n.muted||e(t)}),0)},e}(),to=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];!function(e,t,n,r){if(!(t instanceof Array)||t.length<r)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" argument to be an array with at least "+$(r,"element")+".")}("FieldPath",e,"fieldNames",1);for(var n=0;n<e.length;++n)if(M("FieldPath","string",n,e[n]),0===e[n].length)throw new T(C.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new de(e)}return e.documentId=function(){return e._DOCUMENT_ID},e.prototype.isEqual=function(t){if(!(t instanceof e))throw K("isEqual","FieldPath",1,t);return this._internalPath.isEqual(t._internalPath)},e._DOCUMENT_ID=new e(de.keyField().canonicalString()),e}(),no=new RegExp("[~\\*/\\[\\]]");var ro=function(e,t){this.user=t,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization="Bearer "+e},io=function(){function e(){this.changeListener=null}return e.prototype.getToken=function(){return Promise.resolve(null)},e.prototype.invalidateToken=function(){},e.prototype.setChangeListener=function(e){b(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,e(Mi.UNAUTHENTICATED)},e.prototype.removeChangeListener=function(){b(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},e}(),oo=function(){function e(e){var t=this;this.tokenListener=null,this.currentUser=Mi.UNAUTHENTICATED,this.receivedInitialUser=!1,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){t.tokenCounter++,t.currentUser=t.getUser(),t.receivedInitialUser=!0,t.changeListener&&t.changeListener(t.currentUser)},this.tokenCounter=0,this.auth=e.getImmediate({optional:!0}),this.auth?this.auth.addAuthTokenListener(this.tokenListener):(this.tokenListener(null),e.get().then((function(e){t.auth=e,t.tokenListener&&t.auth.addAuthTokenListener(t.tokenListener)}),(function(){})))}return e.prototype.getToken=function(){var e=this;b(null!=this.tokenListener,"getToken cannot be called after listener removed.");var t=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(n).then((function(n){if(e.tokenCounter!==t)throw new T(C.ABORTED,"getToken aborted due to token change.");return n?(b("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new ro(n.accessToken,e.currentUser)):null})):Promise.resolve(null)},e.prototype.invalidateToken=function(){this.forceRefresh=!0},e.prototype.setChangeListener=function(e){b(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,this.receivedInitialUser&&e(this.currentUser)},e.prototype.removeChangeListener=function(){b(null!=this.tokenListener,"removeChangeListener() called twice"),b(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.auth&&this.auth.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},e.prototype.getUser=function(){var e=this.auth&&this.auth.getUid();return b(null===e||"string"==typeof e,"Received invalid UID: "+e),new Mi(e)},e}(),ao=function(){function e(e,t){this.gapi=e,this.sessionIndex=t,this.type="FirstParty",this.user=Mi.FIRST_PARTY}return Object.defineProperty(e.prototype,"authHeaders",{get:function(){var e={"X-Goog-AuthUser":this.sessionIndex},t=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return t&&(e.Authorization=t),e},enumerable:!0,configurable:!0}),e}(),so=function(){function e(e,t){this.gapi=e,this.sessionIndex=t}return e.prototype.getToken=function(){return Promise.resolve(new ao(this.gapi,this.sessionIndex))},e.prototype.setChangeListener=function(e){e(Mi.FIRST_PARTY)},e.prototype.removeChangeListener=function(){},e.prototype.invalidateToken=function(){},e}();function uo(e){if(!e)return new io;switch(e.type){case"gapi":var t=e.client;return b(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new so(t,e.sessionIndex||"0");case"provider":return e.client;default:throw new T(C.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function co(e){return function(e,t){if("object"!=typeof e||null===e)return!1;for(var n=e,r=0,i=t;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(e,["next","error","complete"])}var lo,ho=function(){function e(e){this._methodName=e}return e.delete=function(){return N("FieldValue.delete",arguments),po.instance},e.serverTimestamp=function(){return N("FieldValue.serverTimestamp",arguments),fo.instance},e.arrayUnion=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return D("FieldValue.arrayUnion",arguments,1),new mo(e)},e.arrayRemove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return D("FieldValue.arrayRemove",arguments,1),new go(e)},e.increment=function(e){return M("FieldValue.increment","number",1,e),L("FieldValue.increment",arguments,1),new vo(e)},e.prototype.isEqual=function(e){return this===e},e}(),po=function(e){function t(){return e.call(this,"FieldValue.delete")||this}return a.__extends(t,e),t.instance=new t,t}(ho),fo=function(e){function t(){return e.call(this,"FieldValue.serverTimestamp")||this}return a.__extends(t,e),t.instance=new t,t}(ho),mo=function(e){function t(t){var n=e.call(this,"FieldValue.arrayUnion")||this;return n._elements=t,n}return a.__extends(t,e),t}(ho),go=function(e){function t(t){var n=e.call(this,"FieldValue.arrayRemove")||this;return n._elements=t,n}return a.__extends(t,e),t}(ho),vo=function(e){function t(t){var n=e.call(this,"FieldValue.increment")||this;return n._operand=t,n}return a.__extends(t,e),t}(ho),yo=S(ho,"Use FieldValue.<field>() instead."),bo=/^__.*__$/,wo=function(){function e(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return e.prototype.toMutations=function(e,t){var n=[];return null!==this.fieldMask?n.push(new Et(e,this.data,this.fieldMask,t)):n.push(new St(e,this.data,t)),this.fieldTransforms.length>0&&n.push(new xt(e,this.fieldTransforms)),n},e}(),_o=function(){function e(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return e.prototype.toMutations=function(e,t){var n=[new Et(e,this.data,this.fieldMask,t)];return this.fieldTransforms.length>0&&n.push(new xt(e,this.fieldTransforms)),n},e}();function Co(e){switch(e){case lo.Set:case lo.MergeSet:case lo.Update:return!0;case lo.Argument:case lo.ArrayArgument:return!1;default:throw y("Unexpected case for UserDataSource: "+e)}}!function(e){e[e.Set=0]="Set",e[e.Update=1]="Update",e[e.MergeSet=2]="MergeSet",e[e.Argument=3]="Argument",e[e.ArrayArgument=4]="ArrayArgument"}(lo||(lo={}));var To=function(){function e(e,t,n,r,i,o){this.dataSource=e,this.methodName=t,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return e.prototype.childContextForField=function(t){var n=null==this.path?null:this.path.child(t),r=new e(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(t),r},e.prototype.childContextForFieldPath=function(t){var n=null==this.path?null:this.path.child(t),r=new e(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},e.prototype.childContextForArray=function(t){return new e(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},e.prototype.createError=function(e){var t=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new T(C.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+e+t)},e.prototype.contains=function(e){return void 0!==this.fieldMask.find((function(t){return e.isPrefixOf(t)}))||void 0!==this.fieldTransforms.find((function(t){return e.isPrefixOf(t.field)}))},e.prototype.validatePath=function(){if(null!==this.path)for(var e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))},e.prototype.validatePathSegment=function(e){if(0===e.length)throw this.createError("Document fields must not be empty");if(Co(this.dataSource)&&bo.test(e))throw this.createError('Document fields cannot begin and end with "__"')},e}(),So=function(e,t){this.databaseId=e,this.key=t},Eo=function(){function e(e){this.preConverter=e}return e.prototype.parseSetData=function(e,t){var n=new To(lo.Set,e,de.EMPTY_PATH);Io("Data must be an object, but it was:",n,t);var r=this.parseData(t,n);return new wo(r,null,n.fieldTransforms)},e.prototype.parseMergeData=function(e,t,n){var r=new To(lo.MergeSet,e,de.EMPTY_PATH);Io("Data must be an object, but it was:",r,t);var i,o,a=this.parseData(t,r);if(n){for(var s=new Le(de.comparator),u=0,c=n;u<c.length;u++){var l=c[u],h=void 0;if(l instanceof to)h=l._internalPath;else{if("string"!=typeof l)throw y("Expected stringOrFieldPath to be a string or a FieldPath");h=Ao(e,l)}if(!r.contains(h))throw new T(C.INVALID_ARGUMENT,"Field '"+h+"' is specified in your field mask but missing from your input data.");s=s.add(h)}i=vt.fromSet(s),o=r.fieldTransforms.filter((function(e){return i.covers(e.field)}))}else i=vt.fromArray(r.fieldMask),o=r.fieldTransforms;return new wo(a,i,o)},e.prototype.parseUpdateData=function(e,t){var n=this,r=new To(lo.Update,e,de.EMPTY_PATH);Io("Data must be an object, but it was:",r,t);var i=new Le(de.comparator),o=Ut.EMPTY;k(t,(function(t,a){var s=Ao(e,t),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof po)i=i.add(s);else{var c=n.parseData(a,u);null!=c&&(i=i.add(s),o=o.set(s,c))}}));var a=vt.fromSet(i);return new _o(o,a,r.fieldTransforms)},e.prototype.parseUpdateVarargs=function(e,t,n,r){var i=new To(lo.Update,e,de.EMPTY_PATH),o=[ko(e,t)],a=[n];if(r.length%2!=0)throw new T(C.INVALID_ARGUMENT,"Function "+e+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var s=0;s<r.length;s+=2)o.push(ko(e,r[s])),a.push(r[s+1]);var u=new Le(de.comparator),c=Ut.EMPTY;for(s=0;s<o.length;++s){var l=o[s],h=i.childContextForFieldPath(l),d=this.runPreConverter(a[s],h);if(d instanceof po)u=u.add(l);else{var p=this.parseData(d,h);null!=p&&(u=u.add(l),c=c.set(l,p))}}var f=vt.fromSet(u);return new _o(c,f,i.fieldTransforms)},e.prototype.parseQueryValue=function(e,t,n){void 0===n&&(n=!1);var r=new To(n?lo.ArrayArgument:lo.Argument,e,de.EMPTY_PATH),i=this.parseData(t,r);return b(null!=i,"Parsed data should not be null."),b(0===r.fieldTransforms.length,"Field transforms should have been disallowed."),i},e.prototype.runPreConverter=function(e,t){try{return this.preConverter(e)}catch(r){var n=No(r);throw t.createError(n)}},e.prototype.parseData=function(e,t){if(xo(e=this.runPreConverter(e,t)))return Io("Unsupported field value:",t,e),this.parseObject(e,t);if(e instanceof ho)return this.parseSentinelFieldValue(e,t),null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.arrayElement&&t.dataSource!==lo.ArrayArgument)throw t.createError("Nested arrays are not supported");return this.parseArray(e,t)}return this.parseScalarValue(e,t)},e.prototype.parseObject=function(e,t){var n=this,r=new Ie(X);return A(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):k(e,(function(e,i){var o=n.parseData(i,t.childContextForField(e));null!=o&&(r=r.insert(e,o))})),new Ut(r)},e.prototype.parseArray=function(e,t){for(var n=[],r=0,i=0,o=e;i<o.length;i++){var a=o[i],s=this.parseData(a,t.childContextForArray(r));null==s&&(s=Nt.INSTANCE),n.push(s),r++}return new Ht(n)},e.prototype.parseSentinelFieldValue=function(e,t){if(!Co(t.dataSource))throw t.createError(e._methodName+"() can only be used with update() and set()");if(null===t.path)throw t.createError(e._methodName+"() is not currently supported inside arrays");if(e instanceof po){if(t.dataSource!==lo.MergeSet)throw t.dataSource===lo.Update?(b(t.path.length>0,"FieldValue.delete() at the top level should have already been handled."),t.createError("FieldValue.delete() can only appear at the top level of your update data")):t.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");t.fieldMask.push(t.path)}else if(e instanceof fo)t.fieldTransforms.push(new yt(t.path,ui.instance));else if(e instanceof mo){var n=this.parseArrayTransformElements(e._methodName,e._elements),r=new ci(n);t.fieldTransforms.push(new yt(t.path,r))}else if(e instanceof go){n=this.parseArrayTransformElements(e._methodName,e._elements);var i=new li(n);t.fieldTransforms.push(new yt(t.path,i))}else if(e instanceof vo){var o=this.parseQueryValue("FieldValue.increment",e._operand),a=new hi(o);t.fieldTransforms.push(new yt(t.path,a))}else y("Unknown FieldValue type: "+e)},e.prototype.parseScalarValue=function(e,t){if(null===e)return Nt.INSTANCE;if("number"==typeof e)return Jn(e)?new Mt(e):new Rt(e);if("boolean"==typeof e)return Lt.of(e);if("string"==typeof e)return new Pt(e);if(e instanceof Date)return new Ft(Ee.fromDate(e));if(e instanceof Ee)return new Ft(new Ee(e.seconds,1e3*Math.floor(e.nanoseconds/1e3)));if(e instanceof si)return new Wt(e);if(e instanceof re)return new Bt(e);if(e instanceof So)return new Vt(e.databaseId,e.key);throw t.createError("Unsupported field value: "+H(e))},e.prototype.parseArrayTransformElements=function(e,t){var n=this;return t.map((function(t,r){var i=new To(lo.Argument,e,de.EMPTY_PATH);return n.parseData(t,i.childContextForArray(r))}))},e}();function xo(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Ee||e instanceof si||e instanceof re||e instanceof So||e instanceof ho)}function Io(e,t,n){if(!xo(n)||!U(n)){var r=H(n);throw"an object"===r?t.createError(e+" a custom object"):t.createError(e+" "+r)}}function ko(e,t){if(t instanceof to)return t._internalPath;if("string"==typeof t)return Ao(e,t);throw new T(C.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Ao(e,t){try{return function(e){if(e.search(no)>=0)throw new T(C.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(to.bind.apply(to,a.__spreadArrays([void 0],e.split("."))))}catch(t){throw new T(C.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(t)._internalPath}catch(r){var n=No(r);throw new T(C.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. "+n)}}function No(e){return e instanceof Error?e.message:e.toString()}var Lo="firestore.googleapis.com",Do=!0,Oo=!0,Mo=!1,Ro=On.COLLECTION_DISABLED,Po=function(){function e(e){if(void 0===e.host){if(void 0!==e.ssl)throw new T(C.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Lo,this.ssl=Do}else P("settings","non-empty string","host",e.host),this.host=e.host,F("settings","boolean","ssl",e.ssl),this.ssl=x(e.ssl,Do);if(q("settings",e,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),F("settings","object","credentials",e.credentials),this.credentials=e.credentials,F("settings","boolean","timestampsInSnapshots",e.timestampsInSnapshots),!0===e.timestampsInSnapshots?g("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===e.timestampsInSnapshots&&g("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=x(e.timestampsInSnapshots,Oo),F("settings","number","cacheSizeBytes",e.cacheSizeBytes),void 0===e.cacheSizeBytes)this.cacheSizeBytes=On.DEFAULT_CACHE_SIZE_BYTES;else{if(e.cacheSizeBytes!==Ro&&e.cacheSizeBytes<On.MINIMUM_CACHE_SIZE_BYTES)throw new T(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+On.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=e.cacheSizeBytes}F("settings","boolean","experimentalForceLongPolling",e.experimentalForceLongPolling),this.forceLongPolling=void 0===e.experimentalForceLongPolling?Mo:e.experimentalForceLongPolling}return e.prototype.isEqual=function(e){return this.host===e.host&&this.ssl===e.ssl&&this.timestampsInSnapshots===e.timestampsInSnapshots&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.forceLongPolling===e.forceLongPolling},e}(),Fo=function(){function e(t,n){var r=this;if(this._firebaseApp=null,this._queue=new ge,this.INTERNAL={delete:function(){return a.__awaiter(r,void 0,void 0,(function(){return a.__generator(this,(function(e){switch(e.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.terminate()];case 1:return e.sent(),[2]}}))}))}},"object"==typeof t.options){var i=t;this._firebaseApp=i,this._databaseId=e.databaseIdFromApp(i),this._persistenceKey=i.name,this._credentials=new oo(n)}else{var o=t;if(!o.projectId)throw new T(C.INVALID_ARGUMENT,"Must provide projectId");this._databaseId=new se(o.projectId,o.database),this._persistenceKey="[DEFAULT]",this._credentials=new io}this._settings=new Po({}),this._dataConverter=this.createDataConverter(this._databaseId)}return e.prototype.settings=function(e){if(L("Firestore.settings",arguments,1),M("Firestore.settings","object",1,e),E(e,"persistence"))throw new T(C.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var t=new Po(e);if(this._firestoreClient&&!this._settings.isEqual(t))throw new T(C.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._settings=t,void 0!==t.credentials&&(this._credentials=uo(t.credentials))},e.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},e.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},e.prototype.enablePersistence=function(e){if(this._firestoreClient)throw new T(C.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var t=!1;return e&&(void 0!==e.experimentalTabSynchronization&&g("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),t=x(void 0!==e.synchronizeTabs?e.synchronizeTabs:e.experimentalTabSynchronization,!1)),this.configureClient(new Xi(this._settings.cacheSizeBytes,t))},e.prototype.clearPersistence=function(){var e=this,t=Wn.buildStoragePrefix(this.makeDatabaseInfo()),n=new fe;return this._queue.enqueueAndForgetEvenAfterShutdown((function(){return a.__awaiter(e,void 0,void 0,(function(){var e;return a.__generator(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientTerminated)throw new T(C.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,Wn.clearPersistence(t)];case 1:return r.sent(),n.resolve(),[3,3];case 2:return e=r.sent(),n.reject(e),[3,3];case 3:return[2]}}))}))})),n.promise},e.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()},Object.defineProperty(e.prototype,"_isTerminated",{get:function(){return this.ensureClientConfigured(),this._firestoreClient.clientTerminated},enumerable:!0,configurable:!0}),e.prototype.waitForPendingWrites=function(){return this.ensureClientConfigured(),this._firestoreClient.waitForPendingWrites()},e.prototype.onSnapshotsInSync=function(e){if(this.ensureClientConfigured(),co(e))return this.onSnapshotsInSyncInternal(e);M("Firestore.onSnapshotsInSync","function",1,e);var t={next:e};return this.onSnapshotsInSyncInternal(t)},e.prototype.onSnapshotsInSyncInternal=function(e){var t=this,n=new eo({next:function(){e.next&&e.next()},error:function(e){throw y("Uncaught Error in onSnapshotsInSync")}});return this._firestoreClient.addSnapshotsInSyncListener(n),function(){n.mute(),t._firestoreClient.removeSnapshotsInSyncListener(n)}},e.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Ji),this._firestoreClient},e.prototype.makeDatabaseInfo=function(){return new oe(this._databaseId,this._persistenceKey,this._settings.host,this._settings.ssl,this._settings.forceLongPolling)},e.prototype.configureClient=function(e){b(!!this._settings.host,"FirestoreSettings.host is not set"),b(!this._firestoreClient,"configureClient() called multiple times");var t=this.makeDatabaseInfo();return this._firestoreClient=new Zi(w.getPlatform(),t,this._credentials,this._queue),this._firestoreClient.start(e)},e.prototype.createDataConverter=function(e){return new Eo((function(t){if(t instanceof Vo){var n=e,r=t.firestore._databaseId;if(!r.isEqual(n))throw new T(C.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new So(e,t._key)}return t}))},e.databaseIdFromApp=function(e){var t=e.options;if(!E(t,"projectId"))throw new T(C.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=t.projectId;if(!n||"string"!=typeof n)throw new T(C.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new se(n)},Object.defineProperty(e.prototype,"app",{get:function(){if(!this._firebaseApp)throw new T(C.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._firebaseApp},enumerable:!0,configurable:!0}),e.prototype.collection=function(e){return L("Firestore.collection",arguments,1),M("Firestore.collection","non-empty string",1,e),this.ensureClientConfigured(),new Ko(le.fromString(e),this)},e.prototype.doc=function(e){return L("Firestore.doc",arguments,1),M("Firestore.doc","non-empty string",1,e),this.ensureClientConfigured(),Vo.forPath(le.fromString(e),this)},e.prototype.collectionGroup=function(e){if(L("Firestore.collectionGroup",arguments,1),M("Firestore.collectionGroup","non-empty string",1,e),e.indexOf("/")>=0)throw new T(C.INVALID_ARGUMENT,"Invalid collection ID '"+e+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new zo(new tr(le.EMPTY_PATH,e),this)},e.prototype.runTransaction=function(e){var t=this;return L("Firestore.runTransaction",arguments,1),M("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction((function(n){return e(new jo(t,n))}))},e.prototype.batch=function(){return this.ensureClientConfigured(),new Bo(this)},Object.defineProperty(e,"logLevel",{get:function(){switch(p()){case i.DEBUG:return"debug";case i.ERROR:return"error";case i.SILENT:return"silent";default:return y("Unknown log level: "+p())}},enumerable:!0,configurable:!0}),e.setLogLevel=function(e){switch(L("Firestore.setLogLevel",arguments,1),M("Firestore.setLogLevel","non-empty string",1,e),e){case"debug":f(i.DEBUG);break;case"error":f(i.ERROR);break;case"silent":f(i.SILENT);break;default:throw new T(C.INVALID_ARGUMENT,"Invalid log level: "+e)}},e.prototype._areTimestampsInSnapshotsEnabled=function(){return this._settings.timestampsInSnapshots},e}(),jo=function(){function e(e,t){this._firestore=e,this._transaction=t}return e.prototype.get=function(e){var t=this;L("Transaction.get",arguments,1);var n=Yo("Transaction.get",e,this._firestore);return this._transaction.lookup([n._key]).then((function(e){if(!e||1!==e.length)return y("Mismatch in docs returned from document lookup.");var r=e[0];if(r instanceof Kt)return new Uo(t._firestore,n._key,null,!1,!1,n._converter);if(r instanceof qt)return new Uo(t._firestore,n._key,r,!1,!1,n._converter);throw y("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)}))},e.prototype.set=function(e,t,n){O("Transaction.set",arguments,2,3);var r=Yo("Transaction.set",e,this._firestore);n=Go("Transaction.set",n);var i=Jo(r._converter,t,"Transaction.set"),o=i[0],a=i[1],s=n.merge||n.mergeFields?this._firestore._dataConverter.parseMergeData(a,o,n.mergeFields):this._firestore._dataConverter.parseSetData(a,o);return this._transaction.set(r._key,s),this},e.prototype.update=function(e,t,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return"string"==typeof t||t instanceof to?(D("Transaction.update",arguments,3),r=Yo("Transaction.update",e,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",t,n,o)):(L("Transaction.update",arguments,2),r=Yo("Transaction.update",e,this._firestore),i=this._firestore._dataConverter.parseUpdateData("Transaction.update",t)),this._transaction.update(r._key,i),this},e.prototype.delete=function(e){L("Transaction.delete",arguments,1);var t=Yo("Transaction.delete",e,this._firestore);return this._transaction.delete(t._key),this},e}(),Bo=function(){function e(e){this._firestore=e,this._mutations=[],this._committed=!1}return e.prototype.set=function(e,t,n){O("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=Yo("WriteBatch.set",e,this._firestore);n=Go("WriteBatch.set",n);var i=Jo(r._converter,t,"WriteBatch.set"),o=i[0],a=i[1],s=n.merge||n.mergeFields?this._firestore._dataConverter.parseMergeData(a,o,n.mergeFields):this._firestore._dataConverter.parseSetData(a,o);return this._mutations=this._mutations.concat(s.toMutations(r._key,Ct.NONE)),this},e.prototype.update=function(e,t,n){for(var r,i,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return this.verifyNotCommitted(),"string"==typeof t||t instanceof to?(D("WriteBatch.update",arguments,3),r=Yo("WriteBatch.update",e,this._firestore),i=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",t,n,o)):(L("WriteBatch.update",arguments,2),r=Yo("WriteBatch.update",e,this._firestore),i=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",t)),this._mutations=this._mutations.concat(i.toMutations(r._key,Ct.exists(!0))),this},e.prototype.delete=function(e){L("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var t=Yo("WriteBatch.delete",e,this._firestore);return this._mutations=this._mutations.concat(new It(t._key,Ct.NONE)),this},e.prototype.commit=function(){return a.__awaiter(this,void 0,void 0,(function(){return a.__generator(this,(function(e){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]}))}))},e.prototype.verifyNotCommitted=function(){if(this._committed)throw new T(C.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},e}(),Vo=function(){function e(e,t,n){this._key=e,this.firestore=t,this._converter=n,this._firestoreClient=this.firestore.ensureClientConfigured()}return e.forPath=function(t,n,r){if(t.length%2!=0)throw new T(C.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new e(new pe(t),n,r)},Object.defineProperty(e.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return new Ko(this._key.path.popLast(),this.firestore,this._converter)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.collection=function(e){if(L("DocumentReference.collection",arguments,1),M("DocumentReference.collection","non-empty string",1,e),!e)throw new T(C.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var t=le.fromString(e);return new Ko(this._key.path.child(t),this.firestore)},e.prototype.isEqual=function(t){if(!(t instanceof e))throw K("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.isEqual(t._key)&&this._converter===t._converter},e.prototype.set=function(e,t){O("DocumentReference.set",arguments,1,2),t=Go("DocumentReference.set",t);var n=Jo(this._converter,e,"DocumentReference.set"),r=n[0],i=n[1],o=t.merge||t.mergeFields?this.firestore._dataConverter.parseMergeData(i,r,t.mergeFields):this.firestore._dataConverter.parseSetData(i,r);return this._firestoreClient.write(o.toMutations(this._key,Ct.NONE))},e.prototype.update=function(e,t){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return"string"==typeof e||e instanceof to?(D("DocumentReference.update",arguments,2),n=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",e,t,r)):(L("DocumentReference.update",arguments,1),n=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",e)),this._firestoreClient.write(n.toMutations(this._key,Ct.exists(!0)))},e.prototype.delete=function(){return L("DocumentReference.delete",arguments,0),this._firestoreClient.write([new It(this._key,Ct.NONE)])},e.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];O("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof e[i]||co(e[i])||(q("DocumentReference.onSnapshot",r=e[i],["includeMetadataChanges"]),F("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return co(e[i])?n=e[i]:(M("DocumentReference.onSnapshot","function",i,e[i]),R("DocumentReference.onSnapshot","function",i+1,e[i+1]),R("DocumentReference.onSnapshot","function",i+2,e[i+2]),n={next:e[i],error:e[i+1],complete:e[i+2]}),this.onSnapshotInternal(o,n)},e.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var i=new eo({next:function(e){if(t.next){b(e.docs.size<=1,"Too many documents returned on a document query");var r=e.docs.get(n._key);t.next(new Uo(n.firestore,n._key,r,e.fromCache,e.hasPendingWrites,n._converter))}},error:r}),o=this._firestoreClient.listen(tr.atPath(this._key.path),i,e);return function(){i.mute(),n._firestoreClient.unlisten(o)}},e.prototype.get=function(e){var t=this;return O("DocumentReference.get",arguments,0,1),$o("DocumentReference.get",e),new Promise((function(n,r){e&&"cache"===e.source?t.firestore.ensureClientConfigured().getDocumentFromLocalCache(t._key).then((function(e){n(new Uo(t.firestore,t._key,e,!0,e instanceof qt&&e.hasLocalMutations,t._converter))}),r):t.getViaSnapshotListener(n,r,e)}))},e.prototype.getViaSnapshotListener=function(e,t,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?t(new T(C.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?t(new T(C.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e(i)},error:t})},e.prototype.withConverter=function(t){return new e(this._key,this.firestore,t)},e}(),Wo=function(){function e(e,t){this.hasPendingWrites=e,this.fromCache=t}return e.prototype.isEqual=function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache},e}(),Uo=function(){function e(e,t,n,r,i,o){this._firestore=e,this._key=t,this._document=n,this._fromCache=r,this._hasPendingWrites=i,this._converter=o}return e.prototype.data=function(e){if(O("DocumentSnapshot.data",arguments,0,1),e=Qo("DocumentSnapshot.data",e),this._document){if(this._converter){var t=new Ho(this._firestore,this._key,this._document,this._fromCache,this._hasPendingWrites);return this._converter.fromFirestore(t,e)}return this.toJSObject(this._document.data(),kt.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},e.prototype.get=function(e,t){if(O("DocumentSnapshot.get",arguments,1,2),t=Qo("DocumentSnapshot.get",t),this._document){var n=this._document.data().field(ko("DocumentSnapshot.get",e));if(null!==n)return this.toJSValue(n,kt.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(e.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ref",{get:function(){return new Vo(this._key,this._firestore,this._converter)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metadata",{get:function(){return new Wo(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){if(!(t instanceof e))throw K("isEqual","DocumentSnapshot",1,t);return this._firestore===t._firestore&&this._fromCache===t._fromCache&&this._key.isEqual(t._key)&&(null===this._document?null===t._document:this._document.isEqual(t._document))&&this._converter===t._converter},e.prototype.toJSObject=function(e,t){var n=this,r={};return e.forEach((function(e,i){r[e]=n.toJSValue(i,t)})),r},e.prototype.toJSValue=function(e,t){if(e instanceof Ut)return this.toJSObject(e,t);if(e instanceof Ht)return this.toJSArray(e,t);if(e instanceof Vt){var n=e.value(t),r=this._firestore.ensureClientConfigured().databaseId();return e.databaseId.isEqual(r)||g("Document "+this._key.path+" contains a document reference within a different database ("+e.databaseId.projectId+"/"+e.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new Vo(n,this._firestore,this._converter)}return e.value(t)},e.prototype.toJSArray=function(e,t){var n=this;return e.internalValue.map((function(e){return n.toJSValue(e,t)}))},e}(),Ho=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a.__extends(t,e),t.prototype.data=function(t){var n=e.prototype.data.call(this,t);return b(void 0!==n,"Document in a QueryDocumentSnapshot should exist"),n},t}(Uo),zo=function(){function e(e,t,n){this._query=e,this.firestore=t,this._converter=n}return e.prototype.where=function(t,n,r){L("Query.where",arguments,3),z("Query.where",3,r);var i,o=["<","<=","==",">=",">","array-contains","in","array-contains-any"];V("Query.where",o,2,n);var a=ko("Query.where",t),s=rr.fromString(n);if(a.isKeyField()){if(s===rr.ARRAY_CONTAINS||s===rr.ARRAY_CONTAINS_ANY)throw new T(C.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+s.toString()+"' queries on FieldPath.documentId().");if(s===rr.IN){this.validateDisjunctiveFilterElements(r,s);for(var u=[],c=0,l=r;c<l.length;c++){var h=l[c];u.push(this.parseDocumentIdValue(h))}i=new Ht(u)}else i=this.parseDocumentIdValue(r)}else s!==rr.IN&&s!==rr.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(r,s),i=this.firestore._dataConverter.parseQueryValue("Query.where",r,s===rr.IN);var d=ir.create(a,s,i);return this.validateNewFilter(d),new e(this._query.addFilter(d),this.firestore,this._converter)},e.prototype.orderBy=function(t,n){var r;if(O("Query.orderBy",arguments,1,2),R("Query.orderBy","non-empty string",2,n),void 0===n||"asc"===n)r=lr.ASCENDING;else{if("desc"!==n)throw new T(C.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=lr.DESCENDING}if(null!==this._query.startAt)throw new T(C.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new T(C.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=ko("Query.orderBy",t),o=new dr(i,r);return this.validateNewOrderBy(o),new e(this._query.addOrderBy(o),this.firestore,this._converter)},e.prototype.limit=function(t){return L("Query.limit",arguments,1),M("Query.limit","number",1,t),G("Query.limit",1,t),new e(this._query.withLimitToFirst(t),this.firestore,this._converter)},e.prototype.limitToLast=function(t){return L("Query.limitToLast",arguments,1),M("Query.limitToLast","number",1,t),G("Query.limitToLast",1,t),new e(this._query.withLimitToLast(t),this.firestore,this._converter)},e.prototype.startAt=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];D("Query.startAt",arguments,1);var i=this.boundFromDocOrFields("Query.startAt",t,n,!0);return new e(this._query.withStartAt(i),this.firestore,this._converter)},e.prototype.startAfter=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];D("Query.startAfter",arguments,1);var i=this.boundFromDocOrFields("Query.startAfter",t,n,!1);return new e(this._query.withStartAt(i),this.firestore,this._converter)},e.prototype.endBefore=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];D("Query.endBefore",arguments,1);var i=this.boundFromDocOrFields("Query.endBefore",t,n,!0);return new e(this._query.withEndAt(i),this.firestore,this._converter)},e.prototype.endAt=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];D("Query.endAt",arguments,1);var i=this.boundFromDocOrFields("Query.endAt",t,n,!1);return new e(this._query.withEndAt(i),this.firestore,this._converter)},e.prototype.isEqual=function(t){if(!(t instanceof e))throw K("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.isEqual(t._query)},e.prototype.withConverter=function(t){return new e(this._query,this.firestore,t)},e.prototype.boundFromDocOrFields=function(e,t,n,r){if(z(e,1,t),t instanceof Uo){if(n.length>0)throw new T(C.INVALID_ARGUMENT,"Too many arguments provided to "+e+"().");var i=t;if(!i.exists)throw new T(C.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+e+"().");return this.boundFromDocument(e,i._document,r)}var o=[t].concat(n);return this.boundFromFields(e,o,r)},e.prototype.boundFromDocument=function(e,t,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var a=o[i];if(a.field.isKeyField())r.push(new Vt(this.firestore._databaseId,t.key));else{var s=t.field(a.field);if(s instanceof jt)throw new T(C.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){var u=a.field.canonicalString();throw new T(C.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new hr(r,n)},e.prototype.boundFromFields=function(e,t,n){var r=this._query.explicitOrderBy;if(t.length>r.length)throw new T(C.INVALID_ARGUMENT,"Too many arguments provided to "+e+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<t.length;o++){var a=t[o];if(r[o].field.isKeyField()){if("string"!=typeof a)throw new T(C.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+e+"(), but got a "+typeof a);if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+e+"() must be a plain document ID, but '"+a+"' contains a slash.");var s=this._query.path.child(le.fromString(a));if(!pe.isDocumentKey(s))throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+e+"() must result in a valid document path, but '"+s+"' is not because it contains an odd number of segments.");var u=new pe(s);i.push(new Vt(this.firestore._databaseId,u))}else{var c=this.firestore._dataConverter.parseQueryValue(e,a);i.push(c)}}return new hr(i,n)},e.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];O("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof e[i]||co(e[i])||(q("Query.onSnapshot",r=e[i],["includeMetadataChanges"]),F("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),co(e[i])?n=e[i]:(M("Query.onSnapshot","function",i,e[i]),R("Query.onSnapshot","function",i+1,e[i+1]),R("Query.onSnapshot","function",i+2,e[i+2]),n={next:e[i],error:e[i+1],complete:e[i+2]}),this.validateHasExplicitOrderByForLimitToLast(this._query),this.onSnapshotInternal(r,n)},e.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var i=new eo({next:function(e){t.next&&t.next(new qo(n.firestore,n._query,e,n._converter))},error:r}),o=this.firestore.ensureClientConfigured(),a=o.listen(this._query,i,e);return function(){i.mute(),o.unlisten(a)}},e.prototype.validateHasExplicitOrderByForLimitToLast=function(e){if(e.hasLimitToLast()&&0===e.explicitOrderBy.length)throw new T(C.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")},e.prototype.get=function(e){var t=this;return O("Query.get",arguments,0,1),$o("Query.get",e),this.validateHasExplicitOrderByForLimitToLast(this._query),new Promise((function(n,r){e&&"cache"===e.source?t.firestore.ensureClientConfigured().getDocumentsFromLocalCache(t._query).then((function(e){n(new qo(t.firestore,t._query,e,t._converter))}),r):t.getViaSnapshotListener(n,r,e)}))},e.prototype.getViaSnapshotListener=function(e,t,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?t(new T(C.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e(i)},error:t})},e.prototype.parseDocumentIdValue=function(e){if("string"==typeof e){if(""===e)throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==e.indexOf("/"))throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+e+"' contains a '/' character.");var t=this._query.path.child(le.fromString(e));if(!pe.isDocumentKey(t))throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+t+"' is not because it has an odd number of segments ("+t.length+").");return new Vt(this.firestore._databaseId,new pe(t))}if(e instanceof Vo){var n=e;return new Vt(this.firestore._databaseId,n._key)}throw new T(C.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+H(e)+".")},e.prototype.validateDisjunctiveFilterElements=function(e,t){if(!Array.isArray(e)||0===e.length)throw new T(C.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+t.toString()+"' filters.");if(e.length>10)throw new T(C.INVALID_ARGUMENT,"Invalid Query. '"+t.toString()+"' filters support a maximum of 10 elements in the value array.");if(e.indexOf(null)>=0)throw new T(C.INVALID_ARGUMENT,"Invalid Query. '"+t.toString()+"' filters cannot contain 'null' in the value array.");if(e.filter((function(e){return Number.isNaN(e)})).length>0)throw new T(C.INVALID_ARGUMENT,"Invalid Query. '"+t.toString()+"' filters cannot contain 'NaN' in the value array.")},e.prototype.validateNewFilter=function(e){if(e instanceof ir){var t=[rr.ARRAY_CONTAINS,rr.ARRAY_CONTAINS_ANY],n=[rr.IN,rr.ARRAY_CONTAINS_ANY],r=t.indexOf(e.op)>=0,i=n.indexOf(e.op)>=0;if(e.isInequality()){var o=this._query.getInequalityFilterField();if(null!==o&&!o.isEqual(e.field))throw new T(C.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+o.toString()+"' and '"+e.field.toString()+"'");var a=this._query.getFirstOrderByField();null!==a&&this.validateOrderByAndInequalityMatch(e.field,a)}else if(i||r){var s=null;if(i&&(s=this._query.findFilterOperator(n)),null===s&&r&&(s=this._query.findFilterOperator(t)),null!=s)throw s===e.op?new T(C.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+e.op.toString()+"' filter."):new T(C.INVALID_ARGUMENT,"Invalid query. You cannot use '"+e.op.toString()+"' filters with '"+s.toString()+"' filters.")}}},e.prototype.validateNewOrderBy=function(e){if(null===this._query.getFirstOrderByField()){var t=this._query.getInequalityFilterField();null!==t&&this.validateOrderByAndInequalityMatch(t,e.field)}},e.prototype.validateOrderByAndInequalityMatch=function(e,t){if(!t.isEqual(e))throw new T(C.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+e.toString()+"' and so you must also use '"+e.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+t.toString()+"' instead.")},e}(),qo=function(){function e(e,t,n,r){this._firestore=e,this._originalQuery=t,this._snapshot=n,this._converter=r,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new Wo(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(e.prototype,"docs",{get:function(){var e=[];return this.forEach((function(t){return e.push(t)})),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e,t){var n=this;O("QuerySnapshot.forEach",arguments,1,2),M("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach((function(r){e.call(t,n.convertToDocumentImpl(r))}))},Object.defineProperty(e.prototype,"query",{get:function(){return new zo(this._originalQuery,this._firestore,this._converter)},enumerable:!0,configurable:!0}),e.prototype.docChanges=function(e){e&&(q("QuerySnapshot.docChanges",e,["includeMetadataChanges"]),F("QuerySnapshot.docChanges","boolean","includeMetadataChanges",e.includeMetadataChanges));var t=!(!e||!e.includeMetadataChanges);if(t&&this._snapshot.excludesMetadataChanges)throw new T(C.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t,n,r){if(n.oldDocs.isEmpty()){var i,o=0;return n.docChanges.map((function(t){var a=new Ho(e,t.doc.key,t.doc,n.fromCache,n.mutatedKeys.has(t.doc.key),r);return b(t.type===zr.Added,"Invalid event type for first snapshot"),b(!i||n.query.docComparator(i,t.doc)<0,"Got added events in wrong order"),i=t.doc,{type:"added",doc:a,oldIndex:-1,newIndex:o++}}))}var a=n.oldDocs;return n.docChanges.filter((function(e){return t||e.type!==zr.Metadata})).map((function(t){var i=new Ho(e,t.doc.key,t.doc,n.fromCache,n.mutatedKeys.has(t.doc.key),r),o=-1,s=-1;return t.type!==zr.Added&&(b((o=a.indexOf(t.doc.key))>=0,"Index for document not found"),a=a.delete(t.doc.key)),t.type!==zr.Removed&&(s=(a=a.add(t.doc)).indexOf(t.doc.key)),{type:Xo(t.type),doc:i,oldIndex:o,newIndex:s}}))}(this._firestore,t,this._snapshot,this._converter),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges},e.prototype.isEqual=function(t){if(!(t instanceof e))throw K("isEqual","QuerySnapshot",1,t);return this._firestore===t._firestore&&this._originalQuery.isEqual(t._originalQuery)&&this._snapshot.isEqual(t._snapshot)&&this._converter===t._converter},e.prototype.convertToDocumentImpl=function(e){return new Ho(this._firestore,e.key,e,this.metadata.fromCache,this._snapshot.mutatedKeys.has(e.key),this._converter)},e}();a.__spreadArrays(["length","forEach","map"],"undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach((function(e){try{Object.defineProperty(qo.prototype.docChanges,e,{get:function(){return function(){throw new T(C.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}}));var Ko=function(e){function t(t,n,r){var i=e.call(this,tr.atPath(t),n,r)||this;if(i._path=t,t.length%2!=1)throw new T(C.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return i}return a.__extends(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){var e=this._query.path.popLast();return e.isEmpty()?null:new Vo(new pe(e),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.doc=function(e){if(O("CollectionReference.doc",arguments,0,1),0===arguments.length&&(e=Y.newId()),M("CollectionReference.doc","non-empty string",1,e),""===e)throw new T(C.INVALID_ARGUMENT,"Document path must be a non-empty string");var t=le.fromString(e);return Vo.forPath(this._query.path.child(t),this.firestore,this._converter)},t.prototype.add=function(e){L("CollectionReference.add",arguments,1),M("CollectionReference.add","object",1,e);var t=this.doc();return t.set(e).then((function(){return t}))},t.prototype.withConverter=function(e){return new t(this._path,this.firestore,e)},t}(zo);function Go(e,t){if(void 0===t)return{merge:!1};if(q(e,t,["merge","mergeFields"]),F(e,"boolean","merge",t.merge),j(e,"mergeFields","a string or a FieldPath",t.mergeFields,(function(e){return"string"==typeof e||e instanceof to})),void 0!==t.mergeFields&&void 0!==t.merge)throw new T(C.INVALID_ARGUMENT,"Invalid options passed to function "+e+'(): You cannot specify both "merge" and "mergeFields".');return t}function Qo(e,t){return void 0===t?{}:(q(e,t,["serverTimestamps"]),B(e,0,"serverTimestamps",t.serverTimestamps,["estimate","previous","none"]),t)}function $o(e,t){R(e,"object",1,t),t&&(q(e,t,["source"]),B(e,0,"source",t.source,["default","server","cache"]))}function Yo(e,t,n){if(t instanceof Vo){if(t.firestore!==n)throw new T(C.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}throw K(e,"DocumentReference",1,t)}function Xo(e){switch(e){case zr.Added:return"added";case zr.Modified:case zr.Metadata:return"modified";case zr.Removed:return"removed";default:return y("Unknown change type: "+e)}}function Jo(e,t,n){var r;return e?(r=e.toFirestore(t),n="toFirestore() in "+n):r=t,[r,n]}var Zo=S(Fo,"Use firebase.firestore() instead."),ea=S(jo,"Use firebase.firestore().runTransaction() instead."),ta=S(Bo,"Use firebase.firestore().batch() instead."),na=S(Vo,"Use firebase.firestore().doc() instead."),ra=S(Uo),ia=S(Ho),oa=S(zo),aa=S(qo),sa=S(Ko,"Use firebase.firestore().collection() instead."),ua={Firestore:Zo,GeoPoint:si,Timestamp:Ee,Blob:ie,Transaction:ea,WriteBatch:ta,DocumentReference:na,DocumentSnapshot:ra,Query:oa,QueryDocumentSnapshot:ia,QuerySnapshot:aa,CollectionReference:sa,FieldPath:to,FieldValue:yo,setLogLevel:Fo.setLogLevel,CACHE_SIZE_UNLIMITED:Ro};function ca(e){e.INTERNAL.registerComponent(new c.Component("firestore",(function(e){var t=e.getProvider("app").getImmediate();return new Fo(t,e.getProvider("auth-internal"))}),"PUBLIC").setServiceProps(function(e){b(e&&"object"==typeof e,"shallowCopy() expects object parameter.");var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}(ua)))}var la=function(){function e(){}return e.prototype.addCallback=function(e){},e.prototype.shutdown=function(){},e}(),ha=function(){function e(){var e=this;this.networkAvailableListener=function(){return e.onNetworkAvailable()},this.networkUnavailableListener=function(){return e.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}return e.prototype.addCallback=function(e){this.callbacks.push(e)},e.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},e.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},e.prototype.onNetworkAvailable=function(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(var e=0,t=this.callbacks;e<t.length;e++){(0,t[e])(0)}},e.prototype.onNetworkUnavailable=function(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(var e=0,t=this.callbacks;e<t.length;e++){(0,t[e])(1)}},e.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},e}(),da=function(){function e(e){this.sendFn=e.sendFn,this.closeFn=e.closeFn}return e.prototype.onOpen=function(e){b(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=e},e.prototype.onClose=function(e){b(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=e},e.prototype.onMessage=function(e){b(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=e},e.prototype.close=function(){this.closeFn()},e.prototype.send=function(e){this.sendFn(e)},e.prototype.callOnOpen=function(){b(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},e.prototype.callOnClose=function(e){b(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(e)},e.prototype.callOnMessage=function(e){b(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(e)},e}(),pa="Connection",fa={BatchGetDocuments:"batchGet",Commit:"commit"},ma="gl-js/ fire/"+h,ga=function(){function e(e){this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.baseUrl=t+"://"+e.host,this.forceLongPolling=e.forceLongPolling}return e.prototype.modifyHeadersForRequest=function(e,t){if(t)for(var n in t.authHeaders)t.authHeaders.hasOwnProperty(n)&&(e[n]=t.authHeaders[n]);e["X-Goog-Api-Client"]=ma},e.prototype.invokeRPC=function(e,t,n){var r=this,i=this.makeUrl(e);return new Promise((function(o,s){var u=new l.XhrIo;u.listenOnce(l.EventType.COMPLETE,(function(){try{switch(u.getLastErrorCode()){case l.ErrorCode.NO_ERROR:var t=u.getResponseJson();m(pa,"XHR received:",JSON.stringify(t)),o(t);break;case l.ErrorCode.TIMEOUT:m(pa,'RPC "'+e+'" timed out'),s(new T(C.DEADLINE_EXCEEDED,"Request time out"));break;case l.ErrorCode.HTTP_ERROR:var n=u.getStatus();if(m(pa,'RPC "'+e+'" failed with status:',n,"response text:",u.getResponseText()),n>0){var r=u.getResponseJson().error;if(r&&r.status&&r.message){var i=(a=r.status,c=a.toLowerCase().replace("_","-"),Object.values(C).indexOf(c)>=0?c:C.UNKNOWN);s(new T(i,r.message))}else s(new T(C.UNKNOWN,"Server responded with status "+u.getStatus()))}else m(pa,'RPC "'+e+'" failed'),s(new T(C.UNAVAILABLE,"Connection failed."));break;default:y('RPC "'+e+'" failed with unanticipated webchannel error '+u.getLastErrorCode()+": "+u.getLastError()+", giving up.")}}finally{m(pa,'RPC "'+e+'" completed.')}var a,c}));var c=a.__assign({},t);delete c.database;var h=JSON.stringify(c);m(pa,"XHR sending: ",i+" "+h);var d={"Content-Type":"text/plain"};r.modifyHeadersForRequest(d,n),u.send(i,"POST",h,d,15)}))},e.prototype.invokeStreamingRPC=function(e,t,n){return this.invokeRPC(e,t,n)},e.prototype.openStream=function(e,t){var n=[this.baseUrl,"/","google.firestore.v1.Firestore","/",e,"/channel"],r=l.createWebChannelTransport(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(i.initMessageHeaders,t),u.isReactNative()||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");m(pa,"Creating WebChannel: "+o+" "+i);var a=r.createWebChannel(o,i),s=!1,c=!1,h=new da({sendFn:function(e){c?m(pa,"Not sending because WebChannel is closed:",e):(s||(m(pa,"Opening WebChannel transport."),a.open(),s=!0),m(pa,"WebChannel sending:",e),a.send(e))},closeFn:function(){return a.close()}}),d=function(e,t){a.listen(e,(function(e){try{t(e)}catch(n){setTimeout((function(){throw n}),0)}}))};return d(l.WebChannel.EventType.OPEN,(function(){c||m(pa,"WebChannel transport opened.")})),d(l.WebChannel.EventType.CLOSE,(function(){c||(c=!0,m(pa,"WebChannel transport closed"),h.callOnClose())})),d(l.WebChannel.EventType.ERROR,(function(e){c||(c=!0,m(pa,"WebChannel transport errored:",e),h.callOnClose(new T(C.UNAVAILABLE,"The operation could not be completed")))})),d(l.WebChannel.EventType.MESSAGE,(function(e){var t;if(!c){var n=e.data[0];b(!!n,"Got a webchannel message without data.");var r=n,i=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(i){m(pa,"WebChannel received error:",i);var o=i.status,s=function(e){var t=Br[e];if(void 0!==t)return Ur(t)}(o),u=i.message;void 0===s&&(s=C.INTERNAL,u="Unknown error status: "+o+" with message "+i.message),c=!0,h.callOnClose(new T(s,u)),a.close()}else m(pa,"WebChannel received:",n),h.callOnMessage(n)}})),setTimeout((function(){h.callOnOpen()}),0),h},e.prototype.makeUrl=function(e){var t=fa[e];return b(void 0!==t,"Unknown REST mapping for: "+e),this.baseUrl+"/v1/projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents:"+t},e}(),va=function(){function e(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(e.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),e.prototype.loadConnection=function(e){return Promise.resolve(new ga(e))},e.prototype.newConnectivityMonitor=function(){return ha.isAvailable()?new ha:new la},e.prototype.newSerializer=function(e){return new _i(e,{useProto3Json:!0})},e.prototype.formatJSON=function(e){return JSON.stringify(e)},e.prototype.atob=function(e){return atob(e)},e.prototype.btoa=function(e){return btoa(e)},e}();w.setPlatform(new va);var ya="@firebase/firestore",ba="1.9.1";function wa(e){ca(e),e.registerVersion(ya,ba)}wa(o),t.registerFirestore=wa}).call(this,n("8oxB"))},"6nXr":function(e,t,n){n("Sc3u")("Int32",4,(function(e){return function(t,n,r){return e(this,t,n,r)}}))},"6nsN":function(e,t,n){"use strict";n.r(t);n("t6oF")},"8oxB":function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(e){r=a}}();var u,c=[],l=!1,h=-1;function d(){l&&u&&(l=!1,u.length?c=u.concat(c):h=-1,c.length&&p())}function p(){if(!l){var e=s(d);l=!0;for(var t=c.length;t;){for(u=c,c=[];++h<t;)u&&u[h].run();h=-1,t=c.length}u=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new f(e,t)),1!==c.length||l||s(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},"8rVx":function(e,t){e.exports=function(e){function t(e){"undefined"!=typeof console&&(console.error||console.log)("[Script Loader]",e)}try{"undefined"!=typeof execScript&&"undefined"!=typeof attachEvent&&"undefined"==typeof addEventListener?execScript(e):"undefined"!=typeof eval?eval.call(null,e):t("EvalError: No eval function available")}catch(n){t(n)}}},ARus:function(e,t,n){"use strict";n.d(t,"b",(function(){return p}));n("Ll4R");var r=n("q1tI"),i=n.n(r),o=(n("hmp0"),n("h3sT")),a=n("O6Fj"),s=n.n(a),u=n("zEh/"),c=n("if7W"),l=n("YtDf"),h=n.n(l);function d(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)}function p(e,t){if(!t)return!1;var n=Math.round(t.currentTime-e.time);return n<=2&&n>=0}t.a=function(e){var t=e.pos,n=e.getPane,a=e.remove,l=e.annotation,f=e.onMove,m=e.comment,g=e.onSave,v=e.onChange,y=Object(r.useState)(!d()||!m),b=y[0],w=y[1],_=Object(r.useState)(!1),C=_[0],T=_[1];Object(r.useEffect)((function(){return document.addEventListener("dragover",(function(e){return e.preventDefault()}),!1)}),[]);var S=-1!==window.location.href.indexOf("/all"),E=-1*(Math.min(125,t.x-15)+Math.max(140-(n().offsetWidth-t.x),0))+"px",x=t.y>=n().offsetHeight/2?"-100%":0;return i.a.createElement("div",{style:{top:t.y,left:t.x},className:(m?"":"emptytext")+" annotation "+(C?"hasFocus":"")+" "+(l.time?p(l,n())?"visibletime":"hiddentime":"")},i.a.createElement((function(){return i.a.createElement("div",{draggable:!0,onDrag:function(e){e.nativeEvent.target.parentElement.style.top=e.nativeEvent.pageY-n().getBoundingClientRect().top+"px",e.nativeEvent.target.parentElement.style.left=e.nativeEvent.pageX-n().getBoundingClientRect().left+"px"},onDragEnd:function(e){return f({x:e.nativeEvent.pageX-n().getBoundingClientRect().left,y:e.nativeEvent.pageY-n().getBoundingClientRect().top})},className:"annoicon",onClick:function(){return w(!b)}})}),null),i.a.createElement("div",{style:{display:b?"block":"none",transform:"translate("+E+","+x+")"},className:"arrow_box"},!S&&i.a.createElement(s.a,{className:"marktextarea",required:!0,autoFocus:!m,onBlur:function(){m&&g(),setTimeout((function(){return T(!1)}),100)},value:m,onFocus:function(){return T(!0)},onChange:function(e){return v(e.target.value)},name:"comment",placeholder:c.a.annotator.type},m),S&&i.a.createElement("div",{className:"marktextarea"},i.a.createElement(h.a,null,m)),!m&&i.a.createElement((function(){return i.a.createElement("input",{accept:"image/x-png,image/gif,image/jpeg",onChange:function(e){Object(u.a)(e.target,(function(e){v(e),g(),w(!d())}),null,null)},type:"file"})}),null),l.time&&!!m&&i.a.createElement((function(){return i.a.createElement("a",{onClick:function(){return n().currentTime=l.time},className:"timestamp"},c.a.annotator.second," ",Math.floor(100*l.time)/100)}),null),i.a.createElement((function(){return i.a.createElement(o.a,{tagName:"button",onClick:function(e){g(),w(!d())}},"Speichern")}),null),!S&&i.a.createElement((function(){return i.a.createElement("img",{className:"binicon",onClick:function(e){a(e)},src:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxNnB4IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxNiAxNiIgd2lkdGg9IjE2cHgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6c2tldGNoPSJodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2gvbnMiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48dGl0bGUvPjxkZWZzLz48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGlkPSJJY29ucyB3aXRoIG51bWJlcnMiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIj48ZyBmaWxsPSIjMDAwMDAwIiBpZD0iR3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0zMzYuMDAwMDAwLCAtMTkyLjAwMDAwMCkiPjxwYXRoIGQ9Ik0zNDcuOTk5OTU5LDE5NSBMMzUwLDE5NSBMMzUwLDE5NiBMMzQ5LDE5NiBMMzQ5LDIwNy4wMDE0OTggQzM0OSwyMDcuNTUyNTExIDM0OC41NTQyNjUsMjA4IDM0OC4wMDQ0MjMsMjA4IEwzMzguOTk1NTc3LDIwOCBDMzM4LjQ0NDgzNywyMDggMzM4LDIwNy41NTI5NTUgMzM4LDIwNy4wMDE0OTggTDMzOCwxOTYgTDMzNywxOTYgTDMzNywxOTUgTDMzOC45OTU1NzcsMTk1IEwzMzkuMDAwMDQyLDE5NSBMMzM5LDE5NC45OTA2MzEgTDMzOSwxOTMuMDA5MzY5IEMzMzksMTkyLjQ0MzM1MyAzMzkuNDQ2NjE2LDE5MiAzMzkuOTk3NTQ1LDE5MiBMMzQ3LjAwMjQ1NSwxOTIgQzM0Ny41NTM2ODksMTkyIDM0OCwxOTIuNDUxOTEgMzQ4LDE5My4wMDkzNjkgTDM0OCwxOTQuOTkwNjMxIFogTTM0MCwxOTQgTDM0MCwxOTUgTDM0NywxOTUgTDM0NywxOTQgQzM0NywxOTMuNDQ3NzE1IDM0Ni41NTIyODUsMTkzIDM0NiwxOTMgTDM0MSwxOTMgQzM0MC40NDc3MTUsMTkzIDM0MCwxOTMuNDQ3NzE1IDM0MCwxOTQgWiBNMzM5LDE5NiBMMzM5LDIwNyBMMzQ4LDIwNyBMMzQ4LDE5NiBaIE0zNDEsMTk3IEwzNDIsMTk3IEwzNDIsMjA2IEwzNDEsMjA2IFogTTM0MywxOTcgTDM0NCwxOTcgTDM0NCwyMDYgTDM0MywyMDYgWiBNMzQ1LDE5NyBMMzQ1LDIwNiBMMzQ2LDIwNiBMMzQ2LDE5NyBMMzQ1LDE5NyBaIE0zNDUsMTk3IiBpZD0iUmVjdGFuZ2xlIDE1OSIvPjwvZz48L2c+PC9zdmc+",alt:"remove comment icon"})}),null)))}},CNgt:function(e,t,n){"use strict";n("4DPX"),n("sc67"),n("E5k/"),n("pS08"),n("LagC");var r,i=this&&this.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},a=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n};t.__esModule=!0;var s=n("q1tI"),u=n("17x9"),c=n("GemG"),l=n("Rk8H"),h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={lineHeight:null},t.textarea=t.props.innerRef||s.createRef(),t.onResize=function(e){t.props.onResize&&t.props.onResize(e)},t.updateLineHeight=function(){t.textarea.current&&t.setState({lineHeight:l(t.textarea.current)})},t.onChange=function(e){var n=t.props.onChange;t.currentValue=e.currentTarget.value,n&&n(e)},t}return i(t,e),t.prototype.componentDidMount=function(){var e=this,t=this.props,n=t.maxRows,r=t.async;"number"==typeof n&&this.updateLineHeight(),"number"==typeof n||r?setTimeout((function(){return e.textarea.current&&c(e.textarea.current)})):this.textarea.current&&c(this.textarea.current),this.textarea.current&&this.textarea.current.addEventListener("autosize:resized",this.onResize)},t.prototype.componentWillUnmount=function(){this.textarea.current&&(this.textarea.current.removeEventListener("autosize:resized",this.onResize),c.destroy(this.textarea.current))},t.prototype.render=function(){var e=this.props,t=(e.onResize,e.maxRows),n=(e.onChange,e.style),r=(e.innerRef,e.children),i=a(e,["onResize","maxRows","onChange","style","innerRef","children"]),u=this.state.lineHeight,c=t&&u?u*t:null;return s.createElement("textarea",o({},i,{onChange:this.onChange,style:c?o({},n,{maxHeight:c}):n,ref:this.textarea}),r)},t.prototype.componentDidUpdate=function(){this.textarea.current&&c.update(this.textarea.current)},t.defaultProps={rows:1,async:!1},t.propTypes={rows:u.number,maxRows:u.number,onResize:u.func,innerRef:u.object,async:u.bool},t}(s.Component);t.TextareaAutosize=s.forwardRef((function(e,t){return s.createElement(h,o({},e,{innerRef:t}))}))},CnIf:function(e,t){e.exports='require("core-js/modules/es6.array.sort");\n\nrequire("core-js/modules/es6.string.anchor");\n\nrequire("core-js/modules/es6.regexp.to-string");\n\nrequire("core-js/modules/es6.date.to-string");\n\nrequire("core-js/modules/es6.object.to-string");\n\nrequire("core-js/modules/es6.array.map");\n\nrequire("core-js/modules/es6.array.find");\n\nrequire("core-js/modules/es6.regexp.replace");\n\nrequire("core-js/modules/es6.function.name");\n\nrequire("core-js/modules/es6.object.create");\n\nrequire("core-js/modules/es6.array.index-of");\n\nrequire("core-js/modules/es6.regexp.search");\n\nrequire("core-js/modules/es6.regexp.split");\n\nrequire("core-js/modules/es6.regexp.constructor");\n\nrequire("core-js/modules/es6.number.constructor");\n\nrequire("core-js/modules/es6.regexp.match");\n\n// CodeMirror, copyright (c) by Marijn Haverbeke and others\n// Distributed under an MIT license: https://codemirror.net/LICENSE\n// This is CodeMirror (https://codemirror.net), a code editor\n// implemented in JavaScript on top of the browser\'s DOM.\n//\n// You can find some technical background for some of the code below\n// at http://marijnhaverbeke.nl/blog/#cm-internals .\n(function (global, factory) {\n  typeof exports === \'object\' && typeof module !== \'undefined\' ? module.exports = factory() : typeof define === \'function\' && define.amd ? define(factory) : (global = global || self, global.CodeMirror = factory());\n})(this, function () {\n  \'use strict\'; // Kludges for bugs and behavior differences that can\'t be feature\n  // detected are enabled based on userAgent etc sniffing.\n\n  var userAgent = navigator.userAgent;\n  var platform = navigator.platform;\n  var gecko = /gecko\\/\\d/i.test(userAgent);\n  var ie_upto10 = /MSIE \\d/.test(userAgent);\n  var ie_11up = /Trident\\/(?:[7-9]|\\d{2,})\\..*rv:(\\d+)/.exec(userAgent);\n  var edge = /Edge\\/(\\d+)/.exec(userAgent);\n  var ie = ie_upto10 || ie_11up || edge;\n  var ie_version = ie && (ie_upto10 ? document.documentMode || 6 : +(edge || ie_11up)[1]);\n  var webkit = !edge && /WebKit\\//.test(userAgent);\n  var qtwebkit = webkit && /Qt\\/\\d+\\.\\d+/.test(userAgent);\n  var chrome = !edge && /Chrome\\//.test(userAgent);\n  var presto = /Opera\\//.test(userAgent);\n  var safari = /Apple Computer/.test(navigator.vendor);\n  var mac_geMountainLion = /Mac OS X 1\\d\\D([8-9]|\\d\\d)\\D/.test(userAgent);\n  var phantom = /PhantomJS/.test(userAgent);\n  var ios = !edge && /AppleWebKit/.test(userAgent) && /Mobile\\/\\w+/.test(userAgent);\n  var android = /Android/.test(userAgent); // This is woefully incomplete. Suggestions for alternative methods welcome.\n\n  var mobile = ios || android || /webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(userAgent);\n  var mac = ios || /Mac/.test(platform);\n  var chromeOS = /\\bCrOS\\b/.test(userAgent);\n  var windows = /win/i.test(platform);\n  var presto_version = presto && userAgent.match(/Version\\/(\\d*\\.\\d*)/);\n\n  if (presto_version) {\n    presto_version = Number(presto_version[1]);\n  }\n\n  if (presto_version && presto_version >= 15) {\n    presto = false;\n    webkit = true;\n  } // Some browsers use the wrong event properties to signal cmd/ctrl on OS X\n\n\n  var flipCtrlCmd = mac && (qtwebkit || presto && (presto_version == null || presto_version < 12.11));\n  var captureRightClick = gecko || ie && ie_version >= 9;\n\n  function classTest(cls) {\n    return new RegExp("(^|\\\\s)" + cls + "(?:$|\\\\s)\\\\s*");\n  }\n\n  var rmClass = function rmClass(node, cls) {\n    var current = node.className;\n    var match = classTest(cls).exec(current);\n\n    if (match) {\n      var after = current.slice(match.index + match[0].length);\n      node.className = current.slice(0, match.index) + (after ? match[1] + after : "");\n    }\n  };\n\n  function removeChildren(e) {\n    for (var count = e.childNodes.length; count > 0; --count) {\n      e.removeChild(e.firstChild);\n    }\n\n    return e;\n  }\n\n  function removeChildrenAndAdd(parent, e) {\n    return removeChildren(parent).appendChild(e);\n  }\n\n  function elt(tag, content, className, style) {\n    var e = document.createElement(tag);\n\n    if (className) {\n      e.className = className;\n    }\n\n    if (style) {\n      e.style.cssText = style;\n    }\n\n    if (typeof content == "string") {\n      e.appendChild(document.createTextNode(content));\n    } else if (content) {\n      for (var i = 0; i < content.length; ++i) {\n        e.appendChild(content[i]);\n      }\n    }\n\n    return e;\n  } // wrapper for elt, which removes the elt from the accessibility tree\n\n\n  function eltP(tag, content, className, style) {\n    var e = elt(tag, content, className, style);\n    e.setAttribute("role", "presentation");\n    return e;\n  }\n\n  var range;\n\n  if (document.createRange) {\n    range = function range(node, start, end, endNode) {\n      var r = document.createRange();\n      r.setEnd(endNode || node, end);\n      r.setStart(node, start);\n      return r;\n    };\n  } else {\n    range = function range(node, start, end) {\n      var r = document.body.createTextRange();\n\n      try {\n        r.moveToElementText(node.parentNode);\n      } catch (e) {\n        return r;\n      }\n\n      r.collapse(true);\n      r.moveEnd("character", end);\n      r.moveStart("character", start);\n      return r;\n    };\n  }\n\n  function contains(parent, child) {\n    if (child.nodeType == 3) // Android browser always returns false when child is a textnode\n      {\n        child = child.parentNode;\n      }\n\n    if (parent.contains) {\n      return parent.contains(child);\n    }\n\n    do {\n      if (child.nodeType == 11) {\n        child = child.host;\n      }\n\n      if (child == parent) {\n        return true;\n      }\n    } while (child = child.parentNode);\n  }\n\n  function activeElt() {\n    // IE and Edge may throw an "Unspecified Error" when accessing document.activeElement.\n    // IE < 10 will throw when accessed while the page is loading or in an iframe.\n    // IE > 9 and Edge will throw when accessed in an iframe if document.body is unavailable.\n    var activeElement;\n\n    try {\n      activeElement = document.activeElement;\n    } catch (e) {\n      activeElement = document.body || null;\n    }\n\n    while (activeElement && activeElement.shadowRoot && activeElement.shadowRoot.activeElement) {\n      activeElement = activeElement.shadowRoot.activeElement;\n    }\n\n    return activeElement;\n  }\n\n  function addClass(node, cls) {\n    var current = node.className;\n\n    if (!classTest(cls).test(current)) {\n      node.className += (current ? " " : "") + cls;\n    }\n  }\n\n  function joinClasses(a, b) {\n    var as = a.split(" ");\n\n    for (var i = 0; i < as.length; i++) {\n      if (as[i] && !classTest(as[i]).test(b)) {\n        b += " " + as[i];\n      }\n    }\n\n    return b;\n  }\n\n  var selectInput = function selectInput(node) {\n    node.select();\n  };\n\n  if (ios) // Mobile Safari apparently has a bug where select() is broken.\n    {\n      selectInput = function selectInput(node) {\n        node.selectionStart = 0;\n        node.selectionEnd = node.value.length;\n      };\n    } else if (ie) // Suppress mysterious IE10 errors\n    {\n      selectInput = function selectInput(node) {\n        try {\n          node.select();\n        } catch (_e) {}\n      };\n    }\n\n  function bind(f) {\n    var args = Array.prototype.slice.call(arguments, 1);\n    return function () {\n      return f.apply(null, args);\n    };\n  }\n\n  function copyObj(obj, target, overwrite) {\n    if (!target) {\n      target = {};\n    }\n\n    for (var prop in obj) {\n      if (obj.hasOwnProperty(prop) && (overwrite !== false || !target.hasOwnProperty(prop))) {\n        target[prop] = obj[prop];\n      }\n    }\n\n    return target;\n  } // Counts the column offset in a string, taking tabs into account.\n  // Used mostly to find indentation.\n\n\n  function countColumn(string, end, tabSize, startIndex, startValue) {\n    if (end == null) {\n      end = string.search(/[^\\s\\u00a0]/);\n\n      if (end == -1) {\n        end = string.length;\n      }\n    }\n\n    for (var i = startIndex || 0, n = startValue || 0;;) {\n      var nextTab = string.indexOf("\\t", i);\n\n      if (nextTab < 0 || nextTab >= end) {\n        return n + (end - i);\n      }\n\n      n += nextTab - i;\n      n += tabSize - n % tabSize;\n      i = nextTab + 1;\n    }\n  }\n\n  var Delayed = function Delayed() {\n    this.id = null;\n    this.f = null;\n    this.time = 0;\n    this.handler = bind(this.onTimeout, this);\n  };\n\n  Delayed.prototype.onTimeout = function (self) {\n    self.id = 0;\n\n    if (self.time <= +new Date()) {\n      self.f();\n    } else {\n      setTimeout(self.handler, self.time - +new Date());\n    }\n  };\n\n  Delayed.prototype.set = function (ms, f) {\n    this.f = f;\n    var time = +new Date() + ms;\n\n    if (!this.id || time < this.time) {\n      clearTimeout(this.id);\n      this.id = setTimeout(this.handler, ms);\n      this.time = time;\n    }\n  };\n\n  function indexOf(array, elt) {\n    for (var i = 0; i < array.length; ++i) {\n      if (array[i] == elt) {\n        return i;\n      }\n    }\n\n    return -1;\n  } // Number of pixels added to scroller and sizer to hide scrollbar\n\n\n  var scrollerGap = 30; // Returned or thrown by various protocols to signal \'I\'m not\n  // handling this\'.\n\n  var Pass = {\n    toString: function toString() {\n      return "CodeMirror.Pass";\n    }\n  }; // Reused option objects for setSelection & friends\n\n  var sel_dontScroll = {\n    scroll: false\n  },\n      sel_mouse = {\n    origin: "*mouse"\n  },\n      sel_move = {\n    origin: "+move"\n  }; // The inverse of countColumn -- find the offset that corresponds to\n  // a particular column.\n\n  function findColumn(string, goal, tabSize) {\n    for (var pos = 0, col = 0;;) {\n      var nextTab = string.indexOf("\\t", pos);\n\n      if (nextTab == -1) {\n        nextTab = string.length;\n      }\n\n      var skipped = nextTab - pos;\n\n      if (nextTab == string.length || col + skipped >= goal) {\n        return pos + Math.min(skipped, goal - col);\n      }\n\n      col += nextTab - pos;\n      col += tabSize - col % tabSize;\n      pos = nextTab + 1;\n\n      if (col >= goal) {\n        return pos;\n      }\n    }\n  }\n\n  var spaceStrs = [""];\n\n  function spaceStr(n) {\n    while (spaceStrs.length <= n) {\n      spaceStrs.push(lst(spaceStrs) + " ");\n    }\n\n    return spaceStrs[n];\n  }\n\n  function lst(arr) {\n    return arr[arr.length - 1];\n  }\n\n  function map(array, f) {\n    var out = [];\n\n    for (var i = 0; i < array.length; i++) {\n      out[i] = f(array[i], i);\n    }\n\n    return out;\n  }\n\n  function insertSorted(array, value, score) {\n    var pos = 0,\n        priority = score(value);\n\n    while (pos < array.length && score(array[pos]) <= priority) {\n      pos++;\n    }\n\n    array.splice(pos, 0, value);\n  }\n\n  function nothing() {}\n\n  function createObj(base, props) {\n    var inst;\n\n    if (Object.create) {\n      inst = Object.create(base);\n    } else {\n      nothing.prototype = base;\n      inst = new nothing();\n    }\n\n    if (props) {\n      copyObj(props, inst);\n    }\n\n    return inst;\n  }\n\n  var nonASCIISingleCaseWordChar = /[\\u00df\\u0587\\u0590-\\u05f4\\u0600-\\u06ff\\u3040-\\u309f\\u30a0-\\u30ff\\u3400-\\u4db5\\u4e00-\\u9fcc\\uac00-\\ud7af]/;\n\n  function isWordCharBasic(ch) {\n    return /\\w/.test(ch) || ch > "\\x80" && (ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch));\n  }\n\n  function isWordChar(ch, helper) {\n    if (!helper) {\n      return isWordCharBasic(ch);\n    }\n\n    if (helper.source.indexOf("\\\\w") > -1 && isWordCharBasic(ch)) {\n      return true;\n    }\n\n    return helper.test(ch);\n  }\n\n  function isEmpty(obj) {\n    for (var n in obj) {\n      if (obj.hasOwnProperty(n) && obj[n]) {\n        return false;\n      }\n    }\n\n    return true;\n  } // Extending unicode characters. A series of a non-extending char +\n  // any number of extending chars is treated as a single unit as far\n  // as editing and measuring is concerned. This is not fully correct,\n  // since some scripts/fonts/browsers also treat other configurations\n  // of code points as a group.\n\n\n  var extendingChars = /[\\u0300-\\u036f\\u0483-\\u0489\\u0591-\\u05bd\\u05bf\\u05c1\\u05c2\\u05c4\\u05c5\\u05c7\\u0610-\\u061a\\u064b-\\u065e\\u0670\\u06d6-\\u06dc\\u06de-\\u06e4\\u06e7\\u06e8\\u06ea-\\u06ed\\u0711\\u0730-\\u074a\\u07a6-\\u07b0\\u07eb-\\u07f3\\u0816-\\u0819\\u081b-\\u0823\\u0825-\\u0827\\u0829-\\u082d\\u0900-\\u0902\\u093c\\u0941-\\u0948\\u094d\\u0951-\\u0955\\u0962\\u0963\\u0981\\u09bc\\u09be\\u09c1-\\u09c4\\u09cd\\u09d7\\u09e2\\u09e3\\u0a01\\u0a02\\u0a3c\\u0a41\\u0a42\\u0a47\\u0a48\\u0a4b-\\u0a4d\\u0a51\\u0a70\\u0a71\\u0a75\\u0a81\\u0a82\\u0abc\\u0ac1-\\u0ac5\\u0ac7\\u0ac8\\u0acd\\u0ae2\\u0ae3\\u0b01\\u0b3c\\u0b3e\\u0b3f\\u0b41-\\u0b44\\u0b4d\\u0b56\\u0b57\\u0b62\\u0b63\\u0b82\\u0bbe\\u0bc0\\u0bcd\\u0bd7\\u0c3e-\\u0c40\\u0c46-\\u0c48\\u0c4a-\\u0c4d\\u0c55\\u0c56\\u0c62\\u0c63\\u0cbc\\u0cbf\\u0cc2\\u0cc6\\u0ccc\\u0ccd\\u0cd5\\u0cd6\\u0ce2\\u0ce3\\u0d3e\\u0d41-\\u0d44\\u0d4d\\u0d57\\u0d62\\u0d63\\u0dca\\u0dcf\\u0dd2-\\u0dd4\\u0dd6\\u0ddf\\u0e31\\u0e34-\\u0e3a\\u0e47-\\u0e4e\\u0eb1\\u0eb4-\\u0eb9\\u0ebb\\u0ebc\\u0ec8-\\u0ecd\\u0f18\\u0f19\\u0f35\\u0f37\\u0f39\\u0f71-\\u0f7e\\u0f80-\\u0f84\\u0f86\\u0f87\\u0f90-\\u0f97\\u0f99-\\u0fbc\\u0fc6\\u102d-\\u1030\\u1032-\\u1037\\u1039\\u103a\\u103d\\u103e\\u1058\\u1059\\u105e-\\u1060\\u1071-\\u1074\\u1082\\u1085\\u1086\\u108d\\u109d\\u135f\\u1712-\\u1714\\u1732-\\u1734\\u1752\\u1753\\u1772\\u1773\\u17b7-\\u17bd\\u17c6\\u17c9-\\u17d3\\u17dd\\u180b-\\u180d\\u18a9\\u1920-\\u1922\\u1927\\u1928\\u1932\\u1939-\\u193b\\u1a17\\u1a18\\u1a56\\u1a58-\\u1a5e\\u1a60\\u1a62\\u1a65-\\u1a6c\\u1a73-\\u1a7c\\u1a7f\\u1b00-\\u1b03\\u1b34\\u1b36-\\u1b3a\\u1b3c\\u1b42\\u1b6b-\\u1b73\\u1b80\\u1b81\\u1ba2-\\u1ba5\\u1ba8\\u1ba9\\u1c2c-\\u1c33\\u1c36\\u1c37\\u1cd0-\\u1cd2\\u1cd4-\\u1ce0\\u1ce2-\\u1ce8\\u1ced\\u1dc0-\\u1de6\\u1dfd-\\u1dff\\u200c\\u200d\\u20d0-\\u20f0\\u2cef-\\u2cf1\\u2de0-\\u2dff\\u302a-\\u302f\\u3099\\u309a\\ua66f-\\ua672\\ua67c\\ua67d\\ua6f0\\ua6f1\\ua802\\ua806\\ua80b\\ua825\\ua826\\ua8c4\\ua8e0-\\ua8f1\\ua926-\\ua92d\\ua947-\\ua951\\ua980-\\ua982\\ua9b3\\ua9b6-\\ua9b9\\ua9bc\\uaa29-\\uaa2e\\uaa31\\uaa32\\uaa35\\uaa36\\uaa43\\uaa4c\\uaab0\\uaab2-\\uaab4\\uaab7\\uaab8\\uaabe\\uaabf\\uaac1\\uabe5\\uabe8\\uabed\\udc00-\\udfff\\ufb1e\\ufe00-\\ufe0f\\ufe20-\\ufe26\\uff9e\\uff9f]/;\n\n  function isExtendingChar(ch) {\n    return ch.charCodeAt(0) >= 768 && extendingChars.test(ch);\n  } // Returns a number from the range [`0`; `str.length`] unless `pos` is outside that range.\n\n\n  function skipExtendingChars(str, pos, dir) {\n    while ((dir < 0 ? pos > 0 : pos < str.length) && isExtendingChar(str.charAt(pos))) {\n      pos += dir;\n    }\n\n    return pos;\n  } // Returns the value from the range [`from`; `to`] that satisfies\n  // `pred` and is closest to `from`. Assumes that at least `to`\n  // satisfies `pred`. Supports `from` being greater than `to`.\n\n\n  function findFirst(pred, from, to) {\n    // At any point we are certain `to` satisfies `pred`, don\'t know\n    // whether `from` does.\n    var dir = from > to ? -1 : 1;\n\n    for (;;) {\n      if (from == to) {\n        return from;\n      }\n\n      var midF = (from + to) / 2,\n          mid = dir < 0 ? Math.ceil(midF) : Math.floor(midF);\n\n      if (mid == from) {\n        return pred(mid) ? from : to;\n      }\n\n      if (pred(mid)) {\n        to = mid;\n      } else {\n        from = mid + dir;\n      }\n    }\n  } // BIDI HELPERS\n\n\n  function iterateBidiSections(order, from, to, f) {\n    if (!order) {\n      return f(from, to, "ltr", 0);\n    }\n\n    var found = false;\n\n    for (var i = 0; i < order.length; ++i) {\n      var part = order[i];\n\n      if (part.from < to && part.to > from || from == to && part.to == from) {\n        f(Math.max(part.from, from), Math.min(part.to, to), part.level == 1 ? "rtl" : "ltr", i);\n        found = true;\n      }\n    }\n\n    if (!found) {\n      f(from, to, "ltr");\n    }\n  }\n\n  var bidiOther = null;\n\n  function getBidiPartAt(order, ch, sticky) {\n    var found;\n    bidiOther = null;\n\n    for (var i = 0; i < order.length; ++i) {\n      var cur = order[i];\n\n      if (cur.from < ch && cur.to > ch) {\n        return i;\n      }\n\n      if (cur.to == ch) {\n        if (cur.from != cur.to && sticky == "before") {\n          found = i;\n        } else {\n          bidiOther = i;\n        }\n      }\n\n      if (cur.from == ch) {\n        if (cur.from != cur.to && sticky != "before") {\n          found = i;\n        } else {\n          bidiOther = i;\n        }\n      }\n    }\n\n    return found != null ? found : bidiOther;\n  } // Bidirectional ordering algorithm\n  // See http://unicode.org/reports/tr9/tr9-13.html for the algorithm\n  // that this (partially) implements.\n  // One-char codes used for character types:\n  // L (L):   Left-to-Right\n  // R (R):   Right-to-Left\n  // r (AL):  Right-to-Left Arabic\n  // 1 (EN):  European Number\n  // + (ES):  European Number Separator\n  // % (ET):  European Number Terminator\n  // n (AN):  Arabic Number\n  // , (CS):  Common Number Separator\n  // m (NSM): Non-Spacing Mark\n  // b (BN):  Boundary Neutral\n  // s (B):   Paragraph Separator\n  // t (S):   Segment Separator\n  // w (WS):  Whitespace\n  // N (ON):  Other Neutrals\n  // Returns null if characters are ordered as they appear\n  // (left-to-right), or an array of sections ({from, to, level}\n  // objects) in the order in which they occur visually.\n\n\n  var bidiOrdering = function () {\n    // Character types for codepoints 0 to 0xff\n    var lowTypes = "bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN"; // Character types for codepoints 0x600 to 0x6f9\n\n    var arabicTypes = "nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";\n\n    function charType(code) {\n      if (code <= 0xf7) {\n        return lowTypes.charAt(code);\n      } else if (0x590 <= code && code <= 0x5f4) {\n        return "R";\n      } else if (0x600 <= code && code <= 0x6f9) {\n        return arabicTypes.charAt(code - 0x600);\n      } else if (0x6ee <= code && code <= 0x8ac) {\n        return "r";\n      } else if (0x2000 <= code && code <= 0x200b) {\n        return "w";\n      } else if (code == 0x200c) {\n        return "b";\n      } else {\n        return "L";\n      }\n    }\n\n    var bidiRE = /[\\u0590-\\u05f4\\u0600-\\u06ff\\u0700-\\u08ac]/;\n    var isNeutral = /[stwN]/,\n        isStrong = /[LRr]/,\n        countsAsLeft = /[Lb1n]/,\n        countsAsNum = /[1n]/;\n\n    function BidiSpan(level, from, to) {\n      this.level = level;\n      this.from = from;\n      this.to = to;\n    }\n\n    return function (str, direction) {\n      var outerType = direction == "ltr" ? "L" : "R";\n\n      if (str.length == 0 || direction == "ltr" && !bidiRE.test(str)) {\n        return false;\n      }\n\n      var len = str.length,\n          types = [];\n\n      for (var i = 0; i < len; ++i) {\n        types.push(charType(str.charCodeAt(i)));\n      } // W1. Examine each non-spacing mark (NSM) in the level run, and\n      // change the type of the NSM to the type of the previous\n      // character. If the NSM is at the start of the level run, it will\n      // get the type of sor.\n\n\n      for (var i$1 = 0, prev = outerType; i$1 < len; ++i$1) {\n        var type = types[i$1];\n\n        if (type == "m") {\n          types[i$1] = prev;\n        } else {\n          prev = type;\n        }\n      } // W2. Search backwards from each instance of a European number\n      // until the first strong type (R, L, AL, or sor) is found. If an\n      // AL is found, change the type of the European number to Arabic\n      // number.\n      // W3. Change all ALs to R.\n\n\n      for (var i$2 = 0, cur = outerType; i$2 < len; ++i$2) {\n        var type$1 = types[i$2];\n\n        if (type$1 == "1" && cur == "r") {\n          types[i$2] = "n";\n        } else if (isStrong.test(type$1)) {\n          cur = type$1;\n\n          if (type$1 == "r") {\n            types[i$2] = "R";\n          }\n        }\n      } // W4. A single European separator between two European numbers\n      // changes to a European number. A single common separator between\n      // two numbers of the same type changes to that type.\n\n\n      for (var i$3 = 1, prev$1 = types[0]; i$3 < len - 1; ++i$3) {\n        var type$2 = types[i$3];\n\n        if (type$2 == "+" && prev$1 == "1" && types[i$3 + 1] == "1") {\n          types[i$3] = "1";\n        } else if (type$2 == "," && prev$1 == types[i$3 + 1] && (prev$1 == "1" || prev$1 == "n")) {\n          types[i$3] = prev$1;\n        }\n\n        prev$1 = type$2;\n      } // W5. A sequence of European terminators adjacent to European\n      // numbers changes to all European numbers.\n      // W6. Otherwise, separators and terminators change to Other\n      // Neutral.\n\n\n      for (var i$4 = 0; i$4 < len; ++i$4) {\n        var type$3 = types[i$4];\n\n        if (type$3 == ",") {\n          types[i$4] = "N";\n        } else if (type$3 == "%") {\n          var end = void 0;\n\n          for (end = i$4 + 1; end < len && types[end] == "%"; ++end) {}\n\n          var replace = i$4 && types[i$4 - 1] == "!" || end < len && types[end] == "1" ? "1" : "N";\n\n          for (var j = i$4; j < end; ++j) {\n            types[j] = replace;\n          }\n\n          i$4 = end - 1;\n        }\n      } // W7. Search backwards from each instance of a European number\n      // until the first strong type (R, L, or sor) is found. If an L is\n      // found, then change the type of the European number to L.\n\n\n      for (var i$5 = 0, cur$1 = outerType; i$5 < len; ++i$5) {\n        var type$4 = types[i$5];\n\n        if (cur$1 == "L" && type$4 == "1") {\n          types[i$5] = "L";\n        } else if (isStrong.test(type$4)) {\n          cur$1 = type$4;\n        }\n      } // N1. A sequence of neutrals takes the direction of the\n      // surrounding strong text if the text on both sides has the same\n      // direction. European and Arabic numbers act as if they were R in\n      // terms of their influence on neutrals. Start-of-level-run (sor)\n      // and end-of-level-run (eor) are used at level run boundaries.\n      // N2. Any remaining neutrals take the embedding direction.\n\n\n      for (var i$6 = 0; i$6 < len; ++i$6) {\n        if (isNeutral.test(types[i$6])) {\n          var end$1 = void 0;\n\n          for (end$1 = i$6 + 1; end$1 < len && isNeutral.test(types[end$1]); ++end$1) {}\n\n          var before = (i$6 ? types[i$6 - 1] : outerType) == "L";\n          var after = (end$1 < len ? types[end$1] : outerType) == "L";\n          var replace$1 = before == after ? before ? "L" : "R" : outerType;\n\n          for (var j$1 = i$6; j$1 < end$1; ++j$1) {\n            types[j$1] = replace$1;\n          }\n\n          i$6 = end$1 - 1;\n        }\n      } // Here we depart from the documented algorithm, in order to avoid\n      // building up an actual levels array. Since there are only three\n      // levels (0, 1, 2) in an implementation that doesn\'t take\n      // explicit embedding into account, we can build up the order on\n      // the fly, without following the level-based algorithm.\n\n\n      var order = [],\n          m;\n\n      for (var i$7 = 0; i$7 < len;) {\n        if (countsAsLeft.test(types[i$7])) {\n          var start = i$7;\n\n          for (++i$7; i$7 < len && countsAsLeft.test(types[i$7]); ++i$7) {}\n\n          order.push(new BidiSpan(0, start, i$7));\n        } else {\n          var pos = i$7,\n              at = order.length;\n\n          for (++i$7; i$7 < len && types[i$7] != "L"; ++i$7) {}\n\n          for (var j$2 = pos; j$2 < i$7;) {\n            if (countsAsNum.test(types[j$2])) {\n              if (pos < j$2) {\n                order.splice(at, 0, new BidiSpan(1, pos, j$2));\n              }\n\n              var nstart = j$2;\n\n              for (++j$2; j$2 < i$7 && countsAsNum.test(types[j$2]); ++j$2) {}\n\n              order.splice(at, 0, new BidiSpan(2, nstart, j$2));\n              pos = j$2;\n            } else {\n              ++j$2;\n            }\n          }\n\n          if (pos < i$7) {\n            order.splice(at, 0, new BidiSpan(1, pos, i$7));\n          }\n        }\n      }\n\n      if (direction == "ltr") {\n        if (order[0].level == 1 && (m = str.match(/^\\s+/))) {\n          order[0].from = m[0].length;\n          order.unshift(new BidiSpan(0, 0, m[0].length));\n        }\n\n        if (lst(order).level == 1 && (m = str.match(/\\s+$/))) {\n          lst(order).to -= m[0].length;\n          order.push(new BidiSpan(0, len - m[0].length, len));\n        }\n      }\n\n      return direction == "rtl" ? order.reverse() : order;\n    };\n  }(); // Get the bidi ordering for the given line (and cache it). Returns\n  // false for lines that are fully left-to-right, and an array of\n  // BidiSpan objects otherwise.\n\n\n  function getOrder(line, direction) {\n    var order = line.order;\n\n    if (order == null) {\n      order = line.order = bidiOrdering(line.text, direction);\n    }\n\n    return order;\n  } // EVENT HANDLING\n  // Lightweight event framework. on/off also work on DOM nodes,\n  // registering native DOM handlers.\n\n\n  var noHandlers = [];\n\n  var on = function on(emitter, type, f) {\n    if (emitter.addEventListener) {\n      emitter.addEventListener(type, f, false);\n    } else if (emitter.attachEvent) {\n      emitter.attachEvent("on" + type, f);\n    } else {\n      var map = emitter._handlers || (emitter._handlers = {});\n      map[type] = (map[type] || noHandlers).concat(f);\n    }\n  };\n\n  function getHandlers(emitter, type) {\n    return emitter._handlers && emitter._handlers[type] || noHandlers;\n  }\n\n  function off(emitter, type, f) {\n    if (emitter.removeEventListener) {\n      emitter.removeEventListener(type, f, false);\n    } else if (emitter.detachEvent) {\n      emitter.detachEvent("on" + type, f);\n    } else {\n      var map = emitter._handlers,\n          arr = map && map[type];\n\n      if (arr) {\n        var index = indexOf(arr, f);\n\n        if (index > -1) {\n          map[type] = arr.slice(0, index).concat(arr.slice(index + 1));\n        }\n      }\n    }\n  }\n\n  function signal(emitter, type\n  /*, values...*/\n  ) {\n    var handlers = getHandlers(emitter, type);\n\n    if (!handlers.length) {\n      return;\n    }\n\n    var args = Array.prototype.slice.call(arguments, 2);\n\n    for (var i = 0; i < handlers.length; ++i) {\n      handlers[i].apply(null, args);\n    }\n  } // The DOM events that CodeMirror handles can be overridden by\n  // registering a (non-DOM) handler on the editor for the event name,\n  // and preventDefault-ing the event in that handler.\n\n\n  function signalDOMEvent(cm, e, override) {\n    if (typeof e == "string") {\n      e = {\n        type: e,\n        preventDefault: function preventDefault() {\n          this.defaultPrevented = true;\n        }\n      };\n    }\n\n    signal(cm, override || e.type, cm, e);\n    return e_defaultPrevented(e) || e.codemirrorIgnore;\n  }\n\n  function signalCursorActivity(cm) {\n    var arr = cm._handlers && cm._handlers.cursorActivity;\n\n    if (!arr) {\n      return;\n    }\n\n    var set = cm.curOp.cursorActivityHandlers || (cm.curOp.cursorActivityHandlers = []);\n\n    for (var i = 0; i < arr.length; ++i) {\n      if (indexOf(set, arr[i]) == -1) {\n        set.push(arr[i]);\n      }\n    }\n  }\n\n  function hasHandler(emitter, type) {\n    return getHandlers(emitter, type).length > 0;\n  } // Add on and off methods to a constructor\'s prototype, to make\n  // registering events on such objects more convenient.\n\n\n  function eventMixin(ctor) {\n    ctor.prototype.on = function (type, f) {\n      on(this, type, f);\n    };\n\n    ctor.prototype.off = function (type, f) {\n      off(this, type, f);\n    };\n  } // Due to the fact that we still support jurassic IE versions, some\n  // compatibility wrappers are needed.\n\n\n  function e_preventDefault(e) {\n    if (e.preventDefault) {\n      e.preventDefault();\n    } else {\n      e.returnValue = false;\n    }\n  }\n\n  function e_stopPropagation(e) {\n    if (e.stopPropagation) {\n      e.stopPropagation();\n    } else {\n      e.cancelBubble = true;\n    }\n  }\n\n  function e_defaultPrevented(e) {\n    return e.defaultPrevented != null ? e.defaultPrevented : e.returnValue == false;\n  }\n\n  function e_stop(e) {\n    e_preventDefault(e);\n    e_stopPropagation(e);\n  }\n\n  function e_target(e) {\n    return e.target || e.srcElement;\n  }\n\n  function e_button(e) {\n    var b = e.which;\n\n    if (b == null) {\n      if (e.button & 1) {\n        b = 1;\n      } else if (e.button & 2) {\n        b = 3;\n      } else if (e.button & 4) {\n        b = 2;\n      }\n    }\n\n    if (mac && e.ctrlKey && b == 1) {\n      b = 3;\n    }\n\n    return b;\n  } // Detect drag-and-drop\n\n\n  var dragAndDrop = function () {\n    // There is *some* kind of drag-and-drop support in IE6-8, but I\n    // couldn\'t get it to work yet.\n    if (ie && ie_version < 9) {\n      return false;\n    }\n\n    var div = elt(\'div\');\n    return "draggable" in div || "dragDrop" in div;\n  }();\n\n  var zwspSupported;\n\n  function zeroWidthElement(measure) {\n    if (zwspSupported == null) {\n      var test = elt("span", "\\u200B");\n      removeChildrenAndAdd(measure, elt("span", [test, document.createTextNode("x")]));\n\n      if (measure.firstChild.offsetHeight != 0) {\n        zwspSupported = test.offsetWidth <= 1 && test.offsetHeight > 2 && !(ie && ie_version < 8);\n      }\n    }\n\n    var node = zwspSupported ? elt("span", "\\u200B") : elt("span", "\\xA0", null, "display: inline-block; width: 1px; margin-right: -1px");\n    node.setAttribute("cm-text", "");\n    return node;\n  } // Feature-detect IE\'s crummy client rect reporting for bidi text\n\n\n  var badBidiRects;\n\n  function hasBadBidiRects(measure) {\n    if (badBidiRects != null) {\n      return badBidiRects;\n    }\n\n    var txt = removeChildrenAndAdd(measure, document.createTextNode("A\\u062EA"));\n    var r0 = range(txt, 0, 1).getBoundingClientRect();\n    var r1 = range(txt, 1, 2).getBoundingClientRect();\n    removeChildren(measure);\n\n    if (!r0 || r0.left == r0.right) {\n      return false;\n    } // Safari returns null in some cases (#2780)\n\n\n    return badBidiRects = r1.right - r0.right < 3;\n  } // See if "".split is the broken IE version, if so, provide an\n  // alternative way to split lines.\n\n\n  var splitLinesAuto = "\\n\\nb".split(/\\n/).length != 3 ? function (string) {\n    var pos = 0,\n        result = [],\n        l = string.length;\n\n    while (pos <= l) {\n      var nl = string.indexOf("\\n", pos);\n\n      if (nl == -1) {\n        nl = string.length;\n      }\n\n      var line = string.slice(pos, string.charAt(nl - 1) == "\\r" ? nl - 1 : nl);\n      var rt = line.indexOf("\\r");\n\n      if (rt != -1) {\n        result.push(line.slice(0, rt));\n        pos += rt + 1;\n      } else {\n        result.push(line);\n        pos = nl + 1;\n      }\n    }\n\n    return result;\n  } : function (string) {\n    return string.split(/\\r\\n?|\\n/);\n  };\n  var hasSelection = window.getSelection ? function (te) {\n    try {\n      return te.selectionStart != te.selectionEnd;\n    } catch (e) {\n      return false;\n    }\n  } : function (te) {\n    var range;\n\n    try {\n      range = te.ownerDocument.selection.createRange();\n    } catch (e) {}\n\n    if (!range || range.parentElement() != te) {\n      return false;\n    }\n\n    return range.compareEndPoints("StartToEnd", range) != 0;\n  };\n\n  var hasCopyEvent = function () {\n    var e = elt("div");\n\n    if ("oncopy" in e) {\n      return true;\n    }\n\n    e.setAttribute("oncopy", "return;");\n    return typeof e.oncopy == "function";\n  }();\n\n  var badZoomedRects = null;\n\n  function hasBadZoomedRects(measure) {\n    if (badZoomedRects != null) {\n      return badZoomedRects;\n    }\n\n    var node = removeChildrenAndAdd(measure, elt("span", "x"));\n    var normal = node.getBoundingClientRect();\n    var fromRange = range(node, 0, 1).getBoundingClientRect();\n    return badZoomedRects = Math.abs(normal.left - fromRange.left) > 1;\n  } // Known modes, by name and by MIME\n\n\n  var modes = {},\n      mimeModes = {}; // Extra arguments are stored as the mode\'s dependencies, which is\n  // used by (legacy) mechanisms like loadmode.js to automatically\n  // load a mode. (Preferred mechanism is the require/define calls.)\n\n  function defineMode(name, mode) {\n    if (arguments.length > 2) {\n      mode.dependencies = Array.prototype.slice.call(arguments, 2);\n    }\n\n    modes[name] = mode;\n  }\n\n  function defineMIME(mime, spec) {\n    mimeModes[mime] = spec;\n  } // Given a MIME type, a {name, ...options} config object, or a name\n  // string, return a mode config object.\n\n\n  function resolveMode(spec) {\n    if (typeof spec == "string" && mimeModes.hasOwnProperty(spec)) {\n      spec = mimeModes[spec];\n    } else if (spec && typeof spec.name == "string" && mimeModes.hasOwnProperty(spec.name)) {\n      var found = mimeModes[spec.name];\n\n      if (typeof found == "string") {\n        found = {\n          name: found\n        };\n      }\n\n      spec = createObj(found, spec);\n      spec.name = found.name;\n    } else if (typeof spec == "string" && /^[\\w\\-]+\\/[\\w\\-]+\\+xml$/.test(spec)) {\n      return resolveMode("application/xml");\n    } else if (typeof spec == "string" && /^[\\w\\-]+\\/[\\w\\-]+\\+json$/.test(spec)) {\n      return resolveMode("application/json");\n    }\n\n    if (typeof spec == "string") {\n      return {\n        name: spec\n      };\n    } else {\n      return spec || {\n        name: "null"\n      };\n    }\n  } // Given a mode spec (anything that resolveMode accepts), find and\n  // initialize an actual mode object.\n\n\n  function getMode(options, spec) {\n    spec = resolveMode(spec);\n    var mfactory = modes[spec.name];\n\n    if (!mfactory) {\n      return getMode(options, "text/plain");\n    }\n\n    var modeObj = mfactory(options, spec);\n\n    if (modeExtensions.hasOwnProperty(spec.name)) {\n      var exts = modeExtensions[spec.name];\n\n      for (var prop in exts) {\n        if (!exts.hasOwnProperty(prop)) {\n          continue;\n        }\n\n        if (modeObj.hasOwnProperty(prop)) {\n          modeObj["_" + prop] = modeObj[prop];\n        }\n\n        modeObj[prop] = exts[prop];\n      }\n    }\n\n    modeObj.name = spec.name;\n\n    if (spec.helperType) {\n      modeObj.helperType = spec.helperType;\n    }\n\n    if (spec.modeProps) {\n      for (var prop$1 in spec.modeProps) {\n        modeObj[prop$1] = spec.modeProps[prop$1];\n      }\n    }\n\n    return modeObj;\n  } // This can be used to attach properties to mode objects from\n  // outside the actual mode definition.\n\n\n  var modeExtensions = {};\n\n  function extendMode(mode, properties) {\n    var exts = modeExtensions.hasOwnProperty(mode) ? modeExtensions[mode] : modeExtensions[mode] = {};\n    copyObj(properties, exts);\n  }\n\n  function copyState(mode, state) {\n    if (state === true) {\n      return state;\n    }\n\n    if (mode.copyState) {\n      return mode.copyState(state);\n    }\n\n    var nstate = {};\n\n    for (var n in state) {\n      var val = state[n];\n\n      if (val instanceof Array) {\n        val = val.concat([]);\n      }\n\n      nstate[n] = val;\n    }\n\n    return nstate;\n  } // Given a mode and a state (for that mode), find the inner mode and\n  // state at the position that the state refers to.\n\n\n  function innerMode(mode, state) {\n    var info;\n\n    while (mode.innerMode) {\n      info = mode.innerMode(state);\n\n      if (!info || info.mode == mode) {\n        break;\n      }\n\n      state = info.state;\n      mode = info.mode;\n    }\n\n    return info || {\n      mode: mode,\n      state: state\n    };\n  }\n\n  function startState(mode, a1, a2) {\n    return mode.startState ? mode.startState(a1, a2) : true;\n  } // STRING STREAM\n  // Fed to the mode parsers, provides helper functions to make\n  // parsers more succinct.\n\n\n  var StringStream = function StringStream(string, tabSize, lineOracle) {\n    this.pos = this.start = 0;\n    this.string = string;\n    this.tabSize = tabSize || 8;\n    this.lastColumnPos = this.lastColumnValue = 0;\n    this.lineStart = 0;\n    this.lineOracle = lineOracle;\n  };\n\n  StringStream.prototype.eol = function () {\n    return this.pos >= this.string.length;\n  };\n\n  StringStream.prototype.sol = function () {\n    return this.pos == this.lineStart;\n  };\n\n  StringStream.prototype.peek = function () {\n    return this.string.charAt(this.pos) || undefined;\n  };\n\n  StringStream.prototype.next = function () {\n    if (this.pos < this.string.length) {\n      return this.string.charAt(this.pos++);\n    }\n  };\n\n  StringStream.prototype.eat = function (match) {\n    var ch = this.string.charAt(this.pos);\n    var ok;\n\n    if (typeof match == "string") {\n      ok = ch == match;\n    } else {\n      ok = ch && (match.test ? match.test(ch) : match(ch));\n    }\n\n    if (ok) {\n      ++this.pos;\n      return ch;\n    }\n  };\n\n  StringStream.prototype.eatWhile = function (match) {\n    var start = this.pos;\n\n    while (this.eat(match)) {}\n\n    return this.pos > start;\n  };\n\n  StringStream.prototype.eatSpace = function () {\n    var start = this.pos;\n\n    while (/[\\s\\u00a0]/.test(this.string.charAt(this.pos))) {\n      ++this.pos;\n    }\n\n    return this.pos > start;\n  };\n\n  StringStream.prototype.skipToEnd = function () {\n    this.pos = this.string.length;\n  };\n\n  StringStream.prototype.skipTo = function (ch) {\n    var found = this.string.indexOf(ch, this.pos);\n\n    if (found > -1) {\n      this.pos = found;\n      return true;\n    }\n  };\n\n  StringStream.prototype.backUp = function (n) {\n    this.pos -= n;\n  };\n\n  StringStream.prototype.column = function () {\n    if (this.lastColumnPos < this.start) {\n      this.lastColumnValue = countColumn(this.string, this.start, this.tabSize, this.lastColumnPos, this.lastColumnValue);\n      this.lastColumnPos = this.start;\n    }\n\n    return this.lastColumnValue - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);\n  };\n\n  StringStream.prototype.indentation = function () {\n    return countColumn(this.string, null, this.tabSize) - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);\n  };\n\n  StringStream.prototype.match = function (pattern, consume, caseInsensitive) {\n    if (typeof pattern == "string") {\n      var cased = function cased(str) {\n        return caseInsensitive ? str.toLowerCase() : str;\n      };\n\n      var substr = this.string.substr(this.pos, pattern.length);\n\n      if (cased(substr) == cased(pattern)) {\n        if (consume !== false) {\n          this.pos += pattern.length;\n        }\n\n        return true;\n      }\n    } else {\n      var match = this.string.slice(this.pos).match(pattern);\n\n      if (match && match.index > 0) {\n        return null;\n      }\n\n      if (match && consume !== false) {\n        this.pos += match[0].length;\n      }\n\n      return match;\n    }\n  };\n\n  StringStream.prototype.current = function () {\n    return this.string.slice(this.start, this.pos);\n  };\n\n  StringStream.prototype.hideFirstChars = function (n, inner) {\n    this.lineStart += n;\n\n    try {\n      return inner();\n    } finally {\n      this.lineStart -= n;\n    }\n  };\n\n  StringStream.prototype.lookAhead = function (n) {\n    var oracle = this.lineOracle;\n    return oracle && oracle.lookAhead(n);\n  };\n\n  StringStream.prototype.baseToken = function () {\n    var oracle = this.lineOracle;\n    return oracle && oracle.baseToken(this.pos);\n  }; // Find the line object corresponding to the given line number.\n\n\n  function getLine(doc, n) {\n    n -= doc.first;\n\n    if (n < 0 || n >= doc.size) {\n      throw new Error("There is no line " + (n + doc.first) + " in the document.");\n    }\n\n    var chunk = doc;\n\n    while (!chunk.lines) {\n      for (var i = 0;; ++i) {\n        var child = chunk.children[i],\n            sz = child.chunkSize();\n\n        if (n < sz) {\n          chunk = child;\n          break;\n        }\n\n        n -= sz;\n      }\n    }\n\n    return chunk.lines[n];\n  } // Get the part of a document between two positions, as an array of\n  // strings.\n\n\n  function getBetween(doc, start, end) {\n    var out = [],\n        n = start.line;\n    doc.iter(start.line, end.line + 1, function (line) {\n      var text = line.text;\n\n      if (n == end.line) {\n        text = text.slice(0, end.ch);\n      }\n\n      if (n == start.line) {\n        text = text.slice(start.ch);\n      }\n\n      out.push(text);\n      ++n;\n    });\n    return out;\n  } // Get the lines between from and to, as array of strings.\n\n\n  function getLines(doc, from, to) {\n    var out = [];\n    doc.iter(from, to, function (line) {\n      out.push(line.text);\n    }); // iter aborts when callback returns truthy value\n\n    return out;\n  } // Update the height of a line, propagating the height change\n  // upwards to parent nodes.\n\n\n  function updateLineHeight(line, height) {\n    var diff = height - line.height;\n\n    if (diff) {\n      for (var n = line; n; n = n.parent) {\n        n.height += diff;\n      }\n    }\n  } // Given a line object, find its line number by walking up through\n  // its parent links.\n\n\n  function lineNo(line) {\n    if (line.parent == null) {\n      return null;\n    }\n\n    var cur = line.parent,\n        no = indexOf(cur.lines, line);\n\n    for (var chunk = cur.parent; chunk; cur = chunk, chunk = chunk.parent) {\n      for (var i = 0;; ++i) {\n        if (chunk.children[i] == cur) {\n          break;\n        }\n\n        no += chunk.children[i].chunkSize();\n      }\n    }\n\n    return no + cur.first;\n  } // Find the line at the given vertical position, using the height\n  // information in the document tree.\n\n\n  function _lineAtHeight(chunk, h) {\n    var n = chunk.first;\n\n    outer: do {\n      for (var i$1 = 0; i$1 < chunk.children.length; ++i$1) {\n        var child = chunk.children[i$1],\n            ch = child.height;\n\n        if (h < ch) {\n          chunk = child;\n          continue outer;\n        }\n\n        h -= ch;\n        n += child.chunkSize();\n      }\n\n      return n;\n    } while (!chunk.lines);\n\n    var i = 0;\n\n    for (; i < chunk.lines.length; ++i) {\n      var line = chunk.lines[i],\n          lh = line.height;\n\n      if (h < lh) {\n        break;\n      }\n\n      h -= lh;\n    }\n\n    return n + i;\n  }\n\n  function isLine(doc, l) {\n    return l >= doc.first && l < doc.first + doc.size;\n  }\n\n  function lineNumberFor(options, i) {\n    return String(options.lineNumberFormatter(i + options.firstLineNumber));\n  } // A Pos instance represents a position within the text.\n\n\n  function Pos(line, ch, sticky) {\n    if (sticky === void 0) sticky = null;\n\n    if (!(this instanceof Pos)) {\n      return new Pos(line, ch, sticky);\n    }\n\n    this.line = line;\n    this.ch = ch;\n    this.sticky = sticky;\n  } // Compare two positions, return 0 if they are the same, a negative\n  // number when a is less, and a positive number otherwise.\n\n\n  function cmp(a, b) {\n    return a.line - b.line || a.ch - b.ch;\n  }\n\n  function equalCursorPos(a, b) {\n    return a.sticky == b.sticky && cmp(a, b) == 0;\n  }\n\n  function copyPos(x) {\n    return Pos(x.line, x.ch);\n  }\n\n  function maxPos(a, b) {\n    return cmp(a, b) < 0 ? b : a;\n  }\n\n  function minPos(a, b) {\n    return cmp(a, b) < 0 ? a : b;\n  } // Most of the external API clips given positions to make sure they\n  // actually exist within the document.\n\n\n  function clipLine(doc, n) {\n    return Math.max(doc.first, Math.min(n, doc.first + doc.size - 1));\n  }\n\n  function _clipPos(doc, pos) {\n    if (pos.line < doc.first) {\n      return Pos(doc.first, 0);\n    }\n\n    var last = doc.first + doc.size - 1;\n\n    if (pos.line > last) {\n      return Pos(last, getLine(doc, last).text.length);\n    }\n\n    return clipToLen(pos, getLine(doc, pos.line).text.length);\n  }\n\n  function clipToLen(pos, linelen) {\n    var ch = pos.ch;\n\n    if (ch == null || ch > linelen) {\n      return Pos(pos.line, linelen);\n    } else if (ch < 0) {\n      return Pos(pos.line, 0);\n    } else {\n      return pos;\n    }\n  }\n\n  function clipPosArray(doc, array) {\n    var out = [];\n\n    for (var i = 0; i < array.length; i++) {\n      out[i] = _clipPos(doc, array[i]);\n    }\n\n    return out;\n  }\n\n  var SavedContext = function SavedContext(state, lookAhead) {\n    this.state = state;\n    this.lookAhead = lookAhead;\n  };\n\n  var Context = function Context(doc, state, line, lookAhead) {\n    this.state = state;\n    this.doc = doc;\n    this.line = line;\n    this.maxLookAhead = lookAhead || 0;\n    this.baseTokens = null;\n    this.baseTokenPos = 1;\n  };\n\n  Context.prototype.lookAhead = function (n) {\n    var line = this.doc.getLine(this.line + n);\n\n    if (line != null && n > this.maxLookAhead) {\n      this.maxLookAhead = n;\n    }\n\n    return line;\n  };\n\n  Context.prototype.baseToken = function (n) {\n    if (!this.baseTokens) {\n      return null;\n    }\n\n    while (this.baseTokens[this.baseTokenPos] <= n) {\n      this.baseTokenPos += 2;\n    }\n\n    var type = this.baseTokens[this.baseTokenPos + 1];\n    return {\n      type: type && type.replace(/( |^)overlay .*/, ""),\n      size: this.baseTokens[this.baseTokenPos] - n\n    };\n  };\n\n  Context.prototype.nextLine = function () {\n    this.line++;\n\n    if (this.maxLookAhead > 0) {\n      this.maxLookAhead--;\n    }\n  };\n\n  Context.fromSaved = function (doc, saved, line) {\n    if (saved instanceof SavedContext) {\n      return new Context(doc, copyState(doc.mode, saved.state), line, saved.lookAhead);\n    } else {\n      return new Context(doc, copyState(doc.mode, saved), line);\n    }\n  };\n\n  Context.prototype.save = function (copy) {\n    var state = copy !== false ? copyState(this.doc.mode, this.state) : this.state;\n    return this.maxLookAhead > 0 ? new SavedContext(state, this.maxLookAhead) : state;\n  }; // Compute a style array (an array starting with a mode generation\n  // -- for invalidation -- followed by pairs of end positions and\n  // style strings), which is used to highlight the tokens on the\n  // line.\n\n\n  function highlightLine(cm, line, context, forceToEnd) {\n    // A styles array always starts with a number identifying the\n    // mode/overlays that it is based on (for easy invalidation).\n    var st = [cm.state.modeGen],\n        lineClasses = {}; // Compute the base array of styles\n\n    runMode(cm, line.text, cm.doc.mode, context, function (end, style) {\n      return st.push(end, style);\n    }, lineClasses, forceToEnd);\n    var state = context.state; // Run overlays, adjust style array.\n\n    var loop = function loop(o) {\n      context.baseTokens = st;\n      var overlay = cm.state.overlays[o],\n          i = 1,\n          at = 0;\n      context.state = true;\n      runMode(cm, line.text, overlay.mode, context, function (end, style) {\n        var start = i; // Ensure there\'s a token end at the current position, and that i points at it\n\n        while (at < end) {\n          var i_end = st[i];\n\n          if (i_end > end) {\n            st.splice(i, 1, end, st[i + 1], i_end);\n          }\n\n          i += 2;\n          at = Math.min(end, i_end);\n        }\n\n        if (!style) {\n          return;\n        }\n\n        if (overlay.opaque) {\n          st.splice(start, i - start, end, "overlay " + style);\n          i = start + 2;\n        } else {\n          for (; start < i; start += 2) {\n            var cur = st[start + 1];\n            st[start + 1] = (cur ? cur + " " : "") + "overlay " + style;\n          }\n        }\n      }, lineClasses);\n      context.state = state;\n      context.baseTokens = null;\n      context.baseTokenPos = 1;\n    };\n\n    for (var o = 0; o < cm.state.overlays.length; ++o) {\n      loop(o);\n    }\n\n    return {\n      styles: st,\n      classes: lineClasses.bgClass || lineClasses.textClass ? lineClasses : null\n    };\n  }\n\n  function getLineStyles(cm, line, updateFrontier) {\n    if (!line.styles || line.styles[0] != cm.state.modeGen) {\n      var context = getContextBefore(cm, lineNo(line));\n      var resetState = line.text.length > cm.options.maxHighlightLength && copyState(cm.doc.mode, context.state);\n      var result = highlightLine(cm, line, context);\n\n      if (resetState) {\n        context.state = resetState;\n      }\n\n      line.stateAfter = context.save(!resetState);\n      line.styles = result.styles;\n\n      if (result.classes) {\n        line.styleClasses = result.classes;\n      } else if (line.styleClasses) {\n        line.styleClasses = null;\n      }\n\n      if (updateFrontier === cm.doc.highlightFrontier) {\n        cm.doc.modeFrontier = Math.max(cm.doc.modeFrontier, ++cm.doc.highlightFrontier);\n      }\n    }\n\n    return line.styles;\n  }\n\n  function getContextBefore(cm, n, precise) {\n    var doc = cm.doc,\n        display = cm.display;\n\n    if (!doc.mode.startState) {\n      return new Context(doc, true, n);\n    }\n\n    var start = findStartLine(cm, n, precise);\n    var saved = start > doc.first && getLine(doc, start - 1).stateAfter;\n    var context = saved ? Context.fromSaved(doc, saved, start) : new Context(doc, startState(doc.mode), start);\n    doc.iter(start, n, function (line) {\n      processLine(cm, line.text, context);\n      var pos = context.line;\n      line.stateAfter = pos == n - 1 || pos % 5 == 0 || pos >= display.viewFrom && pos < display.viewTo ? context.save() : null;\n      context.nextLine();\n    });\n\n    if (precise) {\n      doc.modeFrontier = context.line;\n    }\n\n    return context;\n  } // Lightweight form of highlight -- proceed over this line and\n  // update state, but don\'t save a style array. Used for lines that\n  // aren\'t currently visible.\n\n\n  function processLine(cm, text, context, startAt) {\n    var mode = cm.doc.mode;\n    var stream = new StringStream(text, cm.options.tabSize, context);\n    stream.start = stream.pos = startAt || 0;\n\n    if (text == "") {\n      callBlankLine(mode, context.state);\n    }\n\n    while (!stream.eol()) {\n      readToken(mode, stream, context.state);\n      stream.start = stream.pos;\n    }\n  }\n\n  function callBlankLine(mode, state) {\n    if (mode.blankLine) {\n      return mode.blankLine(state);\n    }\n\n    if (!mode.innerMode) {\n      return;\n    }\n\n    var inner = innerMode(mode, state);\n\n    if (inner.mode.blankLine) {\n      return inner.mode.blankLine(inner.state);\n    }\n  }\n\n  function readToken(mode, stream, state, inner) {\n    for (var i = 0; i < 10; i++) {\n      if (inner) {\n        inner[0] = innerMode(mode, state).mode;\n      }\n\n      var style = mode.token(stream, state);\n\n      if (stream.pos > stream.start) {\n        return style;\n      }\n    }\n\n    throw new Error("Mode " + mode.name + " failed to advance stream.");\n  }\n\n  var Token = function Token(stream, type, state) {\n    this.start = stream.start;\n    this.end = stream.pos;\n    this.string = stream.current();\n    this.type = type || null;\n    this.state = state;\n  }; // Utility for getTokenAt and getLineTokens\n\n\n  function takeToken(cm, pos, precise, asArray) {\n    var doc = cm.doc,\n        mode = doc.mode,\n        style;\n    pos = _clipPos(doc, pos);\n    var line = getLine(doc, pos.line),\n        context = getContextBefore(cm, pos.line, precise);\n    var stream = new StringStream(line.text, cm.options.tabSize, context),\n        tokens;\n\n    if (asArray) {\n      tokens = [];\n    }\n\n    while ((asArray || stream.pos < pos.ch) && !stream.eol()) {\n      stream.start = stream.pos;\n      style = readToken(mode, stream, context.state);\n\n      if (asArray) {\n        tokens.push(new Token(stream, style, copyState(doc.mode, context.state)));\n      }\n    }\n\n    return asArray ? tokens : new Token(stream, style, context.state);\n  }\n\n  function extractLineClasses(type, output) {\n    if (type) {\n      for (;;) {\n        var lineClass = type.match(/(?:^|\\s+)line-(background-)?(\\S+)/);\n\n        if (!lineClass) {\n          break;\n        }\n\n        type = type.slice(0, lineClass.index) + type.slice(lineClass.index + lineClass[0].length);\n        var prop = lineClass[1] ? "bgClass" : "textClass";\n\n        if (output[prop] == null) {\n          output[prop] = lineClass[2];\n        } else if (!new RegExp("(?:^|\\s)" + lineClass[2] + "(?:$|\\s)").test(output[prop])) {\n          output[prop] += " " + lineClass[2];\n        }\n      }\n    }\n\n    return type;\n  } // Run the given mode\'s parser over a line, calling f for each token.\n\n\n  function runMode(cm, text, mode, context, f, lineClasses, forceToEnd) {\n    var flattenSpans = mode.flattenSpans;\n\n    if (flattenSpans == null) {\n      flattenSpans = cm.options.flattenSpans;\n    }\n\n    var curStart = 0,\n        curStyle = null;\n    var stream = new StringStream(text, cm.options.tabSize, context),\n        style;\n    var inner = cm.options.addModeClass && [null];\n\n    if (text == "") {\n      extractLineClasses(callBlankLine(mode, context.state), lineClasses);\n    }\n\n    while (!stream.eol()) {\n      if (stream.pos > cm.options.maxHighlightLength) {\n        flattenSpans = false;\n\n        if (forceToEnd) {\n          processLine(cm, text, context, stream.pos);\n        }\n\n        stream.pos = text.length;\n        style = null;\n      } else {\n        style = extractLineClasses(readToken(mode, stream, context.state, inner), lineClasses);\n      }\n\n      if (inner) {\n        var mName = inner[0].name;\n\n        if (mName) {\n          style = "m-" + (style ? mName + " " + style : mName);\n        }\n      }\n\n      if (!flattenSpans || curStyle != style) {\n        while (curStart < stream.start) {\n          curStart = Math.min(stream.start, curStart + 5000);\n          f(curStart, curStyle);\n        }\n\n        curStyle = style;\n      }\n\n      stream.start = stream.pos;\n    }\n\n    while (curStart < stream.pos) {\n      // Webkit seems to refuse to render text nodes longer than 57444\n      // characters, and returns inaccurate measurements in nodes\n      // starting around 5000 chars.\n      var pos = Math.min(stream.pos, curStart + 5000);\n      f(pos, curStyle);\n      curStart = pos;\n    }\n  } // Finds the line to start with when starting a parse. Tries to\n  // find a line with a stateAfter, so that it can start with a\n  // valid state. If that fails, it returns the line with the\n  // smallest indentation, which tends to need the least context to\n  // parse correctly.\n\n\n  function findStartLine(cm, n, precise) {\n    var minindent,\n        minline,\n        doc = cm.doc;\n    var lim = precise ? -1 : n - (cm.doc.mode.innerMode ? 1000 : 100);\n\n    for (var search = n; search > lim; --search) {\n      if (search <= doc.first) {\n        return doc.first;\n      }\n\n      var line = getLine(doc, search - 1),\n          after = line.stateAfter;\n\n      if (after && (!precise || search + (after instanceof SavedContext ? after.lookAhead : 0) <= doc.modeFrontier)) {\n        return search;\n      }\n\n      var indented = countColumn(line.text, null, cm.options.tabSize);\n\n      if (minline == null || minindent > indented) {\n        minline = search - 1;\n        minindent = indented;\n      }\n    }\n\n    return minline;\n  }\n\n  function retreatFrontier(doc, n) {\n    doc.modeFrontier = Math.min(doc.modeFrontier, n);\n\n    if (doc.highlightFrontier < n - 10) {\n      return;\n    }\n\n    var start = doc.first;\n\n    for (var line = n - 1; line > start; line--) {\n      var saved = getLine(doc, line).stateAfter; // change is on 3\n      // state on line 1 looked ahead 2 -- so saw 3\n      // test 1 + 2 < 3 should cover this\n\n      if (saved && (!(saved instanceof SavedContext) || line + saved.lookAhead < n)) {\n        start = line + 1;\n        break;\n      }\n    }\n\n    doc.highlightFrontier = Math.min(doc.highlightFrontier, start);\n  } // Optimize some code when these features are not used.\n\n\n  var sawReadOnlySpans = false,\n      sawCollapsedSpans = false;\n\n  function seeReadOnlySpans() {\n    sawReadOnlySpans = true;\n  }\n\n  function seeCollapsedSpans() {\n    sawCollapsedSpans = true;\n  } // TEXTMARKER SPANS\n\n\n  function MarkedSpan(marker, from, to) {\n    this.marker = marker;\n    this.from = from;\n    this.to = to;\n  } // Search an array of spans for a span matching the given marker.\n\n\n  function getMarkedSpanFor(spans, marker) {\n    if (spans) {\n      for (var i = 0; i < spans.length; ++i) {\n        var span = spans[i];\n\n        if (span.marker == marker) {\n          return span;\n        }\n      }\n    }\n  } // Remove a span from an array, returning undefined if no spans are\n  // left (we don\'t store arrays for lines without spans).\n\n\n  function removeMarkedSpan(spans, span) {\n    var r;\n\n    for (var i = 0; i < spans.length; ++i) {\n      if (spans[i] != span) {\n        (r || (r = [])).push(spans[i]);\n      }\n    }\n\n    return r;\n  } // Add a span to a line.\n\n\n  function addMarkedSpan(line, span) {\n    line.markedSpans = line.markedSpans ? line.markedSpans.concat([span]) : [span];\n    span.marker.attachLine(line);\n  } // Used for the algorithm that adjusts markers for a change in the\n  // document. These functions cut an array of spans at a given\n  // character position, returning an array of remaining chunks (or\n  // undefined if nothing remains).\n\n\n  function markedSpansBefore(old, startCh, isInsert) {\n    var nw;\n\n    if (old) {\n      for (var i = 0; i < old.length; ++i) {\n        var span = old[i],\n            marker = span.marker;\n        var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= startCh : span.from < startCh);\n\n        if (startsBefore || span.from == startCh && marker.type == "bookmark" && (!isInsert || !span.marker.insertLeft)) {\n          var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= startCh : span.to > startCh);\n          (nw || (nw = [])).push(new MarkedSpan(marker, span.from, endsAfter ? null : span.to));\n        }\n      }\n    }\n\n    return nw;\n  }\n\n  function markedSpansAfter(old, endCh, isInsert) {\n    var nw;\n\n    if (old) {\n      for (var i = 0; i < old.length; ++i) {\n        var span = old[i],\n            marker = span.marker;\n        var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= endCh : span.to > endCh);\n\n        if (endsAfter || span.from == endCh && marker.type == "bookmark" && (!isInsert || span.marker.insertLeft)) {\n          var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= endCh : span.from < endCh);\n          (nw || (nw = [])).push(new MarkedSpan(marker, startsBefore ? null : span.from - endCh, span.to == null ? null : span.to - endCh));\n        }\n      }\n    }\n\n    return nw;\n  } // Given a change object, compute the new set of marker spans that\n  // cover the line in which the change took place. Removes spans\n  // entirely within the change, reconnects spans belonging to the\n  // same marker that appear on both sides of the change, and cuts off\n  // spans partially within the change. Returns an array of span\n  // arrays with one element for each line in (after) the change.\n\n\n  function stretchSpansOverChange(doc, change) {\n    if (change.full) {\n      return null;\n    }\n\n    var oldFirst = isLine(doc, change.from.line) && getLine(doc, change.from.line).markedSpans;\n    var oldLast = isLine(doc, change.to.line) && getLine(doc, change.to.line).markedSpans;\n\n    if (!oldFirst && !oldLast) {\n      return null;\n    }\n\n    var startCh = change.from.ch,\n        endCh = change.to.ch,\n        isInsert = cmp(change.from, change.to) == 0; // Get the spans that \'stick out\' on both sides\n\n    var first = markedSpansBefore(oldFirst, startCh, isInsert);\n    var last = markedSpansAfter(oldLast, endCh, isInsert); // Next, merge those two ends\n\n    var sameLine = change.text.length == 1,\n        offset = lst(change.text).length + (sameLine ? startCh : 0);\n\n    if (first) {\n      // Fix up .to properties of first\n      for (var i = 0; i < first.length; ++i) {\n        var span = first[i];\n\n        if (span.to == null) {\n          var found = getMarkedSpanFor(last, span.marker);\n\n          if (!found) {\n            span.to = startCh;\n          } else if (sameLine) {\n            span.to = found.to == null ? null : found.to + offset;\n          }\n        }\n      }\n    }\n\n    if (last) {\n      // Fix up .from in last (or move them into first in case of sameLine)\n      for (var i$1 = 0; i$1 < last.length; ++i$1) {\n        var span$1 = last[i$1];\n\n        if (span$1.to != null) {\n          span$1.to += offset;\n        }\n\n        if (span$1.from == null) {\n          var found$1 = getMarkedSpanFor(first, span$1.marker);\n\n          if (!found$1) {\n            span$1.from = offset;\n\n            if (sameLine) {\n              (first || (first = [])).push(span$1);\n            }\n          }\n        } else {\n          span$1.from += offset;\n\n          if (sameLine) {\n            (first || (first = [])).push(span$1);\n          }\n        }\n      }\n    } // Make sure we didn\'t create any zero-length spans\n\n\n    if (first) {\n      first = clearEmptySpans(first);\n    }\n\n    if (last && last != first) {\n      last = clearEmptySpans(last);\n    }\n\n    var newMarkers = [first];\n\n    if (!sameLine) {\n      // Fill gap with whole-line-spans\n      var gap = change.text.length - 2,\n          gapMarkers;\n\n      if (gap > 0 && first) {\n        for (var i$2 = 0; i$2 < first.length; ++i$2) {\n          if (first[i$2].to == null) {\n            (gapMarkers || (gapMarkers = [])).push(new MarkedSpan(first[i$2].marker, null, null));\n          }\n        }\n      }\n\n      for (var i$3 = 0; i$3 < gap; ++i$3) {\n        newMarkers.push(gapMarkers);\n      }\n\n      newMarkers.push(last);\n    }\n\n    return newMarkers;\n  } // Remove spans that are empty and don\'t have a clearWhenEmpty\n  // option of false.\n\n\n  function clearEmptySpans(spans) {\n    for (var i = 0; i < spans.length; ++i) {\n      var span = spans[i];\n\n      if (span.from != null && span.from == span.to && span.marker.clearWhenEmpty !== false) {\n        spans.splice(i--, 1);\n      }\n    }\n\n    if (!spans.length) {\n      return null;\n    }\n\n    return spans;\n  } // Used to \'clip\' out readOnly ranges when making a change.\n\n\n  function removeReadOnlyRanges(doc, from, to) {\n    var markers = null;\n    doc.iter(from.line, to.line + 1, function (line) {\n      if (line.markedSpans) {\n        for (var i = 0; i < line.markedSpans.length; ++i) {\n          var mark = line.markedSpans[i].marker;\n\n          if (mark.readOnly && (!markers || indexOf(markers, mark) == -1)) {\n            (markers || (markers = [])).push(mark);\n          }\n        }\n      }\n    });\n\n    if (!markers) {\n      return null;\n    }\n\n    var parts = [{\n      from: from,\n      to: to\n    }];\n\n    for (var i = 0; i < markers.length; ++i) {\n      var mk = markers[i],\n          m = mk.find(0);\n\n      for (var j = 0; j < parts.length; ++j) {\n        var p = parts[j];\n\n        if (cmp(p.to, m.from) < 0 || cmp(p.from, m.to) > 0) {\n          continue;\n        }\n\n        var newParts = [j, 1],\n            dfrom = cmp(p.from, m.from),\n            dto = cmp(p.to, m.to);\n\n        if (dfrom < 0 || !mk.inclusiveLeft && !dfrom) {\n          newParts.push({\n            from: p.from,\n            to: m.from\n          });\n        }\n\n        if (dto > 0 || !mk.inclusiveRight && !dto) {\n          newParts.push({\n            from: m.to,\n            to: p.to\n          });\n        }\n\n        parts.splice.apply(parts, newParts);\n        j += newParts.length - 3;\n      }\n    }\n\n    return parts;\n  } // Connect or disconnect spans from a line.\n\n\n  function detachMarkedSpans(line) {\n    var spans = line.markedSpans;\n\n    if (!spans) {\n      return;\n    }\n\n    for (var i = 0; i < spans.length; ++i) {\n      spans[i].marker.detachLine(line);\n    }\n\n    line.markedSpans = null;\n  }\n\n  function attachMarkedSpans(line, spans) {\n    if (!spans) {\n      return;\n    }\n\n    for (var i = 0; i < spans.length; ++i) {\n      spans[i].marker.attachLine(line);\n    }\n\n    line.markedSpans = spans;\n  } // Helpers used when computing which overlapping collapsed span\n  // counts as the larger one.\n\n\n  function extraLeft(marker) {\n    return marker.inclusiveLeft ? -1 : 0;\n  }\n\n  function extraRight(marker) {\n    return marker.inclusiveRight ? 1 : 0;\n  } // Returns a number indicating which of two overlapping collapsed\n  // spans is larger (and thus includes the other). Falls back to\n  // comparing ids when the spans cover exactly the same range.\n\n\n  function compareCollapsedMarkers(a, b) {\n    var lenDiff = a.lines.length - b.lines.length;\n\n    if (lenDiff != 0) {\n      return lenDiff;\n    }\n\n    var aPos = a.find(),\n        bPos = b.find();\n    var fromCmp = cmp(aPos.from, bPos.from) || extraLeft(a) - extraLeft(b);\n\n    if (fromCmp) {\n      return -fromCmp;\n    }\n\n    var toCmp = cmp(aPos.to, bPos.to) || extraRight(a) - extraRight(b);\n\n    if (toCmp) {\n      return toCmp;\n    }\n\n    return b.id - a.id;\n  } // Find out whether a line ends or starts in a collapsed span. If\n  // so, return the marker for that span.\n\n\n  function collapsedSpanAtSide(line, start) {\n    var sps = sawCollapsedSpans && line.markedSpans,\n        found;\n\n    if (sps) {\n      for (var sp = void 0, i = 0; i < sps.length; ++i) {\n        sp = sps[i];\n\n        if (sp.marker.collapsed && (start ? sp.from : sp.to) == null && (!found || compareCollapsedMarkers(found, sp.marker) < 0)) {\n          found = sp.marker;\n        }\n      }\n    }\n\n    return found;\n  }\n\n  function collapsedSpanAtStart(line) {\n    return collapsedSpanAtSide(line, true);\n  }\n\n  function collapsedSpanAtEnd(line) {\n    return collapsedSpanAtSide(line, false);\n  }\n\n  function collapsedSpanAround(line, ch) {\n    var sps = sawCollapsedSpans && line.markedSpans,\n        found;\n\n    if (sps) {\n      for (var i = 0; i < sps.length; ++i) {\n        var sp = sps[i];\n\n        if (sp.marker.collapsed && (sp.from == null || sp.from < ch) && (sp.to == null || sp.to > ch) && (!found || compareCollapsedMarkers(found, sp.marker) < 0)) {\n          found = sp.marker;\n        }\n      }\n    }\n\n    return found;\n  } // Test whether there exists a collapsed span that partially\n  // overlaps (covers the start or end, but not both) of a new span.\n  // Such overlap is not allowed.\n\n\n  function conflictingCollapsedRange(doc, lineNo, from, to, marker) {\n    var line = getLine(doc, lineNo);\n    var sps = sawCollapsedSpans && line.markedSpans;\n\n    if (sps) {\n      for (var i = 0; i < sps.length; ++i) {\n        var sp = sps[i];\n\n        if (!sp.marker.collapsed) {\n          continue;\n        }\n\n        var found = sp.marker.find(0);\n        var fromCmp = cmp(found.from, from) || extraLeft(sp.marker) - extraLeft(marker);\n        var toCmp = cmp(found.to, to) || extraRight(sp.marker) - extraRight(marker);\n\n        if (fromCmp >= 0 && toCmp <= 0 || fromCmp <= 0 && toCmp >= 0) {\n          continue;\n        }\n\n        if (fromCmp <= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.to, from) >= 0 : cmp(found.to, from) > 0) || fromCmp >= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.from, to) <= 0 : cmp(found.from, to) < 0)) {\n          return true;\n        }\n      }\n    }\n  } // A visual line is a line as drawn on the screen. Folding, for\n  // example, can cause multiple logical lines to appear on the same\n  // visual line. This finds the start of the visual line that the\n  // given line is part of (usually that is the line itself).\n\n\n  function visualLine(line) {\n    var merged;\n\n    while (merged = collapsedSpanAtStart(line)) {\n      line = merged.find(-1, true).line;\n    }\n\n    return line;\n  }\n\n  function visualLineEnd(line) {\n    var merged;\n\n    while (merged = collapsedSpanAtEnd(line)) {\n      line = merged.find(1, true).line;\n    }\n\n    return line;\n  } // Returns an array of logical lines that continue the visual line\n  // started by the argument, or undefined if there are no such lines.\n\n\n  function visualLineContinued(line) {\n    var merged, lines;\n\n    while (merged = collapsedSpanAtEnd(line)) {\n      line = merged.find(1, true).line;\n      (lines || (lines = [])).push(line);\n    }\n\n    return lines;\n  } // Get the line number of the start of the visual line that the\n  // given line number is part of.\n\n\n  function visualLineNo(doc, lineN) {\n    var line = getLine(doc, lineN),\n        vis = visualLine(line);\n\n    if (line == vis) {\n      return lineN;\n    }\n\n    return lineNo(vis);\n  } // Get the line number of the start of the next visual line after\n  // the given line.\n\n\n  function visualLineEndNo(doc, lineN) {\n    if (lineN > doc.lastLine()) {\n      return lineN;\n    }\n\n    var line = getLine(doc, lineN),\n        merged;\n\n    if (!lineIsHidden(doc, line)) {\n      return lineN;\n    }\n\n    while (merged = collapsedSpanAtEnd(line)) {\n      line = merged.find(1, true).line;\n    }\n\n    return lineNo(line) + 1;\n  } // Compute whether a line is hidden. Lines count as hidden when they\n  // are part of a visual line that starts with another line, or when\n  // they are entirely covered by collapsed, non-widget span.\n\n\n  function lineIsHidden(doc, line) {\n    var sps = sawCollapsedSpans && line.markedSpans;\n\n    if (sps) {\n      for (var sp = void 0, i = 0; i < sps.length; ++i) {\n        sp = sps[i];\n\n        if (!sp.marker.collapsed) {\n          continue;\n        }\n\n        if (sp.from == null) {\n          return true;\n        }\n\n        if (sp.marker.widgetNode) {\n          continue;\n        }\n\n        if (sp.from == 0 && sp.marker.inclusiveLeft && lineIsHiddenInner(doc, line, sp)) {\n          return true;\n        }\n      }\n    }\n  }\n\n  function lineIsHiddenInner(doc, line, span) {\n    if (span.to == null) {\n      var end = span.marker.find(1, true);\n      return lineIsHiddenInner(doc, end.line, getMarkedSpanFor(end.line.markedSpans, span.marker));\n    }\n\n    if (span.marker.inclusiveRight && span.to == line.text.length) {\n      return true;\n    }\n\n    for (var sp = void 0, i = 0; i < line.markedSpans.length; ++i) {\n      sp = line.markedSpans[i];\n\n      if (sp.marker.collapsed && !sp.marker.widgetNode && sp.from == span.to && (sp.to == null || sp.to != span.from) && (sp.marker.inclusiveLeft || span.marker.inclusiveRight) && lineIsHiddenInner(doc, line, sp)) {\n        return true;\n      }\n    }\n  } // Find the height above the given line.\n\n\n  function _heightAtLine(lineObj) {\n    lineObj = visualLine(lineObj);\n    var h = 0,\n        chunk = lineObj.parent;\n\n    for (var i = 0; i < chunk.lines.length; ++i) {\n      var line = chunk.lines[i];\n\n      if (line == lineObj) {\n        break;\n      } else {\n        h += line.height;\n      }\n    }\n\n    for (var p = chunk.parent; p; chunk = p, p = chunk.parent) {\n      for (var i$1 = 0; i$1 < p.children.length; ++i$1) {\n        var cur = p.children[i$1];\n\n        if (cur == chunk) {\n          break;\n        } else {\n          h += cur.height;\n        }\n      }\n    }\n\n    return h;\n  } // Compute the character length of a line, taking into account\n  // collapsed ranges (see markText) that might hide parts, and join\n  // other lines onto it.\n\n\n  function lineLength(line) {\n    if (line.height == 0) {\n      return 0;\n    }\n\n    var len = line.text.length,\n        merged,\n        cur = line;\n\n    while (merged = collapsedSpanAtStart(cur)) {\n      var found = merged.find(0, true);\n      cur = found.from.line;\n      len += found.from.ch - found.to.ch;\n    }\n\n    cur = line;\n\n    while (merged = collapsedSpanAtEnd(cur)) {\n      var found$1 = merged.find(0, true);\n      len -= cur.text.length - found$1.from.ch;\n      cur = found$1.to.line;\n      len += cur.text.length - found$1.to.ch;\n    }\n\n    return len;\n  } // Find the longest line in the document.\n\n\n  function findMaxLine(cm) {\n    var d = cm.display,\n        doc = cm.doc;\n    d.maxLine = getLine(doc, doc.first);\n    d.maxLineLength = lineLength(d.maxLine);\n    d.maxLineChanged = true;\n    doc.iter(function (line) {\n      var len = lineLength(line);\n\n      if (len > d.maxLineLength) {\n        d.maxLineLength = len;\n        d.maxLine = line;\n      }\n    });\n  } // LINE DATA STRUCTURE\n  // Line objects. These hold state related to a line, including\n  // highlighting info (the styles array).\n\n\n  var Line = function Line(text, markedSpans, estimateHeight) {\n    this.text = text;\n    attachMarkedSpans(this, markedSpans);\n    this.height = estimateHeight ? estimateHeight(this) : 1;\n  };\n\n  Line.prototype.lineNo = function () {\n    return lineNo(this);\n  };\n\n  eventMixin(Line); // Change the content (text, markers) of a line. Automatically\n  // invalidates cached information and tries to re-estimate the\n  // line\'s height.\n\n  function updateLine(line, text, markedSpans, estimateHeight) {\n    line.text = text;\n\n    if (line.stateAfter) {\n      line.stateAfter = null;\n    }\n\n    if (line.styles) {\n      line.styles = null;\n    }\n\n    if (line.order != null) {\n      line.order = null;\n    }\n\n    detachMarkedSpans(line);\n    attachMarkedSpans(line, markedSpans);\n    var estHeight = estimateHeight ? estimateHeight(line) : 1;\n\n    if (estHeight != line.height) {\n      updateLineHeight(line, estHeight);\n    }\n  } // Detach a line from the document tree and its markers.\n\n\n  function cleanUpLine(line) {\n    line.parent = null;\n    detachMarkedSpans(line);\n  } // Convert a style as returned by a mode (either null, or a string\n  // containing one or more styles) to a CSS style. This is cached,\n  // and also looks for line-wide styles.\n\n\n  var styleToClassCache = {},\n      styleToClassCacheWithMode = {};\n\n  function interpretTokenStyle(style, options) {\n    if (!style || /^\\s*$/.test(style)) {\n      return null;\n    }\n\n    var cache = options.addModeClass ? styleToClassCacheWithMode : styleToClassCache;\n    return cache[style] || (cache[style] = style.replace(/\\S+/g, "cm-$&"));\n  } // Render the DOM representation of the text of a line. Also builds\n  // up a \'line map\', which points at the DOM nodes that represent\n  // specific stretches of text, and is used by the measuring code.\n  // The returned object contains the DOM node, this map, and\n  // information about line-wide styles that were set by the mode.\n\n\n  function buildLineContent(cm, lineView) {\n    // The padding-right forces the element to have a \'border\', which\n    // is needed on Webkit to be able to get line-level bounding\n    // rectangles for it (in measureChar).\n    var content = eltP("span", null, null, webkit ? "padding-right: .1px" : null);\n    var builder = {\n      pre: eltP("pre", [content], "CodeMirror-line"),\n      content: content,\n      col: 0,\n      pos: 0,\n      cm: cm,\n      trailingSpace: false,\n      splitSpaces: cm.getOption("lineWrapping")\n    };\n    lineView.measure = {}; // Iterate over the logical lines that make up this visual line.\n\n    for (var i = 0; i <= (lineView.rest ? lineView.rest.length : 0); i++) {\n      var line = i ? lineView.rest[i - 1] : lineView.line,\n          order = void 0;\n      builder.pos = 0;\n      builder.addToken = buildToken; // Optionally wire in some hacks into the token-rendering\n      // algorithm, to deal with browser quirks.\n\n      if (hasBadBidiRects(cm.display.measure) && (order = getOrder(line, cm.doc.direction))) {\n        builder.addToken = buildTokenBadBidi(builder.addToken, order);\n      }\n\n      builder.map = [];\n      var allowFrontierUpdate = lineView != cm.display.externalMeasured && lineNo(line);\n      insertLineContent(line, builder, getLineStyles(cm, line, allowFrontierUpdate));\n\n      if (line.styleClasses) {\n        if (line.styleClasses.bgClass) {\n          builder.bgClass = joinClasses(line.styleClasses.bgClass, builder.bgClass || "");\n        }\n\n        if (line.styleClasses.textClass) {\n          builder.textClass = joinClasses(line.styleClasses.textClass, builder.textClass || "");\n        }\n      } // Ensure at least a single node is present, for measuring.\n\n\n      if (builder.map.length == 0) {\n        builder.map.push(0, 0, builder.content.appendChild(zeroWidthElement(cm.display.measure)));\n      } // Store the map and a cache object for the current logical line\n\n\n      if (i == 0) {\n        lineView.measure.map = builder.map;\n        lineView.measure.cache = {};\n      } else {\n        (lineView.measure.maps || (lineView.measure.maps = [])).push(builder.map);\n        (lineView.measure.caches || (lineView.measure.caches = [])).push({});\n      }\n    } // See issue #2901\n\n\n    if (webkit) {\n      var last = builder.content.lastChild;\n\n      if (/\\bcm-tab\\b/.test(last.className) || last.querySelector && last.querySelector(".cm-tab")) {\n        builder.content.className = "cm-tab-wrap-hack";\n      }\n    }\n\n    signal(cm, "renderLine", cm, lineView.line, builder.pre);\n\n    if (builder.pre.className) {\n      builder.textClass = joinClasses(builder.pre.className, builder.textClass || "");\n    }\n\n    return builder;\n  }\n\n  function defaultSpecialCharPlaceholder(ch) {\n    var token = elt("span", "\\u2022", "cm-invalidchar");\n    token.title = "\\\\u" + ch.charCodeAt(0).toString(16);\n    token.setAttribute("aria-label", token.title);\n    return token;\n  } // Build up the DOM representation for a single token, and add it to\n  // the line map. Takes care to render special characters separately.\n\n\n  function buildToken(builder, text, style, startStyle, endStyle, css, attributes) {\n    if (!text) {\n      return;\n    }\n\n    var displayText = builder.splitSpaces ? splitSpaces(text, builder.trailingSpace) : text;\n    var special = builder.cm.state.specialChars,\n        mustWrap = false;\n    var content;\n\n    if (!special.test(text)) {\n      builder.col += text.length;\n      content = document.createTextNode(displayText);\n      builder.map.push(builder.pos, builder.pos + text.length, content);\n\n      if (ie && ie_version < 9) {\n        mustWrap = true;\n      }\n\n      builder.pos += text.length;\n    } else {\n      content = document.createDocumentFragment();\n      var pos = 0;\n\n      while (true) {\n        special.lastIndex = pos;\n        var m = special.exec(text);\n        var skipped = m ? m.index - pos : text.length - pos;\n\n        if (skipped) {\n          var txt = document.createTextNode(displayText.slice(pos, pos + skipped));\n\n          if (ie && ie_version < 9) {\n            content.appendChild(elt("span", [txt]));\n          } else {\n            content.appendChild(txt);\n          }\n\n          builder.map.push(builder.pos, builder.pos + skipped, txt);\n          builder.col += skipped;\n          builder.pos += skipped;\n        }\n\n        if (!m) {\n          break;\n        }\n\n        pos += skipped + 1;\n        var txt$1 = void 0;\n\n        if (m[0] == "\\t") {\n          var tabSize = builder.cm.options.tabSize,\n              tabWidth = tabSize - builder.col % tabSize;\n          txt$1 = content.appendChild(elt("span", spaceStr(tabWidth), "cm-tab"));\n          txt$1.setAttribute("role", "presentation");\n          txt$1.setAttribute("cm-text", "\\t");\n          builder.col += tabWidth;\n        } else if (m[0] == "\\r" || m[0] == "\\n") {\n          txt$1 = content.appendChild(elt("span", m[0] == "\\r" ? "\\u240D" : "\\u2424", "cm-invalidchar"));\n          txt$1.setAttribute("cm-text", m[0]);\n          builder.col += 1;\n        } else {\n          txt$1 = builder.cm.options.specialCharPlaceholder(m[0]);\n          txt$1.setAttribute("cm-text", m[0]);\n\n          if (ie && ie_version < 9) {\n            content.appendChild(elt("span", [txt$1]));\n          } else {\n            content.appendChild(txt$1);\n          }\n\n          builder.col += 1;\n        }\n\n        builder.map.push(builder.pos, builder.pos + 1, txt$1);\n        builder.pos++;\n      }\n    }\n\n    builder.trailingSpace = displayText.charCodeAt(text.length - 1) == 32;\n\n    if (style || startStyle || endStyle || mustWrap || css) {\n      var fullStyle = style || "";\n\n      if (startStyle) {\n        fullStyle += startStyle;\n      }\n\n      if (endStyle) {\n        fullStyle += endStyle;\n      }\n\n      var token = elt("span", [content], fullStyle, css);\n\n      if (attributes) {\n        for (var attr in attributes) {\n          if (attributes.hasOwnProperty(attr) && attr != "style" && attr != "class") {\n            token.setAttribute(attr, attributes[attr]);\n          }\n        }\n      }\n\n      return builder.content.appendChild(token);\n    }\n\n    builder.content.appendChild(content);\n  } // Change some spaces to NBSP to prevent the browser from collapsing\n  // trailing spaces at the end of a line when rendering text (issue #1362).\n\n\n  function splitSpaces(text, trailingBefore) {\n    if (text.length > 1 && !/  /.test(text)) {\n      return text;\n    }\n\n    var spaceBefore = trailingBefore,\n        result = "";\n\n    for (var i = 0; i < text.length; i++) {\n      var ch = text.charAt(i);\n\n      if (ch == " " && spaceBefore && (i == text.length - 1 || text.charCodeAt(i + 1) == 32)) {\n        ch = "\\xA0";\n      }\n\n      result += ch;\n      spaceBefore = ch == " ";\n    }\n\n    return result;\n  } // Work around nonsense dimensions being reported for stretches of\n  // right-to-left text.\n\n\n  function buildTokenBadBidi(inner, order) {\n    return function (builder, text, style, startStyle, endStyle, css, attributes) {\n      style = style ? style + " cm-force-border" : "cm-force-border";\n      var start = builder.pos,\n          end = start + text.length;\n\n      for (;;) {\n        // Find the part that overlaps with the start of this text\n        var part = void 0;\n\n        for (var i = 0; i < order.length; i++) {\n          part = order[i];\n\n          if (part.to > start && part.from <= start) {\n            break;\n          }\n        }\n\n        if (part.to >= end) {\n          return inner(builder, text, style, startStyle, endStyle, css, attributes);\n        }\n\n        inner(builder, text.slice(0, part.to - start), style, startStyle, null, css, attributes);\n        startStyle = null;\n        text = text.slice(part.to - start);\n        start = part.to;\n      }\n    };\n  }\n\n  function buildCollapsedSpan(builder, size, marker, ignoreWidget) {\n    var widget = !ignoreWidget && marker.widgetNode;\n\n    if (widget) {\n      builder.map.push(builder.pos, builder.pos + size, widget);\n    }\n\n    if (!ignoreWidget && builder.cm.display.input.needsContentAttribute) {\n      if (!widget) {\n        widget = builder.content.appendChild(document.createElement("span"));\n      }\n\n      widget.setAttribute("cm-marker", marker.id);\n    }\n\n    if (widget) {\n      builder.cm.display.input.setUneditable(widget);\n      builder.content.appendChild(widget);\n    }\n\n    builder.pos += size;\n    builder.trailingSpace = false;\n  } // Outputs a number of spans to make up a line, taking highlighting\n  // and marked text into account.\n\n\n  function insertLineContent(line, builder, styles) {\n    var spans = line.markedSpans,\n        allText = line.text,\n        at = 0;\n\n    if (!spans) {\n      for (var i$1 = 1; i$1 < styles.length; i$1 += 2) {\n        builder.addToken(builder, allText.slice(at, at = styles[i$1]), interpretTokenStyle(styles[i$1 + 1], builder.cm.options));\n      }\n\n      return;\n    }\n\n    var len = allText.length,\n        pos = 0,\n        i = 1,\n        text = "",\n        style,\n        css;\n    var nextChange = 0,\n        spanStyle,\n        spanEndStyle,\n        spanStartStyle,\n        collapsed,\n        attributes;\n\n    for (;;) {\n      if (nextChange == pos) {\n        // Update current marker set\n        spanStyle = spanEndStyle = spanStartStyle = css = "";\n        attributes = null;\n        collapsed = null;\n        nextChange = Infinity;\n        var foundBookmarks = [],\n            endStyles = void 0;\n\n        for (var j = 0; j < spans.length; ++j) {\n          var sp = spans[j],\n              m = sp.marker;\n\n          if (m.type == "bookmark" && sp.from == pos && m.widgetNode) {\n            foundBookmarks.push(m);\n          } else if (sp.from <= pos && (sp.to == null || sp.to > pos || m.collapsed && sp.to == pos && sp.from == pos)) {\n            if (sp.to != null && sp.to != pos && nextChange > sp.to) {\n              nextChange = sp.to;\n              spanEndStyle = "";\n            }\n\n            if (m.className) {\n              spanStyle += " " + m.className;\n            }\n\n            if (m.css) {\n              css = (css ? css + ";" : "") + m.css;\n            }\n\n            if (m.startStyle && sp.from == pos) {\n              spanStartStyle += " " + m.startStyle;\n            }\n\n            if (m.endStyle && sp.to == nextChange) {\n              (endStyles || (endStyles = [])).push(m.endStyle, sp.to);\n            } // support for the old title property\n            // https://github.com/codemirror/CodeMirror/pull/5673\n\n\n            if (m.title) {\n              (attributes || (attributes = {})).title = m.title;\n            }\n\n            if (m.attributes) {\n              for (var attr in m.attributes) {\n                (attributes || (attributes = {}))[attr] = m.attributes[attr];\n              }\n            }\n\n            if (m.collapsed && (!collapsed || compareCollapsedMarkers(collapsed.marker, m) < 0)) {\n              collapsed = sp;\n            }\n          } else if (sp.from > pos && nextChange > sp.from) {\n            nextChange = sp.from;\n          }\n        }\n\n        if (endStyles) {\n          for (var j$1 = 0; j$1 < endStyles.length; j$1 += 2) {\n            if (endStyles[j$1 + 1] == nextChange) {\n              spanEndStyle += " " + endStyles[j$1];\n            }\n          }\n        }\n\n        if (!collapsed || collapsed.from == pos) {\n          for (var j$2 = 0; j$2 < foundBookmarks.length; ++j$2) {\n            buildCollapsedSpan(builder, 0, foundBookmarks[j$2]);\n          }\n        }\n\n        if (collapsed && (collapsed.from || 0) == pos) {\n          buildCollapsedSpan(builder, (collapsed.to == null ? len + 1 : collapsed.to) - pos, collapsed.marker, collapsed.from == null);\n\n          if (collapsed.to == null) {\n            return;\n          }\n\n          if (collapsed.to == pos) {\n            collapsed = false;\n          }\n        }\n      }\n\n      if (pos >= len) {\n        break;\n      }\n\n      var upto = Math.min(len, nextChange);\n\n      while (true) {\n        if (text) {\n          var end = pos + text.length;\n\n          if (!collapsed) {\n            var tokenText = end > upto ? text.slice(0, upto - pos) : text;\n            builder.addToken(builder, tokenText, style ? style + spanStyle : spanStyle, spanStartStyle, pos + tokenText.length == nextChange ? spanEndStyle : "", css, attributes);\n          }\n\n          if (end >= upto) {\n            text = text.slice(upto - pos);\n            pos = upto;\n            break;\n          }\n\n          pos = end;\n          spanStartStyle = "";\n        }\n\n        text = allText.slice(at, at = styles[i++]);\n        style = interpretTokenStyle(styles[i++], builder.cm.options);\n      }\n    }\n  } // These objects are used to represent the visible (currently drawn)\n  // part of the document. A LineView may correspond to multiple\n  // logical lines, if those are connected by collapsed ranges.\n\n\n  function LineView(doc, line, lineN) {\n    // The starting line\n    this.line = line; // Continuing lines, if any\n\n    this.rest = visualLineContinued(line); // Number of logical lines in this visual line\n\n    this.size = this.rest ? lineNo(lst(this.rest)) - lineN + 1 : 1;\n    this.node = this.text = null;\n    this.hidden = lineIsHidden(doc, line);\n  } // Create a range of LineView objects for the given lines.\n\n\n  function buildViewArray(cm, from, to) {\n    var array = [],\n        nextPos;\n\n    for (var pos = from; pos < to; pos = nextPos) {\n      var view = new LineView(cm.doc, getLine(cm.doc, pos), pos);\n      nextPos = pos + view.size;\n      array.push(view);\n    }\n\n    return array;\n  }\n\n  var operationGroup = null;\n\n  function pushOperation(op) {\n    if (operationGroup) {\n      operationGroup.ops.push(op);\n    } else {\n      op.ownsGroup = operationGroup = {\n        ops: [op],\n        delayedCallbacks: []\n      };\n    }\n  }\n\n  function fireCallbacksForOps(group) {\n    // Calls delayed callbacks and cursorActivity handlers until no\n    // new ones appear\n    var callbacks = group.delayedCallbacks,\n        i = 0;\n\n    do {\n      for (; i < callbacks.length; i++) {\n        callbacks[i].call(null);\n      }\n\n      for (var j = 0; j < group.ops.length; j++) {\n        var op = group.ops[j];\n\n        if (op.cursorActivityHandlers) {\n          while (op.cursorActivityCalled < op.cursorActivityHandlers.length) {\n            op.cursorActivityHandlers[op.cursorActivityCalled++].call(null, op.cm);\n          }\n        }\n      }\n    } while (i < callbacks.length);\n  }\n\n  function finishOperation(op, endCb) {\n    var group = op.ownsGroup;\n\n    if (!group) {\n      return;\n    }\n\n    try {\n      fireCallbacksForOps(group);\n    } finally {\n      operationGroup = null;\n      endCb(group);\n    }\n  }\n\n  var orphanDelayedCallbacks = null; // Often, we want to signal events at a point where we are in the\n  // middle of some work, but don\'t want the handler to start calling\n  // other methods on the editor, which might be in an inconsistent\n  // state or simply not expect any other events to happen.\n  // signalLater looks whether there are any handlers, and schedules\n  // them to be executed when the last operation ends, or, if no\n  // operation is active, when a timeout fires.\n\n  function signalLater(emitter, type\n  /*, values...*/\n  ) {\n    var arr = getHandlers(emitter, type);\n\n    if (!arr.length) {\n      return;\n    }\n\n    var args = Array.prototype.slice.call(arguments, 2),\n        list;\n\n    if (operationGroup) {\n      list = operationGroup.delayedCallbacks;\n    } else if (orphanDelayedCallbacks) {\n      list = orphanDelayedCallbacks;\n    } else {\n      list = orphanDelayedCallbacks = [];\n      setTimeout(fireOrphanDelayed, 0);\n    }\n\n    var loop = function loop(i) {\n      list.push(function () {\n        return arr[i].apply(null, args);\n      });\n    };\n\n    for (var i = 0; i < arr.length; ++i) {\n      loop(i);\n    }\n  }\n\n  function fireOrphanDelayed() {\n    var delayed = orphanDelayedCallbacks;\n    orphanDelayedCallbacks = null;\n\n    for (var i = 0; i < delayed.length; ++i) {\n      delayed[i]();\n    }\n  } // When an aspect of a line changes, a string is added to\n  // lineView.changes. This updates the relevant part of the line\'s\n  // DOM structure.\n\n\n  function updateLineForChanges(cm, lineView, lineN, dims) {\n    for (var j = 0; j < lineView.changes.length; j++) {\n      var type = lineView.changes[j];\n\n      if (type == "text") {\n        updateLineText(cm, lineView);\n      } else if (type == "gutter") {\n        updateLineGutter(cm, lineView, lineN, dims);\n      } else if (type == "class") {\n        updateLineClasses(cm, lineView);\n      } else if (type == "widget") {\n        updateLineWidgets(cm, lineView, dims);\n      }\n    }\n\n    lineView.changes = null;\n  } // Lines with gutter elements, widgets or a background class need to\n  // be wrapped, and have the extra elements added to the wrapper div\n\n\n  function ensureLineWrapped(lineView) {\n    if (lineView.node == lineView.text) {\n      lineView.node = elt("div", null, null, "position: relative");\n\n      if (lineView.text.parentNode) {\n        lineView.text.parentNode.replaceChild(lineView.node, lineView.text);\n      }\n\n      lineView.node.appendChild(lineView.text);\n\n      if (ie && ie_version < 8) {\n        lineView.node.style.zIndex = 2;\n      }\n    }\n\n    return lineView.node;\n  }\n\n  function updateLineBackground(cm, lineView) {\n    var cls = lineView.bgClass ? lineView.bgClass + " " + (lineView.line.bgClass || "") : lineView.line.bgClass;\n\n    if (cls) {\n      cls += " CodeMirror-linebackground";\n    }\n\n    if (lineView.background) {\n      if (cls) {\n        lineView.background.className = cls;\n      } else {\n        lineView.background.parentNode.removeChild(lineView.background);\n        lineView.background = null;\n      }\n    } else if (cls) {\n      var wrap = ensureLineWrapped(lineView);\n      lineView.background = wrap.insertBefore(elt("div", null, cls), wrap.firstChild);\n      cm.display.input.setUneditable(lineView.background);\n    }\n  } // Wrapper around buildLineContent which will reuse the structure\n  // in display.externalMeasured when possible.\n\n\n  function getLineContent(cm, lineView) {\n    var ext = cm.display.externalMeasured;\n\n    if (ext && ext.line == lineView.line) {\n      cm.display.externalMeasured = null;\n      lineView.measure = ext.measure;\n      return ext.built;\n    }\n\n    return buildLineContent(cm, lineView);\n  } // Redraw the line\'s text. Interacts with the background and text\n  // classes because the mode may output tokens that influence these\n  // classes.\n\n\n  function updateLineText(cm, lineView) {\n    var cls = lineView.text.className;\n    var built = getLineContent(cm, lineView);\n\n    if (lineView.text == lineView.node) {\n      lineView.node = built.pre;\n    }\n\n    lineView.text.parentNode.replaceChild(built.pre, lineView.text);\n    lineView.text = built.pre;\n\n    if (built.bgClass != lineView.bgClass || built.textClass != lineView.textClass) {\n      lineView.bgClass = built.bgClass;\n      lineView.textClass = built.textClass;\n      updateLineClasses(cm, lineView);\n    } else if (cls) {\n      lineView.text.className = cls;\n    }\n  }\n\n  function updateLineClasses(cm, lineView) {\n    updateLineBackground(cm, lineView);\n\n    if (lineView.line.wrapClass) {\n      ensureLineWrapped(lineView).className = lineView.line.wrapClass;\n    } else if (lineView.node != lineView.text) {\n      lineView.node.className = "";\n    }\n\n    var textClass = lineView.textClass ? lineView.textClass + " " + (lineView.line.textClass || "") : lineView.line.textClass;\n    lineView.text.className = textClass || "";\n  }\n\n  function updateLineGutter(cm, lineView, lineN, dims) {\n    if (lineView.gutter) {\n      lineView.node.removeChild(lineView.gutter);\n      lineView.gutter = null;\n    }\n\n    if (lineView.gutterBackground) {\n      lineView.node.removeChild(lineView.gutterBackground);\n      lineView.gutterBackground = null;\n    }\n\n    if (lineView.line.gutterClass) {\n      var wrap = ensureLineWrapped(lineView);\n      lineView.gutterBackground = elt("div", null, "CodeMirror-gutter-background " + lineView.line.gutterClass, "left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px; width: " + dims.gutterTotalWidth + "px");\n      cm.display.input.setUneditable(lineView.gutterBackground);\n      wrap.insertBefore(lineView.gutterBackground, lineView.text);\n    }\n\n    var markers = lineView.line.gutterMarkers;\n\n    if (cm.options.lineNumbers || markers) {\n      var wrap$1 = ensureLineWrapped(lineView);\n      var gutterWrap = lineView.gutter = elt("div", null, "CodeMirror-gutter-wrapper", "left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px");\n      cm.display.input.setUneditable(gutterWrap);\n      wrap$1.insertBefore(gutterWrap, lineView.text);\n\n      if (lineView.line.gutterClass) {\n        gutterWrap.className += " " + lineView.line.gutterClass;\n      }\n\n      if (cm.options.lineNumbers && (!markers || !markers["CodeMirror-linenumbers"])) {\n        lineView.lineNumber = gutterWrap.appendChild(elt("div", lineNumberFor(cm.options, lineN), "CodeMirror-linenumber CodeMirror-gutter-elt", "left: " + dims.gutterLeft["CodeMirror-linenumbers"] + "px; width: " + cm.display.lineNumInnerWidth + "px"));\n      }\n\n      if (markers) {\n        for (var k = 0; k < cm.display.gutterSpecs.length; ++k) {\n          var id = cm.display.gutterSpecs[k].className,\n              found = markers.hasOwnProperty(id) && markers[id];\n\n          if (found) {\n            gutterWrap.appendChild(elt("div", [found], "CodeMirror-gutter-elt", "left: " + dims.gutterLeft[id] + "px; width: " + dims.gutterWidth[id] + "px"));\n          }\n        }\n      }\n    }\n  }\n\n  function updateLineWidgets(cm, lineView, dims) {\n    if (lineView.alignable) {\n      lineView.alignable = null;\n    }\n\n    var isWidget = classTest("CodeMirror-linewidget");\n\n    for (var node = lineView.node.firstChild, next = void 0; node; node = next) {\n      next = node.nextSibling;\n\n      if (isWidget.test(node)) {\n        lineView.node.removeChild(node);\n      }\n    }\n\n    insertLineWidgets(cm, lineView, dims);\n  } // Build a line\'s DOM representation from scratch\n\n\n  function buildLineElement(cm, lineView, lineN, dims) {\n    var built = getLineContent(cm, lineView);\n    lineView.text = lineView.node = built.pre;\n\n    if (built.bgClass) {\n      lineView.bgClass = built.bgClass;\n    }\n\n    if (built.textClass) {\n      lineView.textClass = built.textClass;\n    }\n\n    updateLineClasses(cm, lineView);\n    updateLineGutter(cm, lineView, lineN, dims);\n    insertLineWidgets(cm, lineView, dims);\n    return lineView.node;\n  } // A lineView may contain multiple logical lines (when merged by\n  // collapsed spans). The widgets for all of them need to be drawn.\n\n\n  function insertLineWidgets(cm, lineView, dims) {\n    insertLineWidgetsFor(cm, lineView.line, lineView, dims, true);\n\n    if (lineView.rest) {\n      for (var i = 0; i < lineView.rest.length; i++) {\n        insertLineWidgetsFor(cm, lineView.rest[i], lineView, dims, false);\n      }\n    }\n  }\n\n  function insertLineWidgetsFor(cm, line, lineView, dims, allowAbove) {\n    if (!line.widgets) {\n      return;\n    }\n\n    var wrap = ensureLineWrapped(lineView);\n\n    for (var i = 0, ws = line.widgets; i < ws.length; ++i) {\n      var widget = ws[i],\n          node = elt("div", [widget.node], "CodeMirror-linewidget" + (widget.className ? " " + widget.className : ""));\n\n      if (!widget.handleMouseEvents) {\n        node.setAttribute("cm-ignore-events", "true");\n      }\n\n      positionLineWidget(widget, node, lineView, dims);\n      cm.display.input.setUneditable(node);\n\n      if (allowAbove && widget.above) {\n        wrap.insertBefore(node, lineView.gutter || lineView.text);\n      } else {\n        wrap.appendChild(node);\n      }\n\n      signalLater(widget, "redraw");\n    }\n  }\n\n  function positionLineWidget(widget, node, lineView, dims) {\n    if (widget.noHScroll) {\n      (lineView.alignable || (lineView.alignable = [])).push(node);\n      var width = dims.wrapperWidth;\n      node.style.left = dims.fixedPos + "px";\n\n      if (!widget.coverGutter) {\n        width -= dims.gutterTotalWidth;\n        node.style.paddingLeft = dims.gutterTotalWidth + "px";\n      }\n\n      node.style.width = width + "px";\n    }\n\n    if (widget.coverGutter) {\n      node.style.zIndex = 5;\n      node.style.position = "relative";\n\n      if (!widget.noHScroll) {\n        node.style.marginLeft = -dims.gutterTotalWidth + "px";\n      }\n    }\n  }\n\n  function widgetHeight(widget) {\n    if (widget.height != null) {\n      return widget.height;\n    }\n\n    var cm = widget.doc.cm;\n\n    if (!cm) {\n      return 0;\n    }\n\n    if (!contains(document.body, widget.node)) {\n      var parentStyle = "position: relative;";\n\n      if (widget.coverGutter) {\n        parentStyle += "margin-left: -" + cm.display.gutters.offsetWidth + "px;";\n      }\n\n      if (widget.noHScroll) {\n        parentStyle += "width: " + cm.display.wrapper.clientWidth + "px;";\n      }\n\n      removeChildrenAndAdd(cm.display.measure, elt("div", [widget.node], null, parentStyle));\n    }\n\n    return widget.height = widget.node.parentNode.offsetHeight;\n  } // Return true when the given mouse event happened in a widget\n\n\n  function eventInWidget(display, e) {\n    for (var n = e_target(e); n != display.wrapper; n = n.parentNode) {\n      if (!n || n.nodeType == 1 && n.getAttribute("cm-ignore-events") == "true" || n.parentNode == display.sizer && n != display.mover) {\n        return true;\n      }\n    }\n  } // POSITION MEASUREMENT\n\n\n  function paddingTop(display) {\n    return display.lineSpace.offsetTop;\n  }\n\n  function paddingVert(display) {\n    return display.mover.offsetHeight - display.lineSpace.offsetHeight;\n  }\n\n  function paddingH(display) {\n    if (display.cachedPaddingH) {\n      return display.cachedPaddingH;\n    }\n\n    var e = removeChildrenAndAdd(display.measure, elt("pre", "x", "CodeMirror-line-like"));\n    var style = window.getComputedStyle ? window.getComputedStyle(e) : e.currentStyle;\n    var data = {\n      left: parseInt(style.paddingLeft),\n      right: parseInt(style.paddingRight)\n    };\n\n    if (!isNaN(data.left) && !isNaN(data.right)) {\n      display.cachedPaddingH = data;\n    }\n\n    return data;\n  }\n\n  function scrollGap(cm) {\n    return scrollerGap - cm.display.nativeBarWidth;\n  }\n\n  function displayWidth(cm) {\n    return cm.display.scroller.clientWidth - scrollGap(cm) - cm.display.barWidth;\n  }\n\n  function displayHeight(cm) {\n    return cm.display.scroller.clientHeight - scrollGap(cm) - cm.display.barHeight;\n  } // Ensure the lineView.wrapping.heights array is populated. This is\n  // an array of bottom offsets for the lines that make up a drawn\n  // line. When lineWrapping is on, there might be more than one\n  // height.\n\n\n  function ensureLineHeights(cm, lineView, rect) {\n    var wrapping = cm.options.lineWrapping;\n    var curWidth = wrapping && displayWidth(cm);\n\n    if (!lineView.measure.heights || wrapping && lineView.measure.width != curWidth) {\n      var heights = lineView.measure.heights = [];\n\n      if (wrapping) {\n        lineView.measure.width = curWidth;\n        var rects = lineView.text.firstChild.getClientRects();\n\n        for (var i = 0; i < rects.length - 1; i++) {\n          var cur = rects[i],\n              next = rects[i + 1];\n\n          if (Math.abs(cur.bottom - next.bottom) > 2) {\n            heights.push((cur.bottom + next.top) / 2 - rect.top);\n          }\n        }\n      }\n\n      heights.push(rect.bottom - rect.top);\n    }\n  } // Find a line map (mapping character offsets to text nodes) and a\n  // measurement cache for the given line number. (A line view might\n  // contain multiple lines when collapsed ranges are present.)\n\n\n  function mapFromLineView(lineView, line, lineN) {\n    if (lineView.line == line) {\n      return {\n        map: lineView.measure.map,\n        cache: lineView.measure.cache\n      };\n    }\n\n    for (var i = 0; i < lineView.rest.length; i++) {\n      if (lineView.rest[i] == line) {\n        return {\n          map: lineView.measure.maps[i],\n          cache: lineView.measure.caches[i]\n        };\n      }\n    }\n\n    for (var i$1 = 0; i$1 < lineView.rest.length; i$1++) {\n      if (lineNo(lineView.rest[i$1]) > lineN) {\n        return {\n          map: lineView.measure.maps[i$1],\n          cache: lineView.measure.caches[i$1],\n          before: true\n        };\n      }\n    }\n  } // Render a line into the hidden node display.externalMeasured. Used\n  // when measurement is needed for a line that\'s not in the viewport.\n\n\n  function updateExternalMeasurement(cm, line) {\n    line = visualLine(line);\n    var lineN = lineNo(line);\n    var view = cm.display.externalMeasured = new LineView(cm.doc, line, lineN);\n    view.lineN = lineN;\n    var built = view.built = buildLineContent(cm, view);\n    view.text = built.pre;\n    removeChildrenAndAdd(cm.display.lineMeasure, built.pre);\n    return view;\n  } // Get a {top, bottom, left, right} box (in line-local coordinates)\n  // for a given character.\n\n\n  function measureChar(cm, line, ch, bias) {\n    return measureCharPrepared(cm, prepareMeasureForLine(cm, line), ch, bias);\n  } // Find a line view that corresponds to the given line number.\n\n\n  function findViewForLine(cm, lineN) {\n    if (lineN >= cm.display.viewFrom && lineN < cm.display.viewTo) {\n      return cm.display.view[findViewIndex(cm, lineN)];\n    }\n\n    var ext = cm.display.externalMeasured;\n\n    if (ext && lineN >= ext.lineN && lineN < ext.lineN + ext.size) {\n      return ext;\n    }\n  } // Measurement can be split in two steps, the set-up work that\n  // applies to the whole line, and the measurement of the actual\n  // character. Functions like coordsChar, that need to do a lot of\n  // measurements in a row, can thus ensure that the set-up work is\n  // only done once.\n\n\n  function prepareMeasureForLine(cm, line) {\n    var lineN = lineNo(line);\n    var view = findViewForLine(cm, lineN);\n\n    if (view && !view.text) {\n      view = null;\n    } else if (view && view.changes) {\n      updateLineForChanges(cm, view, lineN, getDimensions(cm));\n      cm.curOp.forceUpdate = true;\n    }\n\n    if (!view) {\n      view = updateExternalMeasurement(cm, line);\n    }\n\n    var info = mapFromLineView(view, line, lineN);\n    return {\n      line: line,\n      view: view,\n      rect: null,\n      map: info.map,\n      cache: info.cache,\n      before: info.before,\n      hasHeights: false\n    };\n  } // Given a prepared measurement object, measures the position of an\n  // actual character (or fetches it from the cache).\n\n\n  function measureCharPrepared(cm, prepared, ch, bias, varHeight) {\n    if (prepared.before) {\n      ch = -1;\n    }\n\n    var key = ch + (bias || ""),\n        found;\n\n    if (prepared.cache.hasOwnProperty(key)) {\n      found = prepared.cache[key];\n    } else {\n      if (!prepared.rect) {\n        prepared.rect = prepared.view.text.getBoundingClientRect();\n      }\n\n      if (!prepared.hasHeights) {\n        ensureLineHeights(cm, prepared.view, prepared.rect);\n        prepared.hasHeights = true;\n      }\n\n      found = measureCharInner(cm, prepared, ch, bias);\n\n      if (!found.bogus) {\n        prepared.cache[key] = found;\n      }\n    }\n\n    return {\n      left: found.left,\n      right: found.right,\n      top: varHeight ? found.rtop : found.top,\n      bottom: varHeight ? found.rbottom : found.bottom\n    };\n  }\n\n  var nullRect = {\n    left: 0,\n    right: 0,\n    top: 0,\n    bottom: 0\n  };\n\n  function nodeAndOffsetInLineMap(map, ch, bias) {\n    var node, start, end, collapse, mStart, mEnd; // First, search the line map for the text node corresponding to,\n    // or closest to, the target character.\n\n    for (var i = 0; i < map.length; i += 3) {\n      mStart = map[i];\n      mEnd = map[i + 1];\n\n      if (ch < mStart) {\n        start = 0;\n        end = 1;\n        collapse = "left";\n      } else if (ch < mEnd) {\n        start = ch - mStart;\n        end = start + 1;\n      } else if (i == map.length - 3 || ch == mEnd && map[i + 3] > ch) {\n        end = mEnd - mStart;\n        start = end - 1;\n\n        if (ch >= mEnd) {\n          collapse = "right";\n        }\n      }\n\n      if (start != null) {\n        node = map[i + 2];\n\n        if (mStart == mEnd && bias == (node.insertLeft ? "left" : "right")) {\n          collapse = bias;\n        }\n\n        if (bias == "left" && start == 0) {\n          while (i && map[i - 2] == map[i - 3] && map[i - 1].insertLeft) {\n            node = map[(i -= 3) + 2];\n            collapse = "left";\n          }\n        }\n\n        if (bias == "right" && start == mEnd - mStart) {\n          while (i < map.length - 3 && map[i + 3] == map[i + 4] && !map[i + 5].insertLeft) {\n            node = map[(i += 3) + 2];\n            collapse = "right";\n          }\n        }\n\n        break;\n      }\n    }\n\n    return {\n      node: node,\n      start: start,\n      end: end,\n      collapse: collapse,\n      coverStart: mStart,\n      coverEnd: mEnd\n    };\n  }\n\n  function getUsefulRect(rects, bias) {\n    var rect = nullRect;\n\n    if (bias == "left") {\n      for (var i = 0; i < rects.length; i++) {\n        if ((rect = rects[i]).left != rect.right) {\n          break;\n        }\n      }\n    } else {\n      for (var i$1 = rects.length - 1; i$1 >= 0; i$1--) {\n        if ((rect = rects[i$1]).left != rect.right) {\n          break;\n        }\n      }\n    }\n\n    return rect;\n  }\n\n  function measureCharInner(cm, prepared, ch, bias) {\n    var place = nodeAndOffsetInLineMap(prepared.map, ch, bias);\n    var node = place.node,\n        start = place.start,\n        end = place.end,\n        collapse = place.collapse;\n    var rect;\n\n    if (node.nodeType == 3) {\n      // If it is a text node, use a range to retrieve the coordinates.\n      for (var i$1 = 0; i$1 < 4; i$1++) {\n        // Retry a maximum of 4 times when nonsense rectangles are returned\n        while (start && isExtendingChar(prepared.line.text.charAt(place.coverStart + start))) {\n          --start;\n        }\n\n        while (place.coverStart + end < place.coverEnd && isExtendingChar(prepared.line.text.charAt(place.coverStart + end))) {\n          ++end;\n        }\n\n        if (ie && ie_version < 9 && start == 0 && end == place.coverEnd - place.coverStart) {\n          rect = node.parentNode.getBoundingClientRect();\n        } else {\n          rect = getUsefulRect(range(node, start, end).getClientRects(), bias);\n        }\n\n        if (rect.left || rect.right || start == 0) {\n          break;\n        }\n\n        end = start;\n        start = start - 1;\n        collapse = "right";\n      }\n\n      if (ie && ie_version < 11) {\n        rect = maybeUpdateRectForZooming(cm.display.measure, rect);\n      }\n    } else {\n      // If it is a widget, simply get the box for the whole widget.\n      if (start > 0) {\n        collapse = bias = "right";\n      }\n\n      var rects;\n\n      if (cm.options.lineWrapping && (rects = node.getClientRects()).length > 1) {\n        rect = rects[bias == "right" ? rects.length - 1 : 0];\n      } else {\n        rect = node.getBoundingClientRect();\n      }\n    }\n\n    if (ie && ie_version < 9 && !start && (!rect || !rect.left && !rect.right)) {\n      var rSpan = node.parentNode.getClientRects()[0];\n\n      if (rSpan) {\n        rect = {\n          left: rSpan.left,\n          right: rSpan.left + charWidth(cm.display),\n          top: rSpan.top,\n          bottom: rSpan.bottom\n        };\n      } else {\n        rect = nullRect;\n      }\n    }\n\n    var rtop = rect.top - prepared.rect.top,\n        rbot = rect.bottom - prepared.rect.top;\n    var mid = (rtop + rbot) / 2;\n    var heights = prepared.view.measure.heights;\n    var i = 0;\n\n    for (; i < heights.length - 1; i++) {\n      if (mid < heights[i]) {\n        break;\n      }\n    }\n\n    var top = i ? heights[i - 1] : 0,\n        bot = heights[i];\n    var result = {\n      left: (collapse == "right" ? rect.right : rect.left) - prepared.rect.left,\n      right: (collapse == "left" ? rect.left : rect.right) - prepared.rect.left,\n      top: top,\n      bottom: bot\n    };\n\n    if (!rect.left && !rect.right) {\n      result.bogus = true;\n    }\n\n    if (!cm.options.singleCursorHeightPerLine) {\n      result.rtop = rtop;\n      result.rbottom = rbot;\n    }\n\n    return result;\n  } // Work around problem with bounding client rects on ranges being\n  // returned incorrectly when zoomed on IE10 and below.\n\n\n  function maybeUpdateRectForZooming(measure, rect) {\n    if (!window.screen || screen.logicalXDPI == null || screen.logicalXDPI == screen.deviceXDPI || !hasBadZoomedRects(measure)) {\n      return rect;\n    }\n\n    var scaleX = screen.logicalXDPI / screen.deviceXDPI;\n    var scaleY = screen.logicalYDPI / screen.deviceYDPI;\n    return {\n      left: rect.left * scaleX,\n      right: rect.right * scaleX,\n      top: rect.top * scaleY,\n      bottom: rect.bottom * scaleY\n    };\n  }\n\n  function clearLineMeasurementCacheFor(lineView) {\n    if (lineView.measure) {\n      lineView.measure.cache = {};\n      lineView.measure.heights = null;\n\n      if (lineView.rest) {\n        for (var i = 0; i < lineView.rest.length; i++) {\n          lineView.measure.caches[i] = {};\n        }\n      }\n    }\n  }\n\n  function clearLineMeasurementCache(cm) {\n    cm.display.externalMeasure = null;\n    removeChildren(cm.display.lineMeasure);\n\n    for (var i = 0; i < cm.display.view.length; i++) {\n      clearLineMeasurementCacheFor(cm.display.view[i]);\n    }\n  }\n\n  function clearCaches(cm) {\n    clearLineMeasurementCache(cm);\n    cm.display.cachedCharWidth = cm.display.cachedTextHeight = cm.display.cachedPaddingH = null;\n\n    if (!cm.options.lineWrapping) {\n      cm.display.maxLineChanged = true;\n    }\n\n    cm.display.lineNumChars = null;\n  }\n\n  function pageScrollX() {\n    // Work around https://bugs.chromium.org/p/chromium/issues/detail?id=489206\n    // which causes page_Offset and bounding client rects to use\n    // different reference viewports and invalidate our calculations.\n    if (chrome && android) {\n      return -(document.body.getBoundingClientRect().left - parseInt(getComputedStyle(document.body).marginLeft));\n    }\n\n    return window.pageXOffset || (document.documentElement || document.body).scrollLeft;\n  }\n\n  function pageScrollY() {\n    if (chrome && android) {\n      return -(document.body.getBoundingClientRect().top - parseInt(getComputedStyle(document.body).marginTop));\n    }\n\n    return window.pageYOffset || (document.documentElement || document.body).scrollTop;\n  }\n\n  function widgetTopHeight(lineObj) {\n    var height = 0;\n\n    if (lineObj.widgets) {\n      for (var i = 0; i < lineObj.widgets.length; ++i) {\n        if (lineObj.widgets[i].above) {\n          height += widgetHeight(lineObj.widgets[i]);\n        }\n      }\n    }\n\n    return height;\n  } // Converts a {top, bottom, left, right} box from line-local\n  // coordinates into another coordinate system. Context may be one of\n  // "line", "div" (display.lineDiv), "local"./null (editor), "window",\n  // or "page".\n\n\n  function intoCoordSystem(cm, lineObj, rect, context, includeWidgets) {\n    if (!includeWidgets) {\n      var height = widgetTopHeight(lineObj);\n      rect.top += height;\n      rect.bottom += height;\n    }\n\n    if (context == "line") {\n      return rect;\n    }\n\n    if (!context) {\n      context = "local";\n    }\n\n    var yOff = _heightAtLine(lineObj);\n\n    if (context == "local") {\n      yOff += paddingTop(cm.display);\n    } else {\n      yOff -= cm.display.viewOffset;\n    }\n\n    if (context == "page" || context == "window") {\n      var lOff = cm.display.lineSpace.getBoundingClientRect();\n      yOff += lOff.top + (context == "window" ? 0 : pageScrollY());\n      var xOff = lOff.left + (context == "window" ? 0 : pageScrollX());\n      rect.left += xOff;\n      rect.right += xOff;\n    }\n\n    rect.top += yOff;\n    rect.bottom += yOff;\n    return rect;\n  } // Coverts a box from "div" coords to another coordinate system.\n  // Context may be "window", "page", "div", or "local"./null.\n\n\n  function fromCoordSystem(cm, coords, context) {\n    if (context == "div") {\n      return coords;\n    }\n\n    var left = coords.left,\n        top = coords.top; // First move into "page" coordinate system\n\n    if (context == "page") {\n      left -= pageScrollX();\n      top -= pageScrollY();\n    } else if (context == "local" || !context) {\n      var localBox = cm.display.sizer.getBoundingClientRect();\n      left += localBox.left;\n      top += localBox.top;\n    }\n\n    var lineSpaceBox = cm.display.lineSpace.getBoundingClientRect();\n    return {\n      left: left - lineSpaceBox.left,\n      top: top - lineSpaceBox.top\n    };\n  }\n\n  function _charCoords(cm, pos, context, lineObj, bias) {\n    if (!lineObj) {\n      lineObj = getLine(cm.doc, pos.line);\n    }\n\n    return intoCoordSystem(cm, lineObj, measureChar(cm, lineObj, pos.ch, bias), context);\n  } // Returns a box for a given cursor position, which may have an\n  // \'other\' property containing the position of the secondary cursor\n  // on a bidi boundary.\n  // A cursor Pos(line, char, "before") is on the same visual line as `char - 1`\n  // and after `char - 1` in writing order of `char - 1`\n  // A cursor Pos(line, char, "after") is on the same visual line as `char`\n  // and before `char` in writing order of `char`\n  // Examples (upper-case letters are RTL, lower-case are LTR):\n  //     Pos(0, 1, ...)\n  //     before   after\n  // ab     a|b     a|b\n  // aB     a|B     aB|\n  // Ab     |Ab     A|b\n  // AB     B|A     B|A\n  // Every position after the last character on a line is considered to stick\n  // to the last character on the line.\n\n\n  function _cursorCoords(cm, pos, context, lineObj, preparedMeasure, varHeight) {\n    lineObj = lineObj || getLine(cm.doc, pos.line);\n\n    if (!preparedMeasure) {\n      preparedMeasure = prepareMeasureForLine(cm, lineObj);\n    }\n\n    function get(ch, right) {\n      var m = measureCharPrepared(cm, preparedMeasure, ch, right ? "right" : "left", varHeight);\n\n      if (right) {\n        m.left = m.right;\n      } else {\n        m.right = m.left;\n      }\n\n      return intoCoordSystem(cm, lineObj, m, context);\n    }\n\n    var order = getOrder(lineObj, cm.doc.direction),\n        ch = pos.ch,\n        sticky = pos.sticky;\n\n    if (ch >= lineObj.text.length) {\n      ch = lineObj.text.length;\n      sticky = "before";\n    } else if (ch <= 0) {\n      ch = 0;\n      sticky = "after";\n    }\n\n    if (!order) {\n      return get(sticky == "before" ? ch - 1 : ch, sticky == "before");\n    }\n\n    function getBidi(ch, partPos, invert) {\n      var part = order[partPos],\n          right = part.level == 1;\n      return get(invert ? ch - 1 : ch, right != invert);\n    }\n\n    var partPos = getBidiPartAt(order, ch, sticky);\n    var other = bidiOther;\n    var val = getBidi(ch, partPos, sticky == "before");\n\n    if (other != null) {\n      val.other = getBidi(ch, other, sticky != "before");\n    }\n\n    return val;\n  } // Used to cheaply estimate the coordinates for a position. Used for\n  // intermediate scroll updates.\n\n\n  function estimateCoords(cm, pos) {\n    var left = 0;\n    pos = _clipPos(cm.doc, pos);\n\n    if (!cm.options.lineWrapping) {\n      left = charWidth(cm.display) * pos.ch;\n    }\n\n    var lineObj = getLine(cm.doc, pos.line);\n    var top = _heightAtLine(lineObj) + paddingTop(cm.display);\n    return {\n      left: left,\n      right: left,\n      top: top,\n      bottom: top + lineObj.height\n    };\n  } // Positions returned by coordsChar contain some extra information.\n  // xRel is the relative x position of the input coordinates compared\n  // to the found position (so xRel > 0 means the coordinates are to\n  // the right of the character position, for example). When outside\n  // is true, that means the coordinates lie outside the line\'s\n  // vertical range.\n\n\n  function PosWithInfo(line, ch, sticky, outside, xRel) {\n    var pos = Pos(line, ch, sticky);\n    pos.xRel = xRel;\n\n    if (outside) {\n      pos.outside = outside;\n    }\n\n    return pos;\n  } // Compute the character position closest to the given coordinates.\n  // Input must be lineSpace-local ("div" coordinate system).\n\n\n  function _coordsChar(cm, x, y) {\n    var doc = cm.doc;\n    y += cm.display.viewOffset;\n\n    if (y < 0) {\n      return PosWithInfo(doc.first, 0, null, -1, -1);\n    }\n\n    var lineN = _lineAtHeight(doc, y),\n        last = doc.first + doc.size - 1;\n\n    if (lineN > last) {\n      return PosWithInfo(doc.first + doc.size - 1, getLine(doc, last).text.length, null, 1, 1);\n    }\n\n    if (x < 0) {\n      x = 0;\n    }\n\n    var lineObj = getLine(doc, lineN);\n\n    for (;;) {\n      var found = coordsCharInner(cm, lineObj, lineN, x, y);\n      var collapsed = collapsedSpanAround(lineObj, found.ch + (found.xRel > 0 || found.outside > 0 ? 1 : 0));\n\n      if (!collapsed) {\n        return found;\n      }\n\n      var rangeEnd = collapsed.find(1);\n\n      if (rangeEnd.line == lineN) {\n        return rangeEnd;\n      }\n\n      lineObj = getLine(doc, lineN = rangeEnd.line);\n    }\n  }\n\n  function wrappedLineExtent(cm, lineObj, preparedMeasure, y) {\n    y -= widgetTopHeight(lineObj);\n    var end = lineObj.text.length;\n    var begin = findFirst(function (ch) {\n      return measureCharPrepared(cm, preparedMeasure, ch - 1).bottom <= y;\n    }, end, 0);\n    end = findFirst(function (ch) {\n      return measureCharPrepared(cm, preparedMeasure, ch).top > y;\n    }, begin, end);\n    return {\n      begin: begin,\n      end: end\n    };\n  }\n\n  function wrappedLineExtentChar(cm, lineObj, preparedMeasure, target) {\n    if (!preparedMeasure) {\n      preparedMeasure = prepareMeasureForLine(cm, lineObj);\n    }\n\n    var targetTop = intoCoordSystem(cm, lineObj, measureCharPrepared(cm, preparedMeasure, target), "line").top;\n    return wrappedLineExtent(cm, lineObj, preparedMeasure, targetTop);\n  } // Returns true if the given side of a box is after the given\n  // coordinates, in top-to-bottom, left-to-right order.\n\n\n  function boxIsAfter(box, x, y, left) {\n    return box.bottom <= y ? false : box.top > y ? true : (left ? box.left : box.right) > x;\n  }\n\n  function coordsCharInner(cm, lineObj, lineNo, x, y) {\n    // Move y into line-local coordinate space\n    y -= _heightAtLine(lineObj);\n    var preparedMeasure = prepareMeasureForLine(cm, lineObj); // When directly calling `measureCharPrepared`, we have to adjust\n    // for the widgets at this line.\n\n    var widgetHeight = widgetTopHeight(lineObj);\n    var begin = 0,\n        end = lineObj.text.length,\n        ltr = true;\n    var order = getOrder(lineObj, cm.doc.direction); // If the line isn\'t plain left-to-right text, first figure out\n    // which bidi section the coordinates fall into.\n\n    if (order) {\n      var part = (cm.options.lineWrapping ? coordsBidiPartWrapped : coordsBidiPart)(cm, lineObj, lineNo, preparedMeasure, order, x, y);\n      ltr = part.level != 1; // The awkward -1 offsets are needed because findFirst (called\n      // on these below) will treat its first bound as inclusive,\n      // second as exclusive, but we want to actually address the\n      // characters in the part\'s range\n\n      begin = ltr ? part.from : part.to - 1;\n      end = ltr ? part.to : part.from - 1;\n    } // A binary search to find the first character whose bounding box\n    // starts after the coordinates. If we run across any whose box wrap\n    // the coordinates, store that.\n\n\n    var chAround = null,\n        boxAround = null;\n    var ch = findFirst(function (ch) {\n      var box = measureCharPrepared(cm, preparedMeasure, ch);\n      box.top += widgetHeight;\n      box.bottom += widgetHeight;\n\n      if (!boxIsAfter(box, x, y, false)) {\n        return false;\n      }\n\n      if (box.top <= y && box.left <= x) {\n        chAround = ch;\n        boxAround = box;\n      }\n\n      return true;\n    }, begin, end);\n    var baseX,\n        sticky,\n        outside = false; // If a box around the coordinates was found, use that\n\n    if (boxAround) {\n      // Distinguish coordinates nearer to the left or right side of the box\n      var atLeft = x - boxAround.left < boxAround.right - x,\n          atStart = atLeft == ltr;\n      ch = chAround + (atStart ? 0 : 1);\n      sticky = atStart ? "after" : "before";\n      baseX = atLeft ? boxAround.left : boxAround.right;\n    } else {\n      // (Adjust for extended bound, if necessary.)\n      if (!ltr && (ch == end || ch == begin)) {\n        ch++;\n      } // To determine which side to associate with, get the box to the\n      // left of the character and compare it\'s vertical position to the\n      // coordinates\n\n\n      sticky = ch == 0 ? "after" : ch == lineObj.text.length ? "before" : measureCharPrepared(cm, preparedMeasure, ch - (ltr ? 1 : 0)).bottom + widgetHeight <= y == ltr ? "after" : "before"; // Now get accurate coordinates for this place, in order to get a\n      // base X position\n\n      var coords = _cursorCoords(cm, Pos(lineNo, ch, sticky), "line", lineObj, preparedMeasure);\n\n      baseX = coords.left;\n      outside = y < coords.top ? -1 : y >= coords.bottom ? 1 : 0;\n    }\n\n    ch = skipExtendingChars(lineObj.text, ch, 1);\n    return PosWithInfo(lineNo, ch, sticky, outside, x - baseX);\n  }\n\n  function coordsBidiPart(cm, lineObj, lineNo, preparedMeasure, order, x, y) {\n    // Bidi parts are sorted left-to-right, and in a non-line-wrapping\n    // situation, we can take this ordering to correspond to the visual\n    // ordering. This finds the first part whose end is after the given\n    // coordinates.\n    var index = findFirst(function (i) {\n      var part = order[i],\n          ltr = part.level != 1;\n      return boxIsAfter(_cursorCoords(cm, Pos(lineNo, ltr ? part.to : part.from, ltr ? "before" : "after"), "line", lineObj, preparedMeasure), x, y, true);\n    }, 0, order.length - 1);\n    var part = order[index]; // If this isn\'t the first part, the part\'s start is also after\n    // the coordinates, and the coordinates aren\'t on the same line as\n    // that start, move one part back.\n\n    if (index > 0) {\n      var ltr = part.level != 1;\n\n      var start = _cursorCoords(cm, Pos(lineNo, ltr ? part.from : part.to, ltr ? "after" : "before"), "line", lineObj, preparedMeasure);\n\n      if (boxIsAfter(start, x, y, true) && start.top > y) {\n        part = order[index - 1];\n      }\n    }\n\n    return part;\n  }\n\n  function coordsBidiPartWrapped(cm, lineObj, _lineNo, preparedMeasure, order, x, y) {\n    // In a wrapped line, rtl text on wrapping boundaries can do things\n    // that don\'t correspond to the ordering in our `order` array at\n    // all, so a binary search doesn\'t work, and we want to return a\n    // part that only spans one line so that the binary search in\n    // coordsCharInner is safe. As such, we first find the extent of the\n    // wrapped line, and then do a flat search in which we discard any\n    // spans that aren\'t on the line.\n    var ref = wrappedLineExtent(cm, lineObj, preparedMeasure, y);\n    var begin = ref.begin;\n    var end = ref.end;\n\n    if (/\\s/.test(lineObj.text.charAt(end - 1))) {\n      end--;\n    }\n\n    var part = null,\n        closestDist = null;\n\n    for (var i = 0; i < order.length; i++) {\n      var p = order[i];\n\n      if (p.from >= end || p.to <= begin) {\n        continue;\n      }\n\n      var ltr = p.level != 1;\n      var endX = measureCharPrepared(cm, preparedMeasure, ltr ? Math.min(end, p.to) - 1 : Math.max(begin, p.from)).right; // Weigh against spans ending before this, so that they are only\n      // picked if nothing ends after\n\n      var dist = endX < x ? x - endX + 1e9 : endX - x;\n\n      if (!part || closestDist > dist) {\n        part = p;\n        closestDist = dist;\n      }\n    }\n\n    if (!part) {\n      part = order[order.length - 1];\n    } // Clip the part to the wrapped line.\n\n\n    if (part.from < begin) {\n      part = {\n        from: begin,\n        to: part.to,\n        level: part.level\n      };\n    }\n\n    if (part.to > end) {\n      part = {\n        from: part.from,\n        to: end,\n        level: part.level\n      };\n    }\n\n    return part;\n  }\n\n  var measureText; // Compute the default text height.\n\n  function textHeight(display) {\n    if (display.cachedTextHeight != null) {\n      return display.cachedTextHeight;\n    }\n\n    if (measureText == null) {\n      measureText = elt("pre", null, "CodeMirror-line-like"); // Measure a bunch of lines, for browsers that compute\n      // fractional heights.\n\n      for (var i = 0; i < 49; ++i) {\n        measureText.appendChild(document.createTextNode("x"));\n        measureText.appendChild(elt("br"));\n      }\n\n      measureText.appendChild(document.createTextNode("x"));\n    }\n\n    removeChildrenAndAdd(display.measure, measureText);\n    var height = measureText.offsetHeight / 50;\n\n    if (height > 3) {\n      display.cachedTextHeight = height;\n    }\n\n    removeChildren(display.measure);\n    return height || 1;\n  } // Compute the default character width.\n\n\n  function charWidth(display) {\n    if (display.cachedCharWidth != null) {\n      return display.cachedCharWidth;\n    }\n\n    var anchor = elt("span", "xxxxxxxxxx");\n    var pre = elt("pre", [anchor], "CodeMirror-line-like");\n    removeChildrenAndAdd(display.measure, pre);\n    var rect = anchor.getBoundingClientRect(),\n        width = (rect.right - rect.left) / 10;\n\n    if (width > 2) {\n      display.cachedCharWidth = width;\n    }\n\n    return width || 10;\n  } // Do a bulk-read of the DOM positions and sizes needed to draw the\n  // view, so that we don\'t interleave reading and writing to the DOM.\n\n\n  function getDimensions(cm) {\n    var d = cm.display,\n        left = {},\n        width = {};\n    var gutterLeft = d.gutters.clientLeft;\n\n    for (var n = d.gutters.firstChild, i = 0; n; n = n.nextSibling, ++i) {\n      var id = cm.display.gutterSpecs[i].className;\n      left[id] = n.offsetLeft + n.clientLeft + gutterLeft;\n      width[id] = n.clientWidth;\n    }\n\n    return {\n      fixedPos: compensateForHScroll(d),\n      gutterTotalWidth: d.gutters.offsetWidth,\n      gutterLeft: left,\n      gutterWidth: width,\n      wrapperWidth: d.wrapper.clientWidth\n    };\n  } // Computes display.scroller.scrollLeft + display.gutters.offsetWidth,\n  // but using getBoundingClientRect to get a sub-pixel-accurate\n  // result.\n\n\n  function compensateForHScroll(display) {\n    return display.scroller.getBoundingClientRect().left - display.sizer.getBoundingClientRect().left;\n  } // Returns a function that estimates the height of a line, to use as\n  // first approximation until the line becomes visible (and is thus\n  // properly measurable).\n\n\n  function estimateHeight(cm) {\n    var th = textHeight(cm.display),\n        wrapping = cm.options.lineWrapping;\n    var perLine = wrapping && Math.max(5, cm.display.scroller.clientWidth / charWidth(cm.display) - 3);\n    return function (line) {\n      if (lineIsHidden(cm.doc, line)) {\n        return 0;\n      }\n\n      var widgetsHeight = 0;\n\n      if (line.widgets) {\n        for (var i = 0; i < line.widgets.length; i++) {\n          if (line.widgets[i].height) {\n            widgetsHeight += line.widgets[i].height;\n          }\n        }\n      }\n\n      if (wrapping) {\n        return widgetsHeight + (Math.ceil(line.text.length / perLine) || 1) * th;\n      } else {\n        return widgetsHeight + th;\n      }\n    };\n  }\n\n  function estimateLineHeights(cm) {\n    var doc = cm.doc,\n        est = estimateHeight(cm);\n    doc.iter(function (line) {\n      var estHeight = est(line);\n\n      if (estHeight != line.height) {\n        updateLineHeight(line, estHeight);\n      }\n    });\n  } // Given a mouse event, find the corresponding position. If liberal\n  // is false, it checks whether a gutter or scrollbar was clicked,\n  // and returns null if it was. forRect is used by rectangular\n  // selections, and tries to estimate a character position even for\n  // coordinates beyond the right of the text.\n\n\n  function posFromMouse(cm, e, liberal, forRect) {\n    var display = cm.display;\n\n    if (!liberal && e_target(e).getAttribute("cm-not-content") == "true") {\n      return null;\n    }\n\n    var x,\n        y,\n        space = display.lineSpace.getBoundingClientRect(); // Fails unpredictably on IE[67] when mouse is dragged around quickly.\n\n    try {\n      x = e.clientX - space.left;\n      y = e.clientY - space.top;\n    } catch (e) {\n      return null;\n    }\n\n    var coords = _coordsChar(cm, x, y),\n        line;\n\n    if (forRect && coords.xRel > 0 && (line = getLine(cm.doc, coords.line).text).length == coords.ch) {\n      var colDiff = countColumn(line, line.length, cm.options.tabSize) - line.length;\n      coords = Pos(coords.line, Math.max(0, Math.round((x - paddingH(cm.display).left) / charWidth(cm.display)) - colDiff));\n    }\n\n    return coords;\n  } // Find the view element corresponding to a given line. Return null\n  // when the line isn\'t visible.\n\n\n  function findViewIndex(cm, n) {\n    if (n >= cm.display.viewTo) {\n      return null;\n    }\n\n    n -= cm.display.viewFrom;\n\n    if (n < 0) {\n      return null;\n    }\n\n    var view = cm.display.view;\n\n    for (var i = 0; i < view.length; i++) {\n      n -= view[i].size;\n\n      if (n < 0) {\n        return i;\n      }\n    }\n  } // Updates the display.view data structure for a given change to the\n  // document. From and to are in pre-change coordinates. Lendiff is\n  // the amount of lines added or subtracted by the change. This is\n  // used for changes that span multiple lines, or change the way\n  // lines are divided into visual lines. regLineChange (below)\n  // registers single-line changes.\n\n\n  function regChange(cm, from, to, lendiff) {\n    if (from == null) {\n      from = cm.doc.first;\n    }\n\n    if (to == null) {\n      to = cm.doc.first + cm.doc.size;\n    }\n\n    if (!lendiff) {\n      lendiff = 0;\n    }\n\n    var display = cm.display;\n\n    if (lendiff && to < display.viewTo && (display.updateLineNumbers == null || display.updateLineNumbers > from)) {\n      display.updateLineNumbers = from;\n    }\n\n    cm.curOp.viewChanged = true;\n\n    if (from >= display.viewTo) {\n      // Change after\n      if (sawCollapsedSpans && visualLineNo(cm.doc, from) < display.viewTo) {\n        resetView(cm);\n      }\n    } else if (to <= display.viewFrom) {\n      // Change before\n      if (sawCollapsedSpans && visualLineEndNo(cm.doc, to + lendiff) > display.viewFrom) {\n        resetView(cm);\n      } else {\n        display.viewFrom += lendiff;\n        display.viewTo += lendiff;\n      }\n    } else if (from <= display.viewFrom && to >= display.viewTo) {\n      // Full overlap\n      resetView(cm);\n    } else if (from <= display.viewFrom) {\n      // Top overlap\n      var cut = viewCuttingPoint(cm, to, to + lendiff, 1);\n\n      if (cut) {\n        display.view = display.view.slice(cut.index);\n        display.viewFrom = cut.lineN;\n        display.viewTo += lendiff;\n      } else {\n        resetView(cm);\n      }\n    } else if (to >= display.viewTo) {\n      // Bottom overlap\n      var cut$1 = viewCuttingPoint(cm, from, from, -1);\n\n      if (cut$1) {\n        display.view = display.view.slice(0, cut$1.index);\n        display.viewTo = cut$1.lineN;\n      } else {\n        resetView(cm);\n      }\n    } else {\n      // Gap in the middle\n      var cutTop = viewCuttingPoint(cm, from, from, -1);\n      var cutBot = viewCuttingPoint(cm, to, to + lendiff, 1);\n\n      if (cutTop && cutBot) {\n        display.view = display.view.slice(0, cutTop.index).concat(buildViewArray(cm, cutTop.lineN, cutBot.lineN)).concat(display.view.slice(cutBot.index));\n        display.viewTo += lendiff;\n      } else {\n        resetView(cm);\n      }\n    }\n\n    var ext = display.externalMeasured;\n\n    if (ext) {\n      if (to < ext.lineN) {\n        ext.lineN += lendiff;\n      } else if (from < ext.lineN + ext.size) {\n        display.externalMeasured = null;\n      }\n    }\n  } // Register a change to a single line. Type must be one of "text",\n  // "gutter", "class", "widget"\n\n\n  function regLineChange(cm, line, type) {\n    cm.curOp.viewChanged = true;\n    var display = cm.display,\n        ext = cm.display.externalMeasured;\n\n    if (ext && line >= ext.lineN && line < ext.lineN + ext.size) {\n      display.externalMeasured = null;\n    }\n\n    if (line < display.viewFrom || line >= display.viewTo) {\n      return;\n    }\n\n    var lineView = display.view[findViewIndex(cm, line)];\n\n    if (lineView.node == null) {\n      return;\n    }\n\n    var arr = lineView.changes || (lineView.changes = []);\n\n    if (indexOf(arr, type) == -1) {\n      arr.push(type);\n    }\n  } // Clear the view.\n\n\n  function resetView(cm) {\n    cm.display.viewFrom = cm.display.viewTo = cm.doc.first;\n    cm.display.view = [];\n    cm.display.viewOffset = 0;\n  }\n\n  function viewCuttingPoint(cm, oldN, newN, dir) {\n    var index = findViewIndex(cm, oldN),\n        diff,\n        view = cm.display.view;\n\n    if (!sawCollapsedSpans || newN == cm.doc.first + cm.doc.size) {\n      return {\n        index: index,\n        lineN: newN\n      };\n    }\n\n    var n = cm.display.viewFrom;\n\n    for (var i = 0; i < index; i++) {\n      n += view[i].size;\n    }\n\n    if (n != oldN) {\n      if (dir > 0) {\n        if (index == view.length - 1) {\n          return null;\n        }\n\n        diff = n + view[index].size - oldN;\n        index++;\n      } else {\n        diff = n - oldN;\n      }\n\n      oldN += diff;\n      newN += diff;\n    }\n\n    while (visualLineNo(cm.doc, newN) != newN) {\n      if (index == (dir < 0 ? 0 : view.length - 1)) {\n        return null;\n      }\n\n      newN += dir * view[index - (dir < 0 ? 1 : 0)].size;\n      index += dir;\n    }\n\n    return {\n      index: index,\n      lineN: newN\n    };\n  } // Force the view to cover a given range, adding empty view element\n  // or clipping off existing ones as needed.\n\n\n  function adjustView(cm, from, to) {\n    var display = cm.display,\n        view = display.view;\n\n    if (view.length == 0 || from >= display.viewTo || to <= display.viewFrom) {\n      display.view = buildViewArray(cm, from, to);\n      display.viewFrom = from;\n    } else {\n      if (display.viewFrom > from) {\n        display.view = buildViewArray(cm, from, display.viewFrom).concat(display.view);\n      } else if (display.viewFrom < from) {\n        display.view = display.view.slice(findViewIndex(cm, from));\n      }\n\n      display.viewFrom = from;\n\n      if (display.viewTo < to) {\n        display.view = display.view.concat(buildViewArray(cm, display.viewTo, to));\n      } else if (display.viewTo > to) {\n        display.view = display.view.slice(0, findViewIndex(cm, to));\n      }\n    }\n\n    display.viewTo = to;\n  } // Count the number of lines in the view whose DOM representation is\n  // out of date (or nonexistent).\n\n\n  function countDirtyView(cm) {\n    var view = cm.display.view,\n        dirty = 0;\n\n    for (var i = 0; i < view.length; i++) {\n      var lineView = view[i];\n\n      if (!lineView.hidden && (!lineView.node || lineView.changes)) {\n        ++dirty;\n      }\n    }\n\n    return dirty;\n  }\n\n  function updateSelection(cm) {\n    cm.display.input.showSelection(cm.display.input.prepareSelection());\n  }\n\n  function prepareSelection(cm, primary) {\n    if (primary === void 0) primary = true;\n    var doc = cm.doc,\n        result = {};\n    var curFragment = result.cursors = document.createDocumentFragment();\n    var selFragment = result.selection = document.createDocumentFragment();\n\n    for (var i = 0; i < doc.sel.ranges.length; i++) {\n      if (!primary && i == doc.sel.primIndex) {\n        continue;\n      }\n\n      var range = doc.sel.ranges[i];\n\n      if (range.from().line >= cm.display.viewTo || range.to().line < cm.display.viewFrom) {\n        continue;\n      }\n\n      var collapsed = range.empty();\n\n      if (collapsed || cm.options.showCursorWhenSelecting) {\n        drawSelectionCursor(cm, range.head, curFragment);\n      }\n\n      if (!collapsed) {\n        drawSelectionRange(cm, range, selFragment);\n      }\n    }\n\n    return result;\n  } // Draws a cursor for the given range\n\n\n  function drawSelectionCursor(cm, head, output) {\n    var pos = _cursorCoords(cm, head, "div", null, null, !cm.options.singleCursorHeightPerLine);\n\n    var cursor = output.appendChild(elt("div", "\\xA0", "CodeMirror-cursor"));\n    cursor.style.left = pos.left + "px";\n    cursor.style.top = pos.top + "px";\n    cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + "px";\n\n    if (pos.other) {\n      // Secondary cursor, shown when on a \'jump\' in bi-directional text\n      var otherCursor = output.appendChild(elt("div", "\\xA0", "CodeMirror-cursor CodeMirror-secondarycursor"));\n      otherCursor.style.display = "";\n      otherCursor.style.left = pos.other.left + "px";\n      otherCursor.style.top = pos.other.top + "px";\n      otherCursor.style.height = (pos.other.bottom - pos.other.top) * .85 + "px";\n    }\n  }\n\n  function cmpCoords(a, b) {\n    return a.top - b.top || a.left - b.left;\n  } // Draws the given range as a highlighted selection\n\n\n  function drawSelectionRange(cm, range, output) {\n    var display = cm.display,\n        doc = cm.doc;\n    var fragment = document.createDocumentFragment();\n    var padding = paddingH(cm.display),\n        leftSide = padding.left;\n    var rightSide = Math.max(display.sizerWidth, displayWidth(cm) - display.sizer.offsetLeft) - padding.right;\n    var docLTR = doc.direction == "ltr";\n\n    function add(left, top, width, bottom) {\n      if (top < 0) {\n        top = 0;\n      }\n\n      top = Math.round(top);\n      bottom = Math.round(bottom);\n      fragment.appendChild(elt("div", null, "CodeMirror-selected", "position: absolute; left: " + left + "px;\\n                             top: " + top + "px; width: " + (width == null ? rightSide - left : width) + "px;\\n                             height: " + (bottom - top) + "px"));\n    }\n\n    function drawForLine(line, fromArg, toArg) {\n      var lineObj = getLine(doc, line);\n      var lineLen = lineObj.text.length;\n      var start, end;\n\n      function coords(ch, bias) {\n        return _charCoords(cm, Pos(line, ch), "div", lineObj, bias);\n      }\n\n      function wrapX(pos, dir, side) {\n        var extent = wrappedLineExtentChar(cm, lineObj, null, pos);\n        var prop = dir == "ltr" == (side == "after") ? "left" : "right";\n        var ch = side == "after" ? extent.begin : extent.end - (/\\s/.test(lineObj.text.charAt(extent.end - 1)) ? 2 : 1);\n        return coords(ch, prop)[prop];\n      }\n\n      var order = getOrder(lineObj, doc.direction);\n      iterateBidiSections(order, fromArg || 0, toArg == null ? lineLen : toArg, function (from, to, dir, i) {\n        var ltr = dir == "ltr";\n        var fromPos = coords(from, ltr ? "left" : "right");\n        var toPos = coords(to - 1, ltr ? "right" : "left");\n        var openStart = fromArg == null && from == 0,\n            openEnd = toArg == null && to == lineLen;\n        var first = i == 0,\n            last = !order || i == order.length - 1;\n\n        if (toPos.top - fromPos.top <= 3) {\n          // Single line\n          var openLeft = (docLTR ? openStart : openEnd) && first;\n          var openRight = (docLTR ? openEnd : openStart) && last;\n          var left = openLeft ? leftSide : (ltr ? fromPos : toPos).left;\n          var right = openRight ? rightSide : (ltr ? toPos : fromPos).right;\n          add(left, fromPos.top, right - left, fromPos.bottom);\n        } else {\n          // Multiple lines\n          var topLeft, topRight, botLeft, botRight;\n\n          if (ltr) {\n            topLeft = docLTR && openStart && first ? leftSide : fromPos.left;\n            topRight = docLTR ? rightSide : wrapX(from, dir, "before");\n            botLeft = docLTR ? leftSide : wrapX(to, dir, "after");\n            botRight = docLTR && openEnd && last ? rightSide : toPos.right;\n          } else {\n            topLeft = !docLTR ? leftSide : wrapX(from, dir, "before");\n            topRight = !docLTR && openStart && first ? rightSide : fromPos.right;\n            botLeft = !docLTR && openEnd && last ? leftSide : toPos.left;\n            botRight = !docLTR ? rightSide : wrapX(to, dir, "after");\n          }\n\n          add(topLeft, fromPos.top, topRight - topLeft, fromPos.bottom);\n\n          if (fromPos.bottom < toPos.top) {\n            add(leftSide, fromPos.bottom, null, toPos.top);\n          }\n\n          add(botLeft, toPos.top, botRight - botLeft, toPos.bottom);\n        }\n\n        if (!start || cmpCoords(fromPos, start) < 0) {\n          start = fromPos;\n        }\n\n        if (cmpCoords(toPos, start) < 0) {\n          start = toPos;\n        }\n\n        if (!end || cmpCoords(fromPos, end) < 0) {\n          end = fromPos;\n        }\n\n        if (cmpCoords(toPos, end) < 0) {\n          end = toPos;\n        }\n      });\n      return {\n        start: start,\n        end: end\n      };\n    }\n\n    var sFrom = range.from(),\n        sTo = range.to();\n\n    if (sFrom.line == sTo.line) {\n      drawForLine(sFrom.line, sFrom.ch, sTo.ch);\n    } else {\n      var fromLine = getLine(doc, sFrom.line),\n          toLine = getLine(doc, sTo.line);\n      var singleVLine = visualLine(fromLine) == visualLine(toLine);\n      var leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end;\n      var rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start;\n\n      if (singleVLine) {\n        if (leftEnd.top < rightStart.top - 2) {\n          add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);\n          add(leftSide, rightStart.top, rightStart.left, rightStart.bottom);\n        } else {\n          add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom);\n        }\n      }\n\n      if (leftEnd.bottom < rightStart.top) {\n        add(leftSide, leftEnd.bottom, null, rightStart.top);\n      }\n    }\n\n    output.appendChild(fragment);\n  } // Cursor-blinking\n\n\n  function restartBlink(cm) {\n    if (!cm.state.focused) {\n      return;\n    }\n\n    var display = cm.display;\n    clearInterval(display.blinker);\n    var on = true;\n    display.cursorDiv.style.visibility = "";\n\n    if (cm.options.cursorBlinkRate > 0) {\n      display.blinker = setInterval(function () {\n        return display.cursorDiv.style.visibility = (on = !on) ? "" : "hidden";\n      }, cm.options.cursorBlinkRate);\n    } else if (cm.options.cursorBlinkRate < 0) {\n      display.cursorDiv.style.visibility = "hidden";\n    }\n  }\n\n  function ensureFocus(cm) {\n    if (!cm.state.focused) {\n      cm.display.input.focus();\n      onFocus(cm);\n    }\n  }\n\n  function delayBlurEvent(cm) {\n    cm.state.delayingBlurEvent = true;\n    setTimeout(function () {\n      if (cm.state.delayingBlurEvent) {\n        cm.state.delayingBlurEvent = false;\n        onBlur(cm);\n      }\n    }, 100);\n  }\n\n  function onFocus(cm, e) {\n    if (cm.state.delayingBlurEvent) {\n      cm.state.delayingBlurEvent = false;\n    }\n\n    if (cm.options.readOnly == "nocursor") {\n      return;\n    }\n\n    if (!cm.state.focused) {\n      signal(cm, "focus", cm, e);\n      cm.state.focused = true;\n      addClass(cm.display.wrapper, "CodeMirror-focused"); // This test prevents this from firing when a context\n      // menu is closed (since the input reset would kill the\n      // select-all detection hack)\n\n      if (!cm.curOp && cm.display.selForContextMenu != cm.doc.sel) {\n        cm.display.input.reset();\n\n        if (webkit) {\n          setTimeout(function () {\n            return cm.display.input.reset(true);\n          }, 20);\n        } // Issue #1730\n\n      }\n\n      cm.display.input.receivedFocus();\n    }\n\n    restartBlink(cm);\n  }\n\n  function onBlur(cm, e) {\n    if (cm.state.delayingBlurEvent) {\n      return;\n    }\n\n    if (cm.state.focused) {\n      signal(cm, "blur", cm, e);\n      cm.state.focused = false;\n      rmClass(cm.display.wrapper, "CodeMirror-focused");\n    }\n\n    clearInterval(cm.display.blinker);\n    setTimeout(function () {\n      if (!cm.state.focused) {\n        cm.display.shift = false;\n      }\n    }, 150);\n  } // Read the actual heights of the rendered lines, and update their\n  // stored heights to match.\n\n\n  function updateHeightsInViewport(cm) {\n    var display = cm.display;\n    var prevBottom = display.lineDiv.offsetTop;\n\n    for (var i = 0; i < display.view.length; i++) {\n      var cur = display.view[i],\n          wrapping = cm.options.lineWrapping;\n      var height = void 0,\n          width = 0;\n\n      if (cur.hidden) {\n        continue;\n      }\n\n      if (ie && ie_version < 8) {\n        var bot = cur.node.offsetTop + cur.node.offsetHeight;\n        height = bot - prevBottom;\n        prevBottom = bot;\n      } else {\n        var box = cur.node.getBoundingClientRect();\n        height = box.bottom - box.top; // Check that lines don\'t extend past the right of the current\n        // editor width\n\n        if (!wrapping && cur.text.firstChild) {\n          width = cur.text.firstChild.getBoundingClientRect().right - box.left - 1;\n        }\n      }\n\n      var diff = cur.line.height - height;\n\n      if (diff > .005 || diff < -.005) {\n        updateLineHeight(cur.line, height);\n        updateWidgetHeight(cur.line);\n\n        if (cur.rest) {\n          for (var j = 0; j < cur.rest.length; j++) {\n            updateWidgetHeight(cur.rest[j]);\n          }\n        }\n      }\n\n      if (width > cm.display.sizerWidth) {\n        var chWidth = Math.ceil(width / charWidth(cm.display));\n\n        if (chWidth > cm.display.maxLineLength) {\n          cm.display.maxLineLength = chWidth;\n          cm.display.maxLine = cur.line;\n          cm.display.maxLineChanged = true;\n        }\n      }\n    }\n  } // Read and store the height of line widgets associated with the\n  // given line.\n\n\n  function updateWidgetHeight(line) {\n    if (line.widgets) {\n      for (var i = 0; i < line.widgets.length; ++i) {\n        var w = line.widgets[i],\n            parent = w.node.parentNode;\n\n        if (parent) {\n          w.height = parent.offsetHeight;\n        }\n      }\n    }\n  } // Compute the lines that are visible in a given viewport (defaults\n  // the the current scroll position). viewport may contain top,\n  // height, and ensure (see op.scrollToPos) properties.\n\n\n  function visibleLines(display, doc, viewport) {\n    var top = viewport && viewport.top != null ? Math.max(0, viewport.top) : display.scroller.scrollTop;\n    top = Math.floor(top - paddingTop(display));\n    var bottom = viewport && viewport.bottom != null ? viewport.bottom : top + display.wrapper.clientHeight;\n\n    var from = _lineAtHeight(doc, top),\n        to = _lineAtHeight(doc, bottom); // Ensure is a {from: {line, ch}, to: {line, ch}} object, and\n    // forces those lines into the viewport (if possible).\n\n\n    if (viewport && viewport.ensure) {\n      var ensureFrom = viewport.ensure.from.line,\n          ensureTo = viewport.ensure.to.line;\n\n      if (ensureFrom < from) {\n        from = ensureFrom;\n        to = _lineAtHeight(doc, _heightAtLine(getLine(doc, ensureFrom)) + display.wrapper.clientHeight);\n      } else if (Math.min(ensureTo, doc.lastLine()) >= to) {\n        from = _lineAtHeight(doc, _heightAtLine(getLine(doc, ensureTo)) - display.wrapper.clientHeight);\n        to = ensureTo;\n      }\n    }\n\n    return {\n      from: from,\n      to: Math.max(to, from + 1)\n    };\n  } // SCROLLING THINGS INTO VIEW\n  // If an editor sits on the top or bottom of the window, partially\n  // scrolled out of view, this ensures that the cursor is visible.\n\n\n  function maybeScrollWindow(cm, rect) {\n    if (signalDOMEvent(cm, "scrollCursorIntoView")) {\n      return;\n    }\n\n    var display = cm.display,\n        box = display.sizer.getBoundingClientRect(),\n        doScroll = null;\n\n    if (rect.top + box.top < 0) {\n      doScroll = true;\n    } else if (rect.bottom + box.top > (window.innerHeight || document.documentElement.clientHeight)) {\n      doScroll = false;\n    }\n\n    if (doScroll != null && !phantom) {\n      var scrollNode = elt("div", "\\u200B", null, "position: absolute;\\n                         top: " + (rect.top - display.viewOffset - paddingTop(cm.display)) + "px;\\n                         height: " + (rect.bottom - rect.top + scrollGap(cm) + display.barHeight) + "px;\\n                         left: " + rect.left + "px; width: " + Math.max(2, rect.right - rect.left) + "px;");\n      cm.display.lineSpace.appendChild(scrollNode);\n      scrollNode.scrollIntoView(doScroll);\n      cm.display.lineSpace.removeChild(scrollNode);\n    }\n  } // Scroll a given position into view (immediately), verifying that\n  // it actually became visible (as line heights are accurately\n  // measured, the position of something may \'drift\' during drawing).\n\n\n  function scrollPosIntoView(cm, pos, end, margin) {\n    if (margin == null) {\n      margin = 0;\n    }\n\n    var rect;\n\n    if (!cm.options.lineWrapping && pos == end) {\n      // Set pos and end to the cursor positions around the character pos sticks to\n      // If pos.sticky == "before", that is around pos.ch - 1, otherwise around pos.ch\n      // If pos == Pos(_, 0, "before"), pos and end are unchanged\n      pos = pos.ch ? Pos(pos.line, pos.sticky == "before" ? pos.ch - 1 : pos.ch, "after") : pos;\n      end = pos.sticky == "before" ? Pos(pos.line, pos.ch + 1, "before") : pos;\n    }\n\n    for (var limit = 0; limit < 5; limit++) {\n      var changed = false;\n\n      var coords = _cursorCoords(cm, pos);\n\n      var endCoords = !end || end == pos ? coords : _cursorCoords(cm, end);\n      rect = {\n        left: Math.min(coords.left, endCoords.left),\n        top: Math.min(coords.top, endCoords.top) - margin,\n        right: Math.max(coords.left, endCoords.left),\n        bottom: Math.max(coords.bottom, endCoords.bottom) + margin\n      };\n      var scrollPos = calculateScrollPos(cm, rect);\n      var startTop = cm.doc.scrollTop,\n          startLeft = cm.doc.scrollLeft;\n\n      if (scrollPos.scrollTop != null) {\n        updateScrollTop(cm, scrollPos.scrollTop);\n\n        if (Math.abs(cm.doc.scrollTop - startTop) > 1) {\n          changed = true;\n        }\n      }\n\n      if (scrollPos.scrollLeft != null) {\n        setScrollLeft(cm, scrollPos.scrollLeft);\n\n        if (Math.abs(cm.doc.scrollLeft - startLeft) > 1) {\n          changed = true;\n        }\n      }\n\n      if (!changed) {\n        break;\n      }\n    }\n\n    return rect;\n  } // Scroll a given set of coordinates into view (immediately).\n\n\n  function scrollIntoView(cm, rect) {\n    var scrollPos = calculateScrollPos(cm, rect);\n\n    if (scrollPos.scrollTop != null) {\n      updateScrollTop(cm, scrollPos.scrollTop);\n    }\n\n    if (scrollPos.scrollLeft != null) {\n      setScrollLeft(cm, scrollPos.scrollLeft);\n    }\n  } // Calculate a new scroll position needed to scroll the given\n  // rectangle into view. Returns an object with scrollTop and\n  // scrollLeft properties. When these are undefined, the\n  // vertical/horizontal position does not need to be adjusted.\n\n\n  function calculateScrollPos(cm, rect) {\n    var display = cm.display,\n        snapMargin = textHeight(cm.display);\n\n    if (rect.top < 0) {\n      rect.top = 0;\n    }\n\n    var screentop = cm.curOp && cm.curOp.scrollTop != null ? cm.curOp.scrollTop : display.scroller.scrollTop;\n    var screen = displayHeight(cm),\n        result = {};\n\n    if (rect.bottom - rect.top > screen) {\n      rect.bottom = rect.top + screen;\n    }\n\n    var docBottom = cm.doc.height + paddingVert(display);\n    var atTop = rect.top < snapMargin,\n        atBottom = rect.bottom > docBottom - snapMargin;\n\n    if (rect.top < screentop) {\n      result.scrollTop = atTop ? 0 : rect.top;\n    } else if (rect.bottom > screentop + screen) {\n      var newTop = Math.min(rect.top, (atBottom ? docBottom : rect.bottom) - screen);\n\n      if (newTop != screentop) {\n        result.scrollTop = newTop;\n      }\n    }\n\n    var screenleft = cm.curOp && cm.curOp.scrollLeft != null ? cm.curOp.scrollLeft : display.scroller.scrollLeft;\n    var screenw = displayWidth(cm) - (cm.options.fixedGutter ? display.gutters.offsetWidth : 0);\n    var tooWide = rect.right - rect.left > screenw;\n\n    if (tooWide) {\n      rect.right = rect.left + screenw;\n    }\n\n    if (rect.left < 10) {\n      result.scrollLeft = 0;\n    } else if (rect.left < screenleft) {\n      result.scrollLeft = Math.max(0, rect.left - (tooWide ? 0 : 10));\n    } else if (rect.right > screenw + screenleft - 3) {\n      result.scrollLeft = rect.right + (tooWide ? 0 : 10) - screenw;\n    }\n\n    return result;\n  } // Store a relative adjustment to the scroll position in the current\n  // operation (to be applied when the operation finishes).\n\n\n  function addToScrollTop(cm, top) {\n    if (top == null) {\n      return;\n    }\n\n    resolveScrollToPos(cm);\n    cm.curOp.scrollTop = (cm.curOp.scrollTop == null ? cm.doc.scrollTop : cm.curOp.scrollTop) + top;\n  } // Make sure that at the end of the operation the current cursor is\n  // shown.\n\n\n  function ensureCursorVisible(cm) {\n    resolveScrollToPos(cm);\n    var cur = cm.getCursor();\n    cm.curOp.scrollToPos = {\n      from: cur,\n      to: cur,\n      margin: cm.options.cursorScrollMargin\n    };\n  }\n\n  function scrollToCoords(cm, x, y) {\n    if (x != null || y != null) {\n      resolveScrollToPos(cm);\n    }\n\n    if (x != null) {\n      cm.curOp.scrollLeft = x;\n    }\n\n    if (y != null) {\n      cm.curOp.scrollTop = y;\n    }\n  }\n\n  function scrollToRange(cm, range) {\n    resolveScrollToPos(cm);\n    cm.curOp.scrollToPos = range;\n  } // When an operation has its scrollToPos property set, and another\n  // scroll action is applied before the end of the operation, this\n  // \'simulates\' scrolling that position into view in a cheap way, so\n  // that the effect of intermediate scroll commands is not ignored.\n\n\n  function resolveScrollToPos(cm) {\n    var range = cm.curOp.scrollToPos;\n\n    if (range) {\n      cm.curOp.scrollToPos = null;\n      var from = estimateCoords(cm, range.from),\n          to = estimateCoords(cm, range.to);\n      scrollToCoordsRange(cm, from, to, range.margin);\n    }\n  }\n\n  function scrollToCoordsRange(cm, from, to, margin) {\n    var sPos = calculateScrollPos(cm, {\n      left: Math.min(from.left, to.left),\n      top: Math.min(from.top, to.top) - margin,\n      right: Math.max(from.right, to.right),\n      bottom: Math.max(from.bottom, to.bottom) + margin\n    });\n    scrollToCoords(cm, sPos.scrollLeft, sPos.scrollTop);\n  } // Sync the scrollable area and scrollbars, ensure the viewport\n  // covers the visible area.\n\n\n  function updateScrollTop(cm, val) {\n    if (Math.abs(cm.doc.scrollTop - val) < 2) {\n      return;\n    }\n\n    if (!gecko) {\n      updateDisplaySimple(cm, {\n        top: val\n      });\n    }\n\n    setScrollTop(cm, val, true);\n\n    if (gecko) {\n      updateDisplaySimple(cm);\n    }\n\n    startWorker(cm, 100);\n  }\n\n  function setScrollTop(cm, val, forceScroll) {\n    val = Math.min(cm.display.scroller.scrollHeight - cm.display.scroller.clientHeight, val);\n\n    if (cm.display.scroller.scrollTop == val && !forceScroll) {\n      return;\n    }\n\n    cm.doc.scrollTop = val;\n    cm.display.scrollbars.setScrollTop(val);\n\n    if (cm.display.scroller.scrollTop != val) {\n      cm.display.scroller.scrollTop = val;\n    }\n  } // Sync scroller and scrollbar, ensure the gutter elements are\n  // aligned.\n\n\n  function setScrollLeft(cm, val, isScroller, forceScroll) {\n    val = Math.min(val, cm.display.scroller.scrollWidth - cm.display.scroller.clientWidth);\n\n    if ((isScroller ? val == cm.doc.scrollLeft : Math.abs(cm.doc.scrollLeft - val) < 2) && !forceScroll) {\n      return;\n    }\n\n    cm.doc.scrollLeft = val;\n    alignHorizontally(cm);\n\n    if (cm.display.scroller.scrollLeft != val) {\n      cm.display.scroller.scrollLeft = val;\n    }\n\n    cm.display.scrollbars.setScrollLeft(val);\n  } // SCROLLBARS\n  // Prepare DOM reads needed to update the scrollbars. Done in one\n  // shot to minimize update/measure roundtrips.\n\n\n  function measureForScrollbars(cm) {\n    var d = cm.display,\n        gutterW = d.gutters.offsetWidth;\n    var docH = Math.round(cm.doc.height + paddingVert(cm.display));\n    return {\n      clientHeight: d.scroller.clientHeight,\n      viewHeight: d.wrapper.clientHeight,\n      scrollWidth: d.scroller.scrollWidth,\n      clientWidth: d.scroller.clientWidth,\n      viewWidth: d.wrapper.clientWidth,\n      barLeft: cm.options.fixedGutter ? gutterW : 0,\n      docHeight: docH,\n      scrollHeight: docH + scrollGap(cm) + d.barHeight,\n      nativeBarWidth: d.nativeBarWidth,\n      gutterWidth: gutterW\n    };\n  }\n\n  var NativeScrollbars = function NativeScrollbars(place, scroll, cm) {\n    this.cm = cm;\n    var vert = this.vert = elt("div", [elt("div", null, null, "min-width: 1px")], "CodeMirror-vscrollbar");\n    var horiz = this.horiz = elt("div", [elt("div", null, null, "height: 100%; min-height: 1px")], "CodeMirror-hscrollbar");\n    vert.tabIndex = horiz.tabIndex = -1;\n    place(vert);\n    place(horiz);\n    on(vert, "scroll", function () {\n      if (vert.clientHeight) {\n        scroll(vert.scrollTop, "vertical");\n      }\n    });\n    on(horiz, "scroll", function () {\n      if (horiz.clientWidth) {\n        scroll(horiz.scrollLeft, "horizontal");\n      }\n    });\n    this.checkedZeroWidth = false; // Need to set a minimum width to see the scrollbar on IE7 (but must not set it on IE8).\n\n    if (ie && ie_version < 8) {\n      this.horiz.style.minHeight = this.vert.style.minWidth = "18px";\n    }\n  };\n\n  NativeScrollbars.prototype.update = function (measure) {\n    var needsH = measure.scrollWidth > measure.clientWidth + 1;\n    var needsV = measure.scrollHeight > measure.clientHeight + 1;\n    var sWidth = measure.nativeBarWidth;\n\n    if (needsV) {\n      this.vert.style.display = "block";\n      this.vert.style.bottom = needsH ? sWidth + "px" : "0";\n      var totalHeight = measure.viewHeight - (needsH ? sWidth : 0); // A bug in IE8 can cause this value to be negative, so guard it.\n\n      this.vert.firstChild.style.height = Math.max(0, measure.scrollHeight - measure.clientHeight + totalHeight) + "px";\n    } else {\n      this.vert.style.display = "";\n      this.vert.firstChild.style.height = "0";\n    }\n\n    if (needsH) {\n      this.horiz.style.display = "block";\n      this.horiz.style.right = needsV ? sWidth + "px" : "0";\n      this.horiz.style.left = measure.barLeft + "px";\n      var totalWidth = measure.viewWidth - measure.barLeft - (needsV ? sWidth : 0);\n      this.horiz.firstChild.style.width = Math.max(0, measure.scrollWidth - measure.clientWidth + totalWidth) + "px";\n    } else {\n      this.horiz.style.display = "";\n      this.horiz.firstChild.style.width = "0";\n    }\n\n    if (!this.checkedZeroWidth && measure.clientHeight > 0) {\n      if (sWidth == 0) {\n        this.zeroWidthHack();\n      }\n\n      this.checkedZeroWidth = true;\n    }\n\n    return {\n      right: needsV ? sWidth : 0,\n      bottom: needsH ? sWidth : 0\n    };\n  };\n\n  NativeScrollbars.prototype.setScrollLeft = function (pos) {\n    if (this.horiz.scrollLeft != pos) {\n      this.horiz.scrollLeft = pos;\n    }\n\n    if (this.disableHoriz) {\n      this.enableZeroWidthBar(this.horiz, this.disableHoriz, "horiz");\n    }\n  };\n\n  NativeScrollbars.prototype.setScrollTop = function (pos) {\n    if (this.vert.scrollTop != pos) {\n      this.vert.scrollTop = pos;\n    }\n\n    if (this.disableVert) {\n      this.enableZeroWidthBar(this.vert, this.disableVert, "vert");\n    }\n  };\n\n  NativeScrollbars.prototype.zeroWidthHack = function () {\n    var w = mac && !mac_geMountainLion ? "12px" : "18px";\n    this.horiz.style.height = this.vert.style.width = w;\n    this.horiz.style.pointerEvents = this.vert.style.pointerEvents = "none";\n    this.disableHoriz = new Delayed();\n    this.disableVert = new Delayed();\n  };\n\n  NativeScrollbars.prototype.enableZeroWidthBar = function (bar, delay, type) {\n    bar.style.pointerEvents = "auto";\n\n    function maybeDisable() {\n      // To find out whether the scrollbar is still visible, we\n      // check whether the element under the pixel in the bottom\n      // right corner of the scrollbar box is the scrollbar box\n      // itself (when the bar is still visible) or its filler child\n      // (when the bar is hidden). If it is still visible, we keep\n      // it enabled, if it\'s hidden, we disable pointer events.\n      var box = bar.getBoundingClientRect();\n      var elt = type == "vert" ? document.elementFromPoint(box.right - 1, (box.top + box.bottom) / 2) : document.elementFromPoint((box.right + box.left) / 2, box.bottom - 1);\n\n      if (elt != bar) {\n        bar.style.pointerEvents = "none";\n      } else {\n        delay.set(1000, maybeDisable);\n      }\n    }\n\n    delay.set(1000, maybeDisable);\n  };\n\n  NativeScrollbars.prototype.clear = function () {\n    var parent = this.horiz.parentNode;\n    parent.removeChild(this.horiz);\n    parent.removeChild(this.vert);\n  };\n\n  var NullScrollbars = function NullScrollbars() {};\n\n  NullScrollbars.prototype.update = function () {\n    return {\n      bottom: 0,\n      right: 0\n    };\n  };\n\n  NullScrollbars.prototype.setScrollLeft = function () {};\n\n  NullScrollbars.prototype.setScrollTop = function () {};\n\n  NullScrollbars.prototype.clear = function () {};\n\n  function updateScrollbars(cm, measure) {\n    if (!measure) {\n      measure = measureForScrollbars(cm);\n    }\n\n    var startWidth = cm.display.barWidth,\n        startHeight = cm.display.barHeight;\n    updateScrollbarsInner(cm, measure);\n\n    for (var i = 0; i < 4 && startWidth != cm.display.barWidth || startHeight != cm.display.barHeight; i++) {\n      if (startWidth != cm.display.barWidth && cm.options.lineWrapping) {\n        updateHeightsInViewport(cm);\n      }\n\n      updateScrollbarsInner(cm, measureForScrollbars(cm));\n      startWidth = cm.display.barWidth;\n      startHeight = cm.display.barHeight;\n    }\n  } // Re-synchronize the fake scrollbars with the actual size of the\n  // content.\n\n\n  function updateScrollbarsInner(cm, measure) {\n    var d = cm.display;\n    var sizes = d.scrollbars.update(measure);\n    d.sizer.style.paddingRight = (d.barWidth = sizes.right) + "px";\n    d.sizer.style.paddingBottom = (d.barHeight = sizes.bottom) + "px";\n    d.heightForcer.style.borderBottom = sizes.bottom + "px solid transparent";\n\n    if (sizes.right && sizes.bottom) {\n      d.scrollbarFiller.style.display = "block";\n      d.scrollbarFiller.style.height = sizes.bottom + "px";\n      d.scrollbarFiller.style.width = sizes.right + "px";\n    } else {\n      d.scrollbarFiller.style.display = "";\n    }\n\n    if (sizes.bottom && cm.options.coverGutterNextToScrollbar && cm.options.fixedGutter) {\n      d.gutterFiller.style.display = "block";\n      d.gutterFiller.style.height = sizes.bottom + "px";\n      d.gutterFiller.style.width = measure.gutterWidth + "px";\n    } else {\n      d.gutterFiller.style.display = "";\n    }\n  }\n\n  var scrollbarModel = {\n    "native": NativeScrollbars,\n    "null": NullScrollbars\n  };\n\n  function initScrollbars(cm) {\n    if (cm.display.scrollbars) {\n      cm.display.scrollbars.clear();\n\n      if (cm.display.scrollbars.addClass) {\n        rmClass(cm.display.wrapper, cm.display.scrollbars.addClass);\n      }\n    }\n\n    cm.display.scrollbars = new scrollbarModel[cm.options.scrollbarStyle](function (node) {\n      cm.display.wrapper.insertBefore(node, cm.display.scrollbarFiller); // Prevent clicks in the scrollbars from killing focus\n\n      on(node, "mousedown", function () {\n        if (cm.state.focused) {\n          setTimeout(function () {\n            return cm.display.input.focus();\n          }, 0);\n        }\n      });\n      node.setAttribute("cm-not-content", "true");\n    }, function (pos, axis) {\n      if (axis == "horizontal") {\n        setScrollLeft(cm, pos);\n      } else {\n        updateScrollTop(cm, pos);\n      }\n    }, cm);\n\n    if (cm.display.scrollbars.addClass) {\n      addClass(cm.display.wrapper, cm.display.scrollbars.addClass);\n    }\n  } // Operations are used to wrap a series of changes to the editor\n  // state in such a way that each change won\'t have to update the\n  // cursor and display (which would be awkward, slow, and\n  // error-prone). Instead, display updates are batched and then all\n  // combined and executed at once.\n\n\n  var nextOpId = 0; // Start a new operation.\n\n  function _startOperation(cm) {\n    cm.curOp = {\n      cm: cm,\n      viewChanged: false,\n      // Flag that indicates that lines might need to be redrawn\n      startHeight: cm.doc.height,\n      // Used to detect need to update scrollbar\n      forceUpdate: false,\n      // Used to force a redraw\n      updateInput: 0,\n      // Whether to reset the input textarea\n      typing: false,\n      // Whether this reset should be careful to leave existing text (for compositing)\n      changeObjs: null,\n      // Accumulated changes, for firing change events\n      cursorActivityHandlers: null,\n      // Set of handlers to fire cursorActivity on\n      cursorActivityCalled: 0,\n      // Tracks which cursorActivity handlers have been called already\n      selectionChanged: false,\n      // Whether the selection needs to be redrawn\n      updateMaxLine: false,\n      // Set when the widest line needs to be determined anew\n      scrollLeft: null,\n      scrollTop: null,\n      // Intermediate scroll position, not pushed to DOM yet\n      scrollToPos: null,\n      // Used to scroll to a specific position\n      focus: false,\n      id: ++nextOpId // Unique ID\n\n    };\n    pushOperation(cm.curOp);\n  } // Finish an operation, updating the display and signalling delayed events\n\n\n  function _endOperation(cm) {\n    var op = cm.curOp;\n\n    if (op) {\n      finishOperation(op, function (group) {\n        for (var i = 0; i < group.ops.length; i++) {\n          group.ops[i].cm.curOp = null;\n        }\n\n        endOperations(group);\n      });\n    }\n  } // The DOM updates done when an operation finishes are batched so\n  // that the minimum number of relayouts are required.\n\n\n  function endOperations(group) {\n    var ops = group.ops;\n\n    for (var i = 0; i < ops.length; i++) // Read DOM\n    {\n      endOperation_R1(ops[i]);\n    }\n\n    for (var i$1 = 0; i$1 < ops.length; i$1++) // Write DOM (maybe)\n    {\n      endOperation_W1(ops[i$1]);\n    }\n\n    for (var i$2 = 0; i$2 < ops.length; i$2++) // Read DOM\n    {\n      endOperation_R2(ops[i$2]);\n    }\n\n    for (var i$3 = 0; i$3 < ops.length; i$3++) // Write DOM (maybe)\n    {\n      endOperation_W2(ops[i$3]);\n    }\n\n    for (var i$4 = 0; i$4 < ops.length; i$4++) // Read DOM\n    {\n      endOperation_finish(ops[i$4]);\n    }\n  }\n\n  function endOperation_R1(op) {\n    var cm = op.cm,\n        display = cm.display;\n    maybeClipScrollbars(cm);\n\n    if (op.updateMaxLine) {\n      findMaxLine(cm);\n    }\n\n    op.mustUpdate = op.viewChanged || op.forceUpdate || op.scrollTop != null || op.scrollToPos && (op.scrollToPos.from.line < display.viewFrom || op.scrollToPos.to.line >= display.viewTo) || display.maxLineChanged && cm.options.lineWrapping;\n    op.update = op.mustUpdate && new DisplayUpdate(cm, op.mustUpdate && {\n      top: op.scrollTop,\n      ensure: op.scrollToPos\n    }, op.forceUpdate);\n  }\n\n  function endOperation_W1(op) {\n    op.updatedDisplay = op.mustUpdate && updateDisplayIfNeeded(op.cm, op.update);\n  }\n\n  function endOperation_R2(op) {\n    var cm = op.cm,\n        display = cm.display;\n\n    if (op.updatedDisplay) {\n      updateHeightsInViewport(cm);\n    }\n\n    op.barMeasure = measureForScrollbars(cm); // If the max line changed since it was last measured, measure it,\n    // and ensure the document\'s width matches it.\n    // updateDisplay_W2 will use these properties to do the actual resizing\n\n    if (display.maxLineChanged && !cm.options.lineWrapping) {\n      op.adjustWidthTo = measureChar(cm, display.maxLine, display.maxLine.text.length).left + 3;\n      cm.display.sizerWidth = op.adjustWidthTo;\n      op.barMeasure.scrollWidth = Math.max(display.scroller.clientWidth, display.sizer.offsetLeft + op.adjustWidthTo + scrollGap(cm) + cm.display.barWidth);\n      op.maxScrollLeft = Math.max(0, display.sizer.offsetLeft + op.adjustWidthTo - displayWidth(cm));\n    }\n\n    if (op.updatedDisplay || op.selectionChanged) {\n      op.preparedSelection = display.input.prepareSelection();\n    }\n  }\n\n  function endOperation_W2(op) {\n    var cm = op.cm;\n\n    if (op.adjustWidthTo != null) {\n      cm.display.sizer.style.minWidth = op.adjustWidthTo + "px";\n\n      if (op.maxScrollLeft < cm.doc.scrollLeft) {\n        setScrollLeft(cm, Math.min(cm.display.scroller.scrollLeft, op.maxScrollLeft), true);\n      }\n\n      cm.display.maxLineChanged = false;\n    }\n\n    var takeFocus = op.focus && op.focus == activeElt();\n\n    if (op.preparedSelection) {\n      cm.display.input.showSelection(op.preparedSelection, takeFocus);\n    }\n\n    if (op.updatedDisplay || op.startHeight != cm.doc.height) {\n      updateScrollbars(cm, op.barMeasure);\n    }\n\n    if (op.updatedDisplay) {\n      setDocumentHeight(cm, op.barMeasure);\n    }\n\n    if (op.selectionChanged) {\n      restartBlink(cm);\n    }\n\n    if (cm.state.focused && op.updateInput) {\n      cm.display.input.reset(op.typing);\n    }\n\n    if (takeFocus) {\n      ensureFocus(op.cm);\n    }\n  }\n\n  function endOperation_finish(op) {\n    var cm = op.cm,\n        display = cm.display,\n        doc = cm.doc;\n\n    if (op.updatedDisplay) {\n      postUpdateDisplay(cm, op.update);\n    } // Abort mouse wheel delta measurement, when scrolling explicitly\n\n\n    if (display.wheelStartX != null && (op.scrollTop != null || op.scrollLeft != null || op.scrollToPos)) {\n      display.wheelStartX = display.wheelStartY = null;\n    } // Propagate the scroll position to the actual DOM scroller\n\n\n    if (op.scrollTop != null) {\n      setScrollTop(cm, op.scrollTop, op.forceScroll);\n    }\n\n    if (op.scrollLeft != null) {\n      setScrollLeft(cm, op.scrollLeft, true, true);\n    } // If we need to scroll a specific position into view, do so.\n\n\n    if (op.scrollToPos) {\n      var rect = scrollPosIntoView(cm, _clipPos(doc, op.scrollToPos.from), _clipPos(doc, op.scrollToPos.to), op.scrollToPos.margin);\n      maybeScrollWindow(cm, rect);\n    } // Fire events for markers that are hidden/unidden by editing or\n    // undoing\n\n\n    var hidden = op.maybeHiddenMarkers,\n        unhidden = op.maybeUnhiddenMarkers;\n\n    if (hidden) {\n      for (var i = 0; i < hidden.length; ++i) {\n        if (!hidden[i].lines.length) {\n          signal(hidden[i], "hide");\n        }\n      }\n    }\n\n    if (unhidden) {\n      for (var i$1 = 0; i$1 < unhidden.length; ++i$1) {\n        if (unhidden[i$1].lines.length) {\n          signal(unhidden[i$1], "unhide");\n        }\n      }\n    }\n\n    if (display.wrapper.offsetHeight) {\n      doc.scrollTop = cm.display.scroller.scrollTop;\n    } // Fire change events, and delayed event handlers\n\n\n    if (op.changeObjs) {\n      signal(cm, "changes", cm, op.changeObjs);\n    }\n\n    if (op.update) {\n      op.update.finish();\n    }\n  } // Run the given function in an operation\n\n\n  function runInOp(cm, f) {\n    if (cm.curOp) {\n      return f();\n    }\n\n    _startOperation(cm);\n\n    try {\n      return f();\n    } finally {\n      _endOperation(cm);\n    }\n  } // Wraps a function in an operation. Returns the wrapped function.\n\n\n  function operation(cm, f) {\n    return function () {\n      if (cm.curOp) {\n        return f.apply(cm, arguments);\n      }\n\n      _startOperation(cm);\n\n      try {\n        return f.apply(cm, arguments);\n      } finally {\n        _endOperation(cm);\n      }\n    };\n  } // Used to add methods to editor and doc instances, wrapping them in\n  // operations.\n\n\n  function methodOp(f) {\n    return function () {\n      if (this.curOp) {\n        return f.apply(this, arguments);\n      }\n\n      _startOperation(this);\n\n      try {\n        return f.apply(this, arguments);\n      } finally {\n        _endOperation(this);\n      }\n    };\n  }\n\n  function docMethodOp(f) {\n    return function () {\n      var cm = this.cm;\n\n      if (!cm || cm.curOp) {\n        return f.apply(this, arguments);\n      }\n\n      _startOperation(cm);\n\n      try {\n        return f.apply(this, arguments);\n      } finally {\n        _endOperation(cm);\n      }\n    };\n  } // HIGHLIGHT WORKER\n\n\n  function startWorker(cm, time) {\n    if (cm.doc.highlightFrontier < cm.display.viewTo) {\n      cm.state.highlight.set(time, bind(highlightWorker, cm));\n    }\n  }\n\n  function highlightWorker(cm) {\n    var doc = cm.doc;\n\n    if (doc.highlightFrontier >= cm.display.viewTo) {\n      return;\n    }\n\n    var end = +new Date() + cm.options.workTime;\n    var context = getContextBefore(cm, doc.highlightFrontier);\n    var changedLines = [];\n    doc.iter(context.line, Math.min(doc.first + doc.size, cm.display.viewTo + 500), function (line) {\n      if (context.line >= cm.display.viewFrom) {\n        // Visible\n        var oldStyles = line.styles;\n        var resetState = line.text.length > cm.options.maxHighlightLength ? copyState(doc.mode, context.state) : null;\n        var highlighted = highlightLine(cm, line, context, true);\n\n        if (resetState) {\n          context.state = resetState;\n        }\n\n        line.styles = highlighted.styles;\n        var oldCls = line.styleClasses,\n            newCls = highlighted.classes;\n\n        if (newCls) {\n          line.styleClasses = newCls;\n        } else if (oldCls) {\n          line.styleClasses = null;\n        }\n\n        var ischange = !oldStyles || oldStyles.length != line.styles.length || oldCls != newCls && (!oldCls || !newCls || oldCls.bgClass != newCls.bgClass || oldCls.textClass != newCls.textClass);\n\n        for (var i = 0; !ischange && i < oldStyles.length; ++i) {\n          ischange = oldStyles[i] != line.styles[i];\n        }\n\n        if (ischange) {\n          changedLines.push(context.line);\n        }\n\n        line.stateAfter = context.save();\n        context.nextLine();\n      } else {\n        if (line.text.length <= cm.options.maxHighlightLength) {\n          processLine(cm, line.text, context);\n        }\n\n        line.stateAfter = context.line % 5 == 0 ? context.save() : null;\n        context.nextLine();\n      }\n\n      if (+new Date() > end) {\n        startWorker(cm, cm.options.workDelay);\n        return true;\n      }\n    });\n    doc.highlightFrontier = context.line;\n    doc.modeFrontier = Math.max(doc.modeFrontier, context.line);\n\n    if (changedLines.length) {\n      runInOp(cm, function () {\n        for (var i = 0; i < changedLines.length; i++) {\n          regLineChange(cm, changedLines[i], "text");\n        }\n      });\n    }\n  } // DISPLAY DRAWING\n\n\n  var DisplayUpdate = function DisplayUpdate(cm, viewport, force) {\n    var display = cm.display;\n    this.viewport = viewport; // Store some values that we\'ll need later (but don\'t want to force a relayout for)\n\n    this.visible = visibleLines(display, cm.doc, viewport);\n    this.editorIsHidden = !display.wrapper.offsetWidth;\n    this.wrapperHeight = display.wrapper.clientHeight;\n    this.wrapperWidth = display.wrapper.clientWidth;\n    this.oldDisplayWidth = displayWidth(cm);\n    this.force = force;\n    this.dims = getDimensions(cm);\n    this.events = [];\n  };\n\n  DisplayUpdate.prototype.signal = function (emitter, type) {\n    if (hasHandler(emitter, type)) {\n      this.events.push(arguments);\n    }\n  };\n\n  DisplayUpdate.prototype.finish = function () {\n    for (var i = 0; i < this.events.length; i++) {\n      signal.apply(null, this.events[i]);\n    }\n  };\n\n  function maybeClipScrollbars(cm) {\n    var display = cm.display;\n\n    if (!display.scrollbarsClipped && display.scroller.offsetWidth) {\n      display.nativeBarWidth = display.scroller.offsetWidth - display.scroller.clientWidth;\n      display.heightForcer.style.height = scrollGap(cm) + "px";\n      display.sizer.style.marginBottom = -display.nativeBarWidth + "px";\n      display.sizer.style.borderRightWidth = scrollGap(cm) + "px";\n      display.scrollbarsClipped = true;\n    }\n  }\n\n  function selectionSnapshot(cm) {\n    if (cm.hasFocus()) {\n      return null;\n    }\n\n    var active = activeElt();\n\n    if (!active || !contains(cm.display.lineDiv, active)) {\n      return null;\n    }\n\n    var result = {\n      activeElt: active\n    };\n\n    if (window.getSelection) {\n      var sel = window.getSelection();\n\n      if (sel.anchorNode && sel.extend && contains(cm.display.lineDiv, sel.anchorNode)) {\n        result.anchorNode = sel.anchorNode;\n        result.anchorOffset = sel.anchorOffset;\n        result.focusNode = sel.focusNode;\n        result.focusOffset = sel.focusOffset;\n      }\n    }\n\n    return result;\n  }\n\n  function restoreSelection(snapshot) {\n    if (!snapshot || !snapshot.activeElt || snapshot.activeElt == activeElt()) {\n      return;\n    }\n\n    snapshot.activeElt.focus();\n\n    if (snapshot.anchorNode && contains(document.body, snapshot.anchorNode) && contains(document.body, snapshot.focusNode)) {\n      var sel = window.getSelection(),\n          range = document.createRange();\n      range.setEnd(snapshot.anchorNode, snapshot.anchorOffset);\n      range.collapse(false);\n      sel.removeAllRanges();\n      sel.addRange(range);\n      sel.extend(snapshot.focusNode, snapshot.focusOffset);\n    }\n  } // Does the actual updating of the line display. Bails out\n  // (returning false) when there is nothing to be done and forced is\n  // false.\n\n\n  function updateDisplayIfNeeded(cm, update) {\n    var display = cm.display,\n        doc = cm.doc;\n\n    if (update.editorIsHidden) {\n      resetView(cm);\n      return false;\n    } // Bail out if the visible area is already rendered and nothing changed.\n\n\n    if (!update.force && update.visible.from >= display.viewFrom && update.visible.to <= display.viewTo && (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo) && display.renderedView == display.view && countDirtyView(cm) == 0) {\n      return false;\n    }\n\n    if (maybeUpdateLineNumberWidth(cm)) {\n      resetView(cm);\n      update.dims = getDimensions(cm);\n    } // Compute a suitable new viewport (from & to)\n\n\n    var end = doc.first + doc.size;\n    var from = Math.max(update.visible.from - cm.options.viewportMargin, doc.first);\n    var to = Math.min(end, update.visible.to + cm.options.viewportMargin);\n\n    if (display.viewFrom < from && from - display.viewFrom < 20) {\n      from = Math.max(doc.first, display.viewFrom);\n    }\n\n    if (display.viewTo > to && display.viewTo - to < 20) {\n      to = Math.min(end, display.viewTo);\n    }\n\n    if (sawCollapsedSpans) {\n      from = visualLineNo(cm.doc, from);\n      to = visualLineEndNo(cm.doc, to);\n    }\n\n    var different = from != display.viewFrom || to != display.viewTo || display.lastWrapHeight != update.wrapperHeight || display.lastWrapWidth != update.wrapperWidth;\n    adjustView(cm, from, to);\n    display.viewOffset = _heightAtLine(getLine(cm.doc, display.viewFrom)); // Position the mover div to align with the current scroll position\n\n    cm.display.mover.style.top = display.viewOffset + "px";\n    var toUpdate = countDirtyView(cm);\n\n    if (!different && toUpdate == 0 && !update.force && display.renderedView == display.view && (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo)) {\n      return false;\n    } // For big changes, we hide the enclosing element during the\n    // update, since that speeds up the operations on most browsers.\n\n\n    var selSnapshot = selectionSnapshot(cm);\n\n    if (toUpdate > 4) {\n      display.lineDiv.style.display = "none";\n    }\n\n    patchDisplay(cm, display.updateLineNumbers, update.dims);\n\n    if (toUpdate > 4) {\n      display.lineDiv.style.display = "";\n    }\n\n    display.renderedView = display.view; // There might have been a widget with a focused element that got\n    // hidden or updated, if so re-focus it.\n\n    restoreSelection(selSnapshot); // Prevent selection and cursors from interfering with the scroll\n    // width and height.\n\n    removeChildren(display.cursorDiv);\n    removeChildren(display.selectionDiv);\n    display.gutters.style.height = display.sizer.style.minHeight = 0;\n\n    if (different) {\n      display.lastWrapHeight = update.wrapperHeight;\n      display.lastWrapWidth = update.wrapperWidth;\n      startWorker(cm, 400);\n    }\n\n    display.updateLineNumbers = null;\n    return true;\n  }\n\n  function postUpdateDisplay(cm, update) {\n    var viewport = update.viewport;\n\n    for (var first = true;; first = false) {\n      if (!first || !cm.options.lineWrapping || update.oldDisplayWidth == displayWidth(cm)) {\n        // Clip forced viewport to actual scrollable area.\n        if (viewport && viewport.top != null) {\n          viewport = {\n            top: Math.min(cm.doc.height + paddingVert(cm.display) - displayHeight(cm), viewport.top)\n          };\n        } // Updated line heights might result in the drawn area not\n        // actually covering the viewport. Keep looping until it does.\n\n\n        update.visible = visibleLines(cm.display, cm.doc, viewport);\n\n        if (update.visible.from >= cm.display.viewFrom && update.visible.to <= cm.display.viewTo) {\n          break;\n        }\n      }\n\n      if (!updateDisplayIfNeeded(cm, update)) {\n        break;\n      }\n\n      updateHeightsInViewport(cm);\n      var barMeasure = measureForScrollbars(cm);\n      updateSelection(cm);\n      updateScrollbars(cm, barMeasure);\n      setDocumentHeight(cm, barMeasure);\n      update.force = false;\n    }\n\n    update.signal(cm, "update", cm);\n\n    if (cm.display.viewFrom != cm.display.reportedViewFrom || cm.display.viewTo != cm.display.reportedViewTo) {\n      update.signal(cm, "viewportChange", cm, cm.display.viewFrom, cm.display.viewTo);\n      cm.display.reportedViewFrom = cm.display.viewFrom;\n      cm.display.reportedViewTo = cm.display.viewTo;\n    }\n  }\n\n  function updateDisplaySimple(cm, viewport) {\n    var update = new DisplayUpdate(cm, viewport);\n\n    if (updateDisplayIfNeeded(cm, update)) {\n      updateHeightsInViewport(cm);\n      postUpdateDisplay(cm, update);\n      var barMeasure = measureForScrollbars(cm);\n      updateSelection(cm);\n      updateScrollbars(cm, barMeasure);\n      setDocumentHeight(cm, barMeasure);\n      update.finish();\n    }\n  } // Sync the actual display DOM structure with display.view, removing\n  // nodes for lines that are no longer in view, and creating the ones\n  // that are not there yet, and updating the ones that are out of\n  // date.\n\n\n  function patchDisplay(cm, updateNumbersFrom, dims) {\n    var display = cm.display,\n        lineNumbers = cm.options.lineNumbers;\n    var container = display.lineDiv,\n        cur = container.firstChild;\n\n    function rm(node) {\n      var next = node.nextSibling; // Works around a throw-scroll bug in OS X Webkit\n\n      if (webkit && mac && cm.display.currentWheelTarget == node) {\n        node.style.display = "none";\n      } else {\n        node.parentNode.removeChild(node);\n      }\n\n      return next;\n    }\n\n    var view = display.view,\n        lineN = display.viewFrom; // Loop over the elements in the view, syncing cur (the DOM nodes\n    // in display.lineDiv) with the view as we go.\n\n    for (var i = 0; i < view.length; i++) {\n      var lineView = view[i];\n      if (lineView.hidden) ;else if (!lineView.node || lineView.node.parentNode != container) {\n        // Not drawn yet\n        var node = buildLineElement(cm, lineView, lineN, dims);\n        container.insertBefore(node, cur);\n      } else {\n        // Already drawn\n        while (cur != lineView.node) {\n          cur = rm(cur);\n        }\n\n        var updateNumber = lineNumbers && updateNumbersFrom != null && updateNumbersFrom <= lineN && lineView.lineNumber;\n\n        if (lineView.changes) {\n          if (indexOf(lineView.changes, "gutter") > -1) {\n            updateNumber = false;\n          }\n\n          updateLineForChanges(cm, lineView, lineN, dims);\n        }\n\n        if (updateNumber) {\n          removeChildren(lineView.lineNumber);\n          lineView.lineNumber.appendChild(document.createTextNode(lineNumberFor(cm.options, lineN)));\n        }\n\n        cur = lineView.node.nextSibling;\n      }\n      lineN += lineView.size;\n    }\n\n    while (cur) {\n      cur = rm(cur);\n    }\n  }\n\n  function updateGutterSpace(display) {\n    var width = display.gutters.offsetWidth;\n    display.sizer.style.marginLeft = width + "px";\n  }\n\n  function setDocumentHeight(cm, measure) {\n    cm.display.sizer.style.minHeight = measure.docHeight + "px";\n    cm.display.heightForcer.style.top = measure.docHeight + "px";\n    cm.display.gutters.style.height = measure.docHeight + cm.display.barHeight + scrollGap(cm) + "px";\n  } // Re-align line numbers and gutter marks to compensate for\n  // horizontal scrolling.\n\n\n  function alignHorizontally(cm) {\n    var display = cm.display,\n        view = display.view;\n\n    if (!display.alignWidgets && (!display.gutters.firstChild || !cm.options.fixedGutter)) {\n      return;\n    }\n\n    var comp = compensateForHScroll(display) - display.scroller.scrollLeft + cm.doc.scrollLeft;\n    var gutterW = display.gutters.offsetWidth,\n        left = comp + "px";\n\n    for (var i = 0; i < view.length; i++) {\n      if (!view[i].hidden) {\n        if (cm.options.fixedGutter) {\n          if (view[i].gutter) {\n            view[i].gutter.style.left = left;\n          }\n\n          if (view[i].gutterBackground) {\n            view[i].gutterBackground.style.left = left;\n          }\n        }\n\n        var align = view[i].alignable;\n\n        if (align) {\n          for (var j = 0; j < align.length; j++) {\n            align[j].style.left = left;\n          }\n        }\n      }\n    }\n\n    if (cm.options.fixedGutter) {\n      display.gutters.style.left = comp + gutterW + "px";\n    }\n  } // Used to ensure that the line number gutter is still the right\n  // size for the current document size. Returns true when an update\n  // is needed.\n\n\n  function maybeUpdateLineNumberWidth(cm) {\n    if (!cm.options.lineNumbers) {\n      return false;\n    }\n\n    var doc = cm.doc,\n        last = lineNumberFor(cm.options, doc.first + doc.size - 1),\n        display = cm.display;\n\n    if (last.length != display.lineNumChars) {\n      var test = display.measure.appendChild(elt("div", [elt("div", last)], "CodeMirror-linenumber CodeMirror-gutter-elt"));\n      var innerW = test.firstChild.offsetWidth,\n          padding = test.offsetWidth - innerW;\n      display.lineGutter.style.width = "";\n      display.lineNumInnerWidth = Math.max(innerW, display.lineGutter.offsetWidth - padding) + 1;\n      display.lineNumWidth = display.lineNumInnerWidth + padding;\n      display.lineNumChars = display.lineNumInnerWidth ? last.length : -1;\n      display.lineGutter.style.width = display.lineNumWidth + "px";\n      updateGutterSpace(cm.display);\n      return true;\n    }\n\n    return false;\n  }\n\n  function getGutters(gutters, lineNumbers) {\n    var result = [],\n        sawLineNumbers = false;\n\n    for (var i = 0; i < gutters.length; i++) {\n      var name = gutters[i],\n          style = null;\n\n      if (typeof name != "string") {\n        style = name.style;\n        name = name.className;\n      }\n\n      if (name == "CodeMirror-linenumbers") {\n        if (!lineNumbers) {\n          continue;\n        } else {\n          sawLineNumbers = true;\n        }\n      }\n\n      result.push({\n        className: name,\n        style: style\n      });\n    }\n\n    if (lineNumbers && !sawLineNumbers) {\n      result.push({\n        className: "CodeMirror-linenumbers",\n        style: null\n      });\n    }\n\n    return result;\n  } // Rebuild the gutter elements, ensure the margin to the left of the\n  // code matches their width.\n\n\n  function renderGutters(display) {\n    var gutters = display.gutters,\n        specs = display.gutterSpecs;\n    removeChildren(gutters);\n    display.lineGutter = null;\n\n    for (var i = 0; i < specs.length; ++i) {\n      var ref = specs[i];\n      var className = ref.className;\n      var style = ref.style;\n      var gElt = gutters.appendChild(elt("div", null, "CodeMirror-gutter " + className));\n\n      if (style) {\n        gElt.style.cssText = style;\n      }\n\n      if (className == "CodeMirror-linenumbers") {\n        display.lineGutter = gElt;\n        gElt.style.width = (display.lineNumWidth || 1) + "px";\n      }\n    }\n\n    gutters.style.display = specs.length ? "" : "none";\n    updateGutterSpace(display);\n  }\n\n  function updateGutters(cm) {\n    renderGutters(cm.display);\n    regChange(cm);\n    alignHorizontally(cm);\n  } // The display handles the DOM integration, both for input reading\n  // and content drawing. It holds references to DOM nodes and\n  // display-related state.\n\n\n  function Display(place, doc, input, options) {\n    var d = this;\n    this.input = input; // Covers bottom-right square when both scrollbars are present.\n\n    d.scrollbarFiller = elt("div", null, "CodeMirror-scrollbar-filler");\n    d.scrollbarFiller.setAttribute("cm-not-content", "true"); // Covers bottom of gutter when coverGutterNextToScrollbar is on\n    // and h scrollbar is present.\n\n    d.gutterFiller = elt("div", null, "CodeMirror-gutter-filler");\n    d.gutterFiller.setAttribute("cm-not-content", "true"); // Will contain the actual code, positioned to cover the viewport.\n\n    d.lineDiv = eltP("div", null, "CodeMirror-code"); // Elements are added to these to represent selection and cursors.\n\n    d.selectionDiv = elt("div", null, null, "position: relative; z-index: 1");\n    d.cursorDiv = elt("div", null, "CodeMirror-cursors"); // A visibility: hidden element used to find the size of things.\n\n    d.measure = elt("div", null, "CodeMirror-measure"); // When lines outside of the viewport are measured, they are drawn in this.\n\n    d.lineMeasure = elt("div", null, "CodeMirror-measure"); // Wraps everything that needs to exist inside the vertically-padded coordinate system\n\n    d.lineSpace = eltP("div", [d.measure, d.lineMeasure, d.selectionDiv, d.cursorDiv, d.lineDiv], null, "position: relative; outline: none");\n    var lines = eltP("div", [d.lineSpace], "CodeMirror-lines"); // Moved around its parent to cover visible view.\n\n    d.mover = elt("div", [lines], null, "position: relative"); // Set to the height of the document, allowing scrolling.\n\n    d.sizer = elt("div", [d.mover], "CodeMirror-sizer");\n    d.sizerWidth = null; // Behavior of elts with overflow: auto and padding is\n    // inconsistent across browsers. This is used to ensure the\n    // scrollable area is big enough.\n\n    d.heightForcer = elt("div", null, null, "position: absolute; height: " + scrollerGap + "px; width: 1px;"); // Will contain the gutters, if any.\n\n    d.gutters = elt("div", null, "CodeMirror-gutters");\n    d.lineGutter = null; // Actual scrollable element.\n\n    d.scroller = elt("div", [d.sizer, d.heightForcer, d.gutters], "CodeMirror-scroll");\n    d.scroller.setAttribute("tabIndex", "-1"); // The element in which the editor lives.\n\n    d.wrapper = elt("div", [d.scrollbarFiller, d.gutterFiller, d.scroller], "CodeMirror"); // Work around IE7 z-index bug (not perfect, hence IE7 not really being supported)\n\n    if (ie && ie_version < 8) {\n      d.gutters.style.zIndex = -1;\n      d.scroller.style.paddingRight = 0;\n    }\n\n    if (!webkit && !(gecko && mobile)) {\n      d.scroller.draggable = true;\n    }\n\n    if (place) {\n      if (place.appendChild) {\n        place.appendChild(d.wrapper);\n      } else {\n        place(d.wrapper);\n      }\n    } // Current rendered range (may be bigger than the view window).\n\n\n    d.viewFrom = d.viewTo = doc.first;\n    d.reportedViewFrom = d.reportedViewTo = doc.first; // Information about the rendered lines.\n\n    d.view = [];\n    d.renderedView = null; // Holds info about a single rendered line when it was rendered\n    // for measurement, while not in view.\n\n    d.externalMeasured = null; // Empty space (in pixels) above the view\n\n    d.viewOffset = 0;\n    d.lastWrapHeight = d.lastWrapWidth = 0;\n    d.updateLineNumbers = null;\n    d.nativeBarWidth = d.barHeight = d.barWidth = 0;\n    d.scrollbarsClipped = false; // Used to only resize the line number gutter when necessary (when\n    // the amount of lines crosses a boundary that makes its width change)\n\n    d.lineNumWidth = d.lineNumInnerWidth = d.lineNumChars = null; // Set to true when a non-horizontal-scrolling line widget is\n    // added. As an optimization, line widget aligning is skipped when\n    // this is false.\n\n    d.alignWidgets = false;\n    d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null; // Tracks the maximum line length so that the horizontal scrollbar\n    // can be kept static when scrolling.\n\n    d.maxLine = null;\n    d.maxLineLength = 0;\n    d.maxLineChanged = false; // Used for measuring wheel scrolling granularity\n\n    d.wheelDX = d.wheelDY = d.wheelStartX = d.wheelStartY = null; // True when shift is held down.\n\n    d.shift = false; // Used to track whether anything happened since the context menu\n    // was opened.\n\n    d.selForContextMenu = null;\n    d.activeTouch = null;\n    d.gutterSpecs = getGutters(options.gutters, options.lineNumbers);\n    renderGutters(d);\n    input.init(d);\n  } // Since the delta values reported on mouse wheel events are\n  // unstandardized between browsers and even browser versions, and\n  // generally horribly unpredictable, this code starts by measuring\n  // the scroll effect that the first few mouse wheel events have,\n  // and, from that, detects the way it can convert deltas to pixel\n  // offsets afterwards.\n  //\n  // The reason we want to know the amount a wheel event will scroll\n  // is that it gives us a chance to update the display before the\n  // actual scrolling happens, reducing flickering.\n\n\n  var wheelSamples = 0,\n      wheelPixelsPerUnit = null; // Fill in a browser-detected starting value on browsers where we\n  // know one. These don\'t have to be accurate -- the result of them\n  // being wrong would just be a slight flicker on the first wheel\n  // scroll (if it is large enough).\n\n  if (ie) {\n    wheelPixelsPerUnit = -.53;\n  } else if (gecko) {\n    wheelPixelsPerUnit = 15;\n  } else if (chrome) {\n    wheelPixelsPerUnit = -.7;\n  } else if (safari) {\n    wheelPixelsPerUnit = -1 / 3;\n  }\n\n  function wheelEventDelta(e) {\n    var dx = e.wheelDeltaX,\n        dy = e.wheelDeltaY;\n\n    if (dx == null && e.detail && e.axis == e.HORIZONTAL_AXIS) {\n      dx = e.detail;\n    }\n\n    if (dy == null && e.detail && e.axis == e.VERTICAL_AXIS) {\n      dy = e.detail;\n    } else if (dy == null) {\n      dy = e.wheelDelta;\n    }\n\n    return {\n      x: dx,\n      y: dy\n    };\n  }\n\n  function wheelEventPixels(e) {\n    var delta = wheelEventDelta(e);\n    delta.x *= wheelPixelsPerUnit;\n    delta.y *= wheelPixelsPerUnit;\n    return delta;\n  }\n\n  function onScrollWheel(cm, e) {\n    var delta = wheelEventDelta(e),\n        dx = delta.x,\n        dy = delta.y;\n    var display = cm.display,\n        scroll = display.scroller; // Quit if there\'s nothing to scroll here\n\n    var canScrollX = scroll.scrollWidth > scroll.clientWidth;\n    var canScrollY = scroll.scrollHeight > scroll.clientHeight;\n\n    if (!(dx && canScrollX || dy && canScrollY)) {\n      return;\n    } // Webkit browsers on OS X abort momentum scrolls when the target\n    // of the scroll event is removed from the scrollable element.\n    // This hack (see related code in patchDisplay) makes sure the\n    // element is kept around.\n\n\n    if (dy && mac && webkit) {\n      outer: for (var cur = e.target, view = display.view; cur != scroll; cur = cur.parentNode) {\n        for (var i = 0; i < view.length; i++) {\n          if (view[i].node == cur) {\n            cm.display.currentWheelTarget = cur;\n            break outer;\n          }\n        }\n      }\n    } // On some browsers, horizontal scrolling will cause redraws to\n    // happen before the gutter has been realigned, causing it to\n    // wriggle around in a most unseemly way. When we have an\n    // estimated pixels/delta value, we just handle horizontal\n    // scrolling entirely here. It\'ll be slightly off from native, but\n    // better than glitching out.\n\n\n    if (dx && !gecko && !presto && wheelPixelsPerUnit != null) {\n      if (dy && canScrollY) {\n        updateScrollTop(cm, Math.max(0, scroll.scrollTop + dy * wheelPixelsPerUnit));\n      }\n\n      setScrollLeft(cm, Math.max(0, scroll.scrollLeft + dx * wheelPixelsPerUnit)); // Only prevent default scrolling if vertical scrolling is\n      // actually possible. Otherwise, it causes vertical scroll\n      // jitter on OSX trackpads when deltaX is small and deltaY\n      // is large (issue #3579)\n\n      if (!dy || dy && canScrollY) {\n        e_preventDefault(e);\n      }\n\n      display.wheelStartX = null; // Abort measurement, if in progress\n\n      return;\n    } // \'Project\' the visible viewport to cover the area that is being\n    // scrolled into view (if we know enough to estimate it).\n\n\n    if (dy && wheelPixelsPerUnit != null) {\n      var pixels = dy * wheelPixelsPerUnit;\n      var top = cm.doc.scrollTop,\n          bot = top + display.wrapper.clientHeight;\n\n      if (pixels < 0) {\n        top = Math.max(0, top + pixels - 50);\n      } else {\n        bot = Math.min(cm.doc.height, bot + pixels + 50);\n      }\n\n      updateDisplaySimple(cm, {\n        top: top,\n        bottom: bot\n      });\n    }\n\n    if (wheelSamples < 20) {\n      if (display.wheelStartX == null) {\n        display.wheelStartX = scroll.scrollLeft;\n        display.wheelStartY = scroll.scrollTop;\n        display.wheelDX = dx;\n        display.wheelDY = dy;\n        setTimeout(function () {\n          if (display.wheelStartX == null) {\n            return;\n          }\n\n          var movedX = scroll.scrollLeft - display.wheelStartX;\n          var movedY = scroll.scrollTop - display.wheelStartY;\n          var sample = movedY && display.wheelDY && movedY / display.wheelDY || movedX && display.wheelDX && movedX / display.wheelDX;\n          display.wheelStartX = display.wheelStartY = null;\n\n          if (!sample) {\n            return;\n          }\n\n          wheelPixelsPerUnit = (wheelPixelsPerUnit * wheelSamples + sample) / (wheelSamples + 1);\n          ++wheelSamples;\n        }, 200);\n      } else {\n        display.wheelDX += dx;\n        display.wheelDY += dy;\n      }\n    }\n  } // Selection objects are immutable. A new one is created every time\n  // the selection changes. A selection is one or more non-overlapping\n  // (and non-touching) ranges, sorted, and an integer that indicates\n  // which one is the primary selection (the one that\'s scrolled into\n  // view, that getCursor returns, etc).\n\n\n  var Selection = function Selection(ranges, primIndex) {\n    this.ranges = ranges;\n    this.primIndex = primIndex;\n  };\n\n  Selection.prototype.primary = function () {\n    return this.ranges[this.primIndex];\n  };\n\n  Selection.prototype.equals = function (other) {\n    if (other == this) {\n      return true;\n    }\n\n    if (other.primIndex != this.primIndex || other.ranges.length != this.ranges.length) {\n      return false;\n    }\n\n    for (var i = 0; i < this.ranges.length; i++) {\n      var here = this.ranges[i],\n          there = other.ranges[i];\n\n      if (!equalCursorPos(here.anchor, there.anchor) || !equalCursorPos(here.head, there.head)) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  Selection.prototype.deepCopy = function () {\n    var out = [];\n\n    for (var i = 0; i < this.ranges.length; i++) {\n      out[i] = new Range(copyPos(this.ranges[i].anchor), copyPos(this.ranges[i].head));\n    }\n\n    return new Selection(out, this.primIndex);\n  };\n\n  Selection.prototype.somethingSelected = function () {\n    for (var i = 0; i < this.ranges.length; i++) {\n      if (!this.ranges[i].empty()) {\n        return true;\n      }\n    }\n\n    return false;\n  };\n\n  Selection.prototype.contains = function (pos, end) {\n    if (!end) {\n      end = pos;\n    }\n\n    for (var i = 0; i < this.ranges.length; i++) {\n      var range = this.ranges[i];\n\n      if (cmp(end, range.from()) >= 0 && cmp(pos, range.to()) <= 0) {\n        return i;\n      }\n    }\n\n    return -1;\n  };\n\n  var Range = function Range(anchor, head) {\n    this.anchor = anchor;\n    this.head = head;\n  };\n\n  Range.prototype.from = function () {\n    return minPos(this.anchor, this.head);\n  };\n\n  Range.prototype.to = function () {\n    return maxPos(this.anchor, this.head);\n  };\n\n  Range.prototype.empty = function () {\n    return this.head.line == this.anchor.line && this.head.ch == this.anchor.ch;\n  }; // Take an unsorted, potentially overlapping set of ranges, and\n  // build a selection out of it. \'Consumes\' ranges array (modifying\n  // it).\n\n\n  function normalizeSelection(cm, ranges, primIndex) {\n    var mayTouch = cm && cm.options.selectionsMayTouch;\n    var prim = ranges[primIndex];\n    ranges.sort(function (a, b) {\n      return cmp(a.from(), b.from());\n    });\n    primIndex = indexOf(ranges, prim);\n\n    for (var i = 1; i < ranges.length; i++) {\n      var cur = ranges[i],\n          prev = ranges[i - 1];\n      var diff = cmp(prev.to(), cur.from());\n\n      if (mayTouch && !cur.empty() ? diff > 0 : diff >= 0) {\n        var from = minPos(prev.from(), cur.from()),\n            to = maxPos(prev.to(), cur.to());\n        var inv = prev.empty() ? cur.from() == cur.head : prev.from() == prev.head;\n\n        if (i <= primIndex) {\n          --primIndex;\n        }\n\n        ranges.splice(--i, 2, new Range(inv ? to : from, inv ? from : to));\n      }\n    }\n\n    return new Selection(ranges, primIndex);\n  }\n\n  function simpleSelection(anchor, head) {\n    return new Selection([new Range(anchor, head || anchor)], 0);\n  } // Compute the position of the end of a change (its \'to\' property\n  // refers to the pre-change end).\n\n\n  function changeEnd(change) {\n    if (!change.text) {\n      return change.to;\n    }\n\n    return Pos(change.from.line + change.text.length - 1, lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0));\n  } // Adjust a position to refer to the post-change position of the\n  // same text, or the end of the change if the change covers it.\n\n\n  function adjustForChange(pos, change) {\n    if (cmp(pos, change.from) < 0) {\n      return pos;\n    }\n\n    if (cmp(pos, change.to) <= 0) {\n      return changeEnd(change);\n    }\n\n    var line = pos.line + change.text.length - (change.to.line - change.from.line) - 1,\n        ch = pos.ch;\n\n    if (pos.line == change.to.line) {\n      ch += changeEnd(change).ch - change.to.ch;\n    }\n\n    return Pos(line, ch);\n  }\n\n  function computeSelAfterChange(doc, change) {\n    var out = [];\n\n    for (var i = 0; i < doc.sel.ranges.length; i++) {\n      var range = doc.sel.ranges[i];\n      out.push(new Range(adjustForChange(range.anchor, change), adjustForChange(range.head, change)));\n    }\n\n    return normalizeSelection(doc.cm, out, doc.sel.primIndex);\n  }\n\n  function offsetPos(pos, old, nw) {\n    if (pos.line == old.line) {\n      return Pos(nw.line, pos.ch - old.ch + nw.ch);\n    } else {\n      return Pos(nw.line + (pos.line - old.line), pos.ch);\n    }\n  } // Used by replaceSelections to allow moving the selection to the\n  // start or around the replaced test. Hint may be "start" or "around".\n\n\n  function computeReplacedSel(doc, changes, hint) {\n    var out = [];\n    var oldPrev = Pos(doc.first, 0),\n        newPrev = oldPrev;\n\n    for (var i = 0; i < changes.length; i++) {\n      var change = changes[i];\n      var from = offsetPos(change.from, oldPrev, newPrev);\n      var to = offsetPos(changeEnd(change), oldPrev, newPrev);\n      oldPrev = change.to;\n      newPrev = to;\n\n      if (hint == "around") {\n        var range = doc.sel.ranges[i],\n            inv = cmp(range.head, range.anchor) < 0;\n        out[i] = new Range(inv ? to : from, inv ? from : to);\n      } else {\n        out[i] = new Range(from, from);\n      }\n    }\n\n    return new Selection(out, doc.sel.primIndex);\n  } // Used to get the editor into a consistent state again when options change.\n\n\n  function loadMode(cm) {\n    cm.doc.mode = getMode(cm.options, cm.doc.modeOption);\n    resetModeState(cm);\n  }\n\n  function resetModeState(cm) {\n    cm.doc.iter(function (line) {\n      if (line.stateAfter) {\n        line.stateAfter = null;\n      }\n\n      if (line.styles) {\n        line.styles = null;\n      }\n    });\n    cm.doc.modeFrontier = cm.doc.highlightFrontier = cm.doc.first;\n    startWorker(cm, 100);\n    cm.state.modeGen++;\n\n    if (cm.curOp) {\n      regChange(cm);\n    }\n  } // DOCUMENT DATA STRUCTURE\n  // By default, updates that start and end at the beginning of a line\n  // are treated specially, in order to make the association of line\n  // widgets and marker elements with the text behave more intuitive.\n\n\n  function isWholeLineUpdate(doc, change) {\n    return change.from.ch == 0 && change.to.ch == 0 && lst(change.text) == "" && (!doc.cm || doc.cm.options.wholeLineUpdateBefore);\n  } // Perform a change on the document data structure.\n\n\n  function updateDoc(doc, change, markedSpans, estimateHeight) {\n    function spansFor(n) {\n      return markedSpans ? markedSpans[n] : null;\n    }\n\n    function update(line, text, spans) {\n      updateLine(line, text, spans, estimateHeight);\n      signalLater(line, "change", line, change);\n    }\n\n    function linesFor(start, end) {\n      var result = [];\n\n      for (var i = start; i < end; ++i) {\n        result.push(new Line(text[i], spansFor(i), estimateHeight));\n      }\n\n      return result;\n    }\n\n    var from = change.from,\n        to = change.to,\n        text = change.text;\n    var firstLine = getLine(doc, from.line),\n        lastLine = getLine(doc, to.line);\n    var lastText = lst(text),\n        lastSpans = spansFor(text.length - 1),\n        nlines = to.line - from.line; // Adjust the line structure\n\n    if (change.full) {\n      doc.insert(0, linesFor(0, text.length));\n      doc.remove(text.length, doc.size - text.length);\n    } else if (isWholeLineUpdate(doc, change)) {\n      // This is a whole-line replace. Treated specially to make\n      // sure line objects move the way they are supposed to.\n      var added = linesFor(0, text.length - 1);\n      update(lastLine, lastLine.text, lastSpans);\n\n      if (nlines) {\n        doc.remove(from.line, nlines);\n      }\n\n      if (added.length) {\n        doc.insert(from.line, added);\n      }\n    } else if (firstLine == lastLine) {\n      if (text.length == 1) {\n        update(firstLine, firstLine.text.slice(0, from.ch) + lastText + firstLine.text.slice(to.ch), lastSpans);\n      } else {\n        var added$1 = linesFor(1, text.length - 1);\n        added$1.push(new Line(lastText + firstLine.text.slice(to.ch), lastSpans, estimateHeight));\n        update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));\n        doc.insert(from.line + 1, added$1);\n      }\n    } else if (text.length == 1) {\n      update(firstLine, firstLine.text.slice(0, from.ch) + text[0] + lastLine.text.slice(to.ch), spansFor(0));\n      doc.remove(from.line + 1, nlines);\n    } else {\n      update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));\n      update(lastLine, lastText + lastLine.text.slice(to.ch), lastSpans);\n      var added$2 = linesFor(1, text.length - 1);\n\n      if (nlines > 1) {\n        doc.remove(from.line + 1, nlines - 1);\n      }\n\n      doc.insert(from.line + 1, added$2);\n    }\n\n    signalLater(doc, "change", doc, change);\n  } // Call f for all linked documents.\n\n\n  function linkedDocs(doc, f, sharedHistOnly) {\n    function propagate(doc, skip, sharedHist) {\n      if (doc.linked) {\n        for (var i = 0; i < doc.linked.length; ++i) {\n          var rel = doc.linked[i];\n\n          if (rel.doc == skip) {\n            continue;\n          }\n\n          var shared = sharedHist && rel.sharedHist;\n\n          if (sharedHistOnly && !shared) {\n            continue;\n          }\n\n          f(rel.doc, shared);\n          propagate(rel.doc, doc, shared);\n        }\n      }\n    }\n\n    propagate(doc, null, true);\n  } // Attach a document to an editor.\n\n\n  function attachDoc(cm, doc) {\n    if (doc.cm) {\n      throw new Error("This document is already in use.");\n    }\n\n    cm.doc = doc;\n    doc.cm = cm;\n    estimateLineHeights(cm);\n    loadMode(cm);\n    setDirectionClass(cm);\n\n    if (!cm.options.lineWrapping) {\n      findMaxLine(cm);\n    }\n\n    cm.options.mode = doc.modeOption;\n    regChange(cm);\n  }\n\n  function setDirectionClass(cm) {\n    (cm.doc.direction == "rtl" ? addClass : rmClass)(cm.display.lineDiv, "CodeMirror-rtl");\n  }\n\n  function directionChanged(cm) {\n    runInOp(cm, function () {\n      setDirectionClass(cm);\n      regChange(cm);\n    });\n  }\n\n  function History(startGen) {\n    // Arrays of change events and selections. Doing something adds an\n    // event to done and clears undo. Undoing moves events from done\n    // to undone, redoing moves them in the other direction.\n    this.done = [];\n    this.undone = [];\n    this.undoDepth = Infinity; // Used to track when changes can be merged into a single undo\n    // event\n\n    this.lastModTime = this.lastSelTime = 0;\n    this.lastOp = this.lastSelOp = null;\n    this.lastOrigin = this.lastSelOrigin = null; // Used by the isClean() method\n\n    this.generation = this.maxGeneration = startGen || 1;\n  } // Create a history change event from an updateDoc-style change\n  // object.\n\n\n  function historyChangeFromChange(doc, change) {\n    var histChange = {\n      from: copyPos(change.from),\n      to: changeEnd(change),\n      text: getBetween(doc, change.from, change.to)\n    };\n    attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);\n    linkedDocs(doc, function (doc) {\n      return attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);\n    }, true);\n    return histChange;\n  } // Pop all selection events off the end of a history array. Stop at\n  // a change event.\n\n\n  function clearSelectionEvents(array) {\n    while (array.length) {\n      var last = lst(array);\n\n      if (last.ranges) {\n        array.pop();\n      } else {\n        break;\n      }\n    }\n  } // Find the top change event in the history. Pop off selection\n  // events that are in the way.\n\n\n  function lastChangeEvent(hist, force) {\n    if (force) {\n      clearSelectionEvents(hist.done);\n      return lst(hist.done);\n    } else if (hist.done.length && !lst(hist.done).ranges) {\n      return lst(hist.done);\n    } else if (hist.done.length > 1 && !hist.done[hist.done.length - 2].ranges) {\n      hist.done.pop();\n      return lst(hist.done);\n    }\n  } // Register a change in the history. Merges changes that are within\n  // a single operation, or are close together with an origin that\n  // allows merging (starting with "+") into a single event.\n\n\n  function addChangeToHistory(doc, change, selAfter, opId) {\n    var hist = doc.history;\n    hist.undone.length = 0;\n    var time = +new Date(),\n        cur;\n    var last;\n\n    if ((hist.lastOp == opId || hist.lastOrigin == change.origin && change.origin && (change.origin.charAt(0) == "+" && hist.lastModTime > time - (doc.cm ? doc.cm.options.historyEventDelay : 500) || change.origin.charAt(0) == "*")) && (cur = lastChangeEvent(hist, hist.lastOp == opId))) {\n      // Merge this change into the last event\n      last = lst(cur.changes);\n\n      if (cmp(change.from, change.to) == 0 && cmp(change.from, last.to) == 0) {\n        // Optimized case for simple insertion -- don\'t want to add\n        // new changesets for every character typed\n        last.to = changeEnd(change);\n      } else {\n        // Add new sub-event\n        cur.changes.push(historyChangeFromChange(doc, change));\n      }\n    } else {\n      // Can not be merged, start a new event.\n      var before = lst(hist.done);\n\n      if (!before || !before.ranges) {\n        pushSelectionToHistory(doc.sel, hist.done);\n      }\n\n      cur = {\n        changes: [historyChangeFromChange(doc, change)],\n        generation: hist.generation\n      };\n      hist.done.push(cur);\n\n      while (hist.done.length > hist.undoDepth) {\n        hist.done.shift();\n\n        if (!hist.done[0].ranges) {\n          hist.done.shift();\n        }\n      }\n    }\n\n    hist.done.push(selAfter);\n    hist.generation = ++hist.maxGeneration;\n    hist.lastModTime = hist.lastSelTime = time;\n    hist.lastOp = hist.lastSelOp = opId;\n    hist.lastOrigin = hist.lastSelOrigin = change.origin;\n\n    if (!last) {\n      signal(doc, "historyAdded");\n    }\n  }\n\n  function selectionEventCanBeMerged(doc, origin, prev, sel) {\n    var ch = origin.charAt(0);\n    return ch == "*" || ch == "+" && prev.ranges.length == sel.ranges.length && prev.somethingSelected() == sel.somethingSelected() && new Date() - doc.history.lastSelTime <= (doc.cm ? doc.cm.options.historyEventDelay : 500);\n  } // Called whenever the selection changes, sets the new selection as\n  // the pending selection in the history, and pushes the old pending\n  // selection into the \'done\' array when it was significantly\n  // different (in number of selected ranges, emptiness, or time).\n\n\n  function addSelectionToHistory(doc, sel, opId, options) {\n    var hist = doc.history,\n        origin = options && options.origin; // A new event is started when the previous origin does not match\n    // the current, or the origins don\'t allow matching. Origins\n    // starting with * are always merged, those starting with + are\n    // merged when similar and close together in time.\n\n    if (opId == hist.lastSelOp || origin && hist.lastSelOrigin == origin && (hist.lastModTime == hist.lastSelTime && hist.lastOrigin == origin || selectionEventCanBeMerged(doc, origin, lst(hist.done), sel))) {\n      hist.done[hist.done.length - 1] = sel;\n    } else {\n      pushSelectionToHistory(sel, hist.done);\n    }\n\n    hist.lastSelTime = +new Date();\n    hist.lastSelOrigin = origin;\n    hist.lastSelOp = opId;\n\n    if (options && options.clearRedo !== false) {\n      clearSelectionEvents(hist.undone);\n    }\n  }\n\n  function pushSelectionToHistory(sel, dest) {\n    var top = lst(dest);\n\n    if (!(top && top.ranges && top.equals(sel))) {\n      dest.push(sel);\n    }\n  } // Used to store marked span information in the history.\n\n\n  function attachLocalSpans(doc, change, from, to) {\n    var existing = change["spans_" + doc.id],\n        n = 0;\n    doc.iter(Math.max(doc.first, from), Math.min(doc.first + doc.size, to), function (line) {\n      if (line.markedSpans) {\n        (existing || (existing = change["spans_" + doc.id] = {}))[n] = line.markedSpans;\n      }\n\n      ++n;\n    });\n  } // When un/re-doing restores text containing marked spans, those\n  // that have been explicitly cleared should not be restored.\n\n\n  function removeClearedSpans(spans) {\n    if (!spans) {\n      return null;\n    }\n\n    var out;\n\n    for (var i = 0; i < spans.length; ++i) {\n      if (spans[i].marker.explicitlyCleared) {\n        if (!out) {\n          out = spans.slice(0, i);\n        }\n      } else if (out) {\n        out.push(spans[i]);\n      }\n    }\n\n    return !out ? spans : out.length ? out : null;\n  } // Retrieve and filter the old marked spans stored in a change event.\n\n\n  function getOldSpans(doc, change) {\n    var found = change["spans_" + doc.id];\n\n    if (!found) {\n      return null;\n    }\n\n    var nw = [];\n\n    for (var i = 0; i < change.text.length; ++i) {\n      nw.push(removeClearedSpans(found[i]));\n    }\n\n    return nw;\n  } // Used for un/re-doing changes from the history. Combines the\n  // result of computing the existing spans with the set of spans that\n  // existed in the history (so that deleting around a span and then\n  // undoing brings back the span).\n\n\n  function mergeOldSpans(doc, change) {\n    var old = getOldSpans(doc, change);\n    var stretched = stretchSpansOverChange(doc, change);\n\n    if (!old) {\n      return stretched;\n    }\n\n    if (!stretched) {\n      return old;\n    }\n\n    for (var i = 0; i < old.length; ++i) {\n      var oldCur = old[i],\n          stretchCur = stretched[i];\n\n      if (oldCur && stretchCur) {\n        spans: for (var j = 0; j < stretchCur.length; ++j) {\n          var span = stretchCur[j];\n\n          for (var k = 0; k < oldCur.length; ++k) {\n            if (oldCur[k].marker == span.marker) {\n              continue spans;\n            }\n          }\n\n          oldCur.push(span);\n        }\n      } else if (stretchCur) {\n        old[i] = stretchCur;\n      }\n    }\n\n    return old;\n  } // Used both to provide a JSON-safe object in .getHistory, and, when\n  // detaching a document, to split the history in two\n\n\n  function copyHistoryArray(events, newGroup, instantiateSel) {\n    var copy = [];\n\n    for (var i = 0; i < events.length; ++i) {\n      var event = events[i];\n\n      if (event.ranges) {\n        copy.push(instantiateSel ? Selection.prototype.deepCopy.call(event) : event);\n        continue;\n      }\n\n      var changes = event.changes,\n          newChanges = [];\n      copy.push({\n        changes: newChanges\n      });\n\n      for (var j = 0; j < changes.length; ++j) {\n        var change = changes[j],\n            m = void 0;\n        newChanges.push({\n          from: change.from,\n          to: change.to,\n          text: change.text\n        });\n\n        if (newGroup) {\n          for (var prop in change) {\n            if (m = prop.match(/^spans_(\\d+)$/)) {\n              if (indexOf(newGroup, Number(m[1])) > -1) {\n                lst(newChanges)[prop] = change[prop];\n                delete change[prop];\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return copy;\n  } // The \'scroll\' parameter given to many of these indicated whether\n  // the new cursor position should be scrolled into view after\n  // modifying the selection.\n  // If shift is held or the extend flag is set, extends a range to\n  // include a given position (and optionally a second position).\n  // Otherwise, simply returns the range between the given positions.\n  // Used for cursor motion and such.\n\n\n  function extendRange(range, head, other, extend) {\n    if (extend) {\n      var anchor = range.anchor;\n\n      if (other) {\n        var posBefore = cmp(head, anchor) < 0;\n\n        if (posBefore != cmp(other, anchor) < 0) {\n          anchor = head;\n          head = other;\n        } else if (posBefore != cmp(head, other) < 0) {\n          head = other;\n        }\n      }\n\n      return new Range(anchor, head);\n    } else {\n      return new Range(other || head, head);\n    }\n  } // Extend the primary selection range, discard the rest.\n\n\n  function extendSelection(doc, head, other, options, extend) {\n    if (extend == null) {\n      extend = doc.cm && (doc.cm.display.shift || doc.extend);\n    }\n\n    setSelection(doc, new Selection([extendRange(doc.sel.primary(), head, other, extend)], 0), options);\n  } // Extend all selections (pos is an array of selections with length\n  // equal the number of selections)\n\n\n  function extendSelections(doc, heads, options) {\n    var out = [];\n    var extend = doc.cm && (doc.cm.display.shift || doc.extend);\n\n    for (var i = 0; i < doc.sel.ranges.length; i++) {\n      out[i] = extendRange(doc.sel.ranges[i], heads[i], null, extend);\n    }\n\n    var newSel = normalizeSelection(doc.cm, out, doc.sel.primIndex);\n    setSelection(doc, newSel, options);\n  } // Updates a single range in the selection.\n\n\n  function replaceOneSelection(doc, i, range, options) {\n    var ranges = doc.sel.ranges.slice(0);\n    ranges[i] = range;\n    setSelection(doc, normalizeSelection(doc.cm, ranges, doc.sel.primIndex), options);\n  } // Reset the selection to a single range.\n\n\n  function setSimpleSelection(doc, anchor, head, options) {\n    setSelection(doc, simpleSelection(anchor, head), options);\n  } // Give beforeSelectionChange handlers a change to influence a\n  // selection update.\n\n\n  function filterSelectionChange(doc, sel, options) {\n    var obj = {\n      ranges: sel.ranges,\n      update: function update(ranges) {\n        this.ranges = [];\n\n        for (var i = 0; i < ranges.length; i++) {\n          this.ranges[i] = new Range(_clipPos(doc, ranges[i].anchor), _clipPos(doc, ranges[i].head));\n        }\n      },\n      origin: options && options.origin\n    };\n    signal(doc, "beforeSelectionChange", doc, obj);\n\n    if (doc.cm) {\n      signal(doc.cm, "beforeSelectionChange", doc.cm, obj);\n    }\n\n    if (obj.ranges != sel.ranges) {\n      return normalizeSelection(doc.cm, obj.ranges, obj.ranges.length - 1);\n    } else {\n      return sel;\n    }\n  }\n\n  function setSelectionReplaceHistory(doc, sel, options) {\n    var done = doc.history.done,\n        last = lst(done);\n\n    if (last && last.ranges) {\n      done[done.length - 1] = sel;\n      setSelectionNoUndo(doc, sel, options);\n    } else {\n      setSelection(doc, sel, options);\n    }\n  } // Set a new selection.\n\n\n  function setSelection(doc, sel, options) {\n    setSelectionNoUndo(doc, sel, options);\n    addSelectionToHistory(doc, doc.sel, doc.cm ? doc.cm.curOp.id : NaN, options);\n  }\n\n  function setSelectionNoUndo(doc, sel, options) {\n    if (hasHandler(doc, "beforeSelectionChange") || doc.cm && hasHandler(doc.cm, "beforeSelectionChange")) {\n      sel = filterSelectionChange(doc, sel, options);\n    }\n\n    var bias = options && options.bias || (cmp(sel.primary().head, doc.sel.primary().head) < 0 ? -1 : 1);\n    setSelectionInner(doc, skipAtomicInSelection(doc, sel, bias, true));\n\n    if (!(options && options.scroll === false) && doc.cm) {\n      ensureCursorVisible(doc.cm);\n    }\n  }\n\n  function setSelectionInner(doc, sel) {\n    if (sel.equals(doc.sel)) {\n      return;\n    }\n\n    doc.sel = sel;\n\n    if (doc.cm) {\n      doc.cm.curOp.updateInput = 1;\n      doc.cm.curOp.selectionChanged = true;\n      signalCursorActivity(doc.cm);\n    }\n\n    signalLater(doc, "cursorActivity", doc);\n  } // Verify that the selection does not partially select any atomic\n  // marked ranges.\n\n\n  function reCheckSelection(doc) {\n    setSelectionInner(doc, skipAtomicInSelection(doc, doc.sel, null, false));\n  } // Return a selection that does not partially select any atomic\n  // ranges.\n\n\n  function skipAtomicInSelection(doc, sel, bias, mayClear) {\n    var out;\n\n    for (var i = 0; i < sel.ranges.length; i++) {\n      var range = sel.ranges[i];\n      var old = sel.ranges.length == doc.sel.ranges.length && doc.sel.ranges[i];\n      var newAnchor = skipAtomic(doc, range.anchor, old && old.anchor, bias, mayClear);\n      var newHead = skipAtomic(doc, range.head, old && old.head, bias, mayClear);\n\n      if (out || newAnchor != range.anchor || newHead != range.head) {\n        if (!out) {\n          out = sel.ranges.slice(0, i);\n        }\n\n        out[i] = new Range(newAnchor, newHead);\n      }\n    }\n\n    return out ? normalizeSelection(doc.cm, out, sel.primIndex) : sel;\n  }\n\n  function skipAtomicInner(doc, pos, oldPos, dir, mayClear) {\n    var line = getLine(doc, pos.line);\n\n    if (line.markedSpans) {\n      for (var i = 0; i < line.markedSpans.length; ++i) {\n        var sp = line.markedSpans[i],\n            m = sp.marker; // Determine if we should prevent the cursor being placed to the left/right of an atomic marker\n        // Historically this was determined using the inclusiveLeft/Right option, but the new way to control it\n        // is with selectLeft/Right\n\n        var preventCursorLeft = "selectLeft" in m ? !m.selectLeft : m.inclusiveLeft;\n        var preventCursorRight = "selectRight" in m ? !m.selectRight : m.inclusiveRight;\n\n        if ((sp.from == null || (preventCursorLeft ? sp.from <= pos.ch : sp.from < pos.ch)) && (sp.to == null || (preventCursorRight ? sp.to >= pos.ch : sp.to > pos.ch))) {\n          if (mayClear) {\n            signal(m, "beforeCursorEnter");\n\n            if (m.explicitlyCleared) {\n              if (!line.markedSpans) {\n                break;\n              } else {\n                --i;\n                continue;\n              }\n            }\n          }\n\n          if (!m.atomic) {\n            continue;\n          }\n\n          if (oldPos) {\n            var near = m.find(dir < 0 ? 1 : -1),\n                diff = void 0;\n\n            if (dir < 0 ? preventCursorRight : preventCursorLeft) {\n              near = movePos(doc, near, -dir, near && near.line == pos.line ? line : null);\n            }\n\n            if (near && near.line == pos.line && (diff = cmp(near, oldPos)) && (dir < 0 ? diff < 0 : diff > 0)) {\n              return skipAtomicInner(doc, near, pos, dir, mayClear);\n            }\n          }\n\n          var far = m.find(dir < 0 ? -1 : 1);\n\n          if (dir < 0 ? preventCursorLeft : preventCursorRight) {\n            far = movePos(doc, far, dir, far.line == pos.line ? line : null);\n          }\n\n          return far ? skipAtomicInner(doc, far, pos, dir, mayClear) : null;\n        }\n      }\n    }\n\n    return pos;\n  } // Ensure a given position is not inside an atomic range.\n\n\n  function skipAtomic(doc, pos, oldPos, bias, mayClear) {\n    var dir = bias || 1;\n    var found = skipAtomicInner(doc, pos, oldPos, dir, mayClear) || !mayClear && skipAtomicInner(doc, pos, oldPos, dir, true) || skipAtomicInner(doc, pos, oldPos, -dir, mayClear) || !mayClear && skipAtomicInner(doc, pos, oldPos, -dir, true);\n\n    if (!found) {\n      doc.cantEdit = true;\n      return Pos(doc.first, 0);\n    }\n\n    return found;\n  }\n\n  function movePos(doc, pos, dir, line) {\n    if (dir < 0 && pos.ch == 0) {\n      if (pos.line > doc.first) {\n        return _clipPos(doc, Pos(pos.line - 1));\n      } else {\n        return null;\n      }\n    } else if (dir > 0 && pos.ch == (line || getLine(doc, pos.line)).text.length) {\n      if (pos.line < doc.first + doc.size - 1) {\n        return Pos(pos.line + 1, 0);\n      } else {\n        return null;\n      }\n    } else {\n      return new Pos(pos.line, pos.ch + dir);\n    }\n  }\n\n  function selectAll(cm) {\n    cm.setSelection(Pos(cm.firstLine(), 0), Pos(cm.lastLine()), sel_dontScroll);\n  } // UPDATING\n  // Allow "beforeChange" event handlers to influence a change\n\n\n  function filterChange(doc, change, update) {\n    var obj = {\n      canceled: false,\n      from: change.from,\n      to: change.to,\n      text: change.text,\n      origin: change.origin,\n      cancel: function cancel() {\n        return obj.canceled = true;\n      }\n    };\n\n    if (update) {\n      obj.update = function (from, to, text, origin) {\n        if (from) {\n          obj.from = _clipPos(doc, from);\n        }\n\n        if (to) {\n          obj.to = _clipPos(doc, to);\n        }\n\n        if (text) {\n          obj.text = text;\n        }\n\n        if (origin !== undefined) {\n          obj.origin = origin;\n        }\n      };\n    }\n\n    signal(doc, "beforeChange", doc, obj);\n\n    if (doc.cm) {\n      signal(doc.cm, "beforeChange", doc.cm, obj);\n    }\n\n    if (obj.canceled) {\n      if (doc.cm) {\n        doc.cm.curOp.updateInput = 2;\n      }\n\n      return null;\n    }\n\n    return {\n      from: obj.from,\n      to: obj.to,\n      text: obj.text,\n      origin: obj.origin\n    };\n  } // Apply a change to a document, and add it to the document\'s\n  // history, and propagating it to all linked documents.\n\n\n  function makeChange(doc, change, ignoreReadOnly) {\n    if (doc.cm) {\n      if (!doc.cm.curOp) {\n        return operation(doc.cm, makeChange)(doc, change, ignoreReadOnly);\n      }\n\n      if (doc.cm.state.suppressEdits) {\n        return;\n      }\n    }\n\n    if (hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")) {\n      change = filterChange(doc, change, true);\n\n      if (!change) {\n        return;\n      }\n    } // Possibly split or suppress the update based on the presence\n    // of read-only spans in its range.\n\n\n    var split = sawReadOnlySpans && !ignoreReadOnly && removeReadOnlyRanges(doc, change.from, change.to);\n\n    if (split) {\n      for (var i = split.length - 1; i >= 0; --i) {\n        makeChangeInner(doc, {\n          from: split[i].from,\n          to: split[i].to,\n          text: i ? [""] : change.text,\n          origin: change.origin\n        });\n      }\n    } else {\n      makeChangeInner(doc, change);\n    }\n  }\n\n  function makeChangeInner(doc, change) {\n    if (change.text.length == 1 && change.text[0] == "" && cmp(change.from, change.to) == 0) {\n      return;\n    }\n\n    var selAfter = computeSelAfterChange(doc, change);\n    addChangeToHistory(doc, change, selAfter, doc.cm ? doc.cm.curOp.id : NaN);\n    makeChangeSingleDoc(doc, change, selAfter, stretchSpansOverChange(doc, change));\n    var rebased = [];\n    linkedDocs(doc, function (doc, sharedHist) {\n      if (!sharedHist && indexOf(rebased, doc.history) == -1) {\n        rebaseHist(doc.history, change);\n        rebased.push(doc.history);\n      }\n\n      makeChangeSingleDoc(doc, change, null, stretchSpansOverChange(doc, change));\n    });\n  } // Revert a change stored in a document\'s history.\n\n\n  function makeChangeFromHistory(doc, type, allowSelectionOnly) {\n    var suppress = doc.cm && doc.cm.state.suppressEdits;\n\n    if (suppress && !allowSelectionOnly) {\n      return;\n    }\n\n    var hist = doc.history,\n        event,\n        selAfter = doc.sel;\n    var source = type == "undo" ? hist.done : hist.undone,\n        dest = type == "undo" ? hist.undone : hist.done; // Verify that there is a useable event (so that ctrl-z won\'t\n    // needlessly clear selection events)\n\n    var i = 0;\n\n    for (; i < source.length; i++) {\n      event = source[i];\n\n      if (allowSelectionOnly ? event.ranges && !event.equals(doc.sel) : !event.ranges) {\n        break;\n      }\n    }\n\n    if (i == source.length) {\n      return;\n    }\n\n    hist.lastOrigin = hist.lastSelOrigin = null;\n\n    for (;;) {\n      event = source.pop();\n\n      if (event.ranges) {\n        pushSelectionToHistory(event, dest);\n\n        if (allowSelectionOnly && !event.equals(doc.sel)) {\n          setSelection(doc, event, {\n            clearRedo: false\n          });\n          return;\n        }\n\n        selAfter = event;\n      } else if (suppress) {\n        source.push(event);\n        return;\n      } else {\n        break;\n      }\n    } // Build up a reverse change object to add to the opposite history\n    // stack (redo when undoing, and vice versa).\n\n\n    var antiChanges = [];\n    pushSelectionToHistory(selAfter, dest);\n    dest.push({\n      changes: antiChanges,\n      generation: hist.generation\n    });\n    hist.generation = event.generation || ++hist.maxGeneration;\n    var filter = hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange");\n\n    var loop = function loop(i) {\n      var change = event.changes[i];\n      change.origin = type;\n\n      if (filter && !filterChange(doc, change, false)) {\n        source.length = 0;\n        return {};\n      }\n\n      antiChanges.push(historyChangeFromChange(doc, change));\n      var after = i ? computeSelAfterChange(doc, change) : lst(source);\n      makeChangeSingleDoc(doc, change, after, mergeOldSpans(doc, change));\n\n      if (!i && doc.cm) {\n        doc.cm.scrollIntoView({\n          from: change.from,\n          to: changeEnd(change)\n        });\n      }\n\n      var rebased = []; // Propagate to the linked documents\n\n      linkedDocs(doc, function (doc, sharedHist) {\n        if (!sharedHist && indexOf(rebased, doc.history) == -1) {\n          rebaseHist(doc.history, change);\n          rebased.push(doc.history);\n        }\n\n        makeChangeSingleDoc(doc, change, null, mergeOldSpans(doc, change));\n      });\n    };\n\n    for (var i$1 = event.changes.length - 1; i$1 >= 0; --i$1) {\n      var returned = loop(i$1);\n      if (returned) return returned.v;\n    }\n  } // Sub-views need their line numbers shifted when text is added\n  // above or below them in the parent document.\n\n\n  function shiftDoc(doc, distance) {\n    if (distance == 0) {\n      return;\n    }\n\n    doc.first += distance;\n    doc.sel = new Selection(map(doc.sel.ranges, function (range) {\n      return new Range(Pos(range.anchor.line + distance, range.anchor.ch), Pos(range.head.line + distance, range.head.ch));\n    }), doc.sel.primIndex);\n\n    if (doc.cm) {\n      regChange(doc.cm, doc.first, doc.first - distance, distance);\n\n      for (var d = doc.cm.display, l = d.viewFrom; l < d.viewTo; l++) {\n        regLineChange(doc.cm, l, "gutter");\n      }\n    }\n  } // More lower-level change function, handling only a single document\n  // (not linked ones).\n\n\n  function makeChangeSingleDoc(doc, change, selAfter, spans) {\n    if (doc.cm && !doc.cm.curOp) {\n      return operation(doc.cm, makeChangeSingleDoc)(doc, change, selAfter, spans);\n    }\n\n    if (change.to.line < doc.first) {\n      shiftDoc(doc, change.text.length - 1 - (change.to.line - change.from.line));\n      return;\n    }\n\n    if (change.from.line > doc.lastLine()) {\n      return;\n    } // Clip the change to the size of this doc\n\n\n    if (change.from.line < doc.first) {\n      var shift = change.text.length - 1 - (doc.first - change.from.line);\n      shiftDoc(doc, shift);\n      change = {\n        from: Pos(doc.first, 0),\n        to: Pos(change.to.line + shift, change.to.ch),\n        text: [lst(change.text)],\n        origin: change.origin\n      };\n    }\n\n    var last = doc.lastLine();\n\n    if (change.to.line > last) {\n      change = {\n        from: change.from,\n        to: Pos(last, getLine(doc, last).text.length),\n        text: [change.text[0]],\n        origin: change.origin\n      };\n    }\n\n    change.removed = getBetween(doc, change.from, change.to);\n\n    if (!selAfter) {\n      selAfter = computeSelAfterChange(doc, change);\n    }\n\n    if (doc.cm) {\n      makeChangeSingleDocInEditor(doc.cm, change, spans);\n    } else {\n      updateDoc(doc, change, spans);\n    }\n\n    setSelectionNoUndo(doc, selAfter, sel_dontScroll);\n\n    if (doc.cantEdit && skipAtomic(doc, Pos(doc.firstLine(), 0))) {\n      doc.cantEdit = false;\n    }\n  } // Handle the interaction of a change to a document with the editor\n  // that this document is part of.\n\n\n  function makeChangeSingleDocInEditor(cm, change, spans) {\n    var doc = cm.doc,\n        display = cm.display,\n        from = change.from,\n        to = change.to;\n    var recomputeMaxLength = false,\n        checkWidthStart = from.line;\n\n    if (!cm.options.lineWrapping) {\n      checkWidthStart = lineNo(visualLine(getLine(doc, from.line)));\n      doc.iter(checkWidthStart, to.line + 1, function (line) {\n        if (line == display.maxLine) {\n          recomputeMaxLength = true;\n          return true;\n        }\n      });\n    }\n\n    if (doc.sel.contains(change.from, change.to) > -1) {\n      signalCursorActivity(cm);\n    }\n\n    updateDoc(doc, change, spans, estimateHeight(cm));\n\n    if (!cm.options.lineWrapping) {\n      doc.iter(checkWidthStart, from.line + change.text.length, function (line) {\n        var len = lineLength(line);\n\n        if (len > display.maxLineLength) {\n          display.maxLine = line;\n          display.maxLineLength = len;\n          display.maxLineChanged = true;\n          recomputeMaxLength = false;\n        }\n      });\n\n      if (recomputeMaxLength) {\n        cm.curOp.updateMaxLine = true;\n      }\n    }\n\n    retreatFrontier(doc, from.line);\n    startWorker(cm, 400);\n    var lendiff = change.text.length - (to.line - from.line) - 1; // Remember that these lines changed, for updating the display\n\n    if (change.full) {\n      regChange(cm);\n    } else if (from.line == to.line && change.text.length == 1 && !isWholeLineUpdate(cm.doc, change)) {\n      regLineChange(cm, from.line, "text");\n    } else {\n      regChange(cm, from.line, to.line + 1, lendiff);\n    }\n\n    var changesHandler = hasHandler(cm, "changes"),\n        changeHandler = hasHandler(cm, "change");\n\n    if (changeHandler || changesHandler) {\n      var obj = {\n        from: from,\n        to: to,\n        text: change.text,\n        removed: change.removed,\n        origin: change.origin\n      };\n\n      if (changeHandler) {\n        signalLater(cm, "change", cm, obj);\n      }\n\n      if (changesHandler) {\n        (cm.curOp.changeObjs || (cm.curOp.changeObjs = [])).push(obj);\n      }\n    }\n\n    cm.display.selForContextMenu = null;\n  }\n\n  function _replaceRange(doc, code, from, to, origin) {\n    var assign;\n\n    if (!to) {\n      to = from;\n    }\n\n    if (cmp(to, from) < 0) {\n      assign = [to, from], from = assign[0], to = assign[1];\n    }\n\n    if (typeof code == "string") {\n      code = doc.splitLines(code);\n    }\n\n    makeChange(doc, {\n      from: from,\n      to: to,\n      text: code,\n      origin: origin\n    });\n  } // Rebasing/resetting history to deal with externally-sourced changes\n\n\n  function rebaseHistSelSingle(pos, from, to, diff) {\n    if (to < pos.line) {\n      pos.line += diff;\n    } else if (from < pos.line) {\n      pos.line = from;\n      pos.ch = 0;\n    }\n  } // Tries to rebase an array of history events given a change in the\n  // document. If the change touches the same lines as the event, the\n  // event, and everything \'behind\' it, is discarded. If the change is\n  // before the event, the event\'s positions are updated. Uses a\n  // copy-on-write scheme for the positions, to avoid having to\n  // reallocate them all on every rebase, but also avoid problems with\n  // shared position objects being unsafely updated.\n\n\n  function rebaseHistArray(array, from, to, diff) {\n    for (var i = 0; i < array.length; ++i) {\n      var sub = array[i],\n          ok = true;\n\n      if (sub.ranges) {\n        if (!sub.copied) {\n          sub = array[i] = sub.deepCopy();\n          sub.copied = true;\n        }\n\n        for (var j = 0; j < sub.ranges.length; j++) {\n          rebaseHistSelSingle(sub.ranges[j].anchor, from, to, diff);\n          rebaseHistSelSingle(sub.ranges[j].head, from, to, diff);\n        }\n\n        continue;\n      }\n\n      for (var j$1 = 0; j$1 < sub.changes.length; ++j$1) {\n        var cur = sub.changes[j$1];\n\n        if (to < cur.from.line) {\n          cur.from = Pos(cur.from.line + diff, cur.from.ch);\n          cur.to = Pos(cur.to.line + diff, cur.to.ch);\n        } else if (from <= cur.to.line) {\n          ok = false;\n          break;\n        }\n      }\n\n      if (!ok) {\n        array.splice(0, i + 1);\n        i = 0;\n      }\n    }\n  }\n\n  function rebaseHist(hist, change) {\n    var from = change.from.line,\n        to = change.to.line,\n        diff = change.text.length - (to - from) - 1;\n    rebaseHistArray(hist.done, from, to, diff);\n    rebaseHistArray(hist.undone, from, to, diff);\n  } // Utility for applying a change to a line by handle or number,\n  // returning the number and optionally registering the line as\n  // changed.\n\n\n  function changeLine(doc, handle, changeType, op) {\n    var no = handle,\n        line = handle;\n\n    if (typeof handle == "number") {\n      line = getLine(doc, clipLine(doc, handle));\n    } else {\n      no = lineNo(handle);\n    }\n\n    if (no == null) {\n      return null;\n    }\n\n    if (op(line, no) && doc.cm) {\n      regLineChange(doc.cm, no, changeType);\n    }\n\n    return line;\n  } // The document is represented as a BTree consisting of leaves, with\n  // chunk of lines in them, and branches, with up to ten leaves or\n  // other branch nodes below them. The top node is always a branch\n  // node, and is the document object itself (meaning it has\n  // additional methods and properties).\n  //\n  // All nodes have parent links. The tree is used both to go from\n  // line numbers to line objects, and to go from objects to numbers.\n  // It also indexes by height, and is used to convert between height\n  // and line object, and to find the total height of the document.\n  //\n  // See also http://marijnhaverbeke.nl/blog/codemirror-line-tree.html\n\n\n  function LeafChunk(lines) {\n    this.lines = lines;\n    this.parent = null;\n    var height = 0;\n\n    for (var i = 0; i < lines.length; ++i) {\n      lines[i].parent = this;\n      height += lines[i].height;\n    }\n\n    this.height = height;\n  }\n\n  LeafChunk.prototype = {\n    chunkSize: function chunkSize() {\n      return this.lines.length;\n    },\n    // Remove the n lines at offset \'at\'.\n    removeInner: function removeInner(at, n) {\n      for (var i = at, e = at + n; i < e; ++i) {\n        var line = this.lines[i];\n        this.height -= line.height;\n        cleanUpLine(line);\n        signalLater(line, "delete");\n      }\n\n      this.lines.splice(at, n);\n    },\n    // Helper used to collapse a small branch into a single leaf.\n    collapse: function collapse(lines) {\n      lines.push.apply(lines, this.lines);\n    },\n    // Insert the given array of lines at offset \'at\', count them as\n    // having the given height.\n    insertInner: function insertInner(at, lines, height) {\n      this.height += height;\n      this.lines = this.lines.slice(0, at).concat(lines).concat(this.lines.slice(at));\n\n      for (var i = 0; i < lines.length; ++i) {\n        lines[i].parent = this;\n      }\n    },\n    // Used to iterate over a part of the tree.\n    iterN: function iterN(at, n, op) {\n      for (var e = at + n; at < e; ++at) {\n        if (op(this.lines[at])) {\n          return true;\n        }\n      }\n    }\n  };\n\n  function BranchChunk(children) {\n    this.children = children;\n    var size = 0,\n        height = 0;\n\n    for (var i = 0; i < children.length; ++i) {\n      var ch = children[i];\n      size += ch.chunkSize();\n      height += ch.height;\n      ch.parent = this;\n    }\n\n    this.size = size;\n    this.height = height;\n    this.parent = null;\n  }\n\n  BranchChunk.prototype = {\n    chunkSize: function chunkSize() {\n      return this.size;\n    },\n    removeInner: function removeInner(at, n) {\n      this.size -= n;\n\n      for (var i = 0; i < this.children.length; ++i) {\n        var child = this.children[i],\n            sz = child.chunkSize();\n\n        if (at < sz) {\n          var rm = Math.min(n, sz - at),\n              oldHeight = child.height;\n          child.removeInner(at, rm);\n          this.height -= oldHeight - child.height;\n\n          if (sz == rm) {\n            this.children.splice(i--, 1);\n            child.parent = null;\n          }\n\n          if ((n -= rm) == 0) {\n            break;\n          }\n\n          at = 0;\n        } else {\n          at -= sz;\n        }\n      } // If the result is smaller than 25 lines, ensure that it is a\n      // single leaf node.\n\n\n      if (this.size - n < 25 && (this.children.length > 1 || !(this.children[0] instanceof LeafChunk))) {\n        var lines = [];\n        this.collapse(lines);\n        this.children = [new LeafChunk(lines)];\n        this.children[0].parent = this;\n      }\n    },\n    collapse: function collapse(lines) {\n      for (var i = 0; i < this.children.length; ++i) {\n        this.children[i].collapse(lines);\n      }\n    },\n    insertInner: function insertInner(at, lines, height) {\n      this.size += lines.length;\n      this.height += height;\n\n      for (var i = 0; i < this.children.length; ++i) {\n        var child = this.children[i],\n            sz = child.chunkSize();\n\n        if (at <= sz) {\n          child.insertInner(at, lines, height);\n\n          if (child.lines && child.lines.length > 50) {\n            // To avoid memory thrashing when child.lines is huge (e.g. first view of a large file), it\'s never spliced.\n            // Instead, small slices are taken. They\'re taken in order because sequential memory accesses are fastest.\n            var remaining = child.lines.length % 25 + 25;\n\n            for (var pos = remaining; pos < child.lines.length;) {\n              var leaf = new LeafChunk(child.lines.slice(pos, pos += 25));\n              child.height -= leaf.height;\n              this.children.splice(++i, 0, leaf);\n              leaf.parent = this;\n            }\n\n            child.lines = child.lines.slice(0, remaining);\n            this.maybeSpill();\n          }\n\n          break;\n        }\n\n        at -= sz;\n      }\n    },\n    // When a node has grown, check whether it should be split.\n    maybeSpill: function maybeSpill() {\n      if (this.children.length <= 10) {\n        return;\n      }\n\n      var me = this;\n\n      do {\n        var spilled = me.children.splice(me.children.length - 5, 5);\n        var sibling = new BranchChunk(spilled);\n\n        if (!me.parent) {\n          // Become the parent node\n          var copy = new BranchChunk(me.children);\n          copy.parent = me;\n          me.children = [copy, sibling];\n          me = copy;\n        } else {\n          me.size -= sibling.size;\n          me.height -= sibling.height;\n          var myIndex = indexOf(me.parent.children, me);\n          me.parent.children.splice(myIndex + 1, 0, sibling);\n        }\n\n        sibling.parent = me.parent;\n      } while (me.children.length > 10);\n\n      me.parent.maybeSpill();\n    },\n    iterN: function iterN(at, n, op) {\n      for (var i = 0; i < this.children.length; ++i) {\n        var child = this.children[i],\n            sz = child.chunkSize();\n\n        if (at < sz) {\n          var used = Math.min(n, sz - at);\n\n          if (child.iterN(at, used, op)) {\n            return true;\n          }\n\n          if ((n -= used) == 0) {\n            break;\n          }\n\n          at = 0;\n        } else {\n          at -= sz;\n        }\n      }\n    }\n  }; // Line widgets are block elements displayed above or below a line.\n\n  var LineWidget = function LineWidget(doc, node, options) {\n    if (options) {\n      for (var opt in options) {\n        if (options.hasOwnProperty(opt)) {\n          this[opt] = options[opt];\n        }\n      }\n    }\n\n    this.doc = doc;\n    this.node = node;\n  };\n\n  LineWidget.prototype.clear = function () {\n    var cm = this.doc.cm,\n        ws = this.line.widgets,\n        line = this.line,\n        no = lineNo(line);\n\n    if (no == null || !ws) {\n      return;\n    }\n\n    for (var i = 0; i < ws.length; ++i) {\n      if (ws[i] == this) {\n        ws.splice(i--, 1);\n      }\n    }\n\n    if (!ws.length) {\n      line.widgets = null;\n    }\n\n    var height = widgetHeight(this);\n    updateLineHeight(line, Math.max(0, line.height - height));\n\n    if (cm) {\n      runInOp(cm, function () {\n        adjustScrollWhenAboveVisible(cm, line, -height);\n        regLineChange(cm, no, "widget");\n      });\n      signalLater(cm, "lineWidgetCleared", cm, this, no);\n    }\n  };\n\n  LineWidget.prototype.changed = function () {\n    var this$1 = this;\n    var oldH = this.height,\n        cm = this.doc.cm,\n        line = this.line;\n    this.height = null;\n    var diff = widgetHeight(this) - oldH;\n\n    if (!diff) {\n      return;\n    }\n\n    if (!lineIsHidden(this.doc, line)) {\n      updateLineHeight(line, line.height + diff);\n    }\n\n    if (cm) {\n      runInOp(cm, function () {\n        cm.curOp.forceUpdate = true;\n        adjustScrollWhenAboveVisible(cm, line, diff);\n        signalLater(cm, "lineWidgetChanged", cm, this$1, lineNo(line));\n      });\n    }\n  };\n\n  eventMixin(LineWidget);\n\n  function adjustScrollWhenAboveVisible(cm, line, diff) {\n    if (_heightAtLine(line) < (cm.curOp && cm.curOp.scrollTop || cm.doc.scrollTop)) {\n      addToScrollTop(cm, diff);\n    }\n  }\n\n  function addLineWidget(doc, handle, node, options) {\n    var widget = new LineWidget(doc, node, options);\n    var cm = doc.cm;\n\n    if (cm && widget.noHScroll) {\n      cm.display.alignWidgets = true;\n    }\n\n    changeLine(doc, handle, "widget", function (line) {\n      var widgets = line.widgets || (line.widgets = []);\n\n      if (widget.insertAt == null) {\n        widgets.push(widget);\n      } else {\n        widgets.splice(Math.min(widgets.length - 1, Math.max(0, widget.insertAt)), 0, widget);\n      }\n\n      widget.line = line;\n\n      if (cm && !lineIsHidden(doc, line)) {\n        var aboveVisible = _heightAtLine(line) < doc.scrollTop;\n        updateLineHeight(line, line.height + widgetHeight(widget));\n\n        if (aboveVisible) {\n          addToScrollTop(cm, widget.height);\n        }\n\n        cm.curOp.forceUpdate = true;\n      }\n\n      return true;\n    });\n\n    if (cm) {\n      signalLater(cm, "lineWidgetAdded", cm, widget, typeof handle == "number" ? handle : lineNo(handle));\n    }\n\n    return widget;\n  } // TEXTMARKERS\n  // Created with markText and setBookmark methods. A TextMarker is a\n  // handle that can be used to clear or find a marked position in the\n  // document. Line objects hold arrays (markedSpans) containing\n  // {from, to, marker} object pointing to such marker objects, and\n  // indicating that such a marker is present on that line. Multiple\n  // lines may point to the same marker when it spans across lines.\n  // The spans will have null for their from/to properties when the\n  // marker continues beyond the start/end of the line. Markers have\n  // links back to the lines they currently touch.\n  // Collapsed markers have unique ids, in order to be able to order\n  // them, which is needed for uniquely determining an outer marker\n  // when they overlap (they may nest, but not partially overlap).\n\n\n  var nextMarkerId = 0;\n\n  var TextMarker = function TextMarker(doc, type) {\n    this.lines = [];\n    this.type = type;\n    this.doc = doc;\n    this.id = ++nextMarkerId;\n  }; // Clear the marker.\n\n\n  TextMarker.prototype.clear = function () {\n    if (this.explicitlyCleared) {\n      return;\n    }\n\n    var cm = this.doc.cm,\n        withOp = cm && !cm.curOp;\n\n    if (withOp) {\n      _startOperation(cm);\n    }\n\n    if (hasHandler(this, "clear")) {\n      var found = this.find();\n\n      if (found) {\n        signalLater(this, "clear", found.from, found.to);\n      }\n    }\n\n    var min = null,\n        max = null;\n\n    for (var i = 0; i < this.lines.length; ++i) {\n      var line = this.lines[i];\n      var span = getMarkedSpanFor(line.markedSpans, this);\n\n      if (cm && !this.collapsed) {\n        regLineChange(cm, lineNo(line), "text");\n      } else if (cm) {\n        if (span.to != null) {\n          max = lineNo(line);\n        }\n\n        if (span.from != null) {\n          min = lineNo(line);\n        }\n      }\n\n      line.markedSpans = removeMarkedSpan(line.markedSpans, span);\n\n      if (span.from == null && this.collapsed && !lineIsHidden(this.doc, line) && cm) {\n        updateLineHeight(line, textHeight(cm.display));\n      }\n    }\n\n    if (cm && this.collapsed && !cm.options.lineWrapping) {\n      for (var i$1 = 0; i$1 < this.lines.length; ++i$1) {\n        var visual = visualLine(this.lines[i$1]),\n            len = lineLength(visual);\n\n        if (len > cm.display.maxLineLength) {\n          cm.display.maxLine = visual;\n          cm.display.maxLineLength = len;\n          cm.display.maxLineChanged = true;\n        }\n      }\n    }\n\n    if (min != null && cm && this.collapsed) {\n      regChange(cm, min, max + 1);\n    }\n\n    this.lines.length = 0;\n    this.explicitlyCleared = true;\n\n    if (this.atomic && this.doc.cantEdit) {\n      this.doc.cantEdit = false;\n\n      if (cm) {\n        reCheckSelection(cm.doc);\n      }\n    }\n\n    if (cm) {\n      signalLater(cm, "markerCleared", cm, this, min, max);\n    }\n\n    if (withOp) {\n      _endOperation(cm);\n    }\n\n    if (this.parent) {\n      this.parent.clear();\n    }\n  }; // Find the position of the marker in the document. Returns a {from,\n  // to} object by default. Side can be passed to get a specific side\n  // -- 0 (both), -1 (left), or 1 (right). When lineObj is true, the\n  // Pos objects returned contain a line object, rather than a line\n  // number (used to prevent looking up the same line twice).\n\n\n  TextMarker.prototype.find = function (side, lineObj) {\n    if (side == null && this.type == "bookmark") {\n      side = 1;\n    }\n\n    var from, to;\n\n    for (var i = 0; i < this.lines.length; ++i) {\n      var line = this.lines[i];\n      var span = getMarkedSpanFor(line.markedSpans, this);\n\n      if (span.from != null) {\n        from = Pos(lineObj ? line : lineNo(line), span.from);\n\n        if (side == -1) {\n          return from;\n        }\n      }\n\n      if (span.to != null) {\n        to = Pos(lineObj ? line : lineNo(line), span.to);\n\n        if (side == 1) {\n          return to;\n        }\n      }\n    }\n\n    return from && {\n      from: from,\n      to: to\n    };\n  }; // Signals that the marker\'s widget changed, and surrounding layout\n  // should be recomputed.\n\n\n  TextMarker.prototype.changed = function () {\n    var this$1 = this;\n    var pos = this.find(-1, true),\n        widget = this,\n        cm = this.doc.cm;\n\n    if (!pos || !cm) {\n      return;\n    }\n\n    runInOp(cm, function () {\n      var line = pos.line,\n          lineN = lineNo(pos.line);\n      var view = findViewForLine(cm, lineN);\n\n      if (view) {\n        clearLineMeasurementCacheFor(view);\n        cm.curOp.selectionChanged = cm.curOp.forceUpdate = true;\n      }\n\n      cm.curOp.updateMaxLine = true;\n\n      if (!lineIsHidden(widget.doc, line) && widget.height != null) {\n        var oldHeight = widget.height;\n        widget.height = null;\n        var dHeight = widgetHeight(widget) - oldHeight;\n\n        if (dHeight) {\n          updateLineHeight(line, line.height + dHeight);\n        }\n      }\n\n      signalLater(cm, "markerChanged", cm, this$1);\n    });\n  };\n\n  TextMarker.prototype.attachLine = function (line) {\n    if (!this.lines.length && this.doc.cm) {\n      var op = this.doc.cm.curOp;\n\n      if (!op.maybeHiddenMarkers || indexOf(op.maybeHiddenMarkers, this) == -1) {\n        (op.maybeUnhiddenMarkers || (op.maybeUnhiddenMarkers = [])).push(this);\n      }\n    }\n\n    this.lines.push(line);\n  };\n\n  TextMarker.prototype.detachLine = function (line) {\n    this.lines.splice(indexOf(this.lines, line), 1);\n\n    if (!this.lines.length && this.doc.cm) {\n      var op = this.doc.cm.curOp;\n      (op.maybeHiddenMarkers || (op.maybeHiddenMarkers = [])).push(this);\n    }\n  };\n\n  eventMixin(TextMarker); // Create a marker, wire it up to the right lines, and\n\n  function _markText(doc, from, to, options, type) {\n    // Shared markers (across linked documents) are handled separately\n    // (markTextShared will call out to this again, once per\n    // document).\n    if (options && options.shared) {\n      return markTextShared(doc, from, to, options, type);\n    } // Ensure we are in an operation.\n\n\n    if (doc.cm && !doc.cm.curOp) {\n      return operation(doc.cm, _markText)(doc, from, to, options, type);\n    }\n\n    var marker = new TextMarker(doc, type),\n        diff = cmp(from, to);\n\n    if (options) {\n      copyObj(options, marker, false);\n    } // Don\'t connect empty markers unless clearWhenEmpty is false\n\n\n    if (diff > 0 || diff == 0 && marker.clearWhenEmpty !== false) {\n      return marker;\n    }\n\n    if (marker.replacedWith) {\n      // Showing up as a widget implies collapsed (widget replaces text)\n      marker.collapsed = true;\n      marker.widgetNode = eltP("span", [marker.replacedWith], "CodeMirror-widget");\n\n      if (!options.handleMouseEvents) {\n        marker.widgetNode.setAttribute("cm-ignore-events", "true");\n      }\n\n      if (options.insertLeft) {\n        marker.widgetNode.insertLeft = true;\n      }\n    }\n\n    if (marker.collapsed) {\n      if (conflictingCollapsedRange(doc, from.line, from, to, marker) || from.line != to.line && conflictingCollapsedRange(doc, to.line, from, to, marker)) {\n        throw new Error("Inserting collapsed marker partially overlapping an existing one");\n      }\n\n      seeCollapsedSpans();\n    }\n\n    if (marker.addToHistory) {\n      addChangeToHistory(doc, {\n        from: from,\n        to: to,\n        origin: "markText"\n      }, doc.sel, NaN);\n    }\n\n    var curLine = from.line,\n        cm = doc.cm,\n        updateMaxLine;\n    doc.iter(curLine, to.line + 1, function (line) {\n      if (cm && marker.collapsed && !cm.options.lineWrapping && visualLine(line) == cm.display.maxLine) {\n        updateMaxLine = true;\n      }\n\n      if (marker.collapsed && curLine != from.line) {\n        updateLineHeight(line, 0);\n      }\n\n      addMarkedSpan(line, new MarkedSpan(marker, curLine == from.line ? from.ch : null, curLine == to.line ? to.ch : null));\n      ++curLine;\n    }); // lineIsHidden depends on the presence of the spans, so needs a second pass\n\n    if (marker.collapsed) {\n      doc.iter(from.line, to.line + 1, function (line) {\n        if (lineIsHidden(doc, line)) {\n          updateLineHeight(line, 0);\n        }\n      });\n    }\n\n    if (marker.clearOnEnter) {\n      on(marker, "beforeCursorEnter", function () {\n        return marker.clear();\n      });\n    }\n\n    if (marker.readOnly) {\n      seeReadOnlySpans();\n\n      if (doc.history.done.length || doc.history.undone.length) {\n        doc.clearHistory();\n      }\n    }\n\n    if (marker.collapsed) {\n      marker.id = ++nextMarkerId;\n      marker.atomic = true;\n    }\n\n    if (cm) {\n      // Sync editor state\n      if (updateMaxLine) {\n        cm.curOp.updateMaxLine = true;\n      }\n\n      if (marker.collapsed) {\n        regChange(cm, from.line, to.line + 1);\n      } else if (marker.className || marker.startStyle || marker.endStyle || marker.css || marker.attributes || marker.title) {\n        for (var i = from.line; i <= to.line; i++) {\n          regLineChange(cm, i, "text");\n        }\n      }\n\n      if (marker.atomic) {\n        reCheckSelection(cm.doc);\n      }\n\n      signalLater(cm, "markerAdded", cm, marker);\n    }\n\n    return marker;\n  } // SHARED TEXTMARKERS\n  // A shared marker spans multiple linked documents. It is\n  // implemented as a meta-marker-object controlling multiple normal\n  // markers.\n\n\n  var SharedTextMarker = function SharedTextMarker(markers, primary) {\n    this.markers = markers;\n    this.primary = primary;\n\n    for (var i = 0; i < markers.length; ++i) {\n      markers[i].parent = this;\n    }\n  };\n\n  SharedTextMarker.prototype.clear = function () {\n    if (this.explicitlyCleared) {\n      return;\n    }\n\n    this.explicitlyCleared = true;\n\n    for (var i = 0; i < this.markers.length; ++i) {\n      this.markers[i].clear();\n    }\n\n    signalLater(this, "clear");\n  };\n\n  SharedTextMarker.prototype.find = function (side, lineObj) {\n    return this.primary.find(side, lineObj);\n  };\n\n  eventMixin(SharedTextMarker);\n\n  function markTextShared(doc, from, to, options, type) {\n    options = copyObj(options);\n    options.shared = false;\n    var markers = [_markText(doc, from, to, options, type)],\n        primary = markers[0];\n    var widget = options.widgetNode;\n    linkedDocs(doc, function (doc) {\n      if (widget) {\n        options.widgetNode = widget.cloneNode(true);\n      }\n\n      markers.push(_markText(doc, _clipPos(doc, from), _clipPos(doc, to), options, type));\n\n      for (var i = 0; i < doc.linked.length; ++i) {\n        if (doc.linked[i].isParent) {\n          return;\n        }\n      }\n\n      primary = lst(markers);\n    });\n    return new SharedTextMarker(markers, primary);\n  }\n\n  function findSharedMarkers(doc) {\n    return doc.findMarks(Pos(doc.first, 0), doc.clipPos(Pos(doc.lastLine())), function (m) {\n      return m.parent;\n    });\n  }\n\n  function copySharedMarkers(doc, markers) {\n    for (var i = 0; i < markers.length; i++) {\n      var marker = markers[i],\n          pos = marker.find();\n      var mFrom = doc.clipPos(pos.from),\n          mTo = doc.clipPos(pos.to);\n\n      if (cmp(mFrom, mTo)) {\n        var subMark = _markText(doc, mFrom, mTo, marker.primary, marker.primary.type);\n\n        marker.markers.push(subMark);\n        subMark.parent = marker;\n      }\n    }\n  }\n\n  function detachSharedMarkers(markers) {\n    var loop = function loop(i) {\n      var marker = markers[i],\n          linked = [marker.primary.doc];\n      linkedDocs(marker.primary.doc, function (d) {\n        return linked.push(d);\n      });\n\n      for (var j = 0; j < marker.markers.length; j++) {\n        var subMarker = marker.markers[j];\n\n        if (indexOf(linked, subMarker.doc) == -1) {\n          subMarker.parent = null;\n          marker.markers.splice(j--, 1);\n        }\n      }\n    };\n\n    for (var i = 0; i < markers.length; i++) {\n      loop(i);\n    }\n  }\n\n  var nextDocId = 0;\n\n  var Doc = function Doc(text, mode, firstLine, lineSep, direction) {\n    if (!(this instanceof Doc)) {\n      return new Doc(text, mode, firstLine, lineSep, direction);\n    }\n\n    if (firstLine == null) {\n      firstLine = 0;\n    }\n\n    BranchChunk.call(this, [new LeafChunk([new Line("", null)])]);\n    this.first = firstLine;\n    this.scrollTop = this.scrollLeft = 0;\n    this.cantEdit = false;\n    this.cleanGeneration = 1;\n    this.modeFrontier = this.highlightFrontier = firstLine;\n    var start = Pos(firstLine, 0);\n    this.sel = simpleSelection(start);\n    this.history = new History(null);\n    this.id = ++nextDocId;\n    this.modeOption = mode;\n    this.lineSep = lineSep;\n    this.direction = direction == "rtl" ? "rtl" : "ltr";\n    this.extend = false;\n\n    if (typeof text == "string") {\n      text = this.splitLines(text);\n    }\n\n    updateDoc(this, {\n      from: start,\n      to: start,\n      text: text\n    });\n    setSelection(this, simpleSelection(start), sel_dontScroll);\n  };\n\n  Doc.prototype = createObj(BranchChunk.prototype, {\n    constructor: Doc,\n    // Iterate over the document. Supports two forms -- with only one\n    // argument, it calls that for each line in the document. With\n    // three, it iterates over the range given by the first two (with\n    // the second being non-inclusive).\n    iter: function iter(from, to, op) {\n      if (op) {\n        this.iterN(from - this.first, to - from, op);\n      } else {\n        this.iterN(this.first, this.first + this.size, from);\n      }\n    },\n    // Non-public interface for adding and removing lines.\n    insert: function insert(at, lines) {\n      var height = 0;\n\n      for (var i = 0; i < lines.length; ++i) {\n        height += lines[i].height;\n      }\n\n      this.insertInner(at - this.first, lines, height);\n    },\n    remove: function remove(at, n) {\n      this.removeInner(at - this.first, n);\n    },\n    // From here, the methods are part of the public interface. Most\n    // are also available from CodeMirror (editor) instances.\n    getValue: function getValue(lineSep) {\n      var lines = getLines(this, this.first, this.first + this.size);\n\n      if (lineSep === false) {\n        return lines;\n      }\n\n      return lines.join(lineSep || this.lineSeparator());\n    },\n    setValue: docMethodOp(function (code) {\n      var top = Pos(this.first, 0),\n          last = this.first + this.size - 1;\n      makeChange(this, {\n        from: top,\n        to: Pos(last, getLine(this, last).text.length),\n        text: this.splitLines(code),\n        origin: "setValue",\n        full: true\n      }, true);\n\n      if (this.cm) {\n        scrollToCoords(this.cm, 0, 0);\n      }\n\n      setSelection(this, simpleSelection(top), sel_dontScroll);\n    }),\n    replaceRange: function replaceRange(code, from, to, origin) {\n      from = _clipPos(this, from);\n      to = to ? _clipPos(this, to) : from;\n\n      _replaceRange(this, code, from, to, origin);\n    },\n    getRange: function getRange(from, to, lineSep) {\n      var lines = getBetween(this, _clipPos(this, from), _clipPos(this, to));\n\n      if (lineSep === false) {\n        return lines;\n      }\n\n      return lines.join(lineSep || this.lineSeparator());\n    },\n    getLine: function getLine(line) {\n      var l = this.getLineHandle(line);\n      return l && l.text;\n    },\n    getLineHandle: function getLineHandle(line) {\n      if (isLine(this, line)) {\n        return getLine(this, line);\n      }\n    },\n    getLineNumber: function getLineNumber(line) {\n      return lineNo(line);\n    },\n    getLineHandleVisualStart: function getLineHandleVisualStart(line) {\n      if (typeof line == "number") {\n        line = getLine(this, line);\n      }\n\n      return visualLine(line);\n    },\n    lineCount: function lineCount() {\n      return this.size;\n    },\n    firstLine: function firstLine() {\n      return this.first;\n    },\n    lastLine: function lastLine() {\n      return this.first + this.size - 1;\n    },\n    clipPos: function clipPos(pos) {\n      return _clipPos(this, pos);\n    },\n    getCursor: function getCursor(start) {\n      var range = this.sel.primary(),\n          pos;\n\n      if (start == null || start == "head") {\n        pos = range.head;\n      } else if (start == "anchor") {\n        pos = range.anchor;\n      } else if (start == "end" || start == "to" || start === false) {\n        pos = range.to();\n      } else {\n        pos = range.from();\n      }\n\n      return pos;\n    },\n    listSelections: function listSelections() {\n      return this.sel.ranges;\n    },\n    somethingSelected: function somethingSelected() {\n      return this.sel.somethingSelected();\n    },\n    setCursor: docMethodOp(function (line, ch, options) {\n      setSimpleSelection(this, _clipPos(this, typeof line == "number" ? Pos(line, ch || 0) : line), null, options);\n    }),\n    setSelection: docMethodOp(function (anchor, head, options) {\n      setSimpleSelection(this, _clipPos(this, anchor), _clipPos(this, head || anchor), options);\n    }),\n    extendSelection: docMethodOp(function (head, other, options) {\n      extendSelection(this, _clipPos(this, head), other && _clipPos(this, other), options);\n    }),\n    extendSelections: docMethodOp(function (heads, options) {\n      extendSelections(this, clipPosArray(this, heads), options);\n    }),\n    extendSelectionsBy: docMethodOp(function (f, options) {\n      var heads = map(this.sel.ranges, f);\n      extendSelections(this, clipPosArray(this, heads), options);\n    }),\n    setSelections: docMethodOp(function (ranges, primary, options) {\n      if (!ranges.length) {\n        return;\n      }\n\n      var out = [];\n\n      for (var i = 0; i < ranges.length; i++) {\n        out[i] = new Range(_clipPos(this, ranges[i].anchor), _clipPos(this, ranges[i].head));\n      }\n\n      if (primary == null) {\n        primary = Math.min(ranges.length - 1, this.sel.primIndex);\n      }\n\n      setSelection(this, normalizeSelection(this.cm, out, primary), options);\n    }),\n    addSelection: docMethodOp(function (anchor, head, options) {\n      var ranges = this.sel.ranges.slice(0);\n      ranges.push(new Range(_clipPos(this, anchor), _clipPos(this, head || anchor)));\n      setSelection(this, normalizeSelection(this.cm, ranges, ranges.length - 1), options);\n    }),\n    getSelection: function getSelection(lineSep) {\n      var ranges = this.sel.ranges,\n          lines;\n\n      for (var i = 0; i < ranges.length; i++) {\n        var sel = getBetween(this, ranges[i].from(), ranges[i].to());\n        lines = lines ? lines.concat(sel) : sel;\n      }\n\n      if (lineSep === false) {\n        return lines;\n      } else {\n        return lines.join(lineSep || this.lineSeparator());\n      }\n    },\n    getSelections: function getSelections(lineSep) {\n      var parts = [],\n          ranges = this.sel.ranges;\n\n      for (var i = 0; i < ranges.length; i++) {\n        var sel = getBetween(this, ranges[i].from(), ranges[i].to());\n\n        if (lineSep !== false) {\n          sel = sel.join(lineSep || this.lineSeparator());\n        }\n\n        parts[i] = sel;\n      }\n\n      return parts;\n    },\n    replaceSelection: function replaceSelection(code, collapse, origin) {\n      var dup = [];\n\n      for (var i = 0; i < this.sel.ranges.length; i++) {\n        dup[i] = code;\n      }\n\n      this.replaceSelections(dup, collapse, origin || "+input");\n    },\n    replaceSelections: docMethodOp(function (code, collapse, origin) {\n      var changes = [],\n          sel = this.sel;\n\n      for (var i = 0; i < sel.ranges.length; i++) {\n        var range = sel.ranges[i];\n        changes[i] = {\n          from: range.from(),\n          to: range.to(),\n          text: this.splitLines(code[i]),\n          origin: origin\n        };\n      }\n\n      var newSel = collapse && collapse != "end" && computeReplacedSel(this, changes, collapse);\n\n      for (var i$1 = changes.length - 1; i$1 >= 0; i$1--) {\n        makeChange(this, changes[i$1]);\n      }\n\n      if (newSel) {\n        setSelectionReplaceHistory(this, newSel);\n      } else if (this.cm) {\n        ensureCursorVisible(this.cm);\n      }\n    }),\n    undo: docMethodOp(function () {\n      makeChangeFromHistory(this, "undo");\n    }),\n    redo: docMethodOp(function () {\n      makeChangeFromHistory(this, "redo");\n    }),\n    undoSelection: docMethodOp(function () {\n      makeChangeFromHistory(this, "undo", true);\n    }),\n    redoSelection: docMethodOp(function () {\n      makeChangeFromHistory(this, "redo", true);\n    }),\n    setExtending: function setExtending(val) {\n      this.extend = val;\n    },\n    getExtending: function getExtending() {\n      return this.extend;\n    },\n    historySize: function historySize() {\n      var hist = this.history,\n          done = 0,\n          undone = 0;\n\n      for (var i = 0; i < hist.done.length; i++) {\n        if (!hist.done[i].ranges) {\n          ++done;\n        }\n      }\n\n      for (var i$1 = 0; i$1 < hist.undone.length; i$1++) {\n        if (!hist.undone[i$1].ranges) {\n          ++undone;\n        }\n      }\n\n      return {\n        undo: done,\n        redo: undone\n      };\n    },\n    clearHistory: function clearHistory() {\n      this.history = new History(this.history.maxGeneration);\n    },\n    markClean: function markClean() {\n      this.cleanGeneration = this.changeGeneration(true);\n    },\n    changeGeneration: function changeGeneration(forceSplit) {\n      if (forceSplit) {\n        this.history.lastOp = this.history.lastSelOp = this.history.lastOrigin = null;\n      }\n\n      return this.history.generation;\n    },\n    isClean: function isClean(gen) {\n      return this.history.generation == (gen || this.cleanGeneration);\n    },\n    getHistory: function getHistory() {\n      return {\n        done: copyHistoryArray(this.history.done),\n        undone: copyHistoryArray(this.history.undone)\n      };\n    },\n    setHistory: function setHistory(histData) {\n      var hist = this.history = new History(this.history.maxGeneration);\n      hist.done = copyHistoryArray(histData.done.slice(0), null, true);\n      hist.undone = copyHistoryArray(histData.undone.slice(0), null, true);\n    },\n    setGutterMarker: docMethodOp(function (line, gutterID, value) {\n      return changeLine(this, line, "gutter", function (line) {\n        var markers = line.gutterMarkers || (line.gutterMarkers = {});\n        markers[gutterID] = value;\n\n        if (!value && isEmpty(markers)) {\n          line.gutterMarkers = null;\n        }\n\n        return true;\n      });\n    }),\n    clearGutter: docMethodOp(function (gutterID) {\n      var this$1 = this;\n      this.iter(function (line) {\n        if (line.gutterMarkers && line.gutterMarkers[gutterID]) {\n          changeLine(this$1, line, "gutter", function () {\n            line.gutterMarkers[gutterID] = null;\n\n            if (isEmpty(line.gutterMarkers)) {\n              line.gutterMarkers = null;\n            }\n\n            return true;\n          });\n        }\n      });\n    }),\n    lineInfo: function lineInfo(line) {\n      var n;\n\n      if (typeof line == "number") {\n        if (!isLine(this, line)) {\n          return null;\n        }\n\n        n = line;\n        line = getLine(this, line);\n\n        if (!line) {\n          return null;\n        }\n      } else {\n        n = lineNo(line);\n\n        if (n == null) {\n          return null;\n        }\n      }\n\n      return {\n        line: n,\n        handle: line,\n        text: line.text,\n        gutterMarkers: line.gutterMarkers,\n        textClass: line.textClass,\n        bgClass: line.bgClass,\n        wrapClass: line.wrapClass,\n        widgets: line.widgets\n      };\n    },\n    addLineClass: docMethodOp(function (handle, where, cls) {\n      return changeLine(this, handle, where == "gutter" ? "gutter" : "class", function (line) {\n        var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : where == "gutter" ? "gutterClass" : "wrapClass";\n\n        if (!line[prop]) {\n          line[prop] = cls;\n        } else if (classTest(cls).test(line[prop])) {\n          return false;\n        } else {\n          line[prop] += " " + cls;\n        }\n\n        return true;\n      });\n    }),\n    removeLineClass: docMethodOp(function (handle, where, cls) {\n      return changeLine(this, handle, where == "gutter" ? "gutter" : "class", function (line) {\n        var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : where == "gutter" ? "gutterClass" : "wrapClass";\n        var cur = line[prop];\n\n        if (!cur) {\n          return false;\n        } else if (cls == null) {\n          line[prop] = null;\n        } else {\n          var found = cur.match(classTest(cls));\n\n          if (!found) {\n            return false;\n          }\n\n          var end = found.index + found[0].length;\n          line[prop] = cur.slice(0, found.index) + (!found.index || end == cur.length ? "" : " ") + cur.slice(end) || null;\n        }\n\n        return true;\n      });\n    }),\n    addLineWidget: docMethodOp(function (handle, node, options) {\n      return addLineWidget(this, handle, node, options);\n    }),\n    removeLineWidget: function removeLineWidget(widget) {\n      widget.clear();\n    },\n    markText: function markText(from, to, options) {\n      return _markText(this, _clipPos(this, from), _clipPos(this, to), options, options && options.type || "range");\n    },\n    setBookmark: function setBookmark(pos, options) {\n      var realOpts = {\n        replacedWith: options && (options.nodeType == null ? options.widget : options),\n        insertLeft: options && options.insertLeft,\n        clearWhenEmpty: false,\n        shared: options && options.shared,\n        handleMouseEvents: options && options.handleMouseEvents\n      };\n      pos = _clipPos(this, pos);\n      return _markText(this, pos, pos, realOpts, "bookmark");\n    },\n    findMarksAt: function findMarksAt(pos) {\n      pos = _clipPos(this, pos);\n      var markers = [],\n          spans = getLine(this, pos.line).markedSpans;\n\n      if (spans) {\n        for (var i = 0; i < spans.length; ++i) {\n          var span = spans[i];\n\n          if ((span.from == null || span.from <= pos.ch) && (span.to == null || span.to >= pos.ch)) {\n            markers.push(span.marker.parent || span.marker);\n          }\n        }\n      }\n\n      return markers;\n    },\n    findMarks: function findMarks(from, to, filter) {\n      from = _clipPos(this, from);\n      to = _clipPos(this, to);\n      var found = [],\n          lineNo = from.line;\n      this.iter(from.line, to.line + 1, function (line) {\n        var spans = line.markedSpans;\n\n        if (spans) {\n          for (var i = 0; i < spans.length; i++) {\n            var span = spans[i];\n\n            if (!(span.to != null && lineNo == from.line && from.ch >= span.to || span.from == null && lineNo != from.line || span.from != null && lineNo == to.line && span.from >= to.ch) && (!filter || filter(span.marker))) {\n              found.push(span.marker.parent || span.marker);\n            }\n          }\n        }\n\n        ++lineNo;\n      });\n      return found;\n    },\n    getAllMarks: function getAllMarks() {\n      var markers = [];\n      this.iter(function (line) {\n        var sps = line.markedSpans;\n\n        if (sps) {\n          for (var i = 0; i < sps.length; ++i) {\n            if (sps[i].from != null) {\n              markers.push(sps[i].marker);\n            }\n          }\n        }\n      });\n      return markers;\n    },\n    posFromIndex: function posFromIndex(off) {\n      var ch,\n          lineNo = this.first,\n          sepSize = this.lineSeparator().length;\n      this.iter(function (line) {\n        var sz = line.text.length + sepSize;\n\n        if (sz > off) {\n          ch = off;\n          return true;\n        }\n\n        off -= sz;\n        ++lineNo;\n      });\n      return _clipPos(this, Pos(lineNo, ch));\n    },\n    indexFromPos: function indexFromPos(coords) {\n      coords = _clipPos(this, coords);\n      var index = coords.ch;\n\n      if (coords.line < this.first || coords.ch < 0) {\n        return 0;\n      }\n\n      var sepSize = this.lineSeparator().length;\n      this.iter(this.first, coords.line, function (line) {\n        // iter aborts when callback returns a truthy value\n        index += line.text.length + sepSize;\n      });\n      return index;\n    },\n    copy: function copy(copyHistory) {\n      var doc = new Doc(getLines(this, this.first, this.first + this.size), this.modeOption, this.first, this.lineSep, this.direction);\n      doc.scrollTop = this.scrollTop;\n      doc.scrollLeft = this.scrollLeft;\n      doc.sel = this.sel;\n      doc.extend = false;\n\n      if (copyHistory) {\n        doc.history.undoDepth = this.history.undoDepth;\n        doc.setHistory(this.getHistory());\n      }\n\n      return doc;\n    },\n    linkedDoc: function linkedDoc(options) {\n      if (!options) {\n        options = {};\n      }\n\n      var from = this.first,\n          to = this.first + this.size;\n\n      if (options.from != null && options.from > from) {\n        from = options.from;\n      }\n\n      if (options.to != null && options.to < to) {\n        to = options.to;\n      }\n\n      var copy = new Doc(getLines(this, from, to), options.mode || this.modeOption, from, this.lineSep, this.direction);\n\n      if (options.sharedHist) {\n        copy.history = this.history;\n      }\n\n      (this.linked || (this.linked = [])).push({\n        doc: copy,\n        sharedHist: options.sharedHist\n      });\n      copy.linked = [{\n        doc: this,\n        isParent: true,\n        sharedHist: options.sharedHist\n      }];\n      copySharedMarkers(copy, findSharedMarkers(this));\n      return copy;\n    },\n    unlinkDoc: function unlinkDoc(other) {\n      if (other instanceof CodeMirror) {\n        other = other.doc;\n      }\n\n      if (this.linked) {\n        for (var i = 0; i < this.linked.length; ++i) {\n          var link = this.linked[i];\n\n          if (link.doc != other) {\n            continue;\n          }\n\n          this.linked.splice(i, 1);\n          other.unlinkDoc(this);\n          detachSharedMarkers(findSharedMarkers(this));\n          break;\n        }\n      } // If the histories were shared, split them again\n\n\n      if (other.history == this.history) {\n        var splitIds = [other.id];\n        linkedDocs(other, function (doc) {\n          return splitIds.push(doc.id);\n        }, true);\n        other.history = new History(null);\n        other.history.done = copyHistoryArray(this.history.done, splitIds);\n        other.history.undone = copyHistoryArray(this.history.undone, splitIds);\n      }\n    },\n    iterLinkedDocs: function iterLinkedDocs(f) {\n      linkedDocs(this, f);\n    },\n    getMode: function getMode() {\n      return this.mode;\n    },\n    getEditor: function getEditor() {\n      return this.cm;\n    },\n    splitLines: function splitLines(str) {\n      if (this.lineSep) {\n        return str.split(this.lineSep);\n      }\n\n      return splitLinesAuto(str);\n    },\n    lineSeparator: function lineSeparator() {\n      return this.lineSep || "\\n";\n    },\n    setDirection: docMethodOp(function (dir) {\n      if (dir != "rtl") {\n        dir = "ltr";\n      }\n\n      if (dir == this.direction) {\n        return;\n      }\n\n      this.direction = dir;\n      this.iter(function (line) {\n        return line.order = null;\n      });\n\n      if (this.cm) {\n        directionChanged(this.cm);\n      }\n    })\n  }); // Public alias.\n\n  Doc.prototype.eachLine = Doc.prototype.iter; // Kludge to work around strange IE behavior where it\'ll sometimes\n  // re-fire a series of drag-related events right after the drop (#1551)\n\n  var lastDrop = 0;\n\n  function onDrop(e) {\n    var cm = this;\n    clearDragCursor(cm);\n\n    if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) {\n      return;\n    }\n\n    e_preventDefault(e);\n\n    if (ie) {\n      lastDrop = +new Date();\n    }\n\n    var pos = posFromMouse(cm, e, true),\n        files = e.dataTransfer.files;\n\n    if (!pos || cm.isReadOnly()) {\n      return;\n    } // Might be a file drop, in which case we simply extract the text\n    // and insert it.\n\n\n    if (files && files.length && window.FileReader && window.File) {\n      var n = files.length,\n          text = Array(n),\n          read = 0;\n\n      var loadFile = function loadFile(file, i) {\n        if (cm.options.allowDropFileTypes && indexOf(cm.options.allowDropFileTypes, file.type) == -1) {\n          return;\n        }\n\n        var reader = new FileReader();\n        reader.onload = operation(cm, function () {\n          var content = reader.result;\n\n          if (/[\\x00-\\x08\\x0e-\\x1f]{2}/.test(content)) {\n            content = "";\n          }\n\n          text[i] = content;\n\n          if (++read == n) {\n            pos = _clipPos(cm.doc, pos);\n            var change = {\n              from: pos,\n              to: pos,\n              text: cm.doc.splitLines(text.join(cm.doc.lineSeparator())),\n              origin: "paste"\n            };\n            makeChange(cm.doc, change);\n            setSelectionReplaceHistory(cm.doc, simpleSelection(pos, changeEnd(change)));\n          }\n        });\n        reader.readAsText(file);\n      };\n\n      for (var i = 0; i < n; ++i) {\n        loadFile(files[i], i);\n      }\n    } else {\n      // Normal drop\n      // Don\'t do a replace if the drop happened inside of the selected text.\n      if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {\n        cm.state.draggingText(e); // Ensure the editor is re-focused\n\n        setTimeout(function () {\n          return cm.display.input.focus();\n        }, 20);\n        return;\n      }\n\n      try {\n        var text$1 = e.dataTransfer.getData("Text");\n\n        if (text$1) {\n          var selected;\n\n          if (cm.state.draggingText && !cm.state.draggingText.copy) {\n            selected = cm.listSelections();\n          }\n\n          setSelectionNoUndo(cm.doc, simpleSelection(pos, pos));\n\n          if (selected) {\n            for (var i$1 = 0; i$1 < selected.length; ++i$1) {\n              _replaceRange(cm.doc, "", selected[i$1].anchor, selected[i$1].head, "drag");\n            }\n          }\n\n          cm.replaceSelection(text$1, "around", "paste");\n          cm.display.input.focus();\n        }\n      } catch (e) {}\n    }\n  }\n\n  function onDragStart(cm, e) {\n    if (ie && (!cm.state.draggingText || +new Date() - lastDrop < 100)) {\n      e_stop(e);\n      return;\n    }\n\n    if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) {\n      return;\n    }\n\n    e.dataTransfer.setData("Text", cm.getSelection());\n    e.dataTransfer.effectAllowed = "copyMove"; // Use dummy image instead of default browsers image.\n    // Recent Safari (~6.0.2) have a tendency to segfault when this happens, so we don\'t do it there.\n\n    if (e.dataTransfer.setDragImage && !safari) {\n      var img = elt("img", null, null, "position: fixed; left: 0; top: 0;");\n      img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";\n\n      if (presto) {\n        img.width = img.height = 1;\n        cm.display.wrapper.appendChild(img); // Force a relayout, or Opera won\'t use our image for some obscure reason\n\n        img._top = img.offsetTop;\n      }\n\n      e.dataTransfer.setDragImage(img, 0, 0);\n\n      if (presto) {\n        img.parentNode.removeChild(img);\n      }\n    }\n  }\n\n  function onDragOver(cm, e) {\n    var pos = posFromMouse(cm, e);\n\n    if (!pos) {\n      return;\n    }\n\n    var frag = document.createDocumentFragment();\n    drawSelectionCursor(cm, pos, frag);\n\n    if (!cm.display.dragCursor) {\n      cm.display.dragCursor = elt("div", null, "CodeMirror-cursors CodeMirror-dragcursors");\n      cm.display.lineSpace.insertBefore(cm.display.dragCursor, cm.display.cursorDiv);\n    }\n\n    removeChildrenAndAdd(cm.display.dragCursor, frag);\n  }\n\n  function clearDragCursor(cm) {\n    if (cm.display.dragCursor) {\n      cm.display.lineSpace.removeChild(cm.display.dragCursor);\n      cm.display.dragCursor = null;\n    }\n  } // These must be handled carefully, because naively registering a\n  // handler for each editor will cause the editors to never be\n  // garbage collected.\n\n\n  function forEachCodeMirror(f) {\n    if (!document.getElementsByClassName) {\n      return;\n    }\n\n    var byClass = document.getElementsByClassName("CodeMirror"),\n        editors = [];\n\n    for (var i = 0; i < byClass.length; i++) {\n      var cm = byClass[i].CodeMirror;\n\n      if (cm) {\n        editors.push(cm);\n      }\n    }\n\n    if (editors.length) {\n      editors[0].operation(function () {\n        for (var i = 0; i < editors.length; i++) {\n          f(editors[i]);\n        }\n      });\n    }\n  }\n\n  var globalsRegistered = false;\n\n  function ensureGlobalHandlers() {\n    if (globalsRegistered) {\n      return;\n    }\n\n    registerGlobalHandlers();\n    globalsRegistered = true;\n  }\n\n  function registerGlobalHandlers() {\n    // When the window resizes, we need to refresh active editors.\n    var resizeTimer;\n    on(window, "resize", function () {\n      if (resizeTimer == null) {\n        resizeTimer = setTimeout(function () {\n          resizeTimer = null;\n          forEachCodeMirror(onResize);\n        }, 100);\n      }\n    }); // When the window loses focus, we want to show the editor as blurred\n\n    on(window, "blur", function () {\n      return forEachCodeMirror(onBlur);\n    });\n  } // Called when the window resizes\n\n\n  function onResize(cm) {\n    var d = cm.display; // Might be a text scaling operation, clear size caches.\n\n    d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null;\n    d.scrollbarsClipped = false;\n    cm.setSize();\n  }\n\n  var keyNames = {\n    3: "Pause",\n    8: "Backspace",\n    9: "Tab",\n    13: "Enter",\n    16: "Shift",\n    17: "Ctrl",\n    18: "Alt",\n    19: "Pause",\n    20: "CapsLock",\n    27: "Esc",\n    32: "Space",\n    33: "PageUp",\n    34: "PageDown",\n    35: "End",\n    36: "Home",\n    37: "Left",\n    38: "Up",\n    39: "Right",\n    40: "Down",\n    44: "PrintScrn",\n    45: "Insert",\n    46: "Delete",\n    59: ";",\n    61: "=",\n    91: "Mod",\n    92: "Mod",\n    93: "Mod",\n    106: "*",\n    107: "=",\n    109: "-",\n    110: ".",\n    111: "/",\n    145: "ScrollLock",\n    173: "-",\n    186: ";",\n    187: "=",\n    188: ",",\n    189: "-",\n    190: ".",\n    191: "/",\n    192: "`",\n    219: "[",\n    220: "\\\\",\n    221: "]",\n    222: "\'",\n    63232: "Up",\n    63233: "Down",\n    63234: "Left",\n    63235: "Right",\n    63272: "Delete",\n    63273: "Home",\n    63275: "End",\n    63276: "PageUp",\n    63277: "PageDown",\n    63302: "Insert"\n  }; // Number keys\n\n  for (var i = 0; i < 10; i++) {\n    keyNames[i + 48] = keyNames[i + 96] = String(i);\n  } // Alphabetic keys\n\n\n  for (var i$1 = 65; i$1 <= 90; i$1++) {\n    keyNames[i$1] = String.fromCharCode(i$1);\n  } // Function keys\n\n\n  for (var i$2 = 1; i$2 <= 12; i$2++) {\n    keyNames[i$2 + 111] = keyNames[i$2 + 63235] = "F" + i$2;\n  }\n\n  var keyMap = {};\n  keyMap.basic = {\n    "Left": "goCharLeft",\n    "Right": "goCharRight",\n    "Up": "goLineUp",\n    "Down": "goLineDown",\n    "End": "goLineEnd",\n    "Home": "goLineStartSmart",\n    "PageUp": "goPageUp",\n    "PageDown": "goPageDown",\n    "Delete": "delCharAfter",\n    "Backspace": "delCharBefore",\n    "Shift-Backspace": "delCharBefore",\n    "Tab": "defaultTab",\n    "Shift-Tab": "indentAuto",\n    "Enter": "newlineAndIndent",\n    "Insert": "toggleOverwrite",\n    "Esc": "singleSelection"\n  }; // Note that the save and find-related commands aren\'t defined by\n  // default. User code or addons can define them. Unknown commands\n  // are simply ignored.\n\n  keyMap.pcDefault = {\n    "Ctrl-A": "selectAll",\n    "Ctrl-D": "deleteLine",\n    "Ctrl-Z": "undo",\n    "Shift-Ctrl-Z": "redo",\n    "Ctrl-Y": "redo",\n    "Ctrl-Home": "goDocStart",\n    "Ctrl-End": "goDocEnd",\n    "Ctrl-Up": "goLineUp",\n    "Ctrl-Down": "goLineDown",\n    "Ctrl-Left": "goGroupLeft",\n    "Ctrl-Right": "goGroupRight",\n    "Alt-Left": "goLineStart",\n    "Alt-Right": "goLineEnd",\n    "Ctrl-Backspace": "delGroupBefore",\n    "Ctrl-Delete": "delGroupAfter",\n    "Ctrl-S": "save",\n    "Ctrl-F": "find",\n    "Ctrl-G": "findNext",\n    "Shift-Ctrl-G": "findPrev",\n    "Shift-Ctrl-F": "replace",\n    "Shift-Ctrl-R": "replaceAll",\n    "Ctrl-[": "indentLess",\n    "Ctrl-]": "indentMore",\n    "Ctrl-U": "undoSelection",\n    "Shift-Ctrl-U": "redoSelection",\n    "Alt-U": "redoSelection",\n    "fallthrough": "basic"\n  }; // Very basic readline/emacs-style bindings, which are standard on Mac.\n\n  keyMap.emacsy = {\n    "Ctrl-F": "goCharRight",\n    "Ctrl-B": "goCharLeft",\n    "Ctrl-P": "goLineUp",\n    "Ctrl-N": "goLineDown",\n    "Alt-F": "goWordRight",\n    "Alt-B": "goWordLeft",\n    "Ctrl-A": "goLineStart",\n    "Ctrl-E": "goLineEnd",\n    "Ctrl-V": "goPageDown",\n    "Shift-Ctrl-V": "goPageUp",\n    "Ctrl-D": "delCharAfter",\n    "Ctrl-H": "delCharBefore",\n    "Alt-D": "delWordAfter",\n    "Alt-Backspace": "delWordBefore",\n    "Ctrl-K": "killLine",\n    "Ctrl-T": "transposeChars",\n    "Ctrl-O": "openLine"\n  };\n  keyMap.macDefault = {\n    "Cmd-A": "selectAll",\n    "Cmd-D": "deleteLine",\n    "Cmd-Z": "undo",\n    "Shift-Cmd-Z": "redo",\n    "Cmd-Y": "redo",\n    "Cmd-Home": "goDocStart",\n    "Cmd-Up": "goDocStart",\n    "Cmd-End": "goDocEnd",\n    "Cmd-Down": "goDocEnd",\n    "Alt-Left": "goGroupLeft",\n    "Alt-Right": "goGroupRight",\n    "Cmd-Left": "goLineLeft",\n    "Cmd-Right": "goLineRight",\n    "Alt-Backspace": "delGroupBefore",\n    "Ctrl-Alt-Backspace": "delGroupAfter",\n    "Alt-Delete": "delGroupAfter",\n    "Cmd-S": "save",\n    "Cmd-F": "find",\n    "Cmd-G": "findNext",\n    "Shift-Cmd-G": "findPrev",\n    "Cmd-Alt-F": "replace",\n    "Shift-Cmd-Alt-F": "replaceAll",\n    "Cmd-[": "indentLess",\n    "Cmd-]": "indentMore",\n    "Cmd-Backspace": "delWrappedLineLeft",\n    "Cmd-Delete": "delWrappedLineRight",\n    "Cmd-U": "undoSelection",\n    "Shift-Cmd-U": "redoSelection",\n    "Ctrl-Up": "goDocStart",\n    "Ctrl-Down": "goDocEnd",\n    "fallthrough": ["basic", "emacsy"]\n  };\n  keyMap["default"] = mac ? keyMap.macDefault : keyMap.pcDefault; // KEYMAP DISPATCH\n\n  function normalizeKeyName(name) {\n    var parts = name.split(/-(?!$)/);\n    name = parts[parts.length - 1];\n    var alt, ctrl, shift, cmd;\n\n    for (var i = 0; i < parts.length - 1; i++) {\n      var mod = parts[i];\n\n      if (/^(cmd|meta|m)$/i.test(mod)) {\n        cmd = true;\n      } else if (/^a(lt)?$/i.test(mod)) {\n        alt = true;\n      } else if (/^(c|ctrl|control)$/i.test(mod)) {\n        ctrl = true;\n      } else if (/^s(hift)?$/i.test(mod)) {\n        shift = true;\n      } else {\n        throw new Error("Unrecognized modifier name: " + mod);\n      }\n    }\n\n    if (alt) {\n      name = "Alt-" + name;\n    }\n\n    if (ctrl) {\n      name = "Ctrl-" + name;\n    }\n\n    if (cmd) {\n      name = "Cmd-" + name;\n    }\n\n    if (shift) {\n      name = "Shift-" + name;\n    }\n\n    return name;\n  } // This is a kludge to keep keymaps mostly working as raw objects\n  // (backwards compatibility) while at the same time support features\n  // like normalization and multi-stroke key bindings. It compiles a\n  // new normalized keymap, and then updates the old object to reflect\n  // this.\n\n\n  function normalizeKeyMap(keymap) {\n    var copy = {};\n\n    for (var keyname in keymap) {\n      if (keymap.hasOwnProperty(keyname)) {\n        var value = keymap[keyname];\n\n        if (/^(name|fallthrough|(de|at)tach)$/.test(keyname)) {\n          continue;\n        }\n\n        if (value == "...") {\n          delete keymap[keyname];\n          continue;\n        }\n\n        var keys = map(keyname.split(" "), normalizeKeyName);\n\n        for (var i = 0; i < keys.length; i++) {\n          var val = void 0,\n              name = void 0;\n\n          if (i == keys.length - 1) {\n            name = keys.join(" ");\n            val = value;\n          } else {\n            name = keys.slice(0, i + 1).join(" ");\n            val = "...";\n          }\n\n          var prev = copy[name];\n\n          if (!prev) {\n            copy[name] = val;\n          } else if (prev != val) {\n            throw new Error("Inconsistent bindings for " + name);\n          }\n        }\n\n        delete keymap[keyname];\n      }\n    }\n\n    for (var prop in copy) {\n      keymap[prop] = copy[prop];\n    }\n\n    return keymap;\n  }\n\n  function lookupKey(key, map, handle, context) {\n    map = getKeyMap(map);\n    var found = map.call ? map.call(key, context) : map[key];\n\n    if (found === false) {\n      return "nothing";\n    }\n\n    if (found === "...") {\n      return "multi";\n    }\n\n    if (found != null && handle(found)) {\n      return "handled";\n    }\n\n    if (map.fallthrough) {\n      if (Object.prototype.toString.call(map.fallthrough) != "[object Array]") {\n        return lookupKey(key, map.fallthrough, handle, context);\n      }\n\n      for (var i = 0; i < map.fallthrough.length; i++) {\n        var result = lookupKey(key, map.fallthrough[i], handle, context);\n\n        if (result) {\n          return result;\n        }\n      }\n    }\n  } // Modifier key presses don\'t count as \'real\' key presses for the\n  // purpose of keymap fallthrough.\n\n\n  function isModifierKey(value) {\n    var name = typeof value == "string" ? value : keyNames[value.keyCode];\n    return name == "Ctrl" || name == "Alt" || name == "Shift" || name == "Mod";\n  }\n\n  function addModifierNames(name, event, noShift) {\n    var base = name;\n\n    if (event.altKey && base != "Alt") {\n      name = "Alt-" + name;\n    }\n\n    if ((flipCtrlCmd ? event.metaKey : event.ctrlKey) && base != "Ctrl") {\n      name = "Ctrl-" + name;\n    }\n\n    if ((flipCtrlCmd ? event.ctrlKey : event.metaKey) && base != "Cmd") {\n      name = "Cmd-" + name;\n    }\n\n    if (!noShift && event.shiftKey && base != "Shift") {\n      name = "Shift-" + name;\n    }\n\n    return name;\n  } // Look up the name of a key as indicated by an event object.\n\n\n  function keyName(event, noShift) {\n    if (presto && event.keyCode == 34 && event["char"]) {\n      return false;\n    }\n\n    var name = keyNames[event.keyCode];\n\n    if (name == null || event.altGraphKey) {\n      return false;\n    } // Ctrl-ScrollLock has keyCode 3, same as Ctrl-Pause,\n    // so we\'ll use event.code when available (Chrome 48+, FF 38+, Safari 10.1+)\n\n\n    if (event.keyCode == 3 && event.code) {\n      name = event.code;\n    }\n\n    return addModifierNames(name, event, noShift);\n  }\n\n  function getKeyMap(val) {\n    return typeof val == "string" ? keyMap[val] : val;\n  } // Helper for deleting text near the selection(s), used to implement\n  // backspace, delete, and similar functionality.\n\n\n  function deleteNearSelection(cm, compute) {\n    var ranges = cm.doc.sel.ranges,\n        kill = []; // Build up a set of ranges to kill first, merging overlapping\n    // ranges.\n\n    for (var i = 0; i < ranges.length; i++) {\n      var toKill = compute(ranges[i]);\n\n      while (kill.length && cmp(toKill.from, lst(kill).to) <= 0) {\n        var replaced = kill.pop();\n\n        if (cmp(replaced.from, toKill.from) < 0) {\n          toKill.from = replaced.from;\n          break;\n        }\n      }\n\n      kill.push(toKill);\n    } // Next, remove those actual ranges.\n\n\n    runInOp(cm, function () {\n      for (var i = kill.length - 1; i >= 0; i--) {\n        _replaceRange(cm.doc, "", kill[i].from, kill[i].to, "+delete");\n      }\n\n      ensureCursorVisible(cm);\n    });\n  }\n\n  function moveCharLogically(line, ch, dir) {\n    var target = skipExtendingChars(line.text, ch + dir, dir);\n    return target < 0 || target > line.text.length ? null : target;\n  }\n\n  function moveLogically(line, start, dir) {\n    var ch = moveCharLogically(line, start.ch, dir);\n    return ch == null ? null : new Pos(start.line, ch, dir < 0 ? "after" : "before");\n  }\n\n  function endOfLine(visually, cm, lineObj, lineNo, dir) {\n    if (visually) {\n      var order = getOrder(lineObj, cm.doc.direction);\n\n      if (order) {\n        var part = dir < 0 ? lst(order) : order[0];\n        var moveInStorageOrder = dir < 0 == (part.level == 1);\n        var sticky = moveInStorageOrder ? "after" : "before";\n        var ch; // With a wrapped rtl chunk (possibly spanning multiple bidi parts),\n        // it could be that the last bidi part is not on the last visual line,\n        // since visual lines contain content order-consecutive chunks.\n        // Thus, in rtl, we are looking for the first (content-order) character\n        // in the rtl chunk that is on the last line (that is, the same line\n        // as the last (content-order) character).\n\n        if (part.level > 0 || cm.doc.direction == "rtl") {\n          var prep = prepareMeasureForLine(cm, lineObj);\n          ch = dir < 0 ? lineObj.text.length - 1 : 0;\n          var targetTop = measureCharPrepared(cm, prep, ch).top;\n          ch = findFirst(function (ch) {\n            return measureCharPrepared(cm, prep, ch).top == targetTop;\n          }, dir < 0 == (part.level == 1) ? part.from : part.to - 1, ch);\n\n          if (sticky == "before") {\n            ch = moveCharLogically(lineObj, ch, 1);\n          }\n        } else {\n          ch = dir < 0 ? part.to : part.from;\n        }\n\n        return new Pos(lineNo, ch, sticky);\n      }\n    }\n\n    return new Pos(lineNo, dir < 0 ? lineObj.text.length : 0, dir < 0 ? "before" : "after");\n  }\n\n  function moveVisually(cm, line, start, dir) {\n    var bidi = getOrder(line, cm.doc.direction);\n\n    if (!bidi) {\n      return moveLogically(line, start, dir);\n    }\n\n    if (start.ch >= line.text.length) {\n      start.ch = line.text.length;\n      start.sticky = "before";\n    } else if (start.ch <= 0) {\n      start.ch = 0;\n      start.sticky = "after";\n    }\n\n    var partPos = getBidiPartAt(bidi, start.ch, start.sticky),\n        part = bidi[partPos];\n\n    if (cm.doc.direction == "ltr" && part.level % 2 == 0 && (dir > 0 ? part.to > start.ch : part.from < start.ch)) {\n      // Case 1: We move within an ltr part in an ltr editor. Even with wrapped lines,\n      // nothing interesting happens.\n      return moveLogically(line, start, dir);\n    }\n\n    var mv = function mv(pos, dir) {\n      return moveCharLogically(line, pos instanceof Pos ? pos.ch : pos, dir);\n    };\n\n    var prep;\n\n    var getWrappedLineExtent = function getWrappedLineExtent(ch) {\n      if (!cm.options.lineWrapping) {\n        return {\n          begin: 0,\n          end: line.text.length\n        };\n      }\n\n      prep = prep || prepareMeasureForLine(cm, line);\n      return wrappedLineExtentChar(cm, line, prep, ch);\n    };\n\n    var wrappedLineExtent = getWrappedLineExtent(start.sticky == "before" ? mv(start, -1) : start.ch);\n\n    if (cm.doc.direction == "rtl" || part.level == 1) {\n      var moveInStorageOrder = part.level == 1 == dir < 0;\n      var ch = mv(start, moveInStorageOrder ? 1 : -1);\n\n      if (ch != null && (!moveInStorageOrder ? ch >= part.from && ch >= wrappedLineExtent.begin : ch <= part.to && ch <= wrappedLineExtent.end)) {\n        // Case 2: We move within an rtl part or in an rtl editor on the same visual line\n        var sticky = moveInStorageOrder ? "before" : "after";\n        return new Pos(start.line, ch, sticky);\n      }\n    } // Case 3: Could not move within this bidi part in this visual line, so leave\n    // the current bidi part\n\n\n    var searchInVisualLine = function searchInVisualLine(partPos, dir, wrappedLineExtent) {\n      var getRes = function getRes(ch, moveInStorageOrder) {\n        return moveInStorageOrder ? new Pos(start.line, mv(ch, 1), "before") : new Pos(start.line, ch, "after");\n      };\n\n      for (; partPos >= 0 && partPos < bidi.length; partPos += dir) {\n        var part = bidi[partPos];\n        var moveInStorageOrder = dir > 0 == (part.level != 1);\n        var ch = moveInStorageOrder ? wrappedLineExtent.begin : mv(wrappedLineExtent.end, -1);\n\n        if (part.from <= ch && ch < part.to) {\n          return getRes(ch, moveInStorageOrder);\n        }\n\n        ch = moveInStorageOrder ? part.from : mv(part.to, -1);\n\n        if (wrappedLineExtent.begin <= ch && ch < wrappedLineExtent.end) {\n          return getRes(ch, moveInStorageOrder);\n        }\n      }\n    }; // Case 3a: Look for other bidi parts on the same visual line\n\n\n    var res = searchInVisualLine(partPos + dir, dir, wrappedLineExtent);\n\n    if (res) {\n      return res;\n    } // Case 3b: Look for other bidi parts on the next visual line\n\n\n    var nextCh = dir > 0 ? wrappedLineExtent.end : mv(wrappedLineExtent.begin, -1);\n\n    if (nextCh != null && !(dir > 0 && nextCh == line.text.length)) {\n      res = searchInVisualLine(dir > 0 ? 0 : bidi.length - 1, dir, getWrappedLineExtent(nextCh));\n\n      if (res) {\n        return res;\n      }\n    } // Case 4: Nowhere to move\n\n\n    return null;\n  } // Commands are parameter-less actions that can be performed on an\n  // editor, mostly used for keybindings.\n\n\n  var commands = {\n    selectAll: selectAll,\n    singleSelection: function singleSelection(cm) {\n      return cm.setSelection(cm.getCursor("anchor"), cm.getCursor("head"), sel_dontScroll);\n    },\n    killLine: function killLine(cm) {\n      return deleteNearSelection(cm, function (range) {\n        if (range.empty()) {\n          var len = getLine(cm.doc, range.head.line).text.length;\n\n          if (range.head.ch == len && range.head.line < cm.lastLine()) {\n            return {\n              from: range.head,\n              to: Pos(range.head.line + 1, 0)\n            };\n          } else {\n            return {\n              from: range.head,\n              to: Pos(range.head.line, len)\n            };\n          }\n        } else {\n          return {\n            from: range.from(),\n            to: range.to()\n          };\n        }\n      });\n    },\n    deleteLine: function deleteLine(cm) {\n      return deleteNearSelection(cm, function (range) {\n        return {\n          from: Pos(range.from().line, 0),\n          to: _clipPos(cm.doc, Pos(range.to().line + 1, 0))\n        };\n      });\n    },\n    delLineLeft: function delLineLeft(cm) {\n      return deleteNearSelection(cm, function (range) {\n        return {\n          from: Pos(range.from().line, 0),\n          to: range.from()\n        };\n      });\n    },\n    delWrappedLineLeft: function delWrappedLineLeft(cm) {\n      return deleteNearSelection(cm, function (range) {\n        var top = cm.charCoords(range.head, "div").top + 5;\n        var leftPos = cm.coordsChar({\n          left: 0,\n          top: top\n        }, "div");\n        return {\n          from: leftPos,\n          to: range.from()\n        };\n      });\n    },\n    delWrappedLineRight: function delWrappedLineRight(cm) {\n      return deleteNearSelection(cm, function (range) {\n        var top = cm.charCoords(range.head, "div").top + 5;\n        var rightPos = cm.coordsChar({\n          left: cm.display.lineDiv.offsetWidth + 100,\n          top: top\n        }, "div");\n        return {\n          from: range.from(),\n          to: rightPos\n        };\n      });\n    },\n    undo: function undo(cm) {\n      return cm.undo();\n    },\n    redo: function redo(cm) {\n      return cm.redo();\n    },\n    undoSelection: function undoSelection(cm) {\n      return cm.undoSelection();\n    },\n    redoSelection: function redoSelection(cm) {\n      return cm.redoSelection();\n    },\n    goDocStart: function goDocStart(cm) {\n      return cm.extendSelection(Pos(cm.firstLine(), 0));\n    },\n    goDocEnd: function goDocEnd(cm) {\n      return cm.extendSelection(Pos(cm.lastLine()));\n    },\n    goLineStart: function goLineStart(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        return lineStart(cm, range.head.line);\n      }, {\n        origin: "+move",\n        bias: 1\n      });\n    },\n    goLineStartSmart: function goLineStartSmart(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        return lineStartSmart(cm, range.head);\n      }, {\n        origin: "+move",\n        bias: 1\n      });\n    },\n    goLineEnd: function goLineEnd(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        return lineEnd(cm, range.head.line);\n      }, {\n        origin: "+move",\n        bias: -1\n      });\n    },\n    goLineRight: function goLineRight(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        var top = cm.cursorCoords(range.head, "div").top + 5;\n        return cm.coordsChar({\n          left: cm.display.lineDiv.offsetWidth + 100,\n          top: top\n        }, "div");\n      }, sel_move);\n    },\n    goLineLeft: function goLineLeft(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        var top = cm.cursorCoords(range.head, "div").top + 5;\n        return cm.coordsChar({\n          left: 0,\n          top: top\n        }, "div");\n      }, sel_move);\n    },\n    goLineLeftSmart: function goLineLeftSmart(cm) {\n      return cm.extendSelectionsBy(function (range) {\n        var top = cm.cursorCoords(range.head, "div").top + 5;\n        var pos = cm.coordsChar({\n          left: 0,\n          top: top\n        }, "div");\n\n        if (pos.ch < cm.getLine(pos.line).search(/\\S/)) {\n          return lineStartSmart(cm, range.head);\n        }\n\n        return pos;\n      }, sel_move);\n    },\n    goLineUp: function goLineUp(cm) {\n      return cm.moveV(-1, "line");\n    },\n    goLineDown: function goLineDown(cm) {\n      return cm.moveV(1, "line");\n    },\n    goPageUp: function goPageUp(cm) {\n      return cm.moveV(-1, "page");\n    },\n    goPageDown: function goPageDown(cm) {\n      return cm.moveV(1, "page");\n    },\n    goCharLeft: function goCharLeft(cm) {\n      return cm.moveH(-1, "char");\n    },\n    goCharRight: function goCharRight(cm) {\n      return cm.moveH(1, "char");\n    },\n    goColumnLeft: function goColumnLeft(cm) {\n      return cm.moveH(-1, "column");\n    },\n    goColumnRight: function goColumnRight(cm) {\n      return cm.moveH(1, "column");\n    },\n    goWordLeft: function goWordLeft(cm) {\n      return cm.moveH(-1, "word");\n    },\n    goGroupRight: function goGroupRight(cm) {\n      return cm.moveH(1, "group");\n    },\n    goGroupLeft: function goGroupLeft(cm) {\n      return cm.moveH(-1, "group");\n    },\n    goWordRight: function goWordRight(cm) {\n      return cm.moveH(1, "word");\n    },\n    delCharBefore: function delCharBefore(cm) {\n      return cm.deleteH(-1, "char");\n    },\n    delCharAfter: function delCharAfter(cm) {\n      return cm.deleteH(1, "char");\n    },\n    delWordBefore: function delWordBefore(cm) {\n      return cm.deleteH(-1, "word");\n    },\n    delWordAfter: function delWordAfter(cm) {\n      return cm.deleteH(1, "word");\n    },\n    delGroupBefore: function delGroupBefore(cm) {\n      return cm.deleteH(-1, "group");\n    },\n    delGroupAfter: function delGroupAfter(cm) {\n      return cm.deleteH(1, "group");\n    },\n    indentAuto: function indentAuto(cm) {\n      return cm.indentSelection("smart");\n    },\n    indentMore: function indentMore(cm) {\n      return cm.indentSelection("add");\n    },\n    indentLess: function indentLess(cm) {\n      return cm.indentSelection("subtract");\n    },\n    insertTab: function insertTab(cm) {\n      return cm.replaceSelection("\\t");\n    },\n    insertSoftTab: function insertSoftTab(cm) {\n      var spaces = [],\n          ranges = cm.listSelections(),\n          tabSize = cm.options.tabSize;\n\n      for (var i = 0; i < ranges.length; i++) {\n        var pos = ranges[i].from();\n        var col = countColumn(cm.getLine(pos.line), pos.ch, tabSize);\n        spaces.push(spaceStr(tabSize - col % tabSize));\n      }\n\n      cm.replaceSelections(spaces);\n    },\n    defaultTab: function defaultTab(cm) {\n      if (cm.somethingSelected()) {\n        cm.indentSelection("add");\n      } else {\n        cm.execCommand("insertTab");\n      }\n    },\n    // Swap the two chars left and right of each selection\'s head.\n    // Move cursor behind the two swapped characters afterwards.\n    //\n    // Doesn\'t consider line feeds a character.\n    // Doesn\'t scan more than one line above to find a character.\n    // Doesn\'t do anything on an empty line.\n    // Doesn\'t do anything with non-empty selections.\n    transposeChars: function transposeChars(cm) {\n      return runInOp(cm, function () {\n        var ranges = cm.listSelections(),\n            newSel = [];\n\n        for (var i = 0; i < ranges.length; i++) {\n          if (!ranges[i].empty()) {\n            continue;\n          }\n\n          var cur = ranges[i].head,\n              line = getLine(cm.doc, cur.line).text;\n\n          if (line) {\n            if (cur.ch == line.length) {\n              cur = new Pos(cur.line, cur.ch - 1);\n            }\n\n            if (cur.ch > 0) {\n              cur = new Pos(cur.line, cur.ch + 1);\n              cm.replaceRange(line.charAt(cur.ch - 1) + line.charAt(cur.ch - 2), Pos(cur.line, cur.ch - 2), cur, "+transpose");\n            } else if (cur.line > cm.doc.first) {\n              var prev = getLine(cm.doc, cur.line - 1).text;\n\n              if (prev) {\n                cur = new Pos(cur.line, 1);\n                cm.replaceRange(line.charAt(0) + cm.doc.lineSeparator() + prev.charAt(prev.length - 1), Pos(cur.line - 1, prev.length - 1), cur, "+transpose");\n              }\n            }\n          }\n\n          newSel.push(new Range(cur, cur));\n        }\n\n        cm.setSelections(newSel);\n      });\n    },\n    newlineAndIndent: function newlineAndIndent(cm) {\n      return runInOp(cm, function () {\n        var sels = cm.listSelections();\n\n        for (var i = sels.length - 1; i >= 0; i--) {\n          cm.replaceRange(cm.doc.lineSeparator(), sels[i].anchor, sels[i].head, "+input");\n        }\n\n        sels = cm.listSelections();\n\n        for (var i$1 = 0; i$1 < sels.length; i$1++) {\n          cm.indentLine(sels[i$1].from().line, null, true);\n        }\n\n        ensureCursorVisible(cm);\n      });\n    },\n    openLine: function openLine(cm) {\n      return cm.replaceSelection("\\n", "start");\n    },\n    toggleOverwrite: function toggleOverwrite(cm) {\n      return cm.toggleOverwrite();\n    }\n  };\n\n  function lineStart(cm, lineN) {\n    var line = getLine(cm.doc, lineN);\n    var visual = visualLine(line);\n\n    if (visual != line) {\n      lineN = lineNo(visual);\n    }\n\n    return endOfLine(true, cm, visual, lineN, 1);\n  }\n\n  function lineEnd(cm, lineN) {\n    var line = getLine(cm.doc, lineN);\n    var visual = visualLineEnd(line);\n\n    if (visual != line) {\n      lineN = lineNo(visual);\n    }\n\n    return endOfLine(true, cm, line, lineN, -1);\n  }\n\n  function lineStartSmart(cm, pos) {\n    var start = lineStart(cm, pos.line);\n    var line = getLine(cm.doc, start.line);\n    var order = getOrder(line, cm.doc.direction);\n\n    if (!order || order[0].level == 0) {\n      var firstNonWS = Math.max(0, line.text.search(/\\S/));\n      var inWS = pos.line == start.line && pos.ch <= firstNonWS && pos.ch;\n      return Pos(start.line, inWS ? 0 : firstNonWS, start.sticky);\n    }\n\n    return start;\n  } // Run a handler that was bound to a key.\n\n\n  function doHandleBinding(cm, bound, dropShift) {\n    if (typeof bound == "string") {\n      bound = commands[bound];\n\n      if (!bound) {\n        return false;\n      }\n    } // Ensure previous input has been read, so that the handler sees a\n    // consistent view of the document\n\n\n    cm.display.input.ensurePolled();\n    var prevShift = cm.display.shift,\n        done = false;\n\n    try {\n      if (cm.isReadOnly()) {\n        cm.state.suppressEdits = true;\n      }\n\n      if (dropShift) {\n        cm.display.shift = false;\n      }\n\n      done = bound(cm) != Pass;\n    } finally {\n      cm.display.shift = prevShift;\n      cm.state.suppressEdits = false;\n    }\n\n    return done;\n  }\n\n  function lookupKeyForEditor(cm, name, handle) {\n    for (var i = 0; i < cm.state.keyMaps.length; i++) {\n      var result = lookupKey(name, cm.state.keyMaps[i], handle, cm);\n\n      if (result) {\n        return result;\n      }\n    }\n\n    return cm.options.extraKeys && lookupKey(name, cm.options.extraKeys, handle, cm) || lookupKey(name, cm.options.keyMap, handle, cm);\n  } // Note that, despite the name, this function is also used to check\n  // for bound mouse clicks.\n\n\n  var stopSeq = new Delayed();\n\n  function dispatchKey(cm, name, e, handle) {\n    var seq = cm.state.keySeq;\n\n    if (seq) {\n      if (isModifierKey(name)) {\n        return "handled";\n      }\n\n      if (/\\\'$/.test(name)) {\n        cm.state.keySeq = null;\n      } else {\n        stopSeq.set(50, function () {\n          if (cm.state.keySeq == seq) {\n            cm.state.keySeq = null;\n            cm.display.input.reset();\n          }\n        });\n      }\n\n      if (dispatchKeyInner(cm, seq + " " + name, e, handle)) {\n        return true;\n      }\n    }\n\n    return dispatchKeyInner(cm, name, e, handle);\n  }\n\n  function dispatchKeyInner(cm, name, e, handle) {\n    var result = lookupKeyForEditor(cm, name, handle);\n\n    if (result == "multi") {\n      cm.state.keySeq = name;\n    }\n\n    if (result == "handled") {\n      signalLater(cm, "keyHandled", cm, name, e);\n    }\n\n    if (result == "handled" || result == "multi") {\n      e_preventDefault(e);\n      restartBlink(cm);\n    }\n\n    return !!result;\n  } // Handle a key from the keydown event.\n\n\n  function handleKeyBinding(cm, e) {\n    var name = keyName(e, true);\n\n    if (!name) {\n      return false;\n    }\n\n    if (e.shiftKey && !cm.state.keySeq) {\n      // First try to resolve full name (including \'Shift-\'). Failing\n      // that, see if there is a cursor-motion command (starting with\n      // \'go\') bound to the keyname without \'Shift-\'.\n      return dispatchKey(cm, "Shift-" + name, e, function (b) {\n        return doHandleBinding(cm, b, true);\n      }) || dispatchKey(cm, name, e, function (b) {\n        if (typeof b == "string" ? /^go[A-Z]/.test(b) : b.motion) {\n          return doHandleBinding(cm, b);\n        }\n      });\n    } else {\n      return dispatchKey(cm, name, e, function (b) {\n        return doHandleBinding(cm, b);\n      });\n    }\n  } // Handle a key from the keypress event\n\n\n  function handleCharBinding(cm, e, ch) {\n    return dispatchKey(cm, "\'" + ch + "\'", e, function (b) {\n      return doHandleBinding(cm, b, true);\n    });\n  }\n\n  var lastStoppedKey = null;\n\n  function onKeyDown(e) {\n    var cm = this;\n    cm.curOp.focus = activeElt();\n\n    if (signalDOMEvent(cm, e)) {\n      return;\n    } // IE does strange things with escape.\n\n\n    if (ie && ie_version < 11 && e.keyCode == 27) {\n      e.returnValue = false;\n    }\n\n    var code = e.keyCode;\n    cm.display.shift = code == 16 || e.shiftKey;\n    var handled = handleKeyBinding(cm, e);\n\n    if (presto) {\n      lastStoppedKey = handled ? code : null; // Opera has no cut event... we try to at least catch the key combo\n\n      if (!handled && code == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey)) {\n        cm.replaceSelection("", null, "cut");\n      }\n    }\n\n    if (gecko && !mac && !handled && code == 46 && e.shiftKey && !e.ctrlKey && document.execCommand) {\n      document.execCommand("cut");\n    } // Turn mouse into crosshair when Alt is held on Mac.\n\n\n    if (code == 18 && !/\\bCodeMirror-crosshair\\b/.test(cm.display.lineDiv.className)) {\n      showCrossHair(cm);\n    }\n  }\n\n  function showCrossHair(cm) {\n    var lineDiv = cm.display.lineDiv;\n    addClass(lineDiv, "CodeMirror-crosshair");\n\n    function up(e) {\n      if (e.keyCode == 18 || !e.altKey) {\n        rmClass(lineDiv, "CodeMirror-crosshair");\n        off(document, "keyup", up);\n        off(document, "mouseover", up);\n      }\n    }\n\n    on(document, "keyup", up);\n    on(document, "mouseover", up);\n  }\n\n  function onKeyUp(e) {\n    if (e.keyCode == 16) {\n      this.doc.sel.shift = false;\n    }\n\n    signalDOMEvent(this, e);\n  }\n\n  function onKeyPress(e) {\n    var cm = this;\n\n    if (eventInWidget(cm.display, e) || signalDOMEvent(cm, e) || e.ctrlKey && !e.altKey || mac && e.metaKey) {\n      return;\n    }\n\n    var keyCode = e.keyCode,\n        charCode = e.charCode;\n\n    if (presto && keyCode == lastStoppedKey) {\n      lastStoppedKey = null;\n      e_preventDefault(e);\n      return;\n    }\n\n    if (presto && (!e.which || e.which < 10) && handleKeyBinding(cm, e)) {\n      return;\n    }\n\n    var ch = String.fromCharCode(charCode == null ? keyCode : charCode); // Some browsers fire keypress events for backspace\n\n    if (ch == "\\x08") {\n      return;\n    }\n\n    if (handleCharBinding(cm, e, ch)) {\n      return;\n    }\n\n    cm.display.input.onKeyPress(e);\n  }\n\n  var DOUBLECLICK_DELAY = 400;\n\n  var PastClick = function PastClick(time, pos, button) {\n    this.time = time;\n    this.pos = pos;\n    this.button = button;\n  };\n\n  PastClick.prototype.compare = function (time, pos, button) {\n    return this.time + DOUBLECLICK_DELAY > time && cmp(pos, this.pos) == 0 && button == this.button;\n  };\n\n  var lastClick, lastDoubleClick;\n\n  function clickRepeat(pos, button) {\n    var now = +new Date();\n\n    if (lastDoubleClick && lastDoubleClick.compare(now, pos, button)) {\n      lastClick = lastDoubleClick = null;\n      return "triple";\n    } else if (lastClick && lastClick.compare(now, pos, button)) {\n      lastDoubleClick = new PastClick(now, pos, button);\n      lastClick = null;\n      return "double";\n    } else {\n      lastClick = new PastClick(now, pos, button);\n      lastDoubleClick = null;\n      return "single";\n    }\n  } // A mouse down can be a single click, double click, triple click,\n  // start of selection drag, start of text drag, new cursor\n  // (ctrl-click), rectangle drag (alt-drag), or xwin\n  // middle-click-paste. Or it might be a click on something we should\n  // not interfere with, such as a scrollbar or widget.\n\n\n  function onMouseDown(e) {\n    var cm = this,\n        display = cm.display;\n\n    if (signalDOMEvent(cm, e) || display.activeTouch && display.input.supportsTouch()) {\n      return;\n    }\n\n    display.input.ensurePolled();\n    display.shift = e.shiftKey;\n\n    if (eventInWidget(display, e)) {\n      if (!webkit) {\n        // Briefly turn off draggability, to allow widgets to do\n        // normal dragging things.\n        display.scroller.draggable = false;\n        setTimeout(function () {\n          return display.scroller.draggable = true;\n        }, 100);\n      }\n\n      return;\n    }\n\n    if (clickInGutter(cm, e)) {\n      return;\n    }\n\n    var pos = posFromMouse(cm, e),\n        button = e_button(e),\n        repeat = pos ? clickRepeat(pos, button) : "single";\n    window.focus(); // #3261: make sure, that we\'re not starting a second selection\n\n    if (button == 1 && cm.state.selectingText) {\n      cm.state.selectingText(e);\n    }\n\n    if (pos && handleMappedButton(cm, button, pos, repeat, e)) {\n      return;\n    }\n\n    if (button == 1) {\n      if (pos) {\n        leftButtonDown(cm, pos, repeat, e);\n      } else if (e_target(e) == display.scroller) {\n        e_preventDefault(e);\n      }\n    } else if (button == 2) {\n      if (pos) {\n        extendSelection(cm.doc, pos);\n      }\n\n      setTimeout(function () {\n        return display.input.focus();\n      }, 20);\n    } else if (button == 3) {\n      if (captureRightClick) {\n        cm.display.input.onContextMenu(e);\n      } else {\n        delayBlurEvent(cm);\n      }\n    }\n  }\n\n  function handleMappedButton(cm, button, pos, repeat, event) {\n    var name = "Click";\n\n    if (repeat == "double") {\n      name = "Double" + name;\n    } else if (repeat == "triple") {\n      name = "Triple" + name;\n    }\n\n    name = (button == 1 ? "Left" : button == 2 ? "Middle" : "Right") + name;\n    return dispatchKey(cm, addModifierNames(name, event), event, function (bound) {\n      if (typeof bound == "string") {\n        bound = commands[bound];\n      }\n\n      if (!bound) {\n        return false;\n      }\n\n      var done = false;\n\n      try {\n        if (cm.isReadOnly()) {\n          cm.state.suppressEdits = true;\n        }\n\n        done = bound(cm, pos) != Pass;\n      } finally {\n        cm.state.suppressEdits = false;\n      }\n\n      return done;\n    });\n  }\n\n  function configureMouse(cm, repeat, event) {\n    var option = cm.getOption("configureMouse");\n    var value = option ? option(cm, repeat, event) : {};\n\n    if (value.unit == null) {\n      var rect = chromeOS ? event.shiftKey && event.metaKey : event.altKey;\n      value.unit = rect ? "rectangle" : repeat == "single" ? "char" : repeat == "double" ? "word" : "line";\n    }\n\n    if (value.extend == null || cm.doc.extend) {\n      value.extend = cm.doc.extend || event.shiftKey;\n    }\n\n    if (value.addNew == null) {\n      value.addNew = mac ? event.metaKey : event.ctrlKey;\n    }\n\n    if (value.moveOnDrag == null) {\n      value.moveOnDrag = !(mac ? event.altKey : event.ctrlKey);\n    }\n\n    return value;\n  }\n\n  function leftButtonDown(cm, pos, repeat, event) {\n    if (ie) {\n      setTimeout(bind(ensureFocus, cm), 0);\n    } else {\n      cm.curOp.focus = activeElt();\n    }\n\n    var behavior = configureMouse(cm, repeat, event);\n    var sel = cm.doc.sel,\n        contained;\n\n    if (cm.options.dragDrop && dragAndDrop && !cm.isReadOnly() && repeat == "single" && (contained = sel.contains(pos)) > -1 && (cmp((contained = sel.ranges[contained]).from(), pos) < 0 || pos.xRel > 0) && (cmp(contained.to(), pos) > 0 || pos.xRel < 0)) {\n      leftButtonStartDrag(cm, event, pos, behavior);\n    } else {\n      leftButtonSelect(cm, event, pos, behavior);\n    }\n  } // Start a text drag. When it ends, see if any dragging actually\n  // happen, and treat as a click if it didn\'t.\n\n\n  function leftButtonStartDrag(cm, event, pos, behavior) {\n    var display = cm.display,\n        moved = false;\n    var dragEnd = operation(cm, function (e) {\n      if (webkit) {\n        display.scroller.draggable = false;\n      }\n\n      cm.state.draggingText = false;\n      off(display.wrapper.ownerDocument, "mouseup", dragEnd);\n      off(display.wrapper.ownerDocument, "mousemove", mouseMove);\n      off(display.scroller, "dragstart", dragStart);\n      off(display.scroller, "drop", dragEnd);\n\n      if (!moved) {\n        e_preventDefault(e);\n\n        if (!behavior.addNew) {\n          extendSelection(cm.doc, pos, null, null, behavior.extend);\n        } // Work around unexplainable focus problem in IE9 (#2127) and Chrome (#3081)\n\n\n        if (webkit || ie && ie_version == 9) {\n          setTimeout(function () {\n            display.wrapper.ownerDocument.body.focus();\n            display.input.focus();\n          }, 20);\n        } else {\n          display.input.focus();\n        }\n      }\n    });\n\n    var mouseMove = function mouseMove(e2) {\n      moved = moved || Math.abs(event.clientX - e2.clientX) + Math.abs(event.clientY - e2.clientY) >= 10;\n    };\n\n    var dragStart = function dragStart() {\n      return moved = true;\n    }; // Let the drag handler handle this.\n\n\n    if (webkit) {\n      display.scroller.draggable = true;\n    }\n\n    cm.state.draggingText = dragEnd;\n    dragEnd.copy = !behavior.moveOnDrag; // IE\'s approach to draggable\n\n    if (display.scroller.dragDrop) {\n      display.scroller.dragDrop();\n    }\n\n    on(display.wrapper.ownerDocument, "mouseup", dragEnd);\n    on(display.wrapper.ownerDocument, "mousemove", mouseMove);\n    on(display.scroller, "dragstart", dragStart);\n    on(display.scroller, "drop", dragEnd);\n    delayBlurEvent(cm);\n    setTimeout(function () {\n      return display.input.focus();\n    }, 20);\n  }\n\n  function rangeForUnit(cm, pos, unit) {\n    if (unit == "char") {\n      return new Range(pos, pos);\n    }\n\n    if (unit == "word") {\n      return cm.findWordAt(pos);\n    }\n\n    if (unit == "line") {\n      return new Range(Pos(pos.line, 0), _clipPos(cm.doc, Pos(pos.line + 1, 0)));\n    }\n\n    var result = unit(cm, pos);\n    return new Range(result.from, result.to);\n  } // Normal selection, as opposed to text dragging.\n\n\n  function leftButtonSelect(cm, event, start, behavior) {\n    var display = cm.display,\n        doc = cm.doc;\n    e_preventDefault(event);\n    var ourRange,\n        ourIndex,\n        startSel = doc.sel,\n        ranges = startSel.ranges;\n\n    if (behavior.addNew && !behavior.extend) {\n      ourIndex = doc.sel.contains(start);\n\n      if (ourIndex > -1) {\n        ourRange = ranges[ourIndex];\n      } else {\n        ourRange = new Range(start, start);\n      }\n    } else {\n      ourRange = doc.sel.primary();\n      ourIndex = doc.sel.primIndex;\n    }\n\n    if (behavior.unit == "rectangle") {\n      if (!behavior.addNew) {\n        ourRange = new Range(start, start);\n      }\n\n      start = posFromMouse(cm, event, true, true);\n      ourIndex = -1;\n    } else {\n      var range = rangeForUnit(cm, start, behavior.unit);\n\n      if (behavior.extend) {\n        ourRange = extendRange(ourRange, range.anchor, range.head, behavior.extend);\n      } else {\n        ourRange = range;\n      }\n    }\n\n    if (!behavior.addNew) {\n      ourIndex = 0;\n      setSelection(doc, new Selection([ourRange], 0), sel_mouse);\n      startSel = doc.sel;\n    } else if (ourIndex == -1) {\n      ourIndex = ranges.length;\n      setSelection(doc, normalizeSelection(cm, ranges.concat([ourRange]), ourIndex), {\n        scroll: false,\n        origin: "*mouse"\n      });\n    } else if (ranges.length > 1 && ranges[ourIndex].empty() && behavior.unit == "char" && !behavior.extend) {\n      setSelection(doc, normalizeSelection(cm, ranges.slice(0, ourIndex).concat(ranges.slice(ourIndex + 1)), 0), {\n        scroll: false,\n        origin: "*mouse"\n      });\n      startSel = doc.sel;\n    } else {\n      replaceOneSelection(doc, ourIndex, ourRange, sel_mouse);\n    }\n\n    var lastPos = start;\n\n    function extendTo(pos) {\n      if (cmp(lastPos, pos) == 0) {\n        return;\n      }\n\n      lastPos = pos;\n\n      if (behavior.unit == "rectangle") {\n        var ranges = [],\n            tabSize = cm.options.tabSize;\n        var startCol = countColumn(getLine(doc, start.line).text, start.ch, tabSize);\n        var posCol = countColumn(getLine(doc, pos.line).text, pos.ch, tabSize);\n        var left = Math.min(startCol, posCol),\n            right = Math.max(startCol, posCol);\n\n        for (var line = Math.min(start.line, pos.line), end = Math.min(cm.lastLine(), Math.max(start.line, pos.line)); line <= end; line++) {\n          var text = getLine(doc, line).text,\n              leftPos = findColumn(text, left, tabSize);\n\n          if (left == right) {\n            ranges.push(new Range(Pos(line, leftPos), Pos(line, leftPos)));\n          } else if (text.length > leftPos) {\n            ranges.push(new Range(Pos(line, leftPos), Pos(line, findColumn(text, right, tabSize))));\n          }\n        }\n\n        if (!ranges.length) {\n          ranges.push(new Range(start, start));\n        }\n\n        setSelection(doc, normalizeSelection(cm, startSel.ranges.slice(0, ourIndex).concat(ranges), ourIndex), {\n          origin: "*mouse",\n          scroll: false\n        });\n        cm.scrollIntoView(pos);\n      } else {\n        var oldRange = ourRange;\n        var range = rangeForUnit(cm, pos, behavior.unit);\n        var anchor = oldRange.anchor,\n            head;\n\n        if (cmp(range.anchor, anchor) > 0) {\n          head = range.head;\n          anchor = minPos(oldRange.from(), range.anchor);\n        } else {\n          head = range.anchor;\n          anchor = maxPos(oldRange.to(), range.head);\n        }\n\n        var ranges$1 = startSel.ranges.slice(0);\n        ranges$1[ourIndex] = bidiSimplify(cm, new Range(_clipPos(doc, anchor), head));\n        setSelection(doc, normalizeSelection(cm, ranges$1, ourIndex), sel_mouse);\n      }\n    }\n\n    var editorSize = display.wrapper.getBoundingClientRect(); // Used to ensure timeout re-tries don\'t fire when another extend\n    // happened in the meantime (clearTimeout isn\'t reliable -- at\n    // least on Chrome, the timeouts still happen even when cleared,\n    // if the clear happens after their scheduled firing time).\n\n    var counter = 0;\n\n    function extend(e) {\n      var curCount = ++counter;\n      var cur = posFromMouse(cm, e, true, behavior.unit == "rectangle");\n\n      if (!cur) {\n        return;\n      }\n\n      if (cmp(cur, lastPos) != 0) {\n        cm.curOp.focus = activeElt();\n        extendTo(cur);\n        var visible = visibleLines(display, doc);\n\n        if (cur.line >= visible.to || cur.line < visible.from) {\n          setTimeout(operation(cm, function () {\n            if (counter == curCount) {\n              extend(e);\n            }\n          }), 150);\n        }\n      } else {\n        var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0;\n\n        if (outside) {\n          setTimeout(operation(cm, function () {\n            if (counter != curCount) {\n              return;\n            }\n\n            display.scroller.scrollTop += outside;\n            extend(e);\n          }), 50);\n        }\n      }\n    }\n\n    function done(e) {\n      cm.state.selectingText = false;\n      counter = Infinity; // If e is null or undefined we interpret this as someone trying\n      // to explicitly cancel the selection rather than the user\n      // letting go of the mouse button.\n\n      if (e) {\n        e_preventDefault(e);\n        display.input.focus();\n      }\n\n      off(display.wrapper.ownerDocument, "mousemove", move);\n      off(display.wrapper.ownerDocument, "mouseup", up);\n      doc.history.lastSelOrigin = null;\n    }\n\n    var move = operation(cm, function (e) {\n      if (e.buttons === 0 || !e_button(e)) {\n        done(e);\n      } else {\n        extend(e);\n      }\n    });\n    var up = operation(cm, done);\n    cm.state.selectingText = up;\n    on(display.wrapper.ownerDocument, "mousemove", move);\n    on(display.wrapper.ownerDocument, "mouseup", up);\n  } // Used when mouse-selecting to adjust the anchor to the proper side\n  // of a bidi jump depending on the visual position of the head.\n\n\n  function bidiSimplify(cm, range) {\n    var anchor = range.anchor;\n    var head = range.head;\n    var anchorLine = getLine(cm.doc, anchor.line);\n\n    if (cmp(anchor, head) == 0 && anchor.sticky == head.sticky) {\n      return range;\n    }\n\n    var order = getOrder(anchorLine);\n\n    if (!order) {\n      return range;\n    }\n\n    var index = getBidiPartAt(order, anchor.ch, anchor.sticky),\n        part = order[index];\n\n    if (part.from != anchor.ch && part.to != anchor.ch) {\n      return range;\n    }\n\n    var boundary = index + (part.from == anchor.ch == (part.level != 1) ? 0 : 1);\n\n    if (boundary == 0 || boundary == order.length) {\n      return range;\n    } // Compute the relative visual position of the head compared to the\n    // anchor (<0 is to the left, >0 to the right)\n\n\n    var leftSide;\n\n    if (head.line != anchor.line) {\n      leftSide = (head.line - anchor.line) * (cm.doc.direction == "ltr" ? 1 : -1) > 0;\n    } else {\n      var headIndex = getBidiPartAt(order, head.ch, head.sticky);\n      var dir = headIndex - index || (head.ch - anchor.ch) * (part.level == 1 ? -1 : 1);\n\n      if (headIndex == boundary - 1 || headIndex == boundary) {\n        leftSide = dir < 0;\n      } else {\n        leftSide = dir > 0;\n      }\n    }\n\n    var usePart = order[boundary + (leftSide ? -1 : 0)];\n    var from = leftSide == (usePart.level == 1);\n    var ch = from ? usePart.from : usePart.to,\n        sticky = from ? "after" : "before";\n    return anchor.ch == ch && anchor.sticky == sticky ? range : new Range(new Pos(anchor.line, ch, sticky), head);\n  } // Determines whether an event happened in the gutter, and fires the\n  // handlers for the corresponding event.\n\n\n  function gutterEvent(cm, e, type, prevent) {\n    var mX, mY;\n\n    if (e.touches) {\n      mX = e.touches[0].clientX;\n      mY = e.touches[0].clientY;\n    } else {\n      try {\n        mX = e.clientX;\n        mY = e.clientY;\n      } catch (e) {\n        return false;\n      }\n    }\n\n    if (mX >= Math.floor(cm.display.gutters.getBoundingClientRect().right)) {\n      return false;\n    }\n\n    if (prevent) {\n      e_preventDefault(e);\n    }\n\n    var display = cm.display;\n    var lineBox = display.lineDiv.getBoundingClientRect();\n\n    if (mY > lineBox.bottom || !hasHandler(cm, type)) {\n      return e_defaultPrevented(e);\n    }\n\n    mY -= lineBox.top - display.viewOffset;\n\n    for (var i = 0; i < cm.display.gutterSpecs.length; ++i) {\n      var g = display.gutters.childNodes[i];\n\n      if (g && g.getBoundingClientRect().right >= mX) {\n        var line = _lineAtHeight(cm.doc, mY);\n\n        var gutter = cm.display.gutterSpecs[i];\n        signal(cm, type, cm, line, gutter.className, e);\n        return e_defaultPrevented(e);\n      }\n    }\n  }\n\n  function clickInGutter(cm, e) {\n    return gutterEvent(cm, e, "gutterClick", true);\n  } // CONTEXT MENU HANDLING\n  // To make the context menu work, we need to briefly unhide the\n  // textarea (making it as unobtrusive as possible) to let the\n  // right-click take effect on it.\n\n\n  function onContextMenu(cm, e) {\n    if (eventInWidget(cm.display, e) || contextMenuInGutter(cm, e)) {\n      return;\n    }\n\n    if (signalDOMEvent(cm, e, "contextmenu")) {\n      return;\n    }\n\n    if (!captureRightClick) {\n      cm.display.input.onContextMenu(e);\n    }\n  }\n\n  function contextMenuInGutter(cm, e) {\n    if (!hasHandler(cm, "gutterContextMenu")) {\n      return false;\n    }\n\n    return gutterEvent(cm, e, "gutterContextMenu", false);\n  }\n\n  function themeChanged(cm) {\n    cm.display.wrapper.className = cm.display.wrapper.className.replace(/\\s*cm-s-\\S+/g, "") + cm.options.theme.replace(/(^|\\s)\\s*/g, " cm-s-");\n    clearCaches(cm);\n  }\n\n  var Init = {\n    toString: function toString() {\n      return "CodeMirror.Init";\n    }\n  };\n  var defaults = {};\n  var optionHandlers = {};\n\n  function defineOptions(CodeMirror) {\n    var optionHandlers = CodeMirror.optionHandlers;\n\n    function option(name, deflt, handle, notOnInit) {\n      CodeMirror.defaults[name] = deflt;\n\n      if (handle) {\n        optionHandlers[name] = notOnInit ? function (cm, val, old) {\n          if (old != Init) {\n            handle(cm, val, old);\n          }\n        } : handle;\n      }\n    }\n\n    CodeMirror.defineOption = option; // Passed to option handlers when there is no old value.\n\n    CodeMirror.Init = Init; // These two are, on init, called from the constructor because they\n    // have to be initialized before the editor can start at all.\n\n    option("value", "", function (cm, val) {\n      return cm.setValue(val);\n    }, true);\n    option("mode", null, function (cm, val) {\n      cm.doc.modeOption = val;\n      loadMode(cm);\n    }, true);\n    option("indentUnit", 2, loadMode, true);\n    option("indentWithTabs", false);\n    option("smartIndent", true);\n    option("tabSize", 4, function (cm) {\n      resetModeState(cm);\n      clearCaches(cm);\n      regChange(cm);\n    }, true);\n    option("lineSeparator", null, function (cm, val) {\n      cm.doc.lineSep = val;\n\n      if (!val) {\n        return;\n      }\n\n      var newBreaks = [],\n          lineNo = cm.doc.first;\n      cm.doc.iter(function (line) {\n        for (var pos = 0;;) {\n          var found = line.text.indexOf(val, pos);\n\n          if (found == -1) {\n            break;\n          }\n\n          pos = found + val.length;\n          newBreaks.push(Pos(lineNo, found));\n        }\n\n        lineNo++;\n      });\n\n      for (var i = newBreaks.length - 1; i >= 0; i--) {\n        _replaceRange(cm.doc, val, newBreaks[i], Pos(newBreaks[i].line, newBreaks[i].ch + val.length));\n      }\n    });\n    option("specialChars", /[\\u0000-\\u001f\\u007f-\\u009f\\u00ad\\u061c\\u200b-\\u200f\\u2028\\u2029\\ufeff\\ufff9-\\ufffc]/g, function (cm, val, old) {\n      cm.state.specialChars = new RegExp(val.source + (val.test("\\t") ? "" : "|\\t"), "g");\n\n      if (old != Init) {\n        cm.refresh();\n      }\n    });\n    option("specialCharPlaceholder", defaultSpecialCharPlaceholder, function (cm) {\n      return cm.refresh();\n    }, true);\n    option("electricChars", true);\n    option("inputStyle", mobile ? "contenteditable" : "textarea", function () {\n      throw new Error("inputStyle can not (yet) be changed in a running editor"); // FIXME\n    }, true);\n    option("spellcheck", false, function (cm, val) {\n      return cm.getInputField().spellcheck = val;\n    }, true);\n    option("autocorrect", false, function (cm, val) {\n      return cm.getInputField().autocorrect = val;\n    }, true);\n    option("autocapitalize", false, function (cm, val) {\n      return cm.getInputField().autocapitalize = val;\n    }, true);\n    option("rtlMoveVisually", !windows);\n    option("wholeLineUpdateBefore", true);\n    option("theme", "default", function (cm) {\n      themeChanged(cm);\n      updateGutters(cm);\n    }, true);\n    option("keyMap", "default", function (cm, val, old) {\n      var next = getKeyMap(val);\n      var prev = old != Init && getKeyMap(old);\n\n      if (prev && prev.detach) {\n        prev.detach(cm, next);\n      }\n\n      if (next.attach) {\n        next.attach(cm, prev || null);\n      }\n    });\n    option("extraKeys", null);\n    option("configureMouse", null);\n    option("lineWrapping", false, wrappingChanged, true);\n    option("gutters", [], function (cm, val) {\n      cm.display.gutterSpecs = getGutters(val, cm.options.lineNumbers);\n      updateGutters(cm);\n    }, true);\n    option("fixedGutter", true, function (cm, val) {\n      cm.display.gutters.style.left = val ? compensateForHScroll(cm.display) + "px" : "0";\n      cm.refresh();\n    }, true);\n    option("coverGutterNextToScrollbar", false, function (cm) {\n      return updateScrollbars(cm);\n    }, true);\n    option("scrollbarStyle", "native", function (cm) {\n      initScrollbars(cm);\n      updateScrollbars(cm);\n      cm.display.scrollbars.setScrollTop(cm.doc.scrollTop);\n      cm.display.scrollbars.setScrollLeft(cm.doc.scrollLeft);\n    }, true);\n    option("lineNumbers", false, function (cm, val) {\n      cm.display.gutterSpecs = getGutters(cm.options.gutters, val);\n      updateGutters(cm);\n    }, true);\n    option("firstLineNumber", 1, updateGutters, true);\n    option("lineNumberFormatter", function (integer) {\n      return integer;\n    }, updateGutters, true);\n    option("showCursorWhenSelecting", false, updateSelection, true);\n    option("resetSelectionOnContextMenu", true);\n    option("lineWiseCopyCut", true);\n    option("pasteLinesPerSelection", true);\n    option("selectionsMayTouch", false);\n    option("readOnly", false, function (cm, val) {\n      if (val == "nocursor") {\n        onBlur(cm);\n        cm.display.input.blur();\n      }\n\n      cm.display.input.readOnlyChanged(val);\n    });\n    option("disableInput", false, function (cm, val) {\n      if (!val) {\n        cm.display.input.reset();\n      }\n    }, true);\n    option("dragDrop", true, dragDropChanged);\n    option("allowDropFileTypes", null);\n    option("cursorBlinkRate", 530);\n    option("cursorScrollMargin", 0);\n    option("cursorHeight", 1, updateSelection, true);\n    option("singleCursorHeightPerLine", true, updateSelection, true);\n    option("workTime", 100);\n    option("workDelay", 100);\n    option("flattenSpans", true, resetModeState, true);\n    option("addModeClass", false, resetModeState, true);\n    option("pollInterval", 100);\n    option("undoDepth", 200, function (cm, val) {\n      return cm.doc.history.undoDepth = val;\n    });\n    option("historyEventDelay", 1250);\n    option("viewportMargin", 10, function (cm) {\n      return cm.refresh();\n    }, true);\n    option("maxHighlightLength", 10000, resetModeState, true);\n    option("moveInputWithCursor", true, function (cm, val) {\n      if (!val) {\n        cm.display.input.resetPosition();\n      }\n    });\n    option("tabindex", null, function (cm, val) {\n      return cm.display.input.getField().tabIndex = val || "";\n    });\n    option("autofocus", null);\n    option("direction", "ltr", function (cm, val) {\n      return cm.doc.setDirection(val);\n    }, true);\n    option("phrases", null);\n  }\n\n  function dragDropChanged(cm, value, old) {\n    var wasOn = old && old != Init;\n\n    if (!value != !wasOn) {\n      var funcs = cm.display.dragFunctions;\n      var toggle = value ? on : off;\n      toggle(cm.display.scroller, "dragstart", funcs.start);\n      toggle(cm.display.scroller, "dragenter", funcs.enter);\n      toggle(cm.display.scroller, "dragover", funcs.over);\n      toggle(cm.display.scroller, "dragleave", funcs.leave);\n      toggle(cm.display.scroller, "drop", funcs.drop);\n    }\n  }\n\n  function wrappingChanged(cm) {\n    if (cm.options.lineWrapping) {\n      addClass(cm.display.wrapper, "CodeMirror-wrap");\n      cm.display.sizer.style.minWidth = "";\n      cm.display.sizerWidth = null;\n    } else {\n      rmClass(cm.display.wrapper, "CodeMirror-wrap");\n      findMaxLine(cm);\n    }\n\n    estimateLineHeights(cm);\n    regChange(cm);\n    clearCaches(cm);\n    setTimeout(function () {\n      return updateScrollbars(cm);\n    }, 100);\n  } // A CodeMirror instance represents an editor. This is the object\n  // that user code is usually dealing with.\n\n\n  function CodeMirror(place, options) {\n    var this$1 = this;\n\n    if (!(this instanceof CodeMirror)) {\n      return new CodeMirror(place, options);\n    }\n\n    this.options = options = options ? copyObj(options) : {}; // Determine effective options based on given values and defaults.\n\n    copyObj(defaults, options, false);\n    var doc = options.value;\n\n    if (typeof doc == "string") {\n      doc = new Doc(doc, options.mode, null, options.lineSeparator, options.direction);\n    } else if (options.mode) {\n      doc.modeOption = options.mode;\n    }\n\n    this.doc = doc;\n    var input = new CodeMirror.inputStyles[options.inputStyle](this);\n    var display = this.display = new Display(place, doc, input, options);\n    display.wrapper.CodeMirror = this;\n    themeChanged(this);\n\n    if (options.lineWrapping) {\n      this.display.wrapper.className += " CodeMirror-wrap";\n    }\n\n    initScrollbars(this);\n    this.state = {\n      keyMaps: [],\n      // stores maps added by addKeyMap\n      overlays: [],\n      // highlighting overlays, as added by addOverlay\n      modeGen: 0,\n      // bumped when mode/overlay changes, used to invalidate highlighting info\n      overwrite: false,\n      delayingBlurEvent: false,\n      focused: false,\n      suppressEdits: false,\n      // used to disable editing during key handlers when in readOnly mode\n      pasteIncoming: -1,\n      cutIncoming: -1,\n      // help recognize paste/cut edits in input.poll\n      selectingText: false,\n      draggingText: false,\n      highlight: new Delayed(),\n      // stores highlight worker timeout\n      keySeq: null,\n      // Unfinished key sequence\n      specialChars: null\n    };\n\n    if (options.autofocus && !mobile) {\n      display.input.focus();\n    } // Override magic textarea content restore that IE sometimes does\n    // on our hidden textarea on reload\n\n\n    if (ie && ie_version < 11) {\n      setTimeout(function () {\n        return this$1.display.input.reset(true);\n      }, 20);\n    }\n\n    registerEventHandlers(this);\n    ensureGlobalHandlers();\n\n    _startOperation(this);\n\n    this.curOp.forceUpdate = true;\n    attachDoc(this, doc);\n\n    if (options.autofocus && !mobile || this.hasFocus()) {\n      setTimeout(bind(onFocus, this), 20);\n    } else {\n      onBlur(this);\n    }\n\n    for (var opt in optionHandlers) {\n      if (optionHandlers.hasOwnProperty(opt)) {\n        optionHandlers[opt](this, options[opt], Init);\n      }\n    }\n\n    maybeUpdateLineNumberWidth(this);\n\n    if (options.finishInit) {\n      options.finishInit(this);\n    }\n\n    for (var i = 0; i < initHooks.length; ++i) {\n      initHooks[i](this);\n    }\n\n    _endOperation(this); // Suppress optimizelegibility in Webkit, since it breaks text\n    // measuring on line wrapping boundaries.\n\n\n    if (webkit && options.lineWrapping && getComputedStyle(display.lineDiv).textRendering == "optimizelegibility") {\n      display.lineDiv.style.textRendering = "auto";\n    }\n  } // The default configuration options.\n\n\n  CodeMirror.defaults = defaults; // Functions to run when options are changed.\n\n  CodeMirror.optionHandlers = optionHandlers; // Attach the necessary event handlers when initializing the editor\n\n  function registerEventHandlers(cm) {\n    var d = cm.display;\n    on(d.scroller, "mousedown", operation(cm, onMouseDown)); // Older IE\'s will not fire a second mousedown for a double click\n\n    if (ie && ie_version < 11) {\n      on(d.scroller, "dblclick", operation(cm, function (e) {\n        if (signalDOMEvent(cm, e)) {\n          return;\n        }\n\n        var pos = posFromMouse(cm, e);\n\n        if (!pos || clickInGutter(cm, e) || eventInWidget(cm.display, e)) {\n          return;\n        }\n\n        e_preventDefault(e);\n        var word = cm.findWordAt(pos);\n        extendSelection(cm.doc, word.anchor, word.head);\n      }));\n    } else {\n      on(d.scroller, "dblclick", function (e) {\n        return signalDOMEvent(cm, e) || e_preventDefault(e);\n      });\n    } // Some browsers fire contextmenu *after* opening the menu, at\n    // which point we can\'t mess with it anymore. Context menu is\n    // handled in onMouseDown for these browsers.\n\n\n    on(d.scroller, "contextmenu", function (e) {\n      return onContextMenu(cm, e);\n    }); // Used to suppress mouse event handling when a touch happens\n\n    var touchFinished,\n        prevTouch = {\n      end: 0\n    };\n\n    function finishTouch() {\n      if (d.activeTouch) {\n        touchFinished = setTimeout(function () {\n          return d.activeTouch = null;\n        }, 1000);\n        prevTouch = d.activeTouch;\n        prevTouch.end = +new Date();\n      }\n    }\n\n    function isMouseLikeTouchEvent(e) {\n      if (e.touches.length != 1) {\n        return false;\n      }\n\n      var touch = e.touches[0];\n      return touch.radiusX <= 1 && touch.radiusY <= 1;\n    }\n\n    function farAway(touch, other) {\n      if (other.left == null) {\n        return true;\n      }\n\n      var dx = other.left - touch.left,\n          dy = other.top - touch.top;\n      return dx * dx + dy * dy > 20 * 20;\n    }\n\n    on(d.scroller, "touchstart", function (e) {\n      if (!signalDOMEvent(cm, e) && !isMouseLikeTouchEvent(e) && !clickInGutter(cm, e)) {\n        d.input.ensurePolled();\n        clearTimeout(touchFinished);\n        var now = +new Date();\n        d.activeTouch = {\n          start: now,\n          moved: false,\n          prev: now - prevTouch.end <= 300 ? prevTouch : null\n        };\n\n        if (e.touches.length == 1) {\n          d.activeTouch.left = e.touches[0].pageX;\n          d.activeTouch.top = e.touches[0].pageY;\n        }\n      }\n    });\n    on(d.scroller, "touchmove", function () {\n      if (d.activeTouch) {\n        d.activeTouch.moved = true;\n      }\n    });\n    on(d.scroller, "touchend", function (e) {\n      var touch = d.activeTouch;\n\n      if (touch && !eventInWidget(d, e) && touch.left != null && !touch.moved && new Date() - touch.start < 300) {\n        var pos = cm.coordsChar(d.activeTouch, "page"),\n            range;\n\n        if (!touch.prev || farAway(touch, touch.prev)) // Single tap\n          {\n            range = new Range(pos, pos);\n          } else if (!touch.prev.prev || farAway(touch, touch.prev.prev)) // Double tap\n          {\n            range = cm.findWordAt(pos);\n          } else // Triple tap\n          {\n            range = new Range(Pos(pos.line, 0), _clipPos(cm.doc, Pos(pos.line + 1, 0)));\n          }\n\n        cm.setSelection(range.anchor, range.head);\n        cm.focus();\n        e_preventDefault(e);\n      }\n\n      finishTouch();\n    });\n    on(d.scroller, "touchcancel", finishTouch); // Sync scrolling between fake scrollbars and real scrollable\n    // area, ensure viewport is updated when scrolling.\n\n    on(d.scroller, "scroll", function () {\n      if (d.scroller.clientHeight) {\n        updateScrollTop(cm, d.scroller.scrollTop);\n        setScrollLeft(cm, d.scroller.scrollLeft, true);\n        signal(cm, "scroll", cm);\n      }\n    }); // Listen to wheel events in order to try and update the viewport on time.\n\n    on(d.scroller, "mousewheel", function (e) {\n      return onScrollWheel(cm, e);\n    });\n    on(d.scroller, "DOMMouseScroll", function (e) {\n      return onScrollWheel(cm, e);\n    }); // Prevent wrapper from ever scrolling\n\n    on(d.wrapper, "scroll", function () {\n      return d.wrapper.scrollTop = d.wrapper.scrollLeft = 0;\n    });\n    d.dragFunctions = {\n      enter: function enter(e) {\n        if (!signalDOMEvent(cm, e)) {\n          e_stop(e);\n        }\n      },\n      over: function over(e) {\n        if (!signalDOMEvent(cm, e)) {\n          onDragOver(cm, e);\n          e_stop(e);\n        }\n      },\n      start: function start(e) {\n        return onDragStart(cm, e);\n      },\n      drop: operation(cm, onDrop),\n      leave: function leave(e) {\n        if (!signalDOMEvent(cm, e)) {\n          clearDragCursor(cm);\n        }\n      }\n    };\n    var inp = d.input.getField();\n    on(inp, "keyup", function (e) {\n      return onKeyUp.call(cm, e);\n    });\n    on(inp, "keydown", operation(cm, onKeyDown));\n    on(inp, "keypress", operation(cm, onKeyPress));\n    on(inp, "focus", function (e) {\n      return onFocus(cm, e);\n    });\n    on(inp, "blur", function (e) {\n      return onBlur(cm, e);\n    });\n  }\n\n  var initHooks = [];\n\n  CodeMirror.defineInitHook = function (f) {\n    return initHooks.push(f);\n  }; // Indent the given line. The how parameter can be "smart",\n  // "add"/null, "subtract", or "prev". When aggressive is false\n  // (typically set to true for forced single-line indents), empty\n  // lines are not indented, and places where the mode returns Pass\n  // are left alone.\n\n\n  function indentLine(cm, n, how, aggressive) {\n    var doc = cm.doc,\n        state;\n\n    if (how == null) {\n      how = "add";\n    }\n\n    if (how == "smart") {\n      // Fall back to "prev" when the mode doesn\'t have an indentation\n      // method.\n      if (!doc.mode.indent) {\n        how = "prev";\n      } else {\n        state = getContextBefore(cm, n).state;\n      }\n    }\n\n    var tabSize = cm.options.tabSize;\n    var line = getLine(doc, n),\n        curSpace = countColumn(line.text, null, tabSize);\n\n    if (line.stateAfter) {\n      line.stateAfter = null;\n    }\n\n    var curSpaceString = line.text.match(/^\\s*/)[0],\n        indentation;\n\n    if (!aggressive && !/\\S/.test(line.text)) {\n      indentation = 0;\n      how = "not";\n    } else if (how == "smart") {\n      indentation = doc.mode.indent(state, line.text.slice(curSpaceString.length), line.text);\n\n      if (indentation == Pass || indentation > 150) {\n        if (!aggressive) {\n          return;\n        }\n\n        how = "prev";\n      }\n    }\n\n    if (how == "prev") {\n      if (n > doc.first) {\n        indentation = countColumn(getLine(doc, n - 1).text, null, tabSize);\n      } else {\n        indentation = 0;\n      }\n    } else if (how == "add") {\n      indentation = curSpace + cm.options.indentUnit;\n    } else if (how == "subtract") {\n      indentation = curSpace - cm.options.indentUnit;\n    } else if (typeof how == "number") {\n      indentation = curSpace + how;\n    }\n\n    indentation = Math.max(0, indentation);\n    var indentString = "",\n        pos = 0;\n\n    if (cm.options.indentWithTabs) {\n      for (var i = Math.floor(indentation / tabSize); i; --i) {\n        pos += tabSize;\n        indentString += "\\t";\n      }\n    }\n\n    if (pos < indentation) {\n      indentString += spaceStr(indentation - pos);\n    }\n\n    if (indentString != curSpaceString) {\n      _replaceRange(doc, indentString, Pos(n, 0), Pos(n, curSpaceString.length), "+input");\n\n      line.stateAfter = null;\n      return true;\n    } else {\n      // Ensure that, if the cursor was in the whitespace at the start\n      // of the line, it is moved to the end of that space.\n      for (var i$1 = 0; i$1 < doc.sel.ranges.length; i$1++) {\n        var range = doc.sel.ranges[i$1];\n\n        if (range.head.line == n && range.head.ch < curSpaceString.length) {\n          var pos$1 = Pos(n, curSpaceString.length);\n          replaceOneSelection(doc, i$1, new Range(pos$1, pos$1));\n          break;\n        }\n      }\n    }\n  } // This will be set to a {lineWise: bool, text: [string]} object, so\n  // that, when pasting, we know what kind of selections the copied\n  // text was made out of.\n\n\n  var lastCopied = null;\n\n  function setLastCopied(newLastCopied) {\n    lastCopied = newLastCopied;\n  }\n\n  function applyTextInput(cm, inserted, deleted, sel, origin) {\n    var doc = cm.doc;\n    cm.display.shift = false;\n\n    if (!sel) {\n      sel = doc.sel;\n    }\n\n    var recent = +new Date() - 200;\n    var paste = origin == "paste" || cm.state.pasteIncoming > recent;\n    var textLines = splitLinesAuto(inserted),\n        multiPaste = null; // When pasting N lines into N selections, insert one line per selection\n\n    if (paste && sel.ranges.length > 1) {\n      if (lastCopied && lastCopied.text.join("\\n") == inserted) {\n        if (sel.ranges.length % lastCopied.text.length == 0) {\n          multiPaste = [];\n\n          for (var i = 0; i < lastCopied.text.length; i++) {\n            multiPaste.push(doc.splitLines(lastCopied.text[i]));\n          }\n        }\n      } else if (textLines.length == sel.ranges.length && cm.options.pasteLinesPerSelection) {\n        multiPaste = map(textLines, function (l) {\n          return [l];\n        });\n      }\n    }\n\n    var updateInput = cm.curOp.updateInput; // Normal behavior is to insert the new text into every selection\n\n    for (var i$1 = sel.ranges.length - 1; i$1 >= 0; i$1--) {\n      var range = sel.ranges[i$1];\n      var from = range.from(),\n          to = range.to();\n\n      if (range.empty()) {\n        if (deleted && deleted > 0) // Handle deletion\n          {\n            from = Pos(from.line, from.ch - deleted);\n          } else if (cm.state.overwrite && !paste) // Handle overwrite\n          {\n            to = Pos(to.line, Math.min(getLine(doc, to.line).text.length, to.ch + lst(textLines).length));\n          } else if (paste && lastCopied && lastCopied.lineWise && lastCopied.text.join("\\n") == inserted) {\n          from = to = Pos(from.line, 0);\n        }\n      }\n\n      var changeEvent = {\n        from: from,\n        to: to,\n        text: multiPaste ? multiPaste[i$1 % multiPaste.length] : textLines,\n        origin: origin || (paste ? "paste" : cm.state.cutIncoming > recent ? "cut" : "+input")\n      };\n      makeChange(cm.doc, changeEvent);\n      signalLater(cm, "inputRead", cm, changeEvent);\n    }\n\n    if (inserted && !paste) {\n      triggerElectric(cm, inserted);\n    }\n\n    ensureCursorVisible(cm);\n\n    if (cm.curOp.updateInput < 2) {\n      cm.curOp.updateInput = updateInput;\n    }\n\n    cm.curOp.typing = true;\n    cm.state.pasteIncoming = cm.state.cutIncoming = -1;\n  }\n\n  function handlePaste(e, cm) {\n    var pasted = e.clipboardData && e.clipboardData.getData("Text");\n\n    if (pasted) {\n      e.preventDefault();\n\n      if (!cm.isReadOnly() && !cm.options.disableInput) {\n        runInOp(cm, function () {\n          return applyTextInput(cm, pasted, 0, null, "paste");\n        });\n      }\n\n      return true;\n    }\n  }\n\n  function triggerElectric(cm, inserted) {\n    // When an \'electric\' character is inserted, immediately trigger a reindent\n    if (!cm.options.electricChars || !cm.options.smartIndent) {\n      return;\n    }\n\n    var sel = cm.doc.sel;\n\n    for (var i = sel.ranges.length - 1; i >= 0; i--) {\n      var range = sel.ranges[i];\n\n      if (range.head.ch > 100 || i && sel.ranges[i - 1].head.line == range.head.line) {\n        continue;\n      }\n\n      var mode = cm.getModeAt(range.head);\n      var indented = false;\n\n      if (mode.electricChars) {\n        for (var j = 0; j < mode.electricChars.length; j++) {\n          if (inserted.indexOf(mode.electricChars.charAt(j)) > -1) {\n            indented = indentLine(cm, range.head.line, "smart");\n            break;\n          }\n        }\n      } else if (mode.electricInput) {\n        if (mode.electricInput.test(getLine(cm.doc, range.head.line).text.slice(0, range.head.ch))) {\n          indented = indentLine(cm, range.head.line, "smart");\n        }\n      }\n\n      if (indented) {\n        signalLater(cm, "electricInput", cm, range.head.line);\n      }\n    }\n  }\n\n  function copyableRanges(cm) {\n    var text = [],\n        ranges = [];\n\n    for (var i = 0; i < cm.doc.sel.ranges.length; i++) {\n      var line = cm.doc.sel.ranges[i].head.line;\n      var lineRange = {\n        anchor: Pos(line, 0),\n        head: Pos(line + 1, 0)\n      };\n      ranges.push(lineRange);\n      text.push(cm.getRange(lineRange.anchor, lineRange.head));\n    }\n\n    return {\n      text: text,\n      ranges: ranges\n    };\n  }\n\n  function disableBrowserMagic(field, spellcheck, autocorrect, autocapitalize) {\n    field.setAttribute("autocorrect", autocorrect ? "" : "off");\n    field.setAttribute("autocapitalize", autocapitalize ? "" : "off");\n    field.setAttribute("spellcheck", !!spellcheck);\n  }\n\n  function hiddenTextarea() {\n    var te = elt("textarea", null, null, "position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none");\n    var div = elt("div", [te], null, "overflow: hidden; position: relative; width: 3px; height: 0px;"); // The textarea is kept positioned near the cursor to prevent the\n    // fact that it\'ll be scrolled into view on input from scrolling\n    // our fake cursor out of view. On webkit, when wrap=off, paste is\n    // very slow. So make the area wide instead.\n\n    if (webkit) {\n      te.style.width = "1000px";\n    } else {\n      te.setAttribute("wrap", "off");\n    } // If border: 0; -- iOS fails to open keyboard (issue #1287)\n\n\n    if (ios) {\n      te.style.border = "1px solid black";\n    }\n\n    disableBrowserMagic(te);\n    return div;\n  } // The publicly visible API. Note that methodOp(f) means\n  // \'wrap f in an operation, performed on its `this` parameter\'.\n  // This is not the complete set of editor methods. Most of the\n  // methods defined on the Doc type are also injected into\n  // CodeMirror.prototype, for backwards compatibility and\n  // convenience.\n\n\n  function addEditorMethods(CodeMirror) {\n    var optionHandlers = CodeMirror.optionHandlers;\n    var helpers = CodeMirror.helpers = {};\n    CodeMirror.prototype = {\n      constructor: CodeMirror,\n      focus: function focus() {\n        window.focus();\n        this.display.input.focus();\n      },\n      setOption: function setOption(option, value) {\n        var options = this.options,\n            old = options[option];\n\n        if (options[option] == value && option != "mode") {\n          return;\n        }\n\n        options[option] = value;\n\n        if (optionHandlers.hasOwnProperty(option)) {\n          operation(this, optionHandlers[option])(this, value, old);\n        }\n\n        signal(this, "optionChange", this, option);\n      },\n      getOption: function getOption(option) {\n        return this.options[option];\n      },\n      getDoc: function getDoc() {\n        return this.doc;\n      },\n      addKeyMap: function addKeyMap(map, bottom) {\n        this.state.keyMaps[bottom ? "push" : "unshift"](getKeyMap(map));\n      },\n      removeKeyMap: function removeKeyMap(map) {\n        var maps = this.state.keyMaps;\n\n        for (var i = 0; i < maps.length; ++i) {\n          if (maps[i] == map || maps[i].name == map) {\n            maps.splice(i, 1);\n            return true;\n          }\n        }\n      },\n      addOverlay: methodOp(function (spec, options) {\n        var mode = spec.token ? spec : CodeMirror.getMode(this.options, spec);\n\n        if (mode.startState) {\n          throw new Error("Overlays may not be stateful.");\n        }\n\n        insertSorted(this.state.overlays, {\n          mode: mode,\n          modeSpec: spec,\n          opaque: options && options.opaque,\n          priority: options && options.priority || 0\n        }, function (overlay) {\n          return overlay.priority;\n        });\n        this.state.modeGen++;\n        regChange(this);\n      }),\n      removeOverlay: methodOp(function (spec) {\n        var overlays = this.state.overlays;\n\n        for (var i = 0; i < overlays.length; ++i) {\n          var cur = overlays[i].modeSpec;\n\n          if (cur == spec || typeof spec == "string" && cur.name == spec) {\n            overlays.splice(i, 1);\n            this.state.modeGen++;\n            regChange(this);\n            return;\n          }\n        }\n      }),\n      indentLine: methodOp(function (n, dir, aggressive) {\n        if (typeof dir != "string" && typeof dir != "number") {\n          if (dir == null) {\n            dir = this.options.smartIndent ? "smart" : "prev";\n          } else {\n            dir = dir ? "add" : "subtract";\n          }\n        }\n\n        if (isLine(this.doc, n)) {\n          indentLine(this, n, dir, aggressive);\n        }\n      }),\n      indentSelection: methodOp(function (how) {\n        var ranges = this.doc.sel.ranges,\n            end = -1;\n\n        for (var i = 0; i < ranges.length; i++) {\n          var range = ranges[i];\n\n          if (!range.empty()) {\n            var from = range.from(),\n                to = range.to();\n            var start = Math.max(end, from.line);\n            end = Math.min(this.lastLine(), to.line - (to.ch ? 0 : 1)) + 1;\n\n            for (var j = start; j < end; ++j) {\n              indentLine(this, j, how);\n            }\n\n            var newRanges = this.doc.sel.ranges;\n\n            if (from.ch == 0 && ranges.length == newRanges.length && newRanges[i].from().ch > 0) {\n              replaceOneSelection(this.doc, i, new Range(from, newRanges[i].to()), sel_dontScroll);\n            }\n          } else if (range.head.line > end) {\n            indentLine(this, range.head.line, how, true);\n            end = range.head.line;\n\n            if (i == this.doc.sel.primIndex) {\n              ensureCursorVisible(this);\n            }\n          }\n        }\n      }),\n      // Fetch the parser token for a given character. Useful for hacks\n      // that want to inspect the mode state (say, for completion).\n      getTokenAt: function getTokenAt(pos, precise) {\n        return takeToken(this, pos, precise);\n      },\n      getLineTokens: function getLineTokens(line, precise) {\n        return takeToken(this, Pos(line), precise, true);\n      },\n      getTokenTypeAt: function getTokenTypeAt(pos) {\n        pos = _clipPos(this.doc, pos);\n        var styles = getLineStyles(this, getLine(this.doc, pos.line));\n        var before = 0,\n            after = (styles.length - 1) / 2,\n            ch = pos.ch;\n        var type;\n\n        if (ch == 0) {\n          type = styles[2];\n        } else {\n          for (;;) {\n            var mid = before + after >> 1;\n\n            if ((mid ? styles[mid * 2 - 1] : 0) >= ch) {\n              after = mid;\n            } else if (styles[mid * 2 + 1] < ch) {\n              before = mid + 1;\n            } else {\n              type = styles[mid * 2 + 2];\n              break;\n            }\n          }\n        }\n\n        var cut = type ? type.indexOf("overlay ") : -1;\n        return cut < 0 ? type : cut == 0 ? null : type.slice(0, cut - 1);\n      },\n      getModeAt: function getModeAt(pos) {\n        var mode = this.doc.mode;\n\n        if (!mode.innerMode) {\n          return mode;\n        }\n\n        return CodeMirror.innerMode(mode, this.getTokenAt(pos).state).mode;\n      },\n      getHelper: function getHelper(pos, type) {\n        return this.getHelpers(pos, type)[0];\n      },\n      getHelpers: function getHelpers(pos, type) {\n        var found = [];\n\n        if (!helpers.hasOwnProperty(type)) {\n          return found;\n        }\n\n        var help = helpers[type],\n            mode = this.getModeAt(pos);\n\n        if (typeof mode[type] == "string") {\n          if (help[mode[type]]) {\n            found.push(help[mode[type]]);\n          }\n        } else if (mode[type]) {\n          for (var i = 0; i < mode[type].length; i++) {\n            var val = help[mode[type][i]];\n\n            if (val) {\n              found.push(val);\n            }\n          }\n        } else if (mode.helperType && help[mode.helperType]) {\n          found.push(help[mode.helperType]);\n        } else if (help[mode.name]) {\n          found.push(help[mode.name]);\n        }\n\n        for (var i$1 = 0; i$1 < help._global.length; i$1++) {\n          var cur = help._global[i$1];\n\n          if (cur.pred(mode, this) && indexOf(found, cur.val) == -1) {\n            found.push(cur.val);\n          }\n        }\n\n        return found;\n      },\n      getStateAfter: function getStateAfter(line, precise) {\n        var doc = this.doc;\n        line = clipLine(doc, line == null ? doc.first + doc.size - 1 : line);\n        return getContextBefore(this, line + 1, precise).state;\n      },\n      cursorCoords: function cursorCoords(start, mode) {\n        var pos,\n            range = this.doc.sel.primary();\n\n        if (start == null) {\n          pos = range.head;\n        } else if (typeof start == "object") {\n          pos = _clipPos(this.doc, start);\n        } else {\n          pos = start ? range.from() : range.to();\n        }\n\n        return _cursorCoords(this, pos, mode || "page");\n      },\n      charCoords: function charCoords(pos, mode) {\n        return _charCoords(this, _clipPos(this.doc, pos), mode || "page");\n      },\n      coordsChar: function coordsChar(coords, mode) {\n        coords = fromCoordSystem(this, coords, mode || "page");\n        return _coordsChar(this, coords.left, coords.top);\n      },\n      lineAtHeight: function lineAtHeight(height, mode) {\n        height = fromCoordSystem(this, {\n          top: height,\n          left: 0\n        }, mode || "page").top;\n        return _lineAtHeight(this.doc, height + this.display.viewOffset);\n      },\n      heightAtLine: function heightAtLine(line, mode, includeWidgets) {\n        var end = false,\n            lineObj;\n\n        if (typeof line == "number") {\n          var last = this.doc.first + this.doc.size - 1;\n\n          if (line < this.doc.first) {\n            line = this.doc.first;\n          } else if (line > last) {\n            line = last;\n            end = true;\n          }\n\n          lineObj = getLine(this.doc, line);\n        } else {\n          lineObj = line;\n        }\n\n        return intoCoordSystem(this, lineObj, {\n          top: 0,\n          left: 0\n        }, mode || "page", includeWidgets || end).top + (end ? this.doc.height - _heightAtLine(lineObj) : 0);\n      },\n      defaultTextHeight: function defaultTextHeight() {\n        return textHeight(this.display);\n      },\n      defaultCharWidth: function defaultCharWidth() {\n        return charWidth(this.display);\n      },\n      getViewport: function getViewport() {\n        return {\n          from: this.display.viewFrom,\n          to: this.display.viewTo\n        };\n      },\n      addWidget: function addWidget(pos, node, scroll, vert, horiz) {\n        var display = this.display;\n        pos = _cursorCoords(this, _clipPos(this.doc, pos));\n        var top = pos.bottom,\n            left = pos.left;\n        node.style.position = "absolute";\n        node.setAttribute("cm-ignore-events", "true");\n        this.display.input.setUneditable(node);\n        display.sizer.appendChild(node);\n\n        if (vert == "over") {\n          top = pos.top;\n        } else if (vert == "above" || vert == "near") {\n          var vspace = Math.max(display.wrapper.clientHeight, this.doc.height),\n              hspace = Math.max(display.sizer.clientWidth, display.lineSpace.clientWidth); // Default to positioning above (if specified and possible); otherwise default to positioning below\n\n          if ((vert == \'above\' || pos.bottom + node.offsetHeight > vspace) && pos.top > node.offsetHeight) {\n            top = pos.top - node.offsetHeight;\n          } else if (pos.bottom + node.offsetHeight <= vspace) {\n            top = pos.bottom;\n          }\n\n          if (left + node.offsetWidth > hspace) {\n            left = hspace - node.offsetWidth;\n          }\n        }\n\n        node.style.top = top + "px";\n        node.style.left = node.style.right = "";\n\n        if (horiz == "right") {\n          left = display.sizer.clientWidth - node.offsetWidth;\n          node.style.right = "0px";\n        } else {\n          if (horiz == "left") {\n            left = 0;\n          } else if (horiz == "middle") {\n            left = (display.sizer.clientWidth - node.offsetWidth) / 2;\n          }\n\n          node.style.left = left + "px";\n        }\n\n        if (scroll) {\n          scrollIntoView(this, {\n            left: left,\n            top: top,\n            right: left + node.offsetWidth,\n            bottom: top + node.offsetHeight\n          });\n        }\n      },\n      triggerOnKeyDown: methodOp(onKeyDown),\n      triggerOnKeyPress: methodOp(onKeyPress),\n      triggerOnKeyUp: onKeyUp,\n      triggerOnMouseDown: methodOp(onMouseDown),\n      execCommand: function execCommand(cmd) {\n        if (commands.hasOwnProperty(cmd)) {\n          return commands[cmd].call(null, this);\n        }\n      },\n      triggerElectric: methodOp(function (text) {\n        triggerElectric(this, text);\n      }),\n      findPosH: function findPosH(from, amount, unit, visually) {\n        var dir = 1;\n\n        if (amount < 0) {\n          dir = -1;\n          amount = -amount;\n        }\n\n        var cur = _clipPos(this.doc, from);\n\n        for (var i = 0; i < amount; ++i) {\n          cur = _findPosH(this.doc, cur, dir, unit, visually);\n\n          if (cur.hitSide) {\n            break;\n          }\n        }\n\n        return cur;\n      },\n      moveH: methodOp(function (dir, unit) {\n        var this$1 = this;\n        this.extendSelectionsBy(function (range) {\n          if (this$1.display.shift || this$1.doc.extend || range.empty()) {\n            return _findPosH(this$1.doc, range.head, dir, unit, this$1.options.rtlMoveVisually);\n          } else {\n            return dir < 0 ? range.from() : range.to();\n          }\n        }, sel_move);\n      }),\n      deleteH: methodOp(function (dir, unit) {\n        var sel = this.doc.sel,\n            doc = this.doc;\n\n        if (sel.somethingSelected()) {\n          doc.replaceSelection("", null, "+delete");\n        } else {\n          deleteNearSelection(this, function (range) {\n            var other = _findPosH(doc, range.head, dir, unit, false);\n\n            return dir < 0 ? {\n              from: other,\n              to: range.head\n            } : {\n              from: range.head,\n              to: other\n            };\n          });\n        }\n      }),\n      findPosV: function findPosV(from, amount, unit, goalColumn) {\n        var dir = 1,\n            x = goalColumn;\n\n        if (amount < 0) {\n          dir = -1;\n          amount = -amount;\n        }\n\n        var cur = _clipPos(this.doc, from);\n\n        for (var i = 0; i < amount; ++i) {\n          var coords = _cursorCoords(this, cur, "div");\n\n          if (x == null) {\n            x = coords.left;\n          } else {\n            coords.left = x;\n          }\n\n          cur = _findPosV(this, coords, dir, unit);\n\n          if (cur.hitSide) {\n            break;\n          }\n        }\n\n        return cur;\n      },\n      moveV: methodOp(function (dir, unit) {\n        var this$1 = this;\n        var doc = this.doc,\n            goals = [];\n        var collapse = !this.display.shift && !doc.extend && doc.sel.somethingSelected();\n        doc.extendSelectionsBy(function (range) {\n          if (collapse) {\n            return dir < 0 ? range.from() : range.to();\n          }\n\n          var headPos = _cursorCoords(this$1, range.head, "div");\n\n          if (range.goalColumn != null) {\n            headPos.left = range.goalColumn;\n          }\n\n          goals.push(headPos.left);\n\n          var pos = _findPosV(this$1, headPos, dir, unit);\n\n          if (unit == "page" && range == doc.sel.primary()) {\n            addToScrollTop(this$1, _charCoords(this$1, pos, "div").top - headPos.top);\n          }\n\n          return pos;\n        }, sel_move);\n\n        if (goals.length) {\n          for (var i = 0; i < doc.sel.ranges.length; i++) {\n            doc.sel.ranges[i].goalColumn = goals[i];\n          }\n        }\n      }),\n      // Find the word at the given position (as returned by coordsChar).\n      findWordAt: function findWordAt(pos) {\n        var doc = this.doc,\n            line = getLine(doc, pos.line).text;\n        var start = pos.ch,\n            end = pos.ch;\n\n        if (line) {\n          var helper = this.getHelper(pos, "wordChars");\n\n          if ((pos.sticky == "before" || end == line.length) && start) {\n            --start;\n          } else {\n            ++end;\n          }\n\n          var startChar = line.charAt(start);\n          var check = isWordChar(startChar, helper) ? function (ch) {\n            return isWordChar(ch, helper);\n          } : /\\s/.test(startChar) ? function (ch) {\n            return /\\s/.test(ch);\n          } : function (ch) {\n            return !/\\s/.test(ch) && !isWordChar(ch);\n          };\n\n          while (start > 0 && check(line.charAt(start - 1))) {\n            --start;\n          }\n\n          while (end < line.length && check(line.charAt(end))) {\n            ++end;\n          }\n        }\n\n        return new Range(Pos(pos.line, start), Pos(pos.line, end));\n      },\n      toggleOverwrite: function toggleOverwrite(value) {\n        if (value != null && value == this.state.overwrite) {\n          return;\n        }\n\n        if (this.state.overwrite = !this.state.overwrite) {\n          addClass(this.display.cursorDiv, "CodeMirror-overwrite");\n        } else {\n          rmClass(this.display.cursorDiv, "CodeMirror-overwrite");\n        }\n\n        signal(this, "overwriteToggle", this, this.state.overwrite);\n      },\n      hasFocus: function hasFocus() {\n        return this.display.input.getField() == activeElt();\n      },\n      isReadOnly: function isReadOnly() {\n        return !!(this.options.readOnly || this.doc.cantEdit);\n      },\n      scrollTo: methodOp(function (x, y) {\n        scrollToCoords(this, x, y);\n      }),\n      getScrollInfo: function getScrollInfo() {\n        var scroller = this.display.scroller;\n        return {\n          left: scroller.scrollLeft,\n          top: scroller.scrollTop,\n          height: scroller.scrollHeight - scrollGap(this) - this.display.barHeight,\n          width: scroller.scrollWidth - scrollGap(this) - this.display.barWidth,\n          clientHeight: displayHeight(this),\n          clientWidth: displayWidth(this)\n        };\n      },\n      scrollIntoView: methodOp(function (range, margin) {\n        if (range == null) {\n          range = {\n            from: this.doc.sel.primary().head,\n            to: null\n          };\n\n          if (margin == null) {\n            margin = this.options.cursorScrollMargin;\n          }\n        } else if (typeof range == "number") {\n          range = {\n            from: Pos(range, 0),\n            to: null\n          };\n        } else if (range.from == null) {\n          range = {\n            from: range,\n            to: null\n          };\n        }\n\n        if (!range.to) {\n          range.to = range.from;\n        }\n\n        range.margin = margin || 0;\n\n        if (range.from.line != null) {\n          scrollToRange(this, range);\n        } else {\n          scrollToCoordsRange(this, range.from, range.to, range.margin);\n        }\n      }),\n      setSize: methodOp(function (width, height) {\n        var this$1 = this;\n\n        var interpret = function interpret(val) {\n          return typeof val == "number" || /^\\d+$/.test(String(val)) ? val + "px" : val;\n        };\n\n        if (width != null) {\n          this.display.wrapper.style.width = interpret(width);\n        }\n\n        if (height != null) {\n          this.display.wrapper.style.height = interpret(height);\n        }\n\n        if (this.options.lineWrapping) {\n          clearLineMeasurementCache(this);\n        }\n\n        var lineNo = this.display.viewFrom;\n        this.doc.iter(lineNo, this.display.viewTo, function (line) {\n          if (line.widgets) {\n            for (var i = 0; i < line.widgets.length; i++) {\n              if (line.widgets[i].noHScroll) {\n                regLineChange(this$1, lineNo, "widget");\n                break;\n              }\n            }\n          }\n\n          ++lineNo;\n        });\n        this.curOp.forceUpdate = true;\n        signal(this, "refresh", this);\n      }),\n      operation: function operation(f) {\n        return runInOp(this, f);\n      },\n      startOperation: function startOperation() {\n        return _startOperation(this);\n      },\n      endOperation: function endOperation() {\n        return _endOperation(this);\n      },\n      refresh: methodOp(function () {\n        var oldHeight = this.display.cachedTextHeight;\n        regChange(this);\n        this.curOp.forceUpdate = true;\n        clearCaches(this);\n        scrollToCoords(this, this.doc.scrollLeft, this.doc.scrollTop);\n        updateGutterSpace(this.display);\n\n        if (oldHeight == null || Math.abs(oldHeight - textHeight(this.display)) > .5) {\n          estimateLineHeights(this);\n        }\n\n        signal(this, "refresh", this);\n      }),\n      swapDoc: methodOp(function (doc) {\n        var old = this.doc;\n        old.cm = null; // Cancel the current text selection if any (#5821)\n\n        if (this.state.selectingText) {\n          this.state.selectingText();\n        }\n\n        attachDoc(this, doc);\n        clearCaches(this);\n        this.display.input.reset();\n        scrollToCoords(this, doc.scrollLeft, doc.scrollTop);\n        this.curOp.forceScroll = true;\n        signalLater(this, "swapDoc", this, old);\n        return old;\n      }),\n      phrase: function phrase(phraseText) {\n        var phrases = this.options.phrases;\n        return phrases && Object.prototype.hasOwnProperty.call(phrases, phraseText) ? phrases[phraseText] : phraseText;\n      },\n      getInputField: function getInputField() {\n        return this.display.input.getField();\n      },\n      getWrapperElement: function getWrapperElement() {\n        return this.display.wrapper;\n      },\n      getScrollerElement: function getScrollerElement() {\n        return this.display.scroller;\n      },\n      getGutterElement: function getGutterElement() {\n        return this.display.gutters;\n      }\n    };\n    eventMixin(CodeMirror);\n\n    CodeMirror.registerHelper = function (type, name, value) {\n      if (!helpers.hasOwnProperty(type)) {\n        helpers[type] = CodeMirror[type] = {\n          _global: []\n        };\n      }\n\n      helpers[type][name] = value;\n    };\n\n    CodeMirror.registerGlobalHelper = function (type, name, predicate, value) {\n      CodeMirror.registerHelper(type, name, value);\n\n      helpers[type]._global.push({\n        pred: predicate,\n        val: value\n      });\n    };\n  } // Used for horizontal relative motion. Dir is -1 or 1 (left or\n  // right), unit can be "char", "column" (like char, but doesn\'t\n  // cross line boundaries), "word" (across next word), or "group" (to\n  // the start of next group of word or non-word-non-whitespace\n  // chars). The visually param controls whether, in right-to-left\n  // text, direction 1 means to move towards the next index in the\n  // string, or towards the character to the right of the current\n  // position. The resulting position will have a hitSide=true\n  // property if it reached the end of the document.\n\n\n  function _findPosH(doc, pos, dir, unit, visually) {\n    var oldPos = pos;\n    var origDir = dir;\n    var lineObj = getLine(doc, pos.line);\n\n    function findNextLine() {\n      var l = pos.line + dir;\n\n      if (l < doc.first || l >= doc.first + doc.size) {\n        return false;\n      }\n\n      pos = new Pos(l, pos.ch, pos.sticky);\n      return lineObj = getLine(doc, l);\n    }\n\n    function moveOnce(boundToLine) {\n      var next;\n\n      if (visually) {\n        next = moveVisually(doc.cm, lineObj, pos, dir);\n      } else {\n        next = moveLogically(lineObj, pos, dir);\n      }\n\n      if (next == null) {\n        if (!boundToLine && findNextLine()) {\n          pos = endOfLine(visually, doc.cm, lineObj, pos.line, dir);\n        } else {\n          return false;\n        }\n      } else {\n        pos = next;\n      }\n\n      return true;\n    }\n\n    if (unit == "char") {\n      moveOnce();\n    } else if (unit == "column") {\n      moveOnce(true);\n    } else if (unit == "word" || unit == "group") {\n      var sawType = null,\n          group = unit == "group";\n      var helper = doc.cm && doc.cm.getHelper(pos, "wordChars");\n\n      for (var first = true;; first = false) {\n        if (dir < 0 && !moveOnce(!first)) {\n          break;\n        }\n\n        var cur = lineObj.text.charAt(pos.ch) || "\\n";\n        var type = isWordChar(cur, helper) ? "w" : group && cur == "\\n" ? "n" : !group || /\\s/.test(cur) ? null : "p";\n\n        if (group && !first && !type) {\n          type = "s";\n        }\n\n        if (sawType && sawType != type) {\n          if (dir < 0) {\n            dir = 1;\n            moveOnce();\n            pos.sticky = "after";\n          }\n\n          break;\n        }\n\n        if (type) {\n          sawType = type;\n        }\n\n        if (dir > 0 && !moveOnce(!first)) {\n          break;\n        }\n      }\n    }\n\n    var result = skipAtomic(doc, pos, oldPos, origDir, true);\n\n    if (equalCursorPos(oldPos, result)) {\n      result.hitSide = true;\n    }\n\n    return result;\n  } // For relative vertical movement. Dir may be -1 or 1. Unit can be\n  // "page" or "line". The resulting position will have a hitSide=true\n  // property if it reached the end of the document.\n\n\n  function _findPosV(cm, pos, dir, unit) {\n    var doc = cm.doc,\n        x = pos.left,\n        y;\n\n    if (unit == "page") {\n      var pageSize = Math.min(cm.display.wrapper.clientHeight, window.innerHeight || document.documentElement.clientHeight);\n      var moveAmount = Math.max(pageSize - .5 * textHeight(cm.display), 3);\n      y = (dir > 0 ? pos.bottom : pos.top) + dir * moveAmount;\n    } else if (unit == "line") {\n      y = dir > 0 ? pos.bottom + 3 : pos.top - 3;\n    }\n\n    var target;\n\n    for (;;) {\n      target = _coordsChar(cm, x, y);\n\n      if (!target.outside) {\n        break;\n      }\n\n      if (dir < 0 ? y <= 0 : y >= doc.height) {\n        target.hitSide = true;\n        break;\n      }\n\n      y += dir * 5;\n    }\n\n    return target;\n  } // CONTENTEDITABLE INPUT STYLE\n\n\n  var ContentEditableInput = function ContentEditableInput(cm) {\n    this.cm = cm;\n    this.lastAnchorNode = this.lastAnchorOffset = this.lastFocusNode = this.lastFocusOffset = null;\n    this.polling = new Delayed();\n    this.composing = null;\n    this.gracePeriod = false;\n    this.readDOMTimeout = null;\n  };\n\n  ContentEditableInput.prototype.init = function (display) {\n    var this$1 = this;\n    var input = this,\n        cm = input.cm;\n    var div = input.div = display.lineDiv;\n    disableBrowserMagic(div, cm.options.spellcheck, cm.options.autocorrect, cm.options.autocapitalize);\n    on(div, "paste", function (e) {\n      if (signalDOMEvent(cm, e) || handlePaste(e, cm)) {\n        return;\n      } // IE doesn\'t fire input events, so we schedule a read for the pasted content in this way\n\n\n      if (ie_version <= 11) {\n        setTimeout(operation(cm, function () {\n          return this$1.updateFromDOM();\n        }), 20);\n      }\n    });\n    on(div, "compositionstart", function (e) {\n      this$1.composing = {\n        data: e.data,\n        done: false\n      };\n    });\n    on(div, "compositionupdate", function (e) {\n      if (!this$1.composing) {\n        this$1.composing = {\n          data: e.data,\n          done: false\n        };\n      }\n    });\n    on(div, "compositionend", function (e) {\n      if (this$1.composing) {\n        if (e.data != this$1.composing.data) {\n          this$1.readFromDOMSoon();\n        }\n\n        this$1.composing.done = true;\n      }\n    });\n    on(div, "touchstart", function () {\n      return input.forceCompositionEnd();\n    });\n    on(div, "input", function () {\n      if (!this$1.composing) {\n        this$1.readFromDOMSoon();\n      }\n    });\n\n    function onCopyCut(e) {\n      if (signalDOMEvent(cm, e)) {\n        return;\n      }\n\n      if (cm.somethingSelected()) {\n        setLastCopied({\n          lineWise: false,\n          text: cm.getSelections()\n        });\n\n        if (e.type == "cut") {\n          cm.replaceSelection("", null, "cut");\n        }\n      } else if (!cm.options.lineWiseCopyCut) {\n        return;\n      } else {\n        var ranges = copyableRanges(cm);\n        setLastCopied({\n          lineWise: true,\n          text: ranges.text\n        });\n\n        if (e.type == "cut") {\n          cm.operation(function () {\n            cm.setSelections(ranges.ranges, 0, sel_dontScroll);\n            cm.replaceSelection("", null, "cut");\n          });\n        }\n      }\n\n      if (e.clipboardData) {\n        e.clipboardData.clearData();\n        var content = lastCopied.text.join("\\n"); // iOS exposes the clipboard API, but seems to discard content inserted into it\n\n        e.clipboardData.setData("Text", content);\n\n        if (e.clipboardData.getData("Text") == content) {\n          e.preventDefault();\n          return;\n        }\n      } // Old-fashioned briefly-focus-a-textarea hack\n\n\n      var kludge = hiddenTextarea(),\n          te = kludge.firstChild;\n      cm.display.lineSpace.insertBefore(kludge, cm.display.lineSpace.firstChild);\n      te.value = lastCopied.text.join("\\n");\n      var hadFocus = document.activeElement;\n      selectInput(te);\n      setTimeout(function () {\n        cm.display.lineSpace.removeChild(kludge);\n        hadFocus.focus();\n\n        if (hadFocus == div) {\n          input.showPrimarySelection();\n        }\n      }, 50);\n    }\n\n    on(div, "copy", onCopyCut);\n    on(div, "cut", onCopyCut);\n  };\n\n  ContentEditableInput.prototype.prepareSelection = function () {\n    var result = prepareSelection(this.cm, false);\n    result.focus = this.cm.state.focused;\n    return result;\n  };\n\n  ContentEditableInput.prototype.showSelection = function (info, takeFocus) {\n    if (!info || !this.cm.display.view.length) {\n      return;\n    }\n\n    if (info.focus || takeFocus) {\n      this.showPrimarySelection();\n    }\n\n    this.showMultipleSelections(info);\n  };\n\n  ContentEditableInput.prototype.getSelection = function () {\n    return this.cm.display.wrapper.ownerDocument.getSelection();\n  };\n\n  ContentEditableInput.prototype.showPrimarySelection = function () {\n    var sel = this.getSelection(),\n        cm = this.cm,\n        prim = cm.doc.sel.primary();\n    var from = prim.from(),\n        to = prim.to();\n\n    if (cm.display.viewTo == cm.display.viewFrom || from.line >= cm.display.viewTo || to.line < cm.display.viewFrom) {\n      sel.removeAllRanges();\n      return;\n    }\n\n    var curAnchor = domToPos(cm, sel.anchorNode, sel.anchorOffset);\n    var curFocus = domToPos(cm, sel.focusNode, sel.focusOffset);\n\n    if (curAnchor && !curAnchor.bad && curFocus && !curFocus.bad && cmp(minPos(curAnchor, curFocus), from) == 0 && cmp(maxPos(curAnchor, curFocus), to) == 0) {\n      return;\n    }\n\n    var view = cm.display.view;\n    var start = from.line >= cm.display.viewFrom && posToDOM(cm, from) || {\n      node: view[0].measure.map[2],\n      offset: 0\n    };\n    var end = to.line < cm.display.viewTo && posToDOM(cm, to);\n\n    if (!end) {\n      var measure = view[view.length - 1].measure;\n      var map = measure.maps ? measure.maps[measure.maps.length - 1] : measure.map;\n      end = {\n        node: map[map.length - 1],\n        offset: map[map.length - 2] - map[map.length - 3]\n      };\n    }\n\n    if (!start || !end) {\n      sel.removeAllRanges();\n      return;\n    }\n\n    var old = sel.rangeCount && sel.getRangeAt(0),\n        rng;\n\n    try {\n      rng = range(start.node, start.offset, end.offset, end.node);\n    } catch (e) {} // Our model of the DOM might be outdated, in which case the range we try to set can be impossible\n\n\n    if (rng) {\n      if (!gecko && cm.state.focused) {\n        sel.collapse(start.node, start.offset);\n\n        if (!rng.collapsed) {\n          sel.removeAllRanges();\n          sel.addRange(rng);\n        }\n      } else {\n        sel.removeAllRanges();\n        sel.addRange(rng);\n      }\n\n      if (old && sel.anchorNode == null) {\n        sel.addRange(old);\n      } else if (gecko) {\n        this.startGracePeriod();\n      }\n    }\n\n    this.rememberSelection();\n  };\n\n  ContentEditableInput.prototype.startGracePeriod = function () {\n    var this$1 = this;\n    clearTimeout(this.gracePeriod);\n    this.gracePeriod = setTimeout(function () {\n      this$1.gracePeriod = false;\n\n      if (this$1.selectionChanged()) {\n        this$1.cm.operation(function () {\n          return this$1.cm.curOp.selectionChanged = true;\n        });\n      }\n    }, 20);\n  };\n\n  ContentEditableInput.prototype.showMultipleSelections = function (info) {\n    removeChildrenAndAdd(this.cm.display.cursorDiv, info.cursors);\n    removeChildrenAndAdd(this.cm.display.selectionDiv, info.selection);\n  };\n\n  ContentEditableInput.prototype.rememberSelection = function () {\n    var sel = this.getSelection();\n    this.lastAnchorNode = sel.anchorNode;\n    this.lastAnchorOffset = sel.anchorOffset;\n    this.lastFocusNode = sel.focusNode;\n    this.lastFocusOffset = sel.focusOffset;\n  };\n\n  ContentEditableInput.prototype.selectionInEditor = function () {\n    var sel = this.getSelection();\n\n    if (!sel.rangeCount) {\n      return false;\n    }\n\n    var node = sel.getRangeAt(0).commonAncestorContainer;\n    return contains(this.div, node);\n  };\n\n  ContentEditableInput.prototype.focus = function () {\n    if (this.cm.options.readOnly != "nocursor") {\n      if (!this.selectionInEditor()) {\n        this.showSelection(this.prepareSelection(), true);\n      }\n\n      this.div.focus();\n    }\n  };\n\n  ContentEditableInput.prototype.blur = function () {\n    this.div.blur();\n  };\n\n  ContentEditableInput.prototype.getField = function () {\n    return this.div;\n  };\n\n  ContentEditableInput.prototype.supportsTouch = function () {\n    return true;\n  };\n\n  ContentEditableInput.prototype.receivedFocus = function () {\n    var input = this;\n\n    if (this.selectionInEditor()) {\n      this.pollSelection();\n    } else {\n      runInOp(this.cm, function () {\n        return input.cm.curOp.selectionChanged = true;\n      });\n    }\n\n    function poll() {\n      if (input.cm.state.focused) {\n        input.pollSelection();\n        input.polling.set(input.cm.options.pollInterval, poll);\n      }\n    }\n\n    this.polling.set(this.cm.options.pollInterval, poll);\n  };\n\n  ContentEditableInput.prototype.selectionChanged = function () {\n    var sel = this.getSelection();\n    return sel.anchorNode != this.lastAnchorNode || sel.anchorOffset != this.lastAnchorOffset || sel.focusNode != this.lastFocusNode || sel.focusOffset != this.lastFocusOffset;\n  };\n\n  ContentEditableInput.prototype.pollSelection = function () {\n    if (this.readDOMTimeout != null || this.gracePeriod || !this.selectionChanged()) {\n      return;\n    }\n\n    var sel = this.getSelection(),\n        cm = this.cm; // On Android Chrome (version 56, at least), backspacing into an\n    // uneditable block element will put the cursor in that element,\n    // and then, because it\'s not editable, hide the virtual keyboard.\n    // Because Android doesn\'t allow us to actually detect backspace\n    // presses in a sane way, this code checks for when that happens\n    // and simulates a backspace press in this case.\n\n    if (android && chrome && this.cm.display.gutterSpecs.length && isInGutter(sel.anchorNode)) {\n      this.cm.triggerOnKeyDown({\n        type: "keydown",\n        keyCode: 8,\n        preventDefault: Math.abs\n      });\n      this.blur();\n      this.focus();\n      return;\n    }\n\n    if (this.composing) {\n      return;\n    }\n\n    this.rememberSelection();\n    var anchor = domToPos(cm, sel.anchorNode, sel.anchorOffset);\n    var head = domToPos(cm, sel.focusNode, sel.focusOffset);\n\n    if (anchor && head) {\n      runInOp(cm, function () {\n        setSelection(cm.doc, simpleSelection(anchor, head), sel_dontScroll);\n\n        if (anchor.bad || head.bad) {\n          cm.curOp.selectionChanged = true;\n        }\n      });\n    }\n  };\n\n  ContentEditableInput.prototype.pollContent = function () {\n    if (this.readDOMTimeout != null) {\n      clearTimeout(this.readDOMTimeout);\n      this.readDOMTimeout = null;\n    }\n\n    var cm = this.cm,\n        display = cm.display,\n        sel = cm.doc.sel.primary();\n    var from = sel.from(),\n        to = sel.to();\n\n    if (from.ch == 0 && from.line > cm.firstLine()) {\n      from = Pos(from.line - 1, getLine(cm.doc, from.line - 1).length);\n    }\n\n    if (to.ch == getLine(cm.doc, to.line).text.length && to.line < cm.lastLine()) {\n      to = Pos(to.line + 1, 0);\n    }\n\n    if (from.line < display.viewFrom || to.line > display.viewTo - 1) {\n      return false;\n    }\n\n    var fromIndex, fromLine, fromNode;\n\n    if (from.line == display.viewFrom || (fromIndex = findViewIndex(cm, from.line)) == 0) {\n      fromLine = lineNo(display.view[0].line);\n      fromNode = display.view[0].node;\n    } else {\n      fromLine = lineNo(display.view[fromIndex].line);\n      fromNode = display.view[fromIndex - 1].node.nextSibling;\n    }\n\n    var toIndex = findViewIndex(cm, to.line);\n    var toLine, toNode;\n\n    if (toIndex == display.view.length - 1) {\n      toLine = display.viewTo - 1;\n      toNode = display.lineDiv.lastChild;\n    } else {\n      toLine = lineNo(display.view[toIndex + 1].line) - 1;\n      toNode = display.view[toIndex + 1].node.previousSibling;\n    }\n\n    if (!fromNode) {\n      return false;\n    }\n\n    var newText = cm.doc.splitLines(domTextBetween(cm, fromNode, toNode, fromLine, toLine));\n    var oldText = getBetween(cm.doc, Pos(fromLine, 0), Pos(toLine, getLine(cm.doc, toLine).text.length));\n\n    while (newText.length > 1 && oldText.length > 1) {\n      if (lst(newText) == lst(oldText)) {\n        newText.pop();\n        oldText.pop();\n        toLine--;\n      } else if (newText[0] == oldText[0]) {\n        newText.shift();\n        oldText.shift();\n        fromLine++;\n      } else {\n        break;\n      }\n    }\n\n    var cutFront = 0,\n        cutEnd = 0;\n    var newTop = newText[0],\n        oldTop = oldText[0],\n        maxCutFront = Math.min(newTop.length, oldTop.length);\n\n    while (cutFront < maxCutFront && newTop.charCodeAt(cutFront) == oldTop.charCodeAt(cutFront)) {\n      ++cutFront;\n    }\n\n    var newBot = lst(newText),\n        oldBot = lst(oldText);\n    var maxCutEnd = Math.min(newBot.length - (newText.length == 1 ? cutFront : 0), oldBot.length - (oldText.length == 1 ? cutFront : 0));\n\n    while (cutEnd < maxCutEnd && newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1)) {\n      ++cutEnd;\n    } // Try to move start of change to start of selection if ambiguous\n\n\n    if (newText.length == 1 && oldText.length == 1 && fromLine == from.line) {\n      while (cutFront && cutFront > from.ch && newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1)) {\n        cutFront--;\n        cutEnd++;\n      }\n    }\n\n    newText[newText.length - 1] = newBot.slice(0, newBot.length - cutEnd).replace(/^\\u200b+/, "");\n    newText[0] = newText[0].slice(cutFront).replace(/\\u200b+$/, "");\n    var chFrom = Pos(fromLine, cutFront);\n    var chTo = Pos(toLine, oldText.length ? lst(oldText).length - cutEnd : 0);\n\n    if (newText.length > 1 || newText[0] || cmp(chFrom, chTo)) {\n      _replaceRange(cm.doc, newText, chFrom, chTo, "+input");\n\n      return true;\n    }\n  };\n\n  ContentEditableInput.prototype.ensurePolled = function () {\n    this.forceCompositionEnd();\n  };\n\n  ContentEditableInput.prototype.reset = function () {\n    this.forceCompositionEnd();\n  };\n\n  ContentEditableInput.prototype.forceCompositionEnd = function () {\n    if (!this.composing) {\n      return;\n    }\n\n    clearTimeout(this.readDOMTimeout);\n    this.composing = null;\n    this.updateFromDOM();\n    this.div.blur();\n    this.div.focus();\n  };\n\n  ContentEditableInput.prototype.readFromDOMSoon = function () {\n    var this$1 = this;\n\n    if (this.readDOMTimeout != null) {\n      return;\n    }\n\n    this.readDOMTimeout = setTimeout(function () {\n      this$1.readDOMTimeout = null;\n\n      if (this$1.composing) {\n        if (this$1.composing.done) {\n          this$1.composing = null;\n        } else {\n          return;\n        }\n      }\n\n      this$1.updateFromDOM();\n    }, 80);\n  };\n\n  ContentEditableInput.prototype.updateFromDOM = function () {\n    var this$1 = this;\n\n    if (this.cm.isReadOnly() || !this.pollContent()) {\n      runInOp(this.cm, function () {\n        return regChange(this$1.cm);\n      });\n    }\n  };\n\n  ContentEditableInput.prototype.setUneditable = function (node) {\n    node.contentEditable = "false";\n  };\n\n  ContentEditableInput.prototype.onKeyPress = function (e) {\n    if (e.charCode == 0 || this.composing) {\n      return;\n    }\n\n    e.preventDefault();\n\n    if (!this.cm.isReadOnly()) {\n      operation(this.cm, applyTextInput)(this.cm, String.fromCharCode(e.charCode == null ? e.keyCode : e.charCode), 0);\n    }\n  };\n\n  ContentEditableInput.prototype.readOnlyChanged = function (val) {\n    this.div.contentEditable = String(val != "nocursor");\n  };\n\n  ContentEditableInput.prototype.onContextMenu = function () {};\n\n  ContentEditableInput.prototype.resetPosition = function () {};\n\n  ContentEditableInput.prototype.needsContentAttribute = true;\n\n  function posToDOM(cm, pos) {\n    var view = findViewForLine(cm, pos.line);\n\n    if (!view || view.hidden) {\n      return null;\n    }\n\n    var line = getLine(cm.doc, pos.line);\n    var info = mapFromLineView(view, line, pos.line);\n    var order = getOrder(line, cm.doc.direction),\n        side = "left";\n\n    if (order) {\n      var partPos = getBidiPartAt(order, pos.ch);\n      side = partPos % 2 ? "right" : "left";\n    }\n\n    var result = nodeAndOffsetInLineMap(info.map, pos.ch, side);\n    result.offset = result.collapse == "right" ? result.end : result.start;\n    return result;\n  }\n\n  function isInGutter(node) {\n    for (var scan = node; scan; scan = scan.parentNode) {\n      if (/CodeMirror-gutter-wrapper/.test(scan.className)) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  function badPos(pos, bad) {\n    if (bad) {\n      pos.bad = true;\n    }\n\n    return pos;\n  }\n\n  function domTextBetween(cm, from, to, fromLine, toLine) {\n    var text = "",\n        closing = false,\n        lineSep = cm.doc.lineSeparator(),\n        extraLinebreak = false;\n\n    function recognizeMarker(id) {\n      return function (marker) {\n        return marker.id == id;\n      };\n    }\n\n    function close() {\n      if (closing) {\n        text += lineSep;\n\n        if (extraLinebreak) {\n          text += lineSep;\n        }\n\n        closing = extraLinebreak = false;\n      }\n    }\n\n    function addText(str) {\n      if (str) {\n        close();\n        text += str;\n      }\n    }\n\n    function walk(node) {\n      if (node.nodeType == 1) {\n        var cmText = node.getAttribute("cm-text");\n\n        if (cmText) {\n          addText(cmText);\n          return;\n        }\n\n        var markerID = node.getAttribute("cm-marker"),\n            range;\n\n        if (markerID) {\n          var found = cm.findMarks(Pos(fromLine, 0), Pos(toLine + 1, 0), recognizeMarker(+markerID));\n\n          if (found.length && (range = found[0].find(0))) {\n            addText(getBetween(cm.doc, range.from, range.to).join(lineSep));\n          }\n\n          return;\n        }\n\n        if (node.getAttribute("contenteditable") == "false") {\n          return;\n        }\n\n        var isBlock = /^(pre|div|p|li|table|br)$/i.test(node.nodeName);\n\n        if (!/^br$/i.test(node.nodeName) && node.textContent.length == 0) {\n          return;\n        }\n\n        if (isBlock) {\n          close();\n        }\n\n        for (var i = 0; i < node.childNodes.length; i++) {\n          walk(node.childNodes[i]);\n        }\n\n        if (/^(pre|p)$/i.test(node.nodeName)) {\n          extraLinebreak = true;\n        }\n\n        if (isBlock) {\n          closing = true;\n        }\n      } else if (node.nodeType == 3) {\n        addText(node.nodeValue.replace(/\\u200b/g, "").replace(/\\u00a0/g, " "));\n      }\n    }\n\n    for (;;) {\n      walk(from);\n\n      if (from == to) {\n        break;\n      }\n\n      from = from.nextSibling;\n      extraLinebreak = false;\n    }\n\n    return text;\n  }\n\n  function domToPos(cm, node, offset) {\n    var lineNode;\n\n    if (node == cm.display.lineDiv) {\n      lineNode = cm.display.lineDiv.childNodes[offset];\n\n      if (!lineNode) {\n        return badPos(cm.clipPos(Pos(cm.display.viewTo - 1)), true);\n      }\n\n      node = null;\n      offset = 0;\n    } else {\n      for (lineNode = node;; lineNode = lineNode.parentNode) {\n        if (!lineNode || lineNode == cm.display.lineDiv) {\n          return null;\n        }\n\n        if (lineNode.parentNode && lineNode.parentNode == cm.display.lineDiv) {\n          break;\n        }\n      }\n    }\n\n    for (var i = 0; i < cm.display.view.length; i++) {\n      var lineView = cm.display.view[i];\n\n      if (lineView.node == lineNode) {\n        return locateNodeInLineView(lineView, node, offset);\n      }\n    }\n  }\n\n  function locateNodeInLineView(lineView, node, offset) {\n    var wrapper = lineView.text.firstChild,\n        bad = false;\n\n    if (!node || !contains(wrapper, node)) {\n      return badPos(Pos(lineNo(lineView.line), 0), true);\n    }\n\n    if (node == wrapper) {\n      bad = true;\n      node = wrapper.childNodes[offset];\n      offset = 0;\n\n      if (!node) {\n        var line = lineView.rest ? lst(lineView.rest) : lineView.line;\n        return badPos(Pos(lineNo(line), line.text.length), bad);\n      }\n    }\n\n    var textNode = node.nodeType == 3 ? node : null,\n        topNode = node;\n\n    if (!textNode && node.childNodes.length == 1 && node.firstChild.nodeType == 3) {\n      textNode = node.firstChild;\n\n      if (offset) {\n        offset = textNode.nodeValue.length;\n      }\n    }\n\n    while (topNode.parentNode != wrapper) {\n      topNode = topNode.parentNode;\n    }\n\n    var measure = lineView.measure,\n        maps = measure.maps;\n\n    function find(textNode, topNode, offset) {\n      for (var i = -1; i < (maps ? maps.length : 0); i++) {\n        var map = i < 0 ? measure.map : maps[i];\n\n        for (var j = 0; j < map.length; j += 3) {\n          var curNode = map[j + 2];\n\n          if (curNode == textNode || curNode == topNode) {\n            var line = lineNo(i < 0 ? lineView.line : lineView.rest[i]);\n            var ch = map[j] + offset;\n\n            if (offset < 0 || curNode != textNode) {\n              ch = map[j + (offset ? 1 : 0)];\n            }\n\n            return Pos(line, ch);\n          }\n        }\n      }\n    }\n\n    var found = find(textNode, topNode, offset);\n\n    if (found) {\n      return badPos(found, bad);\n    } // FIXME this is all really shaky. might handle the few cases it needs to handle, but likely to cause problems\n\n\n    for (var after = topNode.nextSibling, dist = textNode ? textNode.nodeValue.length - offset : 0; after; after = after.nextSibling) {\n      found = find(after, after.firstChild, 0);\n\n      if (found) {\n        return badPos(Pos(found.line, found.ch - dist), bad);\n      } else {\n        dist += after.textContent.length;\n      }\n    }\n\n    for (var before = topNode.previousSibling, dist$1 = offset; before; before = before.previousSibling) {\n      found = find(before, before.firstChild, -1);\n\n      if (found) {\n        return badPos(Pos(found.line, found.ch + dist$1), bad);\n      } else {\n        dist$1 += before.textContent.length;\n      }\n    }\n  } // TEXTAREA INPUT STYLE\n\n\n  var TextareaInput = function TextareaInput(cm) {\n    this.cm = cm; // See input.poll and input.reset\n\n    this.prevInput = ""; // Flag that indicates whether we expect input to appear real soon\n    // now (after some event like \'keypress\' or \'input\') and are\n    // polling intensively.\n\n    this.pollingFast = false; // Self-resetting timeout for the poller\n\n    this.polling = new Delayed(); // Used to work around IE issue with selection being forgotten when focus moves away from textarea\n\n    this.hasSelection = false;\n    this.composing = null;\n  };\n\n  TextareaInput.prototype.init = function (display) {\n    var this$1 = this;\n    var input = this,\n        cm = this.cm;\n    this.createField(display);\n    var te = this.textarea;\n    display.wrapper.insertBefore(this.wrapper, display.wrapper.firstChild); // Needed to hide big blue blinking cursor on Mobile Safari (doesn\'t seem to work in iOS 8 anymore)\n\n    if (ios) {\n      te.style.width = "0px";\n    }\n\n    on(te, "input", function () {\n      if (ie && ie_version >= 9 && this$1.hasSelection) {\n        this$1.hasSelection = null;\n      }\n\n      input.poll();\n    });\n    on(te, "paste", function (e) {\n      if (signalDOMEvent(cm, e) || handlePaste(e, cm)) {\n        return;\n      }\n\n      cm.state.pasteIncoming = +new Date();\n      input.fastPoll();\n    });\n\n    function prepareCopyCut(e) {\n      if (signalDOMEvent(cm, e)) {\n        return;\n      }\n\n      if (cm.somethingSelected()) {\n        setLastCopied({\n          lineWise: false,\n          text: cm.getSelections()\n        });\n      } else if (!cm.options.lineWiseCopyCut) {\n        return;\n      } else {\n        var ranges = copyableRanges(cm);\n        setLastCopied({\n          lineWise: true,\n          text: ranges.text\n        });\n\n        if (e.type == "cut") {\n          cm.setSelections(ranges.ranges, null, sel_dontScroll);\n        } else {\n          input.prevInput = "";\n          te.value = ranges.text.join("\\n");\n          selectInput(te);\n        }\n      }\n\n      if (e.type == "cut") {\n        cm.state.cutIncoming = +new Date();\n      }\n    }\n\n    on(te, "cut", prepareCopyCut);\n    on(te, "copy", prepareCopyCut);\n    on(display.scroller, "paste", function (e) {\n      if (eventInWidget(display, e) || signalDOMEvent(cm, e)) {\n        return;\n      }\n\n      if (!te.dispatchEvent) {\n        cm.state.pasteIncoming = +new Date();\n        input.focus();\n        return;\n      } // Pass the `paste` event to the textarea so it\'s handled by its event listener.\n\n\n      var event = new Event("paste");\n      event.clipboardData = e.clipboardData;\n      te.dispatchEvent(event);\n    }); // Prevent normal selection in the editor (we handle our own)\n\n    on(display.lineSpace, "selectstart", function (e) {\n      if (!eventInWidget(display, e)) {\n        e_preventDefault(e);\n      }\n    });\n    on(te, "compositionstart", function () {\n      var start = cm.getCursor("from");\n\n      if (input.composing) {\n        input.composing.range.clear();\n      }\n\n      input.composing = {\n        start: start,\n        range: cm.markText(start, cm.getCursor("to"), {\n          className: "CodeMirror-composing"\n        })\n      };\n    });\n    on(te, "compositionend", function () {\n      if (input.composing) {\n        input.poll();\n        input.composing.range.clear();\n        input.composing = null;\n      }\n    });\n  };\n\n  TextareaInput.prototype.createField = function (_display) {\n    // Wraps and hides input textarea\n    this.wrapper = hiddenTextarea(); // The semihidden textarea that is focused when the editor is\n    // focused, and receives input.\n\n    this.textarea = this.wrapper.firstChild;\n  };\n\n  TextareaInput.prototype.prepareSelection = function () {\n    // Redraw the selection and/or cursor\n    var cm = this.cm,\n        display = cm.display,\n        doc = cm.doc;\n    var result = prepareSelection(cm); // Move the hidden textarea near the cursor to prevent scrolling artifacts\n\n    if (cm.options.moveInputWithCursor) {\n      var headPos = _cursorCoords(cm, doc.sel.primary().head, "div");\n\n      var wrapOff = display.wrapper.getBoundingClientRect(),\n          lineOff = display.lineDiv.getBoundingClientRect();\n      result.teTop = Math.max(0, Math.min(display.wrapper.clientHeight - 10, headPos.top + lineOff.top - wrapOff.top));\n      result.teLeft = Math.max(0, Math.min(display.wrapper.clientWidth - 10, headPos.left + lineOff.left - wrapOff.left));\n    }\n\n    return result;\n  };\n\n  TextareaInput.prototype.showSelection = function (drawn) {\n    var cm = this.cm,\n        display = cm.display;\n    removeChildrenAndAdd(display.cursorDiv, drawn.cursors);\n    removeChildrenAndAdd(display.selectionDiv, drawn.selection);\n\n    if (drawn.teTop != null) {\n      this.wrapper.style.top = drawn.teTop + "px";\n      this.wrapper.style.left = drawn.teLeft + "px";\n    }\n  }; // Reset the input to correspond to the selection (or to be empty,\n  // when not typing and nothing is selected)\n\n\n  TextareaInput.prototype.reset = function (typing) {\n    if (this.contextMenuPending || this.composing) {\n      return;\n    }\n\n    var cm = this.cm;\n\n    if (cm.somethingSelected()) {\n      this.prevInput = "";\n      var content = cm.getSelection();\n      this.textarea.value = content;\n\n      if (cm.state.focused) {\n        selectInput(this.textarea);\n      }\n\n      if (ie && ie_version >= 9) {\n        this.hasSelection = content;\n      }\n    } else if (!typing) {\n      this.prevInput = this.textarea.value = "";\n\n      if (ie && ie_version >= 9) {\n        this.hasSelection = null;\n      }\n    }\n  };\n\n  TextareaInput.prototype.getField = function () {\n    return this.textarea;\n  };\n\n  TextareaInput.prototype.supportsTouch = function () {\n    return false;\n  };\n\n  TextareaInput.prototype.focus = function () {\n    if (this.cm.options.readOnly != "nocursor" && (!mobile || activeElt() != this.textarea)) {\n      try {\n        this.textarea.focus();\n      } catch (e) {} // IE8 will throw if the textarea is display: none or not in DOM\n\n    }\n  };\n\n  TextareaInput.prototype.blur = function () {\n    this.textarea.blur();\n  };\n\n  TextareaInput.prototype.resetPosition = function () {\n    this.wrapper.style.top = this.wrapper.style.left = 0;\n  };\n\n  TextareaInput.prototype.receivedFocus = function () {\n    this.slowPoll();\n  }; // Poll for input changes, using the normal rate of polling. This\n  // runs as long as the editor is focused.\n\n\n  TextareaInput.prototype.slowPoll = function () {\n    var this$1 = this;\n\n    if (this.pollingFast) {\n      return;\n    }\n\n    this.polling.set(this.cm.options.pollInterval, function () {\n      this$1.poll();\n\n      if (this$1.cm.state.focused) {\n        this$1.slowPoll();\n      }\n    });\n  }; // When an event has just come in that is likely to add or change\n  // something in the input textarea, we poll faster, to ensure that\n  // the change appears on the screen quickly.\n\n\n  TextareaInput.prototype.fastPoll = function () {\n    var missed = false,\n        input = this;\n    input.pollingFast = true;\n\n    function p() {\n      var changed = input.poll();\n\n      if (!changed && !missed) {\n        missed = true;\n        input.polling.set(60, p);\n      } else {\n        input.pollingFast = false;\n        input.slowPoll();\n      }\n    }\n\n    input.polling.set(20, p);\n  }; // Read input from the textarea, and update the document to match.\n  // When something is selected, it is present in the textarea, and\n  // selected (unless it is huge, in which case a placeholder is\n  // used). When nothing is selected, the cursor sits after previously\n  // seen text (can be empty), which is stored in prevInput (we must\n  // not reset the textarea when typing, because that breaks IME).\n\n\n  TextareaInput.prototype.poll = function () {\n    var this$1 = this;\n    var cm = this.cm,\n        input = this.textarea,\n        prevInput = this.prevInput; // Since this is called a *lot*, try to bail out as cheaply as\n    // possible when it is clear that nothing happened. hasSelection\n    // will be the case when there is a lot of text in the textarea,\n    // in which case reading its value would be expensive.\n\n    if (this.contextMenuPending || !cm.state.focused || hasSelection(input) && !prevInput && !this.composing || cm.isReadOnly() || cm.options.disableInput || cm.state.keySeq) {\n      return false;\n    }\n\n    var text = input.value; // If nothing changed, bail.\n\n    if (text == prevInput && !cm.somethingSelected()) {\n      return false;\n    } // Work around nonsensical selection resetting in IE9/10, and\n    // inexplicable appearance of private area unicode characters on\n    // some key combos in Mac (#2689).\n\n\n    if (ie && ie_version >= 9 && this.hasSelection === text || mac && /[\\uf700-\\uf7ff]/.test(text)) {\n      cm.display.input.reset();\n      return false;\n    }\n\n    if (cm.doc.sel == cm.display.selForContextMenu) {\n      var first = text.charCodeAt(0);\n\n      if (first == 0x200b && !prevInput) {\n        prevInput = "\\u200B";\n      }\n\n      if (first == 0x21da) {\n        this.reset();\n        return this.cm.execCommand("undo");\n      }\n    } // Find the part of the input that is actually new\n\n\n    var same = 0,\n        l = Math.min(prevInput.length, text.length);\n\n    while (same < l && prevInput.charCodeAt(same) == text.charCodeAt(same)) {\n      ++same;\n    }\n\n    runInOp(cm, function () {\n      applyTextInput(cm, text.slice(same), prevInput.length - same, null, this$1.composing ? "*compose" : null); // Don\'t leave long text in the textarea, since it makes further polling slow\n\n      if (text.length > 1000 || text.indexOf("\\n") > -1) {\n        input.value = this$1.prevInput = "";\n      } else {\n        this$1.prevInput = text;\n      }\n\n      if (this$1.composing) {\n        this$1.composing.range.clear();\n        this$1.composing.range = cm.markText(this$1.composing.start, cm.getCursor("to"), {\n          className: "CodeMirror-composing"\n        });\n      }\n    });\n    return true;\n  };\n\n  TextareaInput.prototype.ensurePolled = function () {\n    if (this.pollingFast && this.poll()) {\n      this.pollingFast = false;\n    }\n  };\n\n  TextareaInput.prototype.onKeyPress = function () {\n    if (ie && ie_version >= 9) {\n      this.hasSelection = null;\n    }\n\n    this.fastPoll();\n  };\n\n  TextareaInput.prototype.onContextMenu = function (e) {\n    var input = this,\n        cm = input.cm,\n        display = cm.display,\n        te = input.textarea;\n\n    if (input.contextMenuPending) {\n      input.contextMenuPending();\n    }\n\n    var pos = posFromMouse(cm, e),\n        scrollPos = display.scroller.scrollTop;\n\n    if (!pos || presto) {\n      return;\n    } // Opera is difficult.\n    // Reset the current text selection only if the click is done outside of the selection\n    // and \'resetSelectionOnContextMenu\' option is true.\n\n\n    var reset = cm.options.resetSelectionOnContextMenu;\n\n    if (reset && cm.doc.sel.contains(pos) == -1) {\n      operation(cm, setSelection)(cm.doc, simpleSelection(pos), sel_dontScroll);\n    }\n\n    var oldCSS = te.style.cssText,\n        oldWrapperCSS = input.wrapper.style.cssText;\n    var wrapperBox = input.wrapper.offsetParent.getBoundingClientRect();\n    input.wrapper.style.cssText = "position: static";\n    te.style.cssText = "position: absolute; width: 30px; height: 30px;\\n      top: " + (e.clientY - wrapperBox.top - 5) + "px; left: " + (e.clientX - wrapperBox.left - 5) + "px;\\n      z-index: 1000; background: " + (ie ? "rgba(255, 255, 255, .05)" : "transparent") + ";\\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";\n    var oldScrollY;\n\n    if (webkit) {\n      oldScrollY = window.scrollY;\n    } // Work around Chrome issue (#2712)\n\n\n    display.input.focus();\n\n    if (webkit) {\n      window.scrollTo(null, oldScrollY);\n    }\n\n    display.input.reset(); // Adds "Select all" to context menu in FF\n\n    if (!cm.somethingSelected()) {\n      te.value = input.prevInput = " ";\n    }\n\n    input.contextMenuPending = rehide;\n    display.selForContextMenu = cm.doc.sel;\n    clearTimeout(display.detectingSelectAll); // Select-all will be greyed out if there\'s nothing to select, so\n    // this adds a zero-width space so that we can later check whether\n    // it got selected.\n\n    function prepareSelectAllHack() {\n      if (te.selectionStart != null) {\n        var selected = cm.somethingSelected();\n        var extval = "\\u200B" + (selected ? te.value : "");\n        te.value = "\\u21DA"; // Used to catch context-menu undo\n\n        te.value = extval;\n        input.prevInput = selected ? "" : "\\u200B";\n        te.selectionStart = 1;\n        te.selectionEnd = extval.length; // Re-set this, in case some other handler touched the\n        // selection in the meantime.\n\n        display.selForContextMenu = cm.doc.sel;\n      }\n    }\n\n    function rehide() {\n      if (input.contextMenuPending != rehide) {\n        return;\n      }\n\n      input.contextMenuPending = false;\n      input.wrapper.style.cssText = oldWrapperCSS;\n      te.style.cssText = oldCSS;\n\n      if (ie && ie_version < 9) {\n        display.scrollbars.setScrollTop(display.scroller.scrollTop = scrollPos);\n      } // Try to detect the user choosing select-all\n\n\n      if (te.selectionStart != null) {\n        if (!ie || ie && ie_version < 9) {\n          prepareSelectAllHack();\n        }\n\n        var i = 0,\n            poll = function poll() {\n          if (display.selForContextMenu == cm.doc.sel && te.selectionStart == 0 && te.selectionEnd > 0 && input.prevInput == "\\u200B") {\n            operation(cm, selectAll)(cm);\n          } else if (i++ < 10) {\n            display.detectingSelectAll = setTimeout(poll, 500);\n          } else {\n            display.selForContextMenu = null;\n            display.input.reset();\n          }\n        };\n\n        display.detectingSelectAll = setTimeout(poll, 200);\n      }\n    }\n\n    if (ie && ie_version >= 9) {\n      prepareSelectAllHack();\n    }\n\n    if (captureRightClick) {\n      e_stop(e);\n\n      var mouseup = function mouseup() {\n        off(window, "mouseup", mouseup);\n        setTimeout(rehide, 20);\n      };\n\n      on(window, "mouseup", mouseup);\n    } else {\n      setTimeout(rehide, 50);\n    }\n  };\n\n  TextareaInput.prototype.readOnlyChanged = function (val) {\n    if (!val) {\n      this.reset();\n    }\n\n    this.textarea.disabled = val == "nocursor";\n  };\n\n  TextareaInput.prototype.setUneditable = function () {};\n\n  TextareaInput.prototype.needsContentAttribute = false;\n\n  function fromTextArea(textarea, options) {\n    options = options ? copyObj(options) : {};\n    options.value = textarea.value;\n\n    if (!options.tabindex && textarea.tabIndex) {\n      options.tabindex = textarea.tabIndex;\n    }\n\n    if (!options.placeholder && textarea.placeholder) {\n      options.placeholder = textarea.placeholder;\n    } // Set autofocus to true if this textarea is focused, or if it has\n    // autofocus and no other element is focused.\n\n\n    if (options.autofocus == null) {\n      var hasFocus = activeElt();\n      options.autofocus = hasFocus == textarea || textarea.getAttribute("autofocus") != null && hasFocus == document.body;\n    }\n\n    function save() {\n      textarea.value = cm.getValue();\n    }\n\n    var realSubmit;\n\n    if (textarea.form) {\n      on(textarea.form, "submit", save); // Deplorable hack to make the submit method do the right thing.\n\n      if (!options.leaveSubmitMethodAlone) {\n        var form = textarea.form;\n        realSubmit = form.submit;\n\n        try {\n          var wrappedSubmit = form.submit = function () {\n            save();\n            form.submit = realSubmit;\n            form.submit();\n            form.submit = wrappedSubmit;\n          };\n        } catch (e) {}\n      }\n    }\n\n    options.finishInit = function (cm) {\n      cm.save = save;\n\n      cm.getTextArea = function () {\n        return textarea;\n      };\n\n      cm.toTextArea = function () {\n        cm.toTextArea = isNaN; // Prevent this from being ran twice\n\n        save();\n        textarea.parentNode.removeChild(cm.getWrapperElement());\n        textarea.style.display = "";\n\n        if (textarea.form) {\n          off(textarea.form, "submit", save);\n\n          if (!options.leaveSubmitMethodAlone && typeof textarea.form.submit == "function") {\n            textarea.form.submit = realSubmit;\n          }\n        }\n      };\n    };\n\n    textarea.style.display = "none";\n    var cm = CodeMirror(function (node) {\n      return textarea.parentNode.insertBefore(node, textarea.nextSibling);\n    }, options);\n    return cm;\n  }\n\n  function addLegacyProps(CodeMirror) {\n    CodeMirror.off = off;\n    CodeMirror.on = on;\n    CodeMirror.wheelEventPixels = wheelEventPixels;\n    CodeMirror.Doc = Doc;\n    CodeMirror.splitLines = splitLinesAuto;\n    CodeMirror.countColumn = countColumn;\n    CodeMirror.findColumn = findColumn;\n    CodeMirror.isWordChar = isWordCharBasic;\n    CodeMirror.Pass = Pass;\n    CodeMirror.signal = signal;\n    CodeMirror.Line = Line;\n    CodeMirror.changeEnd = changeEnd;\n    CodeMirror.scrollbarModel = scrollbarModel;\n    CodeMirror.Pos = Pos;\n    CodeMirror.cmpPos = cmp;\n    CodeMirror.modes = modes;\n    CodeMirror.mimeModes = mimeModes;\n    CodeMirror.resolveMode = resolveMode;\n    CodeMirror.getMode = getMode;\n    CodeMirror.modeExtensions = modeExtensions;\n    CodeMirror.extendMode = extendMode;\n    CodeMirror.copyState = copyState;\n    CodeMirror.startState = startState;\n    CodeMirror.innerMode = innerMode;\n    CodeMirror.commands = commands;\n    CodeMirror.keyMap = keyMap;\n    CodeMirror.keyName = keyName;\n    CodeMirror.isModifierKey = isModifierKey;\n    CodeMirror.lookupKey = lookupKey;\n    CodeMirror.normalizeKeyMap = normalizeKeyMap;\n    CodeMirror.StringStream = StringStream;\n    CodeMirror.SharedTextMarker = SharedTextMarker;\n    CodeMirror.TextMarker = TextMarker;\n    CodeMirror.LineWidget = LineWidget;\n    CodeMirror.e_preventDefault = e_preventDefault;\n    CodeMirror.e_stopPropagation = e_stopPropagation;\n    CodeMirror.e_stop = e_stop;\n    CodeMirror.addClass = addClass;\n    CodeMirror.contains = contains;\n    CodeMirror.rmClass = rmClass;\n    CodeMirror.keyNames = keyNames;\n  } // EDITOR CONSTRUCTOR\n\n\n  defineOptions(CodeMirror);\n  addEditorMethods(CodeMirror); // Set up methods on CodeMirror\'s prototype to redirect to the editor\'s document.\n\n  var dontDelegate = "iter insert remove copy getEditor constructor".split(" ");\n\n  for (var prop in Doc.prototype) {\n    if (Doc.prototype.hasOwnProperty(prop) && indexOf(dontDelegate, prop) < 0) {\n      CodeMirror.prototype[prop] = function (method) {\n        return function () {\n          return method.apply(this.doc, arguments);\n        };\n      }(Doc.prototype[prop]);\n    }\n  }\n\n  eventMixin(Doc);\n  CodeMirror.inputStyles = {\n    "textarea": TextareaInput,\n    "contenteditable": ContentEditableInput\n  }; // Extra arguments are stored as the mode\'s dependencies, which is\n  // used by (legacy) mechanisms like loadmode.js to automatically\n  // load a mode. (Preferred mechanism is the require/define calls.)\n\n  CodeMirror.defineMode = function (name\n  /*, mode, …*/\n  ) {\n    if (!CodeMirror.defaults.mode && name != "null") {\n      CodeMirror.defaults.mode = name;\n    }\n\n    defineMode.apply(this, arguments);\n  };\n\n  CodeMirror.defineMIME = defineMIME; // Minimal default mode.\n\n  CodeMirror.defineMode("null", function () {\n    return {\n      token: function token(stream) {\n        return stream.skipToEnd();\n      }\n    };\n  });\n  CodeMirror.defineMIME("text/plain", "null"); // EXTENSIONS\n\n  CodeMirror.defineExtension = function (name, func) {\n    CodeMirror.prototype[name] = func;\n  };\n\n  CodeMirror.defineDocExtension = function (name, func) {\n    Doc.prototype[name] = func;\n  };\n\n  CodeMirror.fromTextArea = fromTextArea;\n  addLegacyProps(CodeMirror);\n  CodeMirror.version = "5.50.0";\n  return CodeMirror;\n});'},CtJk:function(e,t,n){n("Sc3u")("Uint8",1,(function(e){return function(t,n,r){return e(this,t,n,r)}}))},DrhF:function(e,t,n){var r=n("BjK0"),i=n("N+BI").onFreeze;n("939a")("freeze",(function(e){return function(t){return e&&r(t)?e(i(t)):t}}))},GemG:function(e,t,n){var r,i,o;n("Ggvi"),n("n7j8"),n("JHok"),n("sc67"),n("rzGZ"),n("Dq+y"),n("8npG"),n("YbXK"),n("xJgp"),i=[e,t],void 0===(o="function"==typeof(r=function(e,t){"use strict";var n,r,i="function"==typeof Map?new Map:(n=[],r=[],{has:function(e){return n.indexOf(e)>-1},get:function(e){return r[n.indexOf(e)]},set:function(e,t){-1===n.indexOf(e)&&(n.push(e),r.push(t))},delete:function(e){var t=n.indexOf(e);t>-1&&(n.splice(t,1),r.splice(t,1))}}),o=function(e){return new Event(e,{bubbles:!0})};try{new Event("test")}catch(l){o=function(e){var t=document.createEvent("Event");return t.initEvent(e,!0,!1),t}}function a(e){if(e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!i.has(e)){var t,n=null,r=null,a=null,s=function(){e.clientWidth!==r&&h()},u=function(t){window.removeEventListener("resize",s,!1),e.removeEventListener("input",h,!1),e.removeEventListener("keyup",h,!1),e.removeEventListener("autosize:destroy",u,!1),e.removeEventListener("autosize:update",h,!1),Object.keys(t).forEach((function(n){e.style[n]=t[n]})),i.delete(e)}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",u,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",h,!1),window.addEventListener("resize",s,!1),e.addEventListener("input",h,!1),e.addEventListener("autosize:update",h,!1),e.style.overflowX="hidden",e.style.wordWrap="break-word",i.set(e,{destroy:u,update:h}),"vertical"===(t=window.getComputedStyle(e,null)).resize?e.style.resize="none":"both"===t.resize&&(e.style.resize="horizontal"),n="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth),isNaN(n)&&(n=0),h()}function c(t){var n=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=n,e.style.overflowY=t}function l(){if(0!==e.scrollHeight){var t=function(e){for(var t=[];e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&t.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;return t}(e),i=document.documentElement&&document.documentElement.scrollTop;e.style.height="",e.style.height=e.scrollHeight+n+"px",r=e.clientWidth,t.forEach((function(e){e.node.scrollTop=e.scrollTop})),i&&(document.documentElement.scrollTop=i)}}function h(){l();var t=Math.round(parseFloat(e.style.height)),n=window.getComputedStyle(e,null),r="content-box"===n.boxSizing?Math.round(parseFloat(n.height)):e.offsetHeight;if(r<t?"hidden"===n.overflowY&&(c("scroll"),l(),r="content-box"===n.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight):"hidden"!==n.overflowY&&(c("hidden"),l(),r="content-box"===n.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight),a!==r){a=r;var i=o("autosize:resized");try{e.dispatchEvent(i)}catch(s){}}}}function s(e){var t=i.get(e);t&&t.destroy()}function u(e){var t=i.get(e);t&&t.update()}var c=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?((c=function(e){return e}).destroy=function(e){return e},c.update=function(e){return e}):((c=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],(function(e){return a(e)})),e}).destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],s),e},c.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],u),e}),t.default=c,e.exports=t.default})?r.apply(t,i):r)||(e.exports=o)},HQAx:function(e,t,n){"use strict";var r=n("P8UN"),i=n("ewoU"),o=n("DFzH"),a=n("kiRH"),s=n("nONw"),u=n("ytzU");r(r.P,"Array",{flatMap:function(e){var t,n,r=o(this);return s(e),t=a(r.length),n=u(r,0),i(n,r,r,t,0,1,e,arguments[1]),n}}),n("Dq1/")("flatMap")},HYt3:function(e,t,n){"use strict";(function(e){n("sPse"),n("Ird3");var r=n("q1tI"),i=n.n(r),o=(n("qhky"),n("Wcq6")),a=(n("6nsN"),n("5x/H"),n("fFpS"));n("p77/"),n("SQHg"),n("mN2Q"),n("niph");e.firebase=o;var s=function(e){var t,r;function s(){return e.apply(this,arguments)||this}r=e,(t=s).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r;var u=s.prototype;return u.componentDidMount=function(){o.initializeApp(a.firebaseConfig);var e=n("Wcq6");n("6nsN"),n("Zs65");var t=e.database().ref("/unique/"+new URLSearchParams(window.location.search).get("workspace")),r=CodeMirror(document.getElementById("firepad-container"),{lineWrapping:!0}),i=Firepad.fromCodeMirror(t,r,{richTextToolbar:!0,richTextShortcuts:!0});i.on("ready",(function(){i.isHistoryEmpty()}))},u.render=function(){return i.a.createElement("div",{id:"firepad-container"})},s}(i.a.Component);t.a=s}).call(this,n("yLpj"))},I17o:function(e,t,n){"use strict";var r=n("P8UN"),i=n("pTxf"),o=n("CL53"),a=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);r(r.P+r.F*a,"String",{padEnd:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0,!1)}})},J6QO:function(e,t,n){"use strict";var r=n("96qb"),i=Date.prototype.getTime,o=Date.prototype.toISOString,a=function(e){return e>9?e:"0"+e};e.exports=r((function(){return"0385-07-25T07:06:39.999Z"!=o.call(new Date(-5e13-1))}))||!r((function(){o.call(new Date(NaN))}))?function(){if(!isFinite(i.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),n=e.getUTCMilliseconds(),r=t<0?"-":t>9999?"+":"";return r+("00000"+Math.abs(t)).slice(r?-6:-4)+"-"+a(e.getUTCMonth()+1)+"-"+a(e.getUTCDate())+"T"+a(e.getUTCHours())+":"+a(e.getUTCMinutes())+":"+a(e.getUTCSeconds())+"."+(n>99?n:"0"+a(n))+"Z"}:o},J7Mx:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return O})),n.d(t,"b",(function(){return E})),n.d(t,"c",(function(){return R})),n.d(t,"d",(function(){return y}));n("wZFJ"),n("HQhv"),n("1dPr"),n("JHok"),n("MIFh"),n("sc67"),n("rzGZ"),n("Dq+y"),n("8npG"),n("Ggvi"),n("OeI1"),n("AqHK"),n("U6Bt"),n("sC2a"),n("E5k/"),n("m210"),n("4DPX");var r,i=n("q1tI"),o=n.n(i),a=n("MgzW"),s=n.n(a),u=n("MZZl"),c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},h=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!1===t?String(e):String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")},d=function(e){var t=v(e,u.g.TITLE),n=v(e,u.c.TITLE_TEMPLATE);if(n&&t)return n.replace(/%s/g,(function(){return t}));var r=v(e,u.c.DEFAULT_TITLE);return t||r||void 0},p=function(e){return v(e,u.c.ON_CHANGE_CLIENT_STATE)||function(){}},f=function(e,t){return t.filter((function(t){return void 0!==t[e]})).map((function(t){return t[e]})).reduce((function(e,t){return l({},e,t)}),{})},m=function(e,t){return t.filter((function(e){return void 0!==e[u.g.BASE]})).map((function(e){return e[u.g.BASE]})).reverse().reduce((function(t,n){if(!t.length)for(var r=Object.keys(n),i=0;i<r.length;i++){var o=r[i].toLowerCase();if(-1!==e.indexOf(o)&&n[o])return t.concat(n)}return t}),[])},g=function(e,t,n){var r={};return n.filter((function(t){return!!Array.isArray(t[e])||(void 0!==t[e]&&T("Helmet: "+e+' should be of type "Array". Instead found type "'+c(t[e])+'"'),!1)})).map((function(t){return t[e]})).reverse().reduce((function(e,n){var i={};n.filter((function(e){for(var n=void 0,o=Object.keys(e),a=0;a<o.length;a++){var s=o[a],c=s.toLowerCase();-1===t.indexOf(c)||n===u.h.REL&&"canonical"===e[n].toLowerCase()||c===u.h.REL&&"stylesheet"===e[c].toLowerCase()||(n=c),-1===t.indexOf(s)||s!==u.h.INNER_HTML&&s!==u.h.CSS_TEXT&&s!==u.h.ITEM_PROP||(n=s)}if(!n||!e[n])return!1;var l=e[n].toLowerCase();return r[n]||(r[n]={}),i[n]||(i[n]={}),!r[n][l]&&(i[n][l]=!0,!0)})).reverse().forEach((function(t){return e.push(t)}));for(var o=Object.keys(i),a=0;a<o.length;a++){var c=o[a],l=s()({},r[c],i[c]);r[c]=l}return e}),[]).reverse()},v=function(e,t){for(var n=e.length-1;n>=0;n--){var r=e[n];if(r.hasOwnProperty(t))return r[t]}return null},y=function(e){return{baseTag:m([u.h.HREF],e),bodyAttributes:f(u.a.BODY,e),defer:v(e,u.c.DEFER),encode:v(e,u.c.ENCODE_SPECIAL_CHARACTERS),htmlAttributes:f(u.a.HTML,e),linkTags:g(u.g.LINK,[u.h.REL,u.h.HREF],e),metaTags:g(u.g.META,[u.h.NAME,u.h.CHARSET,u.h.HTTPEQUIV,u.h.PROPERTY,u.h.ITEM_PROP],e),noscriptTags:g(u.g.NOSCRIPT,[u.h.INNER_HTML],e),onChangeClientState:p(e),scriptTags:g(u.g.SCRIPT,[u.h.SRC,u.h.INNER_HTML],e),styleTags:g(u.g.STYLE,[u.h.CSS_TEXT],e),title:d(e),titleAttributes:f(u.a.TITLE,e)}},b=(r=Date.now(),function(e){var t=Date.now();t-r>16?(r=t,e(t)):setTimeout((function(){b(e)}),0)}),w=function(e){return clearTimeout(e)},_="undefined"!=typeof window?window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||b:e.requestAnimationFrame||b,C="undefined"!=typeof window?window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||w:e.cancelAnimationFrame||w,T=function(e){return console&&"function"==typeof console.warn&&console.warn(e)},S=null,E=function(e){S&&C(S),e.defer?S=_((function(){x(e,(function(){S=null}))})):(x(e),S=null)},x=function(e,t){var n=e.baseTag,r=e.bodyAttributes,i=e.htmlAttributes,o=e.linkTags,a=e.metaTags,s=e.noscriptTags,c=e.onChangeClientState,l=e.scriptTags,h=e.styleTags,d=e.title,p=e.titleAttributes;A(u.g.BODY,r),A(u.g.HTML,i),k(d,p);var f={baseTag:N(u.g.BASE,n),linkTags:N(u.g.LINK,o),metaTags:N(u.g.META,a),noscriptTags:N(u.g.NOSCRIPT,s),scriptTags:N(u.g.SCRIPT,l),styleTags:N(u.g.STYLE,h)},m={},g={};Object.keys(f).forEach((function(e){var t=f[e],n=t.newTags,r=t.oldTags;n.length&&(m[e]=n),r.length&&(g[e]=f[e].oldTags)})),t&&t(),c(e,m,g)},I=function(e){return Array.isArray(e)?e.join(""):e},k=function(e,t){void 0!==e&&document.title!==e&&(document.title=I(e)),A(u.g.TITLE,t)},A=function(e,t){var n=document.getElementsByTagName(e)[0];if(n){for(var r=n.getAttribute(u.b),i=r?r.split(","):[],o=[].concat(i),a=Object.keys(t),s=0;s<a.length;s++){var c=a[s],l=t[c]||"";n.getAttribute(c)!==l&&n.setAttribute(c,l),-1===i.indexOf(c)&&i.push(c);var h=o.indexOf(c);-1!==h&&o.splice(h,1)}for(var d=o.length-1;d>=0;d--)n.removeAttribute(o[d]);i.length===o.length?n.removeAttribute(u.b):n.getAttribute(u.b)!==a.join(",")&&n.setAttribute(u.b,a.join(","))}},N=function(e,t){var n=document.head||document.querySelector(u.g.HEAD),r=n.querySelectorAll(e+"["+u.b+"]"),i=Array.prototype.slice.call(r),o=[],a=void 0;return t&&t.length&&t.forEach((function(t){var n=document.createElement(e);for(var r in t)if(t.hasOwnProperty(r))if(r===u.h.INNER_HTML)n.innerHTML=t.innerHTML;else if(r===u.h.CSS_TEXT)n.styleSheet?n.styleSheet.cssText=t.cssText:n.appendChild(document.createTextNode(t.cssText));else{var s=void 0===t[r]?"":t[r];n.setAttribute(r,s)}n.setAttribute(u.b,"true"),i.some((function(e,t){return a=t,n.isEqualNode(e)}))?i.splice(a,1):o.push(n)})),i.forEach((function(e){return e.parentNode.removeChild(e)})),o.forEach((function(e){return n.appendChild(e)})),{oldTags:i,newTags:o}},L=function(e){return Object.keys(e).reduce((function(t,n){var r=void 0!==e[n]?n+'="'+e[n]+'"':""+n;return t?t+" "+r:r}),"")},D=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.keys(e).reduce((function(t,n){return t[u.e[n]||n]=e[n],t}),t)},O=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.keys(e).reduce((function(t,n){return t[u.d[n]||n]=e[n],t}),t)},M=function(e,t,n){switch(e){case u.g.TITLE:return{toComponent:function(){return e=t.title,n=t.titleAttributes,(r={key:e})[u.b]=!0,i=D(n,r),[o.a.createElement(u.g.TITLE,i,e)];var e,n,r,i},toString:function(){return function(e,t,n,r){var i=L(n),o=I(t);return i?"<"+e+" "+u.b+'="true" '+i+">"+h(o,r)+"</"+e+">":"<"+e+" "+u.b+'="true">'+h(o,r)+"</"+e+">"}(e,t.title,t.titleAttributes,n)}};case u.a.BODY:case u.a.HTML:return{toComponent:function(){return D(t)},toString:function(){return L(t)}};default:return{toComponent:function(){return function(e,t){return t.map((function(t,n){var r,i=((r={key:n})[u.b]=!0,r);return Object.keys(t).forEach((function(e){var n=u.e[e]||e;if(n===u.h.INNER_HTML||n===u.h.CSS_TEXT){var r=t.innerHTML||t.cssText;i.dangerouslySetInnerHTML={__html:r}}else i[n]=t[e]})),o.a.createElement(e,i)}))}(e,t)},toString:function(){return function(e,t,n){return t.reduce((function(t,r){var i=Object.keys(r).filter((function(e){return!(e===u.h.INNER_HTML||e===u.h.CSS_TEXT)})).reduce((function(e,t){var i=void 0===r[t]?t:t+'="'+h(r[t],n)+'"';return e?e+" "+i:i}),""),o=r.innerHTML||r.cssText||"",a=-1===u.f.indexOf(e);return t+"<"+e+" "+u.b+'="true" '+i+(a?"/>":">"+o+"</"+e+">")}),"")}(e,t,n)}}}},R=function(e){var t=e.baseTag,n=e.bodyAttributes,r=e.encode,i=e.htmlAttributes,o=e.linkTags,a=e.metaTags,s=e.noscriptTags,c=e.scriptTags,l=e.styleTags,h=e.title,d=void 0===h?"":h,p=e.titleAttributes;return{base:M(u.g.BASE,t,r),bodyAttributes:M(u.a.BODY,n,r),htmlAttributes:M(u.a.HTML,i,r),link:M(u.g.LINK,o,r),meta:M(u.g.META,a,r),noscript:M(u.g.NOSCRIPT,s,r),script:M(u.g.SCRIPT,c,r),style:M(u.g.STYLE,l,r),title:M(u.g.TITLE,{title:d,titleAttributes:p},r)}}}).call(this,n("yLpj"))},Jegl:function(e,t,n){for(var r,i=n("emib"),o=n("8wc8"),a=n("UEZ0"),s=a("typed_array"),u=a("view"),c=!(!i.ArrayBuffer||!i.DataView),l=c,h=0,d="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");h<9;)(r=i[d[h++]])?(o(r.prototype,s,!0),o(r.prototype,u,!0)):l=!1;e.exports={ABV:c,CONSTR:l,TYPED:s,VIEW:u}},KKAB:function(e,t,n){"use strict";var r=n("q1tI"),i=n.n(r),o=n("h3sT");n("if7W");t.a=function(e){var t=e.children,n=e.promise,a=Object(r.useState)(!1),s=a[0],u=a[1];return i.a.createElement(o.a,{onClick:function(){u(!0),n().then((function(e){return u(!1),e})).catch((function(e){u(!1)}))}},s?"Einen Moment Geduld":t)}},L5ms:function(e,t,n){"use strict";n("Ll4R"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r=o(n("+80P")),i=o(n("wRvv"));function o(e){return e&&e.__esModule?e:{default:e}}var a=new r.default;a.tlds(i.default),t.default=function(e){return a.match(e)}},LvDl:function(e,t,n){(function(e,r){var i;n("nMRu"),n("1/Ks"),n("QzX/"),n("HXzo"),n("TAD1"),n("wZFJ"),n("ZiRl"),n("Rw9D"),n("U6Bt"),n("lizw"),n("I17o"),n("gu/5"),n("eoYm"),n("zTTH"),n("v9g0"),n("WevN"),n("HQAx"),n("OeI1"),n("n0hJ"),n("n7j8"),n("lFjb"),n("sPse"),n("MIFh"),n("sc67"),n("AqHK"),n("pJf4"),n("Ggvi"),n("4DPX"),n("1dPr"),n("pS08"),n("sC2a"),n("rzGZ"),n("Dq+y"),n("q8oJ"),n("C9fy"),n("8npG"),n("JHok"),n("zGcK"),n("Ll4R"),n("HQhv"),n("klQ5"),function(){var o,a=200,s="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",u="Expected a function",c="__lodash_hash_undefined__",l=500,h="__lodash_placeholder__",d=1,p=2,f=4,m=1,g=2,v=1,y=2,b=4,w=8,_=16,C=32,T=64,S=128,E=256,x=512,I=30,k="...",A=800,N=16,L=1,D=2,O=1/0,M=9007199254740991,R=17976931348623157e292,P=NaN,F=4294967295,j=F-1,B=F>>>1,V=[["ary",S],["bind",v],["bindKey",y],["curry",w],["curryRight",_],["flip",x],["partial",C],["partialRight",T],["rearg",E]],W="[object Arguments]",U="[object Array]",H="[object AsyncFunction]",z="[object Boolean]",q="[object Date]",K="[object DOMException]",G="[object Error]",Q="[object Function]",$="[object GeneratorFunction]",Y="[object Map]",X="[object Number]",J="[object Null]",Z="[object Object]",ee="[object Proxy]",te="[object RegExp]",ne="[object Set]",re="[object String]",ie="[object Symbol]",oe="[object Undefined]",ae="[object WeakMap]",se="[object WeakSet]",ue="[object ArrayBuffer]",ce="[object DataView]",le="[object Float32Array]",he="[object Float64Array]",de="[object Int8Array]",pe="[object Int16Array]",fe="[object Int32Array]",me="[object Uint8Array]",ge="[object Uint8ClampedArray]",ve="[object Uint16Array]",ye="[object Uint32Array]",be=/\b__p \+= '';/g,we=/\b(__p \+=) '' \+/g,_e=/(__e\(.*?\)|\b__t\)) \+\n'';/g,Ce=/&(?:amp|lt|gt|quot|#39);/g,Te=/[&<>"']/g,Se=RegExp(Ce.source),Ee=RegExp(Te.source),xe=/<%-([\s\S]+?)%>/g,Ie=/<%([\s\S]+?)%>/g,ke=/<%=([\s\S]+?)%>/g,Ae=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ne=/^\w*$/,Le=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,De=/[\\^$.*+?()[\]{}|]/g,Oe=RegExp(De.source),Me=/^\s+|\s+$/g,Re=/^\s+/,Pe=/\s+$/,Fe=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,je=/\{\n\/\* \[wrapped with (.+)\] \*/,Be=/,? & /,Ve=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,We=/\\(\\)?/g,Ue=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,He=/\w*$/,ze=/^[-+]0x[0-9a-f]+$/i,qe=/^0b[01]+$/i,Ke=/^\[object .+?Constructor\]$/,Ge=/^0o[0-7]+$/i,Qe=/^(?:0|[1-9]\d*)$/,$e=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,Ye=/($^)/,Xe=/['\n\r\u2028\u2029\\]/g,Je="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Ze="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",et="[\\ud800-\\udfff]",tt="["+Ze+"]",nt="["+Je+"]",rt="\\d+",it="[\\u2700-\\u27bf]",ot="[a-z\\xdf-\\xf6\\xf8-\\xff]",at="[^\\ud800-\\udfff"+Ze+rt+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",st="\\ud83c[\\udffb-\\udfff]",ut="[^\\ud800-\\udfff]",ct="(?:\\ud83c[\\udde6-\\uddff]){2}",lt="[\\ud800-\\udbff][\\udc00-\\udfff]",ht="[A-Z\\xc0-\\xd6\\xd8-\\xde]",dt="(?:"+ot+"|"+at+")",pt="(?:"+ht+"|"+at+")",ft="(?:"+nt+"|"+st+")"+"?",mt="[\\ufe0e\\ufe0f]?"+ft+("(?:\\u200d(?:"+[ut,ct,lt].join("|")+")[\\ufe0e\\ufe0f]?"+ft+")*"),gt="(?:"+[it,ct,lt].join("|")+")"+mt,vt="(?:"+[ut+nt+"?",nt,ct,lt,et].join("|")+")",yt=RegExp("['’]","g"),bt=RegExp(nt,"g"),wt=RegExp(st+"(?="+st+")|"+vt+mt,"g"),_t=RegExp([ht+"?"+ot+"+(?:['’](?:d|ll|m|re|s|t|ve))?(?="+[tt,ht,"$"].join("|")+")",pt+"+(?:['’](?:D|LL|M|RE|S|T|VE))?(?="+[tt,ht+dt,"$"].join("|")+")",ht+"?"+dt+"+(?:['’](?:d|ll|m|re|s|t|ve))?",ht+"+(?:['’](?:D|LL|M|RE|S|T|VE))?","\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",rt,gt].join("|"),"g"),Ct=RegExp("[\\u200d\\ud800-\\udfff"+Je+"\\ufe0e\\ufe0f]"),Tt=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,St=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],Et=-1,xt={};xt[le]=xt[he]=xt[de]=xt[pe]=xt[fe]=xt[me]=xt[ge]=xt[ve]=xt[ye]=!0,xt[W]=xt[U]=xt[ue]=xt[z]=xt[ce]=xt[q]=xt[G]=xt[Q]=xt[Y]=xt[X]=xt[Z]=xt[te]=xt[ne]=xt[re]=xt[ae]=!1;var It={};It[W]=It[U]=It[ue]=It[ce]=It[z]=It[q]=It[le]=It[he]=It[de]=It[pe]=It[fe]=It[Y]=It[X]=It[Z]=It[te]=It[ne]=It[re]=It[ie]=It[me]=It[ge]=It[ve]=It[ye]=!0,It[G]=It[Q]=It[ae]=!1;var kt={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},At=parseFloat,Nt=parseInt,Lt="object"==typeof e&&e&&e.Object===Object&&e,Dt="object"==typeof self&&self&&self.Object===Object&&self,Ot=Lt||Dt||Function("return this")(),Mt=t&&!t.nodeType&&t,Rt=Mt&&"object"==typeof r&&r&&!r.nodeType&&r,Pt=Rt&&Rt.exports===Mt,Ft=Pt&&Lt.process,jt=function(){try{var e=Rt&&Rt.require&&Rt.require("util").types;return e||Ft&&Ft.binding&&Ft.binding("util")}catch(t){}}(),Bt=jt&&jt.isArrayBuffer,Vt=jt&&jt.isDate,Wt=jt&&jt.isMap,Ut=jt&&jt.isRegExp,Ht=jt&&jt.isSet,zt=jt&&jt.isTypedArray;function qt(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}function Kt(e,t,n,r){for(var i=-1,o=null==e?0:e.length;++i<o;){var a=e[i];t(r,a,n(a),e)}return r}function Gt(e,t){for(var n=-1,r=null==e?0:e.length;++n<r&&!1!==t(e[n],n,e););return e}function Qt(e,t){for(var n=null==e?0:e.length;n--&&!1!==t(e[n],n,e););return e}function $t(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(!t(e[n],n,e))return!1;return!0}function Yt(e,t){for(var n=-1,r=null==e?0:e.length,i=0,o=[];++n<r;){var a=e[n];t(a,n,e)&&(o[i++]=a)}return o}function Xt(e,t){return!!(null==e?0:e.length)&&un(e,t,0)>-1}function Jt(e,t,n){for(var r=-1,i=null==e?0:e.length;++r<i;)if(n(t,e[r]))return!0;return!1}function Zt(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i}function en(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}function tn(e,t,n,r){var i=-1,o=null==e?0:e.length;for(r&&o&&(n=e[++i]);++i<o;)n=t(n,e[i],i,e);return n}function nn(e,t,n,r){var i=null==e?0:e.length;for(r&&i&&(n=e[--i]);i--;)n=t(n,e[i],i,e);return n}function rn(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}var on=dn("length");function an(e,t,n){var r;return n(e,(function(e,n,i){if(t(e,n,i))return r=n,!1})),r}function sn(e,t,n,r){for(var i=e.length,o=n+(r?1:-1);r?o--:++o<i;)if(t(e[o],o,e))return o;return-1}function un(e,t,n){return t==t?function(e,t,n){var r=n-1,i=e.length;for(;++r<i;)if(e[r]===t)return r;return-1}(e,t,n):sn(e,ln,n)}function cn(e,t,n,r){for(var i=n-1,o=e.length;++i<o;)if(r(e[i],t))return i;return-1}function ln(e){return e!=e}function hn(e,t){var n=null==e?0:e.length;return n?mn(e,t)/n:P}function dn(e){return function(t){return null==t?o:t[e]}}function pn(e){return function(t){return null==e?o:e[t]}}function fn(e,t,n,r,i){return i(e,(function(e,i,o){n=r?(r=!1,e):t(n,e,i,o)})),n}function mn(e,t){for(var n,r=-1,i=e.length;++r<i;){var a=t(e[r]);a!==o&&(n=n===o?a:n+a)}return n}function gn(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}function vn(e){return function(t){return e(t)}}function yn(e,t){return Zt(t,(function(t){return e[t]}))}function bn(e,t){return e.has(t)}function wn(e,t){for(var n=-1,r=e.length;++n<r&&un(t,e[n],0)>-1;);return n}function _n(e,t){for(var n=e.length;n--&&un(t,e[n],0)>-1;);return n}var Cn=pn({"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"}),Tn=pn({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function Sn(e){return"\\"+kt[e]}function En(e){return Ct.test(e)}function xn(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function In(e,t){return function(n){return e(t(n))}}function kn(e,t){for(var n=-1,r=e.length,i=0,o=[];++n<r;){var a=e[n];a!==t&&a!==h||(e[n]=h,o[i++]=n)}return o}function An(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}function Nn(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=[e,e]})),n}function Ln(e){return En(e)?function(e){var t=wt.lastIndex=0;for(;wt.test(e);)++t;return t}(e):on(e)}function Dn(e){return En(e)?function(e){return e.match(wt)||[]}(e):function(e){return e.split("")}(e)}var On=pn({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});var Mn=function e(t){var n,r=(t=null==t?Ot:Mn.defaults(Ot.Object(),t,Mn.pick(Ot,St))).Array,i=t.Date,Je=t.Error,Ze=t.Function,et=t.Math,tt=t.Object,nt=t.RegExp,rt=t.String,it=t.TypeError,ot=r.prototype,at=Ze.prototype,st=tt.prototype,ut=t["__core-js_shared__"],ct=at.toString,lt=st.hasOwnProperty,ht=0,dt=(n=/[^.]+$/.exec(ut&&ut.keys&&ut.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"",pt=st.toString,ft=ct.call(tt),mt=Ot._,gt=nt("^"+ct.call(lt).replace(De,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),vt=Pt?t.Buffer:o,wt=t.Symbol,Ct=t.Uint8Array,kt=vt?vt.allocUnsafe:o,Lt=In(tt.getPrototypeOf,tt),Dt=tt.create,Mt=st.propertyIsEnumerable,Rt=ot.splice,Ft=wt?wt.isConcatSpreadable:o,jt=wt?wt.iterator:o,on=wt?wt.toStringTag:o,pn=function(){try{var e=Bo(tt,"defineProperty");return e({},"",{}),e}catch(t){}}(),Rn=t.clearTimeout!==Ot.clearTimeout&&t.clearTimeout,Pn=i&&i.now!==Ot.Date.now&&i.now,Fn=t.setTimeout!==Ot.setTimeout&&t.setTimeout,jn=et.ceil,Bn=et.floor,Vn=tt.getOwnPropertySymbols,Wn=vt?vt.isBuffer:o,Un=t.isFinite,Hn=ot.join,zn=In(tt.keys,tt),qn=et.max,Kn=et.min,Gn=i.now,Qn=t.parseInt,$n=et.random,Yn=ot.reverse,Xn=Bo(t,"DataView"),Jn=Bo(t,"Map"),Zn=Bo(t,"Promise"),er=Bo(t,"Set"),tr=Bo(t,"WeakMap"),nr=Bo(tt,"create"),rr=tr&&new tr,ir={},or=ha(Xn),ar=ha(Jn),sr=ha(Zn),ur=ha(er),cr=ha(tr),lr=wt?wt.prototype:o,hr=lr?lr.valueOf:o,dr=lr?lr.toString:o;function pr(e){if(ks(e)&&!vs(e)&&!(e instanceof vr)){if(e instanceof gr)return e;if(lt.call(e,"__wrapped__"))return da(e)}return new gr(e)}var fr=function(){function e(){}return function(t){if(!Is(t))return{};if(Dt)return Dt(t);e.prototype=t;var n=new e;return e.prototype=o,n}}();function mr(){}function gr(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=o}function vr(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=F,this.__views__=[]}function yr(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function br(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function wr(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function _r(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new wr;++t<n;)this.add(e[t])}function Cr(e){var t=this.__data__=new br(e);this.size=t.size}function Tr(e,t){var n=vs(e),r=!n&&gs(e),i=!n&&!r&&_s(e),o=!n&&!r&&!i&&Ps(e),a=n||r||i||o,s=a?gn(e.length,rt):[],u=s.length;for(var c in e)!t&&!lt.call(e,c)||a&&("length"==c||i&&("offset"==c||"parent"==c)||o&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||Ko(c,u))||s.push(c);return s}function Sr(e){var t=e.length;return t?e[_i(0,t-1)]:o}function Er(e,t){return ua(no(e),Mr(t,0,e.length))}function xr(e){return ua(no(e))}function Ir(e,t,n){(n===o||ps(e[t],n))&&(n!==o||t in e)||Dr(e,t,n)}function kr(e,t,n){var r=e[t];lt.call(e,t)&&ps(r,n)&&(n!==o||t in e)||Dr(e,t,n)}function Ar(e,t){for(var n=e.length;n--;)if(ps(e[n][0],t))return n;return-1}function Nr(e,t,n,r){return Br(e,(function(e,i,o){t(r,e,n(e),o)})),r}function Lr(e,t){return e&&ro(t,iu(t),e)}function Dr(e,t,n){"__proto__"==t&&pn?pn(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}function Or(e,t){for(var n=-1,i=t.length,a=r(i),s=null==e;++n<i;)a[n]=s?o:Zs(e,t[n]);return a}function Mr(e,t,n){return e==e&&(n!==o&&(e=e<=n?e:n),t!==o&&(e=e>=t?e:t)),e}function Rr(e,t,n,r,i,a){var s,u=t&d,c=t&p,l=t&f;if(n&&(s=i?n(e,r,i,a):n(e)),s!==o)return s;if(!Is(e))return e;var h=vs(e);if(h){if(s=function(e){var t=e.length,n=new e.constructor(t);t&&"string"==typeof e[0]&&lt.call(e,"index")&&(n.index=e.index,n.input=e.input);return n}(e),!u)return no(e,s)}else{var m=Uo(e),g=m==Q||m==$;if(_s(e))return Yi(e,u);if(m==Z||m==W||g&&!i){if(s=c||g?{}:zo(e),!u)return c?function(e,t){return ro(e,Wo(e),t)}(e,function(e,t){return e&&ro(t,ou(t),e)}(s,e)):function(e,t){return ro(e,Vo(e),t)}(e,Lr(s,e))}else{if(!It[m])return i?e:{};s=function(e,t,n){var r=e.constructor;switch(t){case ue:return Xi(e);case z:case q:return new r(+e);case ce:return function(e,t){var n=t?Xi(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,n);case le:case he:case de:case pe:case fe:case me:case ge:case ve:case ye:return Ji(e,n);case Y:return new r;case X:case re:return new r(e);case te:return function(e){var t=new e.constructor(e.source,He.exec(e));return t.lastIndex=e.lastIndex,t}(e);case ne:return new r;case ie:return i=e,hr?tt(hr.call(i)):{}}var i}(e,m,u)}}a||(a=new Cr);var v=a.get(e);if(v)return v;a.set(e,s),Os(e)?e.forEach((function(r){s.add(Rr(r,t,n,r,e,a))})):As(e)&&e.forEach((function(r,i){s.set(i,Rr(r,t,n,i,e,a))}));var y=h?o:(l?c?Do:Lo:c?ou:iu)(e);return Gt(y||e,(function(r,i){y&&(r=e[i=r]),kr(s,i,Rr(r,t,n,i,e,a))})),s}function Pr(e,t,n){var r=n.length;if(null==e)return!r;for(e=tt(e);r--;){var i=n[r],a=t[i],s=e[i];if(s===o&&!(i in e)||!a(s))return!1}return!0}function Fr(e,t,n){if("function"!=typeof e)throw new it(u);return ia((function(){e.apply(o,n)}),t)}function jr(e,t,n,r){var i=-1,o=Xt,s=!0,u=e.length,c=[],l=t.length;if(!u)return c;n&&(t=Zt(t,vn(n))),r?(o=Jt,s=!1):t.length>=a&&(o=bn,s=!1,t=new _r(t));e:for(;++i<u;){var h=e[i],d=null==n?h:n(h);if(h=r||0!==h?h:0,s&&d==d){for(var p=l;p--;)if(t[p]===d)continue e;c.push(h)}else o(t,d,r)||c.push(h)}return c}pr.templateSettings={escape:xe,evaluate:Ie,interpolate:ke,variable:"",imports:{_:pr}},pr.prototype=mr.prototype,pr.prototype.constructor=pr,gr.prototype=fr(mr.prototype),gr.prototype.constructor=gr,vr.prototype=fr(mr.prototype),vr.prototype.constructor=vr,yr.prototype.clear=function(){this.__data__=nr?nr(null):{},this.size=0},yr.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},yr.prototype.get=function(e){var t=this.__data__;if(nr){var n=t[e];return n===c?o:n}return lt.call(t,e)?t[e]:o},yr.prototype.has=function(e){var t=this.__data__;return nr?t[e]!==o:lt.call(t,e)},yr.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=nr&&t===o?c:t,this},br.prototype.clear=function(){this.__data__=[],this.size=0},br.prototype.delete=function(e){var t=this.__data__,n=Ar(t,e);return!(n<0)&&(n==t.length-1?t.pop():Rt.call(t,n,1),--this.size,!0)},br.prototype.get=function(e){var t=this.__data__,n=Ar(t,e);return n<0?o:t[n][1]},br.prototype.has=function(e){return Ar(this.__data__,e)>-1},br.prototype.set=function(e,t){var n=this.__data__,r=Ar(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this},wr.prototype.clear=function(){this.size=0,this.__data__={hash:new yr,map:new(Jn||br),string:new yr}},wr.prototype.delete=function(e){var t=Fo(this,e).delete(e);return this.size-=t?1:0,t},wr.prototype.get=function(e){return Fo(this,e).get(e)},wr.prototype.has=function(e){return Fo(this,e).has(e)},wr.prototype.set=function(e,t){var n=Fo(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this},_r.prototype.add=_r.prototype.push=function(e){return this.__data__.set(e,c),this},_r.prototype.has=function(e){return this.__data__.has(e)},Cr.prototype.clear=function(){this.__data__=new br,this.size=0},Cr.prototype.delete=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n},Cr.prototype.get=function(e){return this.__data__.get(e)},Cr.prototype.has=function(e){return this.__data__.has(e)},Cr.prototype.set=function(e,t){var n=this.__data__;if(n instanceof br){var r=n.__data__;if(!Jn||r.length<a-1)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new wr(r)}return n.set(e,t),this.size=n.size,this};var Br=ao(Gr),Vr=ao(Qr,!0);function Wr(e,t){var n=!0;return Br(e,(function(e,r,i){return n=!!t(e,r,i)})),n}function Ur(e,t,n){for(var r=-1,i=e.length;++r<i;){var a=e[r],s=t(a);if(null!=s&&(u===o?s==s&&!Rs(s):n(s,u)))var u=s,c=a}return c}function Hr(e,t){var n=[];return Br(e,(function(e,r,i){t(e,r,i)&&n.push(e)})),n}function zr(e,t,n,r,i){var o=-1,a=e.length;for(n||(n=qo),i||(i=[]);++o<a;){var s=e[o];t>0&&n(s)?t>1?zr(s,t-1,n,r,i):en(i,s):r||(i[i.length]=s)}return i}var qr=so(),Kr=so(!0);function Gr(e,t){return e&&qr(e,t,iu)}function Qr(e,t){return e&&Kr(e,t,iu)}function $r(e,t){return Yt(t,(function(t){return Ss(e[t])}))}function Yr(e,t){for(var n=0,r=(t=Ki(t,e)).length;null!=e&&n<r;)e=e[la(t[n++])];return n&&n==r?e:o}function Xr(e,t,n){var r=t(e);return vs(e)?r:en(r,n(e))}function Jr(e){return null==e?e===o?oe:J:on&&on in tt(e)?function(e){var t=lt.call(e,on),n=e[on];try{e[on]=o;var r=!0}catch(a){}var i=pt.call(e);r&&(t?e[on]=n:delete e[on]);return i}(e):function(e){return pt.call(e)}(e)}function Zr(e,t){return e>t}function ei(e,t){return null!=e&&lt.call(e,t)}function ti(e,t){return null!=e&&t in tt(e)}function ni(e,t,n){for(var i=n?Jt:Xt,a=e[0].length,s=e.length,u=s,c=r(s),l=1/0,h=[];u--;){var d=e[u];u&&t&&(d=Zt(d,vn(t))),l=Kn(d.length,l),c[u]=!n&&(t||a>=120&&d.length>=120)?new _r(u&&d):o}d=e[0];var p=-1,f=c[0];e:for(;++p<a&&h.length<l;){var m=d[p],g=t?t(m):m;if(m=n||0!==m?m:0,!(f?bn(f,g):i(h,g,n))){for(u=s;--u;){var v=c[u];if(!(v?bn(v,g):i(e[u],g,n)))continue e}f&&f.push(g),h.push(m)}}return h}function ri(e,t,n){var r=null==(e=ta(e,t=Ki(t,e)))?e:e[la(Ta(t))];return null==r?o:qt(r,e,n)}function ii(e){return ks(e)&&Jr(e)==W}function oi(e,t,n,r,i){return e===t||(null==e||null==t||!ks(e)&&!ks(t)?e!=e&&t!=t:function(e,t,n,r,i,a){var s=vs(e),u=vs(t),c=s?U:Uo(e),l=u?U:Uo(t),h=(c=c==W?Z:c)==Z,d=(l=l==W?Z:l)==Z,p=c==l;if(p&&_s(e)){if(!_s(t))return!1;s=!0,h=!1}if(p&&!h)return a||(a=new Cr),s||Ps(e)?Ao(e,t,n,r,i,a):function(e,t,n,r,i,o,a){switch(n){case ce:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case ue:return!(e.byteLength!=t.byteLength||!o(new Ct(e),new Ct(t)));case z:case q:case X:return ps(+e,+t);case G:return e.name==t.name&&e.message==t.message;case te:case re:return e==t+"";case Y:var s=xn;case ne:var u=r&m;if(s||(s=An),e.size!=t.size&&!u)return!1;var c=a.get(e);if(c)return c==t;r|=g,a.set(e,t);var l=Ao(s(e),s(t),r,i,o,a);return a.delete(e),l;case ie:if(hr)return hr.call(e)==hr.call(t)}return!1}(e,t,c,n,r,i,a);if(!(n&m)){var f=h&&lt.call(e,"__wrapped__"),v=d&&lt.call(t,"__wrapped__");if(f||v){var y=f?e.value():e,b=v?t.value():t;return a||(a=new Cr),i(y,b,n,r,a)}}if(!p)return!1;return a||(a=new Cr),function(e,t,n,r,i,a){var s=n&m,u=Lo(e),c=u.length,l=Lo(t).length;if(c!=l&&!s)return!1;var h=c;for(;h--;){var d=u[h];if(!(s?d in t:lt.call(t,d)))return!1}var p=a.get(e);if(p&&a.get(t))return p==t;var f=!0;a.set(e,t),a.set(t,e);var g=s;for(;++h<c;){d=u[h];var v=e[d],y=t[d];if(r)var b=s?r(y,v,d,t,e,a):r(v,y,d,e,t,a);if(!(b===o?v===y||i(v,y,n,r,a):b)){f=!1;break}g||(g="constructor"==d)}if(f&&!g){var w=e.constructor,_=t.constructor;w!=_&&"constructor"in e&&"constructor"in t&&!("function"==typeof w&&w instanceof w&&"function"==typeof _&&_ instanceof _)&&(f=!1)}return a.delete(e),a.delete(t),f}(e,t,n,r,i,a)}(e,t,n,r,oi,i))}function ai(e,t,n,r){var i=n.length,a=i,s=!r;if(null==e)return!a;for(e=tt(e);i--;){var u=n[i];if(s&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++i<a;){var c=(u=n[i])[0],l=e[c],h=u[1];if(s&&u[2]){if(l===o&&!(c in e))return!1}else{var d=new Cr;if(r)var p=r(l,h,c,e,t,d);if(!(p===o?oi(h,l,m|g,r,d):p))return!1}}return!0}function si(e){return!(!Is(e)||(t=e,dt&&dt in t))&&(Ss(e)?gt:Ke).test(ha(e));var t}function ui(e){return"function"==typeof e?e:null==e?Nu:"object"==typeof e?vs(e)?fi(e[0],e[1]):pi(e):Bu(e)}function ci(e){if(!Xo(e))return zn(e);var t=[];for(var n in tt(e))lt.call(e,n)&&"constructor"!=n&&t.push(n);return t}function li(e){if(!Is(e))return function(e){var t=[];if(null!=e)for(var n in tt(e))t.push(n);return t}(e);var t=Xo(e),n=[];for(var r in e)("constructor"!=r||!t&&lt.call(e,r))&&n.push(r);return n}function hi(e,t){return e<t}function di(e,t){var n=-1,i=bs(e)?r(e.length):[];return Br(e,(function(e,r,o){i[++n]=t(e,r,o)})),i}function pi(e){var t=jo(e);return 1==t.length&&t[0][2]?Zo(t[0][0],t[0][1]):function(n){return n===e||ai(n,e,t)}}function fi(e,t){return Qo(e)&&Jo(t)?Zo(la(e),t):function(n){var r=Zs(n,e);return r===o&&r===t?eu(n,e):oi(t,r,m|g)}}function mi(e,t,n,r,i){e!==t&&qr(t,(function(a,s){if(i||(i=new Cr),Is(a))!function(e,t,n,r,i,a,s){var u=na(e,n),c=na(t,n),l=s.get(c);if(l)return void Ir(e,n,l);var h=a?a(u,c,n+"",e,t,s):o,d=h===o;if(d){var p=vs(c),f=!p&&_s(c),m=!p&&!f&&Ps(c);h=c,p||f||m?vs(u)?h=u:ws(u)?h=no(u):f?(d=!1,h=Yi(c,!0)):m?(d=!1,h=Ji(c,!0)):h=[]:Ls(c)||gs(c)?(h=u,gs(u)?h=zs(u):Is(u)&&!Ss(u)||(h=zo(c))):d=!1}d&&(s.set(c,h),i(h,c,r,a,s),s.delete(c));Ir(e,n,h)}(e,t,s,n,mi,r,i);else{var u=r?r(na(e,s),a,s+"",e,t,i):o;u===o&&(u=a),Ir(e,s,u)}}),ou)}function gi(e,t){var n=e.length;if(n)return Ko(t+=t<0?n:0,n)?e[t]:o}function vi(e,t,n){var r=-1;return t=Zt(t.length?t:[Nu],vn(Po())),function(e,t){var n=e.length;for(e.sort(t);n--;)e[n]=e[n].value;return e}(di(e,(function(e,n,i){return{criteria:Zt(t,(function(t){return t(e)})),index:++r,value:e}})),(function(e,t){return function(e,t,n){var r=-1,i=e.criteria,o=t.criteria,a=i.length,s=n.length;for(;++r<a;){var u=Zi(i[r],o[r]);if(u){if(r>=s)return u;var c=n[r];return u*("desc"==c?-1:1)}}return e.index-t.index}(e,t,n)}))}function yi(e,t,n){for(var r=-1,i=t.length,o={};++r<i;){var a=t[r],s=Yr(e,a);n(s,a)&&xi(o,Ki(a,e),s)}return o}function bi(e,t,n,r){var i=r?cn:un,o=-1,a=t.length,s=e;for(e===t&&(t=no(t)),n&&(s=Zt(e,vn(n)));++o<a;)for(var u=0,c=t[o],l=n?n(c):c;(u=i(s,l,u,r))>-1;)s!==e&&Rt.call(s,u,1),Rt.call(e,u,1);return e}function wi(e,t){for(var n=e?t.length:0,r=n-1;n--;){var i=t[n];if(n==r||i!==o){var o=i;Ko(i)?Rt.call(e,i,1):ji(e,i)}}return e}function _i(e,t){return e+Bn($n()*(t-e+1))}function Ci(e,t){var n="";if(!e||t<1||t>M)return n;do{t%2&&(n+=e),(t=Bn(t/2))&&(e+=e)}while(t);return n}function Ti(e,t){return oa(ea(e,t,Nu),e+"")}function Si(e){return Sr(pu(e))}function Ei(e,t){var n=pu(e);return ua(n,Mr(t,0,n.length))}function xi(e,t,n,r){if(!Is(e))return e;for(var i=-1,a=(t=Ki(t,e)).length,s=a-1,u=e;null!=u&&++i<a;){var c=la(t[i]),l=n;if(i!=s){var h=u[c];(l=r?r(h,c,u):o)===o&&(l=Is(h)?h:Ko(t[i+1])?[]:{})}kr(u,c,l),u=u[c]}return e}var Ii=rr?function(e,t){return rr.set(e,t),e}:Nu,ki=pn?function(e,t){return pn(e,"toString",{configurable:!0,enumerable:!1,value:Iu(t),writable:!0})}:Nu;function Ai(e){return ua(pu(e))}function Ni(e,t,n){var i=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(n=n>o?o:n)<0&&(n+=o),o=t>n?0:n-t>>>0,t>>>=0;for(var a=r(o);++i<o;)a[i]=e[i+t];return a}function Li(e,t){var n;return Br(e,(function(e,r,i){return!(n=t(e,r,i))})),!!n}function Di(e,t,n){var r=0,i=null==e?r:e.length;if("number"==typeof t&&t==t&&i<=B){for(;r<i;){var o=r+i>>>1,a=e[o];null!==a&&!Rs(a)&&(n?a<=t:a<t)?r=o+1:i=o}return i}return Oi(e,t,Nu,n)}function Oi(e,t,n,r){t=n(t);for(var i=0,a=null==e?0:e.length,s=t!=t,u=null===t,c=Rs(t),l=t===o;i<a;){var h=Bn((i+a)/2),d=n(e[h]),p=d!==o,f=null===d,m=d==d,g=Rs(d);if(s)var v=r||m;else v=l?m&&(r||p):u?m&&p&&(r||!f):c?m&&p&&!f&&(r||!g):!f&&!g&&(r?d<=t:d<t);v?i=h+1:a=h}return Kn(a,j)}function Mi(e,t){for(var n=-1,r=e.length,i=0,o=[];++n<r;){var a=e[n],s=t?t(a):a;if(!n||!ps(s,u)){var u=s;o[i++]=0===a?0:a}}return o}function Ri(e){return"number"==typeof e?e:Rs(e)?P:+e}function Pi(e){if("string"==typeof e)return e;if(vs(e))return Zt(e,Pi)+"";if(Rs(e))return dr?dr.call(e):"";var t=e+"";return"0"==t&&1/e==-O?"-0":t}function Fi(e,t,n){var r=-1,i=Xt,o=e.length,s=!0,u=[],c=u;if(n)s=!1,i=Jt;else if(o>=a){var l=t?null:To(e);if(l)return An(l);s=!1,i=bn,c=new _r}else c=t?[]:u;e:for(;++r<o;){var h=e[r],d=t?t(h):h;if(h=n||0!==h?h:0,s&&d==d){for(var p=c.length;p--;)if(c[p]===d)continue e;t&&c.push(d),u.push(h)}else i(c,d,n)||(c!==u&&c.push(d),u.push(h))}return u}function ji(e,t){return null==(e=ta(e,t=Ki(t,e)))||delete e[la(Ta(t))]}function Bi(e,t,n,r){return xi(e,t,n(Yr(e,t)),r)}function Vi(e,t,n,r){for(var i=e.length,o=r?i:-1;(r?o--:++o<i)&&t(e[o],o,e););return n?Ni(e,r?0:o,r?o+1:i):Ni(e,r?o+1:0,r?i:o)}function Wi(e,t){var n=e;return n instanceof vr&&(n=n.value()),tn(t,(function(e,t){return t.func.apply(t.thisArg,en([e],t.args))}),n)}function Ui(e,t,n){var i=e.length;if(i<2)return i?Fi(e[0]):[];for(var o=-1,a=r(i);++o<i;)for(var s=e[o],u=-1;++u<i;)u!=o&&(a[o]=jr(a[o]||s,e[u],t,n));return Fi(zr(a,1),t,n)}function Hi(e,t,n){for(var r=-1,i=e.length,a=t.length,s={};++r<i;){var u=r<a?t[r]:o;n(s,e[r],u)}return s}function zi(e){return ws(e)?e:[]}function qi(e){return"function"==typeof e?e:Nu}function Ki(e,t){return vs(e)?e:Qo(e,t)?[e]:ca(qs(e))}var Gi=Ti;function Qi(e,t,n){var r=e.length;return n=n===o?r:n,!t&&n>=r?e:Ni(e,t,n)}var $i=Rn||function(e){return Ot.clearTimeout(e)};function Yi(e,t){if(t)return e.slice();var n=e.length,r=kt?kt(n):new e.constructor(n);return e.copy(r),r}function Xi(e){var t=new e.constructor(e.byteLength);return new Ct(t).set(new Ct(e)),t}function Ji(e,t){var n=t?Xi(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}function Zi(e,t){if(e!==t){var n=e!==o,r=null===e,i=e==e,a=Rs(e),s=t!==o,u=null===t,c=t==t,l=Rs(t);if(!u&&!l&&!a&&e>t||a&&s&&c&&!u&&!l||r&&s&&c||!n&&c||!i)return 1;if(!r&&!a&&!l&&e<t||l&&n&&i&&!r&&!a||u&&n&&i||!s&&i||!c)return-1}return 0}function eo(e,t,n,i){for(var o=-1,a=e.length,s=n.length,u=-1,c=t.length,l=qn(a-s,0),h=r(c+l),d=!i;++u<c;)h[u]=t[u];for(;++o<s;)(d||o<a)&&(h[n[o]]=e[o]);for(;l--;)h[u++]=e[o++];return h}function to(e,t,n,i){for(var o=-1,a=e.length,s=-1,u=n.length,c=-1,l=t.length,h=qn(a-u,0),d=r(h+l),p=!i;++o<h;)d[o]=e[o];for(var f=o;++c<l;)d[f+c]=t[c];for(;++s<u;)(p||o<a)&&(d[f+n[s]]=e[o++]);return d}function no(e,t){var n=-1,i=e.length;for(t||(t=r(i));++n<i;)t[n]=e[n];return t}function ro(e,t,n,r){var i=!n;n||(n={});for(var a=-1,s=t.length;++a<s;){var u=t[a],c=r?r(n[u],e[u],u,n,e):o;c===o&&(c=e[u]),i?Dr(n,u,c):kr(n,u,c)}return n}function io(e,t){return function(n,r){var i=vs(n)?Kt:Nr,o=t?t():{};return i(n,e,Po(r,2),o)}}function oo(e){return Ti((function(t,n){var r=-1,i=n.length,a=i>1?n[i-1]:o,s=i>2?n[2]:o;for(a=e.length>3&&"function"==typeof a?(i--,a):o,s&&Go(n[0],n[1],s)&&(a=i<3?o:a,i=1),t=tt(t);++r<i;){var u=n[r];u&&e(t,u,r,a)}return t}))}function ao(e,t){return function(n,r){if(null==n)return n;if(!bs(n))return e(n,r);for(var i=n.length,o=t?i:-1,a=tt(n);(t?o--:++o<i)&&!1!==r(a[o],o,a););return n}}function so(e){return function(t,n,r){for(var i=-1,o=tt(t),a=r(t),s=a.length;s--;){var u=a[e?s:++i];if(!1===n(o[u],u,o))break}return t}}function uo(e){return function(t){var n=En(t=qs(t))?Dn(t):o,r=n?n[0]:t.charAt(0),i=n?Qi(n,1).join(""):t.slice(1);return r[e]()+i}}function co(e){return function(t){return tn(Su(gu(t).replace(yt,"")),e,"")}}function lo(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var n=fr(e.prototype),r=e.apply(n,t);return Is(r)?r:n}}function ho(e){return function(t,n,r){var i=tt(t);if(!bs(t)){var a=Po(n,3);t=iu(t),n=function(e){return a(i[e],e,i)}}var s=e(t,n,r);return s>-1?i[a?t[s]:s]:o}}function po(e){return No((function(t){var n=t.length,r=n,i=gr.prototype.thru;for(e&&t.reverse();r--;){var a=t[r];if("function"!=typeof a)throw new it(u);if(i&&!s&&"wrapper"==Mo(a))var s=new gr([],!0)}for(r=s?r:n;++r<n;){var c=Mo(a=t[r]),l="wrapper"==c?Oo(a):o;s=l&&$o(l[0])&&l[1]==(S|w|C|E)&&!l[4].length&&1==l[9]?s[Mo(l[0])].apply(s,l[3]):1==a.length&&$o(a)?s[c]():s.thru(a)}return function(){var e=arguments,r=e[0];if(s&&1==e.length&&vs(r))return s.plant(r).value();for(var i=0,o=n?t[i].apply(this,e):r;++i<n;)o=t[i].call(this,o);return o}}))}function fo(e,t,n,i,a,s,u,c,l,h){var d=t&S,p=t&v,f=t&y,m=t&(w|_),g=t&x,b=f?o:lo(e);return function v(){for(var y=arguments.length,w=r(y),_=y;_--;)w[_]=arguments[_];if(m)var C=Ro(v),T=function(e,t){for(var n=e.length,r=0;n--;)e[n]===t&&++r;return r}(w,C);if(i&&(w=eo(w,i,a,m)),s&&(w=to(w,s,u,m)),y-=T,m&&y<h){var S=kn(w,C);return _o(e,t,fo,v.placeholder,n,w,S,c,l,h-y)}var E=p?n:this,x=f?E[e]:e;return y=w.length,c?w=function(e,t){var n=e.length,r=Kn(t.length,n),i=no(e);for(;r--;){var a=t[r];e[r]=Ko(a,n)?i[a]:o}return e}(w,c):g&&y>1&&w.reverse(),d&&l<y&&(w.length=l),this&&this!==Ot&&this instanceof v&&(x=b||lo(x)),x.apply(E,w)}}function mo(e,t){return function(n,r){return function(e,t,n,r){return Gr(e,(function(e,i,o){t(r,n(e),i,o)})),r}(n,e,t(r),{})}}function go(e,t){return function(n,r){var i;if(n===o&&r===o)return t;if(n!==o&&(i=n),r!==o){if(i===o)return r;"string"==typeof n||"string"==typeof r?(n=Pi(n),r=Pi(r)):(n=Ri(n),r=Ri(r)),i=e(n,r)}return i}}function vo(e){return No((function(t){return t=Zt(t,vn(Po())),Ti((function(n){var r=this;return e(t,(function(e){return qt(e,r,n)}))}))}))}function yo(e,t){var n=(t=t===o?" ":Pi(t)).length;if(n<2)return n?Ci(t,e):t;var r=Ci(t,jn(e/Ln(t)));return En(t)?Qi(Dn(r),0,e).join(""):r.slice(0,e)}function bo(e){return function(t,n,i){return i&&"number"!=typeof i&&Go(t,n,i)&&(n=i=o),t=Vs(t),n===o?(n=t,t=0):n=Vs(n),function(e,t,n,i){for(var o=-1,a=qn(jn((t-e)/(n||1)),0),s=r(a);a--;)s[i?a:++o]=e,e+=n;return s}(t,n,i=i===o?t<n?1:-1:Vs(i),e)}}function wo(e){return function(t,n){return"string"==typeof t&&"string"==typeof n||(t=Hs(t),n=Hs(n)),e(t,n)}}function _o(e,t,n,r,i,a,s,u,c,l){var h=t&w;t|=h?C:T,(t&=~(h?T:C))&b||(t&=~(v|y));var d=[e,t,i,h?a:o,h?s:o,h?o:a,h?o:s,u,c,l],p=n.apply(o,d);return $o(e)&&ra(p,d),p.placeholder=r,aa(p,e,t)}function Co(e){var t=et[e];return function(e,n){if(e=Hs(e),(n=null==n?0:Kn(Ws(n),292))&&Un(e)){var r=(qs(e)+"e").split("e");return+((r=(qs(t(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}var To=er&&1/An(new er([,-0]))[1]==O?function(e){return new er(e)}:Ru;function So(e){return function(t){var n=Uo(t);return n==Y?xn(t):n==ne?Nn(t):function(e,t){return Zt(t,(function(t){return[t,e[t]]}))}(t,e(t))}}function Eo(e,t,n,i,a,s,c,l){var d=t&y;if(!d&&"function"!=typeof e)throw new it(u);var p=i?i.length:0;if(p||(t&=~(C|T),i=a=o),c=c===o?c:qn(Ws(c),0),l=l===o?l:Ws(l),p-=a?a.length:0,t&T){var f=i,m=a;i=a=o}var g=d?o:Oo(e),x=[e,t,n,i,a,f,m,s,c,l];if(g&&function(e,t){var n=e[1],r=t[1],i=n|r,o=i<(v|y|S),a=r==S&&n==w||r==S&&n==E&&e[7].length<=t[8]||r==(S|E)&&t[7].length<=t[8]&&n==w;if(!o&&!a)return e;r&v&&(e[2]=t[2],i|=n&v?0:b);var s=t[3];if(s){var u=e[3];e[3]=u?eo(u,s,t[4]):s,e[4]=u?kn(e[3],h):t[4]}(s=t[5])&&(u=e[5],e[5]=u?to(u,s,t[6]):s,e[6]=u?kn(e[5],h):t[6]);(s=t[7])&&(e[7]=s);r&S&&(e[8]=null==e[8]?t[8]:Kn(e[8],t[8]));null==e[9]&&(e[9]=t[9]);e[0]=t[0],e[1]=i}(x,g),e=x[0],t=x[1],n=x[2],i=x[3],a=x[4],!(l=x[9]=x[9]===o?d?0:e.length:qn(x[9]-p,0))&&t&(w|_)&&(t&=~(w|_)),t&&t!=v)I=t==w||t==_?function(e,t,n){var i=lo(e);return function a(){for(var s=arguments.length,u=r(s),c=s,l=Ro(a);c--;)u[c]=arguments[c];var h=s<3&&u[0]!==l&&u[s-1]!==l?[]:kn(u,l);return(s-=h.length)<n?_o(e,t,fo,a.placeholder,o,u,h,o,o,n-s):qt(this&&this!==Ot&&this instanceof a?i:e,this,u)}}(e,t,l):t!=C&&t!=(v|C)||a.length?fo.apply(o,x):function(e,t,n,i){var o=t&v,a=lo(e);return function t(){for(var s=-1,u=arguments.length,c=-1,l=i.length,h=r(l+u),d=this&&this!==Ot&&this instanceof t?a:e;++c<l;)h[c]=i[c];for(;u--;)h[c++]=arguments[++s];return qt(d,o?n:this,h)}}(e,t,n,i);else var I=function(e,t,n){var r=t&v,i=lo(e);return function t(){return(this&&this!==Ot&&this instanceof t?i:e).apply(r?n:this,arguments)}}(e,t,n);return aa((g?Ii:ra)(I,x),e,t)}function xo(e,t,n,r){return e===o||ps(e,st[n])&&!lt.call(r,n)?t:e}function Io(e,t,n,r,i,a){return Is(e)&&Is(t)&&(a.set(t,e),mi(e,t,o,Io,a),a.delete(t)),e}function ko(e){return Ls(e)?o:e}function Ao(e,t,n,r,i,a){var s=n&m,u=e.length,c=t.length;if(u!=c&&!(s&&c>u))return!1;var l=a.get(e);if(l&&a.get(t))return l==t;var h=-1,d=!0,p=n&g?new _r:o;for(a.set(e,t),a.set(t,e);++h<u;){var f=e[h],v=t[h];if(r)var y=s?r(v,f,h,t,e,a):r(f,v,h,e,t,a);if(y!==o){if(y)continue;d=!1;break}if(p){if(!rn(t,(function(e,t){if(!bn(p,t)&&(f===e||i(f,e,n,r,a)))return p.push(t)}))){d=!1;break}}else if(f!==v&&!i(f,v,n,r,a)){d=!1;break}}return a.delete(e),a.delete(t),d}function No(e){return oa(ea(e,o,ya),e+"")}function Lo(e){return Xr(e,iu,Vo)}function Do(e){return Xr(e,ou,Wo)}var Oo=rr?function(e){return rr.get(e)}:Ru;function Mo(e){for(var t=e.name+"",n=ir[t],r=lt.call(ir,t)?n.length:0;r--;){var i=n[r],o=i.func;if(null==o||o==e)return i.name}return t}function Ro(e){return(lt.call(pr,"placeholder")?pr:e).placeholder}function Po(){var e=pr.iteratee||Lu;return e=e===Lu?ui:e,arguments.length?e(arguments[0],arguments[1]):e}function Fo(e,t){var n,r,i=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?i["string"==typeof t?"string":"hash"]:i.map}function jo(e){for(var t=iu(e),n=t.length;n--;){var r=t[n],i=e[r];t[n]=[r,i,Jo(i)]}return t}function Bo(e,t){var n=function(e,t){return null==e?o:e[t]}(e,t);return si(n)?n:o}var Vo=Vn?function(e){return null==e?[]:(e=tt(e),Yt(Vn(e),(function(t){return Mt.call(e,t)})))}:Uu,Wo=Vn?function(e){for(var t=[];e;)en(t,Vo(e)),e=Lt(e);return t}:Uu,Uo=Jr;function Ho(e,t,n){for(var r=-1,i=(t=Ki(t,e)).length,o=!1;++r<i;){var a=la(t[r]);if(!(o=null!=e&&n(e,a)))break;e=e[a]}return o||++r!=i?o:!!(i=null==e?0:e.length)&&xs(i)&&Ko(a,i)&&(vs(e)||gs(e))}function zo(e){return"function"!=typeof e.constructor||Xo(e)?{}:fr(Lt(e))}function qo(e){return vs(e)||gs(e)||!!(Ft&&e&&e[Ft])}function Ko(e,t){var n=typeof e;return!!(t=null==t?M:t)&&("number"==n||"symbol"!=n&&Qe.test(e))&&e>-1&&e%1==0&&e<t}function Go(e,t,n){if(!Is(n))return!1;var r=typeof t;return!!("number"==r?bs(n)&&Ko(t,n.length):"string"==r&&t in n)&&ps(n[t],e)}function Qo(e,t){if(vs(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!Rs(e))||(Ne.test(e)||!Ae.test(e)||null!=t&&e in tt(t))}function $o(e){var t=Mo(e),n=pr[t];if("function"!=typeof n||!(t in vr.prototype))return!1;if(e===n)return!0;var r=Oo(n);return!!r&&e===r[0]}(Xn&&Uo(new Xn(new ArrayBuffer(1)))!=ce||Jn&&Uo(new Jn)!=Y||Zn&&"[object Promise]"!=Uo(Zn.resolve())||er&&Uo(new er)!=ne||tr&&Uo(new tr)!=ae)&&(Uo=function(e){var t=Jr(e),n=t==Z?e.constructor:o,r=n?ha(n):"";if(r)switch(r){case or:return ce;case ar:return Y;case sr:return"[object Promise]";case ur:return ne;case cr:return ae}return t});var Yo=ut?Ss:Hu;function Xo(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||st)}function Jo(e){return e==e&&!Is(e)}function Zo(e,t){return function(n){return null!=n&&(n[e]===t&&(t!==o||e in tt(n)))}}function ea(e,t,n){return t=qn(t===o?e.length-1:t,0),function(){for(var i=arguments,o=-1,a=qn(i.length-t,0),s=r(a);++o<a;)s[o]=i[t+o];o=-1;for(var u=r(t+1);++o<t;)u[o]=i[o];return u[t]=n(s),qt(e,this,u)}}function ta(e,t){return t.length<2?e:Yr(e,Ni(t,0,-1))}function na(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var ra=sa(Ii),ia=Fn||function(e,t){return Ot.setTimeout(e,t)},oa=sa(ki);function aa(e,t,n){var r=t+"";return oa(e,function(e,t){var n=t.length;if(!n)return e;var r=n-1;return t[r]=(n>1?"& ":"")+t[r],t=t.join(n>2?", ":" "),e.replace(Fe,"{\n/* [wrapped with "+t+"] */\n")}(r,function(e,t){return Gt(V,(function(n){var r="_."+n[0];t&n[1]&&!Xt(e,r)&&e.push(r)})),e.sort()}(function(e){var t=e.match(je);return t?t[1].split(Be):[]}(r),n)))}function sa(e){var t=0,n=0;return function(){var r=Gn(),i=N-(r-n);if(n=r,i>0){if(++t>=A)return arguments[0]}else t=0;return e.apply(o,arguments)}}function ua(e,t){var n=-1,r=e.length,i=r-1;for(t=t===o?r:t;++n<t;){var a=_i(n,i),s=e[a];e[a]=e[n],e[n]=s}return e.length=t,e}var ca=function(e){var t=ss(e,(function(e){return n.size===l&&n.clear(),e})),n=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Le,(function(e,n,r,i){t.push(r?i.replace(We,"$1"):n||e)})),t}));function la(e){if("string"==typeof e||Rs(e))return e;var t=e+"";return"0"==t&&1/e==-O?"-0":t}function ha(e){if(null!=e){try{return ct.call(e)}catch(t){}try{return e+""}catch(t){}}return""}function da(e){if(e instanceof vr)return e.clone();var t=new gr(e.__wrapped__,e.__chain__);return t.__actions__=no(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var pa=Ti((function(e,t){return ws(e)?jr(e,zr(t,1,ws,!0)):[]})),fa=Ti((function(e,t){var n=Ta(t);return ws(n)&&(n=o),ws(e)?jr(e,zr(t,1,ws,!0),Po(n,2)):[]})),ma=Ti((function(e,t){var n=Ta(t);return ws(n)&&(n=o),ws(e)?jr(e,zr(t,1,ws,!0),o,n):[]}));function ga(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=null==n?0:Ws(n);return i<0&&(i=qn(r+i,0)),sn(e,Po(t,3),i)}function va(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=r-1;return n!==o&&(i=Ws(n),i=n<0?qn(r+i,0):Kn(i,r-1)),sn(e,Po(t,3),i,!0)}function ya(e){return(null==e?0:e.length)?zr(e,1):[]}function ba(e){return e&&e.length?e[0]:o}var wa=Ti((function(e){var t=Zt(e,zi);return t.length&&t[0]===e[0]?ni(t):[]})),_a=Ti((function(e){var t=Ta(e),n=Zt(e,zi);return t===Ta(n)?t=o:n.pop(),n.length&&n[0]===e[0]?ni(n,Po(t,2)):[]})),Ca=Ti((function(e){var t=Ta(e),n=Zt(e,zi);return(t="function"==typeof t?t:o)&&n.pop(),n.length&&n[0]===e[0]?ni(n,o,t):[]}));function Ta(e){var t=null==e?0:e.length;return t?e[t-1]:o}var Sa=Ti(Ea);function Ea(e,t){return e&&e.length&&t&&t.length?bi(e,t):e}var xa=No((function(e,t){var n=null==e?0:e.length,r=Or(e,t);return wi(e,Zt(t,(function(e){return Ko(e,n)?+e:e})).sort(Zi)),r}));function Ia(e){return null==e?e:Yn.call(e)}var ka=Ti((function(e){return Fi(zr(e,1,ws,!0))})),Aa=Ti((function(e){var t=Ta(e);return ws(t)&&(t=o),Fi(zr(e,1,ws,!0),Po(t,2))})),Na=Ti((function(e){var t=Ta(e);return t="function"==typeof t?t:o,Fi(zr(e,1,ws,!0),o,t)}));function La(e){if(!e||!e.length)return[];var t=0;return e=Yt(e,(function(e){if(ws(e))return t=qn(e.length,t),!0})),gn(t,(function(t){return Zt(e,dn(t))}))}function Da(e,t){if(!e||!e.length)return[];var n=La(e);return null==t?n:Zt(n,(function(e){return qt(t,o,e)}))}var Oa=Ti((function(e,t){return ws(e)?jr(e,t):[]})),Ma=Ti((function(e){return Ui(Yt(e,ws))})),Ra=Ti((function(e){var t=Ta(e);return ws(t)&&(t=o),Ui(Yt(e,ws),Po(t,2))})),Pa=Ti((function(e){var t=Ta(e);return t="function"==typeof t?t:o,Ui(Yt(e,ws),o,t)})),Fa=Ti(La);var ja=Ti((function(e){var t=e.length,n=t>1?e[t-1]:o;return n="function"==typeof n?(e.pop(),n):o,Da(e,n)}));function Ba(e){var t=pr(e);return t.__chain__=!0,t}function Va(e,t){return t(e)}var Wa=No((function(e){var t=e.length,n=t?e[0]:0,r=this.__wrapped__,i=function(t){return Or(t,e)};return!(t>1||this.__actions__.length)&&r instanceof vr&&Ko(n)?((r=r.slice(n,+n+(t?1:0))).__actions__.push({func:Va,args:[i],thisArg:o}),new gr(r,this.__chain__).thru((function(e){return t&&!e.length&&e.push(o),e}))):this.thru(i)}));var Ua=io((function(e,t,n){lt.call(e,n)?++e[n]:Dr(e,n,1)}));var Ha=ho(ga),za=ho(va);function qa(e,t){return(vs(e)?Gt:Br)(e,Po(t,3))}function Ka(e,t){return(vs(e)?Qt:Vr)(e,Po(t,3))}var Ga=io((function(e,t,n){lt.call(e,n)?e[n].push(t):Dr(e,n,[t])}));var Qa=Ti((function(e,t,n){var i=-1,o="function"==typeof t,a=bs(e)?r(e.length):[];return Br(e,(function(e){a[++i]=o?qt(t,e,n):ri(e,t,n)})),a})),$a=io((function(e,t,n){Dr(e,n,t)}));function Ya(e,t){return(vs(e)?Zt:di)(e,Po(t,3))}var Xa=io((function(e,t,n){e[n?0:1].push(t)}),(function(){return[[],[]]}));var Ja=Ti((function(e,t){if(null==e)return[];var n=t.length;return n>1&&Go(e,t[0],t[1])?t=[]:n>2&&Go(t[0],t[1],t[2])&&(t=[t[0]]),vi(e,zr(t,1),[])})),Za=Pn||function(){return Ot.Date.now()};function es(e,t,n){return t=n?o:t,t=e&&null==t?e.length:t,Eo(e,S,o,o,o,o,t)}function ts(e,t){var n;if("function"!=typeof t)throw new it(u);return e=Ws(e),function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=o),n}}var ns=Ti((function(e,t,n){var r=v;if(n.length){var i=kn(n,Ro(ns));r|=C}return Eo(e,r,t,n,i)})),rs=Ti((function(e,t,n){var r=v|y;if(n.length){var i=kn(n,Ro(rs));r|=C}return Eo(t,r,e,n,i)}));function is(e,t,n){var r,i,a,s,c,l,h=0,d=!1,p=!1,f=!0;if("function"!=typeof e)throw new it(u);function m(t){var n=r,a=i;return r=i=o,h=t,s=e.apply(a,n)}function g(e){var n=e-l;return l===o||n>=t||n<0||p&&e-h>=a}function v(){var e=Za();if(g(e))return y(e);c=ia(v,function(e){var n=t-(e-l);return p?Kn(n,a-(e-h)):n}(e))}function y(e){return c=o,f&&r?m(e):(r=i=o,s)}function b(){var e=Za(),n=g(e);if(r=arguments,i=this,l=e,n){if(c===o)return function(e){return h=e,c=ia(v,t),d?m(e):s}(l);if(p)return $i(c),c=ia(v,t),m(l)}return c===o&&(c=ia(v,t)),s}return t=Hs(t)||0,Is(n)&&(d=!!n.leading,a=(p="maxWait"in n)?qn(Hs(n.maxWait)||0,t):a,f="trailing"in n?!!n.trailing:f),b.cancel=function(){c!==o&&$i(c),h=0,r=l=i=c=o},b.flush=function(){return c===o?s:y(Za())},b}var os=Ti((function(e,t){return Fr(e,1,t)})),as=Ti((function(e,t,n){return Fr(e,Hs(t)||0,n)}));function ss(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new it(u);var n=function n(){var r=arguments,i=t?t.apply(this,r):r[0],o=n.cache;if(o.has(i))return o.get(i);var a=e.apply(this,r);return n.cache=o.set(i,a)||o,a};return n.cache=new(ss.Cache||wr),n}function us(e){if("function"!=typeof e)throw new it(u);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}ss.Cache=wr;var cs=Gi((function(e,t){var n=(t=1==t.length&&vs(t[0])?Zt(t[0],vn(Po())):Zt(zr(t,1),vn(Po()))).length;return Ti((function(r){for(var i=-1,o=Kn(r.length,n);++i<o;)r[i]=t[i].call(this,r[i]);return qt(e,this,r)}))})),ls=Ti((function(e,t){var n=kn(t,Ro(ls));return Eo(e,C,o,t,n)})),hs=Ti((function(e,t){var n=kn(t,Ro(hs));return Eo(e,T,o,t,n)})),ds=No((function(e,t){return Eo(e,E,o,o,o,t)}));function ps(e,t){return e===t||e!=e&&t!=t}var fs=wo(Zr),ms=wo((function(e,t){return e>=t})),gs=ii(function(){return arguments}())?ii:function(e){return ks(e)&&lt.call(e,"callee")&&!Mt.call(e,"callee")},vs=r.isArray,ys=Bt?vn(Bt):function(e){return ks(e)&&Jr(e)==ue};function bs(e){return null!=e&&xs(e.length)&&!Ss(e)}function ws(e){return ks(e)&&bs(e)}var _s=Wn||Hu,Cs=Vt?vn(Vt):function(e){return ks(e)&&Jr(e)==q};function Ts(e){if(!ks(e))return!1;var t=Jr(e);return t==G||t==K||"string"==typeof e.message&&"string"==typeof e.name&&!Ls(e)}function Ss(e){if(!Is(e))return!1;var t=Jr(e);return t==Q||t==$||t==H||t==ee}function Es(e){return"number"==typeof e&&e==Ws(e)}function xs(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=M}function Is(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function ks(e){return null!=e&&"object"==typeof e}var As=Wt?vn(Wt):function(e){return ks(e)&&Uo(e)==Y};function Ns(e){return"number"==typeof e||ks(e)&&Jr(e)==X}function Ls(e){if(!ks(e)||Jr(e)!=Z)return!1;var t=Lt(e);if(null===t)return!0;var n=lt.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&ct.call(n)==ft}var Ds=Ut?vn(Ut):function(e){return ks(e)&&Jr(e)==te};var Os=Ht?vn(Ht):function(e){return ks(e)&&Uo(e)==ne};function Ms(e){return"string"==typeof e||!vs(e)&&ks(e)&&Jr(e)==re}function Rs(e){return"symbol"==typeof e||ks(e)&&Jr(e)==ie}var Ps=zt?vn(zt):function(e){return ks(e)&&xs(e.length)&&!!xt[Jr(e)]};var Fs=wo(hi),js=wo((function(e,t){return e<=t}));function Bs(e){if(!e)return[];if(bs(e))return Ms(e)?Dn(e):no(e);if(jt&&e[jt])return function(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}(e[jt]());var t=Uo(e);return(t==Y?xn:t==ne?An:pu)(e)}function Vs(e){return e?(e=Hs(e))===O||e===-O?(e<0?-1:1)*R:e==e?e:0:0===e?e:0}function Ws(e){var t=Vs(e),n=t%1;return t==t?n?t-n:t:0}function Us(e){return e?Mr(Ws(e),0,F):0}function Hs(e){if("number"==typeof e)return e;if(Rs(e))return P;if(Is(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Is(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(Me,"");var n=qe.test(e);return n||Ge.test(e)?Nt(e.slice(2),n?2:8):ze.test(e)?P:+e}function zs(e){return ro(e,ou(e))}function qs(e){return null==e?"":Pi(e)}var Ks=oo((function(e,t){if(Xo(t)||bs(t))ro(t,iu(t),e);else for(var n in t)lt.call(t,n)&&kr(e,n,t[n])})),Gs=oo((function(e,t){ro(t,ou(t),e)})),Qs=oo((function(e,t,n,r){ro(t,ou(t),e,r)})),$s=oo((function(e,t,n,r){ro(t,iu(t),e,r)})),Ys=No(Or);var Xs=Ti((function(e,t){e=tt(e);var n=-1,r=t.length,i=r>2?t[2]:o;for(i&&Go(t[0],t[1],i)&&(r=1);++n<r;)for(var a=t[n],s=ou(a),u=-1,c=s.length;++u<c;){var l=s[u],h=e[l];(h===o||ps(h,st[l])&&!lt.call(e,l))&&(e[l]=a[l])}return e})),Js=Ti((function(e){return e.push(o,Io),qt(su,o,e)}));function Zs(e,t,n){var r=null==e?o:Yr(e,t);return r===o?n:r}function eu(e,t){return null!=e&&Ho(e,t,ti)}var tu=mo((function(e,t,n){null!=t&&"function"!=typeof t.toString&&(t=pt.call(t)),e[t]=n}),Iu(Nu)),nu=mo((function(e,t,n){null!=t&&"function"!=typeof t.toString&&(t=pt.call(t)),lt.call(e,t)?e[t].push(n):e[t]=[n]}),Po),ru=Ti(ri);function iu(e){return bs(e)?Tr(e):ci(e)}function ou(e){return bs(e)?Tr(e,!0):li(e)}var au=oo((function(e,t,n){mi(e,t,n)})),su=oo((function(e,t,n,r){mi(e,t,n,r)})),uu=No((function(e,t){var n={};if(null==e)return n;var r=!1;t=Zt(t,(function(t){return t=Ki(t,e),r||(r=t.length>1),t})),ro(e,Do(e),n),r&&(n=Rr(n,d|p|f,ko));for(var i=t.length;i--;)ji(n,t[i]);return n}));var cu=No((function(e,t){return null==e?{}:function(e,t){return yi(e,t,(function(t,n){return eu(e,n)}))}(e,t)}));function lu(e,t){if(null==e)return{};var n=Zt(Do(e),(function(e){return[e]}));return t=Po(t),yi(e,n,(function(e,n){return t(e,n[0])}))}var hu=So(iu),du=So(ou);function pu(e){return null==e?[]:yn(e,iu(e))}var fu=co((function(e,t,n){return t=t.toLowerCase(),e+(n?mu(t):t)}));function mu(e){return Tu(qs(e).toLowerCase())}function gu(e){return(e=qs(e))&&e.replace($e,Cn).replace(bt,"")}var vu=co((function(e,t,n){return e+(n?"-":"")+t.toLowerCase()})),yu=co((function(e,t,n){return e+(n?" ":"")+t.toLowerCase()})),bu=uo("toLowerCase");var wu=co((function(e,t,n){return e+(n?"_":"")+t.toLowerCase()}));var _u=co((function(e,t,n){return e+(n?" ":"")+Tu(t)}));var Cu=co((function(e,t,n){return e+(n?" ":"")+t.toUpperCase()})),Tu=uo("toUpperCase");function Su(e,t,n){return e=qs(e),(t=n?o:t)===o?function(e){return Tt.test(e)}(e)?function(e){return e.match(_t)||[]}(e):function(e){return e.match(Ve)||[]}(e):e.match(t)||[]}var Eu=Ti((function(e,t){try{return qt(e,o,t)}catch(n){return Ts(n)?n:new Je(n)}})),xu=No((function(e,t){return Gt(t,(function(t){t=la(t),Dr(e,t,ns(e[t],e))})),e}));function Iu(e){return function(){return e}}var ku=po(),Au=po(!0);function Nu(e){return e}function Lu(e){return ui("function"==typeof e?e:Rr(e,d))}var Du=Ti((function(e,t){return function(n){return ri(n,e,t)}})),Ou=Ti((function(e,t){return function(n){return ri(e,n,t)}}));function Mu(e,t,n){var r=iu(t),i=$r(t,r);null!=n||Is(t)&&(i.length||!r.length)||(n=t,t=e,e=this,i=$r(t,iu(t)));var o=!(Is(n)&&"chain"in n&&!n.chain),a=Ss(e);return Gt(i,(function(n){var r=t[n];e[n]=r,a&&(e.prototype[n]=function(){var t=this.__chain__;if(o||t){var n=e(this.__wrapped__),i=n.__actions__=no(this.__actions__);return i.push({func:r,args:arguments,thisArg:e}),n.__chain__=t,n}return r.apply(e,en([this.value()],arguments))})})),e}function Ru(){}var Pu=vo(Zt),Fu=vo($t),ju=vo(rn);function Bu(e){return Qo(e)?dn(la(e)):function(e){return function(t){return Yr(t,e)}}(e)}var Vu=bo(),Wu=bo(!0);function Uu(){return[]}function Hu(){return!1}var zu=go((function(e,t){return e+t}),0),qu=Co("ceil"),Ku=go((function(e,t){return e/t}),1),Gu=Co("floor");var Qu,$u=go((function(e,t){return e*t}),1),Yu=Co("round"),Xu=go((function(e,t){return e-t}),0);return pr.after=function(e,t){if("function"!=typeof t)throw new it(u);return e=Ws(e),function(){if(--e<1)return t.apply(this,arguments)}},pr.ary=es,pr.assign=Ks,pr.assignIn=Gs,pr.assignInWith=Qs,pr.assignWith=$s,pr.at=Ys,pr.before=ts,pr.bind=ns,pr.bindAll=xu,pr.bindKey=rs,pr.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return vs(e)?e:[e]},pr.chain=Ba,pr.chunk=function(e,t,n){t=(n?Go(e,t,n):t===o)?1:qn(Ws(t),0);var i=null==e?0:e.length;if(!i||t<1)return[];for(var a=0,s=0,u=r(jn(i/t));a<i;)u[s++]=Ni(e,a,a+=t);return u},pr.compact=function(e){for(var t=-1,n=null==e?0:e.length,r=0,i=[];++t<n;){var o=e[t];o&&(i[r++]=o)}return i},pr.concat=function(){var e=arguments.length;if(!e)return[];for(var t=r(e-1),n=arguments[0],i=e;i--;)t[i-1]=arguments[i];return en(vs(n)?no(n):[n],zr(t,1))},pr.cond=function(e){var t=null==e?0:e.length,n=Po();return e=t?Zt(e,(function(e){if("function"!=typeof e[1])throw new it(u);return[n(e[0]),e[1]]})):[],Ti((function(n){for(var r=-1;++r<t;){var i=e[r];if(qt(i[0],this,n))return qt(i[1],this,n)}}))},pr.conforms=function(e){return function(e){var t=iu(e);return function(n){return Pr(n,e,t)}}(Rr(e,d))},pr.constant=Iu,pr.countBy=Ua,pr.create=function(e,t){var n=fr(e);return null==t?n:Lr(n,t)},pr.curry=function e(t,n,r){var i=Eo(t,w,o,o,o,o,o,n=r?o:n);return i.placeholder=e.placeholder,i},pr.curryRight=function e(t,n,r){var i=Eo(t,_,o,o,o,o,o,n=r?o:n);return i.placeholder=e.placeholder,i},pr.debounce=is,pr.defaults=Xs,pr.defaultsDeep=Js,pr.defer=os,pr.delay=as,pr.difference=pa,pr.differenceBy=fa,pr.differenceWith=ma,pr.drop=function(e,t,n){var r=null==e?0:e.length;return r?Ni(e,(t=n||t===o?1:Ws(t))<0?0:t,r):[]},pr.dropRight=function(e,t,n){var r=null==e?0:e.length;return r?Ni(e,0,(t=r-(t=n||t===o?1:Ws(t)))<0?0:t):[]},pr.dropRightWhile=function(e,t){return e&&e.length?Vi(e,Po(t,3),!0,!0):[]},pr.dropWhile=function(e,t){return e&&e.length?Vi(e,Po(t,3),!0):[]},pr.fill=function(e,t,n,r){var i=null==e?0:e.length;return i?(n&&"number"!=typeof n&&Go(e,t,n)&&(n=0,r=i),function(e,t,n,r){var i=e.length;for((n=Ws(n))<0&&(n=-n>i?0:i+n),(r=r===o||r>i?i:Ws(r))<0&&(r+=i),r=n>r?0:Us(r);n<r;)e[n++]=t;return e}(e,t,n,r)):[]},pr.filter=function(e,t){return(vs(e)?Yt:Hr)(e,Po(t,3))},pr.flatMap=function(e,t){return zr(Ya(e,t),1)},pr.flatMapDeep=function(e,t){return zr(Ya(e,t),O)},pr.flatMapDepth=function(e,t,n){return n=n===o?1:Ws(n),zr(Ya(e,t),n)},pr.flatten=ya,pr.flattenDeep=function(e){return(null==e?0:e.length)?zr(e,O):[]},pr.flattenDepth=function(e,t){return(null==e?0:e.length)?zr(e,t=t===o?1:Ws(t)):[]},pr.flip=function(e){return Eo(e,x)},pr.flow=ku,pr.flowRight=Au,pr.fromPairs=function(e){for(var t=-1,n=null==e?0:e.length,r={};++t<n;){var i=e[t];r[i[0]]=i[1]}return r},pr.functions=function(e){return null==e?[]:$r(e,iu(e))},pr.functionsIn=function(e){return null==e?[]:$r(e,ou(e))},pr.groupBy=Ga,pr.initial=function(e){return(null==e?0:e.length)?Ni(e,0,-1):[]},pr.intersection=wa,pr.intersectionBy=_a,pr.intersectionWith=Ca,pr.invert=tu,pr.invertBy=nu,pr.invokeMap=Qa,pr.iteratee=Lu,pr.keyBy=$a,pr.keys=iu,pr.keysIn=ou,pr.map=Ya,pr.mapKeys=function(e,t){var n={};return t=Po(t,3),Gr(e,(function(e,r,i){Dr(n,t(e,r,i),e)})),n},pr.mapValues=function(e,t){var n={};return t=Po(t,3),Gr(e,(function(e,r,i){Dr(n,r,t(e,r,i))})),n},pr.matches=function(e){return pi(Rr(e,d))},pr.matchesProperty=function(e,t){return fi(e,Rr(t,d))},pr.memoize=ss,pr.merge=au,pr.mergeWith=su,pr.method=Du,pr.methodOf=Ou,pr.mixin=Mu,pr.negate=us,pr.nthArg=function(e){return e=Ws(e),Ti((function(t){return gi(t,e)}))},pr.omit=uu,pr.omitBy=function(e,t){return lu(e,us(Po(t)))},pr.once=function(e){return ts(2,e)},pr.orderBy=function(e,t,n,r){return null==e?[]:(vs(t)||(t=null==t?[]:[t]),vs(n=r?o:n)||(n=null==n?[]:[n]),vi(e,t,n))},pr.over=Pu,pr.overArgs=cs,pr.overEvery=Fu,pr.overSome=ju,pr.partial=ls,pr.partialRight=hs,pr.partition=Xa,pr.pick=cu,pr.pickBy=lu,pr.property=Bu,pr.propertyOf=function(e){return function(t){return null==e?o:Yr(e,t)}},pr.pull=Sa,pr.pullAll=Ea,pr.pullAllBy=function(e,t,n){return e&&e.length&&t&&t.length?bi(e,t,Po(n,2)):e},pr.pullAllWith=function(e,t,n){return e&&e.length&&t&&t.length?bi(e,t,o,n):e},pr.pullAt=xa,pr.range=Vu,pr.rangeRight=Wu,pr.rearg=ds,pr.reject=function(e,t){return(vs(e)?Yt:Hr)(e,us(Po(t,3)))},pr.remove=function(e,t){var n=[];if(!e||!e.length)return n;var r=-1,i=[],o=e.length;for(t=Po(t,3);++r<o;){var a=e[r];t(a,r,e)&&(n.push(a),i.push(r))}return wi(e,i),n},pr.rest=function(e,t){if("function"!=typeof e)throw new it(u);return Ti(e,t=t===o?t:Ws(t))},pr.reverse=Ia,pr.sampleSize=function(e,t,n){return t=(n?Go(e,t,n):t===o)?1:Ws(t),(vs(e)?Er:Ei)(e,t)},pr.set=function(e,t,n){return null==e?e:xi(e,t,n)},pr.setWith=function(e,t,n,r){return r="function"==typeof r?r:o,null==e?e:xi(e,t,n,r)},pr.shuffle=function(e){return(vs(e)?xr:Ai)(e)},pr.slice=function(e,t,n){var r=null==e?0:e.length;return r?(n&&"number"!=typeof n&&Go(e,t,n)?(t=0,n=r):(t=null==t?0:Ws(t),n=n===o?r:Ws(n)),Ni(e,t,n)):[]},pr.sortBy=Ja,pr.sortedUniq=function(e){return e&&e.length?Mi(e):[]},pr.sortedUniqBy=function(e,t){return e&&e.length?Mi(e,Po(t,2)):[]},pr.split=function(e,t,n){return n&&"number"!=typeof n&&Go(e,t,n)&&(t=n=o),(n=n===o?F:n>>>0)?(e=qs(e))&&("string"==typeof t||null!=t&&!Ds(t))&&!(t=Pi(t))&&En(e)?Qi(Dn(e),0,n):e.split(t,n):[]},pr.spread=function(e,t){if("function"!=typeof e)throw new it(u);return t=null==t?0:qn(Ws(t),0),Ti((function(n){var r=n[t],i=Qi(n,0,t);return r&&en(i,r),qt(e,this,i)}))},pr.tail=function(e){var t=null==e?0:e.length;return t?Ni(e,1,t):[]},pr.take=function(e,t,n){return e&&e.length?Ni(e,0,(t=n||t===o?1:Ws(t))<0?0:t):[]},pr.takeRight=function(e,t,n){var r=null==e?0:e.length;return r?Ni(e,(t=r-(t=n||t===o?1:Ws(t)))<0?0:t,r):[]},pr.takeRightWhile=function(e,t){return e&&e.length?Vi(e,Po(t,3),!1,!0):[]},pr.takeWhile=function(e,t){return e&&e.length?Vi(e,Po(t,3)):[]},pr.tap=function(e,t){return t(e),e},pr.throttle=function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new it(u);return Is(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),is(e,t,{leading:r,maxWait:t,trailing:i})},pr.thru=Va,pr.toArray=Bs,pr.toPairs=hu,pr.toPairsIn=du,pr.toPath=function(e){return vs(e)?Zt(e,la):Rs(e)?[e]:no(ca(qs(e)))},pr.toPlainObject=zs,pr.transform=function(e,t,n){var r=vs(e),i=r||_s(e)||Ps(e);if(t=Po(t,4),null==n){var o=e&&e.constructor;n=i?r?new o:[]:Is(e)&&Ss(o)?fr(Lt(e)):{}}return(i?Gt:Gr)(e,(function(e,r,i){return t(n,e,r,i)})),n},pr.unary=function(e){return es(e,1)},pr.union=ka,pr.unionBy=Aa,pr.unionWith=Na,pr.uniq=function(e){return e&&e.length?Fi(e):[]},pr.uniqBy=function(e,t){return e&&e.length?Fi(e,Po(t,2)):[]},pr.uniqWith=function(e,t){return t="function"==typeof t?t:o,e&&e.length?Fi(e,o,t):[]},pr.unset=function(e,t){return null==e||ji(e,t)},pr.unzip=La,pr.unzipWith=Da,pr.update=function(e,t,n){return null==e?e:Bi(e,t,qi(n))},pr.updateWith=function(e,t,n,r){return r="function"==typeof r?r:o,null==e?e:Bi(e,t,qi(n),r)},pr.values=pu,pr.valuesIn=function(e){return null==e?[]:yn(e,ou(e))},pr.without=Oa,pr.words=Su,pr.wrap=function(e,t){return ls(qi(t),e)},pr.xor=Ma,pr.xorBy=Ra,pr.xorWith=Pa,pr.zip=Fa,pr.zipObject=function(e,t){return Hi(e||[],t||[],kr)},pr.zipObjectDeep=function(e,t){return Hi(e||[],t||[],xi)},pr.zipWith=ja,pr.entries=hu,pr.entriesIn=du,pr.extend=Gs,pr.extendWith=Qs,Mu(pr,pr),pr.add=zu,pr.attempt=Eu,pr.camelCase=fu,pr.capitalize=mu,pr.ceil=qu,pr.clamp=function(e,t,n){return n===o&&(n=t,t=o),n!==o&&(n=(n=Hs(n))==n?n:0),t!==o&&(t=(t=Hs(t))==t?t:0),Mr(Hs(e),t,n)},pr.clone=function(e){return Rr(e,f)},pr.cloneDeep=function(e){return Rr(e,d|f)},pr.cloneDeepWith=function(e,t){return Rr(e,d|f,t="function"==typeof t?t:o)},pr.cloneWith=function(e,t){return Rr(e,f,t="function"==typeof t?t:o)},pr.conformsTo=function(e,t){return null==t||Pr(e,t,iu(t))},pr.deburr=gu,pr.defaultTo=function(e,t){return null==e||e!=e?t:e},pr.divide=Ku,pr.endsWith=function(e,t,n){e=qs(e),t=Pi(t);var r=e.length,i=n=n===o?r:Mr(Ws(n),0,r);return(n-=t.length)>=0&&e.slice(n,i)==t},pr.eq=ps,pr.escape=function(e){return(e=qs(e))&&Ee.test(e)?e.replace(Te,Tn):e},pr.escapeRegExp=function(e){return(e=qs(e))&&Oe.test(e)?e.replace(De,"\\$&"):e},pr.every=function(e,t,n){var r=vs(e)?$t:Wr;return n&&Go(e,t,n)&&(t=o),r(e,Po(t,3))},pr.find=Ha,pr.findIndex=ga,pr.findKey=function(e,t){return an(e,Po(t,3),Gr)},pr.findLast=za,pr.findLastIndex=va,pr.findLastKey=function(e,t){return an(e,Po(t,3),Qr)},pr.floor=Gu,pr.forEach=qa,pr.forEachRight=Ka,pr.forIn=function(e,t){return null==e?e:qr(e,Po(t,3),ou)},pr.forInRight=function(e,t){return null==e?e:Kr(e,Po(t,3),ou)},pr.forOwn=function(e,t){return e&&Gr(e,Po(t,3))},pr.forOwnRight=function(e,t){return e&&Qr(e,Po(t,3))},pr.get=Zs,pr.gt=fs,pr.gte=ms,pr.has=function(e,t){return null!=e&&Ho(e,t,ei)},pr.hasIn=eu,pr.head=ba,pr.identity=Nu,pr.includes=function(e,t,n,r){e=bs(e)?e:pu(e),n=n&&!r?Ws(n):0;var i=e.length;return n<0&&(n=qn(i+n,0)),Ms(e)?n<=i&&e.indexOf(t,n)>-1:!!i&&un(e,t,n)>-1},pr.indexOf=function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=null==n?0:Ws(n);return i<0&&(i=qn(r+i,0)),un(e,t,i)},pr.inRange=function(e,t,n){return t=Vs(t),n===o?(n=t,t=0):n=Vs(n),function(e,t,n){return e>=Kn(t,n)&&e<qn(t,n)}(e=Hs(e),t,n)},pr.invoke=ru,pr.isArguments=gs,pr.isArray=vs,pr.isArrayBuffer=ys,pr.isArrayLike=bs,pr.isArrayLikeObject=ws,pr.isBoolean=function(e){return!0===e||!1===e||ks(e)&&Jr(e)==z},pr.isBuffer=_s,pr.isDate=Cs,pr.isElement=function(e){return ks(e)&&1===e.nodeType&&!Ls(e)},pr.isEmpty=function(e){if(null==e)return!0;if(bs(e)&&(vs(e)||"string"==typeof e||"function"==typeof e.splice||_s(e)||Ps(e)||gs(e)))return!e.length;var t=Uo(e);if(t==Y||t==ne)return!e.size;if(Xo(e))return!ci(e).length;for(var n in e)if(lt.call(e,n))return!1;return!0},pr.isEqual=function(e,t){return oi(e,t)},pr.isEqualWith=function(e,t,n){var r=(n="function"==typeof n?n:o)?n(e,t):o;return r===o?oi(e,t,o,n):!!r},pr.isError=Ts,pr.isFinite=function(e){return"number"==typeof e&&Un(e)},pr.isFunction=Ss,pr.isInteger=Es,pr.isLength=xs,pr.isMap=As,pr.isMatch=function(e,t){return e===t||ai(e,t,jo(t))},pr.isMatchWith=function(e,t,n){return n="function"==typeof n?n:o,ai(e,t,jo(t),n)},pr.isNaN=function(e){return Ns(e)&&e!=+e},pr.isNative=function(e){if(Yo(e))throw new Je(s);return si(e)},pr.isNil=function(e){return null==e},pr.isNull=function(e){return null===e},pr.isNumber=Ns,pr.isObject=Is,pr.isObjectLike=ks,pr.isPlainObject=Ls,pr.isRegExp=Ds,pr.isSafeInteger=function(e){return Es(e)&&e>=-M&&e<=M},pr.isSet=Os,pr.isString=Ms,pr.isSymbol=Rs,pr.isTypedArray=Ps,pr.isUndefined=function(e){return e===o},pr.isWeakMap=function(e){return ks(e)&&Uo(e)==ae},pr.isWeakSet=function(e){return ks(e)&&Jr(e)==se},pr.join=function(e,t){return null==e?"":Hn.call(e,t)},pr.kebabCase=vu,pr.last=Ta,pr.lastIndexOf=function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=r;return n!==o&&(i=(i=Ws(n))<0?qn(r+i,0):Kn(i,r-1)),t==t?function(e,t,n){for(var r=n+1;r--;)if(e[r]===t)return r;return r}(e,t,i):sn(e,ln,i,!0)},pr.lowerCase=yu,pr.lowerFirst=bu,pr.lt=Fs,pr.lte=js,pr.max=function(e){return e&&e.length?Ur(e,Nu,Zr):o},pr.maxBy=function(e,t){return e&&e.length?Ur(e,Po(t,2),Zr):o},pr.mean=function(e){return hn(e,Nu)},pr.meanBy=function(e,t){return hn(e,Po(t,2))},pr.min=function(e){return e&&e.length?Ur(e,Nu,hi):o},pr.minBy=function(e,t){return e&&e.length?Ur(e,Po(t,2),hi):o},pr.stubArray=Uu,pr.stubFalse=Hu,pr.stubObject=function(){return{}},pr.stubString=function(){return""},pr.stubTrue=function(){return!0},pr.multiply=$u,pr.nth=function(e,t){return e&&e.length?gi(e,Ws(t)):o},pr.noConflict=function(){return Ot._===this&&(Ot._=mt),this},pr.noop=Ru,pr.now=Za,pr.pad=function(e,t,n){e=qs(e);var r=(t=Ws(t))?Ln(e):0;if(!t||r>=t)return e;var i=(t-r)/2;return yo(Bn(i),n)+e+yo(jn(i),n)},pr.padEnd=function(e,t,n){e=qs(e);var r=(t=Ws(t))?Ln(e):0;return t&&r<t?e+yo(t-r,n):e},pr.padStart=function(e,t,n){e=qs(e);var r=(t=Ws(t))?Ln(e):0;return t&&r<t?yo(t-r,n)+e:e},pr.parseInt=function(e,t,n){return n||null==t?t=0:t&&(t=+t),Qn(qs(e).replace(Re,""),t||0)},pr.random=function(e,t,n){if(n&&"boolean"!=typeof n&&Go(e,t,n)&&(t=n=o),n===o&&("boolean"==typeof t?(n=t,t=o):"boolean"==typeof e&&(n=e,e=o)),e===o&&t===o?(e=0,t=1):(e=Vs(e),t===o?(t=e,e=0):t=Vs(t)),e>t){var r=e;e=t,t=r}if(n||e%1||t%1){var i=$n();return Kn(e+i*(t-e+At("1e-"+((i+"").length-1))),t)}return _i(e,t)},pr.reduce=function(e,t,n){var r=vs(e)?tn:fn,i=arguments.length<3;return r(e,Po(t,4),n,i,Br)},pr.reduceRight=function(e,t,n){var r=vs(e)?nn:fn,i=arguments.length<3;return r(e,Po(t,4),n,i,Vr)},pr.repeat=function(e,t,n){return t=(n?Go(e,t,n):t===o)?1:Ws(t),Ci(qs(e),t)},pr.replace=function(){var e=arguments,t=qs(e[0]);return e.length<3?t:t.replace(e[1],e[2])},pr.result=function(e,t,n){var r=-1,i=(t=Ki(t,e)).length;for(i||(i=1,e=o);++r<i;){var a=null==e?o:e[la(t[r])];a===o&&(r=i,a=n),e=Ss(a)?a.call(e):a}return e},pr.round=Yu,pr.runInContext=e,pr.sample=function(e){return(vs(e)?Sr:Si)(e)},pr.size=function(e){if(null==e)return 0;if(bs(e))return Ms(e)?Ln(e):e.length;var t=Uo(e);return t==Y||t==ne?e.size:ci(e).length},pr.snakeCase=wu,pr.some=function(e,t,n){var r=vs(e)?rn:Li;return n&&Go(e,t,n)&&(t=o),r(e,Po(t,3))},pr.sortedIndex=function(e,t){return Di(e,t)},pr.sortedIndexBy=function(e,t,n){return Oi(e,t,Po(n,2))},pr.sortedIndexOf=function(e,t){var n=null==e?0:e.length;if(n){var r=Di(e,t);if(r<n&&ps(e[r],t))return r}return-1},pr.sortedLastIndex=function(e,t){return Di(e,t,!0)},pr.sortedLastIndexBy=function(e,t,n){return Oi(e,t,Po(n,2),!0)},pr.sortedLastIndexOf=function(e,t){if(null==e?0:e.length){var n=Di(e,t,!0)-1;if(ps(e[n],t))return n}return-1},pr.startCase=_u,pr.startsWith=function(e,t,n){return e=qs(e),n=null==n?0:Mr(Ws(n),0,e.length),t=Pi(t),e.slice(n,n+t.length)==t},pr.subtract=Xu,pr.sum=function(e){return e&&e.length?mn(e,Nu):0},pr.sumBy=function(e,t){return e&&e.length?mn(e,Po(t,2)):0},pr.template=function(e,t,n){var r=pr.templateSettings;n&&Go(e,t,n)&&(t=o),e=qs(e),t=Qs({},t,r,xo);var i,a,s=Qs({},t.imports,r.imports,xo),u=iu(s),c=yn(s,u),l=0,h=t.interpolate||Ye,d="__p += '",p=nt((t.escape||Ye).source+"|"+h.source+"|"+(h===ke?Ue:Ye).source+"|"+(t.evaluate||Ye).source+"|$","g"),f="//# sourceURL="+(lt.call(t,"sourceURL")?(t.sourceURL+"").replace(/[\r\n]/g," "):"lodash.templateSources["+ ++Et+"]")+"\n";e.replace(p,(function(t,n,r,o,s,u){return r||(r=o),d+=e.slice(l,u).replace(Xe,Sn),n&&(i=!0,d+="' +\n__e("+n+") +\n'"),s&&(a=!0,d+="';\n"+s+";\n__p += '"),r&&(d+="' +\n((__t = ("+r+")) == null ? '' : __t) +\n'"),l=u+t.length,t})),d+="';\n";var m=lt.call(t,"variable")&&t.variable;m||(d="with (obj) {\n"+d+"\n}\n"),d=(a?d.replace(be,""):d).replace(we,"$1").replace(_e,"$1;"),d="function("+(m||"obj")+") {\n"+(m?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(i?", __e = _.escape":"")+(a?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+d+"return __p\n}";var g=Eu((function(){return Ze(u,f+"return "+d).apply(o,c)}));if(g.source=d,Ts(g))throw g;return g},pr.times=function(e,t){if((e=Ws(e))<1||e>M)return[];var n=F,r=Kn(e,F);t=Po(t),e-=F;for(var i=gn(r,t);++n<e;)t(n);return i},pr.toFinite=Vs,pr.toInteger=Ws,pr.toLength=Us,pr.toLower=function(e){return qs(e).toLowerCase()},pr.toNumber=Hs,pr.toSafeInteger=function(e){return e?Mr(Ws(e),-M,M):0===e?e:0},pr.toString=qs,pr.toUpper=function(e){return qs(e).toUpperCase()},pr.trim=function(e,t,n){if((e=qs(e))&&(n||t===o))return e.replace(Me,"");if(!e||!(t=Pi(t)))return e;var r=Dn(e),i=Dn(t);return Qi(r,wn(r,i),_n(r,i)+1).join("")},pr.trimEnd=function(e,t,n){if((e=qs(e))&&(n||t===o))return e.replace(Pe,"");if(!e||!(t=Pi(t)))return e;var r=Dn(e);return Qi(r,0,_n(r,Dn(t))+1).join("")},pr.trimStart=function(e,t,n){if((e=qs(e))&&(n||t===o))return e.replace(Re,"");if(!e||!(t=Pi(t)))return e;var r=Dn(e);return Qi(r,wn(r,Dn(t))).join("")},pr.truncate=function(e,t){var n=I,r=k;if(Is(t)){var i="separator"in t?t.separator:i;n="length"in t?Ws(t.length):n,r="omission"in t?Pi(t.omission):r}var a=(e=qs(e)).length;if(En(e)){var s=Dn(e);a=s.length}if(n>=a)return e;var u=n-Ln(r);if(u<1)return r;var c=s?Qi(s,0,u).join(""):e.slice(0,u);if(i===o)return c+r;if(s&&(u+=c.length-u),Ds(i)){if(e.slice(u).search(i)){var l,h=c;for(i.global||(i=nt(i.source,qs(He.exec(i))+"g")),i.lastIndex=0;l=i.exec(h);)var d=l.index;c=c.slice(0,d===o?u:d)}}else if(e.indexOf(Pi(i),u)!=u){var p=c.lastIndexOf(i);p>-1&&(c=c.slice(0,p))}return c+r},pr.unescape=function(e){return(e=qs(e))&&Se.test(e)?e.replace(Ce,On):e},pr.uniqueId=function(e){var t=++ht;return qs(e)+t},pr.upperCase=Cu,pr.upperFirst=Tu,pr.each=qa,pr.eachRight=Ka,pr.first=ba,Mu(pr,(Qu={},Gr(pr,(function(e,t){lt.call(pr.prototype,t)||(Qu[t]=e)})),Qu),{chain:!1}),pr.VERSION="4.17.15",Gt(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(e){pr[e].placeholder=pr})),Gt(["drop","take"],(function(e,t){vr.prototype[e]=function(n){n=n===o?1:qn(Ws(n),0);var r=this.__filtered__&&!t?new vr(this):this.clone();return r.__filtered__?r.__takeCount__=Kn(n,r.__takeCount__):r.__views__.push({size:Kn(n,F),type:e+(r.__dir__<0?"Right":"")}),r},vr.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),Gt(["filter","map","takeWhile"],(function(e,t){var n=t+1,r=n==L||3==n;vr.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:Po(e,3),type:n}),t.__filtered__=t.__filtered__||r,t}})),Gt(["head","last"],(function(e,t){var n="take"+(t?"Right":"");vr.prototype[e]=function(){return this[n](1).value()[0]}})),Gt(["initial","tail"],(function(e,t){var n="drop"+(t?"":"Right");vr.prototype[e]=function(){return this.__filtered__?new vr(this):this[n](1)}})),vr.prototype.compact=function(){return this.filter(Nu)},vr.prototype.find=function(e){return this.filter(e).head()},vr.prototype.findLast=function(e){return this.reverse().find(e)},vr.prototype.invokeMap=Ti((function(e,t){return"function"==typeof e?new vr(this):this.map((function(n){return ri(n,e,t)}))})),vr.prototype.reject=function(e){return this.filter(us(Po(e)))},vr.prototype.slice=function(e,t){e=Ws(e);var n=this;return n.__filtered__&&(e>0||t<0)?new vr(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==o&&(n=(t=Ws(t))<0?n.dropRight(-t):n.take(t-e)),n)},vr.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},vr.prototype.toArray=function(){return this.take(F)},Gr(vr.prototype,(function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),r=/^(?:head|last)$/.test(t),i=pr[r?"take"+("last"==t?"Right":""):t],a=r||/^find/.test(t);i&&(pr.prototype[t]=function(){var t=this.__wrapped__,s=r?[1]:arguments,u=t instanceof vr,c=s[0],l=u||vs(t),h=function(e){var t=i.apply(pr,en([e],s));return r&&d?t[0]:t};l&&n&&"function"==typeof c&&1!=c.length&&(u=l=!1);var d=this.__chain__,p=!!this.__actions__.length,f=a&&!d,m=u&&!p;if(!a&&l){t=m?t:new vr(this);var g=e.apply(t,s);return g.__actions__.push({func:Va,args:[h],thisArg:o}),new gr(g,d)}return f&&m?e.apply(this,s):(g=this.thru(h),f?r?g.value()[0]:g.value():g)})})),Gt(["pop","push","shift","sort","splice","unshift"],(function(e){var t=ot[e],n=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",r=/^(?:pop|shift)$/.test(e);pr.prototype[e]=function(){var e=arguments;if(r&&!this.__chain__){var i=this.value();return t.apply(vs(i)?i:[],e)}return this[n]((function(n){return t.apply(vs(n)?n:[],e)}))}})),Gr(vr.prototype,(function(e,t){var n=pr[t];if(n){var r=n.name+"";lt.call(ir,r)||(ir[r]=[]),ir[r].push({name:t,func:n})}})),ir[fo(o,y).name]=[{name:"wrapper",func:o}],vr.prototype.clone=function(){var e=new vr(this.__wrapped__);return e.__actions__=no(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=no(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=no(this.__views__),e},vr.prototype.reverse=function(){if(this.__filtered__){var e=new vr(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},vr.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,n=vs(e),r=t<0,i=n?e.length:0,o=function(e,t,n){var r=-1,i=n.length;for(;++r<i;){var o=n[r],a=o.size;switch(o.type){case"drop":e+=a;break;case"dropRight":t-=a;break;case"take":t=Kn(t,e+a);break;case"takeRight":e=qn(e,t-a)}}return{start:e,end:t}}(0,i,this.__views__),a=o.start,s=o.end,u=s-a,c=r?s:a-1,l=this.__iteratees__,h=l.length,d=0,p=Kn(u,this.__takeCount__);if(!n||!r&&i==u&&p==u)return Wi(e,this.__actions__);var f=[];e:for(;u--&&d<p;){for(var m=-1,g=e[c+=t];++m<h;){var v=l[m],y=v.iteratee,b=v.type,w=y(g);if(b==D)g=w;else if(!w){if(b==L)continue e;break e}}f[d++]=g}return f},pr.prototype.at=Wa,pr.prototype.chain=function(){return Ba(this)},pr.prototype.commit=function(){return new gr(this.value(),this.__chain__)},pr.prototype.next=function(){this.__values__===o&&(this.__values__=Bs(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?o:this.__values__[this.__index__++]}},pr.prototype.plant=function(e){for(var t,n=this;n instanceof mr;){var r=da(n);r.__index__=0,r.__values__=o,t?i.__wrapped__=r:t=r;var i=r;n=n.__wrapped__}return i.__wrapped__=e,t},pr.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof vr){var t=e;return this.__actions__.length&&(t=new vr(this)),(t=t.reverse()).__actions__.push({func:Va,args:[Ia],thisArg:o}),new gr(t,this.__chain__)}return this.thru(Ia)},pr.prototype.toJSON=pr.prototype.valueOf=pr.prototype.value=function(){return Wi(this.__wrapped__,this.__actions__)},pr.prototype.first=pr.prototype.head,jt&&(pr.prototype[jt]=function(){return this}),pr}();Ot._=Mn,(i=function(){return Mn}.call(t,n,t,r))===o||(r.exports=i)}.call(this)}).call(this,n("yLpj"),n("YuTi")(e))},MZZl:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"g",(function(){return i})),n.d(t,"h",(function(){return o})),n.d(t,"e",(function(){return a})),n.d(t,"c",(function(){return s})),n.d(t,"d",(function(){return u})),n.d(t,"f",(function(){return c})),n.d(t,"b",(function(){return l}));n("U6Bt"),n("rzGZ"),n("Dq+y"),n("8npG"),n("Ggvi"),n("AqHK");var r={BODY:"bodyAttributes",HTML:"htmlAttributes",TITLE:"titleAttributes"},i={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title"},o=(Object.keys(i).map((function(e){return i[e]})),{CHARSET:"charset",CSS_TEXT:"cssText",HREF:"href",HTTPEQUIV:"http-equiv",INNER_HTML:"innerHTML",ITEM_PROP:"itemprop",NAME:"name",PROPERTY:"property",REL:"rel",SRC:"src"}),a={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"},s={DEFAULT_TITLE:"defaultTitle",DEFER:"defer",ENCODE_SPECIAL_CHARACTERS:"encodeSpecialCharacters",ON_CHANGE_CLIENT_STATE:"onChangeClientState",TITLE_TEMPLATE:"titleTemplate"},u=Object.keys(a).reduce((function(e,t){return e[a[t]]=t,e}),{}),c=[i.NOSCRIPT,i.SCRIPT,i.STYLE],l="data-react-helmet"},"Ml7+":function(e,t,n){"use strict";n("t+fG")("sub",(function(e){return function(){return e(this,"sub","","")}}))},NSPt:function(e,t,n){"use strict";(function(r){n("DrhF"),n("U6Bt"),n("Ll4R"),n("ToIb"),n("6kNP"),n("zTTH"),n("OeI1"),n("cFtU"),n("v9g0"),n("YbXK"),n("xJgp"),n("rzGZ"),n("Dq+y"),n("Ggvi"),n("JHok"),n("+ar0"),n("AqHK"),n("pJf4"),n("nMRu"),n("sC2a"),n("HQhv"),n("sPse"),n("klQ5"),n("zGcK"),n("YBKJ"),n("sc67"),n("n7j8"),n("MIFh"),n("q8oJ"),n("C9fy"),n("8npG"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var i,o,a=(i=n("wj3C"))&&"object"==typeof i&&"default"in i?i.default:i,s=n("mrSG"),u=n("zVF4"),c=n("q/0M"),l=n("S+S0"),h=function(){function e(e){this.domStorage_=e,this.prefix_="firebase:"}return e.prototype.set=function(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),u.stringify(t))},e.prototype.get=function(e){var t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:u.jsonEval(t)},e.prototype.remove=function(e){this.domStorage_.removeItem(this.prefixedName_(e))},e.prototype.prefixedName_=function(e){return this.prefix_+e},e.prototype.toString=function(){return this.domStorage_.toString()},e}(),d=function(){function e(){this.cache_={},this.isInMemoryStorage=!0}return e.prototype.set=function(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t},e.prototype.get=function(e){return u.contains(this.cache_,e)?this.cache_[e]:null},e.prototype.remove=function(e){delete this.cache_[e]},e}(),p=function(e){try{if("undefined"!=typeof window&&void 0!==window[e]){var t=window[e];return t.setItem("firebase:sentinel","cache"),t.removeItem("firebase:sentinel"),new h(t)}}catch(n){}return new d},f=p("localStorage"),m=p("sessionStorage"),g=new c.Logger("@firebase/database"),v=(o=1,function(){return o++}),y=function(e){var t=u.stringToByteArray(e),n=new u.Sha1;n.update(t);var r=n.digest();return u.base64.encodeByteArray(r)},b=function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];for(var r="",i=0;i<t.length;i++)Array.isArray(t[i])||t[i]&&"object"==typeof t[i]&&"number"==typeof t[i].length?r+=e.apply(null,t[i]):"object"==typeof t[i]?r+=u.stringify(t[i]):r+=t[i],r+=" ";return r},w=null,_=!0,C=function(e,t){u.assert(!t||!0===e||!1===e,"Can't turn on custom loggers persistently."),!0===e?(g.logLevel=c.LogLevel.VERBOSE,w=g.log.bind(g),t&&m.set("logging_enabled",!0)):"function"==typeof e?w=e:(w=null,m.remove("logging_enabled"))},T=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!0===_&&(_=!1,null===w&&!0===m.get("logging_enabled")&&C(!0)),w){var n=b.apply(null,e);w(n)}},S=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];T.apply(void 0,s.__spread([e],t))}},E=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE INTERNAL ERROR: "+b.apply(void 0,s.__spread(e));g.error(n)},x=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE FATAL ERROR: "+b.apply(void 0,s.__spread(e));throw g.error(n),new Error(n)},I=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="FIREBASE WARNING: "+b.apply(void 0,s.__spread(e));g.warn(n)},k=function(e){return"number"==typeof e&&(e!=e||e==Number.POSITIVE_INFINITY||e==Number.NEGATIVE_INFINITY)},A="[MIN_NAME]",N="[MAX_NAME]",L=function(e,t){if(e===t)return 0;if(e===A||t===N)return-1;if(t===A||e===N)return 1;var n=B(e),r=B(t);return null!==n?null!==r?n-r==0?e.length-t.length:n-r:-1:null!==r?1:e<t?-1:1},D=function(e,t){return e===t?0:e<t?-1:1},O=function(e,t){if(t&&e in t)return t[e];throw new Error("Missing required key ("+e+") in object: "+u.stringify(t))},M=function e(t){if("object"!=typeof t||null===t)return u.stringify(t);var n=[];for(var r in t)n.push(r);n.sort();for(var i="{",o=0;o<n.length;o++)0!==o&&(i+=","),i+=u.stringify(n[o]),i+=":",i+=e(t[n[o]]);return i+="}"},R=function(e,t){var n=e.length;if(n<=t)return[e];for(var r=[],i=0;i<n;i+=t)i+t>n?r.push(e.substring(i,n)):r.push(e.substring(i,i+t));return r};function P(e,t){for(var n in e)e.hasOwnProperty(n)&&t(n,e[n])}var F=function(e){u.assert(!k(e),"Invalid JSON number");var t,n,r,i,o,a,s;for(0===e?(n=0,r=0,t=1/e==-1/0?1:0):(t=e<0,(e=Math.abs(e))>=Math.pow(2,-1022)?(n=(i=Math.min(Math.floor(Math.log(e)/Math.LN2),1023))+1023,r=Math.round(e*Math.pow(2,52-i)-Math.pow(2,52))):(n=0,r=Math.round(e/Math.pow(2,-1074)))),a=[],o=52;o;o-=1)a.push(r%2?1:0),r=Math.floor(r/2);for(o=11;o;o-=1)a.push(n%2?1:0),n=Math.floor(n/2);a.push(t?1:0),a.reverse(),s=a.join("");var c="";for(o=0;o<64;o+=8){var l=parseInt(s.substr(o,8),2).toString(16);1===l.length&&(l="0"+l),c+=l}return c.toLowerCase()},j=new RegExp("^-?(0*)\\d{1,10}$"),B=function(e){if(j.test(e)){var t=Number(e);if(t>=-2147483648&&t<=2147483647)return t}return null},V=function(e){try{e()}catch(t){setTimeout((function(){var e=t.stack||"";throw I("Exception was thrown by user callback.",e),t}),Math.floor(0))}},W=function(){return("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},U=function(e,t){var n=setTimeout(e,t);return"object"==typeof n&&n.unref&&n.unref(),n},H=function(){function e(e,t){if(void 0===t){this.pieces_=e.split("/");for(var n=0,r=0;r<this.pieces_.length;r++)this.pieces_[r].length>0&&(this.pieces_[n]=this.pieces_[r],n++);this.pieces_.length=n,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}return Object.defineProperty(e,"Empty",{get:function(){return new e("")},enumerable:!0,configurable:!0}),e.prototype.getFront=function(){return this.pieceNum_>=this.pieces_.length?null:this.pieces_[this.pieceNum_]},e.prototype.getLength=function(){return this.pieces_.length-this.pieceNum_},e.prototype.popFront=function(){var t=this.pieceNum_;return t<this.pieces_.length&&t++,new e(this.pieces_,t)},e.prototype.getBack=function(){return this.pieceNum_<this.pieces_.length?this.pieces_[this.pieces_.length-1]:null},e.prototype.toString=function(){for(var e="",t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"},e.prototype.toUrlEncodedString=function(){for(var e="",t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+encodeURIComponent(String(this.pieces_[t])));return e||"/"},e.prototype.slice=function(e){return void 0===e&&(e=0),this.pieces_.slice(this.pieceNum_+e)},e.prototype.parent=function(){if(this.pieceNum_>=this.pieces_.length)return null;for(var t=[],n=this.pieceNum_;n<this.pieces_.length-1;n++)t.push(this.pieces_[n]);return new e(t,0)},e.prototype.child=function(t){for(var n=[],r=this.pieceNum_;r<this.pieces_.length;r++)n.push(this.pieces_[r]);if(t instanceof e)for(r=t.pieceNum_;r<t.pieces_.length;r++)n.push(t.pieces_[r]);else{var i=t.split("/");for(r=0;r<i.length;r++)i[r].length>0&&n.push(i[r])}return new e(n,0)},e.prototype.isEmpty=function(){return this.pieceNum_>=this.pieces_.length},e.relativePath=function(t,n){var r=t.getFront(),i=n.getFront();if(null===r)return n;if(r===i)return e.relativePath(t.popFront(),n.popFront());throw new Error("INTERNAL ERROR: innerPath ("+n+") is not within outerPath ("+t+")")},e.comparePaths=function(e,t){for(var n=e.slice(),r=t.slice(),i=0;i<n.length&&i<r.length;i++){var o=L(n[i],r[i]);if(0!==o)return o}return n.length===r.length?0:n.length<r.length?-1:1},e.prototype.equals=function(e){if(this.getLength()!==e.getLength())return!1;for(var t=this.pieceNum_,n=e.pieceNum_;t<=this.pieces_.length;t++,n++)if(this.pieces_[t]!==e.pieces_[n])return!1;return!0},e.prototype.contains=function(e){var t=this.pieceNum_,n=e.pieceNum_;if(this.getLength()>e.getLength())return!1;for(;t<this.pieces_.length;){if(this.pieces_[t]!==e.pieces_[n])return!1;++t,++n}return!0},e}(),z=function(){function e(e,t){this.errorPrefix_=t,this.parts_=e.slice(),this.byteLength_=Math.max(1,this.parts_.length);for(var n=0;n<this.parts_.length;n++)this.byteLength_+=u.stringLength(this.parts_[n]);this.checkValid_()}return Object.defineProperty(e,"MAX_PATH_DEPTH",{get:function(){return 32},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MAX_PATH_LENGTH_BYTES",{get:function(){return 768},enumerable:!0,configurable:!0}),e.prototype.push=function(e){this.parts_.length>0&&(this.byteLength_+=1),this.parts_.push(e),this.byteLength_+=u.stringLength(e),this.checkValid_()},e.prototype.pop=function(){var e=this.parts_.pop();this.byteLength_-=u.stringLength(e),this.parts_.length>0&&(this.byteLength_-=1)},e.prototype.checkValid_=function(){if(this.byteLength_>e.MAX_PATH_LENGTH_BYTES)throw new Error(this.errorPrefix_+"has a key path longer than "+e.MAX_PATH_LENGTH_BYTES+" bytes ("+this.byteLength_+").");if(this.parts_.length>e.MAX_PATH_DEPTH)throw new Error(this.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+e.MAX_PATH_DEPTH+") or object contains a cycle "+this.toErrorString())},e.prototype.toErrorString=function(){return 0==this.parts_.length?"":"in property '"+this.parts_.join(".")+"'"},e}(),q="long_polling",K=function(){function e(e,t,n,r,i,o){void 0===i&&(i=""),void 0===o&&(o=!1),this.secure=t,this.namespace=n,this.webSocketOnly=r,this.persistenceKey=i,this.includeNamespaceInQueryParams=o,this.host=e.toLowerCase(),this.domain=this.host.substr(this.host.indexOf(".")+1),this.internalHost=f.get("host:"+e)||this.host}return e.prototype.needsQueryParam=function(){return this.host!==this.internalHost||this.isCustomHost()||this.includeNamespaceInQueryParams},e.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},e.prototype.isDemoHost=function(){return"firebaseio-demo.com"===this.domain},e.prototype.isCustomHost=function(){return"firebaseio.com"!==this.domain&&"firebaseio-demo.com"!==this.domain},e.prototype.updateHost=function(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&f.set("host:"+this.host,this.internalHost))},e.prototype.connectionURL=function(e,t){var n;if(u.assert("string"==typeof e,"typeof type must == string"),u.assert("object"==typeof t,"typeof params must == object"),"websocket"===e)n=(this.secure?"wss://":"ws://")+this.internalHost+"/.ws?";else{if(e!==q)throw new Error("Unknown connection type: "+e);n=(this.secure?"https://":"http://")+this.internalHost+"/.lp?"}this.needsQueryParam()&&(t.ns=this.namespace);var r=[];return P(t,(function(e,t){r.push(e+"="+t)})),n+r.join("&")},e.prototype.toString=function(){var e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e},e.prototype.toURLString=function(){return(this.secure?"https://":"http://")+this.host},e}();var G,Q,$,Y,X,J=function(e){var t=Z(e),n=t.namespace;"firebase"===t.domain&&x(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),n&&"undefined"!=n||"localhost"===t.domain||x("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&I("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");var r="ws"===t.scheme||"wss"===t.scheme;return{repoInfo:new K(t.host,t.secure,n,r,"",n!=t.subdomain),path:new H(t.pathString)}},Z=function(e){var t="",n="",r="",i="",o="",a=!0,u="https",c=443;if("string"==typeof e){var l=e.indexOf("//");l>=0&&(u=e.substring(0,l-1),e=e.substring(l+2));var h=e.indexOf("/");-1===h&&(h=e.length);var d=e.indexOf("?");-1===d&&(d=e.length),t=e.substring(0,Math.min(h,d)),h<d&&(i=function(e){for(var t="",n=e.split("/"),r=0;r<n.length;r++)if(n[r].length>0){var i=n[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch(o){}t+="/"+i}return t}(e.substring(h,d)));var p=function(e){var t,n,r={};"?"===e.charAt(0)&&(e=e.substring(1));try{for(var i=s.__values(e.split("&")),o=i.next();!o.done;o=i.next()){var a=o.value;if(0!==a.length){var u=a.split("=");2===u.length?r[decodeURIComponent(u[0])]=decodeURIComponent(u[1]):I("Invalid query segment '"+a+"' in query '"+e+"'")}}}catch(c){t={error:c}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r}(e.substring(Math.min(e.length,d)));(l=t.indexOf(":"))>=0?(a="https"===u||"wss"===u,c=parseInt(t.substring(l+1),10)):l=e.length;var f=t.split(".");3===f.length?(n=f[1],o=r=f[0].toLowerCase()):2===f.length?n=f[0]:"localhost"===f[0].slice(0,l).toLowerCase()&&(n="localhost"),"ns"in p&&(o=p.ns)}return{host:t,port:c,domain:n,subdomain:r,secure:a,scheme:u,pathString:i,namespace:o}},ee=/[\[\].#$\/\u0000-\u001F\u007F]/,te=/[\[\].#$\u0000-\u001F\u007F]/,ne=function(e){return"string"==typeof e&&0!==e.length&&!ee.test(e)},re=function(e){return"string"==typeof e&&0!==e.length&&!te.test(e)},ie=function(e){return null===e||"string"==typeof e||"number"==typeof e&&!k(e)||e&&"object"==typeof e&&u.contains(e,".sv")},oe=function(e,t,n,r,i){i&&void 0===n||ae(u.errorPrefix(e,t,i),n,r)},ae=function e(t,n,r){var i=r instanceof H?new z(r,t):r;if(void 0===n)throw new Error(t+"contains undefined "+i.toErrorString());if("function"==typeof n)throw new Error(t+"contains a function "+i.toErrorString()+" with contents = "+n.toString());if(k(n))throw new Error(t+"contains "+n.toString()+" "+i.toErrorString());if("string"==typeof n&&n.length>10485760/3&&u.stringLength(n)>10485760)throw new Error(t+"contains a string greater than 10485760 utf8 bytes "+i.toErrorString()+" ('"+n.substring(0,50)+"...')");if(n&&"object"==typeof n){var o=!1,a=!1;if(P(n,(function(n,r){if(".value"===n)o=!0;else if(".priority"!==n&&".sv"!==n&&(a=!0,!ne(n)))throw new Error(t+" contains an invalid key ("+n+") "+i.toErrorString()+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');i.push(n),e(t,r,i),i.pop()})),o&&a)throw new Error(t+' contains ".value" child '+i.toErrorString()+" in addition to actual children.")}},se=function(e,t,n,r,i){if(!i||void 0!==n){var o=u.errorPrefix(e,t,i);if(!n||"object"!=typeof n||Array.isArray(n))throw new Error(o+" must be an object containing the children to replace.");var a=[];P(n,(function(e,t){var n=new H(e);if(ae(o,t,r.child(n)),".priority"===n.getBack()&&!ie(t))throw new Error(o+"contains an invalid value for '"+n.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");a.push(n)})),function(e,t){var n,r;for(n=0;n<t.length;n++)for(var i=(r=t[n]).slice(),o=0;o<i.length;o++)if(".priority"===i[o]&&o===i.length-1);else if(!ne(i[o]))throw new Error(e+"contains an invalid key ("+i[o]+") in path "+r.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');t.sort(H.comparePaths);var a=null;for(n=0;n<t.length;n++){if(r=t[n],null!==a&&a.contains(r))throw new Error(e+"contains a path "+a.toString()+" that is ancestor of another path "+r.toString());a=r}}(o,a)}},ue=function(e,t,n,r){if(!r||void 0!==n){if(k(n))throw new Error(u.errorPrefix(e,t,r)+"is "+n.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!ie(n))throw new Error(u.errorPrefix(e,t,r)+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},ce=function(e,t,n,r){if(!r||void 0!==n)switch(n){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(u.errorPrefix(e,t,r)+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},le=function(e,t,n,r){if(!(r&&void 0===n||ne(n)))throw new Error(u.errorPrefix(e,t,r)+'was an invalid key = "'+n+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},he=function(e,t,n,r){if(!(r&&void 0===n||re(n)))throw new Error(u.errorPrefix(e,t,r)+'was an invalid path = "'+n+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},de=function(e,t,n,r){n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),he(e,t,n,r)},pe=function(e,t){if(".info"===t.getFront())throw new Error(e+" failed = Can't modify data under /.info/")},fe=function(e,t,n){var r=n.path.toString();if("string"!=typeof n.repoInfo.host||0===n.repoInfo.host.length||!ne(n.repoInfo.namespace)&&"localhost"!==n.repoInfo.host.split(":")[0]||0!==r.length&&!function(e){return e&&(e=e.replace(/^\/*\.info(\/|$)/,"/")),re(e)}(r))throw new Error(u.errorPrefix(e,t,!1)+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')},me=function(e,t,n,r){if((!r||void 0!==n)&&"boolean"!=typeof n)throw new Error(u.errorPrefix(e,t,r)+"must be a boolean.")},ge=function(){function e(e,t){this.repo_=e,this.path_=t}return e.prototype.cancel=function(e){u.validateArgCount("OnDisconnect.cancel",0,1,arguments.length),u.validateCallback("OnDisconnect.cancel",1,e,!0);var t=new u.Deferred;return this.repo_.onDisconnectCancel(this.path_,t.wrapCallback(e)),t.promise},e.prototype.remove=function(e){u.validateArgCount("OnDisconnect.remove",0,1,arguments.length),pe("OnDisconnect.remove",this.path_),u.validateCallback("OnDisconnect.remove",1,e,!0);var t=new u.Deferred;return this.repo_.onDisconnectSet(this.path_,null,t.wrapCallback(e)),t.promise},e.prototype.set=function(e,t){u.validateArgCount("OnDisconnect.set",1,2,arguments.length),pe("OnDisconnect.set",this.path_),oe("OnDisconnect.set",1,e,this.path_,!1),u.validateCallback("OnDisconnect.set",2,t,!0);var n=new u.Deferred;return this.repo_.onDisconnectSet(this.path_,e,n.wrapCallback(t)),n.promise},e.prototype.setWithPriority=function(e,t,n){u.validateArgCount("OnDisconnect.setWithPriority",2,3,arguments.length),pe("OnDisconnect.setWithPriority",this.path_),oe("OnDisconnect.setWithPriority",1,e,this.path_,!1),ue("OnDisconnect.setWithPriority",2,t,!1),u.validateCallback("OnDisconnect.setWithPriority",3,n,!0);var r=new u.Deferred;return this.repo_.onDisconnectSetWithPriority(this.path_,e,t,r.wrapCallback(n)),r.promise},e.prototype.update=function(e,t){if(u.validateArgCount("OnDisconnect.update",1,2,arguments.length),pe("OnDisconnect.update",this.path_),Array.isArray(e)){for(var n={},r=0;r<e.length;++r)n[""+r]=e[r];e=n,I("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}se("OnDisconnect.update",1,e,this.path_,!1),u.validateCallback("OnDisconnect.update",2,t,!0);var i=new u.Deferred;return this.repo_.onDisconnectUpdate(this.path_,e,i.wrapCallback(t)),i.promise},e}(),ve=function(){function e(e,t){this.committed=e,this.snapshot=t}return e.prototype.toJSON=function(){return u.validateArgCount("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},e}(),ye=(G="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Q=0,$=[],function(e){var t,n=e===Q;Q=e;var r=new Array(8);for(t=7;t>=0;t--)r[t]=G.charAt(e%64),e=Math.floor(e/64);u.assert(0===e,"Cannot push at time == 0");var i=r.join("");if(n){for(t=11;t>=0&&63===$[t];t--)$[t]=0;$[t]++}else for(t=0;t<12;t++)$[t]=Math.floor(64*Math.random());for(t=0;t<12;t++)i+=G.charAt($[t]);return u.assert(20===i.length,"nextPushId: Length should be 20."),i}),be=function(){function e(e,t){this.name=e,this.node=t}return e.Wrap=function(t,n){return new e(t,n)},e}(),we=function(){function e(){}return e.prototype.getCompare=function(){return this.compare.bind(this)},e.prototype.indexedValueChanged=function(e,t){var n=new be(A,e),r=new be(A,t);return 0!==this.compare(n,r)},e.prototype.minPost=function(){return be.MIN},e}(),_e=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s.__extends(t,e),Object.defineProperty(t,"__EMPTY_NODE",{get:function(){return Y},set:function(e){Y=e},enumerable:!0,configurable:!0}),t.prototype.compare=function(e,t){return L(e.name,t.name)},t.prototype.isDefinedOn=function(e){throw u.assertionError("KeyIndex.isDefinedOn not expected to be called.")},t.prototype.indexedValueChanged=function(e,t){return!1},t.prototype.minPost=function(){return be.MIN},t.prototype.maxPost=function(){return new be(N,Y)},t.prototype.makePost=function(e,t){return u.assert("string"==typeof e,"KeyIndex indexValue must always be a string."),new be(e,Y)},t.prototype.toString=function(){return".key"},t}(we),Ce=new _e;var Te,Se,Ee,xe=function(e){return"number"==typeof e?"number:"+F(e):"string:"+e},Ie=function(e){if(e.isLeafNode()){var t=e.val();u.assert("string"==typeof t||"number"==typeof t||"object"==typeof t&&u.contains(t,".sv"),"Priority must be a string or number.")}else u.assert(e===X||e.isEmpty(),"priority of unexpected type.");u.assert(e===X||e.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},ke=function(){function e(t,n){void 0===n&&(n=e.__childrenNodeConstructor.EMPTY_NODE),this.value_=t,this.priorityNode_=n,this.lazyHash_=null,u.assert(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),Ie(this.priorityNode_)}return Object.defineProperty(e,"__childrenNodeConstructor",{get:function(){return Te},set:function(e){Te=e},enumerable:!0,configurable:!0}),e.prototype.isLeafNode=function(){return!0},e.prototype.getPriority=function(){return this.priorityNode_},e.prototype.updatePriority=function(t){return new e(this.value_,t)},e.prototype.getImmediateChild=function(t){return".priority"===t?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE},e.prototype.getChild=function(t){return t.isEmpty()?this:".priority"===t.getFront()?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE},e.prototype.hasChild=function(){return!1},e.prototype.getPredecessorChildName=function(e,t){return null},e.prototype.updateImmediateChild=function(t,n){return".priority"===t?this.updatePriority(n):n.isEmpty()&&".priority"!==t?this:e.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,n).updatePriority(this.priorityNode_)},e.prototype.updateChild=function(t,n){var r=t.getFront();return null===r?n:n.isEmpty()&&".priority"!==r?this:(u.assert(".priority"!==r||1===t.getLength(),".priority must be the last token in a path"),this.updateImmediateChild(r,e.__childrenNodeConstructor.EMPTY_NODE.updateChild(t.popFront(),n)))},e.prototype.isEmpty=function(){return!1},e.prototype.numChildren=function(){return 0},e.prototype.forEachChild=function(e,t){return!1},e.prototype.val=function(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},e.prototype.hash=function(){if(null===this.lazyHash_){var e="";this.priorityNode_.isEmpty()||(e+="priority:"+xe(this.priorityNode_.val())+":");var t=typeof this.value_;e+=t+":",e+="number"===t?F(this.value_):this.value_,this.lazyHash_=y(e)}return this.lazyHash_},e.prototype.getValue=function(){return this.value_},e.prototype.compareTo=function(t){return t===e.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof e.__childrenNodeConstructor?-1:(u.assert(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))},e.prototype.compareToLeafNode_=function(t){var n=typeof t.value_,r=typeof this.value_,i=e.VALUE_TYPE_ORDER.indexOf(n),o=e.VALUE_TYPE_ORDER.indexOf(r);return u.assert(i>=0,"Unknown leaf type: "+n),u.assert(o>=0,"Unknown leaf type: "+r),i===o?"object"===r?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-i},e.prototype.withIndex=function(){return this},e.prototype.isIndexed=function(){return!0},e.prototype.equals=function(e){if(e===this)return!0;if(e.isLeafNode()){var t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}return!1},e.VALUE_TYPE_ORDER=["object","boolean","number","string"],e}();var Ae,Ne,Le=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s.__extends(t,e),t.prototype.compare=function(e,t){var n=e.node.getPriority(),r=t.node.getPriority(),i=n.compareTo(r);return 0===i?L(e.name,t.name):i},t.prototype.isDefinedOn=function(e){return!e.getPriority().isEmpty()},t.prototype.indexedValueChanged=function(e,t){return!e.getPriority().equals(t.getPriority())},t.prototype.minPost=function(){return be.MIN},t.prototype.maxPost=function(){return new be(N,new ke("[PRIORITY-POST]",Ee))},t.prototype.makePost=function(e,t){var n=Se(e);return new be(t,new ke("[PRIORITY-POST]",n))},t.prototype.toString=function(){return".priority"},t}(we)),De=function(){function e(e,t,n,r,i){void 0===i&&(i=null),this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];for(var o=1;!e.isEmpty();)if(e=e,o=t?n(e.key,t):1,r&&(o*=-1),o<0)e=this.isReverse_?e.left:e.right;else{if(0===o){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}return e.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var e,t=this.nodeStack_.pop();if(e=this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value},this.isReverse_)for(t=t.left;!t.isEmpty();)this.nodeStack_.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack_.push(t),t=t.left;return e},e.prototype.hasNext=function(){return this.nodeStack_.length>0},e.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}},e}(),Oe=function(){function e(t,n,r,i,o){this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=i?i:Re.EMPTY_NODE,this.right=null!=o?o:Re.EMPTY_NODE}return e.prototype.copy=function(t,n,r,i,o){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},e.prototype.count=function(){return this.left.count()+1+this.right.count()},e.prototype.isEmpty=function(){return!1},e.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},e.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},e.prototype.minKey=function(){return this.min_().key},e.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},e.prototype.insert=function(e,t,n){var r,i;return(i=(r=n(e,(i=this).key))<0?i.copy(null,null,null,i.left.insert(e,t,n),null):0===r?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,n))).fixUp_()},e.prototype.removeMin_=function(){if(this.left.isEmpty())return Re.EMPTY_NODE;var e=this;return e.left.isRed_()||e.left.left.isRed_()||(e=e.moveRedLeft_()),(e=e.copy(null,null,null,e.left.removeMin_(),null)).fixUp_()},e.prototype.remove=function(e,t){var n,r;if(t(e,(n=this).key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===t(e,n.key)){if(n.right.isEmpty())return Re.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp_()},e.prototype.isRed_=function(){return this.color},e.prototype.fixUp_=function(){var e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e},e.prototype.moveRedLeft_=function(){var e=this.colorFlip_();return e.right.left.isRed_()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight_())).rotateLeft_()).colorFlip_()),e},e.prototype.moveRedRight_=function(){var e=this.colorFlip_();return e.left.left.isRed_()&&(e=(e=e.rotateRight_()).colorFlip_()),e},e.prototype.rotateLeft_=function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},e.prototype.rotateRight_=function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},e.prototype.colorFlip_=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},e.prototype.checkMaxDepth_=function(){var e=this.check_();return Math.pow(2,e)<=this.count()+1},e.prototype.check_=function(){var e;if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");if((e=this.left.check_())!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)},e.RED=!0,e.BLACK=!1,e}(),Me=function(){function e(){}return e.prototype.copy=function(e,t,n,r,i){return this},e.prototype.insert=function(e,t,n){return new Oe(e,t,null)},e.prototype.remove=function(e,t){return this},e.prototype.count=function(){return 0},e.prototype.isEmpty=function(){return!0},e.prototype.inorderTraversal=function(e){return!1},e.prototype.reverseTraversal=function(e){return!1},e.prototype.minKey=function(){return null},e.prototype.maxKey=function(){return null},e.prototype.check_=function(){return 0},e.prototype.isRed_=function(){return!1},e}(),Re=function(){function e(t,n){void 0===n&&(n=e.EMPTY_NODE),this.comparator_=t,this.root_=n}return e.prototype.insert=function(t,n){return new e(this.comparator_,this.root_.insert(t,n,this.comparator_).copy(null,null,Oe.BLACK,null,null))},e.prototype.remove=function(t){return new e(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,Oe.BLACK,null,null))},e.prototype.get=function(e){for(var t,n=this.root_;!n.isEmpty();){if(0===(t=this.comparator_(e,n.key)))return n.value;t<0?n=n.left:t>0&&(n=n.right)}return null},e.prototype.getPredecessorKey=function(e){for(var t,n=this.root_,r=null;!n.isEmpty();){if(0===(t=this.comparator_(e,n.key))){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}t<0?n=n.left:t>0&&(r=n,n=n.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},e.prototype.isEmpty=function(){return this.root_.isEmpty()},e.prototype.count=function(){return this.root_.count()},e.prototype.minKey=function(){return this.root_.minKey()},e.prototype.maxKey=function(){return this.root_.maxKey()},e.prototype.inorderTraversal=function(e){return this.root_.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.root_.reverseTraversal(e)},e.prototype.getIterator=function(e){return new De(this.root_,null,this.comparator_,!1,e)},e.prototype.getIteratorFrom=function(e,t){return new De(this.root_,e,this.comparator_,!1,t)},e.prototype.getReverseIteratorFrom=function(e,t){return new De(this.root_,e,this.comparator_,!0,t)},e.prototype.getReverseIterator=function(e){return new De(this.root_,null,this.comparator_,!0,e)},e.EMPTY_NODE=new Me,e}(),Pe=Math.log(2),Fe=function(){function e(e){var t;this.count=(t=e+1,parseInt(Math.log(t)/Pe,10)),this.current_=this.count-1;var n,r=(n=this.count,parseInt(Array(n+1).join("1"),2));this.bits_=e+1&r}return e.prototype.nextBitIsOne=function(){var e=!(this.bits_&1<<this.current_);return this.current_--,e},e}(),je=function(e,t,n,r){e.sort(t);var i=function(t){for(var r=null,i=null,o=e.length,a=function(t,r){var i=o-t,a=o;o-=t;var u=function t(r,i){var o,a,s=i-r;if(0==s)return null;if(1==s)return o=e[r],a=n?n(o):o,new Oe(a,o.node,Oe.BLACK,null,null);var u=parseInt(s/2,10)+r,c=t(r,u),l=t(u+1,i);return o=e[u],a=n?n(o):o,new Oe(a,o.node,Oe.BLACK,c,l)}(i+1,a),c=e[i],l=n?n(c):c;s(new Oe(l,c.node,r,null,u))},s=function(e){r?(r.left=e,r=e):(i=e,r=e)},u=0;u<t.count;++u){var c=t.nextBitIsOne(),l=Math.pow(2,t.count-(u+1));c?a(l,Oe.BLACK):(a(l,Oe.BLACK),a(l,Oe.RED))}return i}(new Fe(e.length));return new Re(r||t,i)},Be={},Ve=function(){function e(e,t){this.indexes_=e,this.indexSet_=t}return Object.defineProperty(e,"Default",{get:function(){return u.assert(Be&&Le,"ChildrenNode.ts has not been loaded"),Ae=Ae||new e({".priority":Be},{".priority":Le})},enumerable:!0,configurable:!0}),e.prototype.get=function(e){var t=u.safeGet(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Re?t:null},e.prototype.hasIndex=function(e){return u.contains(this.indexSet_,e.toString())},e.prototype.addIndex=function(t,n){u.assert(t!==Ce,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var r,i=[],o=!1,a=n.getIterator(be.Wrap),c=a.getNext();c;)o=o||t.isDefinedOn(c.node),i.push(c),c=a.getNext();r=o?je(i,t.getCompare()):Be;var l=t.toString(),h=s.__assign({},this.indexSet_);h[l]=t;var d=s.__assign({},this.indexes_);return d[l]=r,new e(d,h)},e.prototype.addToIndexes=function(t,n){var r=this;return new e(u.map(this.indexes_,(function(e,i){var o=u.safeGet(r.indexSet_,i);if(u.assert(o,"Missing index implementation for "+i),e===Be){if(o.isDefinedOn(t.node)){for(var a=[],s=n.getIterator(be.Wrap),c=s.getNext();c;)c.name!=t.name&&a.push(c),c=s.getNext();return a.push(t),je(a,o.getCompare())}return Be}var l=n.get(t.name),h=e;return l&&(h=h.remove(new be(t.name,l))),h.insert(t,t.node)})),this.indexSet_)},e.prototype.removeFromIndexes=function(t,n){return new e(u.map(this.indexes_,(function(e){if(e===Be)return e;var r=n.get(t.name);return r?e.remove(new be(t.name,r)):e})),this.indexSet_)},e}();function We(e,t){return L(e.name,t.name)}function Ue(e,t){return L(e,t)}var He=function(){function e(e,t,n){this.children_=e,this.priorityNode_=t,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&Ie(this.priorityNode_),this.children_.isEmpty()&&u.assert(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}return Object.defineProperty(e,"EMPTY_NODE",{get:function(){return Ne||(Ne=new e(new Re(Ue),null,Ve.Default))},enumerable:!0,configurable:!0}),e.prototype.isLeafNode=function(){return!1},e.prototype.getPriority=function(){return this.priorityNode_||Ne},e.prototype.updatePriority=function(t){return this.children_.isEmpty()?this:new e(this.children_,t,this.indexMap_)},e.prototype.getImmediateChild=function(e){if(".priority"===e)return this.getPriority();var t=this.children_.get(e);return null===t?Ne:t},e.prototype.getChild=function(e){var t=e.getFront();return null===t?this:this.getImmediateChild(t).getChild(e.popFront())},e.prototype.hasChild=function(e){return null!==this.children_.get(e)},e.prototype.updateImmediateChild=function(t,n){if(u.assert(n,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(n);var r,i=new be(t,n),o=void 0,a=void 0;return n.isEmpty()?(o=this.children_.remove(t),a=this.indexMap_.removeFromIndexes(i,this.children_)):(o=this.children_.insert(t,n),a=this.indexMap_.addToIndexes(i,this.children_)),r=o.isEmpty()?Ne:this.priorityNode_,new e(o,r,a)},e.prototype.updateChild=function(e,t){var n=e.getFront();if(null===n)return t;u.assert(".priority"!==e.getFront()||1===e.getLength(),".priority must be the last token in a path");var r=this.getImmediateChild(n).updateChild(e.popFront(),t);return this.updateImmediateChild(n,r)},e.prototype.isEmpty=function(){return this.children_.isEmpty()},e.prototype.numChildren=function(){return this.children_.count()},e.prototype.val=function(t){if(this.isEmpty())return null;var n={},r=0,i=0,o=!0;if(this.forEachChild(Le,(function(a,s){n[a]=s.val(t),r++,o&&e.INTEGER_REGEXP_.test(a)?i=Math.max(i,Number(a)):o=!1})),!t&&o&&i<2*r){var a=[];for(var s in n)a[s]=n[s];return a}return t&&!this.getPriority().isEmpty()&&(n[".priority"]=this.getPriority().val()),n},e.prototype.hash=function(){if(null===this.lazyHash_){var e="";this.getPriority().isEmpty()||(e+="priority:"+xe(this.getPriority().val())+":"),this.forEachChild(Le,(function(t,n){var r=n.hash();""!==r&&(e+=":"+t+":"+r)})),this.lazyHash_=""===e?"":y(e)}return this.lazyHash_},e.prototype.getPredecessorChildName=function(e,t,n){var r=this.resolveIndex_(n);if(r){var i=r.getPredecessorKey(new be(e,t));return i?i.name:null}return this.children_.getPredecessorKey(e)},e.prototype.getFirstChildName=function(e){var t=this.resolveIndex_(e);if(t){var n=t.minKey();return n&&n.name}return this.children_.minKey()},e.prototype.getFirstChild=function(e){var t=this.getFirstChildName(e);return t?new be(t,this.children_.get(t)):null},e.prototype.getLastChildName=function(e){var t=this.resolveIndex_(e);if(t){var n=t.maxKey();return n&&n.name}return this.children_.maxKey()},e.prototype.getLastChild=function(e){var t=this.getLastChildName(e);return t?new be(t,this.children_.get(t)):null},e.prototype.forEachChild=function(e,t){var n=this.resolveIndex_(e);return n?n.inorderTraversal((function(e){return t(e.name,e.node)})):this.children_.inorderTraversal(t)},e.prototype.getIterator=function(e){return this.getIteratorFrom(e.minPost(),e)},e.prototype.getIteratorFrom=function(e,t){var n=this.resolveIndex_(t);if(n)return n.getIteratorFrom(e,(function(e){return e}));for(var r=this.children_.getIteratorFrom(e.name,be.Wrap),i=r.peek();null!=i&&t.compare(i,e)<0;)r.getNext(),i=r.peek();return r},e.prototype.getReverseIterator=function(e){return this.getReverseIteratorFrom(e.maxPost(),e)},e.prototype.getReverseIteratorFrom=function(e,t){var n=this.resolveIndex_(t);if(n)return n.getReverseIteratorFrom(e,(function(e){return e}));for(var r=this.children_.getReverseIteratorFrom(e.name,be.Wrap),i=r.peek();null!=i&&t.compare(i,e)>0;)r.getNext(),i=r.peek();return r},e.prototype.compareTo=function(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===ze?-1:0},e.prototype.withIndex=function(t){if(t===Ce||this.indexMap_.hasIndex(t))return this;var n=this.indexMap_.addIndex(t,this.children_);return new e(this.children_,this.priorityNode_,n)},e.prototype.isIndexed=function(e){return e===Ce||this.indexMap_.hasIndex(e)},e.prototype.equals=function(e){if(e===this)return!0;if(e.isLeafNode())return!1;var t=e;if(this.getPriority().equals(t.getPriority())){if(this.children_.count()===t.children_.count()){for(var n=this.getIterator(Le),r=t.getIterator(Le),i=n.getNext(),o=r.getNext();i&&o;){if(i.name!==o.name||!i.node.equals(o.node))return!1;i=n.getNext(),o=r.getNext()}return null===i&&null===o}return!1}return!1},e.prototype.resolveIndex_=function(e){return e===Ce?null:this.indexMap_.get(e.toString())},e.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,e}(),ze=new(function(e){function t(){return e.call(this,new Re(Ue),He.EMPTY_NODE,Ve.Default)||this}return s.__extends(t,e),t.prototype.compareTo=function(e){return e===this?0:1},t.prototype.equals=function(e){return e===this},t.prototype.getPriority=function(){return this},t.prototype.getImmediateChild=function(e){return He.EMPTY_NODE},t.prototype.isEmpty=function(){return!1},t}(He));Object.defineProperties(be,{MIN:{value:new be(A,He.EMPTY_NODE)},MAX:{value:new be(N,ze)}}),_e.__EMPTY_NODE=He.EMPTY_NODE,ke.__childrenNodeConstructor=He,X=ze,function(e){Ee=e}(ze);var qe=!0;function Ke(e,t){if(void 0===t&&(t=null),null===e)return He.EMPTY_NODE;if("object"==typeof e&&".priority"in e&&(t=e[".priority"]),u.assert(null===t||"string"==typeof t||"number"==typeof t||"object"==typeof t&&".sv"in t,"Invalid priority type found: "+typeof t),"object"==typeof e&&".value"in e&&null!==e[".value"]&&(e=e[".value"]),"object"!=typeof e||".sv"in e)return new ke(e,Ke(t));if(e instanceof Array||!qe){var n=He.EMPTY_NODE;return P(e,(function(t,r){if(u.contains(e,t)&&"."!==t.substring(0,1)){var i=Ke(r);!i.isLeafNode()&&i.isEmpty()||(n=n.updateImmediateChild(t,i))}})),n.updatePriority(Ke(t))}var r=[],i=!1;if(P(e,(function(e,t){if("."!==e.substring(0,1)){var n=Ke(t);n.isEmpty()||(i=i||!n.getPriority().isEmpty(),r.push(new be(e,n)))}})),0==r.length)return He.EMPTY_NODE;var o=je(r,We,(function(e){return e.name}),Ue);if(i){var a=je(r,Le.getCompare());return new He(o,Ke(t),new Ve({".priority":a},{".priority":Le}))}return new He(o,Ke(t),Ve.Default)}!function(e){Se=e}(Ke);var Ge,Qe,$e=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s.__extends(t,e),t.prototype.compare=function(e,t){var n=e.node.compareTo(t.node);return 0===n?L(e.name,t.name):n},t.prototype.isDefinedOn=function(e){return!0},t.prototype.indexedValueChanged=function(e,t){return!e.equals(t)},t.prototype.minPost=function(){return be.MIN},t.prototype.maxPost=function(){return be.MAX},t.prototype.makePost=function(e,t){var n=Ke(e);return new be(t,n)},t.prototype.toString=function(){return".value"},t}(we)),Ye=function(e){function t(t){var n=e.call(this)||this;return n.indexPath_=t,u.assert(!t.isEmpty()&&".priority"!==t.getFront(),"Can't create PathIndex with empty path or .priority key"),n}return s.__extends(t,e),t.prototype.extractChild=function(e){return e.getChild(this.indexPath_)},t.prototype.isDefinedOn=function(e){return!e.getChild(this.indexPath_).isEmpty()},t.prototype.compare=function(e,t){var n=this.extractChild(e.node),r=this.extractChild(t.node),i=n.compareTo(r);return 0===i?L(e.name,t.name):i},t.prototype.makePost=function(e,t){var n=Ke(e),r=He.EMPTY_NODE.updateChild(this.indexPath_,n);return new be(t,r)},t.prototype.maxPost=function(){var e=He.EMPTY_NODE.updateChild(this.indexPath_,ze);return new be(N,e)},t.prototype.toString=function(){return this.indexPath_.slice().join("/")},t}(we),Xe=function(){function e(e,t,n){this.node_=e,this.ref_=t,this.index_=n}return e.prototype.val=function(){return u.validateArgCount("DataSnapshot.val",0,0,arguments.length),this.node_.val()},e.prototype.exportVal=function(){return u.validateArgCount("DataSnapshot.exportVal",0,0,arguments.length),this.node_.val(!0)},e.prototype.toJSON=function(){return u.validateArgCount("DataSnapshot.toJSON",0,1,arguments.length),this.exportVal()},e.prototype.exists=function(){return u.validateArgCount("DataSnapshot.exists",0,0,arguments.length),!this.node_.isEmpty()},e.prototype.child=function(t){u.validateArgCount("DataSnapshot.child",0,1,arguments.length),t=String(t),he("DataSnapshot.child",1,t,!1);var n=new H(t),r=this.ref_.child(n);return new e(this.node_.getChild(n),r,Le)},e.prototype.hasChild=function(e){u.validateArgCount("DataSnapshot.hasChild",1,1,arguments.length),he("DataSnapshot.hasChild",1,e,!1);var t=new H(e);return!this.node_.getChild(t).isEmpty()},e.prototype.getPriority=function(){return u.validateArgCount("DataSnapshot.getPriority",0,0,arguments.length),this.node_.getPriority().val()},e.prototype.forEach=function(t){var n=this;if(u.validateArgCount("DataSnapshot.forEach",1,1,arguments.length),u.validateCallback("DataSnapshot.forEach",1,t,!1),this.node_.isLeafNode())return!1;var r=this.node_;return!!r.forEachChild(this.index_,(function(r,i){return t(new e(i,n.ref_.child(r),Le))}))},e.prototype.hasChildren=function(){return u.validateArgCount("DataSnapshot.hasChildren",0,0,arguments.length),!this.node_.isLeafNode()&&!this.node_.isEmpty()},Object.defineProperty(e.prototype,"key",{get:function(){return this.ref_.getKey()},enumerable:!0,configurable:!0}),e.prototype.numChildren=function(){return u.validateArgCount("DataSnapshot.numChildren",0,0,arguments.length),this.node_.numChildren()},e.prototype.getRef=function(){return u.validateArgCount("DataSnapshot.ref",0,0,arguments.length),this.ref_},Object.defineProperty(e.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),e}(),Je=function(){function e(e,t,n,r){this.eventType=e,this.eventRegistration=t,this.snapshot=n,this.prevName=r}return e.prototype.getPath=function(){var e=this.snapshot.getRef();return"value"===this.eventType?e.path:e.getParent().path},e.prototype.getEventType=function(){return this.eventType},e.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},e.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+u.stringify(this.snapshot.exportVal())},e}(),Ze=function(){function e(e,t,n){this.eventRegistration=e,this.error=t,this.path=n}return e.prototype.getPath=function(){return this.path},e.prototype.getEventType=function(){return"cancel"},e.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},e.prototype.toString=function(){return this.path.toString()+":cancel"},e}(),et=function(){function e(e,t,n){this.callback_=e,this.cancelCallback_=t,this.context_=n}return e.prototype.respondsTo=function(e){return"value"===e},e.prototype.createEvent=function(e,t){var n=t.getQueryParams().getIndex();return new Je("value",this,new Xe(e.snapshotNode,t.getRef(),n))},e.prototype.getEventRunner=function(e){var t=this.context_;if("cancel"===e.getEventType()){u.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(t,e.error)}}var r=this.callback_;return function(){r.call(t,e.snapshot)}},e.prototype.createCancelEvent=function(e,t){return this.cancelCallback_?new Ze(this,e,t):null},e.prototype.matches=function(t){return t instanceof e&&(!t.callback_||!this.callback_||t.callback_===this.callback_&&t.context_===this.context_)},e.prototype.hasAnyCallback=function(){return null!==this.callback_},e}(),tt=function(){function e(e,t,n){this.callbacks_=e,this.cancelCallback_=t,this.context_=n}return e.prototype.respondsTo=function(e){var t="children_added"===e?"child_added":e;return t="children_removed"===t?"child_removed":t,u.contains(this.callbacks_,t)},e.prototype.createCancelEvent=function(e,t){return this.cancelCallback_?new Ze(this,e,t):null},e.prototype.createEvent=function(e,t){u.assert(null!=e.childName,"Child events should have a childName.");var n=t.getRef().child(e.childName),r=t.getQueryParams().getIndex();return new Je(e.type,this,new Xe(e.snapshotNode,n,r),e.prevName)},e.prototype.getEventRunner=function(e){var t=this.context_;if("cancel"===e.getEventType()){u.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(t,e.error)}}var r=this.callbacks_[e.eventType];return function(){r.call(t,e.snapshot,e.prevName)}},e.prototype.matches=function(t){var n=this;if(t instanceof e){if(!this.callbacks_||!t.callbacks_)return!0;if(this.context_===t.context_){var r=Object.keys(t.callbacks_),i=Object.keys(this.callbacks_),o=r.length;if(o===i.length){if(1===o){var a=r[0],s=i[0];return!(s!==a||t.callbacks_[a]&&this.callbacks_[s]&&t.callbacks_[a]!==this.callbacks_[s])}return i.every((function(e){return t.callbacks_[e]===n.callbacks_[e]}))}}}return!1},e.prototype.hasAnyCallback=function(){return null!==this.callbacks_},e}(),nt=function(){function e(e,t,n,r){this.repo=e,this.path=t,this.queryParams_=n,this.orderByCalled_=r}return Object.defineProperty(e,"__referenceConstructor",{get:function(){return u.assert(Ge,"Reference.ts has not been loaded"),Ge},set:function(e){Ge=e},enumerable:!0,configurable:!0}),e.validateQueryEndpoints_=function(e){var t=null,n=null;if(e.hasStart()&&(t=e.getIndexStartValue()),e.hasEnd()&&(n=e.getIndexEndValue()),e.getIndex()===Ce){var r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.";if(e.hasStart()){if(e.getIndexStartName()!=A)throw new Error(r);if("string"!=typeof t)throw new Error(i)}if(e.hasEnd()){if(e.getIndexEndName()!=N)throw new Error(r);if("string"!=typeof n)throw new Error(i)}}else if(e.getIndex()===Le){if(null!=t&&!ie(t)||null!=n&&!ie(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), endAt(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(u.assert(e.getIndex()instanceof Ye||e.getIndex()===$e,"unknown index type."),null!=t&&"object"==typeof t||null!=n&&"object"==typeof n)throw new Error("Query: First argument passed to startAt(), endAt(), or equalTo() cannot be an object.")},e.validateLimit_=function(e){if(e.hasStart()&&e.hasEnd()&&e.hasLimit()&&!e.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), endAt(), and limit(). Use limitToFirst() or limitToLast() instead.")},e.prototype.validateNoPreviousOrderByCall_=function(e){if(!0===this.orderByCalled_)throw new Error(e+": You can't combine multiple orderBy calls.")},e.prototype.getQueryParams=function(){return this.queryParams_},e.prototype.getRef=function(){return u.validateArgCount("Query.ref",0,0,arguments.length),new e.__referenceConstructor(this.repo,this.path)},e.prototype.on=function(t,n,r,i){u.validateArgCount("Query.on",2,4,arguments.length),ce("Query.on",1,t,!1),u.validateCallback("Query.on",2,n,!1);var o=e.getCancelAndContextArgs_("Query.on",r,i);if("value"===t)this.onValueEvent(n,o.cancel,o.context);else{var a={};a[t]=n,this.onChildEvent(a,o.cancel,o.context)}return n},e.prototype.onValueEvent=function(e,t,n){var r=new et(e,t||null,n||null);this.repo.addEventCallbackForQuery(this,r)},e.prototype.onChildEvent=function(e,t,n){var r=new tt(e,t,n);this.repo.addEventCallbackForQuery(this,r)},e.prototype.off=function(e,t,n){u.validateArgCount("Query.off",0,3,arguments.length),ce("Query.off",1,e,!0),u.validateCallback("Query.off",2,t,!0),u.validateContextObject("Query.off",3,n,!0);var r=null,i=null;if("value"===e){var o=t||null;r=new et(o,null,n||null)}else e&&(t&&((i={})[e]=t),r=new tt(i,null,n||null));this.repo.removeEventCallbackForQuery(this,r)},e.prototype.once=function(t,n,r,i){var o=this;u.validateArgCount("Query.once",1,4,arguments.length),ce("Query.once",1,t,!1),u.validateCallback("Query.once",2,n,!0);var a=e.getCancelAndContextArgs_("Query.once",r,i),s=!0,c=new u.Deferred;c.promise.catch((function(){}));var l=function e(r){s&&(s=!1,o.off(t,e),n&&n.bind(a.context)(r),c.resolve(r))};return this.on(t,l,(function(e){o.off(t,l),a.cancel&&a.cancel.bind(a.context)(e),c.reject(e)})),c.promise},e.prototype.limitToFirst=function(t){if(u.validateArgCount("Query.limitToFirst",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToFirst: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToFirst: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new e(this.repo,this.path,this.queryParams_.limitToFirst(t),this.orderByCalled_)},e.prototype.limitToLast=function(t){if(u.validateArgCount("Query.limitToLast",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToLast: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToLast: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new e(this.repo,this.path,this.queryParams_.limitToLast(t),this.orderByCalled_)},e.prototype.orderByChild=function(t){if(u.validateArgCount("Query.orderByChild",1,1,arguments.length),"$key"===t)throw new Error('Query.orderByChild: "$key" is invalid.  Use Query.orderByKey() instead.');if("$priority"===t)throw new Error('Query.orderByChild: "$priority" is invalid.  Use Query.orderByPriority() instead.');if("$value"===t)throw new Error('Query.orderByChild: "$value" is invalid.  Use Query.orderByValue() instead.');he("Query.orderByChild",1,t,!1),this.validateNoPreviousOrderByCall_("Query.orderByChild");var n=new H(t);if(n.isEmpty())throw new Error("Query.orderByChild: cannot pass in empty path.  Use Query.orderByValue() instead.");var r=new Ye(n),i=this.queryParams_.orderBy(r);return e.validateQueryEndpoints_(i),new e(this.repo,this.path,i,!0)},e.prototype.orderByKey=function(){u.validateArgCount("Query.orderByKey",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByKey");var t=this.queryParams_.orderBy(Ce);return e.validateQueryEndpoints_(t),new e(this.repo,this.path,t,!0)},e.prototype.orderByPriority=function(){u.validateArgCount("Query.orderByPriority",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByPriority");var t=this.queryParams_.orderBy(Le);return e.validateQueryEndpoints_(t),new e(this.repo,this.path,t,!0)},e.prototype.orderByValue=function(){u.validateArgCount("Query.orderByValue",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByValue");var t=this.queryParams_.orderBy($e);return e.validateQueryEndpoints_(t),new e(this.repo,this.path,t,!0)},e.prototype.startAt=function(t,n){void 0===t&&(t=null),u.validateArgCount("Query.startAt",0,2,arguments.length),oe("Query.startAt",1,t,this.path,!0),le("Query.startAt",2,n,!0);var r=this.queryParams_.startAt(t,n);if(e.validateLimit_(r),e.validateQueryEndpoints_(r),this.queryParams_.hasStart())throw new Error("Query.startAt: Starting point was already set (by another call to startAt or equalTo).");return void 0===t&&(t=null,n=null),new e(this.repo,this.path,r,this.orderByCalled_)},e.prototype.endAt=function(t,n){void 0===t&&(t=null),u.validateArgCount("Query.endAt",0,2,arguments.length),oe("Query.endAt",1,t,this.path,!0),le("Query.endAt",2,n,!0);var r=this.queryParams_.endAt(t,n);if(e.validateLimit_(r),e.validateQueryEndpoints_(r),this.queryParams_.hasEnd())throw new Error("Query.endAt: Ending point was already set (by another call to endAt or equalTo).");return new e(this.repo,this.path,r,this.orderByCalled_)},e.prototype.equalTo=function(e,t){if(u.validateArgCount("Query.equalTo",1,2,arguments.length),oe("Query.equalTo",1,e,this.path,!1),le("Query.equalTo",2,t,!0),this.queryParams_.hasStart())throw new Error("Query.equalTo: Starting point was already set (by another call to startAt or equalTo).");if(this.queryParams_.hasEnd())throw new Error("Query.equalTo: Ending point was already set (by another call to endAt or equalTo).");return this.startAt(e,t).endAt(e,t)},e.prototype.toString=function(){return u.validateArgCount("Query.toString",0,0,arguments.length),this.repo.toString()+this.path.toUrlEncodedString()},e.prototype.toJSON=function(){return u.validateArgCount("Query.toJSON",0,1,arguments.length),this.toString()},e.prototype.queryObject=function(){return this.queryParams_.getQueryObject()},e.prototype.queryIdentifier=function(){var e=this.queryObject(),t=M(e);return"{}"===t?"default":t},e.prototype.isEqual=function(t){if(u.validateArgCount("Query.isEqual",1,1,arguments.length),!(t instanceof e)){var n="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(n)}var r=this.repo===t.repo,i=this.path.equals(t.path),o=this.queryIdentifier()===t.queryIdentifier();return r&&i&&o},e.getCancelAndContextArgs_=function(e,t,n){var r={cancel:null,context:null};if(t&&n)r.cancel=t,u.validateCallback(e,3,r.cancel,!0),r.context=n,u.validateContextObject(e,4,r.context,!0);else if(t)if("object"==typeof t&&null!==t)r.context=t;else{if("function"!=typeof t)throw new Error(u.errorPrefix(e,3,!0)+" must either be a cancel callback or a context object.");r.cancel=t}return r},Object.defineProperty(e.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),e}(),rt=function(){function e(){this.value=null,this.children=new Map}return e.prototype.find=function(e){if(null!=this.value)return this.value.getChild(e);if(!e.isEmpty()&&this.children.size>0){var t=e.getFront();return e=e.popFront(),this.children.has(t)?this.children.get(t).find(e):null}return null},e.prototype.remember=function(t,n){if(t.isEmpty())this.value=n,this.children.clear();else if(null!==this.value)this.value=this.value.updateChild(t,n);else{var r=t.getFront();this.children.has(r)||this.children.set(r,new e);var i=this.children.get(r);t=t.popFront(),i.remember(t,n)}},e.prototype.forget=function(e){if(e.isEmpty())return this.value=null,this.children.clear(),!0;if(null!==this.value){if(this.value.isLeafNode())return!1;var t=this.value;this.value=null;var n=this;return t.forEachChild(Le,(function(e,t){n.remember(new H(e),t)})),this.forget(e)}if(this.children.size>0){var r=e.getFront();if(e=e.popFront(),this.children.has(r))this.children.get(r).forget(e)&&this.children.delete(r);return 0===this.children.size}return!0},e.prototype.forEachTree=function(e,t){null!==this.value?t(e,this.value):this.forEachChild((function(n,r){var i=new H(e.toString()+"/"+n);r.forEachTree(i,t)}))},e.prototype.forEachChild=function(e){this.children.forEach((function(t,n){e(n,t)}))},e}(),it=function(e,t,n){return e&&"object"==typeof e?(u.assert(".sv"in e,"Unexpected leaf node or priority contents"),"string"==typeof e[".sv"]?ot(e[".sv"],t,n):"object"==typeof e[".sv"]?at(e[".sv"],t):void u.assert(!1,"Unexpected server value: "+JSON.stringify(e,null,2))):e},ot=function(e,t,n){switch(e){case"timestamp":return n.timestamp;default:u.assert(!1,"Unexpected server value: "+e)}},at=function(e,t,n){e.hasOwnProperty("increment")||u.assert(!1,"Unexpected server value: "+JSON.stringify(e,null,2));var r=e.increment;if("number"!=typeof r&&u.assert(!1,"Unexpected increment value: "+r),!t.isLeafNode())return r;var i=t.getValue();return"number"!=typeof i?r:i+r},st=function e(t,n,r){var i,o=t.getPriority().val(),a=it(o,n.getPriority(),r);if(t.isLeafNode()){var s=t,u=it(s.getValue(),n,r);return u!==s.getValue()||a!==s.getPriority().val()?new ke(u,Ke(a)):t}var c=t;return i=c,a!==c.getPriority().val()&&(i=i.updatePriority(new ke(a))),c.forEachChild(Le,(function(t,o){var a=e(o,n.getImmediateChild(t),r);a!==o&&(i=i.updateImmediateChild(t,a))})),i};!function(e){e[e.OVERWRITE=0]="OVERWRITE",e[e.MERGE=1]="MERGE",e[e.ACK_USER_WRITE=2]="ACK_USER_WRITE",e[e.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(Qe||(Qe={}));var ut,ct,lt=function(){function e(e,t,n,r){this.fromUser=e,this.fromServer=t,this.queryId=n,this.tagged=r,u.assert(!r||t,"Tagged queries must be from server.")}return e.User=new e(!0,!1,null,!1),e.Server=new e(!1,!0,null,!1),e.forServerTaggedQuery=function(t){return new e(!1,!0,t,!0)},e}(),ht=function(){function e(e,t,n){this.path=e,this.affectedTree=t,this.revert=n,this.type=Qe.ACK_USER_WRITE,this.source=lt.User}return e.prototype.operationForChild=function(t){if(this.path.isEmpty()){if(null!=this.affectedTree.value)return u.assert(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var n=this.affectedTree.subtree(new H(t));return new e(H.Empty,n,this.revert)}return u.assert(this.path.getFront()===t,"operationForChild called for unrelated child."),new e(this.path.popFront(),this.affectedTree,this.revert)},e}(),dt=function(){return ut||(ut=new Re(D)),ut},pt=function(){function e(e,t){void 0===t&&(t=dt()),this.value=e,this.children=t}return e.fromObject=function(t){var n=e.Empty;return P(t,(function(e,t){n=n.set(new H(e),t)})),n},e.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},e.prototype.findRootMostMatchingPathAndValue=function(e,t){if(null!=this.value&&t(this.value))return{path:H.Empty,value:this.value};if(e.isEmpty())return null;var n=e.getFront(),r=this.children.get(n);if(null!==r){var i=r.findRootMostMatchingPathAndValue(e.popFront(),t);return null!=i?{path:new H(n).child(i.path),value:i.value}:null}return null},e.prototype.findRootMostValueAndPath=function(e){return this.findRootMostMatchingPathAndValue(e,(function(){return!0}))},e.prototype.subtree=function(t){if(t.isEmpty())return this;var n=t.getFront(),r=this.children.get(n);return null!==r?r.subtree(t.popFront()):e.Empty},e.prototype.set=function(t,n){if(t.isEmpty())return new e(n,this.children);var r=t.getFront(),i=(this.children.get(r)||e.Empty).set(t.popFront(),n),o=this.children.insert(r,i);return new e(this.value,o)},e.prototype.remove=function(t){if(t.isEmpty())return this.children.isEmpty()?e.Empty:new e(null,this.children);var n=t.getFront(),r=this.children.get(n);if(r){var i=r.remove(t.popFront()),o=void 0;return o=i.isEmpty()?this.children.remove(n):this.children.insert(n,i),null===this.value&&o.isEmpty()?e.Empty:new e(this.value,o)}return this},e.prototype.get=function(e){if(e.isEmpty())return this.value;var t=e.getFront(),n=this.children.get(t);return n?n.get(e.popFront()):null},e.prototype.setTree=function(t,n){if(t.isEmpty())return n;var r=t.getFront(),i=(this.children.get(r)||e.Empty).setTree(t.popFront(),n),o=void 0;return o=i.isEmpty()?this.children.remove(r):this.children.insert(r,i),new e(this.value,o)},e.prototype.fold=function(e){return this.fold_(H.Empty,e)},e.prototype.fold_=function(e,t){var n={};return this.children.inorderTraversal((function(r,i){n[r]=i.fold_(e.child(r),t)})),t(e,this.value,n)},e.prototype.findOnPath=function(e,t){return this.findOnPath_(e,H.Empty,t)},e.prototype.findOnPath_=function(e,t,n){var r=!!this.value&&n(t,this.value);if(r)return r;if(e.isEmpty())return null;var i=e.getFront(),o=this.children.get(i);return o?o.findOnPath_(e.popFront(),t.child(i),n):null},e.prototype.foreachOnPath=function(e,t){return this.foreachOnPath_(e,H.Empty,t)},e.prototype.foreachOnPath_=function(t,n,r){if(t.isEmpty())return this;this.value&&r(n,this.value);var i=t.getFront(),o=this.children.get(i);return o?o.foreachOnPath_(t.popFront(),n.child(i),r):e.Empty},e.prototype.foreach=function(e){this.foreach_(H.Empty,e)},e.prototype.foreach_=function(e,t){this.children.inorderTraversal((function(n,r){r.foreach_(e.child(n),t)})),this.value&&t(e,this.value)},e.prototype.foreachChild=function(e){this.children.inorderTraversal((function(t,n){n.value&&e(t,n.value)}))},e.Empty=new e(null),e}(),ft=function(){function e(e,t){this.source=e,this.path=t,this.type=Qe.LISTEN_COMPLETE}return e.prototype.operationForChild=function(t){return this.path.isEmpty()?new e(this.source,H.Empty):new e(this.source,this.path.popFront())},e}(),mt=function(){function e(e,t,n){this.source=e,this.path=t,this.snap=n,this.type=Qe.OVERWRITE}return e.prototype.operationForChild=function(t){return this.path.isEmpty()?new e(this.source,H.Empty,this.snap.getImmediateChild(t)):new e(this.source,this.path.popFront(),this.snap)},e}(),gt=function(){function e(e,t,n){this.source=e,this.path=t,this.children=n,this.type=Qe.MERGE}return e.prototype.operationForChild=function(t){if(this.path.isEmpty()){var n=this.children.subtree(new H(t));return n.isEmpty()?null:n.value?new mt(this.source,H.Empty,n.value):new e(this.source,H.Empty,n)}return u.assert(this.path.getFront()===t,"Can't get a merge for a child not on the path of the operation"),new e(this.source,this.path.popFront(),this.children)},e.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},e}(),vt=function(){function e(e,t,n){this.node_=e,this.fullyInitialized_=t,this.filtered_=n}return e.prototype.isFullyInitialized=function(){return this.fullyInitialized_},e.prototype.isFiltered=function(){return this.filtered_},e.prototype.isCompleteForPath=function(e){if(e.isEmpty())return this.isFullyInitialized()&&!this.filtered_;var t=e.getFront();return this.isCompleteForChild(t)},e.prototype.isCompleteForChild=function(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)},e.prototype.getNode=function(){return this.node_},e}(),yt=function(){function e(e,t){this.eventCache_=e,this.serverCache_=t}return e.prototype.updateEventSnap=function(t,n,r){return new e(new vt(t,n,r),this.serverCache_)},e.prototype.updateServerSnap=function(t,n,r){return new e(this.eventCache_,new vt(t,n,r))},e.prototype.getEventCache=function(){return this.eventCache_},e.prototype.getCompleteEventSnap=function(){return this.eventCache_.isFullyInitialized()?this.eventCache_.getNode():null},e.prototype.getServerCache=function(){return this.serverCache_},e.prototype.getCompleteServerSnap=function(){return this.serverCache_.isFullyInitialized()?this.serverCache_.getNode():null},e.Empty=new e(new vt(He.EMPTY_NODE,!1,!1),new vt(He.EMPTY_NODE,!1,!1)),e}(),bt=function(){function e(e,t,n,r,i){this.type=e,this.snapshotNode=t,this.childName=n,this.oldSnap=r,this.prevName=i}return e.valueChange=function(t){return new e(e.VALUE,t)},e.childAddedChange=function(t,n){return new e(e.CHILD_ADDED,n,t)},e.childRemovedChange=function(t,n){return new e(e.CHILD_REMOVED,n,t)},e.childChangedChange=function(t,n,r){return new e(e.CHILD_CHANGED,n,t,r)},e.childMovedChange=function(t,n){return new e(e.CHILD_MOVED,n,t)},e.CHILD_ADDED="child_added",e.CHILD_REMOVED="child_removed",e.CHILD_CHANGED="child_changed",e.CHILD_MOVED="child_moved",e.VALUE="value",e}(),wt=function(){function e(e){this.index_=e}return e.prototype.updateChild=function(e,t,n,r,i,o){u.assert(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");var a=e.getImmediateChild(t);return a.getChild(r).equals(n.getChild(r))&&a.isEmpty()==n.isEmpty()?e:(null!=o&&(n.isEmpty()?e.hasChild(t)?o.trackChildChange(bt.childRemovedChange(t,a)):u.assert(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):a.isEmpty()?o.trackChildChange(bt.childAddedChange(t,n)):o.trackChildChange(bt.childChangedChange(t,n,a))),e.isLeafNode()&&n.isEmpty()?e:e.updateImmediateChild(t,n).withIndex(this.index_))},e.prototype.updateFullNode=function(e,t,n){return null!=n&&(e.isLeafNode()||e.forEachChild(Le,(function(e,r){t.hasChild(e)||n.trackChildChange(bt.childRemovedChange(e,r))})),t.isLeafNode()||t.forEachChild(Le,(function(t,r){if(e.hasChild(t)){var i=e.getImmediateChild(t);i.equals(r)||n.trackChildChange(bt.childChangedChange(t,r,i))}else n.trackChildChange(bt.childAddedChange(t,r))}))),t.withIndex(this.index_)},e.prototype.updatePriority=function(e,t){return e.isEmpty()?He.EMPTY_NODE:e.updatePriority(t)},e.prototype.filtersNodes=function(){return!1},e.prototype.getIndexedFilter=function(){return this},e.prototype.getIndex=function(){return this.index_},e}(),_t=function(){function e(){this.changeMap=new Map}return e.prototype.trackChildChange=function(e){var t=e.type,n=e.childName;u.assert(t==bt.CHILD_ADDED||t==bt.CHILD_CHANGED||t==bt.CHILD_REMOVED,"Only child changes supported for tracking"),u.assert(".priority"!==n,"Only non-priority child changes can be tracked.");var r=this.changeMap.get(n);if(r){var i=r.type;if(t==bt.CHILD_ADDED&&i==bt.CHILD_REMOVED)this.changeMap.set(n,bt.childChangedChange(n,e.snapshotNode,r.snapshotNode));else if(t==bt.CHILD_REMOVED&&i==bt.CHILD_ADDED)this.changeMap.delete(n);else if(t==bt.CHILD_REMOVED&&i==bt.CHILD_CHANGED)this.changeMap.set(n,bt.childRemovedChange(n,r.oldSnap));else if(t==bt.CHILD_CHANGED&&i==bt.CHILD_ADDED)this.changeMap.set(n,bt.childAddedChange(n,e.snapshotNode));else{if(t!=bt.CHILD_CHANGED||i!=bt.CHILD_CHANGED)throw u.assertionError("Illegal combination of changes: "+e+" occurred after "+r);this.changeMap.set(n,bt.childChangedChange(n,e.snapshotNode,r.oldSnap))}}else this.changeMap.set(n,e)},e.prototype.getChanges=function(){return Array.from(this.changeMap.values())},e}(),Ct=new(function(){function e(){}return e.prototype.getCompleteChild=function(e){return null},e.prototype.getChildAfterChild=function(e,t,n){return null},e}()),Tt=function(){function e(e,t,n){void 0===n&&(n=null),this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=n}return e.prototype.getCompleteChild=function(e){var t=this.viewCache_.getEventCache();if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);var n=null!=this.optCompleteServerCache_?new vt(this.optCompleteServerCache_,!0,!1):this.viewCache_.getServerCache();return this.writes_.calcCompleteChild(e,n)},e.prototype.getChildAfterChild=function(e,t,n){var r=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:this.viewCache_.getCompleteServerSnap(),i=this.writes_.calcIndexedSlice(r,t,1,n,e);return 0===i.length?null:i[0]},e}(),St=function(e,t){this.viewCache=e,this.changes=t},Et=function(){function e(e){this.filter_=e}return e.prototype.assertIndexed=function(e){u.assert(e.getEventCache().getNode().isIndexed(this.filter_.getIndex()),"Event snap not indexed"),u.assert(e.getServerCache().getNode().isIndexed(this.filter_.getIndex()),"Server snap not indexed")},e.prototype.applyOperation=function(t,n,r,i){var o,a,s=new _t;if(n.type===Qe.OVERWRITE){var c=n;c.source.fromUser?o=this.applyUserOverwrite_(t,c.path,c.snap,r,i,s):(u.assert(c.source.fromServer,"Unknown source."),a=c.source.tagged||t.getServerCache().isFiltered()&&!c.path.isEmpty(),o=this.applyServerOverwrite_(t,c.path,c.snap,r,i,a,s))}else if(n.type===Qe.MERGE){var l=n;l.source.fromUser?o=this.applyUserMerge_(t,l.path,l.children,r,i,s):(u.assert(l.source.fromServer,"Unknown source."),a=l.source.tagged||t.getServerCache().isFiltered(),o=this.applyServerMerge_(t,l.path,l.children,r,i,a,s))}else if(n.type===Qe.ACK_USER_WRITE){var h=n;o=h.revert?this.revertUserWrite_(t,h.path,r,i,s):this.ackUserWrite_(t,h.path,h.affectedTree,r,i,s)}else{if(n.type!==Qe.LISTEN_COMPLETE)throw u.assertionError("Unknown operation type: "+n.type);o=this.listenComplete_(t,n.path,r,s)}var d=s.getChanges();return e.maybeAddValueEvent_(t,o,d),new St(o,d)},e.maybeAddValueEvent_=function(e,t,n){var r=t.getEventCache();if(r.isFullyInitialized()){var i=r.getNode().isLeafNode()||r.getNode().isEmpty(),o=e.getCompleteEventSnap();(n.length>0||!e.getEventCache().isFullyInitialized()||i&&!r.getNode().equals(o)||!r.getNode().getPriority().equals(o.getPriority()))&&n.push(bt.valueChange(t.getCompleteEventSnap()))}},e.prototype.generateEventCacheAfterServerEvent_=function(e,t,n,r,i){var o=e.getEventCache();if(null!=n.shadowingWrite(t))return e;var a=void 0,s=void 0;if(t.isEmpty())if(u.assert(e.getServerCache().isFullyInitialized(),"If change path is empty, we must have complete server data"),e.getServerCache().isFiltered()){var c=e.getCompleteServerSnap(),l=c instanceof He?c:He.EMPTY_NODE,h=n.calcCompleteEventChildren(l);a=this.filter_.updateFullNode(e.getEventCache().getNode(),h,i)}else{var d=n.calcCompleteEventCache(e.getCompleteServerSnap());a=this.filter_.updateFullNode(e.getEventCache().getNode(),d,i)}else{var p=t.getFront();if(".priority"==p){u.assert(1==t.getLength(),"Can't have a priority with additional path components");var f=o.getNode();s=e.getServerCache().getNode();var m=n.calcEventCacheAfterServerOverwrite(t,f,s);a=null!=m?this.filter_.updatePriority(f,m):o.getNode()}else{var g=t.popFront(),v=void 0;if(o.isCompleteForChild(p)){s=e.getServerCache().getNode();var y=n.calcEventCacheAfterServerOverwrite(t,o.getNode(),s);v=null!=y?o.getNode().getImmediateChild(p).updateChild(g,y):o.getNode().getImmediateChild(p)}else v=n.calcCompleteChild(p,e.getServerCache());a=null!=v?this.filter_.updateChild(o.getNode(),p,v,g,r,i):o.getNode()}}return e.updateEventSnap(a,o.isFullyInitialized()||t.isEmpty(),this.filter_.filtersNodes())},e.prototype.applyServerOverwrite_=function(e,t,n,r,i,o,a){var s,u=e.getServerCache(),c=o?this.filter_:this.filter_.getIndexedFilter();if(t.isEmpty())s=c.updateFullNode(u.getNode(),n,null);else if(c.filtersNodes()&&!u.isFiltered()){var l=u.getNode().updateChild(t,n);s=c.updateFullNode(u.getNode(),l,null)}else{var h=t.getFront();if(!u.isCompleteForPath(t)&&t.getLength()>1)return e;var d=t.popFront(),p=u.getNode().getImmediateChild(h).updateChild(d,n);s=".priority"==h?c.updatePriority(u.getNode(),p):c.updateChild(u.getNode(),h,p,d,Ct,null)}var f=e.updateServerSnap(s,u.isFullyInitialized()||t.isEmpty(),c.filtersNodes()),m=new Tt(r,f,i);return this.generateEventCacheAfterServerEvent_(f,t,r,m,a)},e.prototype.applyUserOverwrite_=function(e,t,n,r,i,o){var a,s,u=e.getEventCache(),c=new Tt(r,e,i);if(t.isEmpty())s=this.filter_.updateFullNode(e.getEventCache().getNode(),n,o),a=e.updateEventSnap(s,!0,this.filter_.filtersNodes());else{var l=t.getFront();if(".priority"===l)s=this.filter_.updatePriority(e.getEventCache().getNode(),n),a=e.updateEventSnap(s,u.isFullyInitialized(),u.isFiltered());else{var h=t.popFront(),d=u.getNode().getImmediateChild(l),p=void 0;if(h.isEmpty())p=n;else{var f=c.getCompleteChild(l);p=null!=f?".priority"===h.getBack()&&f.getChild(h.parent()).isEmpty()?f:f.updateChild(h,n):He.EMPTY_NODE}if(d.equals(p))a=e;else{var m=this.filter_.updateChild(u.getNode(),l,p,h,c,o);a=e.updateEventSnap(m,u.isFullyInitialized(),this.filter_.filtersNodes())}}}return a},e.cacheHasChild_=function(e,t){return e.getEventCache().isCompleteForChild(t)},e.prototype.applyUserMerge_=function(t,n,r,i,o,a){var s=this,u=t;return r.foreach((function(r,c){var l=n.child(r);e.cacheHasChild_(t,l.getFront())&&(u=s.applyUserOverwrite_(u,l,c,i,o,a))})),r.foreach((function(r,c){var l=n.child(r);e.cacheHasChild_(t,l.getFront())||(u=s.applyUserOverwrite_(u,l,c,i,o,a))})),u},e.prototype.applyMerge_=function(e,t){return t.foreach((function(t,n){e=e.updateChild(t,n)})),e},e.prototype.applyServerMerge_=function(e,t,n,r,i,o,a){var s=this;if(e.getServerCache().getNode().isEmpty()&&!e.getServerCache().isFullyInitialized())return e;var u,c=e;u=t.isEmpty()?n:pt.Empty.setTree(t,n);var l=e.getServerCache().getNode();return u.children.inorderTraversal((function(t,n){if(l.hasChild(t)){var u=e.getServerCache().getNode().getImmediateChild(t),h=s.applyMerge_(u,n);c=s.applyServerOverwrite_(c,new H(t),h,r,i,o,a)}})),u.children.inorderTraversal((function(t,n){var u=!e.getServerCache().isCompleteForChild(t)&&null==n.value;if(!l.hasChild(t)&&!u){var h=e.getServerCache().getNode().getImmediateChild(t),d=s.applyMerge_(h,n);c=s.applyServerOverwrite_(c,new H(t),d,r,i,o,a)}})),c},e.prototype.ackUserWrite_=function(e,t,n,r,i,o){if(null!=r.shadowingWrite(t))return e;var a=e.getServerCache().isFiltered(),s=e.getServerCache();if(null!=n.value){if(t.isEmpty()&&s.isFullyInitialized()||s.isCompleteForPath(t))return this.applyServerOverwrite_(e,t,s.getNode().getChild(t),r,i,a,o);if(t.isEmpty()){var u=pt.Empty;return s.getNode().forEachChild(Ce,(function(e,t){u=u.set(new H(e),t)})),this.applyServerMerge_(e,t,u,r,i,a,o)}return e}var c=pt.Empty;return n.foreach((function(e,n){var r=t.child(e);s.isCompleteForPath(r)&&(c=c.set(e,s.getNode().getChild(r)))})),this.applyServerMerge_(e,t,c,r,i,a,o)},e.prototype.listenComplete_=function(e,t,n,r){var i=e.getServerCache(),o=e.updateServerSnap(i.getNode(),i.isFullyInitialized()||t.isEmpty(),i.isFiltered());return this.generateEventCacheAfterServerEvent_(o,t,n,Ct,r)},e.prototype.revertUserWrite_=function(e,t,n,r,i){var o;if(null!=n.shadowingWrite(t))return e;var a=new Tt(n,e,r),s=e.getEventCache().getNode(),c=void 0;if(t.isEmpty()||".priority"===t.getFront()){var l=void 0;if(e.getServerCache().isFullyInitialized())l=n.calcCompleteEventCache(e.getCompleteServerSnap());else{var h=e.getServerCache().getNode();u.assert(h instanceof He,"serverChildren would be complete if leaf node"),l=n.calcCompleteEventChildren(h)}l=l,c=this.filter_.updateFullNode(s,l,i)}else{var d=t.getFront(),p=n.calcCompleteChild(d,e.getServerCache());null==p&&e.getServerCache().isCompleteForChild(d)&&(p=s.getImmediateChild(d)),(c=null!=p?this.filter_.updateChild(s,d,p,t.popFront(),a,i):e.getEventCache().getNode().hasChild(d)?this.filter_.updateChild(s,d,He.EMPTY_NODE,t.popFront(),a,i):s).isEmpty()&&e.getServerCache().isFullyInitialized()&&(o=n.calcCompleteEventCache(e.getCompleteServerSnap())).isLeafNode()&&(c=this.filter_.updateFullNode(c,o,i))}return o=e.getServerCache().isFullyInitialized()||null!=n.shadowingWrite(H.Empty),e.updateEventSnap(c,o,this.filter_.filtersNodes())},e}(),xt=function(){function e(e){this.query_=e,this.index_=this.query_.getQueryParams().getIndex()}return e.prototype.generateEventsForChanges=function(e,t,n){var r=this,i=[],o=[];return e.forEach((function(e){e.type===bt.CHILD_CHANGED&&r.index_.indexedValueChanged(e.oldSnap,e.snapshotNode)&&o.push(bt.childMovedChange(e.childName,e.snapshotNode))})),this.generateEventsForType_(i,bt.CHILD_REMOVED,e,n,t),this.generateEventsForType_(i,bt.CHILD_ADDED,e,n,t),this.generateEventsForType_(i,bt.CHILD_MOVED,o,n,t),this.generateEventsForType_(i,bt.CHILD_CHANGED,e,n,t),this.generateEventsForType_(i,bt.VALUE,e,n,t),i},e.prototype.generateEventsForType_=function(e,t,n,r,i){var o=this,a=n.filter((function(e){return e.type===t}));a.sort(this.compareChanges_.bind(this)),a.forEach((function(t){var n=o.materializeSingleChange_(t,i);r.forEach((function(r){r.respondsTo(t.type)&&e.push(r.createEvent(n,o.query_))}))}))},e.prototype.materializeSingleChange_=function(e,t){return"value"===e.type||"child_removed"===e.type?e:(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,this.index_),e)},e.prototype.compareChanges_=function(e,t){if(null==e.childName||null==t.childName)throw u.assertionError("Should only compare child_ events.");var n=new be(e.childName,e.snapshotNode),r=new be(t.childName,t.snapshotNode);return this.index_.compare(n,r)},e}(),It=function(){function e(e,t){this.query_=e,this.eventRegistrations_=[];var n=this.query_.getQueryParams(),r=new wt(n.getIndex()),i=n.getNodeFilter();this.processor_=new Et(i);var o=t.getServerCache(),a=t.getEventCache(),s=r.updateFullNode(He.EMPTY_NODE,o.getNode(),null),u=i.updateFullNode(He.EMPTY_NODE,a.getNode(),null),c=new vt(s,o.isFullyInitialized(),r.filtersNodes()),l=new vt(u,a.isFullyInitialized(),i.filtersNodes());this.viewCache_=new yt(l,c),this.eventGenerator_=new xt(this.query_)}return e.prototype.getQuery=function(){return this.query_},e.prototype.getServerCache=function(){return this.viewCache_.getServerCache().getNode()},e.prototype.getCompleteServerCache=function(e){var t=this.viewCache_.getCompleteServerSnap();return t&&(this.query_.getQueryParams().loadsAllData()||!e.isEmpty()&&!t.getImmediateChild(e.getFront()).isEmpty())?t.getChild(e):null},e.prototype.isEmpty=function(){return 0===this.eventRegistrations_.length},e.prototype.addEventRegistration=function(e){this.eventRegistrations_.push(e)},e.prototype.removeEventRegistration=function(e,t){var n=[];if(t){u.assert(null==e,"A cancel should cancel all event registrations.");var r=this.query_.path;this.eventRegistrations_.forEach((function(e){t=t;var i=e.createCancelEvent(t,r);i&&n.push(i)}))}if(e){for(var i=[],o=0;o<this.eventRegistrations_.length;++o){var a=this.eventRegistrations_[o];if(a.matches(e)){if(e.hasAnyCallback()){i=i.concat(this.eventRegistrations_.slice(o+1));break}}else i.push(a)}this.eventRegistrations_=i}else this.eventRegistrations_=[];return n},e.prototype.applyOperation=function(e,t,n){e.type===Qe.MERGE&&null!==e.source.queryId&&(u.assert(this.viewCache_.getCompleteServerSnap(),"We should always have a full cache before handling merges"),u.assert(this.viewCache_.getCompleteEventSnap(),"Missing event cache, even though we have a server cache"));var r=this.viewCache_,i=this.processor_.applyOperation(r,e,t,n);return this.processor_.assertIndexed(i.viewCache),u.assert(i.viewCache.getServerCache().isFullyInitialized()||!r.getServerCache().isFullyInitialized(),"Once a server snap is complete, it should never go back"),this.viewCache_=i.viewCache,this.generateEventsForChanges_(i.changes,i.viewCache.getEventCache().getNode(),null)},e.prototype.getInitialEvents=function(e){var t=this.viewCache_.getEventCache(),n=[];t.getNode().isLeafNode()||t.getNode().forEachChild(Le,(function(e,t){n.push(bt.childAddedChange(e,t))}));return t.isFullyInitialized()&&n.push(bt.valueChange(t.getNode())),this.generateEventsForChanges_(n,t.getNode(),e)},e.prototype.generateEventsForChanges_=function(e,t,n){var r=n?[n]:this.eventRegistrations_;return this.eventGenerator_.generateEventsForChanges(e,t,r)},e}(),kt=function(){function e(){this.views=new Map}return Object.defineProperty(e,"__referenceConstructor",{get:function(){return u.assert(ct,"Reference.ts has not been loaded"),ct},set:function(e){u.assert(!ct,"__referenceConstructor has already been defined"),ct=e},enumerable:!0,configurable:!0}),e.prototype.isEmpty=function(){return 0===this.views.size},e.prototype.applyOperation=function(e,t,n){var r,i,o=e.source.queryId;if(null!==o){var a=this.views.get(o);return u.assert(null!=a,"SyncTree gave us an op for an invalid query."),a.applyOperation(e,t,n)}var c=[];try{for(var l=s.__values(this.views.values()),h=l.next();!h.done;h=l.next()){a=h.value;c=c.concat(a.applyOperation(e,t,n))}}catch(d){r={error:d}}finally{try{h&&!h.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}return c},e.prototype.addEventRegistration=function(e,t,n,r,i){var o=e.queryIdentifier(),a=this.views.get(o);if(!a){var s=n.calcCompleteEventCache(i?r:null),u=!1;s?u=!0:r instanceof He?(s=n.calcCompleteEventChildren(r),u=!1):(s=He.EMPTY_NODE,u=!1);var c=new yt(new vt(s,u,!1),new vt(r,i,!1));a=new It(e,c),this.views.set(o,a)}return a.addEventRegistration(t),a.getInitialEvents(t)},e.prototype.removeEventRegistration=function(t,n,r){var i,o,a=t.queryIdentifier(),u=[],c=[],l=this.hasCompleteView();if("default"===a)try{for(var h=s.__values(this.views.entries()),d=h.next();!d.done;d=h.next()){var p=s.__read(d.value,2),f=p[0],m=p[1];c=c.concat(m.removeEventRegistration(n,r)),m.isEmpty()&&(this.views.delete(f),m.getQuery().getQueryParams().loadsAllData()||u.push(m.getQuery()))}}catch(g){i={error:g}}finally{try{d&&!d.done&&(o=h.return)&&o.call(h)}finally{if(i)throw i.error}}else(m=this.views.get(a))&&(c=c.concat(m.removeEventRegistration(n,r)),m.isEmpty()&&(this.views.delete(a),m.getQuery().getQueryParams().loadsAllData()||u.push(m.getQuery())));return l&&!this.hasCompleteView()&&u.push(new e.__referenceConstructor(t.repo,t.path)),{removed:u,events:c}},e.prototype.getQueryViews=function(){var e,t,n=[];try{for(var r=s.__values(this.views.values()),i=r.next();!i.done;i=r.next()){var o=i.value;o.getQuery().getQueryParams().loadsAllData()||n.push(o)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},e.prototype.getCompleteServerCache=function(e){var t,n,r=null;try{for(var i=s.__values(this.views.values()),o=i.next();!o.done;o=i.next()){var a=o.value;r=r||a.getCompleteServerCache(e)}}catch(u){t={error:u}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r},e.prototype.viewForQuery=function(e){if(e.getQueryParams().loadsAllData())return this.getCompleteView();var t=e.queryIdentifier();return this.views.get(t)},e.prototype.viewExistsForQuery=function(e){return null!=this.viewForQuery(e)},e.prototype.hasCompleteView=function(){return null!=this.getCompleteView()},e.prototype.getCompleteView=function(){var e,t;try{for(var n=s.__values(this.views.values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.getQuery().getQueryParams().loadsAllData())return i}}catch(o){e={error:o}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return null},e}(),At=function(){function e(e){this.writeTree_=e}return e.prototype.addWrite=function(t,n){if(t.isEmpty())return new e(new pt(n));var r=this.writeTree_.findRootMostValueAndPath(t);if(null!=r){var i=r.path,o=r.value,a=H.relativePath(i,t);return o=o.updateChild(a,n),new e(this.writeTree_.set(i,o))}var s=new pt(n);return new e(this.writeTree_.setTree(t,s))},e.prototype.addWrites=function(e,t){var n=this;return P(t,(function(t,r){n=n.addWrite(e.child(t),r)})),n},e.prototype.removeWrite=function(t){return t.isEmpty()?e.Empty:new e(this.writeTree_.setTree(t,pt.Empty))},e.prototype.hasCompleteWrite=function(e){return null!=this.getCompleteNode(e)},e.prototype.getCompleteNode=function(e){var t=this.writeTree_.findRootMostValueAndPath(e);return null!=t?this.writeTree_.get(t.path).getChild(H.relativePath(t.path,e)):null},e.prototype.getCompleteChildren=function(){var e=[],t=this.writeTree_.value;return null!=t?t.isLeafNode()||t.forEachChild(Le,(function(t,n){e.push(new be(t,n))})):this.writeTree_.children.inorderTraversal((function(t,n){null!=n.value&&e.push(new be(t,n.value))})),e},e.prototype.childCompoundWrite=function(t){if(t.isEmpty())return this;var n=this.getCompleteNode(t);return new e(null!=n?new pt(n):this.writeTree_.subtree(t))},e.prototype.isEmpty=function(){return this.writeTree_.isEmpty()},e.prototype.apply=function(e){return function e(t,n,r){if(null!=n.value)return r.updateChild(t,n.value);var i=null;return n.children.inorderTraversal((function(n,o){".priority"===n?(u.assert(null!==o.value,"Priority writes must always be leaf nodes"),i=o.value):r=e(t.child(n),o,r)})),r.getChild(t).isEmpty()||null===i||(r=r.updateChild(t.child(".priority"),i)),r}(H.Empty,this.writeTree_,e)},e.Empty=new e(new pt(null)),e}();var Nt=function(){function e(){this.visibleWrites_=At.Empty,this.allWrites_=[],this.lastWriteId_=-1}return e.prototype.childWrites=function(e){return new Lt(e,this)},e.prototype.addOverwrite=function(e,t,n,r){u.assert(n>this.lastWriteId_,"Stacking an older write on top of newer ones"),void 0===r&&(r=!0),this.allWrites_.push({path:e,snap:t,writeId:n,visible:r}),r&&(this.visibleWrites_=this.visibleWrites_.addWrite(e,t)),this.lastWriteId_=n},e.prototype.addMerge=function(e,t,n){u.assert(n>this.lastWriteId_,"Stacking an older merge on top of newer ones"),this.allWrites_.push({path:e,children:t,writeId:n,visible:!0}),this.visibleWrites_=this.visibleWrites_.addWrites(e,t),this.lastWriteId_=n},e.prototype.getWrite=function(e){for(var t=0;t<this.allWrites_.length;t++){var n=this.allWrites_[t];if(n.writeId===e)return n}return null},e.prototype.removeWrite=function(e){var t=this,n=this.allWrites_.findIndex((function(t){return t.writeId===e}));u.assert(n>=0,"removeWrite called with nonexistent writeId.");var r=this.allWrites_[n];this.allWrites_.splice(n,1);for(var i=r.visible,o=!1,a=this.allWrites_.length-1;i&&a>=0;){var s=this.allWrites_[a];s.visible&&(a>=n&&this.recordContainsPath_(s,r.path)?i=!1:r.path.contains(s.path)&&(o=!0)),a--}if(i){if(o)return this.resetTree_(),!0;r.snap?this.visibleWrites_=this.visibleWrites_.removeWrite(r.path):P(r.children,(function(e){t.visibleWrites_=t.visibleWrites_.removeWrite(r.path.child(e))}));return!0}return!1},e.prototype.getCompleteWriteData=function(e){return this.visibleWrites_.getCompleteNode(e)},e.prototype.calcCompleteEventCache=function(t,n,r,i){if(r||i){var o=this.visibleWrites_.childCompoundWrite(t);if(!i&&o.isEmpty())return n;if(i||null!=n||o.hasCompleteWrite(H.Empty)){var a=e.layerTree_(this.allWrites_,(function(e){return(e.visible||i)&&(!r||!~r.indexOf(e.writeId))&&(e.path.contains(t)||t.contains(e.path))}),t);c=n||He.EMPTY_NODE;return a.apply(c)}return null}var s=this.visibleWrites_.getCompleteNode(t);if(null!=s)return s;var u=this.visibleWrites_.childCompoundWrite(t);if(u.isEmpty())return n;if(null!=n||u.hasCompleteWrite(H.Empty)){var c=n||He.EMPTY_NODE;return u.apply(c)}return null},e.prototype.calcCompleteEventChildren=function(e,t){var n=He.EMPTY_NODE,r=this.visibleWrites_.getCompleteNode(e);if(r)return r.isLeafNode()||r.forEachChild(Le,(function(e,t){n=n.updateImmediateChild(e,t)})),n;if(t){var i=this.visibleWrites_.childCompoundWrite(e);return t.forEachChild(Le,(function(e,t){var r=i.childCompoundWrite(new H(e)).apply(t);n=n.updateImmediateChild(e,r)})),i.getCompleteChildren().forEach((function(e){n=n.updateImmediateChild(e.name,e.node)})),n}return this.visibleWrites_.childCompoundWrite(e).getCompleteChildren().forEach((function(e){n=n.updateImmediateChild(e.name,e.node)})),n},e.prototype.calcEventCacheAfterServerOverwrite=function(e,t,n,r){u.assert(n||r,"Either existingEventSnap or existingServerSnap must exist");var i=e.child(t);if(this.visibleWrites_.hasCompleteWrite(i))return null;var o=this.visibleWrites_.childCompoundWrite(i);return o.isEmpty()?r.getChild(t):o.apply(r.getChild(t))},e.prototype.calcCompleteChild=function(e,t,n){var r=e.child(t),i=this.visibleWrites_.getCompleteNode(r);return null!=i?i:n.isCompleteForChild(t)?this.visibleWrites_.childCompoundWrite(r).apply(n.getNode().getImmediateChild(t)):null},e.prototype.shadowingWrite=function(e){return this.visibleWrites_.getCompleteNode(e)},e.prototype.calcIndexedSlice=function(e,t,n,r,i,o){var a,s=this.visibleWrites_.childCompoundWrite(e),u=s.getCompleteNode(H.Empty);if(null!=u)a=u;else{if(null==t)return[];a=s.apply(t)}if((a=a.withIndex(o)).isEmpty()||a.isLeafNode())return[];for(var c=[],l=o.getCompare(),h=i?a.getReverseIteratorFrom(n,o):a.getIteratorFrom(n,o),d=h.getNext();d&&c.length<r;)0!==l(d,n)&&c.push(d),d=h.getNext();return c},e.prototype.recordContainsPath_=function(e,t){if(e.snap)return e.path.contains(t);for(var n in e.children)if(e.children.hasOwnProperty(n)&&e.path.child(n).contains(t))return!0;return!1},e.prototype.resetTree_=function(){this.visibleWrites_=e.layerTree_(this.allWrites_,e.DefaultFilter_,H.Empty),this.allWrites_.length>0?this.lastWriteId_=this.allWrites_[this.allWrites_.length-1].writeId:this.lastWriteId_=-1},e.DefaultFilter_=function(e){return e.visible},e.layerTree_=function(e,t,n){for(var r=At.Empty,i=0;i<e.length;++i){var o=e[i];if(t(o)){var a=o.path,s=void 0;if(o.snap)n.contains(a)?(s=H.relativePath(n,a),r=r.addWrite(s,o.snap)):a.contains(n)&&(s=H.relativePath(a,n),r=r.addWrite(H.Empty,o.snap.getChild(s)));else{if(!o.children)throw u.assertionError("WriteRecord should have .snap or .children");if(n.contains(a))s=H.relativePath(n,a),r=r.addWrites(s,o.children);else if(a.contains(n))if((s=H.relativePath(a,n)).isEmpty())r=r.addWrites(H.Empty,o.children);else{var c=u.safeGet(o.children,s.getFront());if(c){var l=c.getChild(s.popFront());r=r.addWrite(H.Empty,l)}}}}}return r},e}(),Lt=function(){function e(e,t){this.treePath_=e,this.writeTree_=t}return e.prototype.calcCompleteEventCache=function(e,t,n){return this.writeTree_.calcCompleteEventCache(this.treePath_,e,t,n)},e.prototype.calcCompleteEventChildren=function(e){return this.writeTree_.calcCompleteEventChildren(this.treePath_,e)},e.prototype.calcEventCacheAfterServerOverwrite=function(e,t,n){return this.writeTree_.calcEventCacheAfterServerOverwrite(this.treePath_,e,t,n)},e.prototype.shadowingWrite=function(e){return this.writeTree_.shadowingWrite(this.treePath_.child(e))},e.prototype.calcIndexedSlice=function(e,t,n,r,i){return this.writeTree_.calcIndexedSlice(this.treePath_,e,t,n,r,i)},e.prototype.calcCompleteChild=function(e,t){return this.writeTree_.calcCompleteChild(this.treePath_,e,t)},e.prototype.child=function(t){return new e(this.treePath_.child(t),this.writeTree_)},e}(),Dt=function(){function e(e){this.listenProvider_=e,this.syncPointTree_=pt.Empty,this.pendingWriteTree_=new Nt,this.tagToQueryMap=new Map,this.queryToTagMap=new Map}return e.prototype.applyUserOverwrite=function(e,t,n,r){return this.pendingWriteTree_.addOverwrite(e,t,n,r),r?this.applyOperationToSyncPoints_(new mt(lt.User,e,t)):[]},e.prototype.applyUserMerge=function(e,t,n){this.pendingWriteTree_.addMerge(e,t,n);var r=pt.fromObject(t);return this.applyOperationToSyncPoints_(new gt(lt.User,e,r))},e.prototype.ackUserWrite=function(e,t){void 0===t&&(t=!1);var n=this.pendingWriteTree_.getWrite(e);if(this.pendingWriteTree_.removeWrite(e)){var r=pt.Empty;return null!=n.snap?r=r.set(H.Empty,!0):P(n.children,(function(e,t){r=r.set(new H(e),t)})),this.applyOperationToSyncPoints_(new ht(n.path,r,t))}return[]},e.prototype.applyServerOverwrite=function(e,t){return this.applyOperationToSyncPoints_(new mt(lt.Server,e,t))},e.prototype.applyServerMerge=function(e,t){var n=pt.fromObject(t);return this.applyOperationToSyncPoints_(new gt(lt.Server,e,n))},e.prototype.applyListenComplete=function(e){return this.applyOperationToSyncPoints_(new ft(lt.Server,e))},e.prototype.applyTaggedQueryOverwrite=function(t,n,r){var i=this.queryKeyForTag_(r);if(null!=i){var o=e.parseQueryKey_(i),a=o.path,s=o.queryId,u=H.relativePath(a,t),c=new mt(lt.forServerTaggedQuery(s),u,n);return this.applyTaggedOperation_(a,c)}return[]},e.prototype.applyTaggedQueryMerge=function(t,n,r){var i=this.queryKeyForTag_(r);if(i){var o=e.parseQueryKey_(i),a=o.path,s=o.queryId,u=H.relativePath(a,t),c=pt.fromObject(n),l=new gt(lt.forServerTaggedQuery(s),u,c);return this.applyTaggedOperation_(a,l)}return[]},e.prototype.applyTaggedListenComplete=function(t,n){var r=this.queryKeyForTag_(n);if(r){var i=e.parseQueryKey_(r),o=i.path,a=i.queryId,s=H.relativePath(o,t),u=new ft(lt.forServerTaggedQuery(a),s);return this.applyTaggedOperation_(o,u)}return[]},e.prototype.addEventRegistration=function(t,n){var r=t.path,i=null,o=!1;this.syncPointTree_.foreachOnPath(r,(function(e,t){var n=H.relativePath(e,r);i=i||t.getCompleteServerCache(n),o=o||t.hasCompleteView()}));var a,s=this.syncPointTree_.get(r);(s?(o=o||s.hasCompleteView(),i=i||s.getCompleteServerCache(H.Empty)):(s=new kt,this.syncPointTree_=this.syncPointTree_.set(r,s)),null!=i)?a=!0:(a=!1,i=He.EMPTY_NODE,this.syncPointTree_.subtree(r).foreachChild((function(e,t){var n=t.getCompleteServerCache(H.Empty);n&&(i=i.updateImmediateChild(e,n))})));var c=s.viewExistsForQuery(t);if(!c&&!t.getQueryParams().loadsAllData()){var l=e.makeQueryKey_(t);u.assert(!this.queryToTagMap.has(l),"View does not exist, but we have a tag");var h=e.getNextQueryTag_();this.queryToTagMap.set(l,h),this.tagToQueryMap.set(h,l)}var d=this.pendingWriteTree_.childWrites(r),p=s.addEventRegistration(t,n,d,i,a);if(!c&&!o){var f=s.viewForQuery(t);p=p.concat(this.setupListener_(t,f))}return p},e.prototype.removeEventRegistration=function(t,n,r){var i=this,o=t.path,a=this.syncPointTree_.get(o),s=[];if(a&&("default"===t.queryIdentifier()||a.viewExistsForQuery(t))){var u=a.removeEventRegistration(t,n,r);a.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(o));var c=u.removed;s=u.events;var l=-1!==c.findIndex((function(e){return e.getQueryParams().loadsAllData()})),h=this.syncPointTree_.findOnPath(o,(function(e,t){return t.hasCompleteView()}));if(l&&!h){var d=this.syncPointTree_.subtree(o);if(!d.isEmpty())for(var p=this.collectDistinctViewsForSubTree_(d),f=0;f<p.length;++f){var m=p[f],g=m.getQuery(),v=this.createListenerForView_(m);this.listenProvider_.startListening(e.queryForListening_(g),this.tagForQuery_(g),v.hashFn,v.onComplete)}}if(!h&&c.length>0&&!r)if(l){this.listenProvider_.stopListening(e.queryForListening_(t),null)}else c.forEach((function(t){var n=i.queryToTagMap.get(e.makeQueryKey_(t));i.listenProvider_.stopListening(e.queryForListening_(t),n)}));this.removeTags_(c)}return s},e.prototype.calcCompleteEventCache=function(e,t){var n=this.pendingWriteTree_,r=this.syncPointTree_.findOnPath(e,(function(t,n){var r=H.relativePath(t,e),i=n.getCompleteServerCache(r);if(i)return i}));return n.calcCompleteEventCache(e,r,t,!0)},e.prototype.collectDistinctViewsForSubTree_=function(e){return e.fold((function(e,t,n){if(t&&t.hasCompleteView())return[t.getCompleteView()];var r=[];return t&&(r=t.getQueryViews()),P(n,(function(e,t){r=r.concat(t)})),r}))},e.prototype.removeTags_=function(t){for(var n=0;n<t.length;++n){var r=t[n];if(!r.getQueryParams().loadsAllData()){var i=e.makeQueryKey_(r),o=this.queryToTagMap.get(i);this.queryToTagMap.delete(i),this.tagToQueryMap.delete(o)}}},e.queryForListening_=function(e){return e.getQueryParams().loadsAllData()&&!e.getQueryParams().isDefault()?e.getRef():e},e.prototype.setupListener_=function(t,n){var r=t.path,i=this.tagForQuery_(t),o=this.createListenerForView_(n),a=this.listenProvider_.startListening(e.queryForListening_(t),i,o.hashFn,o.onComplete),s=this.syncPointTree_.subtree(r);if(i)u.assert(!s.value.hasCompleteView(),"If we're adding a query, it shouldn't be shadowed");else for(var c=s.fold((function(e,t,n){if(!e.isEmpty()&&t&&t.hasCompleteView())return[t.getCompleteView().getQuery()];var r=[];return t&&(r=r.concat(t.getQueryViews().map((function(e){return e.getQuery()})))),P(n,(function(e,t){r=r.concat(t)})),r})),l=0;l<c.length;++l){var h=c[l];this.listenProvider_.stopListening(e.queryForListening_(h),this.tagForQuery_(h))}return a},e.prototype.createListenerForView_=function(e){var t=this,n=e.getQuery(),r=this.tagForQuery_(n);return{hashFn:function(){return(e.getServerCache()||He.EMPTY_NODE).hash()},onComplete:function(e){if("ok"===e)return r?t.applyTaggedListenComplete(n.path,r):t.applyListenComplete(n.path);var i=function(e,t){var n="Unknown Error";"too_big"===e?n="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"==e?n="Client doesn't have permission to access the desired data.":"unavailable"==e&&(n="The service is unavailable");var r=new Error(e+" at "+t.path.toString()+": "+n);return r.code=e.toUpperCase(),r}(e,n);return t.removeEventRegistration(n,null,i)}}},e.makeQueryKey_=function(e){return e.path.toString()+"$"+e.queryIdentifier()},e.parseQueryKey_=function(e){var t=e.indexOf("$");return u.assert(-1!==t&&t<e.length-1,"Bad queryKey."),{queryId:e.substr(t+1),path:new H(e.substr(0,t))}},e.prototype.queryKeyForTag_=function(e){return this.tagToQueryMap.get(e)},e.prototype.tagForQuery_=function(t){var n=e.makeQueryKey_(t);return this.queryToTagMap.get(n)},e.getNextQueryTag_=function(){return e.nextQueryTag_++},e.prototype.applyTaggedOperation_=function(e,t){var n=this.syncPointTree_.get(e);u.assert(n,"Missing sync point for query tag that we're tracking");var r=this.pendingWriteTree_.childWrites(e);return n.applyOperation(t,r,null)},e.prototype.applyOperationToSyncPoints_=function(e){return this.applyOperationHelper_(e,this.syncPointTree_,null,this.pendingWriteTree_.childWrites(H.Empty))},e.prototype.applyOperationHelper_=function(e,t,n,r){if(e.path.isEmpty())return this.applyOperationDescendantsHelper_(e,t,n,r);var i=t.get(H.Empty);null==n&&null!=i&&(n=i.getCompleteServerCache(H.Empty));var o=[],a=e.path.getFront(),s=e.operationForChild(a),u=t.children.get(a);if(u&&s){var c=n?n.getImmediateChild(a):null,l=r.child(a);o=o.concat(this.applyOperationHelper_(s,u,c,l))}return i&&(o=o.concat(i.applyOperation(e,r,n))),o},e.prototype.applyOperationDescendantsHelper_=function(e,t,n,r){var i=this,o=t.get(H.Empty);null==n&&null!=o&&(n=o.getCompleteServerCache(H.Empty));var a=[];return t.children.inorderTraversal((function(t,o){var s=n?n.getImmediateChild(t):null,u=r.child(t),c=e.operationForChild(t);c&&(a=a.concat(i.applyOperationDescendantsHelper_(c,o,s,u)))})),o&&(a=a.concat(o.applyOperation(e,r,n))),a},e.nextQueryTag_=1,e}(),Ot=function(){function e(){this.rootNode_=He.EMPTY_NODE}return e.prototype.getNode=function(e){return this.rootNode_.getChild(e)},e.prototype.updateSnapshot=function(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)},e}(),Mt=function(){function e(e,t){var n=this;this.app_=e,this.authProvider_=t,this.auth_=null,this.auth_=t.getImmediate({optional:!0}),this.auth_||t.get().then((function(e){return n.auth_=e}))}return e.prototype.getToken=function(e){return this.auth_?this.auth_.getToken(e).catch((function(e){return e&&"auth/token-not-initialized"===e.code?(T("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(e)})):Promise.resolve(null)},e.prototype.addTokenChangeListener=function(e){this.auth_?this.auth_.addAuthTokenListener(e):(setTimeout((function(){return e(null)}),0),this.authProvider_.get().then((function(t){return t.addAuthTokenListener(e)})))},e.prototype.removeTokenChangeListener=function(e){this.authProvider_.get().then((function(t){return t.removeAuthTokenListener(e)}))},e.prototype.notifyForInvalidToken=function(){var e='Provided authentication credentials for the app named "'+this.app_.name+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.app_.options?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.app_.options?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',I(e)},e}(),Rt=function(){function e(){this.counters_={}}return e.prototype.incrementCounter=function(e,t){void 0===t&&(t=1),u.contains(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t},e.prototype.get=function(){return u.deepCopy(this.counters_)},e}(),Pt=function(){function e(){}return e.getCollection=function(e){var t=e.toString();return this.collections_[t]||(this.collections_[t]=new Rt),this.collections_[t]},e.getOrCreateReporter=function(e,t){var n=e.toString();return this.reporters_[n]||(this.reporters_[n]=t()),this.reporters_[n]},e.collections_={},e.reporters_={},e}(),Ft=function(){function e(e){this.collection_=e,this.last_=null}return e.prototype.get=function(){var e=this.collection_.get(),t=s.__assign({},e);return this.last_&&P(this.last_,(function(e,n){t[e]=t[e]-n})),this.last_=e,t},e}(),jt=1e4,Bt=3e4,Vt=function(){function e(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Ft(e);var n=jt+(Bt-jt)*Math.random();U(this.reportStats_.bind(this),Math.floor(n))}return e.prototype.includeStat=function(e){this.statsToReport_[e]=!0},e.prototype.reportStats_=function(){var e=this,t=this.statsListener_.get(),n={},r=!1;P(t,(function(t,i){i>0&&u.contains(e.statsToReport_,t)&&(n[t]=i,r=!0)})),r&&this.server_.reportStats(n),U(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},e}(),Wt=function(){function e(){this.eventLists_=[],this.recursionDepth_=0}return e.prototype.queueEvents=function(e){for(var t=null,n=0;n<e.length;n++){var r=e[n],i=r.getPath();null===t||i.equals(t.getPath())||(this.eventLists_.push(t),t=null),null===t&&(t=new Ut(i)),t.add(r)}t&&this.eventLists_.push(t)},e.prototype.raiseEventsAtPath=function(e,t){this.queueEvents(t),this.raiseQueuedEventsMatchingPredicate_((function(t){return t.equals(e)}))},e.prototype.raiseEventsForChangedPath=function(e,t){this.queueEvents(t),this.raiseQueuedEventsMatchingPredicate_((function(t){return t.contains(e)||e.contains(t)}))},e.prototype.raiseQueuedEventsMatchingPredicate_=function(e){this.recursionDepth_++;for(var t=!0,n=0;n<this.eventLists_.length;n++){var r=this.eventLists_[n];if(r)e(r.getPath())?(this.eventLists_[n].raise(),this.eventLists_[n]=null):t=!1}t&&(this.eventLists_=[]),this.recursionDepth_--},e}(),Ut=function(){function e(e){this.path_=e,this.events_=[]}return e.prototype.add=function(e){this.events_.push(e)},e.prototype.raise=function(){for(var e=0;e<this.events_.length;e++){var t=this.events_[e];if(null!==t){this.events_[e]=null;var n=t.getEventRunner();w&&T("event: "+t.toString()),V(n)}}},e.prototype.getPath=function(){return this.path_},e}(),Ht=function(){function e(e){this.allowedEvents_=e,this.listeners_={},u.assert(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}return e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(Array.isArray(this.listeners_[e]))for(var r=s.__spread(this.listeners_[e]),i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)},e.prototype.on=function(e,t,n){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:n});var r=this.getInitialEvent(e);r&&t.apply(n,r)},e.prototype.off=function(e,t,n){this.validateEventType_(e);for(var r=this.listeners_[e]||[],i=0;i<r.length;i++)if(r[i].callback===t&&(!n||n===r[i].context))return void r.splice(i,1)},e.prototype.validateEventType_=function(e){u.assert(this.allowedEvents_.find((function(t){return t===e})),"Unknown event: "+e)},e}(),zt=function(e){function t(){var t,n,r=e.call(this,["visible"])||this;return"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(n="visibilitychange",t="hidden"):void 0!==document.mozHidden?(n="mozvisibilitychange",t="mozHidden"):void 0!==document.msHidden?(n="msvisibilitychange",t="msHidden"):void 0!==document.webkitHidden&&(n="webkitvisibilitychange",t="webkitHidden")),r.visible_=!0,n&&document.addEventListener(n,(function(){var e=!document[t];e!==r.visible_&&(r.visible_=e,r.trigger("visible",e))}),!1),r}return s.__extends(t,e),t.getInstance=function(){return new t},t.prototype.getInitialEvent=function(e){return u.assert("visible"===e,"Unknown event type: "+e),[this.visible_]},t}(Ht),qt=function(e){function t(){var t=e.call(this,["online"])||this;return t.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||u.isMobileCordova()||(window.addEventListener("online",(function(){t.online_||(t.online_=!0,t.trigger("online",!0))}),!1),window.addEventListener("offline",(function(){t.online_&&(t.online_=!1,t.trigger("online",!1))}),!1)),t}return s.__extends(t,e),t.getInstance=function(){return new t},t.prototype.getInitialEvent=function(e){return u.assert("online"===e,"Unknown event type: "+e),[this.online_]},t.prototype.currentlyOnline=function(){return this.online_},t}(Ht),Kt=function(){function e(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}return e.prototype.closeAfter=function(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},e.prototype.handleResponse=function(e,t){var n=this;this.pendingResponses[e]=t;for(var r=function(){var e=i.pendingResponses[i.currentResponseNum];delete i.pendingResponses[i.currentResponseNum];for(var t=function(t){e[t]&&V((function(){n.onMessage_(e[t])}))},r=0;r<e.length;++r)t(r);if(i.currentResponseNum===i.closeAfterResponse)return i.onClose&&(i.onClose(),i.onClose=null),"break";i.currentResponseNum++},i=this;this.pendingResponses[this.currentResponseNum];){if("break"===r())break}},e}(),Gt="pLPCommand",Qt="pRTLPCB",$t=function(){function e(e,t,n,r){this.connId=e,this.repoInfo=t,this.transportSessionId=n,this.lastSessionId=r,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=S(e),this.stats_=Pt.getCollection(t),this.urlFn=function(e){return t.connectionURL(q,e)}}return e.prototype.open=function(e,t){var n=this;this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Kt(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout((function(){n.log_("Timed out trying to connect."),n.onClosed_(),n.connectTimeoutTimer_=null}),Math.floor(3e4)),function(e){if(u.isNodeSdk()||"complete"===document.readyState)e();else{var t=!1,n=function n(){document.body?t||(t=!0,e()):setTimeout(n,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",(function(){"complete"===document.readyState&&n()})),window.attachEvent("onload",n))}}((function(){if(!n.isClosed_){n.scriptTagHolder=new Yt((function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=s.__read(e,5),i=r[0],o=r[1],a=r[2];r[3],r[4];if(n.incrementIncomingBytes_(e),n.scriptTagHolder)if(n.connectTimeoutTimer_&&(clearTimeout(n.connectTimeoutTimer_),n.connectTimeoutTimer_=null),n.everConnected_=!0,"start"==i)n.id=o,n.password=a;else{if("close"!==i)throw new Error("Unrecognized command received: "+i);o?(n.scriptTagHolder.sendNewPolls=!1,n.myPacketOrderer.closeAfter(o,(function(){n.onClosed_()}))):n.onClosed_()}}),(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=s.__read(e,2),i=r[0],o=r[1];n.incrementIncomingBytes_(e),n.myPacketOrderer.handleResponse(i,o)}),(function(){n.onClosed_()}),n.urlFn);var e={start:"t"};e.ser=Math.floor(1e8*Math.random()),n.scriptTagHolder.uniqueCallbackIdentifier&&(e.cb=n.scriptTagHolder.uniqueCallbackIdentifier),e.v="5",n.transportSessionId&&(e.s=n.transportSessionId),n.lastSessionId&&(e.ls=n.lastSessionId),"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(e.r="f");var t=n.urlFn(e);n.log_("Connecting via long-poll to "+t),n.scriptTagHolder.addTag(t,(function(){}))}}))},e.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},e.forceAllow=function(){e.forceAllow_=!0},e.forceDisallow=function(){e.forceDisallow_=!0},e.isAvailable=function(){return!u.isNodeSdk()&&(!!e.forceAllow_||!(e.forceDisallow_||"undefined"==typeof document||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI))},e.prototype.markConnectionHealthy=function(){},e.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},e.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},e.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},e.prototype.send=function(e){var t=u.stringify(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);for(var n=u.base64Encode(t),r=R(n,1840),i=0;i<r.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,r.length,r[i]),this.curSegmentNum++},e.prototype.addDisconnectPingFrame=function(e,t){if(!u.isNodeSdk()){this.myDisconnFrame=document.createElement("iframe");var n={dframe:"t"};n.id=e,n.pw=t,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}},e.prototype.incrementIncomingBytes_=function(e){var t=u.stringify(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)},e}(),Yt=function(){function e(t,n,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,u.isNodeSdk())this.commandCB=t,this.onMessageCB=n;else{this.uniqueCallbackIdentifier=v(),window[Gt+this.uniqueCallbackIdentifier]=t,window[Qt+this.uniqueCallbackIdentifier]=n,this.myIFrame=e.createIFrame_();var o="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length))o='<script>document.domain="'+document.domain+'";<\/script>';var a="<html><body>"+o+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(a),this.myIFrame.doc.close()}catch(s){T("frame writing exception"),s.stack&&T(s.stack),T(s)}}}return e.createIFrame_=function(){var e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{e.contentWindow.document||T("No IE domain setting required")}catch(n){var t=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+t+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e},e.prototype.close=function(){var e=this;this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout((function(){null!==e.myIFrame&&(document.body.removeChild(e.myIFrame),e.myIFrame=null)}),Math.floor(0)));var t=this.onDisconnect;t&&(this.onDisconnect=null,t())},e.prototype.startLongPoll=function(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););},e.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;var e={};e.id=this.myID,e.pw=this.myPW,e.ser=this.currentSerial;for(var t=this.urlFn(e),n="",r=0;this.pendingSegs.length>0;){if(!(this.pendingSegs[0].d.length+30+n.length<=1870))break;var i=this.pendingSegs.shift();n=n+"&seg"+r+"="+i.seg+"&ts"+r+"="+i.ts+"&d"+r+"="+i.d,r++}return t+=n,this.addLongPollTag_(t,this.currentSerial),!0}return!1},e.prototype.enqueueSegment=function(e,t,n){this.pendingSegs.push({seg:e,ts:t,d:n}),this.alive&&this.newRequest_()},e.prototype.addLongPollTag_=function(e,t){var n=this;this.outstandingRequests.add(t);var r=function(){n.outstandingRequests.delete(t),n.newRequest_()},i=setTimeout(r,Math.floor(25e3));this.addTag(e,(function(){clearTimeout(i),r()}))},e.prototype.addTag=function(e,t){var n=this;u.isNodeSdk()?this.doNodeLongPoll(e,t):setTimeout((function(){try{if(!n.sendNewPolls)return;var r=n.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){var e=r.readyState;e&&"loaded"!==e&&"complete"!==e||(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=function(){T("Long-poll script failed to load: "+e),n.sendNewPolls=!1,n.close()},n.myIFrame.doc.body.appendChild(r)}catch(i){}}),Math.floor(1))},e}(),Xt="";var Jt=null;"undefined"!=typeof MozWebSocket?Jt=MozWebSocket:"undefined"!=typeof WebSocket&&(Jt=WebSocket);var Zt=function(){function e(t,n,r,i){this.connId=t,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=S(this.connId),this.stats_=Pt.getCollection(n),this.connURL=e.connectionURL_(n,r,i)}return e.connectionURL_=function(e,t,n){var r={v:"5"};return!u.isNodeSdk()&&"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(r.r="f"),t&&(r.s=t),n&&(r.ls=n),e.connectionURL("websocket",r)},e.prototype.open=function(e,t){var n=this;this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,f.set("previous_websocket_failure",!0);try{if(u.isNodeSdk()){var i=u.CONSTANTS.NODE_ADMIN?"AdminNode":"Node",o={headers:{"User-Agent":"Firebase/5/"+Xt+"/"+r.platform+"/"+i}},a={},s=0==this.connURL.indexOf("wss://")?a.HTTPS_PROXY||a.https_proxy:a.HTTP_PROXY||a.http_proxy;s&&(o.proxy={origin:s}),this.mySock=new Jt(this.connURL,[],o)}else this.mySock=new Jt(this.connURL)}catch(l){this.log_("Error instantiating WebSocket.");var c=l.message||l.data;return c&&this.log_(c),void this.onClosed_()}this.mySock.onopen=function(){n.log_("Websocket connected."),n.everConnected_=!0},this.mySock.onclose=function(){n.log_("Websocket connection was disconnected."),n.mySock=null,n.onClosed_()},this.mySock.onmessage=function(e){n.handleIncomingFrame(e)},this.mySock.onerror=function(e){n.log_("WebSocket error.  Closing connection.");var t=e.message||e.data;t&&n.log_(t),n.onClosed_()}},e.prototype.start=function(){},e.forceDisallow=function(){e.forceDisallow_=!0},e.isAvailable=function(){var t=!1;if("undefined"!=typeof navigator&&navigator.userAgent){var n=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);n&&n.length>1&&parseFloat(n[1])<4.4&&(t=!0)}return!t&&null!==Jt&&!e.forceDisallow_},e.previouslyFailed=function(){return f.isInMemoryStorage||!0===f.get("previous_websocket_failure")},e.prototype.markConnectionHealthy=function(){f.remove("previous_websocket_failure")},e.prototype.appendFrame_=function(e){if(this.frames.push(e),this.frames.length==this.totalFrames){var t=this.frames.join("");this.frames=null;var n=u.jsonEval(t);this.onMessage(n)}},e.prototype.handleNewFrameCount_=function(e){this.totalFrames=e,this.frames=[]},e.prototype.extractFrameCount_=function(e){if(u.assert(null===this.frames,"We already have a frame buffer"),e.length<=6){var t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e},e.prototype.handleIncomingFrame=function(e){if(null!==this.mySock){var t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(t);else{var n=this.extractFrameCount_(t);null!==n&&this.appendFrame_(n)}}},e.prototype.send=function(e){this.resetKeepAlive();var t=u.stringify(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);var n=R(t,16384);n.length>1&&this.sendString_(String(n.length));for(var r=0;r<n.length;r++)this.sendString_(n[r])},e.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},e.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},e.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},e.prototype.resetKeepAlive=function(){var e=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval((function(){e.mySock&&e.sendString_("0"),e.resetKeepAlive()}),Math.floor(45e3))},e.prototype.sendString_=function(e){try{this.mySock.send(e)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},e.responsesRequiredToBeHealthy=2,e.healthyTimeout=3e4,e}(),en=function(){function e(e){this.initTransports_(e)}return Object.defineProperty(e,"ALL_TRANSPORTS",{get:function(){return[$t,Zt]},enumerable:!0,configurable:!0}),e.prototype.initTransports_=function(t){var n,r,i=Zt&&Zt.isAvailable(),o=i&&!Zt.previouslyFailed();if(t.webSocketOnly&&(i||I("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),o=!0),o)this.transports_=[Zt];else{var a=this.transports_=[];try{for(var u=s.__values(e.ALL_TRANSPORTS),c=u.next();!c.done;c=u.next()){var l=c.value;l&&l.isAvailable()&&a.push(l)}}catch(h){n={error:h}}finally{try{c&&!c.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}}},e.prototype.initialTransport=function(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")},e.prototype.upgradeTransport=function(){return this.transports_.length>1?this.transports_[1]:null},e}(),tn=function(){function e(e,t,n,r,i,o,a){this.id=e,this.repoInfo_=t,this.onMessage_=n,this.onReady_=r,this.onDisconnect_=i,this.onKill_=o,this.lastSessionId=a,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=S("c:"+this.id+":"),this.transportManager_=new en(t),this.log_("Connection created"),this.start_()}return e.prototype.start_=function(){var e=this,t=this.transportManager_.initialTransport();this.conn_=new t(this.nextTransportId_(),this.repoInfo_,void 0,this.lastSessionId),this.primaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout((function(){e.conn_&&e.conn_.open(n,r)}),Math.floor(0));var i=t.healthyTimeout||0;i>0&&(this.healthyTimeout_=U((function(){e.healthyTimeout_=null,e.isHealthy_||(e.conn_&&e.conn_.bytesReceived>102400?(e.log_("Connection exceeded healthy timeout but has received "+e.conn_.bytesReceived+" bytes.  Marking connection healthy."),e.isHealthy_=!0,e.conn_.markConnectionHealthy()):e.conn_&&e.conn_.bytesSent>10240?e.log_("Connection exceeded healthy timeout but has sent "+e.conn_.bytesSent+" bytes.  Leaving connection alive."):(e.log_("Closing unhealthy connection after timeout."),e.close()))}),Math.floor(i)))},e.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},e.prototype.disconnReceiver_=function(e){var t=this;return function(n){e===t.conn_?t.onConnectionLost_(n):e===t.secondaryConn_?(t.log_("Secondary connection lost."),t.onSecondaryConnectionLost_()):t.log_("closing an old connection")}},e.prototype.connReceiver_=function(e){var t=this;return function(n){2!=t.state_&&(e===t.rx_?t.onPrimaryMessageReceived_(n):e===t.secondaryConn_?t.onSecondaryMessageReceived_(n):t.log_("message on old connection"))}},e.prototype.sendRequest=function(e){var t={t:"d",d:e};this.sendData_(t)},e.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},e.prototype.onSecondaryControl_=function(e){if("t"in e){var t=e.t;"a"===t?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}},e.prototype.onSecondaryMessageReceived_=function(e){var t=O("t",e),n=O("d",e);if("c"==t)this.onSecondaryControl_(n);else{if("d"!=t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(n)}},e.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},e.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},e.prototype.onPrimaryMessageReceived_=function(e){var t=O("t",e),n=O("d",e);"c"==t?this.onControl_(n):"d"==t&&this.onDataMessage_(n)},e.prototype.onDataMessage_=function(e){this.onPrimaryResponse_(),this.onMessage_(e)},e.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},e.prototype.onControl_=function(e){var t=O("t",e);if("d"in e){var n=e.d;if("h"===t)this.onHandshake_(n);else if("n"===t){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var r=0;r<this.pendingDataMessages.length;++r)this.onDataMessage_(this.pendingDataMessages[r]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===t?this.onConnectionShutdown_(n):"r"===t?this.onReset_(n):"e"===t?E("Server Error: "+n):"o"===t?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):E("Unknown control packet command: "+t)}},e.prototype.onHandshake_=function(e){var t=e.ts,n=e.v,r=e.h;this.sessionId=e.s,this.repoInfo_.updateHost(r),0==this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),"5"!==n&&I("Protocol version mismatch detected"),this.tryStartUpgrade_())},e.prototype.tryStartUpgrade_=function(){var e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)},e.prototype.startUpgrade_=function(e){var t=this;this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,r),U((function(){t.secondaryConn_&&(t.log_("Timed out trying to upgrade."),t.secondaryConn_.close())}),Math.floor(6e4))},e.prototype.onReset_=function(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.updateHost(e),1===this.state_?this.close():(this.closeConnections_(),this.start_())},e.prototype.onConnectionEstablished_=function(e,t){var n=this;this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):U((function(){n.sendPingOnPrimaryIfNecessary_()}),Math.floor(5e3))},e.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},e.prototype.onSecondaryConnectionLost_=function(){var e=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==e&&this.rx_!==e||this.close()},e.prototype.onConnectionLost_=function(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(f.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},e.prototype.onConnectionShutdown_=function(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()},e.prototype.sendData_=function(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)},e.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},e.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},e}(),nn=function(){function e(){}return e.prototype.put=function(e,t,n,r){},e.prototype.merge=function(e,t,n,r){},e.prototype.refreshAuthToken=function(e){},e.prototype.onDisconnectPut=function(e,t,n){},e.prototype.onDisconnectMerge=function(e,t,n){},e.prototype.onDisconnectCancel=function(e,t){},e.prototype.reportStats=function(e){},e}(),rn=1e3,on=3e5,an=function(e){function t(n,r,i,o,a,s){var c=e.call(this)||this;if(c.repoInfo_=n,c.onDataUpdate_=r,c.onConnectStatus_=i,c.onServerInfoUpdate_=o,c.authTokenProvider_=a,c.authOverride_=s,c.id=t.nextPersistentConnectionId_++,c.log_=S("p:"+c.id+":"),c.interruptReasons_={},c.listens=new Map,c.outstandingPuts_=[],c.outstandingPutCount_=0,c.onDisconnectRequestQueue_=[],c.connected_=!1,c.reconnectDelay_=rn,c.maxReconnectDelay_=on,c.securityDebugCallback_=null,c.lastSessionId=null,c.establishConnectionTimer_=null,c.visible_=!1,c.requestCBHash_={},c.requestNumber_=0,c.realtime_=null,c.authToken_=null,c.forceTokenRefresh_=!1,c.invalidAuthTokenCount_=0,c.firstConnection_=!0,c.lastConnectionAttemptTime_=null,c.lastConnectionEstablishedTime_=null,s&&!u.isNodeSdk())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return c.scheduleConnect_(0),zt.getInstance().on("visible",c.onVisible_,c),-1===n.host.indexOf("fblocal")&&qt.getInstance().on("online",c.onOnline_,c),c}return s.__extends(t,e),t.prototype.sendRequest=function(e,t,n){var r=++this.requestNumber_,i={r:r,a:e,b:t};this.log_(u.stringify(i)),u.assert(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(i),n&&(this.requestCBHash_[r]=n)},t.prototype.listen=function(e,t,n,r){var i=e.queryIdentifier(),o=e.path.toString();this.log_("Listen called for "+o+" "+i),this.listens.has(o)||this.listens.set(o,new Map),u.assert(e.getQueryParams().isDefault()||!e.getQueryParams().loadsAllData(),"listen() called for non-default but complete query"),u.assert(!this.listens.get(o).has(i),"listen() called twice for same path/queryId.");var a={onComplete:r,hashFn:t,query:e,tag:n};this.listens.get(o).set(i,a),this.connected_&&this.sendListen_(a)},t.prototype.sendListen_=function(e){var n=this,r=e.query,i=r.path.toString(),o=r.queryIdentifier();this.log_("Listen on "+i+" for "+o);var a={p:i};e.tag&&(a.q=r.queryObject(),a.t=e.tag),a.h=e.hashFn(),this.sendRequest("q",a,(function(a){var s=a.d,u=a.s;t.warnOnListenWarnings_(s,r),(n.listens.get(i)&&n.listens.get(i).get(o))===e&&(n.log_("listen response",a),"ok"!==u&&n.removeListen_(i,o),e.onComplete&&e.onComplete(u,s))}))},t.warnOnListenWarnings_=function(e,t){if(e&&"object"==typeof e&&u.contains(e,"w")){var n=u.safeGet(e,"w");if(Array.isArray(n)&&~n.indexOf("no_index")){var r='".indexOn": "'+t.getQueryParams().getIndex().toString()+'"',i=t.path.toString();I("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+r+" at "+i+" to your security rules for better performance.")}}},t.prototype.refreshAuthToken=function(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},(function(){})),this.reduceReconnectDelayIfAdminCredential_(e)},t.prototype.reduceReconnectDelayIfAdminCredential_=function(e){(e&&40===e.length||u.isAdmin(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},t.prototype.tryAuth=function(){var e=this;if(this.connected_&&this.authToken_){var t=this.authToken_,n=u.isValidFormat(t)?"auth":"gauth",r={cred:t};null===this.authOverride_?r.noauth=!0:"object"==typeof this.authOverride_&&(r.authvar=this.authOverride_),this.sendRequest(n,r,(function(n){var r=n.s,i=n.d||"error";e.authToken_===t&&("ok"===r?e.invalidAuthTokenCount_=0:e.onAuthRevoked_(r,i))}))}},t.prototype.unlisten=function(e,t){var n=e.path.toString(),r=e.queryIdentifier();this.log_("Unlisten called for "+n+" "+r),u.assert(e.getQueryParams().isDefault()||!e.getQueryParams().loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(n,r)&&this.connected_&&this.sendUnlisten_(n,r,e.queryObject(),t)},t.prototype.sendUnlisten_=function(e,t,n,r){this.log_("Unlisten on "+e+" for "+t);var i={p:e};r&&(i.q=n,i.t=r),this.sendRequest("n",i)},t.prototype.onDisconnectPut=function(e,t,n){this.connected_?this.sendOnDisconnect_("o",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:n})},t.prototype.onDisconnectMerge=function(e,t,n){this.connected_?this.sendOnDisconnect_("om",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:n})},t.prototype.onDisconnectCancel=function(e,t){this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})},t.prototype.sendOnDisconnect_=function(e,t,n,r){var i={p:t,d:n};this.log_("onDisconnect "+e,i),this.sendRequest(e,i,(function(e){r&&setTimeout((function(){r(e.s,e.d)}),Math.floor(0))}))},t.prototype.put=function(e,t,n,r){this.putInternal("p",e,t,n,r)},t.prototype.merge=function(e,t,n,r){this.putInternal("m",e,t,n,r)},t.prototype.putInternal=function(e,t,n,r,i){var o={p:t,d:n};void 0!==i&&(o.h=i),this.outstandingPuts_.push({action:e,request:o,onComplete:r}),this.outstandingPutCount_++;var a=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(a):this.log_("Buffering put: "+t)},t.prototype.sendPut_=function(e){var t=this,n=this.outstandingPuts_[e].action,r=this.outstandingPuts_[e].request,i=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(n,r,(function(r){t.log_(n+" response",r),delete t.outstandingPuts_[e],t.outstandingPutCount_--,0===t.outstandingPutCount_&&(t.outstandingPuts_=[]),i&&i(r.s,r.d)}))},t.prototype.reportStats=function(e){var t=this;if(this.connected_){var n={c:e};this.log_("reportStats",n),this.sendRequest("s",n,(function(e){if("ok"!==e.s){var n=e.d;t.log_("reportStats","Error sending stats: "+n)}}))}},t.prototype.onDataMessage_=function(e){if("r"in e){this.log_("from server: "+u.stringify(e));var t=e.r,n=this.requestCBHash_[t];n&&(delete this.requestCBHash_[t],n(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}},t.prototype.onDataPush_=function(e,t){this.log_("handleServerMessage",e,t),"d"===e?this.onDataUpdate_(t.p,t.d,!1,t.t):"m"===e?this.onDataUpdate_(t.p,t.d,!0,t.t):"c"===e?this.onListenRevoked_(t.p,t.q):"ac"===e?this.onAuthRevoked_(t.s,t.d):"sd"===e?this.onSecurityDebugPacket_(t):E("Unrecognized action received from server: "+u.stringify(e)+"\nAre you using the latest client?")},t.prototype.onReady_=function(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},t.prototype.scheduleConnect_=function(e){var t=this;u.assert(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout((function(){t.establishConnectionTimer_=null,t.establishConnection_()}),Math.floor(e))},t.prototype.onVisible_=function(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=rn,this.realtime_||this.scheduleConnect_(0)),this.visible_=e},t.prototype.onOnline_=function(e){e?(this.log_("Browser went online."),this.reconnectDelay_=rn,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},t.prototype.onRealtimeDisconnect_=function(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=rn),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();var e=(new Date).getTime()-this.lastConnectionAttemptTime_,t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)},t.prototype.establishConnection_=function(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;var e=this.onDataMessage_.bind(this),n=this.onReady_.bind(this),r=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+t.nextConnectionId_++,o=this,a=this.lastSessionId,s=!1,c=null,l=function(){c?c.close():(s=!0,r())};this.realtime_={close:l,sendRequest:function(e){u.assert(c,"sendRequest call when we're not connected not allowed."),c.sendRequest(e)}};var h=this.forceTokenRefresh_;this.forceTokenRefresh_=!1,this.authTokenProvider_.getToken(h).then((function(t){s?T("getToken() completed but was canceled"):(T("getToken() completed. Creating connection."),o.authToken_=t&&t.accessToken,c=new tn(i,o.repoInfo_,e,n,r,(function(e){I(e+" ("+o.repoInfo_.toString()+")"),o.interrupt("server_kill")}),a))})).then(null,(function(e){o.log_("Failed to get token: "+e),s||(u.CONSTANTS.NODE_ADMIN&&I(e),l())}))}},t.prototype.interrupt=function(e){T("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},t.prototype.resume=function(e){T("Resuming connection for reason: "+e),delete this.interruptReasons_[e],u.isEmpty(this.interruptReasons_)&&(this.reconnectDelay_=rn,this.realtime_||this.scheduleConnect_(0))},t.prototype.handleTimestamp_=function(e){var t=e-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:t})},t.prototype.cancelSentTransactions_=function(){for(var e=0;e<this.outstandingPuts_.length;e++){var t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},t.prototype.onListenRevoked_=function(e,t){var n;n=t?t.map((function(e){return M(e)})).join("$"):"default";var r=this.removeListen_(e,n);r&&r.onComplete&&r.onComplete("permission_denied")},t.prototype.removeListen_=function(e,t){var n,r=new H(e).toString();if(this.listens.has(r)){var i=this.listens.get(r);n=i.get(t),i.delete(t),0===i.size&&this.listens.delete(r)}else n=void 0;return n},t.prototype.onAuthRevoked_=function(e,t){T("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},t.prototype.onSecurityDebugPacket_=function(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace("\n","\nFIREBASE: "))},t.prototype.restoreState_=function(){var e,t,n,r;this.tryAuth();try{for(var i=s.__values(this.listens.values()),o=i.next();!o.done;o=i.next()){var a=o.value;try{for(var u=(n=void 0,s.__values(a.values())),c=u.next();!c.done;c=u.next()){var l=c.value;this.sendListen_(l)}}catch(p){n={error:p}}finally{try{c&&!c.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}}}catch(f){e={error:f}}finally{try{o&&!o.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}for(var h=0;h<this.outstandingPuts_.length;h++)this.outstandingPuts_[h]&&this.sendPut_(h);for(;this.onDisconnectRequestQueue_.length;){var d=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(d.action,d.pathString,d.data,d.onComplete)}},t.prototype.sendConnectStats_=function(){var e={},t="js";u.CONSTANTS.NODE_ADMIN?t="admin_node":u.CONSTANTS.NODE_CLIENT&&(t="node"),e["sdk."+t+"."+Xt.replace(/\./g,"-")]=1,u.isMobileCordova()?e["framework.cordova"]=1:u.isReactNative()&&(e["framework.reactnative"]=1),this.reportStats(e)},t.prototype.shouldReconnect_=function(){var e=qt.getInstance().currentlyOnline();return u.isEmpty(this.interruptReasons_)&&e},t.nextPersistentConnectionId_=0,t.nextConnectionId_=0,t}(nn),sn=function(e){function t(t,n,r){var i=e.call(this)||this;return i.repoInfo_=t,i.onDataUpdate_=n,i.authTokenProvider_=r,i.log_=S("p:rest:"),i.listens_={},i}return s.__extends(t,e),t.prototype.reportStats=function(e){throw new Error("Method not implemented.")},t.getListenId_=function(e,t){return void 0!==t?"tag$"+t:(u.assert(e.getQueryParams().isDefault(),"should have a tag if it's not a default query."),e.path.toString())},t.prototype.listen=function(e,n,r,i){var o=this,a=e.path.toString();this.log_("Listen called for "+a+" "+e.queryIdentifier());var s=t.getListenId_(e,r),c={};this.listens_[s]=c;var l=e.getQueryParams().toRestQueryStringParameters();this.restRequest_(a+".json",l,(function(e,t){var n=t;(404===e&&(n=null,e=null),null===e&&o.onDataUpdate_(a,n,!1,r),u.safeGet(o.listens_,s)===c)&&i(e?401==e?"permission_denied":"rest_error:"+e:"ok",null)}))},t.prototype.unlisten=function(e,n){var r=t.getListenId_(e,n);delete this.listens_[r]},t.prototype.refreshAuthToken=function(e){},t.prototype.restRequest_=function(e,t,n){var r=this;void 0===t&&(t={}),t.format="export",this.authTokenProvider_.getToken(!1).then((function(i){var o=i&&i.accessToken;o&&(t.auth=o);var a=(r.repoInfo_.secure?"https://":"http://")+r.repoInfo_.host+e+"?ns="+r.repoInfo_.namespace+u.querystring(t);r.log_("Sending REST request for "+a);var s=new XMLHttpRequest;s.onreadystatechange=function(){if(n&&4===s.readyState){r.log_("REST Response for "+a+" received. status:",s.status,"response:",s.responseText);var e=null;if(s.status>=200&&s.status<300){try{e=u.jsonEval(s.responseText)}catch(t){I("Failed to parse JSON response for "+a+": "+s.responseText)}n(null,e)}else 401!==s.status&&404!==s.status&&I("Got unsuccessful REST response for "+a+" Status: "+s.status),n(s.status);n=null}},s.open("GET",a,!0),s.send()}))},t}(nn),un=function(){function e(e,t,n,r){var i=this;this.repoInfo_=e,this.app=n,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Wt,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=new rt,this.persistentConnection_=null;var o=new Mt(n,r);if(this.stats_=Pt.getCollection(e),t||W())this.server_=new sn(this.repoInfo_,this.onDataUpdate_.bind(this),o),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{var a=n.options.databaseAuthVariableOverride;if(null!=a){if("object"!=typeof a)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{u.stringify(a)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}this.persistentConnection_=new an(this.repoInfo_,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),o,a),this.server_=this.persistentConnection_}o.addTokenChangeListener((function(e){i.server_.refreshAuthToken(e)})),this.statsReporter_=Pt.getOrCreateReporter(e,(function(){return new Vt(i.stats_,i.server_)})),this.transactions_init_(),this.infoData_=new Ot,this.infoSyncTree_=new Dt({startListening:function(e,t,n,r){var o=[],a=i.infoData_.getNode(e.path);return a.isEmpty()||(o=i.infoSyncTree_.applyServerOverwrite(e.path,a),setTimeout((function(){r("ok")}),0)),o},stopListening:function(){}}),this.updateInfo_("connected",!1),this.serverSyncTree_=new Dt({startListening:function(e,t,n,r){return i.server_.listen(e,n,t,(function(t,n){var o=r(t,n);i.eventQueue_.raiseEventsForChangedPath(e.path,o)})),[]},stopListening:function(e,t){i.server_.unlisten(e,t)}})}return e.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},e.prototype.name=function(){return this.repoInfo_.namespace},e.prototype.serverTime=function(){var e=this.infoData_.getNode(new H(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+e},e.prototype.generateServerValues=function(){return(e=(e={timestamp:this.serverTime()})||{}).timestamp=e.timestamp||(new Date).getTime(),e;var e},e.prototype.onDataUpdate_=function(e,t,n,r){this.dataUpdateCount++;var i=new H(e);t=this.interceptServerDataCallback_?this.interceptServerDataCallback_(e,t):t;var o=[];if(r)if(n){var a=u.map(t,(function(e){return Ke(e)}));o=this.serverSyncTree_.applyTaggedQueryMerge(i,a,r)}else{var s=Ke(t);o=this.serverSyncTree_.applyTaggedQueryOverwrite(i,s,r)}else if(n){var c=u.map(t,(function(e){return Ke(e)}));o=this.serverSyncTree_.applyServerMerge(i,c)}else{var l=Ke(t);o=this.serverSyncTree_.applyServerOverwrite(i,l)}var h=i;o.length>0&&(h=this.rerunTransactions_(i)),this.eventQueue_.raiseEventsForChangedPath(h,o)},e.prototype.interceptServerData_=function(e){this.interceptServerDataCallback_=e},e.prototype.onConnectStatus_=function(e){this.updateInfo_("connected",e),!1===e&&this.runOnDisconnectEvents_()},e.prototype.onServerInfoUpdate_=function(e){var t=this;P(e,(function(e,n){t.updateInfo_(e,n)}))},e.prototype.updateInfo_=function(e,t){var n=new H("/.info/"+e),r=Ke(t);this.infoData_.updateSnapshot(n,r);var i=this.infoSyncTree_.applyServerOverwrite(n,r);this.eventQueue_.raiseEventsForChangedPath(n,i)},e.prototype.getNextWriteId_=function(){return this.nextWriteId_++},e.prototype.setWithPriority=function(e,t,n,r){var i=this;this.log_("set",{path:e.toString(),value:t,priority:n});var o=this.generateServerValues(),a=Ke(t,n),s=this.serverSyncTree_.calcCompleteEventCache(e),u=st(a,s,o),c=this.getNextWriteId_(),l=this.serverSyncTree_.applyUserOverwrite(e,u,c,!0);this.eventQueue_.queueEvents(l),this.server_.put(e.toString(),a.val(!0),(function(t,n){var o="ok"===t;o||I("set at "+e+" failed: "+t);var a=i.serverSyncTree_.ackUserWrite(c,!o);i.eventQueue_.raiseEventsForChangedPath(e,a),i.callOnCompleteCallback(r,t,n)}));var h=this.abortTransactions_(e);this.rerunTransactions_(h),this.eventQueue_.raiseEventsForChangedPath(h,[])},e.prototype.update=function(e,t,n){var r=this;this.log_("update",{path:e.toString(),value:t});var i=!0,o=this.generateServerValues(),a={};if(P(t,(function(t,n){i=!1;var s=Ke(n);a[t]=st(s,r.serverSyncTree_.calcCompleteEventCache(e),o)})),i)T("update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(n,"ok");else{var s=this.getNextWriteId_(),u=this.serverSyncTree_.applyUserMerge(e,a,s);this.eventQueue_.queueEvents(u),this.server_.merge(e.toString(),t,(function(t,i){var o="ok"===t;o||I("update at "+e+" failed: "+t);var a=r.serverSyncTree_.ackUserWrite(s,!o),u=a.length>0?r.rerunTransactions_(e):e;r.eventQueue_.raiseEventsForChangedPath(u,a),r.callOnCompleteCallback(n,t,i)})),P(t,(function(t){var n=r.abortTransactions_(e.child(t));r.rerunTransactions_(n)})),this.eventQueue_.raiseEventsForChangedPath(e,[])}},e.prototype.runOnDisconnectEvents_=function(){var e=this;this.log_("onDisconnectEvents");var t=this.generateServerValues(),n=function(e,t,n){var r=new rt;return e.forEachTree(new H(""),(function(e,i){var o=t.calcCompleteEventCache(e);u.assert(null!=o,"Expected ChildrenNode.EMPTY_NODE for nulls"),r.remember(e,st(i,o,n))})),r}(this.onDisconnect_,this.serverSyncTree_,t),r=[];n.forEachTree(H.Empty,(function(t,n){r=r.concat(e.serverSyncTree_.applyServerOverwrite(t,n));var i=e.abortTransactions_(t);e.rerunTransactions_(i)})),this.onDisconnect_=new rt,this.eventQueue_.raiseEventsForChangedPath(H.Empty,r)},e.prototype.onDisconnectCancel=function(e,t){var n=this;this.server_.onDisconnectCancel(e.toString(),(function(r,i){"ok"===r&&n.onDisconnect_.forget(e),n.callOnCompleteCallback(t,r,i)}))},e.prototype.onDisconnectSet=function(e,t,n){var r=this,i=Ke(t);this.server_.onDisconnectPut(e.toString(),i.val(!0),(function(t,o){"ok"===t&&r.onDisconnect_.remember(e,i),r.callOnCompleteCallback(n,t,o)}))},e.prototype.onDisconnectSetWithPriority=function(e,t,n,r){var i=this,o=Ke(t,n);this.server_.onDisconnectPut(e.toString(),o.val(!0),(function(t,n){"ok"===t&&i.onDisconnect_.remember(e,o),i.callOnCompleteCallback(r,t,n)}))},e.prototype.onDisconnectUpdate=function(e,t,n){var r=this;if(u.isEmpty(t))return T("onDisconnect().update() called with empty data.  Don't do anything."),void this.callOnCompleteCallback(n,"ok");this.server_.onDisconnectMerge(e.toString(),t,(function(i,o){"ok"===i&&P(t,(function(t,n){var i=Ke(n);r.onDisconnect_.remember(e.child(t),i)})),r.callOnCompleteCallback(n,i,o)}))},e.prototype.addEventCallbackForQuery=function(e,t){var n;n=".info"===e.path.getFront()?this.infoSyncTree_.addEventRegistration(e,t):this.serverSyncTree_.addEventRegistration(e,t),this.eventQueue_.raiseEventsAtPath(e.path,n)},e.prototype.removeEventCallbackForQuery=function(e,t){var n;n=".info"===e.path.getFront()?this.infoSyncTree_.removeEventRegistration(e,t):this.serverSyncTree_.removeEventRegistration(e,t),this.eventQueue_.raiseEventsAtPath(e.path,n)},e.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt("repo_interrupt")},e.prototype.resume=function(){this.persistentConnection_&&this.persistentConnection_.resume("repo_interrupt")},e.prototype.stats=function(e){if(void 0===e&&(e=!1),"undefined"!=typeof console){var t;e?(this.statsListener_||(this.statsListener_=new Ft(this.stats_)),t=this.statsListener_.get()):t=this.stats_.get();var n=Object.keys(t).reduce((function(e,t){return Math.max(t.length,e)}),0);P(t,(function(e,t){for(var r=e,i=e.length;i<n+2;i++)r+=" ";console.log(r+t)}))}},e.prototype.statsIncrementCounter=function(e){this.stats_.incrementCounter(e),this.statsReporter_.includeStat(e)},e.prototype.log_=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n="";this.persistentConnection_&&(n=this.persistentConnection_.id+":"),T.apply(void 0,s.__spread([n],e))},e.prototype.callOnCompleteCallback=function(e,t,n){e&&V((function(){if("ok"==t)e(null);else{var r=(t||"error").toUpperCase(),i=r;n&&(i+=": "+n);var o=new Error(i);o.code=r,e(o)}}))},Object.defineProperty(e.prototype,"database",{get:function(){return this.__database||(this.__database=new yn(this))},enumerable:!0,configurable:!0}),e}(),cn=function(){function e(t){this.indexedFilter_=new wt(t.getIndex()),this.index_=t.getIndex(),this.startPost_=e.getStartPost_(t),this.endPost_=e.getEndPost_(t)}return e.prototype.getStartPost=function(){return this.startPost_},e.prototype.getEndPost=function(){return this.endPost_},e.prototype.matches=function(e){return this.index_.compare(this.getStartPost(),e)<=0&&this.index_.compare(e,this.getEndPost())<=0},e.prototype.updateChild=function(e,t,n,r,i,o){return this.matches(new be(t,n))||(n=He.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,n,r,i,o)},e.prototype.updateFullNode=function(e,t,n){t.isLeafNode()&&(t=He.EMPTY_NODE);var r=t.withIndex(this.index_);r=r.updatePriority(He.EMPTY_NODE);var i=this;return t.forEachChild(Le,(function(e,t){i.matches(new be(e,t))||(r=r.updateImmediateChild(e,He.EMPTY_NODE))})),this.indexedFilter_.updateFullNode(e,r,n)},e.prototype.updatePriority=function(e,t){return e},e.prototype.filtersNodes=function(){return!0},e.prototype.getIndexedFilter=function(){return this.indexedFilter_},e.prototype.getIndex=function(){return this.index_},e.getStartPost_=function(e){if(e.hasStart()){var t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}return e.getIndex().minPost()},e.getEndPost_=function(e){if(e.hasEnd()){var t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}return e.getIndex().maxPost()},e}(),ln=function(){function e(e){this.rangedFilter_=new cn(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft()}return e.prototype.updateChild=function(e,t,n,r,i,o){return this.rangedFilter_.matches(new be(t,n))||(n=He.EMPTY_NODE),e.getImmediateChild(t).equals(n)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,n,r,i,o):this.fullLimitUpdateChild_(e,t,n,i,o)},e.prototype.updateFullNode=function(e,t,n){var r;if(t.isLeafNode()||t.isEmpty())r=He.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<t.numChildren()&&t.isIndexed(this.index_)){r=He.EMPTY_NODE.withIndex(this.index_);var i=void 0;i=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var o=0;i.hasNext()&&o<this.limit_;){var a=i.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),a)<=0:this.index_.compare(a,this.rangedFilter_.getEndPost())<=0))break;r=r.updateImmediateChild(a.name,a.node),o++}}else{r=(r=t.withIndex(this.index_)).updatePriority(He.EMPTY_NODE);var s=void 0,u=void 0,c=void 0;i=void 0;if(this.reverse_){i=r.getReverseIterator(this.index_),s=this.rangedFilter_.getEndPost(),u=this.rangedFilter_.getStartPost();var l=this.index_.getCompare();c=function(e,t){return l(t,e)}}else i=r.getIterator(this.index_),s=this.rangedFilter_.getStartPost(),u=this.rangedFilter_.getEndPost(),c=this.index_.getCompare();o=0;for(var h=!1;i.hasNext();){a=i.getNext();!h&&c(s,a)<=0&&(h=!0),h&&o<this.limit_&&c(a,u)<=0?o++:r=r.updateImmediateChild(a.name,He.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,r,n)},e.prototype.updatePriority=function(e,t){return e},e.prototype.filtersNodes=function(){return!0},e.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},e.prototype.getIndex=function(){return this.index_},e.prototype.fullLimitUpdateChild_=function(e,t,n,r,i){var o;if(this.reverse_){var a=this.index_.getCompare();o=function(e,t){return a(t,e)}}else o=this.index_.getCompare();var s=e;u.assert(s.numChildren()==this.limit_,"");var c=new be(t,n),l=this.reverse_?s.getFirstChild(this.index_):s.getLastChild(this.index_),h=this.rangedFilter_.matches(c);if(s.hasChild(t)){for(var d=s.getImmediateChild(t),p=r.getChildAfterChild(this.index_,l,this.reverse_);null!=p&&(p.name==t||s.hasChild(p.name));)p=r.getChildAfterChild(this.index_,p,this.reverse_);var f=null==p?1:o(p,c);if(h&&!n.isEmpty()&&f>=0)return null!=i&&i.trackChildChange(bt.childChangedChange(t,n,d)),s.updateImmediateChild(t,n);null!=i&&i.trackChildChange(bt.childRemovedChange(t,d));var m=s.updateImmediateChild(t,He.EMPTY_NODE);return null!=p&&this.rangedFilter_.matches(p)?(null!=i&&i.trackChildChange(bt.childAddedChange(p.name,p.node)),m.updateImmediateChild(p.name,p.node)):m}return n.isEmpty()?e:h&&o(l,c)>=0?(null!=i&&(i.trackChildChange(bt.childRemovedChange(l.name,l.node)),i.trackChildChange(bt.childAddedChange(t,n))),s.updateImmediateChild(t,n).updateImmediateChild(l.name,He.EMPTY_NODE)):e},e}(),hn=function(){function e(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=Le}return e.prototype.hasStart=function(){return this.startSet_},e.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:this.viewFrom_===e.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT},e.prototype.getIndexStartValue=function(){return u.assert(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},e.prototype.getIndexStartName=function(){return u.assert(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:A},e.prototype.hasEnd=function(){return this.endSet_},e.prototype.getIndexEndValue=function(){return u.assert(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},e.prototype.getIndexEndName=function(){return u.assert(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:N},e.prototype.hasLimit=function(){return this.limitSet_},e.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},e.prototype.getLimit=function(){return u.assert(this.limitSet_,"Only valid if limit has been set"),this.limit_},e.prototype.getIndex=function(){return this.index_},e.prototype.copy_=function(){var t=new e;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t},e.prototype.limit=function(e){var t=this.copy_();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="",t},e.prototype.limitToFirst=function(t){var n=this.copy_();return n.limitSet_=!0,n.limit_=t,n.viewFrom_=e.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT,n},e.prototype.limitToLast=function(t){var n=this.copy_();return n.limitSet_=!0,n.limit_=t,n.viewFrom_=e.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_RIGHT,n},e.prototype.startAt=function(e,t){var n=this.copy_();return n.startSet_=!0,void 0===e&&(e=null),n.indexStartValue_=e,null!=t?(n.startNameSet_=!0,n.indexStartName_=t):(n.startNameSet_=!1,n.indexStartName_=""),n},e.prototype.endAt=function(e,t){var n=this.copy_();return n.endSet_=!0,void 0===e&&(e=null),n.indexEndValue_=e,void 0!==t?(n.endNameSet_=!0,n.indexEndName_=t):(n.endNameSet_=!1,n.indexEndName_=""),n},e.prototype.orderBy=function(e){var t=this.copy_();return t.index_=e,t},e.prototype.getQueryObject=function(){var t=e.WIRE_PROTOCOL_CONSTANTS_,n={};if(this.startSet_&&(n[t.INDEX_START_VALUE]=this.indexStartValue_,this.startNameSet_&&(n[t.INDEX_START_NAME]=this.indexStartName_)),this.endSet_&&(n[t.INDEX_END_VALUE]=this.indexEndValue_,this.endNameSet_&&(n[t.INDEX_END_NAME]=this.indexEndName_)),this.limitSet_){n[t.LIMIT]=this.limit_;var r=this.viewFrom_;""===r&&(r=this.isViewFromLeft()?t.VIEW_FROM_LEFT:t.VIEW_FROM_RIGHT),n[t.VIEW_FROM]=r}return this.index_!==Le&&(n[t.INDEX]=this.index_.toString()),n},e.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},e.prototype.isDefault=function(){return this.loadsAllData()&&this.index_==Le},e.prototype.getNodeFilter=function(){return this.loadsAllData()?new wt(this.getIndex()):this.hasLimit()?new ln(this):new cn(this)},e.prototype.toRestQueryStringParameters=function(){var t,n=e.REST_QUERY_CONSTANTS_,r={};return this.isDefault()?r:(this.index_===Le?t=n.PRIORITY_INDEX:this.index_===$e?t=n.VALUE_INDEX:this.index_===Ce?t=n.KEY_INDEX:(u.assert(this.index_ instanceof Ye,"Unrecognized index type!"),t=this.index_.toString()),r[n.ORDER_BY]=u.stringify(t),this.startSet_&&(r[n.START_AT]=u.stringify(this.indexStartValue_),this.startNameSet_&&(r[n.START_AT]+=","+u.stringify(this.indexStartName_))),this.endSet_&&(r[n.END_AT]=u.stringify(this.indexEndValue_),this.endNameSet_&&(r[n.END_AT]+=","+u.stringify(this.indexEndName_))),this.limitSet_&&(this.isViewFromLeft()?r[n.LIMIT_TO_FIRST]=this.limit_:r[n.LIMIT_TO_LAST]=this.limit_),r)},e.WIRE_PROTOCOL_CONSTANTS_={INDEX_START_VALUE:"sp",INDEX_START_NAME:"sn",INDEX_END_VALUE:"ep",INDEX_END_NAME:"en",LIMIT:"l",VIEW_FROM:"vf",VIEW_FROM_LEFT:"l",VIEW_FROM_RIGHT:"r",INDEX:"i"},e.REST_QUERY_CONSTANTS_={ORDER_BY:"orderBy",PRIORITY_INDEX:"$priority",VALUE_INDEX:"$value",KEY_INDEX:"$key",START_AT:"startAt",END_AT:"endAt",LIMIT_TO_FIRST:"limitToFirst",LIMIT_TO_LAST:"limitToLast"},e.DEFAULT=new e,e}(),dn=function(e){function t(t,n){if(!(t instanceof un))throw new Error("new Reference() no longer supported - use app.database().");return e.call(this,t,n,hn.DEFAULT,!1)||this}return s.__extends(t,e),t.prototype.getKey=function(){return u.validateArgCount("Reference.key",0,0,arguments.length),this.path.isEmpty()?null:this.path.getBack()},t.prototype.child=function(e){return u.validateArgCount("Reference.child",1,1,arguments.length),"number"==typeof e?e=String(e):e instanceof H||(null===this.path.getFront()?de("Reference.child",1,e,!1):he("Reference.child",1,e,!1)),new t(this.repo,this.path.child(e))},t.prototype.getParent=function(){u.validateArgCount("Reference.parent",0,0,arguments.length);var e=this.path.parent();return null===e?null:new t(this.repo,e)},t.prototype.getRoot=function(){u.validateArgCount("Reference.root",0,0,arguments.length);for(var e=this;null!==e.getParent();)e=e.getParent();return e},t.prototype.databaseProp=function(){return this.repo.database},t.prototype.set=function(e,t){u.validateArgCount("Reference.set",1,2,arguments.length),pe("Reference.set",this.path),oe("Reference.set",1,e,this.path,!1),u.validateCallback("Reference.set",2,t,!0);var n=new u.Deferred;return this.repo.setWithPriority(this.path,e,null,n.wrapCallback(t)),n.promise},t.prototype.update=function(e,t){if(u.validateArgCount("Reference.update",1,2,arguments.length),pe("Reference.update",this.path),Array.isArray(e)){for(var n={},r=0;r<e.length;++r)n[""+r]=e[r];e=n,I("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}se("Reference.update",1,e,this.path,!1),u.validateCallback("Reference.update",2,t,!0);var i=new u.Deferred;return this.repo.update(this.path,e,i.wrapCallback(t)),i.promise},t.prototype.setWithPriority=function(e,t,n){if(u.validateArgCount("Reference.setWithPriority",2,3,arguments.length),pe("Reference.setWithPriority",this.path),oe("Reference.setWithPriority",1,e,this.path,!1),ue("Reference.setWithPriority",2,t,!1),u.validateCallback("Reference.setWithPriority",3,n,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.setWithPriority failed: "+this.getKey()+" is a read-only object.";var r=new u.Deferred;return this.repo.setWithPriority(this.path,e,t,r.wrapCallback(n)),r.promise},t.prototype.remove=function(e){return u.validateArgCount("Reference.remove",0,1,arguments.length),pe("Reference.remove",this.path),u.validateCallback("Reference.remove",1,e,!0),this.set(null,e)},t.prototype.transaction=function(e,t,n){if(u.validateArgCount("Reference.transaction",1,3,arguments.length),pe("Reference.transaction",this.path),u.validateCallback("Reference.transaction",1,e,!1),u.validateCallback("Reference.transaction",2,t,!0),me("Reference.transaction",3,n,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.transaction failed: "+this.getKey()+" is a read-only object.";void 0===n&&(n=!0);var r=new u.Deferred;"function"==typeof t&&r.promise.catch((function(){}));var i=function(e,n,i){e?r.reject(e):r.resolve(new ve(n,i)),"function"==typeof t&&t(e,n,i)};return this.repo.startTransaction(this.path,e,i,n),r.promise},t.prototype.setPriority=function(e,t){u.validateArgCount("Reference.setPriority",1,2,arguments.length),pe("Reference.setPriority",this.path),ue("Reference.setPriority",1,e,!1),u.validateCallback("Reference.setPriority",2,t,!0);var n=new u.Deferred;return this.repo.setWithPriority(this.path.child(".priority"),e,null,n.wrapCallback(t)),n.promise},t.prototype.push=function(e,t){u.validateArgCount("Reference.push",0,2,arguments.length),pe("Reference.push",this.path),oe("Reference.push",1,e,this.path,!0),u.validateCallback("Reference.push",2,t,!0);var n,r=this.repo.serverTime(),i=ye(r),o=this.child(i),a=this.child(i);return n=null!=e?o.set(e,t).then((function(){return a})):Promise.resolve(a),o.then=n.then.bind(n),o.catch=n.then.bind(n,void 0),"function"==typeof t&&n.catch((function(){})),o},t.prototype.onDisconnect=function(){return pe("Reference.onDisconnect",this.path),new ge(this.repo,this.path)},Object.defineProperty(t.prototype,"database",{get:function(){return this.databaseProp()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"key",{get:function(){return this.getKey()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this.getParent()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){return this.getRoot()},enumerable:!0,configurable:!0}),t}(nt);nt.__referenceConstructor=dn,kt.__referenceConstructor=dn;var pn,fn=function(){this.children={},this.childCount=0,this.value=null},mn=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=null),void 0===n&&(n=new fn),this.name_=e,this.parent_=t,this.node_=n}return e.prototype.subTree=function(t){for(var n,r=t instanceof H?t:new H(t),i=this;null!==(n=r.getFront());){i=new e(n,i,u.safeGet(i.node_.children,n)||new fn),r=r.popFront()}return i},e.prototype.getValue=function(){return this.node_.value},e.prototype.setValue=function(e){u.assert(void 0!==e,"Cannot set value to undefined"),this.node_.value=e,this.updateParents_()},e.prototype.clear=function(){this.node_.value=null,this.node_.children={},this.node_.childCount=0,this.updateParents_()},e.prototype.hasChildren=function(){return this.node_.childCount>0},e.prototype.isEmpty=function(){return null===this.getValue()&&!this.hasChildren()},e.prototype.forEachChild=function(t){var n=this;P(this.node_.children,(function(r,i){t(new e(r,n,i))}))},e.prototype.forEachDescendant=function(e,t,n){t&&!n&&e(this),this.forEachChild((function(t){t.forEachDescendant(e,!0,n)})),t&&n&&e(this)},e.prototype.forEachAncestor=function(e,t){for(var n=t?this:this.parent();null!==n;){if(e(n))return!0;n=n.parent()}return!1},e.prototype.forEachImmediateDescendantWithValue=function(e){this.forEachChild((function(t){null!==t.getValue()?e(t):t.forEachImmediateDescendantWithValue(e)}))},e.prototype.path=function(){return new H(null===this.parent_?this.name_:this.parent_.path()+"/"+this.name_)},e.prototype.name=function(){return this.name_},e.prototype.parent=function(){return this.parent_},e.prototype.updateParents_=function(){null!==this.parent_&&this.parent_.updateChild_(this.name_,this)},e.prototype.updateChild_=function(e,t){var n=t.isEmpty(),r=u.contains(this.node_.children,e);n&&r?(delete this.node_.children[e],this.node_.childCount--,this.updateParents_()):n||r||(this.node_.children[e]=t.node_,this.node_.childCount++,this.updateParents_())},e}();!function(e){e[e.RUN=0]="RUN",e[e.SENT=1]="SENT",e[e.COMPLETED=2]="COMPLETED",e[e.SENT_NEEDS_ABORT=3]="SENT_NEEDS_ABORT",e[e.NEEDS_ABORT=4]="NEEDS_ABORT"}(pn||(pn={})),un.MAX_TRANSACTION_RETRIES_=25,un.prototype.transactions_init_=function(){this.transactionQueueTree_=new mn},un.prototype.startTransaction=function(e,t,n,r){this.log_("transaction on "+e);var i=function(){},o=new dn(this,e);o.on("value",i);var a={path:e,update:t,onComplete:n,status:null,order:v(),applyLocally:r,retryCount:0,unwatcher:function(){o.off("value",i)},abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},s=this.getLatestState_(e);a.currentInputSnapshot=s;var c=a.update(s.val());if(void 0===c){if(a.unwatcher(),a.currentOutputSnapshotRaw=null,a.currentOutputSnapshotResolved=null,a.onComplete){var l=new Xe(a.currentInputSnapshot,new dn(this,a.path),Le);a.onComplete(null,!1,l)}}else{ae("transaction failed: Data returned ",c,a.path),a.status=pn.RUN;var h=this.transactionQueueTree_.subTree(e),d=h.getValue()||[];d.push(a),h.setValue(d);var p=void 0;if("object"==typeof c&&null!==c&&u.contains(c,".priority"))p=u.safeGet(c,".priority"),u.assert(ie(p),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.");else p=(this.serverSyncTree_.calcCompleteEventCache(e)||He.EMPTY_NODE).getPriority().val();p=p;var f=this.generateServerValues(),m=Ke(c,p),g=st(m,s,f);a.currentOutputSnapshotRaw=m,a.currentOutputSnapshotResolved=g,a.currentWriteId=this.getNextWriteId_();var y=this.serverSyncTree_.applyUserOverwrite(e,g,a.currentWriteId,a.applyLocally);this.eventQueue_.raiseEventsForChangedPath(e,y),this.sendReadyTransactions_()}},un.prototype.getLatestState_=function(e,t){return this.serverSyncTree_.calcCompleteEventCache(e,t)||He.EMPTY_NODE},un.prototype.sendReadyTransactions_=function(e){var t=this;if(void 0===e&&(e=this.transactionQueueTree_),e||this.pruneCompletedTransactionsBelowNode_(e),null!==e.getValue()){var n=this.buildTransactionQueue_(e);u.assert(n.length>0,"Sending zero length transaction queue"),n.every((function(e){return e.status===pn.RUN}))&&this.sendTransactionQueue_(e.path(),n)}else e.hasChildren()&&e.forEachChild((function(e){t.sendReadyTransactions_(e)}))},un.prototype.sendTransactionQueue_=function(e,t){for(var n=this,r=t.map((function(e){return e.currentWriteId})),i=this.getLatestState_(e,r),o=i,a=i.hash(),s=0;s<t.length;s++){var c=t[s];u.assert(c.status===pn.RUN,"tryToSendTransactionQueue_: items in queue should all be run."),c.status=pn.SENT,c.retryCount++;var l=H.relativePath(e,c.path);o=o.updateChild(l,c.currentOutputSnapshotRaw)}var h=o.val(!0),d=e;this.server_.put(d.toString(),h,(function(r){n.log_("transaction put response",{path:d.toString(),status:r});var i=[];if("ok"===r){for(var o=[],a=0;a<t.length;a++){if(t[a].status=pn.COMPLETED,i=i.concat(n.serverSyncTree_.ackUserWrite(t[a].currentWriteId)),t[a].onComplete){var s=t[a].currentOutputSnapshotResolved,u=new dn(n,t[a].path),c=new Xe(s,u,Le);o.push(t[a].onComplete.bind(null,null,!0,c))}t[a].unwatcher()}n.pruneCompletedTransactionsBelowNode_(n.transactionQueueTree_.subTree(e)),n.sendReadyTransactions_(),n.eventQueue_.raiseEventsForChangedPath(e,i);for(a=0;a<o.length;a++)V(o[a])}else{if("datastale"===r)for(a=0;a<t.length;a++)t[a].status===pn.SENT_NEEDS_ABORT?t[a].status=pn.NEEDS_ABORT:t[a].status=pn.RUN;else{I("transaction at "+d.toString()+" failed: "+r);for(a=0;a<t.length;a++)t[a].status=pn.NEEDS_ABORT,t[a].abortReason=r}n.rerunTransactions_(e)}}),a)},un.prototype.rerunTransactions_=function(e){var t=this.getAncestorTransactionNode_(e),n=t.path(),r=this.buildTransactionQueue_(t);return this.rerunTransactionQueue_(r,n),n},un.prototype.rerunTransactionQueue_=function(e,t){if(0!==e.length){for(var n,r=[],i=[],o=e.filter((function(e){return e.status===pn.RUN})).map((function(e){return e.currentWriteId})),a=0;a<e.length;a++){var s=e[a],c=H.relativePath(t,s.path),l=!1,h=void 0;if(u.assert(null!==c,"rerunTransactionsUnderNode_: relativePath should not be null."),s.status===pn.NEEDS_ABORT)l=!0,h=s.abortReason,i=i.concat(this.serverSyncTree_.ackUserWrite(s.currentWriteId,!0));else if(s.status===pn.RUN)if(s.retryCount>=un.MAX_TRANSACTION_RETRIES_)l=!0,h="maxretry",i=i.concat(this.serverSyncTree_.ackUserWrite(s.currentWriteId,!0));else{var d=this.getLatestState_(s.path,o);s.currentInputSnapshot=d;var p=e[a].update(d.val());if(void 0!==p){ae("transaction failed: Data returned ",p,s.path);var f=Ke(p);"object"==typeof p&&null!=p&&u.contains(p,".priority")||(f=f.updatePriority(d.getPriority()));var m=s.currentWriteId,g=this.generateServerValues(),v=st(f,d,g);s.currentOutputSnapshotRaw=f,s.currentOutputSnapshotResolved=v,s.currentWriteId=this.getNextWriteId_(),o.splice(o.indexOf(m),1),i=(i=i.concat(this.serverSyncTree_.applyUserOverwrite(s.path,v,s.currentWriteId,s.applyLocally))).concat(this.serverSyncTree_.ackUserWrite(m,!0))}else l=!0,h="nodata",i=i.concat(this.serverSyncTree_.ackUserWrite(s.currentWriteId,!0))}if(this.eventQueue_.raiseEventsForChangedPath(t,i),i=[],l&&(e[a].status=pn.COMPLETED,n=e[a].unwatcher,setTimeout(n,Math.floor(0)),e[a].onComplete))if("nodata"===h){var y=new dn(this,e[a].path),b=e[a].currentInputSnapshot,w=new Xe(b,y,Le);r.push(e[a].onComplete.bind(null,null,!1,w))}else r.push(e[a].onComplete.bind(null,new Error(h),!1,null))}this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_);for(a=0;a<r.length;a++)V(r[a]);this.sendReadyTransactions_()}},un.prototype.getAncestorTransactionNode_=function(e){for(var t,n=this.transactionQueueTree_;null!==(t=e.getFront())&&null===n.getValue();)n=n.subTree(t),e=e.popFront();return n},un.prototype.buildTransactionQueue_=function(e){var t=[];return this.aggregateTransactionQueuesForNode_(e,t),t.sort((function(e,t){return e.order-t.order})),t},un.prototype.aggregateTransactionQueuesForNode_=function(e,t){var n=this,r=e.getValue();if(null!==r)for(var i=0;i<r.length;i++)t.push(r[i]);e.forEachChild((function(e){n.aggregateTransactionQueuesForNode_(e,t)}))},un.prototype.pruneCompletedTransactionsBelowNode_=function(e){var t=this,n=e.getValue();if(n){for(var r=0,i=0;i<n.length;i++)n[i].status!==pn.COMPLETED&&(n[r]=n[i],r++);n.length=r,e.setValue(n.length>0?n:null)}e.forEachChild((function(e){t.pruneCompletedTransactionsBelowNode_(e)}))},un.prototype.abortTransactions_=function(e){var t=this,n=this.getAncestorTransactionNode_(e).path(),r=this.transactionQueueTree_.subTree(e);return r.forEachAncestor((function(e){t.abortTransactionsOnNode_(e)})),this.abortTransactionsOnNode_(r),r.forEachDescendant((function(e){t.abortTransactionsOnNode_(e)})),n},un.prototype.abortTransactionsOnNode_=function(e){var t=e.getValue();if(null!==t){for(var n=[],r=[],i=-1,o=0;o<t.length;o++)if(t[o].status===pn.SENT_NEEDS_ABORT);else if(t[o].status===pn.SENT)u.assert(i===o-1,"All SENT items should be at beginning of queue."),i=o,t[o].status=pn.SENT_NEEDS_ABORT,t[o].abortReason="set";else if(u.assert(t[o].status===pn.RUN,"Unexpected transaction status in abort"),t[o].unwatcher(),r=r.concat(this.serverSyncTree_.ackUserWrite(t[o].currentWriteId,!0)),t[o].onComplete){n.push(t[o].onComplete.bind(null,new Error("set"),!1,null))}-1===i?e.setValue(null):t.length=i+1,this.eventQueue_.raiseEventsForChangedPath(e.path(),r);for(o=0;o<n.length;o++)V(n[o])}};var gn,vn=function(){function e(){this.repos_={},this.useRestClient_=!1}return e.getInstance=function(){return gn||(gn=new e),gn},e.prototype.interrupt=function(){for(var e in this.repos_)for(var t in this.repos_[e])this.repos_[e][t].interrupt()},e.prototype.resume=function(){for(var e in this.repos_)for(var t in this.repos_[e])this.repos_[e][t].resume()},e.prototype.databaseFromApp=function(e,t,n){var i=n||e.options.databaseURL;void 0===i&&x("Can't determine Firebase Database URL.  Be sure to include databaseURL option when calling firebase.initializeApp().");var o=J(i),a=o.repoInfo,s=void 0;return void 0!==r&&(s={}.FIREBASE_DATABASE_EMULATOR_HOST),s&&(i="http://"+s+"?ns="+a.namespace,a=(o=J(i)).repoInfo),fe("Invalid Firebase Database URL",1,o),o.path.isEmpty()||x("Database URL must point to the root of a Firebase Database (not including a child path)."),this.createRepo(a,e,t).database},e.prototype.deleteRepo=function(e){var t=u.safeGet(this.repos_,e.app.name);t&&u.safeGet(t,e.repoInfo_.toURLString())===e||x("Database "+e.app.name+"("+e.repoInfo_+") has already been deleted."),e.interrupt(),delete t[e.repoInfo_.toURLString()]},e.prototype.createRepo=function(e,t,n){var r=u.safeGet(this.repos_,t.name);r||(r={},this.repos_[t.name]=r);var i=u.safeGet(r,e.toURLString());return i&&x("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),i=new un(e,this.useRestClient_,t,n),r[e.toURLString()]=i,i},e.prototype.forceRestClient=function(e){this.useRestClient_=e},e}(),yn=function(){function e(e){this.repo_=e,e instanceof un||x("Don't call new Database() directly - please use firebase.database()."),this.root_=new dn(e,H.Empty),this.INTERNAL=new bn(this)}return Object.defineProperty(e.prototype,"app",{get:function(){return this.repo_.app},enumerable:!0,configurable:!0}),e.prototype.ref=function(e){return this.checkDeleted_("ref"),u.validateArgCount("database.ref",0,1,arguments.length),e instanceof dn?this.refFromURL(e.toString()):void 0!==e?this.root_.child(e):this.root_},e.prototype.refFromURL=function(e){var t="database.refFromURL";this.checkDeleted_(t),u.validateArgCount(t,1,1,arguments.length);var n=J(e);fe(t,1,n);var r=n.repoInfo;return r.host!==this.repo_.repoInfo_.host&&x(t+": Host name does not match the current database: (found "+r.host+" but expected "+this.repo_.repoInfo_.host+")"),this.ref(n.path.toString())},e.prototype.checkDeleted_=function(e){null===this.repo_&&x("Cannot call "+e+" on a deleted database.")},e.prototype.goOffline=function(){u.validateArgCount("database.goOffline",0,0,arguments.length),this.checkDeleted_("goOffline"),this.repo_.interrupt()},e.prototype.goOnline=function(){u.validateArgCount("database.goOnline",0,0,arguments.length),this.checkDeleted_("goOnline"),this.repo_.resume()},e.ServerValue={TIMESTAMP:{".sv":"timestamp"},_increment:function(e){return{".sv":{increment:e}}}},e}(),bn=function(){function e(e){this.database=e}return e.prototype.delete=function(){return s.__awaiter(this,void 0,void 0,(function(){return s.__generator(this,(function(e){return this.database.checkDeleted_("delete"),vn.getInstance().deleteRepo(this.database.repo_),this.database.repo_=null,this.database.root_=null,this.database.INTERNAL=null,this.database=null,[2]}))}))},e}(),wn=Object.freeze({__proto__:null,forceLongPolling:function(){Zt.forceDisallow(),$t.forceAllow()},forceWebSockets:function(){$t.forceDisallow()},isWebSocketsAvailable:function(){return Zt.isAvailable()},setSecurityDebugCallback:function(e,t){e.repo.persistentConnection_.securityDebugCallback_=t},stats:function(e,t){e.repo.stats(t)},statsIncrementCounter:function(e,t){e.repo.statsIncrementCounter(t)},dataUpdateCount:function(e){return e.repo.dataUpdateCount},interceptServerData:function(e,t){return e.repo.interceptServerData_(t)}}),_n=an;an.prototype.simpleListen=function(e,t){this.sendRequest("q",{p:e},t)},an.prototype.echo=function(e,t){this.sendRequest("echo",{d:e},t)};var Cn=tn,Tn=K,Sn=Object.freeze({__proto__:null,DataConnection:_n,RealTimeConnection:Cn,hijackHash:function(e){var t=an.prototype.put;return an.prototype.put=function(n,r,i,o){void 0!==o&&(o=e()),t.call(this,n,r,i,o)},function(){an.prototype.put=t}},ConnectionTarget:Tn,queryIdentifier:function(e){return e.queryIdentifier()},forceRestClient:function(e){vn.getInstance().forceRestClient(e)}}),En="@firebase/database",xn="0.5.17",In=yn.ServerValue;function kn(t){!function(e){Xt=e}(t.SDK_VERSION);var n=t.INTERNAL.registerComponent(new l.Component("database",(function(e,t){var n=e.getProvider("app").getImmediate(),r=e.getProvider("auth-internal");return vn.getInstance().databaseFromApp(n,r,t)}),"PUBLIC").setServiceProps({Reference:dn,Query:nt,Database:yn,DataSnapshot:Xe,enableLogging:C,INTERNAL:wn,ServerValue:In,TEST_ACCESS:Sn}).setMultipleInstances(!0));t.registerVersion(En,xn),u.isNodeSdk()&&(e.exports=n)}kn(a),t.DataSnapshot=Xe,t.Database=yn,t.OnDisconnect=ge,t.Query=nt,t.Reference=dn,t.ServerValue=In,t.enableLogging=C,t.registerDatabase=kn}).call(this,n("8oxB"))},NrJJ:function(e,t,n){"use strict";n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n("q1tI"));t.default=function(e,t,n){return r.createElement("a",{href:e,key:n},t)}},O6Fj:function(e,t,n){"use strict";t.__esModule=!0;var r=n("CNgt");t.default=r.TextareaAutosize},OR32:function(e,t,n){"use strict";n("R48M"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e}},"PZd/":function(e,t,n){var r=n("P8UN"),i=n("ys0W")(!0);r(r.S,"Object",{entries:function(e){return i(e)}})},"Q+Us":function(e,t,n){"use strict";n("R48M"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e}},"QzX/":function(e,t,n){"use strict";n("EU/P")("trimRight",(function(e){return function(){return e(this,2)}}),"trimEnd")},R0hF:function(e,t,n){var r=n("P8UN");r(r.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},Ribc:function(e,t,n){"use strict";n("AqHK"),n("MIFh"),n("JHok"),n("LagC"),n("pS08"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n("q1tI")),o=c(n("NrJJ")),a=c(n("OR32")),s=c(n("L5ms")),u=c(n("Q+Us"));function c(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"parseString",value:function(e){var t=this;if(""===e)return e;var n=this.props.matchDecorator(e);if(!n)return e;var r=[],i=0;return n.forEach((function(n,o){n.index>i&&r.push(e.substring(i,n.index));var a=t.props.hrefDecorator(n.url),s=t.props.textDecorator(n.text),u=t.props.componentDecorator(a,s,o);r.push(u),i=n.lastIndex})),e.length>i&&r.push(e.substring(i)),1===r.length?r[0]:r}},{key:"parse",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"string"==typeof e?this.parseString(e):i.isValidElement(e)&&"a"!==e.type&&"button"!==e.type?i.cloneElement(e,{key:n},this.parse(e.props.children)):Array.isArray(e)?e.map((function(e,n){return t.parse(e,n)})):e}},{key:"render",value:function(){return i.createElement(i.Fragment,null,this.parse(this.props.children))}}]),t}(i.Component);l.defaultProps={componentDecorator:o.default,hrefDecorator:a.default,matchDecorator:s.default,textDecorator:u.default},t.default=l},Rk8H:function(e,t,n){n("sc67");var r=n("jTPX");e.exports=function(e){var t=r(e,"line-height"),n=parseFloat(t,10);if(t===n+""){var i=e.style.lineHeight;e.style.lineHeight=t+"em",t=r(e,"line-height"),n=parseFloat(t,10),i?e.style.lineHeight=i:delete e.style.lineHeight}if(-1!==t.indexOf("pt")?(n*=4,n/=3):-1!==t.indexOf("mm")?(n*=96,n/=25.4):-1!==t.indexOf("cm")?(n*=96,n/=2.54):-1!==t.indexOf("in")?n*=96:-1!==t.indexOf("pc")&&(n*=16),n=Math.round(n),"normal"===t){var o=e.nodeName,a=document.createElement(o);a.innerHTML="&nbsp;","TEXTAREA"===o.toUpperCase()&&a.setAttribute("rows","1");var s=r(e,"font-size");a.style.fontSize=s,a.style.padding="0px",a.style.border="0px";var u=document.body;u.appendChild(a),n=a.offsetHeight,u.removeChild(a)}return n}},Rw9D:function(e,t,n){"use strict";var r=n("P8UN"),i=n("/+AL");r(r.P+r.F*!n("h/qr")([].reduceRight,!0),"Array",{reduceRight:function(e){return i(this,e,arguments.length,arguments[1],!0)}})},"S+S0":function(e,t,n){"use strict";n("OeI1"),n("AqHK"),n("6kNP"),n("cFtU"),n("rzGZ"),n("Dq+y"),n("8npG"),n("YbXK"),n("xJgp"),n("pJf4"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r=n("mrSG"),i=n("zVF4"),o=function(){function e(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY"}return e.prototype.setInstantiationMode=function(e){return this.instantiationMode=e,this},e.prototype.setMultipleInstances=function(e){return this.multipleInstances=e,this},e.prototype.setServiceProps=function(e){return this.serviceProps=e,this},e}(),a="[DEFAULT]",s=function(){function e(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map}return e.prototype.get=function(e){void 0===e&&(e=a);var t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){var n=new i.Deferred;this.instancesDeferred.set(t,n);try{var r=this.getOrInitializeService(t);r&&n.resolve(r)}catch(o){}}return this.instancesDeferred.get(t).promise},e.prototype.getImmediate=function(e){var t=r.__assign({identifier:a,optional:!1},e),n=t.identifier,i=t.optional,o=this.normalizeInstanceIdentifier(n);try{var s=this.getOrInitializeService(o);if(!s){if(i)return null;throw Error("Service "+this.name+" is not available")}return s}catch(u){if(i)return null;throw u}},e.prototype.getComponent=function(){return this.component},e.prototype.setComponent=function(e){var t,n;if(e.name!==this.name)throw Error("Mismatching Component "+e.name+" for Provider "+this.name+".");if(this.component)throw Error("Component for "+this.name+" has already been provided");if(this.component=e,function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService(a)}catch(d){}try{for(var i=r.__values(this.instancesDeferred.entries()),o=i.next();!o.done;o=i.next()){var s=r.__read(o.value,2),u=s[0],c=s[1],l=this.normalizeInstanceIdentifier(u);try{var h=this.getOrInitializeService(l);c.resolve(h)}catch(d){}}}catch(p){t={error:p}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},e.prototype.clearInstance=function(e){void 0===e&&(e=a),this.instancesDeferred.delete(e),this.instances.delete(e)},e.prototype.delete=function(){return r.__awaiter(this,void 0,void 0,(function(){var e;return r.__generator(this,(function(t){switch(t.label){case 0:return e=Array.from(this.instances.values()),[4,Promise.all(e.filter((function(e){return"INTERNAL"in e})).map((function(e){return e.INTERNAL.delete()})))];case 1:return t.sent(),[2]}}))}))},e.prototype.isComponentSet=function(){return null!=this.component},e.prototype.getOrInitializeService=function(e){var t=this.instances.get(e);return!t&&this.component&&(t=this.component.instanceFactory(this.container,function(e){return e===a?void 0:e}(e)),this.instances.set(e,t)),t||null},e.prototype.normalizeInstanceIdentifier=function(e){return this.component?this.component.multipleInstances?e:a:e},e}();var u=function(){function e(e){this.name=e,this.providers=new Map}return e.prototype.addComponent=function(e){var t=this.getProvider(e.name);if(t.isComponentSet())throw new Error("Component "+e.name+" has already been registered with "+this.name);t.setComponent(e)},e.prototype.addOrOverwriteComponent=function(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)},e.prototype.getProvider=function(e){if(this.providers.has(e))return this.providers.get(e);var t=new s(e,this);return this.providers.set(e,t),t},e.prototype.getProviders=function(){return Array.from(this.providers.values())},e}();t.Component=o,t.ComponentContainer=u,t.Provider=s},Sc3u:function(e,t,n){"use strict";if(n("QPJK")){var r=n("939K"),i=n("emib"),o=n("96qb"),a=n("P8UN"),s=n("Jegl"),u=n("voZr"),c=n("ot9L"),l=n("xa9o"),h=n("pSXQ"),d=n("8wc8"),p=n("rj/q"),f=n("1Llc"),m=n("kiRH"),g=n("gx6d"),v=n("dTG6"),y=n("kxs/"),b=n("qDzq"),w=n("aHWV"),_=n("BjK0"),C=n("DFzH"),T=n("BuzY"),S=n("nsRs"),E=n("ltAs"),x=n("chL8").f,I=n("U9/z"),k=n("UEZ0"),A=n("sOol"),N=n("Wadk"),L=n("Ar2q"),D=n("Ioy3"),O=n("Dq+y"),M=n("m+kh"),R=n("vUMq"),P=n("to/b"),F=n("Y++M"),j=n("cRJv"),B=n("rjfK"),V=n("Drra"),W=B.f,U=V.f,H=i.RangeError,z=i.TypeError,q=i.Uint8Array,K=Array.prototype,G=u.ArrayBuffer,Q=u.DataView,$=N(0),Y=N(2),X=N(3),J=N(4),Z=N(5),ee=N(6),te=L(!0),ne=L(!1),re=O.values,ie=O.keys,oe=O.entries,ae=K.lastIndexOf,se=K.reduce,ue=K.reduceRight,ce=K.join,le=K.sort,he=K.slice,de=K.toString,pe=K.toLocaleString,fe=A("iterator"),me=A("toStringTag"),ge=k("typed_constructor"),ve=k("def_constructor"),ye=s.CONSTR,be=s.TYPED,we=s.VIEW,_e=N(1,(function(e,t){return xe(D(e,e[ve]),t)})),Ce=o((function(){return 1===new q(new Uint16Array([1]).buffer)[0]})),Te=!!q&&!!q.prototype.set&&o((function(){new q(1).set({})})),Se=function(e,t){var n=f(e);if(n<0||n%t)throw H("Wrong offset!");return n},Ee=function(e){if(_(e)&&be in e)return e;throw z(e+" is not a typed array!")},xe=function(e,t){if(!(_(e)&&ge in e))throw z("It is not a typed array constructor!");return new e(t)},Ie=function(e,t){return ke(D(e,e[ve]),t)},ke=function(e,t){for(var n=0,r=t.length,i=xe(e,r);r>n;)i[n]=t[n++];return i},Ae=function(e,t,n){W(e,t,{get:function(){return this._d[n]}})},Ne=function(e){var t,n,r,i,o,a,s=C(e),u=arguments.length,l=u>1?arguments[1]:void 0,h=void 0!==l,d=I(s);if(null!=d&&!T(d)){for(a=d.call(s),r=[],t=0;!(o=a.next()).done;t++)r.push(o.value);s=r}for(h&&u>2&&(l=c(l,arguments[2],2)),t=0,n=m(s.length),i=xe(this,n);n>t;t++)i[t]=h?l(s[t],t):s[t];return i},Le=function(){for(var e=0,t=arguments.length,n=xe(this,t);t>e;)n[e]=arguments[e++];return n},De=!!q&&o((function(){pe.call(new q(1))})),Oe=function(){return pe.apply(De?he.call(Ee(this)):Ee(this),arguments)},Me={copyWithin:function(e,t){return j.call(Ee(this),e,t,arguments.length>2?arguments[2]:void 0)},every:function(e){return J(Ee(this),e,arguments.length>1?arguments[1]:void 0)},fill:function(e){return F.apply(Ee(this),arguments)},filter:function(e){return Ie(this,Y(Ee(this),e,arguments.length>1?arguments[1]:void 0))},find:function(e){return Z(Ee(this),e,arguments.length>1?arguments[1]:void 0)},findIndex:function(e){return ee(Ee(this),e,arguments.length>1?arguments[1]:void 0)},forEach:function(e){$(Ee(this),e,arguments.length>1?arguments[1]:void 0)},indexOf:function(e){return ne(Ee(this),e,arguments.length>1?arguments[1]:void 0)},includes:function(e){return te(Ee(this),e,arguments.length>1?arguments[1]:void 0)},join:function(e){return ce.apply(Ee(this),arguments)},lastIndexOf:function(e){return ae.apply(Ee(this),arguments)},map:function(e){return _e(Ee(this),e,arguments.length>1?arguments[1]:void 0)},reduce:function(e){return se.apply(Ee(this),arguments)},reduceRight:function(e){return ue.apply(Ee(this),arguments)},reverse:function(){for(var e,t=Ee(this).length,n=Math.floor(t/2),r=0;r<n;)e=this[r],this[r++]=this[--t],this[t]=e;return this},some:function(e){return X(Ee(this),e,arguments.length>1?arguments[1]:void 0)},sort:function(e){return le.call(Ee(this),e)},subarray:function(e,t){var n=Ee(this),r=n.length,i=v(e,r);return new(D(n,n[ve]))(n.buffer,n.byteOffset+i*n.BYTES_PER_ELEMENT,m((void 0===t?r:v(t,r))-i))}},Re=function(e,t){return Ie(this,he.call(Ee(this),e,t))},Pe=function(e){Ee(this);var t=Se(arguments[1],1),n=this.length,r=C(e),i=m(r.length),o=0;if(i+t>n)throw H("Wrong length!");for(;o<i;)this[t+o]=r[o++]},Fe={entries:function(){return oe.call(Ee(this))},keys:function(){return ie.call(Ee(this))},values:function(){return re.call(Ee(this))}},je=function(e,t){return _(e)&&e[be]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},Be=function(e,t){return je(e,t=y(t,!0))?h(2,e[t]):U(e,t)},Ve=function(e,t,n){return!(je(e,t=y(t,!0))&&_(n)&&b(n,"value"))||b(n,"get")||b(n,"set")||n.configurable||b(n,"writable")&&!n.writable||b(n,"enumerable")&&!n.enumerable?W(e,t,n):(e[t]=n.value,e)};ye||(V.f=Be,B.f=Ve),a(a.S+a.F*!ye,"Object",{getOwnPropertyDescriptor:Be,defineProperty:Ve}),o((function(){de.call({})}))&&(de=pe=function(){return ce.call(this)});var We=p({},Me);p(We,Fe),d(We,fe,Fe.values),p(We,{slice:Re,set:Pe,constructor:function(){},toString:de,toLocaleString:Oe}),Ae(We,"buffer","b"),Ae(We,"byteOffset","o"),Ae(We,"byteLength","l"),Ae(We,"length","e"),W(We,me,{get:function(){return this[be]}}),e.exports=function(e,t,n,u){var c=e+((u=!!u)?"Clamped":"")+"Array",h="get"+e,p="set"+e,f=i[c],v=f||{},y=f&&E(f),b=!f||!s.ABV,C={},T=f&&f.prototype,I=function(e,n){W(e,n,{get:function(){return function(e,n){var r=e._d;return r.v[h](n*t+r.o,Ce)}(this,n)},set:function(e){return function(e,n,r){var i=e._d;u&&(r=(r=Math.round(r))<0?0:r>255?255:255&r),i.v[p](n*t+i.o,r,Ce)}(this,n,e)},enumerable:!0})};b?(f=n((function(e,n,r,i){l(e,f,c,"_d");var o,a,s,u,h=0,p=0;if(_(n)){if(!(n instanceof G||"ArrayBuffer"==(u=w(n))||"SharedArrayBuffer"==u))return be in n?ke(f,n):Ne.call(f,n);o=n,p=Se(r,t);var v=n.byteLength;if(void 0===i){if(v%t)throw H("Wrong length!");if((a=v-p)<0)throw H("Wrong length!")}else if((a=m(i)*t)+p>v)throw H("Wrong length!");s=a/t}else s=g(n),o=new G(a=s*t);for(d(e,"_d",{b:o,o:p,l:a,e:s,v:new Q(o)});h<s;)I(e,h++)})),T=f.prototype=S(We),d(T,"constructor",f)):o((function(){f(1)}))&&o((function(){new f(-1)}))&&R((function(e){new f,new f(null),new f(1.5),new f(e)}),!0)||(f=n((function(e,n,r,i){var o;return l(e,f,c),_(n)?n instanceof G||"ArrayBuffer"==(o=w(n))||"SharedArrayBuffer"==o?void 0!==i?new v(n,Se(r,t),i):void 0!==r?new v(n,Se(r,t)):new v(n):be in n?ke(f,n):Ne.call(f,n):new v(g(n))})),$(y!==Function.prototype?x(v).concat(x(y)):x(v),(function(e){e in f||d(f,e,v[e])})),f.prototype=T,r||(T.constructor=f));var k=T[fe],A=!!k&&("values"==k.name||null==k.name),N=Fe.values;d(f,ge,!0),d(T,be,c),d(T,we,!0),d(T,ve,f),(u?new f(1)[me]==c:me in T)||W(T,me,{get:function(){return c}}),C[c]=f,a(a.G+a.W+a.F*(f!=v),C),a(a.S,c,{BYTES_PER_ELEMENT:t}),a(a.S+a.F*o((function(){v.of.call(f,1)})),c,{from:Ne,of:Le}),"BYTES_PER_ELEMENT"in T||d(T,"BYTES_PER_ELEMENT",t),a(a.P,c,Me),P(c),a(a.P+a.F*Te,c,{set:Pe}),a(a.P+a.F*!A,c,Fe),r||T.toString==de||(T.toString=de),a(a.P+a.F*o((function(){new f(1).slice()})),c,{slice:Re}),a(a.P+a.F*(o((function(){return[1,2].toLocaleString()!=new f([1,2]).toLocaleString()}))||!o((function(){T.toLocaleString.call([1,2])}))),c,{toLocaleString:Oe}),M[c]=A?k:N,r||A||d(T,fe,N)}}else e.exports=function(){}},T8I8:function(e,t){e.exports=/[ \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/},Wcq6:function(e,t,n){"use strict";var r,i=(r=n("wj3C"))&&"object"==typeof r&&"default"in r?r.default:r;i.registerVersion("firebase","7.6.1","app"),e.exports=i},"Y++M":function(e,t,n){"use strict";var r=n("DFzH"),i=n("dTG6"),o=n("kiRH");e.exports=function(e){for(var t=r(this),n=o(t.length),a=arguments.length,s=i(a>1?arguments[1]:void 0,n),u=a>2?arguments[2]:void 0,c=void 0===u?n:i(u,n);c>s;)t[s++]=e;return t}},"Y+gR":function(e,t,n){"use strict";var r=n("q1tI"),i=n.n(r),o=(n("HE/A"),n("VmWr"));t.a=function(e){var t=e.children;return i.a.createElement("div",{className:"headerimagewrapper"},i.a.createElement(o.a,{className:"imgwrapper"},i.a.createElement("div",{className:"preview"},t)),i.a.createElement("div",{className:"whitebackground"}))}},YtDf:function(e,t,n){"use strict";n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r,i=n("Ribc"),o=(r=i)&&r.__esModule?r:{default:r};t.default=o.default},YuTi:function(e,t,n){n("R48M"),e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},ZiRl:function(e,t,n){var r=n("P8UN");r(r.P,"String",{repeat:n("gd4K")})},Zs65:function(e,t,n){"use strict";n.r(t);n("NSPt")},bdgK:function(e,t,n){"use strict";(function(e){n("eMsz"),n("AqHK"),n("pS08"),n("U6Bt"),n("Ggvi"),n("OeI1"),n("sc67"),n("1dPr"),n("n7j8"),n("JHok"),n("R48M"),n("wZFJ"),n("rzGZ"),n("Dq+y"),n("8npG"),n("YbXK"),n("xJgp");var r=function(){if("undefined"!=typeof Map)return Map;function e(e,t){var n=-1;return e.some((function(e,r){return e[0]===t&&(n=r,!0)})),n}return function(){function t(){this.__entries__=[]}return Object.defineProperty(t.prototype,"size",{get:function(){return this.__entries__.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t){var n=e(this.__entries__,t),r=this.__entries__[n];return r&&r[1]},t.prototype.set=function(t,n){var r=e(this.__entries__,t);~r?this.__entries__[r][1]=n:this.__entries__.push([t,n])},t.prototype.delete=function(t){var n=this.__entries__,r=e(n,t);~r&&n.splice(r,1)},t.prototype.has=function(t){return!!~e(this.__entries__,t)},t.prototype.clear=function(){this.__entries__.splice(0)},t.prototype.forEach=function(e,t){void 0===t&&(t=null);for(var n=0,r=this.__entries__;n<r.length;n++){var i=r[n];e.call(t,i[1],i[0])}},t}()}(),i="undefined"!=typeof window&&"undefined"!=typeof document&&window.document===document,o=void 0!==e&&e.Math===Math?e:"undefined"!=typeof self&&self.Math===Math?self:"undefined"!=typeof window&&window.Math===Math?window:Function("return this")(),a="function"==typeof requestAnimationFrame?requestAnimationFrame.bind(o):function(e){return setTimeout((function(){return e(Date.now())}),1e3/60)},s=2;var u=20,c=["top","right","bottom","left","width","height","size","weight"],l="undefined"!=typeof MutationObserver,h=function(){function e(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=function(e,t){var n=!1,r=!1,i=0;function o(){n&&(n=!1,e()),r&&c()}function u(){a(o)}function c(){var e=Date.now();if(n){if(e-i<s)return;r=!0}else n=!0,r=!1,setTimeout(u,t);i=e}return c}(this.refresh.bind(this),u)}return e.prototype.addObserver=function(e){~this.observers_.indexOf(e)||this.observers_.push(e),this.connected_||this.connect_()},e.prototype.removeObserver=function(e){var t=this.observers_,n=t.indexOf(e);~n&&t.splice(n,1),!t.length&&this.connected_&&this.disconnect_()},e.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},e.prototype.updateObservers_=function(){var e=this.observers_.filter((function(e){return e.gatherActive(),e.hasActive()}));return e.forEach((function(e){return e.broadcastActive()})),e.length>0},e.prototype.connect_=function(){i&&!this.connected_&&(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),l?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},e.prototype.disconnect_=function(){i&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},e.prototype.onTransitionEnd_=function(e){var t=e.propertyName,n=void 0===t?"":t;c.some((function(e){return!!~n.indexOf(e)}))&&this.refresh()},e.getInstance=function(){return this.instance_||(this.instance_=new e),this.instance_},e.instance_=null,e}(),d=function(e,t){for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];Object.defineProperty(e,i,{value:t[i],enumerable:!1,writable:!1,configurable:!0})}return e},p=function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView||o},f=w(0,0,0,0);function m(e){return parseFloat(e)||0}function g(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return t.reduce((function(t,n){return t+m(e["border-"+n+"-width"])}),0)}function v(e){var t=e.clientWidth,n=e.clientHeight;if(!t&&!n)return f;var r=p(e).getComputedStyle(e),i=function(e){for(var t={},n=0,r=["top","right","bottom","left"];n<r.length;n++){var i=r[n],o=e["padding-"+i];t[i]=m(o)}return t}(r),o=i.left+i.right,a=i.top+i.bottom,s=m(r.width),u=m(r.height);if("border-box"===r.boxSizing&&(Math.round(s+o)!==t&&(s-=g(r,"left","right")+o),Math.round(u+a)!==n&&(u-=g(r,"top","bottom")+a)),!function(e){return e===p(e).document.documentElement}(e)){var c=Math.round(s+o)-t,l=Math.round(u+a)-n;1!==Math.abs(c)&&(s-=c),1!==Math.abs(l)&&(u-=l)}return w(i.left,i.top,s,u)}var y="undefined"!=typeof SVGGraphicsElement?function(e){return e instanceof p(e).SVGGraphicsElement}:function(e){return e instanceof p(e).SVGElement&&"function"==typeof e.getBBox};function b(e){return i?y(e)?function(e){var t=e.getBBox();return w(0,0,t.width,t.height)}(e):v(e):f}function w(e,t,n,r){return{x:e,y:t,width:n,height:r}}var _=function(){function e(e){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=w(0,0,0,0),this.target=e}return e.prototype.isActive=function(){var e=b(this.target);return this.contentRect_=e,e.width!==this.broadcastWidth||e.height!==this.broadcastHeight},e.prototype.broadcastRect=function(){var e=this.contentRect_;return this.broadcastWidth=e.width,this.broadcastHeight=e.height,e},e}(),C=function(e,t){var n,r,i,o,a,s,u,c=(r=(n=t).x,i=n.y,o=n.width,a=n.height,s="undefined"!=typeof DOMRectReadOnly?DOMRectReadOnly:Object,u=Object.create(s.prototype),d(u,{x:r,y:i,width:o,height:a,top:i,right:r+o,bottom:a+i,left:r}),u);d(this,{target:e,contentRect:c})},T=function(){function e(e,t,n){if(this.activeObservations_=[],this.observations_=new r,"function"!=typeof e)throw new TypeError("The callback provided as parameter 1 is not a function.");this.callback_=e,this.controller_=t,this.callbackCtx_=n}return e.prototype.observe=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof p(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)||(t.set(e,new _(e)),this.controller_.addObserver(this),this.controller_.refresh())}},e.prototype.unobserve=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof p(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)&&(t.delete(e),t.size||this.controller_.removeObserver(this))}},e.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},e.prototype.gatherActive=function(){var e=this;this.clearActive(),this.observations_.forEach((function(t){t.isActive()&&e.activeObservations_.push(t)}))},e.prototype.broadcastActive=function(){if(this.hasActive()){var e=this.callbackCtx_,t=this.activeObservations_.map((function(e){return new C(e.target,e.broadcastRect())}));this.callback_.call(e,t,e),this.clearActive()}},e.prototype.clearActive=function(){this.activeObservations_.splice(0)},e.prototype.hasActive=function(){return this.activeObservations_.length>0},e}(),S="undefined"!=typeof WeakMap?new WeakMap:new r,E=function e(t){if(!(this instanceof e))throw new TypeError("Cannot call a class as a function.");if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");var n=h.getInstance(),r=new T(t,n,this);S.set(this,r)};["observe","unobserve","disconnect"].forEach((function(e){E.prototype[e]=function(){var t;return(t=S.get(this))[e].apply(t,arguments)}}));var x=void 0!==o.ResizeObserver?o.ResizeObserver:E;t.a=x}).call(this,n("yLpj"))},cRJv:function(e,t,n){"use strict";var r=n("DFzH"),i=n("dTG6"),o=n("kiRH");e.exports=[].copyWithin||function(e,t){var n=r(this),a=o(n.length),s=i(e,a),u=i(t,a),c=arguments.length>2?arguments[2]:void 0,l=Math.min((void 0===c?a:i(c,a))-u,a-s),h=1;for(u<s&&s<u+l&&(h=-1,u+=l-1,s+=l-1);l-- >0;)u in n?n[s]=n[u]:delete n[s],s+=h,u+=h;return n}},cxuS:function(e,t,n){var r=n("P8UN"),i=n("ys0W")(!1);r(r.S,"Object",{values:function(e){return i(e)}})},ewoU:function(e,t,n){"use strict";var r=n("tuyV"),i=n("BjK0"),o=n("kiRH"),a=n("ot9L"),s=n("sOol")("isConcatSpreadable");e.exports=function e(t,n,u,c,l,h,d,p){for(var f,m,g=l,v=0,y=!!d&&a(d,p,3);v<c;){if(v in u){if(f=y?y(u[v],v,n):u[v],m=!1,i(f)&&(m=void 0!==(m=f[s])?!!m:r(f)),m&&h>0)g=e(t,n,f,o(f.length),g,h-1)-1;else{if(g>=9007199254740991)throw TypeError();t[g]=f}g++}v++}return g}},fFpS:function(e,t,n){"use strict";n.r(t);n("E5k/"),n("rzGZ"),n("Dq+y"),n("8npG"),n("HQAx"),n("zGcK"),n("sC2a"),n("YbXK"),n("cFtU"),n("HQhv"),n("sPse");var r=n("q1tI"),i=n.n(r),o=n("vRfx"),a=(n("UXi0"),n("zEh/")),s=n("if7W"),u=n("LvDl"),c=n("ARus"),l=n("h3sT"),h=n("KKAB"),d=function(e){var t=e.images,n=e.onAnnotationSelect,o=e.cur,d=(e.filter,e.folder,e.children),p=(e.onNewImage,e.onChange),f=e.current,m=(e.imageChildren,Object(r.useState)(!1)),g=(m[0],m[1],'https://phantomjscloud.com/api/browser/v2/ak-maw28-drn6m-zchk2-wx8yy-c5zgk/?request={url:"https://beta.videobakers.de/collaboration/all/?workspace='+o.public_id+'",renderType:"pdf",renderSettings:{pdfOptions:{ format: "A4",\nlandscape:true,\npreferCSSPageSize:true,\n }}}');return i.a.createElement("div",{className:"mygallery"},i.a.createElement("div",{className:"selection",id:"galleryselection"},t.length>=1&&i.a.createElement("div",{className:"filter"},"true"===localStorage.getItem("videobakersadmin")&&i.a.createElement(h.a,{promise:function(){return Object(a.a)({files:[g]},(function(e){return window.open(e.url,"_blank"),e}),"temp_download")}},"Kommentare herunterladen"),"true"===localStorage.getItem("videobakersadmin")&&i.a.createElement("select",{onChange:function(e){window.location="/collaboration/file/?workspace="+new URLSearchParams(window.location.search).get("workspace")+"&lang="+e.target.value},value:new URLSearchParams(window.location.search).get("lang")||"de"},i.a.createElement("option",{value:"de"},"Deutsch"),i.a.createElement("option",{value:"en"},"Englisch")),i.a.createElement(l.a,{onClick:function(){window.open(o.secure_url.replace("/upload/","/upload/fl_attachment/"),"_blank")}},"Datei Herunterladen")),t.map((function(e,t){var r=e.annotations.filter((function(e){return e.time>0}));Object(u.chain)(r).groupBy("time").mapValues((function(e){return Object(u.chain)(e).map("comment").flattenDeep()})).forEach((function(e){return console.log(e)}));return i.a.createElement("div",{key:e.public_id,id:e.public_id+"_as",className:"mygalleryimage"},i.a.createElement("img",{alt:"",key:t,className:f(e)?"selected":"",onClick:function(){return p(e)},src:e.src}),e.annotations.length>0&&i.a.createElement("p",{className:"badgeimage"},e.annotations.length),f(e)&&r.length>0&&i.a.createElement("div",{className:"comments"},r.map((function(e){return i.a.createElement("div",{key:e.comment,className:"onecomment "+(Object(c.b)(e,document.getElementsByTagName("video")[0])?"activecom":""),onClick:function(){n(e)}},s.a.annotator.second," ",Math.round(e.time),": ",e.comment)}))))}))),i.a.createElement("div",{className:"gallerydetail"},d))},p=n("0osF"),f=n("4w6A"),m=n.n(f);n("CARs"),n("pdi6");var g=n("Wcq6");n("6nsN"),n("5x/H");n.d(t,"firebaseConfig",(function(){return v})),n.d(t,"getFiles",(function(){return w}));var v={apiKey:"AIzaSyDcMPzTmFKGvIicPwY3D1gJ75eksjNbDQY",authDomain:"videobakers-53fbb.firebaseapp.com",databaseURL:"https://videobakers-53fbb.firebaseio.com",projectId:"videobakers-53fbb",storageBucket:"videobakers-53fbb.appspot.com",messagingSenderId:"872373535977",appId:"1:872373535977:web:e10a1f305054cf5d391c78",measurementId:"G-0GKSY6T98P"},y=function(e){var t,n;function r(){for(var t,n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return(t=e.call.apply(e,[this].concat(r))||this).state={images:[],current:{resource_type:"image",src:"https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif",annotations:[]}},t}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var a=r.prototype;return a.componentDidMount=function(){var e=this;"undefined"!=typeof window&&(document.onkeydown=function(t){t=t||window.event;var n=e.state.images.indexOf(e.state.images.filter((function(t){return t.public_id===e.state.current.public_id}))[0]);"38"==t.keyCode?e.loadImage(0===n?e.state.images[e.state.images.length-1]:e.state.images[n-1]):"40"==t.keyCode&&e.loadImage(e.state.images[(n+1)%e.state.images.length])},g.initializeApp(v),w((function(t){e.setState({images:t,all_images:t});var n=t.filter((function(e){return e.public_id===new URLSearchParams(window.location.search).get("workspace")}));e.loadImage(n.length>=1?n[0]:t[0])})))},a.loadImage=function(e){this.setState({current:e,time:null})},a.render=function(){var e=this;return i.a.createElement(p.a,null,i.a.createElement(d,{filter:function(t){return e.setState({images:e.state.all_images.filter((function(e){return e.annotations.length>=(t?0:1)}))})},onAnnotationSelect:function(t){document.getElementById(e.state.current.public_id+"_img").currentTime=t.time,e.forceUpdate()},folder:"undefined"!=typeof window&&new URLSearchParams(window.location.search).get("workspace").split("/")[0],current:function(t){return!!e.state.current&&t.public_id===e.state.current.public_id},onChange:function(t){return e.loadImage(t)},cur:this.state.current,images:this.state.images},i.a.createElement(o.a,{setAnnotations:function(t){e.state.current.annotations=t,e.forceUpdate()},setTime:function(t){return e.setState({time:t})},time:this.state.time,save:function(t,n){e.state.current.annotations=e.state.current.annotations.filter((function(e){return!!e.comment})),e.state.current.annotations.forEach((function(e){return e.id=Math.random()})),e.state.current.update(e.state.current.annotations),e.forceUpdate()},id:this.state.current.public_id,image:this.state.current})))},r}(i.a.Component);t.default=y;function b(e){console.log(JSON.stringify({meta:e.annotations,public_id:e.public_id,resource_type:e.resource_type}));var t=n("Wcq6");n("6nsN"),n("Zs65"),t.database().ref("files/"+(new URLSearchParams(window.location.search).get("lang")||"de")+"/"+e.public_id).set({meta:JSON.parse(JSON.stringify(e.annotations))})}function w(e,t){var r=new URLSearchParams(window.location.search).get("workspace").split("_idx_")[0],i=n("Wcq6");n("6nsN"),n("Zs65"),i.database().ref("/files/"+(new URLSearchParams(window.location.search).get("lang")||"de")+"/"+r).once("value").then((function(n){fetch("/api/all?folder="+r).then((function(e){return e.json()})).then((function(r){if(r.resources.length<=0)m()({text:"There are currently no files in this workspace. It may take some time till all files are present after upload. Try again in 2 Minutes."}).showToast({duration:6e4});else{var i=Array.from(r.resources).map((function(e){return e.src=e.secure_url.replace(".mp4",".jpg"),e.annotations=n.val()&&n.val().meta?n.val().meta:[],e.annotations.forEach((function(e){return e.id=Math.random()})),e.annotations=e.annotations.sort((function(e,t){return e.time-t.time})),e.update=function(t){e.annotations=t,b(e)},e}));i=i.flatMap((function(e){return console.log(e.pages>=1),e.pages>=1?Array.from(Array(e.pages).keys()).map((function(t){var n=t+1;return Object.assign({},e,{public_id:e.public_id+"_idx_"+n,src:e.secure_url.replace("https://res.cloudinary.com/hvioxpubt/image/upload/","https://res.cloudinary.com/hvioxpubt/image/upload/pg_"+n+"/").replace(".pdf",".jpg"),annotations:e.annotations.filter((function(e){return e.page===n})),update:function(t){e.annotations=e.annotations.filter((function(e){return e.page!==n})).concat(t.map((function(e){return Object.assign({},e,{page:n})}))),console.log(e),b(e)}})})):[e]})),t&&(console.log(i),i=i.flatMap((function(e){return console.log("transofrming videos"),"video"===e.resource_type?e.annotations.map((function(t){var n="https://res.cloudinary.com/hvioxpubt/video/upload/so_"+t.time+",eo_"+t.time+"/"+e.public_id+".jpg";return{public_id:e.public_id+t.time+t.x+t.y,secure_url:n,src:n,resource_type:"image",annotations:[Object.assign({},t,{time:null})]}})):[e]}))),console.log(i),e(i)}}))}))}},fKCf:function(e,t){e.exports=/[!-#%-\*,-\/:;\?@\[-\]_\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166D\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4E\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]/},gBT9:function(e,t,n){var r=n("BjK0"),i=Math.floor;e.exports=function(e){return!r(e)&&isFinite(e)&&i(e)===e}},gd4K:function(e,t,n){"use strict";var r=n("1Llc"),i=n("ap2Z");e.exports=function(e){var t=String(i(this)),n="",o=r(e);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(t+=t))1&o&&(n+=t);return n}},gx6d:function(e,t,n){var r=n("1Llc"),i=n("kiRH");e.exports=function(e){if(void 0===e)return 0;var t=r(e),n=i(t);if(t!==n)throw RangeError("Wrong length!");return n}},iuFa:function(e,t,n){var r=n("P8UN");r(r.S,"Number",{isNaN:function(e){return e!=e}})},jTPX:function(e,t,n){n("sC2a");e.exports=function(e,t,n){return((n=window.getComputedStyle)?n(e):e.currentStyle)[t.replace(/-(\w)/gi,(function(e,t){return t.toUpperCase()}))]}},lizw:function(e,t,n){"use strict";var r=n("P8UN"),i=n("pTxf"),o=n("CL53"),a=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);r(r.P+r.F*a,"String",{padStart:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0,!0)}})},m5Zt:function(e,t,n){var r=n("P8UN");r(r.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},mN2Q:function(e,t,n){n("8rVx")(n("CnIf"))},mrSG:function(e,t,n){"use strict";n.r(t),n.d(t,"__extends",(function(){return i})),n.d(t,"__assign",(function(){return o})),n.d(t,"__rest",(function(){return a})),n.d(t,"__decorate",(function(){return s})),n.d(t,"__param",(function(){return u})),n.d(t,"__metadata",(function(){return c})),n.d(t,"__awaiter",(function(){return l})),n.d(t,"__generator",(function(){return h})),n.d(t,"__exportStar",(function(){return d})),n.d(t,"__values",(function(){return p})),n.d(t,"__read",(function(){return f})),n.d(t,"__spread",(function(){return m})),n.d(t,"__spreadArrays",(function(){return g})),n.d(t,"__await",(function(){return v})),n.d(t,"__asyncGenerator",(function(){return y})),n.d(t,"__asyncDelegator",(function(){return b})),n.d(t,"__asyncValues",(function(){return w})),n.d(t,"__makeTemplateObject",(function(){return _})),n.d(t,"__importStar",(function(){return C})),n.d(t,"__importDefault",(function(){return T}));n("rzGZ"),n("m210"),n("6kNP"),n("8npG"),n("R48M"),n("4DPX"),n("sc67"),n("E5k/"),n("pS08"),n("LagC");var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var o=function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function a(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}function s(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,n,a):i(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a}function u(e,t){return function(n,r){t(n,r,e)}}function c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function h(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function d(e,t){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}function p(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function f(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function m(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(f(arguments[t]));return e}function g(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}function v(e){return this instanceof v?(this.v=e,this):new v(e)}function y(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||s(e,t)}))})}function s(e,t){try{(n=i[e](t)).value instanceof v?Promise.resolve(n.value.v).then(u,c):l(o[0][2],n)}catch(r){l(o[0][3],r)}var n}function u(e){s("next",e)}function c(e){s("throw",e)}function l(e,t){e(t),o.shift(),o.length&&s(o[0][0],o[0][1])}}function b(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:v(e[r](t)),done:"return"===r}:i?i(t):t}:i}}function w(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=p(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function _(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function C(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function T(e){return e&&e.__esModule?e:{default:e}}},n0hJ:function(e,t,n){var r=n("P8UN");r(r.P,"Array",{fill:n("Y++M")}),n("Dq1/")("fill")},niph:function(e,t,n){n("8rVx")(n("25EJ"))},nwhY:function(e,t,n){"use strict";n.r(t);var r=n("q1tI"),i=n.n(r),o=n("n+i3"),a=n("+tgB"),s=n("kEfx"),u=n("Y+gR"),c=n("HYt3"),l=n("I3Kv"),h=n("if7W");var d=function(e){var t,n;function r(){return e.apply(this,arguments)||this}return n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,r.prototype.render=function(){return i.a.createElement("div",{className:"textasd"},i.a.createElement(o.a,{reverse:!0},i.a.createElement(a.a,{title:h.a.collaboration.text.meta.title,description:h.a.collaboration.text.meta.description}),i.a.createElement(s.a,{title:h.a.collaboration.text.header.title,subtitle:h.a.collaboration.text.header.subtitle},i.a.createElement(u.a,null,i.a.createElement(c.a,null),i.a.createElement(l.a,null)))))},r}(i.a.Component);t.default=d},p7ys:function(e,t){e.exports=/[\0-\x1F\x7F-\x9F]/},pQ2P:function(e,t,n){var r=n("P8UN"),i=n("J6QO");r(r.P+r.F*(Date.prototype.toISOString!==i),"Date",{toISOString:i})},pTxf:function(e,t,n){var r=n("kiRH"),i=n("gd4K"),o=n("ap2Z");e.exports=function(e,t,n,a){var s=String(o(e)),u=s.length,c=void 0===n?" ":String(n),l=r(t);if(l<=u||""==c)return s;var h=l-u,d=i.call(c,Math.ceil(h/c.length));return d.length>h&&(d=d.slice(0,h)),a?d+s:s+d}},pncC:function(e,t,n){var r=n("P8UN");r(r.S,"Number",{isInteger:n("gBT9")})},"q/0M":function(e,t,n){"use strict";n.r(t),n.d(t,"LogLevel",(function(){return i})),n.d(t,"Logger",(function(){return u})),n.d(t,"setLogLevel",(function(){return c}));n("JHok"),n("R48M"),n("pJf4"),n("pQ2P");function r(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}var i,o=[];!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(i||(i={}));var a=i.INFO,s=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];if(!(t<e.logLevel)){var a=(new Date).toISOString();switch(t){case i.DEBUG:case i.VERBOSE:console.log.apply(console,r(["["+a+"]  "+e.name+":"],n));break;case i.INFO:console.info.apply(console,r(["["+a+"]  "+e.name+":"],n));break;case i.WARN:console.warn.apply(console,r(["["+a+"]  "+e.name+":"],n));break;case i.ERROR:console.error.apply(console,r(["["+a+"]  "+e.name+":"],n));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+t+")")}}},u=function(){function e(e){this.name=e,this._logLevel=a,this._logHandler=s,o.push(this)}return Object.defineProperty(e.prototype,"logLevel",{get:function(){return this._logLevel},set:function(e){if(!(e in i))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"logHandler",{get:function(){return this._logHandler},set:function(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e},enumerable:!0,configurable:!0}),e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,r([this,i.DEBUG],e))},e.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,r([this,i.VERBOSE],e))},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,r([this,i.INFO],e))},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,r([this,i.WARN],e))},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._logHandler.apply(this,r([this,i.ERROR],e))},e}();function c(e){o.forEach((function(t){t.logLevel=e}))}},qhky:function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));n("MIFh"),n("wZFJ"),n("rzGZ"),n("Dq+y"),n("8npG"),n("Ggvi"),n("JHok"),n("LagC"),n("pS08"),n("sc67"),n("R48M"),n("E5k/");var r=n("q1tI"),i=n.n(r),o=n("17x9"),a=n.n(o),s=n("8+s/"),u=n.n(s),c=n("bmMU"),l=n.n(c),h=n("J7Mx"),d=n("MZZl"),p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function m(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}var g,v,y,b=u()(h.d,h.b,h.c)((function(){return null})),w=(g=b,y=v=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.shouldComponentUpdate=function(e){return!l()(this.props,e)},t.prototype.mapNestedChildrenToProps=function(e,t){if(!t)return null;switch(e.type){case d.g.SCRIPT:case d.g.NOSCRIPT:return{innerHTML:t};case d.g.STYLE:return{cssText:t}}throw new Error("<"+e.type+" /> elements are self-closing and can not contain children. Refer to our API for more information.")},t.prototype.flattenArrayTypeChildren=function(e){var t,n=e.child,r=e.arrayTypeChildren,i=e.newChildProps,o=e.nestedChildren;return p({},r,((t={})[n.type]=[].concat(r[n.type]||[],[p({},i,this.mapNestedChildrenToProps(n,o))]),t))},t.prototype.mapObjectTypeChildren=function(e){var t,n,r=e.child,i=e.newProps,o=e.newChildProps,a=e.nestedChildren;switch(r.type){case d.g.TITLE:return p({},i,((t={})[r.type]=a,t.titleAttributes=p({},o),t));case d.g.BODY:return p({},i,{bodyAttributes:p({},o)});case d.g.HTML:return p({},i,{htmlAttributes:p({},o)})}return p({},i,((n={})[r.type]=p({},o),n))},t.prototype.mapArrayTypeChildrenToProps=function(e,t){var n=p({},t);return Object.keys(e).forEach((function(t){var r;n=p({},n,((r={})[t]=e[t],r))})),n},t.prototype.warnOnInvalidChildren=function(e,t){return!0},t.prototype.mapChildrenToProps=function(e,t){var n=this,r={};return i.a.Children.forEach(e,(function(e){if(e&&e.props){var i=e.props,o=i.children,a=m(i,["children"]),s=Object(h.a)(a);switch(n.warnOnInvalidChildren(e,o),e.type){case d.g.LINK:case d.g.META:case d.g.NOSCRIPT:case d.g.SCRIPT:case d.g.STYLE:r=n.flattenArrayTypeChildren({child:e,arrayTypeChildren:r,newChildProps:s,nestedChildren:o});break;default:t=n.mapObjectTypeChildren({child:e,newProps:t,newChildProps:s,nestedChildren:o})}}})),t=this.mapArrayTypeChildrenToProps(r,t)},t.prototype.render=function(){var e=this.props,t=e.children,n=m(e,["children"]),r=p({},n);return t&&(r=this.mapChildrenToProps(t,r)),i.a.createElement(g,r)},f(t,null,[{key:"canUseDOM",set:function(e){g.canUseDOM=e}}]),t}(i.a.Component),v.propTypes={base:a.a.object,bodyAttributes:a.a.object,children:a.a.oneOfType([a.a.arrayOf(a.a.node),a.a.node]),defaultTitle:a.a.string,defer:a.a.bool,encodeSpecialCharacters:a.a.bool,htmlAttributes:a.a.object,link:a.a.arrayOf(a.a.object),meta:a.a.arrayOf(a.a.object),noscript:a.a.arrayOf(a.a.object),onChangeClientState:a.a.func,script:a.a.arrayOf(a.a.object),style:a.a.arrayOf(a.a.object),title:a.a.string,titleAttributes:a.a.object,titleTemplate:a.a.string},v.defaultProps={defer:!0,encodeSpecialCharacters:!0},v.peek=g.peek,v.rewind=function(){var e=g.rewind();return e||(e=Object(h.c)({baseTag:[],bodyAttributes:{},encodeSpecialCharacters:!0,htmlAttributes:{},linkTags:[],metaTags:[],noscriptTags:[],scriptTags:[],styleTags:[],title:"",titleAttributes:{}})),e},y);w.renderStatic=w.rewind},sRdV:function(e,t,n){"use strict";e.exports=function(e){var t={};t.src_Any=n("y8fO").source,t.src_Cc=n("p7ys").source,t.src_Z=n("T8I8").source,t.src_P=n("fKCf").source,t.src_ZPCc=[t.src_Z,t.src_P,t.src_Cc].join("|"),t.src_ZCc=[t.src_Z,t.src_Cc].join("|");return t.src_pseudo_letter="(?:(?![><｜]|"+t.src_ZPCc+")"+t.src_Any+")",t.src_ip4="(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",t.src_auth="(?:(?:(?!"+t.src_ZCc+"|[@/\\[\\]()]).)+@)?",t.src_port="(?::(?:6(?:[0-4]\\d{3}|5(?:[0-4]\\d{2}|5(?:[0-2]\\d|3[0-5])))|[1-5]?\\d{1,4}))?",t.src_host_terminator="(?=$|[><｜]|"+t.src_ZPCc+")(?!-|_|:\\d|\\.-|\\.(?!$|"+t.src_ZPCc+"))",t.src_path="(?:[/?#](?:(?!"+t.src_ZCc+"|[><｜]|[()[\\]{}.,\"'?!\\-]).|\\[(?:(?!"+t.src_ZCc+"|\\]).)*\\]|\\((?:(?!"+t.src_ZCc+"|[)]).)*\\)|\\{(?:(?!"+t.src_ZCc+'|[}]).)*\\}|\\"(?:(?!'+t.src_ZCc+'|["]).)+\\"|\\\'(?:(?!'+t.src_ZCc+"|[']).)+\\'|\\'(?="+t.src_pseudo_letter+"|[-]).|\\.{2,4}[a-zA-Z0-9%/]|\\.(?!"+t.src_ZCc+"|[.]).|"+(e&&e["---"]?"\\-(?!--(?:[^-]|$))(?:-*)|":"\\-+|")+"\\,(?!"+t.src_ZCc+").|\\!(?!"+t.src_ZCc+"|[!]).|\\?(?!"+t.src_ZCc+"|[?]).)+|\\/)?",t.src_email_name='[\\-;:&=\\+\\$,\\.a-zA-Z0-9_][\\-;:&=\\+\\$,\\"\\.a-zA-Z0-9_]*',t.src_xn="xn--[a-z0-9\\-]{1,59}",t.src_domain_root="(?:"+t.src_xn+"|"+t.src_pseudo_letter+"{1,63})",t.src_domain="(?:"+t.src_xn+"|(?:"+t.src_pseudo_letter+")|(?:"+t.src_pseudo_letter+"(?:-|"+t.src_pseudo_letter+"){0,61}"+t.src_pseudo_letter+"))",t.src_host="(?:(?:(?:(?:"+t.src_domain+")\\.)*"+t.src_domain+"))",t.tpl_host_fuzzy="(?:"+t.src_ip4+"|(?:(?:(?:"+t.src_domain+")\\.)+(?:%TLDS%)))",t.tpl_host_no_ip_fuzzy="(?:(?:(?:"+t.src_domain+")\\.)+(?:%TLDS%))",t.src_host_strict=t.src_host+t.src_host_terminator,t.tpl_host_fuzzy_strict=t.tpl_host_fuzzy+t.src_host_terminator,t.src_host_port_strict=t.src_host+t.src_port+t.src_host_terminator,t.tpl_host_port_fuzzy_strict=t.tpl_host_fuzzy+t.src_port+t.src_host_terminator,t.tpl_host_port_no_ip_fuzzy_strict=t.tpl_host_no_ip_fuzzy+t.src_port+t.src_host_terminator,t.tpl_host_fuzzy_test="localhost|www\\.|\\.\\d{1,3}\\.|(?:\\.(?:%TLDS%)(?:"+t.src_ZPCc+"|>|$))",t.tpl_email_fuzzy='(^|[><｜]|"|\\(|'+t.src_ZCc+")("+t.src_email_name+"@"+t.tpl_host_fuzzy_strict+")",t.tpl_link_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+t.src_ZPCc+"))((?![$+<=>^`|｜])"+t.tpl_host_port_fuzzy_strict+t.src_path+")",t.tpl_link_no_ip_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+t.src_ZPCc+"))((?![$+<=>^`|｜])"+t.tpl_host_port_no_ip_fuzzy_strict+t.src_path+")",t}},t6oF:function(e,t,n){"use strict";(function(e){n("6kNP"),n("6nXr"),n("klQ5"),n("rzGZ"),n("Dq+y"),n("CtJk"),n("Ml7+"),n("nMRu"),n("zGcK"),n("lFjb"),n("Ll4R"),n("YBKJ"),n("DrhF"),n("HXzo"),n("sC2a"),n("wZFJ"),n("AqHK"),n("JHok"),n("pJf4"),n("1dPr"),n("sc67"),n("n7j8"),n("q8oJ"),n("C9fy"),n("8npG"),n("m210"),n("4DPX"),n("HQhv"),n("R48M"),n("+ar0");var t=n("wj3C"),r=n.n(t);(function(){var t,n="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){e!=Array.prototype&&e!=Object.prototype&&(e[t]=n.value)},i="undefined"!=typeof window&&window===this?this:void 0!==e&&null!=e?e:this;function o(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}function a(e){var t="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return t?t.call(e):{next:o(e)}}!function(e,t){if(t){var r=i;e=e.split(".");for(var o=0;o<e.length-1;o++){var a=e[o];a in r||(r[a]={}),r=r[a]}(t=t(o=r[e=e[e.length-1]]))!=o&&null!=t&&n(r,e,{configurable:!0,writable:!0,value:t})}}("Promise",(function(e){function t(e){this.b=0,this.c=void 0,this.a=[];var t=this.f();try{e(t.resolve,t.reject)}catch(n){t.reject(n)}}function n(){this.a=null}function r(e){return e instanceof t?e:new t((function(t){t(e)}))}if(e)return e;n.prototype.b=function(e){if(null==this.a){this.a=[];var t=this;this.c((function(){t.g()}))}this.a.push(e)};var o=i.setTimeout;n.prototype.c=function(e){o(e,0)},n.prototype.g=function(){for(;this.a&&this.a.length;){var e=this.a;this.a=[];for(var t=0;t<e.length;++t){var n=e[t];e[t]=null;try{n()}catch(r){this.f(r)}}}this.a=null},n.prototype.f=function(e){this.c((function(){throw e}))},t.prototype.f=function(){function e(e){return function(r){n||(n=!0,e.call(t,r))}}var t=this,n=!1;return{resolve:e(this.m),reject:e(this.g)}},t.prototype.m=function(e){if(e===this)this.g(new TypeError("A Promise cannot resolve to itself"));else if(e instanceof t)this.o(e);else{e:switch(typeof e){case"object":var n=null!=e;break e;case"function":n=!0;break e;default:n=!1}n?this.u(e):this.h(e)}},t.prototype.u=function(e){var t=void 0;try{t=e.then}catch(n){return void this.g(n)}"function"==typeof t?this.v(t,e):this.h(e)},t.prototype.g=function(e){this.i(2,e)},t.prototype.h=function(e){this.i(1,e)},t.prototype.i=function(e,t){if(0!=this.b)throw Error("Cannot settle("+e+", "+t+"): Promise already settled in state"+this.b);this.b=e,this.c=t,this.l()},t.prototype.l=function(){if(null!=this.a){for(var e=0;e<this.a.length;++e)s.b(this.a[e]);this.a=null}};var s=new n;return t.prototype.o=function(e){var t=this.f();e.La(t.resolve,t.reject)},t.prototype.v=function(e,t){var n=this.f();try{e.call(t,n.resolve,n.reject)}catch(r){n.reject(r)}},t.prototype.then=function(e,n){function r(e,t){return"function"==typeof e?function(t){try{i(e(t))}catch(n){o(n)}}:t}var i,o,a=new t((function(e,t){i=e,o=t}));return this.La(r(e,i),r(n,o)),a},t.prototype.catch=function(e){return this.then(void 0,e)},t.prototype.La=function(e,t){function n(){switch(r.b){case 1:e(r.c);break;case 2:t(r.c);break;default:throw Error("Unexpected state: "+r.b)}}var r=this;null==this.a?s.b(n):this.a.push(n)},t.resolve=r,t.reject=function(e){return new t((function(t,n){n(e)}))},t.race=function(e){return new t((function(t,n){for(var i=a(e),o=i.next();!o.done;o=i.next())r(o.value).La(t,n)}))},t.all=function(e){var n=a(e),i=n.next();return i.done?r([]):new t((function(e,t){function o(t){return function(n){a[t]=n,0==--s&&e(a)}}var a=[],s=0;do{a.push(void 0),s++,r(i.value).La(o(a.length-1),t),i=n.next()}while(!i.done)}))},t}));var s=s||{},u=this||self;function c(e){return"string"==typeof e}function l(e){return"boolean"==typeof e}var h=/^[\w+/_-]+[=]{0,2}$/,d=null;function p(){}function f(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var n=Object.prototype.toString.call(e);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof e.length&&void 0!==e.splice&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==e.call&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===e.call)return"object";return t}function m(e){return null===e}function g(e){return"array"==f(e)}function v(e){var t=f(e);return"array"==t||"object"==t&&"number"==typeof e.length}function y(e){return"function"==f(e)}function b(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var w="closure_uid_"+(1e9*Math.random()>>>0),_=0;function C(e,t,n){return e.call.apply(e.bind,arguments)}function T(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function S(e,t,n){return(S=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?C:T).apply(null,arguments)}function E(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var x=Date.now||function(){return+new Date};function I(e,t){function n(){}n.prototype=t.prototype,e.qb=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.gd=function(e,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return t.prototype[n].apply(e,i)}}function k(e){if(!e)return!1;try{return!!e.$goog_Thenable}catch(t){return!1}}function A(e){if(Error.captureStackTrace)Error.captureStackTrace(this,A);else{var t=Error().stack;t&&(this.stack=t)}e&&(this.message=String(e))}function N(e,t){for(var n="",r=(e=e.split("%s")).length-1,i=0;i<r;i++)n+=e[i]+(i<t.length?t[i]:"%s");A.call(this,n+e[r])}function L(e,t){throw new N("Failure"+(e?": "+e:""),Array.prototype.slice.call(arguments,1))}function D(e,t){this.c=e,this.f=t,this.b=0,this.a=null}function O(e,t){e.f(t),100>e.b&&(e.b++,t.next=e.a,e.a=t)}function M(){this.b=this.a=null}I(A,Error),A.prototype.name="CustomError",I(N,A),N.prototype.name="AssertionError",D.prototype.get=function(){if(0<this.b){this.b--;var e=this.a;this.a=e.next,e.next=null}else e=this.c();return e};var R=new D((function(){return new F}),(function(e){e.reset()}));function P(){var e=ze,t=null;return e.a&&(t=e.a,e.a=e.a.next,e.a||(e.b=null),t.next=null),t}function F(){this.next=this.b=this.a=null}function j(e,t){e:{try{var n=e&&e.ownerDocument,r=n&&(n.defaultView||n.parentWindow);if((r=r||u).Element&&r.Location){var i=r;break e}}catch(a){}i=null}if(i&&void 0!==i[t]&&(!e||!(e instanceof i[t])&&(e instanceof i.Location||e instanceof i.Element))){if(b(e))try{var o=e.constructor.displayName||e.constructor.name||Object.prototype.toString.call(e)}catch(a){o="<object could not be stringified>"}else o=void 0===e?"undefined":null===e?"null":typeof e;L("Argument is not a %s (or a non-Element, non-Location mock); got: %s",t,o)}}M.prototype.add=function(e,t){var n=R.get();n.set(e,t),this.b?this.b.next=n:this.a=n,this.b=n},F.prototype.set=function(e,t){this.a=e,this.b=t,this.next=null},F.prototype.reset=function(){this.next=this.b=this.a=null};var B=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if(c(e))return c(t)&&1==t.length?e.indexOf(t,0):-1;for(var n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},V=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){for(var r=e.length,i=c(e)?e.split(""):e,o=0;o<r;o++)o in i&&t.call(n,i[o],o,e)};var W=Array.prototype.map?function(e,t){return Array.prototype.map.call(e,t,void 0)}:function(e,t){for(var n=e.length,r=Array(n),i=c(e)?e.split(""):e,o=0;o<n;o++)o in i&&(r[o]=t.call(void 0,i[o],o,e));return r},U=Array.prototype.some?function(e,t){return Array.prototype.some.call(e,t,void 0)}:function(e,t){for(var n=e.length,r=c(e)?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e))return!0;return!1};function H(e,t){return 0<=B(e,t)}function z(e,t){var n;return(n=0<=(t=B(e,t)))&&Array.prototype.splice.call(e,t,1),n}function q(e,t){!function(e,t){for(var n=c(e)?e.split(""):e,r=e.length-1;0<=r;--r)r in n&&t.call(void 0,n[r],r,e)}(e,(function(n,r){t.call(void 0,n,r,e)&&1==Array.prototype.splice.call(e,r,1).length&&0}))}function K(e){return Array.prototype.concat.apply([],arguments)}function G(e){var t=e.length;if(0<t){for(var n=Array(t),r=0;r<t;r++)n[r]=e[r];return n}return[]}function Q(e,t){for(var n in e)t.call(void 0,e[n],n,e)}function $(e){for(var t in e)return!1;return!0}function Y(e){var t,n={};for(t in e)n[t]=e[t];return n}var X="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function J(e,t){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])e[n]=r[n];for(var o=0;o<X.length;o++)n=X[o],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Z(e,t){this.a=e===ne&&t||"",this.b=te}function ee(e){return e instanceof Z&&e.constructor===Z&&e.b===te?e.a:(L("expected object of type Const, got '"+e+"'"),"type_error:Const")}Z.prototype.qa=!0,Z.prototype.pa=function(){return this.a},Z.prototype.toString=function(){return"Const{"+this.a+"}"};var te={},ne={},re=new Z(ne,"");function ie(){this.a="",this.b=ce}function oe(e){return e instanceof ie&&e.constructor===ie&&e.b===ce?e.a:(L("expected object of type TrustedResourceUrl, got '"+e+"' of type "+f(e)),"type_error:TrustedResourceUrl")}function ae(e,t){var n=ee(e);if(!ue.test(n))throw Error("Invalid TrustedResourceUrl format: "+n);return le(e=n.replace(se,(function(e,r){if(!Object.prototype.hasOwnProperty.call(t,r))throw Error('Found marker, "'+r+'", in format string, "'+n+'", but no valid label mapping found in args: '+JSON.stringify(t));return(e=t[r])instanceof Z?ee(e):encodeURIComponent(String(e))})))}ie.prototype.qa=!0,ie.prototype.pa=function(){return this.a.toString()},ie.prototype.toString=function(){return"TrustedResourceUrl{"+this.a+"}"};var se=/%{(\w+)}/g,ue=/^((https:)?\/\/[0-9a-z.:[\]-]+\/|\/[^/\\]|[^:/\\%]+\/|[^:/\\%]*[?#]|about:blank#)/i,ce={};function le(e){var t=new ie;return t.a=e,t}var he=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]},de=/&/g,pe=/</g,fe=/>/g,me=/"/g,ge=/'/g,ve=/\x00/g,ye=/[\x00&<>"']/;function be(e,t){return-1!=e.indexOf(t)}function we(e,t){return e<t?-1:e>t?1:0}function _e(){this.a="",this.b=xe}function Ce(e){return e instanceof _e&&e.constructor===_e&&e.b===xe?e.a:(L("expected object of type SafeUrl, got '"+e+"' of type "+f(e)),"type_error:SafeUrl")}_e.prototype.qa=!0,_e.prototype.pa=function(){return this.a.toString()},_e.prototype.toString=function(){return"SafeUrl{"+this.a+"}"};var Te=/^(?:(?:https?|mailto|ftp):|[^:/?#]*(?:[/?#]|$))/i;function Se(e){return e instanceof _e?e:(e="object"==typeof e&&e.qa?e.pa():String(e),Te.test(e)||(e="about:invalid#zClosurez"),Ie(e))}var Ee,xe={};function Ie(e){var t=new _e;return t.a=e,t}Ie("about:blank");e:{var ke=u.navigator;if(ke){var Ae=ke.userAgent;if(Ae){Ee=Ae;break e}}Ee=""}function Ne(e){return be(Ee,e)}function Le(){this.a="",this.b=Oe}function De(e){return e instanceof Le&&e.constructor===Le&&e.b===Oe?e.a:(L("expected object of type SafeHtml, got '"+e+"' of type "+f(e)),"type_error:SafeHtml")}Le.prototype.qa=!0,Le.prototype.pa=function(){return this.a.toString()},Le.prototype.toString=function(){return"SafeHtml{"+this.a+"}"};var Oe={};function Me(e){var t=new Le;return t.a=e,t}Me("<!DOCTYPE html>");var Re,Pe,Fe=Me("");function je(e,t){for(var n=e.split("%s"),r="",i=Array.prototype.slice.call(arguments,1);i.length&&1<n.length;)r+=n.shift()+i.shift();return r+n.join("%s")}function Be(e){return ye.test(e)&&(-1!=e.indexOf("&")&&(e=e.replace(de,"&amp;")),-1!=e.indexOf("<")&&(e=e.replace(pe,"&lt;")),-1!=e.indexOf(">")&&(e=e.replace(fe,"&gt;")),-1!=e.indexOf('"')&&(e=e.replace(me,"&quot;")),-1!=e.indexOf("'")&&(e=e.replace(ge,"&#39;")),-1!=e.indexOf("\0")&&(e=e.replace(ve,"&#0;"))),e}function Ve(e){u.setTimeout((function(){throw e}),0)}function We(){var e=u.MessageChannel;if(void 0===e&&"undefined"!=typeof window&&window.postMessage&&window.addEventListener&&!Ne("Presto")&&(e=function(){var e=document.createElement("IFRAME");e.style.display="none",function(e){var t=le(ee(re));j(e,"HTMLIFrameElement"),e.src=oe(t).toString()}(e),document.documentElement.appendChild(e);var t=e.contentWindow;(e=t.document).open(),e.write(De(Fe)),e.close();var n="callImmediate"+Math.random(),r="file:"==t.location.protocol?"*":t.location.protocol+"//"+t.location.host;e=S((function(e){"*"!=r&&e.origin!=r||e.data!=n||this.port1.onmessage()}),this),t.addEventListener("message",e,!1),this.port1={},this.port2={postMessage:function(){t.postMessage(n,r)}}}),void 0!==e&&!Ne("Trident")&&!Ne("MSIE")){var t=new e,n={},r=n;return t.port1.onmessage=function(){if(void 0!==n.next){var e=(n=n.next).yb;n.yb=null,e()}},function(e){r.next={yb:e},r=r.next,t.port2.postMessage(0)}}return"undefined"!=typeof document&&"onreadystatechange"in document.createElement("SCRIPT")?function(e){var t=document.createElement("SCRIPT");t.onreadystatechange=function(){t.onreadystatechange=null,t.parentNode.removeChild(t),t=null,e(),e=null},document.documentElement.appendChild(t)}:function(e){u.setTimeout(e,0)}}function Ue(e,t){Pe||function(){if(u.Promise&&u.Promise.resolve){var e=u.Promise.resolve(void 0);Pe=function(){e.then(qe)}}else Pe=function(){var e=qe;!y(u.setImmediate)||u.Window&&u.Window.prototype&&!Ne("Edge")&&u.Window.prototype.setImmediate==u.setImmediate?(Re||(Re=We()),Re(e)):u.setImmediate(e)}}(),He||(Pe(),He=!0),ze.add(e,t)}Me("<br>");var He=!1,ze=new M;function qe(){for(var e;e=P();){try{e.a.call(e.b)}catch(t){Ve(t)}O(R,e)}He=!1}function Ke(e,t){if(this.a=Ge,this.i=void 0,this.f=this.b=this.c=null,this.g=this.h=!1,e!=p)try{var n=this;e.call(t,(function(e){ot(n,Qe,e)}),(function(e){if(!(e instanceof dt))try{if(e instanceof Error)throw e;throw Error("Promise rejected.")}catch(t){}ot(n,$e,e)}))}catch(r){ot(this,$e,r)}}var Ge=0,Qe=2,$e=3;function Ye(){this.next=this.f=this.b=this.g=this.a=null,this.c=!1}Ye.prototype.reset=function(){this.f=this.b=this.g=this.a=null,this.c=!1};var Xe=new D((function(){return new Ye}),(function(e){e.reset()}));function Je(e,t,n){var r=Xe.get();return r.g=e,r.b=t,r.f=n,r}function Ze(e){if(e instanceof Ke)return e;var t=new Ke(p);return ot(t,Qe,e),t}function et(e){return new Ke((function(t,n){n(e)}))}function tt(e,t,n){at(e,t,n,null)||Ue(E(t,e))}function nt(e){return new Ke((function(t){var n=e.length,r=[];if(n)for(var i=function(e,i,o){n--,r[e]=i?{Gb:!0,value:o}:{Gb:!1,reason:o},0==n&&t(r)},o=0;o<e.length;o++)tt(e[o],E(i,o,!0),E(i,o,!1));else t(r)}))}function rt(e,t){e.b||e.a!=Qe&&e.a!=$e||st(e),e.f?e.f.next=t:e.b=t,e.f=t}function it(e,t,n,r){var i=Je(null,null,null);return i.a=new Ke((function(e,o){i.g=t?function(n){try{var i=t.call(r,n);e(i)}catch(a){o(a)}}:e,i.b=n?function(t){try{var i=n.call(r,t);void 0===i&&t instanceof dt?o(t):e(i)}catch(a){o(a)}}:o})),i.a.c=e,rt(e,i),i.a}function ot(e,t,n){e.a==Ge&&(e===n&&(t=$e,n=new TypeError("Promise cannot resolve to itself")),e.a=1,at(n,e.Oc,e.Pc,e)||(e.i=n,e.a=t,e.c=null,st(e),t!=$e||n instanceof dt||function(e,t){e.g=!0,Ue((function(){e.g&&ht.call(null,t)}))}(e,n)))}function at(e,t,n,r){if(e instanceof Ke)return rt(e,Je(t||p,n||null,r)),!0;if(k(e))return e.then(t,n,r),!0;if(b(e))try{var i=e.then;if(y(i))return function(e,t,n,r,i){function o(e){a||(a=!0,r.call(i,e))}var a=!1;try{t.call(e,(function(e){a||(a=!0,n.call(i,e))}),o)}catch(s){o(s)}}(e,i,t,n,r),!0}catch(o){return n.call(r,o),!0}return!1}function st(e){e.h||(e.h=!0,Ue(e.Zb,e))}function ut(e){var t=null;return e.b&&(t=e.b,e.b=t.next,t.next=null),e.b||(e.f=null),t}function ct(e,t,n,r){if(n==$e&&t.b&&!t.c)for(;e&&e.g;e=e.c)e.g=!1;if(t.a)t.a.c=null,lt(t,n,r);else try{t.c?t.g.call(t.f):lt(t,n,r)}catch(i){ht.call(null,i)}O(Xe,t)}function lt(e,t,n){t==Qe?e.g.call(e.f,n):e.b&&e.b.call(e.f,n)}Ke.prototype.then=function(e,t,n){return it(this,y(e)?e:null,y(t)?t:null,n)},Ke.prototype.$goog_Thenable=!0,(t=Ke.prototype).ka=function(e,t){return(e=Je(e,e,t)).c=!0,rt(this,e),this},t.s=function(e,t){return it(this,null,e,t)},t.cancel=function(e){this.a==Ge&&Ue((function(){!function e(t,n){if(t.a==Ge)if(t.c){var r=t.c;if(r.b){for(var i=0,o=null,a=null,s=r.b;s&&(s.c||(i++,s.a==t&&(o=s),!(o&&1<i)));s=s.next)o||(a=s);o&&(r.a==Ge&&1==i?e(r,n):(a?((i=a).next==r.f&&(r.f=i),i.next=i.next.next):ut(r),ct(r,o,$e,n)))}t.c=null}else ot(t,$e,n)}(this,new dt(e))}),this)},t.Oc=function(e){this.a=Ge,ot(this,Qe,e)},t.Pc=function(e){this.a=Ge,ot(this,$e,e)},t.Zb=function(){for(var e;e=ut(this);)ct(this,e,this.a,this.i);this.h=!1};var ht=Ve;function dt(e){A.call(this,e)}function pt(){0!=ft&&(mt[this[w]||(this[w]=++_)]=this),this.va=this.va,this.la=this.la}I(dt,A),dt.prototype.name="cancel";var ft=0,mt={};function gt(e){if(!e.va&&(e.va=!0,e.za(),0!=ft)){var t=e[w]||(e[w]=++_);if(0!=ft&&e.la&&0<e.la.length)throw Error(e+" did not empty its onDisposeCallbacks queue. This probably means it overrode dispose() or disposeInternal() without calling the superclass' method.");delete mt[t]}}function vt(e){return vt[" "](e),e}pt.prototype.va=!1,pt.prototype.za=function(){if(this.la)for(;this.la.length;)this.la.shift()()},vt[" "]=p;var yt,bt,wt=Ne("Opera"),_t=Ne("Trident")||Ne("MSIE"),Ct=Ne("Edge"),Tt=Ct||_t,St=Ne("Gecko")&&!(be(Ee.toLowerCase(),"webkit")&&!Ne("Edge"))&&!(Ne("Trident")||Ne("MSIE"))&&!Ne("Edge"),Et=be(Ee.toLowerCase(),"webkit")&&!Ne("Edge");function xt(){var e=u.document;return e?e.documentMode:void 0}e:{var It="",kt=(bt=Ee,St?/rv:([^\);]+)(\)|;)/.exec(bt):Ct?/Edge\/([\d\.]+)/.exec(bt):_t?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(bt):Et?/WebKit\/(\S+)/.exec(bt):wt?/(?:Version)[ \/]?(\S+)/.exec(bt):void 0);if(kt&&(It=kt?kt[1]:""),_t){var At=xt();if(null!=At&&At>parseFloat(It)){yt=String(At);break e}}yt=It}var Nt,Lt={};function Dt(e){return function(e,t){var n=Lt;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e)}(e,(function(){for(var t=0,n=he(String(yt)).split("."),r=he(String(e)).split("."),i=Math.max(n.length,r.length),o=0;0==t&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;t=we(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||we(0==a[2].length,0==s[2].length)||we(a[2],s[2]),a=a[3],s=s[3]}while(0==t)}return 0<=t}))}Nt=u.document&&_t?xt():void 0;var Ot=Object.freeze||function(e){return e},Mt=!_t||9<=Number(Nt),Rt=_t&&!Dt("9"),Pt=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{u.addEventListener("test",p,t),u.removeEventListener("test",p,t)}catch(n){}return e}();function Ft(e,t){this.type=e,this.b=this.target=t,this.Mb=!0}function jt(e,t){if(Ft.call(this,e?e.type:""),this.relatedTarget=this.b=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.a=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.b=t,t=e.relatedTarget){if(St){e:{try{vt(t.nodeName);var i=!0;break e}catch(o){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType=c(e.pointerType)?e.pointerType:Bt[e.pointerType]||"",this.a=e,e.defaultPrevented&&this.preventDefault()}}Ft.prototype.preventDefault=function(){this.Mb=!1},I(jt,Ft);var Bt=Ot({2:"touch",3:"pen",4:"mouse"});jt.prototype.preventDefault=function(){jt.qb.preventDefault.call(this);var e=this.a;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,Rt)try{(e.ctrlKey||112<=e.keyCode&&123>=e.keyCode)&&(e.keyCode=-1)}catch(t){}},jt.prototype.f=function(){return this.a};var Vt="closure_listenable_"+(1e6*Math.random()|0),Wt=0;function Ut(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.Pa=i,this.key=++Wt,this.ta=this.Ka=!1}function Ht(e){e.ta=!0,e.listener=null,e.proxy=null,e.src=null,e.Pa=null}function zt(e){this.src=e,this.a={},this.b=0}function qt(e,t){var n=t.type;n in e.a&&z(e.a[n],t)&&(Ht(t),0==e.a[n].length&&(delete e.a[n],e.b--))}function Kt(e,t,n,r){for(var i=0;i<e.length;++i){var o=e[i];if(!o.ta&&o.listener==t&&o.capture==!!n&&o.Pa==r)return i}return-1}zt.prototype.add=function(e,t,n,r,i){var o=e.toString();(e=this.a[o])||(e=this.a[o]=[],this.b++);var a=Kt(e,t,r,i);return-1<a?(t=e[a],n||(t.Ka=!1)):((t=new Ut(t,this.src,o,!!r,i)).Ka=n,e.push(t)),t};var Gt="closure_lm_"+(1e6*Math.random()|0),Qt={};function $t(e,t,n,r,i){if(r&&r.once)Xt(e,t,n,r,i);else if(g(t))for(var o=0;o<t.length;o++)$t(e,t[o],n,r,i);else n=sn(n),e&&e[Vt]?cn(e,t,n,b(r)?!!r.capture:!!r,i):Yt(e,t,n,!1,r,i)}function Yt(e,t,n,r,i,o){if(!t)throw Error("Invalid event type");var a=b(i)?!!i.capture:!!i,s=on(e);if(s||(e[Gt]=s=new zt(e)),!(n=s.add(t,n,r,a,o)).proxy){if(r=function(){var e=rn,t=Mt?function(n){return e.call(t.src,t.listener,n)}:function(n){if(!(n=e.call(t.src,t.listener,n)))return n};return t}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)Pt||(i=a),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(en(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}0}}function Xt(e,t,n,r,i){if(g(t))for(var o=0;o<t.length;o++)Xt(e,t[o],n,r,i);else n=sn(n),e&&e[Vt]?ln(e,t,n,b(r)?!!r.capture:!!r,i):Yt(e,t,n,!0,r,i)}function Jt(e,t,n,r,i){if(g(t))for(var o=0;o<t.length;o++)Jt(e,t[o],n,r,i);else r=b(r)?!!r.capture:!!r,n=sn(n),e&&e[Vt]?(e=e.u,(t=String(t).toString())in e.a&&(-1<(n=Kt(o=e.a[t],n,r,i))&&(Ht(o[n]),Array.prototype.splice.call(o,n,1),0==o.length&&(delete e.a[t],e.b--)))):e&&(e=on(e))&&(t=e.a[t.toString()],e=-1,t&&(e=Kt(t,n,r,i)),(n=-1<e?t[e]:null)&&Zt(n))}function Zt(e){if("number"!=typeof e&&e&&!e.ta){var t=e.src;if(t&&t[Vt])qt(t.u,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(en(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=on(t))?(qt(n,e),0==n.b&&(n.src=null,t[Gt]=null)):Ht(e)}}}function en(e){return e in Qt?Qt[e]:Qt[e]="on"+e}function tn(e,t,n,r){var i=!0;if((e=on(e))&&(t=e.a[t.toString()]))for(t=t.concat(),e=0;e<t.length;e++){var o=t[e];o&&o.capture==n&&!o.ta&&(o=nn(o,r),i=i&&!1!==o)}return i}function nn(e,t){var n=e.listener,r=e.Pa||e.src;return e.Ka&&Zt(e),n.call(r,t)}function rn(e,t){if(e.ta)return!0;if(!Mt){if(!t)e:{t=["window","event"];for(var n=u,r=0;r<t.length;r++)if(null==(n=n[t[r]])){t=null;break e}t=n}if(t=new jt(r=t,this),n=!0,!(0>r.keyCode||null!=r.returnValue)){e:{var i=!1;if(0==r.keyCode)try{r.keyCode=-1;break e}catch(a){i=!0}(i||null==r.returnValue)&&(r.returnValue=!0)}for(r=[],i=t.b;i;i=i.parentNode)r.push(i);for(e=e.type,i=r.length-1;0<=i;i--){t.b=r[i];var o=tn(r[i],e,!0,t);n=n&&o}for(i=0;i<r.length;i++)t.b=r[i],o=tn(r[i],e,!1,t),n=n&&o}return n}return nn(e,new jt(t,this))}function on(e){return(e=e[Gt])instanceof zt?e:null}var an="__closure_events_fn_"+(1e9*Math.random()>>>0);function sn(e){return y(e)?e:(e[an]||(e[an]=function(t){return e.handleEvent(t)}),e[an])}function un(){pt.call(this),this.u=new zt(this),this.Sb=this,this.Xa=null}function cn(e,t,n,r,i){e.u.add(String(t),n,!1,r,i)}function ln(e,t,n,r,i){e.u.add(String(t),n,!0,r,i)}function hn(e,t,n,r){if(!(t=e.u.a[String(t)]))return!0;t=t.concat();for(var i=!0,o=0;o<t.length;++o){var a=t[o];if(a&&!a.ta&&a.capture==n){var s=a.listener,u=a.Pa||a.src;a.Ka&&qt(e.u,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Mb}function dn(e,t,n){if(y(e))n&&(e=S(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=S(e.handleEvent,e)}return 2147483647<Number(t)?-1:u.setTimeout(e,t||0)}function pn(e){var t=null;return new Ke((function(n,r){-1==(t=dn((function(){n(void 0)}),e))&&r(Error("Failed to schedule timer."))})).s((function(e){throw u.clearTimeout(t),e}))}function fn(e){if(e.U&&"function"==typeof e.U)return e.U();if(c(e))return e.split("");if(v(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}function mn(e){if(e.X&&"function"==typeof e.X)return e.X();if(!e.U||"function"!=typeof e.U){if(v(e)||c(e)){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}for(var r in t=[],n=0,e)t[n++]=r;return t}}function gn(e,t){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof gn)for(n=e.X(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function vn(e){if(e.c!=e.a.length){for(var t=0,n=0;t<e.a.length;){var r=e.a[t];yn(e.b,r)&&(e.a[n++]=r),t++}e.a.length=n}if(e.c!=e.a.length){var i={};for(n=t=0;t<e.a.length;)yn(i,r=e.a[t])||(e.a[n++]=r,i[r]=1),t++;e.a.length=n}}function yn(e,t){return Object.prototype.hasOwnProperty.call(e,t)}I(un,pt),un.prototype[Vt]=!0,un.prototype.addEventListener=function(e,t,n,r){$t(this,e,t,n,r)},un.prototype.removeEventListener=function(e,t,n,r){Jt(this,e,t,n,r)},un.prototype.dispatchEvent=function(e){var t,n=this.Xa;if(n)for(t=[];n;n=n.Xa)t.push(n);n=this.Sb;var r=e.type||e;if(c(e))e=new Ft(e,n);else if(e instanceof Ft)e.target=e.target||n;else{var i=e;J(e=new Ft(r,n),i)}if(i=!0,t)for(var o=t.length-1;0<=o;o--){var a=e.b=t[o];i=hn(a,r,!0,e)&&i}if(i=hn(a=e.b=n,r,!0,e)&&i,i=hn(a,r,!1,e)&&i,t)for(o=0;o<t.length;o++)i=hn(a=e.b=t[o],r,!1,e)&&i;return i},un.prototype.za=function(){if(un.qb.za.call(this),this.u){var e,t=this.u;for(e in t.a){for(var n=t.a[e],r=0;r<n.length;r++)Ht(n[r]);delete t.a[e],t.b--}}this.Xa=null},(t=gn.prototype).U=function(){vn(this);for(var e=[],t=0;t<this.a.length;t++)e.push(this.b[this.a[t]]);return e},t.X=function(){return vn(this),this.a.concat()},t.clear=function(){this.b={},this.c=this.a.length=0},t.get=function(e,t){return yn(this.b,e)?this.b[e]:t},t.set=function(e,t){yn(this.b,e)||(this.c++,this.a.push(e)),this.b[e]=t},t.forEach=function(e,t){for(var n=this.X(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);e.call(t,o,i,this)}};var bn=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function wn(e,t){var n;this.b=this.i=this.f="",this.l=null,this.g=this.c="",this.h=!1,e instanceof wn?(this.h=void 0!==t?t:e.h,_n(this,e.f),this.i=e.i,this.b=e.b,Cn(this,e.l),this.c=e.c,Tn(this,Un(e.a)),this.g=e.g):e&&(n=String(e).match(bn))?(this.h=!!t,_n(this,n[1]||"",!0),this.i=kn(n[2]||""),this.b=kn(n[3]||"",!0),Cn(this,n[4]),this.c=kn(n[5]||"",!0),Tn(this,n[6]||"",!0),this.g=kn(n[7]||"")):(this.h=!!t,this.a=new Pn(null,this.h))}function _n(e,t,n){e.f=n?kn(t,!0):t,e.f&&(e.f=e.f.replace(/:$/,""))}function Cn(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.l=t}else e.l=null}function Tn(e,t,n){t instanceof Pn?(e.a=t,function(e,t){t&&!e.f&&(Fn(e),e.c=null,e.a.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(Bn(this,t),Wn(this,n,e))}),e)),e.f=t}(e.a,e.h)):(n||(t=An(t,Mn)),e.a=new Pn(t,e.h))}function Sn(e,t,n){e.a.set(t,n)}function En(e,t){return e.a.get(t)}function xn(e){return e instanceof wn?new wn(e):new wn(e,void 0)}function In(e,t){var n=new wn(null,void 0);return _n(n,"https"),e&&(n.b=e),t&&(n.c=t),n}function kn(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function An(e,t,n){return c(e)?(e=encodeURI(e).replace(t,Nn),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function Nn(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}wn.prototype.toString=function(){var e=[],t=this.f;t&&e.push(An(t,Ln,!0),":");var n=this.b;return(n||"file"==t)&&(e.push("//"),(t=this.i)&&e.push(An(t,Ln,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.l)&&e.push(":",String(n))),(n=this.c)&&(this.b&&"/"!=n.charAt(0)&&e.push("/"),e.push(An(n,"/"==n.charAt(0)?On:Dn,!0))),(n=this.a.toString())&&e.push("?",n),(n=this.g)&&e.push("#",An(n,Rn)),e.join("")},wn.prototype.resolve=function(e){var t=new wn(this),n=!!e.f;n?_n(t,e.f):n=!!e.i,n?t.i=e.i:n=!!e.b,n?t.b=e.b:n=null!=e.l;var r=e.c;if(n)Cn(t,e.l);else if(n=!!e.c){if("/"!=r.charAt(0))if(this.b&&!this.c)r="/"+r;else{var i=t.c.lastIndexOf("/");-1!=i&&(r=t.c.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(be(i,"./")||be(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?t.c=r:n=""!==e.a.toString(),n?Tn(t,Un(e.a)):n=!!e.g,n&&(t.g=e.g),t};var Ln=/[#\/\?@]/g,Dn=/[#\?:]/g,On=/[#\?]/g,Mn=/[#\?@]/g,Rn=/#/g;function Pn(e,t){this.b=this.a=null,this.c=e||null,this.f=!!t}function Fn(e){e.a||(e.a=new gn,e.b=0,e.c&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var o=e[n].substring(0,r);i=e[n].substring(r+1)}else o=e[n];t(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.c,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function jn(e){var t=mn(e);if(void 0===t)throw Error("Keys are undefined");var n=new Pn(null,void 0);e=fn(e);for(var r=0;r<t.length;r++){var i=t[r],o=e[r];g(o)?Wn(n,i,o):n.add(i,o)}return n}function Bn(e,t){Fn(e),t=Hn(e,t),yn(e.a.b,t)&&(e.c=null,e.b-=e.a.get(t).length,yn((e=e.a).b,t)&&(delete e.b[t],e.c--,e.a.length>2*e.c&&vn(e)))}function Vn(e,t){return Fn(e),t=Hn(e,t),yn(e.a.b,t)}function Wn(e,t,n){Bn(e,t),0<n.length&&(e.c=null,e.a.set(Hn(e,t),G(n)),e.b+=n.length)}function Un(e){var t=new Pn;return t.c=e.c,e.a&&(t.a=new gn(e.a),t.b=e.b),t}function Hn(e,t){return t=String(t),e.f&&(t=t.toLowerCase()),t}(t=Pn.prototype).add=function(e,t){Fn(this),this.c=null,e=Hn(this,e);var n=this.a.get(e);return n||this.a.set(e,n=[]),n.push(t),this.b+=1,this},t.clear=function(){this.a=this.c=null,this.b=0},t.forEach=function(e,t){Fn(this),this.a.forEach((function(n,r){V(n,(function(n){e.call(t,n,r,this)}),this)}),this)},t.X=function(){Fn(this);for(var e=this.a.U(),t=this.a.X(),n=[],r=0;r<t.length;r++)for(var i=e[r],o=0;o<i.length;o++)n.push(t[r]);return n},t.U=function(e){Fn(this);var t=[];if(c(e))Vn(this,e)&&(t=K(t,this.a.get(Hn(this,e))));else{e=this.a.U();for(var n=0;n<e.length;n++)t=K(t,e[n])}return t},t.set=function(e,t){return Fn(this),this.c=null,Vn(this,e=Hn(this,e))&&(this.b-=this.a.get(e).length),this.a.set(e,[t]),this.b+=1,this},t.get=function(e,t){return e&&0<(e=this.U(e)).length?String(e[0]):t},t.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var e=[],t=this.a.X(),n=0;n<t.length;n++){var r=t[n],i=encodeURIComponent(String(r));r=this.U(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),e.push(a)}}return this.c=e.join("&")};var zn=!_t||9<=Number(Nt);function qn(e){var t=document;return c(e)?t.getElementById(e):e}function Kn(e,t){Q(t,(function(t,n){t&&"object"==typeof t&&t.qa&&(t=t.pa()),"style"==n?e.style.cssText=t:"class"==n?e.className=t:"for"==n?e.htmlFor=t:Gn.hasOwnProperty(n)?e.setAttribute(Gn[n],t):0==n.lastIndexOf("aria-",0)||0==n.lastIndexOf("data-",0)?e.setAttribute(n,t):e[n]=t}))}var Gn={cellpadding:"cellPadding",cellspacing:"cellSpacing",colspan:"colSpan",frameborder:"frameBorder",height:"height",maxlength:"maxLength",nonce:"nonce",role:"role",rowspan:"rowSpan",type:"type",usemap:"useMap",valign:"vAlign",width:"width"};function Qn(e,t,n){var r=arguments,i=document,o=String(r[0]),a=r[1];if(!zn&&a&&(a.name||a.type)){if(o=["<",o],a.name&&o.push(' name="',Be(a.name),'"'),a.type){o.push(' type="',Be(a.type),'"');var s={};J(s,a),delete s.type,a=s}o.push(">"),o=o.join("")}return o=i.createElement(o),a&&(c(a)?o.className=a:g(a)?o.className=a.join(" "):Kn(o,a)),2<r.length&&function(e,t,n){function r(n){n&&t.appendChild(c(n)?e.createTextNode(n):n)}for(var i=2;i<n.length;i++){var o=n[i];!v(o)||b(o)&&0<o.nodeType?r(o):V($n(o)?G(o):o,r)}}(i,o,r),o}function $n(e){if(e&&"number"==typeof e.length){if(b(e))return"function"==typeof e.item||"string"==typeof e.item;if(y(e))return"function"==typeof e.item}return!1}function Yn(e){var t=[];return function e(t,n,r){if(null==n)r.push("null");else{if("object"==typeof n){if(g(n)){var i=n;n=i.length,r.push("[");for(var o="",a=0;a<n;a++)r.push(o),e(t,i[a],r),o=",";return void r.push("]")}if(!(n instanceof String||n instanceof Number||n instanceof Boolean)){for(i in r.push("{"),o="",n)Object.prototype.hasOwnProperty.call(n,i)&&("function"!=typeof(a=n[i])&&(r.push(o),er(i,r),r.push(":"),e(t,a,r),o=","));return void r.push("}")}n=n.valueOf()}switch(typeof n){case"string":er(n,r);break;case"number":r.push(isFinite(n)&&!isNaN(n)?String(n):"null");break;case"boolean":r.push(String(n));break;case"function":r.push("null");break;default:throw Error("Unknown type: "+typeof n)}}}(new Xn,e,t),t.join("")}function Xn(){}var Jn={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\v":"\\u000b"},Zn=/\uffff/.test("￿")?/[\\"\x00-\x1f\x7f-\uffff]/g:/[\\"\x00-\x1f\x7f-\xff]/g;function er(e,t){t.push('"',e.replace(Zn,(function(e){var t=Jn[e];return t||(t="\\u"+(65536|e.charCodeAt(0)).toString(16).substr(1),Jn[e]=t),t})),'"')}function tr(){var e=wr();return _t&&!!Nt&&11==Nt||/Edge\/\d+/.test(e)}function nr(){return u.window&&u.window.location.href||self&&self.location&&self.location.href||""}function rr(e,t){t=t||u.window;var n="about:blank";e&&(n=Ce(Se(e)).toString()),t.location.href=n}function ir(e){return!!((e=(e||wr()).toLowerCase()).match(/android/)||e.match(/webos/)||e.match(/iphone|ipad|ipod/)||e.match(/blackberry/)||e.match(/windows phone/)||e.match(/iemobile/))}function or(e){e=e||u.window;try{e.close()}catch(t){}}function ar(e,t,n){var r=Math.floor(1e9*Math.random()).toString();t=t||500,n=n||600;var i=(window.screen.availHeight-n)/2,o=(window.screen.availWidth-t)/2;for(a in t={width:t,height:n,top:0<i?i:0,left:0<o?o:0,location:!0,resizable:!0,statusbar:!0,toolbar:!1},n=wr().toLowerCase(),r&&(t.target=r,be(n,"crios/")&&(t.target="_blank")),vr(wr())==mr&&(e=e||"http://localhost",t.scrollbars=!0),n=e||"",(e=t)||(e={}),r=window,t=n instanceof _e?n:Se(void 0!==n.href?n.href:String(n)),n=e.target||n.target,i=[],e)switch(a){case"width":case"height":case"top":case"left":i.push(a+"="+e[a]);break;case"target":case"noopener":case"noreferrer":break;default:i.push(a+"="+(e[a]?1:0))}var a=i.join(",");if((Ne("iPhone")&&!Ne("iPod")&&!Ne("iPad")||Ne("iPad")||Ne("iPod"))&&r.navigator&&r.navigator.standalone&&n&&"_self"!=n?(j(a=r.document.createElement("A"),"HTMLAnchorElement"),t instanceof _e||t instanceof _e||(t="object"==typeof t&&t.qa?t.pa():String(t),Te.test(t)||(t="about:invalid#zClosurez"),t=Ie(t)),a.href=Ce(t),a.setAttribute("target",n),e.noreferrer&&a.setAttribute("rel","noreferrer"),(e=document.createEvent("MouseEvent")).initMouseEvent("click",!0,!0,r,1),a.dispatchEvent(e),a={}):e.noreferrer?(a=r.open("",n,a),e=Ce(t).toString(),a&&(Tt&&be(e,";")&&(e="'"+e.replace(/'/g,"%27")+"'"),a.opener=null,e=Me('<meta name="referrer" content="no-referrer"><meta http-equiv="refresh" content="0; url='+Be(e)+'">'),a.document.write(De(e)),a.document.close())):(a=r.open(Ce(t).toString(),n,a))&&e.noopener&&(a.opener=null),a)try{a.focus()}catch(s){}return a}var sr=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,ur=/^[^@]+@[^@]+$/;function cr(){var e=null;return new Ke((function(t){"complete"==u.document.readyState?t():(e=function(){t()},Xt(window,"load",e))})).s((function(t){throw Jt(window,"load",e),t}))}function lr(e){return e=e||wr(),!("file:"!==Er()&&"ionic:"!==Er()||!e.toLowerCase().match(/iphone|ipad|ipod|android/))}function hr(){var e=u.window;try{return!(!e||e==e.top)}catch(t){return!1}}function dr(){return void 0!==u.WorkerGlobalScope&&"function"==typeof u.importScripts}function pr(){return r.a.INTERNAL.hasOwnProperty("reactNative")?"ReactNative":r.a.INTERNAL.hasOwnProperty("node")?"Node":dr()?"Worker":"Browser"}function fr(){var e=pr();return"ReactNative"===e||"Node"===e}var mr="Firefox",gr="Chrome";function vr(e){var t=e.toLowerCase();return be(t,"opera/")||be(t,"opr/")||be(t,"opios/")?"Opera":be(t,"iemobile")?"IEMobile":be(t,"msie")||be(t,"trident/")?"IE":be(t,"edge/")?"Edge":be(t,"firefox/")?mr:be(t,"silk/")?"Silk":be(t,"blackberry")?"Blackberry":be(t,"webos")?"Webos":!be(t,"safari/")||be(t,"chrome/")||be(t,"crios/")||be(t,"android")?!be(t,"chrome/")&&!be(t,"crios/")||be(t,"edge/")?be(t,"android")?"Android":(e=e.match(/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/))&&2==e.length?e[1]:"Other":gr:"Safari"}var yr={Wc:"FirebaseCore-web",Yc:"FirebaseUI-web"};function br(e,t){t=t||[];var n,r=[],i={};for(n in yr)i[yr[n]]=!0;for(n=0;n<t.length;n++)void 0!==i[t[n]]&&(delete i[t[n]],r.push(t[n]));return r.sort(),(t=r).length||(t=["FirebaseCore-web"]),"Browser"===(r=pr())?r=vr(i=wr()):"Worker"===r&&(r=vr(i=wr())+"-"+r),r+"/JsCore/"+e+"/"+t.join(",")}function wr(){return u.navigator&&u.navigator.userAgent||""}function _r(e,t){e=e.split("."),t=t||u;for(var n=0;n<e.length&&"object"==typeof t&&null!=t;n++)t=t[e[n]];return n!=e.length&&(t=void 0),t}function Cr(){try{var e=u.localStorage,t=Nr();if(e)return e.setItem(t,"1"),e.removeItem(t),!tr()||!!u.indexedDB}catch(n){return dr()&&!!u.indexedDB}return!1}function Tr(){return(Sr()||"chrome-extension:"===Er()||lr())&&!fr()&&Cr()&&!dr()}function Sr(){return"http:"===Er()||"https:"===Er()}function Er(){return u.location&&u.location.protocol||null}function xr(e){return!ir(e=e||wr())&&vr(e)!=mr}function Ir(e){return void 0===e?null:Yn(e)}function kr(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&null!==e[t]&&void 0!==e[t]&&(n[t]=e[t]);return n}function Ar(e){if(null!==e)return JSON.parse(e)}function Nr(e){return e||Math.floor(1e9*Math.random()).toString()}function Lr(e){return"Safari"!=vr(e=e||wr())&&!e.toLowerCase().match(/iphone|ipad|ipod/)}function Dr(){var e=u.___jsl;if(e&&e.H)for(var t in e.H)if(e.H[t].r=e.H[t].r||[],e.H[t].L=e.H[t].L||[],e.H[t].r=e.H[t].L.concat(),e.CP)for(var n=0;n<e.CP.length;n++)e.CP[n]=null}function Or(e,t){if(e>t)throw Error("Short delay should be less than long delay!");this.a=e,this.c=t,e=wr(),t=pr(),this.b=ir(e)||"ReactNative"===t}function Mr(){var e=u.document;return!e||void 0===e.visibilityState||"visible"==e.visibilityState}function Rr(e){try{var t=new Date(parseInt(e,10));if(!isNaN(t.getTime())&&!/[^0-9]/.test(e))return t.toUTCString()}catch(n){}return null}function Pr(){return!(!_r("fireauth.oauthhelper",u)&&!_r("fireauth.iframe",u))}Or.prototype.get=function(){var e=u.navigator;return!e||"boolean"!=typeof e.onLine||!Sr()&&"chrome-extension:"!==Er()&&void 0===e.connection||e.onLine?this.b?this.c:this.a:Math.min(5e3,this.a)};var Fr,jr={};function Br(e){jr[e]||(jr[e]=!0,"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(e))}try{var Vr={};Object.defineProperty(Vr,"abcd",{configurable:!0,enumerable:!0,value:1}),Object.defineProperty(Vr,"abcd",{configurable:!0,enumerable:!0,value:2}),Fr=2==Vr.abcd}catch(bt){Fr=!1}function Wr(e,t,n){Fr?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,value:n}):e[t]=n}function Ur(e,t){if(t)for(var n in t)t.hasOwnProperty(n)&&Wr(e,n,t[n])}function Hr(e){var t={};return Ur(t,e),t}function zr(e){var t=e;if("object"==typeof e&&null!=e)for(var n in t="length"in e?[]:{},e)Wr(t,n,zr(e[n]));return t}function qr(e){var t={},n=e[Gr],r=e[Qr];if(!(e=e[$r])||e!=Kr&&!n)throw Error("Invalid provider user info!");t[Xr]=r||null,t[Yr]=n||null,Wr(this,Zr,e),Wr(this,Jr,zr(t))}var Kr="EMAIL_SIGNIN",Gr="email",Qr="newEmail",$r="requestType",Yr="email",Xr="fromEmail",Jr="data",Zr="operation";function ei(e,t){this.code=ni+e,this.message=t||ri[e]||""}function ti(e){var t=e&&e.code;return t?new ei(t.substring(ni.length),e.message):null}I(ei,Error),ei.prototype.A=function(){return{code:this.code,message:this.message}},ei.prototype.toJSON=function(){return this.A()};var ni="auth/",ri={"admin-restricted-operation":"This operation is restricted to administrators only.","argument-error":"","app-not-authorized":"This app, identified by the domain where it's hosted, is not authorized to use Firebase Authentication with the provided API key. Review your key configuration in the Google API console.","app-not-installed":"The requested mobile application corresponding to the identifier (Android package name or iOS bundle ID) provided is not installed on this device.","captcha-check-failed":"The reCAPTCHA response token provided is either invalid, expired, already used or the domain associated with it does not match the list of whitelisted domains.","code-expired":"The SMS code has expired. Please re-send the verification code to try again.","cordova-not-ready":"Cordova framework is not ready.","cors-unsupported":"This browser is not supported.","credential-already-in-use":"This credential is already associated with a different user account.","custom-token-mismatch":"The custom token corresponds to a different audience.","requires-recent-login":"This operation is sensitive and requires recent authentication. Log in again before retrying this request.","dynamic-link-not-activated":"Please activate Dynamic Links in the Firebase Console and agree to the terms and conditions.","email-already-in-use":"The email address is already in use by another account.","expired-action-code":"The action code has expired. ","cancelled-popup-request":"This operation has been cancelled due to another conflicting popup being opened.","internal-error":"An internal error has occurred.","invalid-app-credential":"The phone verification request contains an invalid application verifier. The reCAPTCHA token response is either invalid or expired.","invalid-app-id":"The mobile app identifier is not registed for the current project.","invalid-user-token":"This user's credential isn't valid for this project. This can happen if the user's token has been tampered with, or if the user isn't for the project associated with this API key.","invalid-auth-event":"An internal error has occurred.","invalid-verification-code":"The SMS verification code used to create the phone auth credential is invalid. Please resend the verification code sms and be sure use the verification code provided by the user.","invalid-continue-uri":"The continue URL provided in the request is invalid.","invalid-cordova-configuration":"The following Cordova plugins must be installed to enable OAuth sign-in: cordova-plugin-buildinfo, cordova-universal-links-plugin, cordova-plugin-browsertab, cordova-plugin-inappbrowser and cordova-plugin-customurlscheme.","invalid-custom-token":"The custom token format is incorrect. Please check the documentation.","invalid-dynamic-link-domain":"The provided dynamic link domain is not configured or authorized for the current project.","invalid-email":"The email address is badly formatted.","invalid-api-key":"Your API key is invalid, please check you have copied it correctly.","invalid-cert-hash":"The SHA-1 certificate hash provided is invalid.","invalid-credential":"The supplied auth credential is malformed or has expired.","invalid-message-payload":"The email template corresponding to this action contains invalid characters in its message. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-oauth-provider":"EmailAuthProvider is not supported for this operation. This operation only supports OAuth providers.","invalid-oauth-client-id":"The OAuth client ID provided is either invalid or does not match the specified API key.","unauthorized-domain":"This domain is not authorized for OAuth operations for your Firebase project. Edit the list of authorized domains from the Firebase console.","invalid-action-code":"The action code is invalid. This can happen if the code is malformed, expired, or has already been used.","wrong-password":"The password is invalid or the user does not have a password.","invalid-persistence-type":"The specified persistence type is invalid. It can only be local, session or none.","invalid-phone-number":"The format of the phone number provided is incorrect. Please enter the phone number in a format that can be parsed into E.164 format. E.164 phone numbers are written in the format [+][country code][subscriber number including area code].","invalid-provider-id":"The specified provider ID is invalid.","invalid-recipient-email":"The email corresponding to this action failed to send as the provided recipient email address is invalid.","invalid-sender":"The email template corresponding to this action contains an invalid sender email or name. Please fix by going to the Auth email templates section in the Firebase Console.","invalid-verification-id":"The verification ID used to create the phone auth credential is invalid.","invalid-tenant-id":"The Auth instance's tenant ID is invalid.","missing-android-pkg-name":"An Android Package Name must be provided if the Android App is required to be installed.","auth-domain-config-required":"Be sure to include authDomain when calling firebase.initializeApp(), by following the instructions in the Firebase console.","missing-app-credential":"The phone verification request is missing an application verifier assertion. A reCAPTCHA response token needs to be provided.","missing-verification-code":"The phone auth credential was created with an empty SMS verification code.","missing-continue-uri":"A continue URL must be provided in the request.","missing-iframe-start":"An internal error has occurred.","missing-ios-bundle-id":"An iOS Bundle ID must be provided if an App Store ID is provided.","missing-or-invalid-nonce":"The request does not contain a valid nonce. This can occur if the SHA-256 hash of the provided raw nonce does not match the hashed nonce in the ID token payload.","missing-phone-number":"To send verification codes, provide a phone number for the recipient.","missing-verification-id":"The phone auth credential was created with an empty verification ID.","app-deleted":"This instance of FirebaseApp has been deleted.","account-exists-with-different-credential":"An account already exists with the same email address but different sign-in credentials. Sign in using a provider associated with this email address.","network-request-failed":"A network error (such as timeout, interrupted connection or unreachable host) has occurred.","no-auth-event":"An internal error has occurred.","no-such-provider":"User was not linked to an account with the given provider.","null-user":"A null user object was provided as the argument for an operation which requires a non-null user object.","operation-not-allowed":"The given sign-in provider is disabled for this Firebase project. Enable it in the Firebase console, under the sign-in method tab of the Auth section.","operation-not-supported-in-this-environment":'This operation is not supported in the environment this application is running on. "location.protocol" must be http, https or chrome-extension and web storage must be enabled.',"popup-blocked":"Unable to establish a connection with the popup. It may have been blocked by the browser.","popup-closed-by-user":"The popup has been closed by the user before finalizing the operation.","provider-already-linked":"User can only be linked to one identity for the given provider.","quota-exceeded":"The project's quota for this operation has been exceeded.","redirect-cancelled-by-user":"The redirect operation has been cancelled by the user before finalizing.","redirect-operation-pending":"A redirect sign-in operation is already pending.","rejected-credential":"The request contains malformed or mismatching credentials.","tenant-id-mismatch":"The provided tenant ID does not match the Auth instance's tenant ID",timeout:"The operation has timed out.","user-token-expired":"The user's credential is no longer valid. The user must sign in again.","too-many-requests":"We have blocked all requests from this device due to unusual activity. Try again later.","unauthorized-continue-uri":"The domain of the continue URL is not whitelisted.  Please whitelist the domain in the Firebase console.","unsupported-persistence-type":"The current environment does not support the specified persistence type.","unsupported-tenant-operation":"This operation is not supported in a multi-tenant context.","user-cancelled":"The user did not grant your application the permissions it requested.","user-not-found":"There is no user record corresponding to this identifier. The user may have been deleted.","user-disabled":"The user account has been disabled by an administrator.","user-mismatch":"The supplied credentials do not correspond to the previously signed in user.","user-signed-out":"","weak-password":"The password must be 6 characters long or more.","web-storage-unsupported":"This browser is not supported or 3rd party cookies and data may be disabled."};function ii(e){var t=En(e=xn(e),oi)||null,n=En(e,ai)||null,r=En(e,ci)||null;if(r=r&&hi[r]||null,!t||!n||!r)throw new ei("argument-error",oi+", "+ai+"and "+ci+" are required in a valid action code URL.");Ur(this,{apiKey:t,operation:r,code:n,continueUrl:En(e,si)||null,languageCode:En(e,ui)||null,tenantId:En(e,li)||null})}var oi="apiKey",ai="oobCode",si="continueUrl",ui="languageCode",ci="mode",li="tenantId",hi={recoverEmail:"RECOVER_EMAIL",resetPassword:"PASSWORD_RESET",signIn:Kr,verifyEmail:"VERIFY_EMAIL"};function di(e){try{return new ii(e)}catch(t){return null}}function pi(e){var t=e[yi];if(void 0===t)throw new ei("missing-continue-uri");if("string"!=typeof t||"string"==typeof t&&!t.length)throw new ei("invalid-continue-uri");this.h=t,this.b=this.a=null,this.g=!1;var n=e[fi];if(n&&"object"==typeof n){t=n[_i];var r=n[bi];if(n=n[wi],"string"==typeof t&&t.length){if(this.a=t,void 0!==r&&"boolean"!=typeof r)throw new ei("argument-error",bi+" property must be a boolean when specified.");if(this.g=!!r,void 0!==n&&("string"!=typeof n||"string"==typeof n&&!n.length))throw new ei("argument-error",wi+" property must be a non empty string when specified.");this.b=n||null}else{if(void 0!==t)throw new ei("argument-error",_i+" property must be a non empty string when specified.");if(void 0!==r||void 0!==n)throw new ei("missing-android-pkg-name")}}else if(void 0!==n)throw new ei("argument-error",fi+" property must be a non null object when specified.");if(this.f=null,(t=e[vi])&&"object"==typeof t){if("string"==typeof(t=t[Ci])&&t.length)this.f=t;else if(void 0!==t)throw new ei("argument-error",Ci+" property must be a non empty string when specified.")}else if(void 0!==t)throw new ei("argument-error",vi+" property must be a non null object when specified.");if(void 0!==(t=e[gi])&&"boolean"!=typeof t)throw new ei("argument-error",gi+" property must be a boolean when specified.");if(this.c=!!t,void 0!==(e=e[mi])&&("string"!=typeof e||"string"==typeof e&&!e.length))throw new ei("argument-error",mi+" property must be a non empty string when specified.");this.i=e||null}var fi="android",mi="dynamicLinkDomain",gi="handleCodeInApp",vi="iOS",yi="url",bi="installApp",wi="minimumVersion",_i="packageName",Ci="bundleId";function Ti(e){var t={};for(var n in t.continueUrl=e.h,t.canHandleCodeInApp=e.c,(t.androidPackageName=e.a)&&(t.androidMinimumVersion=e.b,t.androidInstallApp=e.g),t.iOSBundleId=e.f,t.dynamicLinkDomain=e.i,t)null===t[n]&&delete t[n];return t}var Si=null,Ei=null;function xi(e){var t="";return function(e,t){function n(t){for(;r<e.length;){var n=e.charAt(r++),i=Ei[n];if(null!=i)return i;if(!/^[\s\xa0]*$/.test(n))throw Error("Unknown base64 encoding at char: "+n)}return t}!function(){if(!Si){Si={},Ei={};for(var e=0;65>e;e++)Si[e]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(e),Ei[Si[e]]=e,62<=e&&(Ei["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.".charAt(e)]=e)}}();for(var r=0;;){var i=n(-1),o=n(0),a=n(64),s=n(64);if(64===s&&-1===i)break;t(i<<2|o>>4),64!=a&&(t(o<<4&240|a>>2),64!=s&&t(a<<6&192|s))}}(e,(function(e){t+=String.fromCharCode(e)})),t}function Ii(e){this.f=e.sub,x(),this.a=e.provider_id||e.firebase&&e.firebase.sign_in_provider||null,this.c=e.firebase&&e.firebase.tenant||null,this.b=!!e.is_anonymous||"anonymous"==this.a}function ki(e){return(e=Ai(e))&&e.sub&&e.iss&&e.aud&&e.exp?new Ii(e):null}function Ai(e){if(!e)return null;if(3!=(e=e.split(".")).length)return null;for(var t=(4-(e=e[1]).length%4)%4,n=0;n<t;n++)e+=".";try{return JSON.parse(xi(e))}catch(r){}return null}Ii.prototype.R=function(){return this.c},Ii.prototype.g=function(){return this.b};var Ni,Li={bd:{cb:"https://www.googleapis.com/identitytoolkit/v3/relyingparty/",ib:"https://securetoken.googleapis.com/v1/token",id:"p"},dd:{cb:"https://staging-www.sandbox.googleapis.com/identitytoolkit/v3/relyingparty/",ib:"https://staging-securetoken.sandbox.googleapis.com/v1/token",id:"s"},ed:{cb:"https://www-googleapis-test.sandbox.google.com/identitytoolkit/v3/relyingparty/",ib:"https://test-securetoken.sandbox.googleapis.com/v1/token",id:"t"}};function Di(e){for(var t in Li)if(Li[t].id===e)return{firebaseEndpoint:(e=Li[t]).cb,secureTokenEndpoint:e.ib};return null}Ni=Di("__EID__")?"__EID__":void 0;var Oi="oauth_consumer_key oauth_nonce oauth_signature oauth_signature_method oauth_timestamp oauth_token oauth_version".split(" "),Mi=["client_id","response_type","scope","redirect_uri","state"],Ri={Xc:{Ea:"locale",sa:700,ra:600,Fa:"facebook.com",Qa:Mi},Zc:{Ea:null,sa:500,ra:750,Fa:"github.com",Qa:Mi},$c:{Ea:"hl",sa:515,ra:680,Fa:"google.com",Qa:Mi},fd:{Ea:"lang",sa:485,ra:705,Fa:"twitter.com",Qa:Oi},Vc:{Ea:"locale",sa:600,ra:600,Fa:"apple.com",Qa:[]}};function Pi(e){for(var t in Ri)if(Ri[t].Fa==e)return Ri[t];return null}function Fi(e){var t={};t["facebook.com"]=Ui,t["google.com"]=zi,t["github.com"]=Hi,t["twitter.com"]=qi;var n=e&&e[Bi];try{if(n)return t[n]?new t[n](e):new Wi(e);if(void 0!==e[ji])return new Vi(e)}catch(r){}return null}var ji="idToken",Bi="providerId";function Vi(e){var t=e[Bi];if(!t&&e[ji]){var n=ki(e[ji]);n&&n.a&&(t=n.a)}if(!t)throw Error("Invalid additional user info!");"anonymous"!=t&&"custom"!=t||(t=null),n=!1,void 0!==e.isNewUser?n=!!e.isNewUser:"identitytoolkit#SignupNewUserResponse"===e.kind&&(n=!0),Wr(this,"providerId",t),Wr(this,"isNewUser",n)}function Wi(e){Vi.call(this,e),Wr(this,"profile",zr((e=Ar(e.rawUserInfo||"{}"))||{}))}function Ui(e){if(Wi.call(this,e),"facebook.com"!=this.providerId)throw Error("Invalid provider ID!")}function Hi(e){if(Wi.call(this,e),"github.com"!=this.providerId)throw Error("Invalid provider ID!");Wr(this,"username",this.profile&&this.profile.login||null)}function zi(e){if(Wi.call(this,e),"google.com"!=this.providerId)throw Error("Invalid provider ID!")}function qi(e){if(Wi.call(this,e),"twitter.com"!=this.providerId)throw Error("Invalid provider ID!");Wr(this,"username",e.screenName||null)}function Ki(e){var t=xn(e),n=En(t,"link"),r=En(xn(n),"link");return t=En(t,"deep_link_id"),En(xn(t),"link")||t||r||n||e}function Gi(){}function Qi(e,t){return e.then((function(e){if(e[Pa]){var n=ki(e[Pa]);if(!n||t!=n.f)throw new ei("user-mismatch");return e}throw new ei("user-mismatch")})).s((function(e){throw e&&e.code&&e.code==ni+"user-not-found"?new ei("user-mismatch"):e}))}function $i(e,t){if(!t)throw new ei("internal-error","failed to construct a credential");this.a=t,Wr(this,"providerId",e),Wr(this,"signInMethod",e)}function Yi(e){return{pendingToken:e.a,requestUri:"http://localhost"}}function Xi(e){if(e&&e.providerId&&e.signInMethod&&0==e.providerId.indexOf("saml.")&&e.pendingToken)try{return new $i(e.providerId,e.pendingToken)}catch(t){}return null}function Ji(e,t,n){if(this.a=null,t.idToken||t.accessToken)t.idToken&&Wr(this,"idToken",t.idToken),t.accessToken&&Wr(this,"accessToken",t.accessToken),t.nonce&&!t.pendingToken&&Wr(this,"nonce",t.nonce),t.pendingToken&&(this.a=t.pendingToken);else{if(!t.oauthToken||!t.oauthTokenSecret)throw new ei("internal-error","failed to construct a credential");Wr(this,"accessToken",t.oauthToken),Wr(this,"secret",t.oauthTokenSecret)}Wr(this,"providerId",e),Wr(this,"signInMethod",n)}function Zi(e){var t={};return e.idToken&&(t.id_token=e.idToken),e.accessToken&&(t.access_token=e.accessToken),e.secret&&(t.oauth_token_secret=e.secret),t.providerId=e.providerId,e.nonce&&!e.a&&(t.nonce=e.nonce),t={postBody:jn(t).toString(),requestUri:"http://localhost"},e.a&&(delete t.postBody,t.pendingToken=e.a),t}function eo(e){if(e&&e.providerId&&e.signInMethod){var t={idToken:e.oauthIdToken,accessToken:e.oauthTokenSecret?null:e.oauthAccessToken,oauthTokenSecret:e.oauthTokenSecret,oauthToken:e.oauthTokenSecret&&e.oauthAccessToken,nonce:e.nonce,pendingToken:e.pendingToken};try{return new Ji(e.providerId,t,e.signInMethod)}catch(n){}}return null}function to(e,t){this.Fc=t||[],Ur(this,{providerId:e,isOAuthProvider:!0}),this.zb={},this.eb=(Pi(e)||{}).Ea||null,this.bb=null}function no(e){if("string"!=typeof e||0!=e.indexOf("saml."))throw new ei("argument-error",'SAML provider IDs must be prefixed with "saml."');to.call(this,e,[])}function ro(e){to.call(this,e,Mi),this.a=[]}function io(){ro.call(this,"facebook.com")}function oo(e){if(!e)throw new ei("argument-error","credential failed: expected 1 argument (the OAuth access token).");var t=e;return b(e)&&(t=e.accessToken),(new io).credential({accessToken:t})}function ao(){ro.call(this,"github.com")}function so(e){if(!e)throw new ei("argument-error","credential failed: expected 1 argument (the OAuth access token).");var t=e;return b(e)&&(t=e.accessToken),(new ao).credential({accessToken:t})}function uo(){ro.call(this,"google.com"),this.ya("profile")}function co(e,t){var n=e;return b(e)&&(n=e.idToken,t=e.accessToken),(new uo).credential({idToken:n,accessToken:t})}function lo(){to.call(this,"twitter.com",Oi)}function ho(e,t){var n=e;if(b(n)||(n={oauthToken:e,oauthTokenSecret:t}),!n.oauthToken||!n.oauthTokenSecret)throw new ei("argument-error","credential failed: expected 2 arguments (the OAuth access token and secret).");return new Ji("twitter.com",n,"twitter.com")}function po(e,t,n){this.a=e,this.c=t,Wr(this,"providerId","password"),Wr(this,"signInMethod",n===mo.EMAIL_LINK_SIGN_IN_METHOD?mo.EMAIL_LINK_SIGN_IN_METHOD:mo.EMAIL_PASSWORD_SIGN_IN_METHOD)}function fo(e){return e&&e.email&&e.password?new po(e.email,e.password,e.signInMethod):null}function mo(){Ur(this,{providerId:"password",isOAuthProvider:!1})}function go(e,t){if(!(t=vo(t)))throw new ei("argument-error","Invalid email link!");return new po(e,t.code,mo.EMAIL_LINK_SIGN_IN_METHOD)}function vo(e){return(e=di(e=Ki(e)))&&e.operation===Kr?e:null}function yo(e){if(!(e.Va&&e.Ua||e.Ha&&e.ba))throw new ei("internal-error");this.a=e,Wr(this,"providerId","phone"),Wr(this,"signInMethod","phone")}function bo(e){if(e&&"phone"===e.providerId&&(e.verificationId&&e.verificationCode||e.temporaryProof&&e.phoneNumber)){var t={};return V(["verificationId","verificationCode","temporaryProof","phoneNumber"],(function(n){e[n]&&(t[n]=e[n])})),new yo(t)}return null}function wo(e){return e.a.Ha&&e.a.ba?{temporaryProof:e.a.Ha,phoneNumber:e.a.ba}:{sessionInfo:e.a.Va,code:e.a.Ua}}function _o(e){try{this.a=e||r.a.auth()}catch(t){throw new ei("argument-error","Either an instance of firebase.auth.Auth must be passed as an argument to the firebase.auth.PhoneAuthProvider constructor, or the default firebase App instance must be initialized via firebase.initializeApp().")}Ur(this,{providerId:"phone",isOAuthProvider:!1})}function Co(e,t){if(!e)throw new ei("missing-verification-id");if(!t)throw new ei("missing-verification-code");return new yo({Va:e,Ua:t})}function To(e){if(e.temporaryProof&&e.phoneNumber)return new yo({Ha:e.temporaryProof,ba:e.phoneNumber});var t=e&&e.providerId;if(!t||"password"===t)return null;var n=e&&e.oauthAccessToken,r=e&&e.oauthTokenSecret,i=e&&e.nonce,o=e&&e.oauthIdToken,a=e&&e.pendingToken;try{switch(t){case"google.com":return co(o,n);case"facebook.com":return oo(n);case"github.com":return so(n);case"twitter.com":return ho(n,r);default:return n||r||o||a?a?0==t.indexOf("saml.")?new $i(t,a):new Ji(t,{pendingToken:a,idToken:e.oauthIdToken,accessToken:e.oauthAccessToken},t):new ro(t).credential({idToken:o,accessToken:n,rawNonce:i}):null}}catch(s){return null}}function So(e){if(!e.isOAuthProvider)throw new ei("invalid-oauth-provider")}function Eo(e,t,n,r,i,o,a){if(this.c=e,this.b=t||null,this.g=n||null,this.f=r||null,this.i=o||null,this.h=a||null,this.a=i||null,!this.g&&!this.a)throw new ei("invalid-auth-event");if(this.g&&this.a)throw new ei("invalid-auth-event");if(this.g&&!this.f)throw new ei("invalid-auth-event")}function xo(e){return(e=e||{}).type?new Eo(e.type,e.eventId,e.urlResponse,e.sessionId,e.error&&ti(e.error),e.postBody,e.tenantId):null}function Io(){this.b=null,this.a=[]}I(Wi,Vi),I(Ui,Wi),I(Hi,Wi),I(zi,Wi),I(qi,Wi),$i.prototype.na=function(e){return es(e,Yi(this))},$i.prototype.b=function(e,t){var n=Yi(this);return n.idToken=t,ts(e,n)},$i.prototype.f=function(e,t){return Qi(ns(e,Yi(this)),t)},$i.prototype.A=function(){return{providerId:this.providerId,signInMethod:this.signInMethod,pendingToken:this.a}},Ji.prototype.na=function(e){return es(e,Zi(this))},Ji.prototype.b=function(e,t){var n=Zi(this);return n.idToken=t,ts(e,n)},Ji.prototype.f=function(e,t){return Qi(ns(e,Zi(this)),t)},Ji.prototype.A=function(){var e={providerId:this.providerId,signInMethod:this.signInMethod};return this.idToken&&(e.oauthIdToken=this.idToken),this.accessToken&&(e.oauthAccessToken=this.accessToken),this.secret&&(e.oauthTokenSecret=this.secret),this.nonce&&(e.nonce=this.nonce),this.a&&(e.pendingToken=this.a),e},to.prototype.Ga=function(e){return this.zb=Y(e),this},I(no,to),I(ro,to),ro.prototype.ya=function(e){return H(this.a,e)||this.a.push(e),this},ro.prototype.Hb=function(){return G(this.a)},ro.prototype.credential=function(e,t){var n;if(!(n=b(e)?{idToken:e.idToken||null,accessToken:e.accessToken||null,nonce:e.rawNonce||null}:{idToken:e||null,accessToken:t||null}).idToken&&!n.accessToken)throw new ei("argument-error","credential failed: must provide the ID token and/or the access token.");return new Ji(this.providerId,n,this.providerId)},I(io,ro),Wr(io,"PROVIDER_ID","facebook.com"),Wr(io,"FACEBOOK_SIGN_IN_METHOD","facebook.com"),I(ao,ro),Wr(ao,"PROVIDER_ID","github.com"),Wr(ao,"GITHUB_SIGN_IN_METHOD","github.com"),I(uo,ro),Wr(uo,"PROVIDER_ID","google.com"),Wr(uo,"GOOGLE_SIGN_IN_METHOD","google.com"),I(lo,to),Wr(lo,"PROVIDER_ID","twitter.com"),Wr(lo,"TWITTER_SIGN_IN_METHOD","twitter.com"),po.prototype.na=function(e){return this.signInMethod==mo.EMAIL_LINK_SIGN_IN_METHOD?Ls(e,ls,{email:this.a,oobCode:this.c}):Ls(e,Is,{email:this.a,password:this.c})},po.prototype.b=function(e,t){return this.signInMethod==mo.EMAIL_LINK_SIGN_IN_METHOD?Ls(e,hs,{idToken:t,email:this.a,oobCode:this.c}):Ls(e,_s,{idToken:t,email:this.a,password:this.c})},po.prototype.f=function(e,t){return Qi(this.na(e),t)},po.prototype.A=function(){return{email:this.a,password:this.c,signInMethod:this.signInMethod}},Ur(mo,{PROVIDER_ID:"password"}),Ur(mo,{EMAIL_LINK_SIGN_IN_METHOD:"emailLink"}),Ur(mo,{EMAIL_PASSWORD_SIGN_IN_METHOD:"password"}),yo.prototype.na=function(e){return e.Wa(wo(this))},yo.prototype.b=function(e,t){var n=wo(this);return n.idToken=t,Ls(e,As,n)},yo.prototype.f=function(e,t){var n=wo(this);return n.operation="REAUTH",Qi(e=Ls(e,Ns,n),t)},yo.prototype.A=function(){var e={providerId:"phone"};return this.a.Va&&(e.verificationId=this.a.Va),this.a.Ua&&(e.verificationCode=this.a.Ua),this.a.Ha&&(e.temporaryProof=this.a.Ha),this.a.ba&&(e.phoneNumber=this.a.ba),e},_o.prototype.Wa=function(e,t){var n=this.a.b;return Ze(t.verify()).then((function(r){if(!c(r))throw new ei("argument-error","An implementation of firebase.auth.ApplicationVerifier.prototype.verify() must return a firebase.Promise that resolves with a string.");switch(t.type){case"recaptcha":return function(e,t){return Ls(e,bs,t)}(n,{phoneNumber:e,recaptchaToken:r}).then((function(e){return"function"==typeof t.reset&&t.reset(),e}),(function(e){throw"function"==typeof t.reset&&t.reset(),e}));default:throw new ei("argument-error",'Only firebase.auth.ApplicationVerifiers with type="recaptcha" are currently supported.')}}))},Ur(_o,{PROVIDER_ID:"phone"}),Ur(_o,{PHONE_SIGN_IN_METHOD:"phone"}),Eo.prototype.getUid=function(){var e=[];return e.push(this.c),this.b&&e.push(this.b),this.f&&e.push(this.f),this.h&&e.push(this.h),e.join("-")},Eo.prototype.R=function(){return this.h},Eo.prototype.A=function(){return{type:this.c,eventId:this.b,urlResponse:this.g,sessionId:this.f,postBody:this.i,tenantId:this.h,error:this.a&&this.a.A()}};var ko,Ao=null;function No(e){var t="unauthorized-domain",n=void 0,r=xn(e);e=r.b,"chrome-extension"==(r=r.f)?n=je("This chrome extension ID (chrome-extension://%s) is not authorized to run this operation. Add it to the OAuth redirect domains list in the Firebase console -> Auth section -> Sign in method tab.",e):"http"==r||"https"==r?n=je("This domain (%s) is not authorized to run this operation. Add it to the OAuth redirect domains list in the Firebase console -> Auth section -> Sign in method tab.",e):t="operation-not-supported-in-this-environment",ei.call(this,t,n)}function Lo(e,t,n){ei.call(this,e,n),(e=t||{}).Ab&&Wr(this,"email",e.Ab),e.ba&&Wr(this,"phoneNumber",e.ba),e.credential&&Wr(this,"credential",e.credential),e.Qb&&Wr(this,"tenantId",e.Qb)}function Do(e){if(e.code){var t=e.code||"";0==t.indexOf(ni)&&(t=t.substring(ni.length));var n={credential:To(e),Qb:e.tenantId};if(e.email)n.Ab=e.email;else if(e.phoneNumber)n.ba=e.phoneNumber;else if(!n.credential)return new ei(t,e.message||void 0);return new Lo(t,n,e.message)}return null}function Oo(){}function Mo(e){return e.c||(e.c=e.b())}function Ro(){}function Po(e){if(!e.f&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var t=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],n=0;n<t.length;n++){var r=t[n];try{return new ActiveXObject(r),e.f=r}catch(i){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed")}return e.f}function Fo(){}function jo(){this.a=new XDomainRequest,this.readyState=0,this.onreadystatechange=null,this.responseType=this.responseText=this.response="",this.status=-1,this.statusText="",this.a.onload=S(this.fc,this),this.a.onerror=S(this.Ib,this),this.a.onprogress=S(this.gc,this),this.a.ontimeout=S(this.kc,this)}function Bo(e,t){e.readyState=t,e.onreadystatechange&&e.onreadystatechange()}function Vo(e,t,n){this.reset(e,t,n,void 0,void 0)}I(No,ei),I(Lo,ei),Lo.prototype.A=function(){var e={code:this.code,message:this.message};this.email&&(e.email=this.email),this.phoneNumber&&(e.phoneNumber=this.phoneNumber),this.tenantId&&(e.tenantId=this.tenantId);var t=this.credential&&this.credential.A();return t&&J(e,t),e},Lo.prototype.toJSON=function(){return this.A()},Oo.prototype.c=null,I(Ro,Oo),Ro.prototype.a=function(){var e=Po(this);return e?new ActiveXObject(e):new XMLHttpRequest},Ro.prototype.b=function(){var e={};return Po(this)&&(e[0]=!0,e[1]=!0),e},ko=new Ro,I(Fo,Oo),Fo.prototype.a=function(){var e=new XMLHttpRequest;if("withCredentials"in e)return e;if("undefined"!=typeof XDomainRequest)return new jo;throw Error("Unsupported browser")},Fo.prototype.b=function(){return{}},(t=jo.prototype).open=function(e,t,n){if(null!=n&&!n)throw Error("Only async requests are supported.");this.a.open(e,t)},t.send=function(e){if(e){if("string"!=typeof e)throw Error("Only string data is supported");this.a.send(e)}else this.a.send()},t.abort=function(){this.a.abort()},t.setRequestHeader=function(){},t.getResponseHeader=function(e){return"content-type"==e.toLowerCase()?this.a.contentType:""},t.fc=function(){this.status=200,this.response=this.responseText=this.a.responseText,Bo(this,4)},t.Ib=function(){this.status=500,this.response=this.responseText="",Bo(this,4)},t.kc=function(){this.Ib()},t.gc=function(){this.status=200,Bo(this,1)},t.getAllResponseHeaders=function(){return"content-type: "+this.a.contentType},Vo.prototype.a=null;function Wo(e){this.f=e,this.b=this.c=this.a=null}function Uo(e,t){this.name=e,this.value=t}Vo.prototype.reset=function(e,t,n,r,i){"number"==typeof i||0,r||x(),delete this.a},Uo.prototype.toString=function(){return this.name};var Ho=new Uo("SEVERE",1e3),zo=new Uo("WARNING",900),qo=new Uo("CONFIG",700),Ko=new Uo("FINE",500);Wo.prototype.log=function(e,t,n){if(e.value>=function e(t){return t.c?t.c:t.a?e(t.a):(L("Root logger has no level set."),null)}(this).value)for(y(t)&&(t=t()),e=new Vo(e,String(t),this.f),n&&(e.a=n),n=this;n;)n=n.a};var Go={},Qo=null;function $o(e){var t;if(Qo||(Qo=new Wo(""),Go[""]=Qo,Qo.c=qo),!(t=Go[e])){t=new Wo(e);var n=e.lastIndexOf("."),r=e.substr(n+1);(n=$o(e.substr(0,n))).b||(n.b={}),n.b[r]=t,t.a=n,Go[e]=t}return t}function Yo(e,t){e&&e.log(Ko,t,void 0)}function Xo(e){this.f=e}function Jo(e){un.call(this),this.o=e,this.readyState=Zo,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.i=new Headers,this.b=null,this.m="GET",this.g="",this.a=!1,this.h=$o("goog.net.FetchXmlHttp"),this.l=this.c=this.f=null}I(Xo,Oo),Xo.prototype.a=function(){return new Jo(this.f)},Xo.prototype.b=function(e){return function(){return e}}({}),I(Jo,un);var Zo=0;function ea(e){e.c.read().then(e.ec.bind(e)).catch(e.Oa.bind(e))}function ta(e,t){t&&e.f&&(e.status=e.f.status,e.statusText=e.f.statusText),e.readyState=4,e.f=null,e.c=null,e.l=null,na(e)}function na(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function ra(e){un.call(this),this.headers=new gn,this.B=e||null,this.c=!1,this.w=this.a=null,this.h=this.O=this.l="",this.f=this.J=this.i=this.I=!1,this.g=0,this.o=null,this.m=ia,this.v=this.P=!1}(t=Jo.prototype).open=function(e,t){if(this.readyState!=Zo)throw this.abort(),Error("Error reopening a connection");this.m=e,this.g=t,this.readyState=1,na(this)},t.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.a=!0;var t={headers:this.i,method:this.m,credentials:void 0,cache:void 0};e&&(t.body=e),this.o.fetch(new Request(this.g,t)).then(this.jc.bind(this),this.Oa.bind(this))},t.abort=function(){this.response=this.responseText="",this.i=new Headers,this.status=0,this.c&&this.c.cancel("Request was aborted."),1<=this.readyState&&this.a&&4!=this.readyState&&(this.a=!1,ta(this,!1)),this.readyState=Zo},t.jc=function(e){this.a&&(this.f=e,this.b||(this.b=e.headers,this.readyState=2,na(this)),this.a&&(this.readyState=3,na(this),this.a&&("arraybuffer"===this.responseType?e.arrayBuffer().then(this.hc.bind(this),this.Oa.bind(this)):void 0!==u.ReadableStream&&"body"in e?(this.response=this.responseText="",this.c=e.body.getReader(),this.l=new TextDecoder,ea(this)):e.text().then(this.ic.bind(this),this.Oa.bind(this)))))},t.ec=function(e){if(this.a){var t=this.l.decode(e.value?e.value:new Uint8Array(0),{stream:!e.done});t&&(this.response=this.responseText+=t),e.done?ta(this,!0):na(this),3==this.readyState&&ea(this)}},t.ic=function(e){this.a&&(this.response=this.responseText=e,ta(this,!0))},t.hc=function(e){this.a&&(this.response=e,ta(this,!0))},t.Oa=function(e){var t=this.h;t&&t.log(zo,"Failed to fetch url "+this.g,e instanceof Error?e:Error(e)),this.a&&ta(this,!0)},t.setRequestHeader=function(e,t){this.i.append(e,t)},t.getResponseHeader=function(e){return this.b?this.b.get(e.toLowerCase())||"":((e=this.h)&&e.log(zo,"Attempting to get response header but no headers have been received for url: "+this.g,void 0),"")},t.getAllResponseHeaders=function(){if(!this.b){var e=this.h;return e&&e.log(zo,"Attempting to get all response headers but no headers have been received for url: "+this.g,void 0),""}e=[];for(var t=this.b.entries(),n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},I(ra,un);var ia="";ra.prototype.b=$o("goog.net.XhrIo");var oa=/^https?$/i,aa=["POST","PUT"];function sa(e,t,n,r,i){if(e.a)throw Error("[goog.net.XhrIo] Object is active with another request="+e.l+"; newUri="+t);n=n?n.toUpperCase():"GET",e.l=t,e.h="",e.O=n,e.I=!1,e.c=!0,e.a=e.B?e.B.a():ko.a(),e.w=e.B?Mo(e.B):Mo(ko),e.a.onreadystatechange=S(e.Lb,e);try{Yo(e.b,ga(e,"Opening Xhr")),e.J=!0,e.a.open(n,String(t),!0),e.J=!1}catch(a){return Yo(e.b,ga(e,"Error opening Xhr: "+a.message)),void ca(e,a)}t=r||"";var o=new gn(e.headers);i&&function(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(v(e)||c(e))V(e,t,void 0);else for(var n=mn(e),r=fn(e),i=r.length,o=0;o<i;o++)t.call(void 0,r[o],n&&n[o],e)}(i,(function(e,t){o.set(t,e)})),i=function(e){e:{for(var t=ua,n=e.length,r=c(e)?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e)){t=i;break e}t=-1}return 0>t?null:c(e)?e.charAt(t):e[t]}(o.X()),r=u.FormData&&t instanceof u.FormData,!H(aa,n)||i||r||o.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.forEach((function(e,t){this.a.setRequestHeader(t,e)}),e),e.m&&(e.a.responseType=e.m),"withCredentials"in e.a&&e.a.withCredentials!==e.P&&(e.a.withCredentials=e.P);try{pa(e),0<e.g&&(e.v=function(e){return _t&&Dt(9)&&"number"==typeof e.timeout&&void 0!==e.ontimeout}(e.a),Yo(e.b,ga(e,"Will abort after "+e.g+"ms if incomplete, xhr2 "+e.v)),e.v?(e.a.timeout=e.g,e.a.ontimeout=S(e.Ia,e)):e.o=dn(e.Ia,e.g,e)),Yo(e.b,ga(e,"Sending request")),e.i=!0,e.a.send(t),e.i=!1}catch(a){Yo(e.b,ga(e,"Send error: "+a.message)),ca(e,a)}}function ua(e){return"content-type"==e.toLowerCase()}function ca(e,t){e.c=!1,e.a&&(e.f=!0,e.a.abort(),e.f=!1),e.h=t,la(e),da(e)}function la(e){e.I||(e.I=!0,e.dispatchEvent("complete"),e.dispatchEvent("error"))}function ha(e){if(e.c&&void 0!==s)if(e.w[1]&&4==fa(e)&&2==ma(e))Yo(e.b,ga(e,"Local request error detected and ignored"));else if(e.i&&4==fa(e))dn(e.Lb,0,e);else if(e.dispatchEvent("readystatechange"),4==fa(e)){Yo(e.b,ga(e,"Request complete")),e.c=!1;try{var t,n=ma(e);e:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break e;default:r=!1}if(!(t=r)){var i;if(i=0===n){var o=String(e.l).match(bn)[1]||null;if(!o&&u.self&&u.self.location){var a=u.self.location.protocol;o=a.substr(0,a.length-1)}i=!oa.test(o?o.toLowerCase():"")}t=i}if(t)e.dispatchEvent("complete"),e.dispatchEvent("success");else{try{var c=2<fa(e)?e.a.statusText:""}catch(l){Yo(e.b,"Can not get status: "+l.message),c=""}e.h=c+" ["+ma(e)+"]",la(e)}}finally{da(e)}}}function da(e,t){if(e.a){pa(e);var n=e.a,r=e.w[0]?p:null;e.a=null,e.w=null,t||e.dispatchEvent("ready");try{n.onreadystatechange=r}catch(i){(e=e.b)&&e.log(Ho,"Problem encountered resetting onreadystatechange: "+i.message,void 0)}}}function pa(e){e.a&&e.v&&(e.a.ontimeout=null),e.o&&(u.clearTimeout(e.o),e.o=null)}function fa(e){return e.a?e.a.readyState:0}function ma(e){try{return 2<fa(e)?e.a.status:-1}catch(t){return-1}}function ga(e,t){return t+" ["+e.O+" "+e.l+" "+ma(e)+"]"}function va(e){var t=ka;this.g=[],this.v=t,this.o=e||null,this.f=this.a=!1,this.c=void 0,this.u=this.w=this.i=!1,this.h=0,this.b=null,this.l=0}function ya(e,t,n){e.a=!0,e.c=n,e.f=!t,Ca(e)}function ba(e){if(e.a){if(!e.u)throw new Ta(e);e.u=!1}}function wa(e,t,n,r){e.g.push([t,n,r]),e.a&&Ca(e)}function _a(e){return U(e.g,(function(e){return y(e[1])}))}function Ca(e){if(e.h&&e.a&&_a(e)){var t=e.h,n=xa[t];n&&(u.clearTimeout(n.a),delete xa[t]),e.h=0}e.b&&(e.b.l--,delete e.b),t=e.c;for(var r=n=!1;e.g.length&&!e.i;){var i=e.g.shift(),o=i[0],a=i[1];if(i=i[2],o=e.f?a:o)try{var s=o.call(i||e.o,t);void 0!==s&&(e.f=e.f&&(s==t||s instanceof Error),e.c=t=s),(k(t)||"function"==typeof u.Promise&&t instanceof u.Promise)&&(r=!0,e.i=!0)}catch(c){t=c,e.f=!0,_a(e)||(n=!0)}}e.c=t,r&&(s=S(e.m,e,!0),r=S(e.m,e,!1),t instanceof va?(wa(t,s,r),t.w=!0):t.then(s,r)),n&&(t=new Ea(t),xa[t.a]=t,e.h=t.a)}function Ta(){A.call(this)}function Sa(){A.call(this)}function Ea(e){this.a=u.setTimeout(S(this.c,this),0),this.b=e}(t=ra.prototype).Ia=function(){void 0!==s&&this.a&&(this.h="Timed out after "+this.g+"ms, aborting",Yo(this.b,ga(this,this.h)),this.dispatchEvent("timeout"),this.abort(8))},t.abort=function(){this.a&&this.c&&(Yo(this.b,ga(this,"Aborting")),this.c=!1,this.f=!0,this.a.abort(),this.f=!1,this.dispatchEvent("complete"),this.dispatchEvent("abort"),da(this))},t.za=function(){this.a&&(this.c&&(this.c=!1,this.f=!0,this.a.abort(),this.f=!1),da(this,!0)),ra.qb.za.call(this)},t.Lb=function(){this.va||(this.J||this.i||this.f?ha(this):this.yc())},t.yc=function(){ha(this)},t.getResponse=function(){try{if(!this.a)return null;if("response"in this.a)return this.a.response;switch(this.m){case ia:case"text":return this.a.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in this.a)return this.a.mozResponseArrayBuffer}var e=this.b;return e&&e.log(Ho,"Response type "+this.m+" is not supported on this browser",void 0),null}catch(t){return Yo(this.b,"Can not get response: "+t.message),null}},va.prototype.cancel=function(e){if(this.a)this.c instanceof va&&this.c.cancel();else{if(this.b){var t=this.b;delete this.b,e?t.cancel(e):(t.l--,0>=t.l&&t.cancel())}this.v?this.v.call(this.o,this):this.u=!0,this.a||(e=new Sa(this),ba(this),ya(this,!1,e))}},va.prototype.m=function(e,t){this.i=!1,ya(this,e,t)},va.prototype.then=function(e,t,n){var r,i,o=new Ke((function(e,t){r=e,i=t}));return wa(this,r,(function(e){e instanceof Sa?o.cancel():i(e)})),o.then(e,t,n)},va.prototype.$goog_Thenable=!0,I(Ta,A),Ta.prototype.message="Deferred has already fired",Ta.prototype.name="AlreadyCalledError",I(Sa,A),Sa.prototype.message="Deferred was canceled",Sa.prototype.name="CanceledError",Ea.prototype.c=function(){throw delete xa[this.a],this.b};var xa={};function Ia(e){var t={},n=t.document||document,r=oe(e).toString(),i=document.createElement("SCRIPT"),o={Nb:i,Ia:void 0},a=new va(o),s=null,c=null!=t.timeout?t.timeout:5e3;return 0<c&&(s=window.setTimeout((function(){Aa(i,!0);var e=new Da(La,"Timeout reached for loading script "+r);ba(a),ya(a,!1,e)}),c),o.Ia=s),i.onload=i.onreadystatechange=function(){i.readyState&&"loaded"!=i.readyState&&"complete"!=i.readyState||(Aa(i,t.hd||!1,s),ba(a),ya(a,!0,null))},i.onerror=function(){Aa(i,!0,s);var e=new Da(Na,"Error while loading script "+r);ba(a),ya(a,!1,e)},J(o=t.attributes||{},{type:"text/javascript",charset:"UTF-8"}),Kn(i,o),function(e,t){j(e,"HTMLScriptElement"),e.src=oe(t),null===d&&(d=(t=(t=u.document).querySelector&&t.querySelector("script[nonce]"))&&(t=t.nonce||t.getAttribute("nonce"))&&h.test(t)?t:""),(t=d)&&e.setAttribute("nonce",t)}(i,e),function(e){var t;return(t=(e||document).getElementsByTagName("HEAD"))&&0!=t.length?t[0]:e.documentElement}(n).appendChild(i),a}function ka(){if(this&&this.Nb){var e=this.Nb;e&&"SCRIPT"==e.tagName&&Aa(e,!0,this.Ia)}}function Aa(e,t,n){null!=n&&u.clearTimeout(n),e.onload=p,e.onerror=p,e.onreadystatechange=p,t&&window.setTimeout((function(){e&&e.parentNode&&e.parentNode.removeChild(e)}),0)}var Na=0,La=1;function Da(e,t){var n="Jsloader error (code #"+e+")";t&&(n+=": "+t),A.call(this,n),this.code=e}function Oa(e){this.f=e}function Ma(e,t,n){if(this.c=e,e=t||{},this.l=e.secureTokenEndpoint||"https://securetoken.googleapis.com/v1/token",this.u=e.secureTokenTimeout||Fa,this.g=Y(e.secureTokenHeaders||ja),this.h=e.firebaseEndpoint||"https://www.googleapis.com/identitytoolkit/v3/relyingparty/",this.i=e.firebaseTimeout||Ba,this.a=Y(e.firebaseHeaders||Va),n&&(this.a["X-Client-Version"]=n,this.g["X-Client-Version"]=n),n="Node"==pr(),!(n=u.XMLHttpRequest||n&&r.a.INTERNAL.node&&r.a.INTERNAL.node.XMLHttpRequest)&&!dr())throw new ei("internal-error","The XMLHttpRequest compatibility library was not found.");this.f=void 0,dr()?this.f=new Xo(self):fr()?this.f=new Oa(n):this.f=new Fo,this.b=null}I(Da,A),I(Oa,Oo),Oa.prototype.a=function(){return new this.f},Oa.prototype.b=function(){return{}};var Ra,Pa="idToken",Fa=new Or(3e4,6e4),ja={"Content-Type":"application/x-www-form-urlencoded"},Ba=new Or(3e4,6e4),Va={"Content-Type":"application/json"};function Wa(e,t){t?e.a["X-Firebase-Locale"]=t:delete e.a["X-Firebase-Locale"]}function Ua(e,t){t?(e.a["X-Client-Version"]=t,e.g["X-Client-Version"]=t):(delete e.a["X-Client-Version"],delete e.g["X-Client-Version"])}function Ha(e,t,n,r,i,o,a){(function(){var e=wr();return!((e=vr(e)!=gr?null:(e=e.match(/\sChrome\/(\d+)/i))&&2==e.length?parseInt(e[1],10):null)&&30>e)&&(!_t||!Nt||9<Nt)})()||dr()?e=S(e.o,e):(Ra||(Ra=new Ke((function(e,t){!function(e,t){if(((window.gapi||{}).client||{}).request)e();else{u[qa]=function(){((window.gapi||{}).client||{}).request?e():t(Error("CORS_UNSUPPORTED"))},function(e,t){wa(e,null,t,void 0)}(Ia(ae(za,{onload:qa})),(function(){t(Error("CORS_UNSUPPORTED"))}))}}(e,t)}))),e=S(e.m,e)),e(t,n,r,i,o,a)}Ma.prototype.R=function(){return this.b},Ma.prototype.o=function(e,t,n,r,i,o){if(dr()&&(void 0===u.fetch||void 0===u.Headers||void 0===u.Request))throw new ei("operation-not-supported-in-this-environment","fetch, Headers and Request native APIs or equivalent Polyfills must be available to support HTTP requests from a Worker environment.");var a=new ra(this.f);if(o){a.g=Math.max(0,o);var s=setTimeout((function(){a.dispatchEvent("timeout")}),o)}cn(a,"complete",(function(){s&&clearTimeout(s);var e=null;try{e=JSON.parse(function(e){try{return e.a?e.a.responseText:""}catch(t){return Yo(e.b,"Can not get responseText: "+t.message),""}}(this))||null}catch(n){e=null}t&&t(e)})),ln(a,"ready",(function(){s&&clearTimeout(s),gt(this)})),ln(a,"timeout",(function(){s&&clearTimeout(s),gt(this),t&&t(null)})),sa(a,e,n,r,i)};var za=new Z(ne,"https://apis.google.com/js/client.js?onload=%{onload}"),qa="__fcb"+Math.floor(1e6*Math.random()).toString();function Ka(e){if(!c(e=e.email)||!ur.test(e))throw new ei("invalid-email")}function Ga(e){"email"in e&&Ka(e)}function Qa(e){if(!e[Pa])throw new ei("internal-error")}function $a(e){if(e.phoneNumber||e.temporaryProof){if(!e.phoneNumber||!e.temporaryProof)throw new ei("internal-error")}else{if(!e.sessionInfo)throw new ei("missing-verification-id");if(!e.code)throw new ei("missing-verification-code")}}Ma.prototype.m=function(e,t,n,r,i){var o=this;Ra.then((function(){window.gapi.client.setApiKey(o.c);var a=window.gapi.auth.getToken();window.gapi.auth.setToken(null),window.gapi.client.request({path:e,method:n,body:r,headers:i,authType:"none",callback:function(e){window.gapi.auth.setToken(a),t&&t(e)}})})).s((function(e){t&&t({error:{message:e&&e.message||"CORS_UNSUPPORTED"}})}))},Ma.prototype.ob=function(){return Ls(this,Cs,{})},Ma.prototype.rb=function(e,t){return Ls(this,ws,{idToken:e,email:t})},Ma.prototype.sb=function(e,t){return Ls(this,_s,{idToken:e,password:t})};var Ya={displayName:"DISPLAY_NAME",photoUrl:"PHOTO_URL"};function Xa(e){if(!e.requestUri||!e.sessionId&&!e.postBody&&!e.pendingToken)throw new ei("internal-error")}function Ja(e,t){return t.oauthIdToken&&t.providerId&&0==t.providerId.indexOf("oidc.")&&!t.pendingToken&&(e.sessionId?t.nonce=e.sessionId:e.postBody&&(Vn(e=new Pn(e.postBody),"nonce")&&(t.nonce=e.get("nonce")))),t}function Za(e){var t=null;if(e.needConfirmation?(e.code="account-exists-with-different-credential",t=Do(e)):"FEDERATED_USER_ID_ALREADY_LINKED"==e.errorMessage?(e.code="credential-already-in-use",t=Do(e)):"EMAIL_EXISTS"==e.errorMessage?(e.code="email-already-in-use",t=Do(e)):e.errorMessage&&(t=Ds(e.errorMessage)),t)throw t;if(!e[Pa])throw new ei("internal-error")}function es(e,t){return t.returnIdpCredential=!0,Ls(e,Ts,t)}function ts(e,t){return t.returnIdpCredential=!0,Ls(e,Es,t)}function ns(e,t){return t.returnIdpCredential=!0,t.autoCreate=!1,Ls(e,Ss,t)}function rs(e){if(!e.oobCode)throw new ei("invalid-action-code")}(t=Ma.prototype).tb=function(e,t){var n={idToken:e},r=[];return Q(Ya,(function(e,i){var o=t[i];null===o?r.push(e):i in t&&(n[i]=o)})),r.length&&(n.deleteAttribute=r),Ls(this,ws,n)},t.kb=function(e,t){return J(e={requestType:"PASSWORD_RESET",email:e},t),Ls(this,ms,e)},t.lb=function(e,t){return J(e={requestType:"EMAIL_SIGNIN",email:e},t),Ls(this,ps,e)},t.jb=function(e,t){return J(e={requestType:"VERIFY_EMAIL",idToken:e},t),Ls(this,fs,e)},t.Wa=function(e){return Ls(this,ks,e)},t.ab=function(e,t){return Ls(this,ys,{oobCode:e,newPassword:t})},t.Ma=function(e){return Ls(this,os,{oobCode:e})},t.Ya=function(e){return Ls(this,is,{oobCode:e})};var is={endpoint:"setAccountInfo",D:rs,fa:"email",F:!0},os={endpoint:"resetPassword",D:rs,K:function(e){var t=e.requestType;if(!t||!e.email&&"EMAIL_SIGNIN"!=t)throw new ei("internal-error")},F:!0},as={endpoint:"signupNewUser",D:function(e){if(Ka(e),!e.password)throw new ei("weak-password")},K:Qa,T:!0,F:!0},ss={endpoint:"createAuthUri",F:!0},us={endpoint:"deleteAccount",V:["idToken"]},cs={endpoint:"setAccountInfo",V:["idToken","deleteProvider"],D:function(e){if(!g(e.deleteProvider))throw new ei("internal-error")}},ls={endpoint:"emailLinkSignin",V:["email","oobCode"],D:Ka,K:Qa,T:!0,F:!0},hs={endpoint:"emailLinkSignin",V:["idToken","email","oobCode"],D:Ka,K:Qa,T:!0},ds={endpoint:"getAccountInfo"},ps={endpoint:"getOobConfirmationCode",V:["requestType"],D:function(e){if("EMAIL_SIGNIN"!=e.requestType)throw new ei("internal-error");Ka(e)},fa:"email",F:!0},fs={endpoint:"getOobConfirmationCode",V:["idToken","requestType"],D:function(e){if("VERIFY_EMAIL"!=e.requestType)throw new ei("internal-error")},fa:"email",F:!0},ms={endpoint:"getOobConfirmationCode",V:["requestType"],D:function(e){if("PASSWORD_RESET"!=e.requestType)throw new ei("internal-error");Ka(e)},fa:"email",F:!0},gs={wb:!0,endpoint:"getProjectConfig",Kb:"GET"},vs={wb:!0,endpoint:"getRecaptchaParam",Kb:"GET",K:function(e){if(!e.recaptchaSiteKey)throw new ei("internal-error")}},ys={endpoint:"resetPassword",D:rs,fa:"email",F:!0},bs={endpoint:"sendVerificationCode",V:["phoneNumber","recaptchaToken"],fa:"sessionInfo",F:!0},ws={endpoint:"setAccountInfo",V:["idToken"],D:Ga,T:!0},_s={endpoint:"setAccountInfo",V:["idToken"],D:function(e){if(Ga(e),!e.password)throw new ei("weak-password")},K:Qa,T:!0},Cs={endpoint:"signupNewUser",K:Qa,T:!0,F:!0},Ts={endpoint:"verifyAssertion",D:Xa,Ra:Ja,K:Za,T:!0,F:!0},Ss={endpoint:"verifyAssertion",D:Xa,Ra:Ja,K:function(e){if(e.errorMessage&&"USER_NOT_FOUND"==e.errorMessage)throw new ei("user-not-found");if(e.errorMessage)throw Ds(e.errorMessage);if(!e[Pa])throw new ei("internal-error")},T:!0,F:!0},Es={endpoint:"verifyAssertion",D:function(e){if(Xa(e),!e.idToken)throw new ei("internal-error")},Ra:Ja,K:Za,T:!0},xs={endpoint:"verifyCustomToken",D:function(e){if(!e.token)throw new ei("invalid-custom-token")},K:Qa,T:!0,F:!0},Is={endpoint:"verifyPassword",D:function(e){if(Ka(e),!e.password)throw new ei("wrong-password")},K:Qa,T:!0,F:!0},ks={endpoint:"verifyPhoneNumber",D:$a,K:Qa,F:!0},As={endpoint:"verifyPhoneNumber",D:function(e){if(!e.idToken)throw new ei("internal-error");$a(e)},K:function(e){if(e.temporaryProof)throw e.code="credential-already-in-use",Do(e);Qa(e)}},Ns={Yb:{USER_NOT_FOUND:"user-not-found"},endpoint:"verifyPhoneNumber",D:$a,K:Qa,F:!0};function Ls(e,t,n){if(!function(e,t){if(!t||!t.length)return!0;if(!e)return!1;for(var n=0;n<t.length;n++){var r=e[t[n]];if(null==r||""===r)return!1}return!0}(n,t.V))return et(new ei("internal-error"));var r,i=t.Kb||"POST";return Ze(n).then(t.D).then((function(){return t.T&&(n.returnSecureToken=!0),t.F&&e.b&&void 0===n.tenantId&&(n.tenantId=e.b),function(e,t,n,r,i,o){var a=xn(e.h+t);Sn(a,"key",e.c),o&&Sn(a,"cb",x().toString());var s="GET"==n;if(s)for(var u in r)r.hasOwnProperty(u)&&Sn(a,u,r[u]);return new Ke((function(t,o){Ha(e,a.toString(),(function(e){e?e.error?o(Os(e,i||{})):t(e):o(new ei("network-request-failed"))}),n,s?void 0:Yn(kr(r)),e.a,e.i.get())}))}(e,t.endpoint,i,n,t.Yb,t.wb||!1)})).then((function(e){return r=e,t.Ra?t.Ra(n,r):r})).then(t.K).then((function(){if(!t.fa)return r;if(!(t.fa in r))throw new ei("internal-error");return r[t.fa]}))}function Ds(e){return Os({error:{errors:[{message:e}],code:400,message:e}})}function Os(e,t){var n=(e.error&&e.error.errors&&e.error.errors[0]||{}).reason||"",r={keyInvalid:"invalid-api-key",ipRefererBlocked:"app-not-authorized"};if(n=r[n]?new ei(r[n]):null)return n;for(var i in n=e.error&&e.error.message||"",J(r={INVALID_CUSTOM_TOKEN:"invalid-custom-token",CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_EMAIL:"invalid-email",INVALID_PASSWORD:"wrong-password",USER_DISABLED:"user-disabled",MISSING_PASSWORD:"internal-error",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_OR_INVALID_NONCE:"missing-or-invalid-nonce",INVALID_MESSAGE_PAYLOAD:"invalid-message-payload",INVALID_RECIPIENT_EMAIL:"invalid-recipient-email",INVALID_SENDER:"invalid-sender",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",INVALID_PROVIDER_ID:"invalid-provider-id",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",CORS_UNSUPPORTED:"cors-unsupported",DYNAMIC_LINK_NOT_ACTIVATED:"dynamic-link-not-activated",INVALID_APP_ID:"invalid-app-id",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",WEAK_PASSWORD:"weak-password",OPERATION_NOT_ALLOWED:"operation-not-allowed",USER_CANCELLED:"user-cancelled",CAPTCHA_CHECK_FAILED:"captcha-check-failed",INVALID_APP_CREDENTIAL:"invalid-app-credential",INVALID_CODE:"invalid-verification-code",INVALID_PHONE_NUMBER:"invalid-phone-number",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_APP_CREDENTIAL:"missing-app-credential",MISSING_CODE:"missing-verification-code",MISSING_PHONE_NUMBER:"missing-phone-number",MISSING_SESSION_INFO:"missing-verification-id",QUOTA_EXCEEDED:"quota-exceeded",SESSION_EXPIRED:"code-expired",REJECTED_CREDENTIAL:"rejected-credential",INVALID_CONTINUE_URI:"invalid-continue-uri",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",MISSING_IOS_BUNDLE_ID:"missing-ios-bundle-id",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_DYNAMIC_LINK_DOMAIN:"invalid-dynamic-link-domain",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",INVALID_CERT_HASH:"invalid-cert-hash",UNSUPPORTED_TENANT_OPERATION:"unsupported-tenant-operation",INVALID_TENANT_ID:"invalid-tenant-id",TENANT_ID_MISMATCH:"tenant-id-mismatch",ADMIN_ONLY_OPERATION:"admin-restricted-operation"},t||{}),t=(t=n.match(/^[^\s]+\s*:\s*([\s\S]*)$/))&&1<t.length?t[1]:void 0,r)if(0===n.indexOf(i))return new ei(r[i],t);return!t&&e&&(t=Ir(e)),new ei("internal-error",t)}function Ms(e){this.b=e,this.a=null,this.gb=function(e){return(js||(js=new Ke((function(e,t){function n(){Dr(),_r("gapi.load")("gapi.iframes",{callback:e,ontimeout:function(){Dr(),t(Error("Network Error"))},timeout:Ps.get()})}if(_r("gapi.iframes.Iframe"))e();else if(_r("gapi.load"))n();else{var r="__iframefcb"+Math.floor(1e6*Math.random()).toString();u[r]=function(){_r("gapi.load")?n():t(Error("Network Error"))},Ze(Ia(r=ae(Rs,{onload:r}))).s((function(){t(Error("Network Error"))}))}})).s((function(e){throw js=null,e})))).then((function(){return new Ke((function(t,n){_r("gapi.iframes.getContext")().open({where:document.body,url:e.b,messageHandlersFilter:_r("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"),attributes:{style:{position:"absolute",top:"-100px",width:"1px",height:"1px"}},dontclear:!0},(function(r){function i(){clearTimeout(o),t()}e.a=r,e.a.restyle({setHideOnLeave:!1});var o=setTimeout((function(){n(Error("Network Error"))}),Fs.get());r.ping(i).then(i,(function(){n(Error("Network Error"))}))}))}))}))}(this)}var Rs=new Z(ne,"https://apis.google.com/js/api.js?onload=%{onload}"),Ps=new Or(3e4,6e4),Fs=new Or(5e3,15e3),js=null;function Bs(e,t,n){this.i=e,this.g=t,this.h=n,this.f=null,this.a=In(this.i,"/__/auth/iframe"),Sn(this.a,"apiKey",this.g),Sn(this.a,"appName",this.h),this.b=null,this.c=[]}function Vs(e,t,n,r,i){this.o=e,this.m=t,this.c=n,this.u=r,this.i=this.g=this.l=null,this.a=i,this.h=this.f=null}function Ws(e){try{return r.a.app(e).auth().Ca()}catch(t){return[]}}function Us(e,t,n,r,i){this.u=e,this.f=t,this.b=n,this.c=r||null,this.h=i||null,this.m=this.o=this.v=null,this.g=[],this.l=this.a=null}function Hs(e){var t=nr();return function(e){return Ls(e,gs,{}).then((function(e){return e.authorizedDomains||[]}))}(e).then((function(e){e:{var n=xn(t),r=n.f;n=n.b;for(var i=0;i<e.length;i++){var o=e[i],a=n,s=r;if(0==o.indexOf("chrome-extension://")?a=xn(o).b==a&&"chrome-extension"==s:"http"!=s&&"https"!=s?a=!1:sr.test(o)?a=a==o:(o=o.split(".").join("\\."),a=new RegExp("^(.+\\."+o+"|"+o+")$","i").test(a)),a){e=!0;break e}}e=!1}if(!e)throw new No(nr())}))}function zs(e){return e.l?e.l:(e.l=cr().then((function(){if(!e.o){var t=e.c,n=e.h,r=Ws(e.b),i=new Bs(e.u,e.f,e.b);i.f=t,i.b=n,i.c=G(r||[]),e.o=i.toString()}e.i=new Ms(e.o),function(e){if(!e.i)throw Error("IfcHandler must be initialized!");!function(e,t){e.gb.then((function(){e.a.register("authEvent",t,_r("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"))}))}(e.i,(function(t){var n={};if(t&&t.authEvent){var r=!1;for(t=xo(t.authEvent),n=0;n<e.g.length;n++)r=e.g[n](t)||r;return(n={}).status=r?"ACK":"ERROR",Ze(n)}return n.status="ERROR",Ze(n)}))}(e)})),e.l)}function qs(e){return e.m||(e.v=e.c?br(e.c,Ws(e.b)):null,e.m=new Ma(e.f,Di(e.h),e.v)),e.m}function Ks(e,t,n,r,i,o,a,s,u,c,l){return(e=new Vs(e,t,n,r,i)).l=o,e.g=a,e.i=s,e.b=Y(u||null),e.f=c,e.nb(l).toString()}function Gs(e){if(this.a=e||r.a.INTERNAL.reactNative&&r.a.INTERNAL.reactNative.AsyncStorage,!this.a)throw new ei("internal-error","The React Native compatibility library was not found.");this.type="asyncStorage"}function Qs(e){this.b=e,this.a={},this.f=S(this.c,this)}Bs.prototype.toString=function(){return this.f?Sn(this.a,"v",this.f):Bn(this.a.a,"v"),this.b?Sn(this.a,"eid",this.b):Bn(this.a.a,"eid"),this.c.length?Sn(this.a,"fw",this.c.join(",")):Bn(this.a.a,"fw"),this.a.toString()},Vs.prototype.nb=function(e){return this.h=e,this},Vs.prototype.toString=function(){var e=In(this.o,"/__/auth/handler");if(Sn(e,"apiKey",this.m),Sn(e,"appName",this.c),Sn(e,"authType",this.u),this.a.isOAuthProvider){var t=this.a;try{var n=r.a.app(this.c).auth().ha()}catch(u){n=null}for(var i in t.bb=n,Sn(e,"providerId",this.a.providerId),n=kr((t=this.a).zb))n[i]=n[i].toString();i=t.Fc,n=Y(n);for(var o=0;o<i.length;o++){var a=i[o];a in n&&delete n[a]}t.eb&&t.bb&&!n[t.eb]&&(n[t.eb]=t.bb),$(n)||Sn(e,"customParameters",Ir(n))}if("function"==typeof this.a.Hb&&((t=this.a.Hb()).length&&Sn(e,"scopes",t.join(","))),this.l?Sn(e,"redirectUrl",this.l):Bn(e.a,"redirectUrl"),this.g?Sn(e,"eventId",this.g):Bn(e.a,"eventId"),this.i?Sn(e,"v",this.i):Bn(e.a,"v"),this.b)for(var s in this.b)this.b.hasOwnProperty(s)&&!En(e,s)&&Sn(e,s,this.b[s]);return this.h?Sn(e,"tid",this.h):Bn(e.a,"tid"),this.f?Sn(e,"eid",this.f):Bn(e.a,"eid"),(s=Ws(this.c)).length&&Sn(e,"fw",s.join(",")),e.toString()},(t=Us.prototype).Fb=function(e,t,n){var r=new ei("popup-closed-by-user"),i=new ei("web-storage-unsupported"),o=this,a=!1;return this.ia().then((function(){(function(e){var t={type:"webStorageSupport"};return zs(e).then((function(){return function(e,t){return e.gb.then((function(){return new Ke((function(n){e.a.send(t.type,t,n,_r("gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER"))}))}))}(e.i,t)})).then((function(e){if(e&&e.length&&void 0!==e[0].webStorageSupport)return e[0].webStorageSupport;throw Error()}))})(o).then((function(n){n||(e&&or(e),t(i),a=!0)}))})).s((function(){})).then((function(){if(!a)return function(e){return new Ke((function(t){return function n(){pn(2e3).then((function(){if(e&&!e.closed)return n();t()}))}()}))}(e)})).then((function(){if(!a)return pn(n).then((function(){t(r)}))}))},t.Ob=function(){var e=wr();return!xr(e)&&!Lr(e)},t.Jb=function(){return!1},t.Db=function(e,t,n,r,i,o,a,s){if(!e)return et(new ei("popup-blocked"));if(a&&!xr())return this.ia().s((function(t){or(e),i(t)})),r(),Ze();this.a||(this.a=Hs(qs(this)));var u=this;return this.a.then((function(){var t=u.ia().s((function(t){throw or(e),i(t),t}));return r(),t})).then((function(){(So(n),a)||rr(Ks(u.u,u.f,u.b,t,n,null,o,u.c,void 0,u.h,s),e)})).s((function(e){throw"auth/network-request-failed"==e.code&&(u.a=null),e}))},t.Eb=function(e,t,n,r){this.a||(this.a=Hs(qs(this)));var i=this;return this.a.then((function(){So(t),rr(Ks(i.u,i.f,i.b,e,t,nr(),n,i.c,void 0,i.h,r))})).s((function(e){throw"auth/network-request-failed"==e.code&&(i.a=null),e}))},t.ia=function(){var e=this;return zs(this).then((function(){return e.i.gb})).s((function(){throw e.a=null,new ei("network-request-failed")}))},t.Rb=function(){return!0},t.Aa=function(e){this.g.push(e)},t.Na=function(e){q(this.g,(function(t){return t==e}))},(t=Gs.prototype).get=function(e){return Ze(this.a.getItem(e)).then((function(e){return e&&Ar(e)}))},t.set=function(e,t){return Ze(this.a.setItem(e,Ir(t)))},t.S=function(e){return Ze(this.a.removeItem(e))},t.$=function(){},t.ea=function(){};var $s,Ys=[];function Xs(e,t,n){$(e.a)&&e.b.addEventListener("message",e.f),void 0===e.a[t]&&(e.a[t]=[]),e.a[t].push(n)}function Js(e){this.a=e}function Zs(e){this.c=e,this.b=!1,this.a=[]}function eu(e,t,n,r){var i,o,a,s,u=n||{},c=null;if(e.b)return et(Error("connection_unavailable"));var l=r?800:50,h="undefined"!=typeof MessageChannel?new MessageChannel:null;return new Ke((function(n,r){h?(i=Math.floor(Math.random()*Math.pow(10,20)).toString(),h.port1.start(),a=setTimeout((function(){r(Error("unsupported_event"))}),l),c={messageChannel:h,onMessage:o=function(e){e.data.eventId===i&&("ack"===e.data.status?(clearTimeout(a),s=setTimeout((function(){r(Error("timeout"))}),3e3)):"done"===e.data.status?(clearTimeout(s),void 0!==e.data.response?n(e.data.response):r(Error("unknown_error"))):(clearTimeout(a),clearTimeout(s),r(Error("invalid_response"))))}},e.a.push(c),h.port1.addEventListener("message",o),e.c.postMessage({eventType:t,eventId:i,data:u},[h.port2])):r(Error("connection_unavailable"))})).then((function(t){return tu(e,c),t})).s((function(t){throw tu(e,c),t}))}function tu(e,t){if(t){var n=t.messageChannel,r=t.onMessage;n&&(n.port1.removeEventListener("message",r),n.port1.close()),q(e.a,(function(e){return e==t}))}}function nu(){if(!ou())throw new ei("web-storage-unsupported");this.c={},this.a=[],this.b=0,this.u=u.indexedDB,this.type="indexedDB",this.g=this.l=this.f=this.i=null,this.o=!1,this.h=null;var e=this;dr()&&self?(this.l=function(){var e=dr()?self:null;if(V(Ys,(function(n){n.b==e&&(t=n)})),!t){var t=new Qs(e);Ys.push(t)}return t}(),Xs(this.l,"keyChanged",(function(t,n){return lu(e).then((function(t){return 0<t.length&&V(e.a,(function(e){e(t)})),{keyProcessed:H(t,n.key)}}))})),Xs(this.l,"ping",(function(){return Ze(["keyChanged"])}))):function(){var e=u.navigator;return e&&e.serviceWorker?Ze().then((function(){return e.serviceWorker.ready})).then((function(e){return e.active||null})).s((function(){return null})):Ze(null)}().then((function(t){(e.h=t)&&(e.g=new Zs(new Js(t)),eu(e.g,"ping",null,!0).then((function(t){t[0].fulfilled&&H(t[0].value,"keyChanged")&&(e.o=!0)})).s((function(){})))}))}function ru(e){return new Ke((function(t,n){var r=e.u.open("firebaseLocalStorageDb",1);r.onerror=function(e){try{e.preventDefault()}catch(t){}n(Error(e.target.error))},r.onupgradeneeded=function(e){e=e.target.result;try{e.createObjectStore("firebaseLocalStorage",{keyPath:"fbase_key"})}catch(t){n(t)}},r.onsuccess=function(r){(r=r.target.result).objectStoreNames.contains("firebaseLocalStorage")?t(r):function(e){return new Ke((function(t,n){var r=e.u.deleteDatabase("firebaseLocalStorageDb");r.onsuccess=function(){t()},r.onerror=function(e){n(Error(e.target.error))}}))}(e).then((function(){return ru(e)})).then((function(e){t(e)})).s((function(e){n(e)}))}}))}function iu(e){return e.m||(e.m=ru(e)),e.m}function ou(){try{return!!u.indexedDB}catch(bt){return!1}}function au(e){return e.objectStore("firebaseLocalStorage")}function su(e,t){return e.transaction(["firebaseLocalStorage"],t?"readwrite":"readonly")}function uu(e){return new Ke((function(t,n){e.onsuccess=function(e){e&&e.target?t(e.target.result):t()},e.onerror=function(e){n(e.target.error)}}))}function cu(e,t){return e.g&&e.h&&function(){var e=u.navigator;return e&&e.serviceWorker&&e.serviceWorker.controller||null}()===e.h?eu(e.g,"keyChanged",{key:t},e.o).then((function(){})).s((function(){})):Ze()}function lu(e){return iu(e).then((function(e){var t=au(su(e,!1));return t.getAll?uu(t.getAll()):new Ke((function(e,n){var r=[],i=t.openCursor();i.onsuccess=function(t){(t=t.target.result)?(r.push(t.value),t.continue()):e(r)},i.onerror=function(e){n(e.target.error)}}))})).then((function(t){var n={},r=[];if(0==e.b){for(r=0;r<t.length;r++)n[t[r].fbase_key]=t[r].value;r=function e(t,n){var r,i=[];for(r in t)r in n?typeof t[r]!=typeof n[r]?i.push(r):"object"==typeof t[r]&&null!=t[r]&&null!=n[r]?0<e(t[r],n[r]).length&&i.push(r):t[r]!==n[r]&&i.push(r):i.push(r);for(r in n)r in t||i.push(r);return i}(e.c,n),e.c=n}return r}))}function hu(e){e.i&&e.i.cancel("STOP_EVENT"),e.f&&(clearTimeout(e.f),e.f=null)}function du(e){var t=this,n=null;this.a=[],this.type="indexedDB",this.c=e,this.b=Ze().then((function(){if(ou()){var e=Nr(),r="__sak"+e;return $s||($s=new nu),(n=$s).set(r,e).then((function(){return n.get(r)})).then((function(t){if(t!==e)throw Error("indexedDB not supported!");return n.S(r)})).then((function(){return n})).s((function(){return t.c}))}return t.c})).then((function(e){return t.type=e.type,e.$((function(e){V(t.a,(function(t){t(e)}))})),e}))}function pu(){this.a={},this.type="inMemory"}function fu(){if(!function(){var e="Node"==pr();if(!(e=mu()||e&&r.a.INTERNAL.node&&r.a.INTERNAL.node.localStorage))return!1;try{return e.setItem("__sak","1"),e.removeItem("__sak"),!0}catch(t){return!1}}()){if("Node"==pr())throw new ei("internal-error","The LocalStorage compatibility library was not found.");throw new ei("web-storage-unsupported")}this.a=mu()||r.a.INTERNAL.node.localStorage,this.type="localStorage"}function mu(){try{var e=u.localStorage,t=Nr();return e&&(e.setItem(t,"1"),e.removeItem(t)),e}catch(n){return null}}function gu(){this.type="nullStorage"}function vu(){if(!function(){var e="Node"==pr();if(!(e=yu()||e&&r.a.INTERNAL.node&&r.a.INTERNAL.node.sessionStorage))return!1;try{return e.setItem("__sak","1"),e.removeItem("__sak"),!0}catch(t){return!1}}()){if("Node"==pr())throw new ei("internal-error","The SessionStorage compatibility library was not found.");throw new ei("web-storage-unsupported")}this.a=yu()||r.a.INTERNAL.node.sessionStorage,this.type="sessionStorage"}function yu(){try{var e=u.sessionStorage,t=Nr();return e&&(e.setItem(t,"1"),e.removeItem(t)),e}catch(n){return null}}function bu(){var e={};e.Browser=Cu,e.Node=Tu,e.ReactNative=Su,e.Worker=Eu,this.a=e[pr()]}Qs.prototype.c=function(e){var t=e.data.eventType,n=e.data.eventId,r=this.a[t];if(r&&0<r.length){e.ports[0].postMessage({status:"ack",eventId:n,eventType:t,response:null});var i=[];V(r,(function(t){i.push(Ze().then((function(){return t(e.origin,e.data.data)})))})),nt(i).then((function(r){var i=[];V(r,(function(e){i.push({fulfilled:e.Gb,value:e.value,reason:e.reason?e.reason.message:void 0})})),V(i,(function(e){for(var t in e)void 0===e[t]&&delete e[t]})),e.ports[0].postMessage({status:"done",eventId:n,eventType:t,response:i})}))}},Js.prototype.postMessage=function(e,t){this.a.postMessage(e,t)},Zs.prototype.close=function(){for(;0<this.a.length;)tu(this,this.a[0]);this.b=!0},(t=nu.prototype).set=function(e,t){var n,r=!1,i=this;return iu(this).then((function(t){return uu((t=au(su(n=t,!0))).get(e))})).then((function(o){var a=au(su(n,!0));return o?(o.value=t,uu(a.put(o))):(i.b++,r=!0,(o={}).fbase_key=e,o.value=t,uu(a.add(o)))})).then((function(){return i.c[e]=t,cu(i,e)})).ka((function(){r&&i.b--}))},t.get=function(e){return iu(this).then((function(t){return uu(au(su(t,!1)).get(e))})).then((function(e){return e&&e.value}))},t.S=function(e){var t=!1,n=this;return iu(this).then((function(r){return t=!0,n.b++,uu(au(su(r,!0)).delete(e))})).then((function(){return delete n.c[e],cu(n,e)})).ka((function(){t&&n.b--}))},t.$=function(e){0==this.a.length&&function(e){hu(e),function t(){e.f=setTimeout((function(){e.i=lu(e).then((function(t){0<t.length&&V(e.a,(function(e){e(t)}))})).then((function(){t()})).s((function(e){"STOP_EVENT"!=e.message&&t()}))}),800)}()}(this),this.a.push(e)},t.ea=function(e){q(this.a,(function(t){return t==e})),0==this.a.length&&hu(this)},(t=du.prototype).get=function(e){return this.b.then((function(t){return t.get(e)}))},t.set=function(e,t){return this.b.then((function(n){return n.set(e,t)}))},t.S=function(e){return this.b.then((function(t){return t.S(e)}))},t.$=function(e){this.a.push(e)},t.ea=function(e){q(this.a,(function(t){return t==e}))},(t=pu.prototype).get=function(e){return Ze(this.a[e])},t.set=function(e,t){return this.a[e]=t,Ze()},t.S=function(e){return delete this.a[e],Ze()},t.$=function(){},t.ea=function(){},(t=fu.prototype).get=function(e){var t=this;return Ze().then((function(){return Ar(t.a.getItem(e))}))},t.set=function(e,t){var n=this;return Ze().then((function(){var r=Ir(t);null===r?n.S(e):n.a.setItem(e,r)}))},t.S=function(e){var t=this;return Ze().then((function(){t.a.removeItem(e)}))},t.$=function(e){u.window&&$t(u.window,"storage",e)},t.ea=function(e){u.window&&Jt(u.window,"storage",e)},(t=gu.prototype).get=function(){return Ze(null)},t.set=function(){return Ze()},t.S=function(){return Ze()},t.$=function(){},t.ea=function(){},(t=vu.prototype).get=function(e){var t=this;return Ze().then((function(){return Ar(t.a.getItem(e))}))},t.set=function(e,t){var n=this;return Ze().then((function(){var r=Ir(t);null===r?n.S(e):n.a.setItem(e,r)}))},t.S=function(e){var t=this;return Ze().then((function(){t.a.removeItem(e)}))},t.$=function(){},t.ea=function(){};var wu,_u,Cu={C:fu,Ta:vu},Tu={C:fu,Ta:vu},Su={C:Gs,Ta:gu},Eu={C:fu,Ta:gu},xu={ad:"local",NONE:"none",cd:"session"};function Iu(){var e=!(Lr(wr())||!hr()),t=xr(),n=Cr();this.m=e,this.h=t,this.l=n,this.a={},wu||(wu=new bu),e=wu;try{this.g=!tr()&&Pr()||!u.indexedDB?new e.a.C:new du(dr()?new pu:new e.a.C)}catch(r){this.g=new pu,this.h=!0}try{this.i=new e.a.Ta}catch(r){this.i=new pu}this.u=new pu,this.f=S(this.Pb,this),this.b={}}function ku(){return _u||(_u=new Iu),_u}function Au(e,t){switch(t){case"session":return e.i;case"none":return e.u;default:return e.g}}function Nu(e,t){return"firebase:"+e.name+(t?":"+t:"")}function Lu(e,t,n){return n=Nu(t,n),"local"==t.C&&(e.b[n]=null),Au(e,t.C).S(n)}function Du(e){e.c&&(clearInterval(e.c),e.c=null)}function Ou(e){this.a=e,this.b=ku()}(t=Iu.prototype).get=function(e,t){return Au(this,e.C).get(Nu(e,t))},t.set=function(e,t,n){var r=Nu(e,n),i=this,o=Au(this,e.C);return o.set(r,t).then((function(){return o.get(r)})).then((function(t){"local"==e.C&&(i.b[r]=t)}))},t.addListener=function(e,t,n){e=Nu(e,t),this.l&&(this.b[e]=u.localStorage.getItem(e)),$(this.a)&&(Au(this,"local").$(this.f),this.h||(tr()||!Pr())&&u.indexedDB||!this.l||function(e){Du(e),e.c=setInterval((function(){for(var t in e.a){var n=u.localStorage.getItem(t),r=e.b[t];n!=r&&(e.b[t]=n,n=new jt({type:"storage",key:t,target:window,oldValue:r,newValue:n,a:!0}),e.Pb(n))}}),1e3)}(this)),this.a[e]||(this.a[e]=[]),this.a[e].push(n)},t.removeListener=function(e,t,n){e=Nu(e,t),this.a[e]&&(q(this.a[e],(function(e){return e==n})),0==this.a[e].length&&delete this.a[e]),$(this.a)&&(Au(this,"local").ea(this.f),Du(this))},t.Pb=function(e){if(e&&e.f){var t=e.a.key;if(null==t)for(var n in this.a){var r=this.b[n];void 0===r&&(r=null);var i=u.localStorage.getItem(n);i!==r&&(this.b[n]=i,this.$a(n))}else if(0==t.indexOf("firebase:")&&this.a[t]){if(void 0!==e.a.a?Au(this,"local").ea(this.f):Du(this),this.m)if(n=u.localStorage.getItem(t),(r=e.a.newValue)!==n)null!==r?u.localStorage.setItem(t,r):u.localStorage.removeItem(t);else if(this.b[t]===r&&void 0===e.a.a)return;var o=this;n=function(){void 0===e.a.a&&o.b[t]===u.localStorage.getItem(t)||(o.b[t]=u.localStorage.getItem(t),o.$a(t))},_t&&Nt&&10==Nt&&u.localStorage.getItem(t)!==e.a.newValue&&e.a.newValue!==e.a.oldValue?setTimeout(n,10):n()}}else V(e,S(this.$a,this))},t.$a=function(e){this.a[e]&&V(this.a[e],(function(e){e()}))};var Mu,Ru={name:"authEvent",C:"local"};function Pu(){this.a=ku()}function Fu(e,t){this.b=ju,this.f=u.Uint8Array?new Uint8Array(this.b):Array(this.b),this.g=this.c=0,this.a=[],this.i=e,this.h=t,this.l=u.Int32Array?new Int32Array(64):Array(64),void 0!==Mu||(Mu=u.Int32Array?new Int32Array(qu):qu),this.reset()}I(Fu,(function(){this.b=-1}));for(var ju=64,Bu=ju-1,Vu=[],Wu=0;Wu<Bu;Wu++)Vu[Wu]=0;var Uu=K(128,Vu);function Hu(e){for(var t=e.f,n=e.l,r=0,i=0;i<t.length;)n[r++]=t[i]<<24|t[i+1]<<16|t[i+2]<<8|t[i+3],i=4*r;for(t=16;64>t;t++){i=0|n[t-15],r=0|n[t-2];var o=(0|n[t-16])+((i>>>7|i<<25)^(i>>>18|i<<14)^i>>>3)|0,a=(0|n[t-7])+((r>>>17|r<<15)^(r>>>19|r<<13)^r>>>10)|0;n[t]=o+a|0}r=0|e.a[0],i=0|e.a[1];var s=0|e.a[2],u=0|e.a[3],c=0|e.a[4],l=0|e.a[5],h=0|e.a[6];for(o=0|e.a[7],t=0;64>t;t++){var d=((r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10))+(r&i^r&s^i&s)|0;a=(o=o+((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))|0)+((a=(a=c&l^~c&h)+(0|Mu[t])|0)+(0|n[t])|0)|0,o=h,h=l,l=c,c=u+a|0,u=s,s=i,i=r,r=a+d|0}e.a[0]=e.a[0]+r|0,e.a[1]=e.a[1]+i|0,e.a[2]=e.a[2]+s|0,e.a[3]=e.a[3]+u|0,e.a[4]=e.a[4]+c|0,e.a[5]=e.a[5]+l|0,e.a[6]=e.a[6]+h|0,e.a[7]=e.a[7]+o|0}function zu(e,t,n){void 0===n&&(n=t.length);var r=0,i=e.c;if(c(t))for(;r<n;)e.f[i++]=t.charCodeAt(r++),i==e.b&&(Hu(e),i=0);else{if(!v(t))throw Error("message must be string or array");for(;r<n;){var o=t[r++];if(!("number"==typeof o&&0<=o&&255>=o&&o==(0|o)))throw Error("message must be a byte array");e.f[i++]=o,i==e.b&&(Hu(e),i=0)}}e.c=i,e.g+=n}Fu.prototype.reset=function(){this.g=this.c=0,this.a=u.Int32Array?new Int32Array(this.h):G(this.h)};var qu=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function Ku(){Fu.call(this,8,Gu)}I(Ku,Fu);var Gu=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];function Qu(e,t,n,r,i){this.u=e,this.i=t,this.l=n,this.m=r||null,this.o=i||null,this.h=t+":"+n,this.v=new Pu,this.g=new Ou(this.h),this.f=null,this.b=[],this.a=this.c=null}function $u(e){return new ei("invalid-cordova-configuration",e)}function Yu(e){var t=new Ku;zu(t,e),e=[];var n=8*t.g;56>t.c?zu(t,Uu,56-t.c):zu(t,Uu,t.b-(t.c-56));for(var r=63;56<=r;r--)t.f[r]=255&n,n/=256;for(Hu(t),r=n=0;r<t.i;r++)for(var i=24;0<=i;i-=8)e[n++]=t.a[r]>>i&255;return function(e){return W(e,(function(e){return 1<(e=e.toString(16)).length?e:"0"+e})).join("")}(e)}function Xu(e,t){for(var n=0;n<e.b.length;n++)try{e.b[n](t)}catch(r){}}function Ju(e){return e.f||(e.f=e.ia().then((function(){return new Ke((function(t){e.Aa((function n(r){return t(r),e.Na(n),!1})),function(e){function t(t){r=!0,i&&i.cancel(),Zu(e).then((function(r){var i=n;if(r&&t&&t.url){var o=null;-1!=(i=Ki(t.url)).indexOf("/__/auth/callback")&&(o=(o="object"==typeof(o=Ar(En(o=xn(i),"firebaseError")||null))?ti(o):null)?new Eo(r.c,r.b,null,null,o,null,r.R()):new Eo(r.c,r.b,i,r.f,null,null,r.R())),i=o||n}Xu(e,i)}))}var n=new Eo("unknown",null,null,null,new ei("no-auth-event")),r=!1,i=pn(500).then((function(){return Zu(e).then((function(){r||Xu(e,n)}))})),o=u.handleOpenURL;u.handleOpenURL=function(e){if(0==e.toLowerCase().indexOf(_r("BuildInfo.packageName",u).toLowerCase()+"://")&&t({url:e}),"function"==typeof o)try{o(e)}catch(n){console.error(n)}},Ao||(Ao=new Io),function(e){var t=Ao;t.a.push(e),t.b||(t.b=function(e){for(var n=0;n<t.a.length;n++)t.a[n](e)},"function"==typeof(e=_r("universalLinks.subscribe",u))&&e(null,t.b))}(t)}(e)}))}))),e.f}function Zu(e){var t=null;return function(e){return e.b.get(Ru,e.a).then((function(e){return xo(e)}))}(e.g).then((function(n){return t=n,Lu((n=e.g).b,Ru,n.a)})).then((function(){return t}))}function ec(e){this.a=e,this.b=ku()}(t=Qu.prototype).ia=function(){return this.Da?this.Da:this.Da=(lr(void 0)?cr().then((function(){return new Ke((function(e,t){var n=u.document,r=setTimeout((function(){t(Error("Cordova framework is not ready."))}),1e3);n.addEventListener("deviceready",(function(){clearTimeout(r),e()}),!1)}))})):et(Error("Cordova must run in an Android or iOS file scheme."))).then((function(){if("function"!=typeof _r("universalLinks.subscribe",u))throw $u("cordova-universal-links-plugin-fix is not installed");if(void 0===_r("BuildInfo.packageName",u))throw $u("cordova-plugin-buildinfo is not installed");if("function"!=typeof _r("cordova.plugins.browsertab.openUrl",u))throw $u("cordova-plugin-browsertab is not installed");if("function"!=typeof _r("cordova.InAppBrowser.open",u))throw $u("cordova-plugin-inappbrowser is not installed")}),(function(){throw new ei("cordova-not-ready")}))},t.Fb=function(e,t){return t(new ei("operation-not-supported-in-this-environment")),Ze()},t.Db=function(){return et(new ei("operation-not-supported-in-this-environment"))},t.Rb=function(){return!1},t.Ob=function(){return!0},t.Jb=function(){return!0},t.Eb=function(e,t,n,r){if(this.c)return et(new ei("redirect-operation-pending"));var i=this,o=u.document,a=null,s=null,c=null,l=null;return this.c=Ze().then((function(){return So(t),Ju(i)})).then((function(){return function(e,t,n,r,i){var o=function(){for(var e=20,t=[];0<e;)t.push("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(62*Math.random()))),e--;return t.join("")}(),a=new Eo(t,r,null,o,new ei("no-auth-event"),null,i),s=_r("BuildInfo.packageName",u);if("string"!=typeof s)throw new ei("invalid-cordova-configuration");var c=_r("BuildInfo.displayName",u),l={};if(wr().toLowerCase().match(/iphone|ipad|ipod/))l.ibi=s;else{if(!wr().toLowerCase().match(/android/))return et(new ei("operation-not-supported-in-this-environment"));l.apn=s}c&&(l.appDisplayName=c),o=Yu(o),l.sessionId=o;var h=Ks(e.u,e.i,e.l,t,n,null,r,e.m,l,e.o,i);return e.ia().then((function(){var t=e.h;return e.v.a.set(Ru,a.A(),t)})).then((function(){var t=_r("cordova.plugins.browsertab.isAvailable",u);if("function"!=typeof t)throw new ei("invalid-cordova-configuration");var n=null;t((function(t){if(t){if("function"!=typeof(n=_r("cordova.plugins.browsertab.openUrl",u)))throw new ei("invalid-cordova-configuration");n(h)}else{if("function"!=typeof(n=_r("cordova.InAppBrowser.open",u)))throw new ei("invalid-cordova-configuration");t=wr(),e.a=n(h,t.match(/(iPad|iPhone|iPod).*OS 7_\d/i)||t.match(/(iPad|iPhone|iPod).*OS 8_\d/i)?"_blank":"_system","location=yes")}}))}))}(i,e,t,n,r)})).then((function(){return new Ke((function(e,t){s=function(){var t=_r("cordova.plugins.browsertab.close",u);return e(),"function"==typeof t&&t(),i.a&&"function"==typeof i.a.close&&(i.a.close(),i.a=null),!1},i.Aa(s),c=function(){a||(a=pn(2e3).then((function(){t(new ei("redirect-cancelled-by-user"))})))},l=function(){Mr()&&c()},o.addEventListener("resume",c,!1),wr().toLowerCase().match(/android/)||o.addEventListener("visibilitychange",l,!1)})).s((function(e){return Zu(i).then((function(){throw e}))}))})).ka((function(){c&&o.removeEventListener("resume",c,!1),l&&o.removeEventListener("visibilitychange",l,!1),a&&a.cancel(),s&&i.Na(s),i.c=null}))},t.Aa=function(e){this.b.push(e),Ju(this).s((function(t){"auth/invalid-cordova-configuration"===t.code&&(t=new Eo("unknown",null,null,null,new ei("no-auth-event")),e(t))}))},t.Na=function(e){q(this.b,(function(t){return t==e}))};var tc={name:"pendingRedirect",C:"session"};function nc(e){return Lu(e.b,tc,e.a)}function rc(e,t,n){this.i={},this.v=0,this.B=e,this.u=t,this.m=n,this.h=[],this.f=!1,this.l=S(this.o,this),this.b=new vc,this.w=new Cc,this.g=new ec(this.u+":"+this.m),this.c={},this.c.unknown=this.b,this.c.signInViaRedirect=this.b,this.c.linkViaRedirect=this.b,this.c.reauthViaRedirect=this.b,this.c.signInViaPopup=this.w,this.c.linkViaPopup=this.w,this.c.reauthViaPopup=this.w,this.a=ic(this.B,this.u,this.m,Ni)}function ic(e,t,n,i){var o=r.a.SDK_VERSION||null;return lr()?new Qu(e,t,n,o,i):new Us(e,t,n,o,i)}function oc(e){e.f||(e.f=!0,e.a.Aa(e.l));var t=e.a;return e.a.ia().s((function(n){throw e.a==t&&e.reset(),n}))}function ac(e){e.a.Ob()&&oc(e).s((function(t){var n=new Eo("unknown",null,null,null,new ei("operation-not-supported-in-this-environment"));dc(t)&&e.o(n)})),e.a.Jb()||yc(e.b)}function sc(e,t){H(e.h,t)||e.h.push(t),e.f||function(e){return e.b.get(tc,e.a).then((function(e){return"pending"==e}))}(e.g).then((function(t){t?nc(e.g).then((function(){oc(e).s((function(t){var n=new Eo("unknown",null,null,null,new ei("operation-not-supported-in-this-environment"));dc(t)&&e.o(n)}))})):ac(e)})).s((function(){ac(e)}))}function uc(e,t){q(e.h,(function(e){return e==t}))}rc.prototype.reset=function(){this.f=!1,this.a.Na(this.l),this.a=ic(this.B,this.u,this.m),this.i={}},rc.prototype.o=function(e){if(!e)throw new ei("invalid-auth-event");if(6e5<=x()-this.v&&(this.i={},this.v=0),e&&e.getUid()&&this.i.hasOwnProperty(e.getUid()))return!1;for(var t=!1,n=0;n<this.h.length;n++){var r=this.h[n];if(r.xb(e.c,e.b)){(t=this.c[e.c])&&(t.h(e,r),e&&(e.f||e.b)&&(this.i[e.getUid()]=!0,this.v=x())),t=!0;break}}return yc(this.b),t};var cc=new Or(2e3,1e4),lc=new Or(3e4,6e4);function hc(e,t,n,r,i,o,a){return e.a.Db(t,n,r,(function(){e.f||(e.f=!0,e.a.Aa(e.l))}),(function(){e.reset()}),i,o,a)}function dc(e){return!(!e||"auth/cordova-not-ready"!=e.code)}function pc(e,t,n,r,i){var o;return function(e){return e.b.set(tc,"pending",e.a)}(e.g).then((function(){return e.a.Eb(t,n,r,i).s((function(t){if(dc(t))throw new ei("operation-not-supported-in-this-environment");return o=t,nc(e.g).then((function(){throw o}))})).then((function(){return e.a.Rb()?new Ke((function(){})):nc(e.g).then((function(){return e.oa()})).then((function(){})).s((function(){}))}))}))}function fc(e,t,n,r,i){return e.a.Fb(r,(function(e){t.ja(n,null,e,i)}),cc.get())}rc.prototype.oa=function(){return this.b.oa()};var mc={};function gc(e,t,n){var r=t+":"+n;return mc[r]||(mc[r]=new rc(e,t,n)),mc[r]}function vc(){this.b=null,this.f=[],this.c=[],this.a=null,this.i=this.g=!1}function yc(e){e.g||(e.g=!0,_c(e,!1,null,null))}function bc(e){e.g&&!e.i&&_c(e,!1,null,null)}function wc(e,t){if(e.b=function(){return Ze(t)},e.f.length)for(var n=0;n<e.f.length;n++)e.f[n](t)}function _c(e,t,n,r){t?r?function(e,t){if(e.b=function(){return et(t)},e.c.length)for(var n=0;n<e.c.length;n++)e.c[n](t)}(e,r):wc(e,n):wc(e,{user:null}),e.f=[],e.c=[]}function Cc(){}function Tc(){this.vb=!1,Object.defineProperty(this,"appVerificationDisabled",{get:function(){return this.vb},set:function(e){this.vb=e},enumerable:!1})}function Sc(e,t){this.a=t,Wr(this,"verificationId",e)}function Ec(e,t,n,r){return new _o(e).Wa(t,n).then((function(e){return new Sc(e,r)}))}function xc(e){var t=Ai(e);if(!(t&&t.exp&&t.auth_time&&t.iat))throw new ei("internal-error","An internal error occurred. The token obtained by Firebase appears to be malformed. Please retry the operation.");Ur(this,{token:e,expirationTime:Rr(1e3*t.exp),authTime:Rr(1e3*t.auth_time),issuedAtTime:Rr(1e3*t.iat),signInProvider:t.firebase&&t.firebase.sign_in_provider?t.firebase.sign_in_provider:null,claims:t})}function Ic(e,t,n){if(this.h=e,this.i=t,this.g=n,this.c=3e4,this.f=96e4,this.b=null,this.a=this.c,this.f<this.c)throw Error("Proactive refresh lower bound greater than upper bound!")}function kc(e){this.f=e,this.b=this.a=null,this.c=0}function Ac(e,t){var n=t[Pa],r=t.refreshToken;t=Nc(t.expiresIn),e.b=n,e.c=t,e.a=r}function Nc(e){return x()+1e3*parseInt(e,10)}function Lc(e,t){return function(e,t){return new Ke((function(n,r){"refresh_token"==t.grant_type&&t.refresh_token||"authorization_code"==t.grant_type&&t.code?Ha(e,e.l+"?key="+encodeURIComponent(e.c),(function(e){e?e.error?r(Os(e)):e.access_token&&e.refresh_token?n(e):r(new ei("internal-error")):r(new ei("network-request-failed"))}),"POST",jn(t).toString(),e.g,e.u.get()):r(new ei("internal-error"))}))}(e.f,t).then((function(t){return e.b=t.access_token,e.c=Nc(t.expires_in),e.a=t.refresh_token,{accessToken:e.b,expirationTime:e.c,refreshToken:e.a}})).s((function(t){throw"auth/user-token-expired"==t.code&&(e.a=null),t}))}function Dc(e,t){this.a=e||null,this.b=t||null,Ur(this,{lastSignInTime:Rr(t||null),creationTime:Rr(e||null)})}function Oc(e,t,n,r,i,o){Ur(this,{uid:e,displayName:r||null,photoURL:i||null,email:n||null,phoneNumber:o||null,providerId:t})}function Mc(e,t){for(var n in Ft.call(this,e),t)this[n]=t[n]}function Rc(e,t,n){this.I=[],this.l=e.apiKey,this.m=e.appName,this.o=e.authDomain||null,e=r.a.SDK_VERSION?br(r.a.SDK_VERSION):null,this.a=new Ma(this.l,Di(Ni),e),this.b=new kc(this.a),Uc(this,t[Pa]),Ac(this.b,t),Wr(this,"refreshToken",this.b.a),qc(this,n||{}),un.call(this),this.J=!1,this.o&&Tr()&&(this.i=gc(this.o,this.l,this.m)),this.O=[],this.h=null,this.w=function(e){return new Ic((function(){return e.G(!0)}),(function(e){return!(!e||"auth/network-request-failed"!=e.code)}),(function(){var t=e.b.c-x()-3e5;return 0<t?t:0}))}(this),this.W=S(this.Ja,this);var i=this;this.ga=null,this.xa=function(e){i.ua(e.g)},this.Z=null,this.P=[],this.wa=function(e){Fc(i,e.c)},this.Y=null}function Pc(e,t){e.Z&&Jt(e.Z,"languageCodeChanged",e.xa),(e.Z=t)&&$t(t,"languageCodeChanged",e.xa)}function Fc(e,t){e.P=t,Ua(e.a,r.a.SDK_VERSION?br(r.a.SDK_VERSION,e.P):null)}function jc(e,t){e.Y&&Jt(e.Y,"frameworkChanged",e.wa),(e.Y=t)&&$t(t,"frameworkChanged",e.wa)}function Bc(e){try{return r.a.app(e.m).auth()}catch(t){throw new ei("internal-error","No firebase.auth.Auth instance is available for the Firebase App '"+e.m+"'!")}}function Vc(e){e.B||e.w.b||(e.w.start(),Jt(e,"tokenChanged",e.W),$t(e,"tokenChanged",e.W))}function Wc(e){Jt(e,"tokenChanged",e.W),e.w.stop()}function Uc(e,t){e.ma=t,Wr(e,"_lat",t)}function Hc(e){for(var t=[],n=0;n<e.O.length;n++)t.push(e.O[n](e));return nt(t).then((function(){return e}))}function zc(e){e.i&&!e.J&&(e.J=!0,sc(e.i,e))}function qc(e,t){Ur(e,{uid:t.uid,displayName:t.displayName||null,photoURL:t.photoURL||null,email:t.email||null,emailVerified:t.emailVerified||!1,phoneNumber:t.phoneNumber||null,isAnonymous:t.isAnonymous||!1,tenantId:t.tenantId||null,metadata:new Dc(t.createdAt,t.lastLoginAt),providerData:[]}),e.a.b=e.tenantId}function Kc(){}function Gc(e){return Ze().then((function(){if(e.B)throw new ei("app-deleted")}))}function Qc(e){return W(e.providerData,(function(e){return e.providerId}))}function $c(e,t){t&&(Yc(e,t.providerId),e.providerData.push(t))}function Yc(e,t){q(e.providerData,(function(e){return e.providerId==t}))}function Xc(e,t,n){("uid"!=t||n)&&e.hasOwnProperty(t)&&Wr(e,t,n)}function Jc(e,t){e!=t&&(Ur(e,{uid:t.uid,displayName:t.displayName,photoURL:t.photoURL,email:t.email,emailVerified:t.emailVerified,phoneNumber:t.phoneNumber,isAnonymous:t.isAnonymous,tenantId:t.tenantId,providerData:[]}),t.metadata?Wr(e,"metadata",function(e){return new Dc(e.a,e.b)}(t.metadata)):Wr(e,"metadata",new Dc),V(t.providerData,(function(t){$c(e,t)})),function(e,t){e.b=t.b,e.a=t.a,e.c=t.c}(e.b,t.b),Wr(e,"refreshToken",e.b.a))}function Zc(e){return e.G().then((function(t){var n=e.isAnonymous;return function(e,t){return Ls(e.a,ds,{idToken:t}).then(S(e.zc,e))}(e,t).then((function(){return n||Xc(e,"isAnonymous",!1),t}))}))}function el(e,t){t[Pa]&&e.ma!=t[Pa]&&(Ac(e.b,t),e.dispatchEvent(new Mc("tokenChanged")),Uc(e,t[Pa]),Xc(e,"refreshToken",e.b.a))}function tl(e,t){return Zc(e).then((function(){if(H(Qc(e),t))return Hc(e).then((function(){throw new ei("provider-already-linked")}))}))}function nl(e,t,n){return Hr({user:e,credential:To(t),additionalUserInfo:t=Fi(t),operationType:n})}function rl(e,t){return el(e,t),e.reload().then((function(){return e}))}function il(e,t,n,i,o){if(!Tr())return et(new ei("operation-not-supported-in-this-environment"));if(e.h&&!o)return et(e.h);var a=Pi(n.providerId),s=Nr(e.uid+":::"),u=null;(!xr()||hr())&&e.o&&n.isOAuthProvider&&(u=Ks(e.o,e.l,e.m,t,n,null,s,r.a.SDK_VERSION||null,null,null,e.tenantId));var c=ar(u,a&&a.sa,a&&a.ra);return i=i().then((function(){if(al(e),!o)return e.G().then((function(){}))})).then((function(){return hc(e.i,c,t,n,s,!!u,e.tenantId)})).then((function(){return new Ke((function(n,r){e.ja(t,null,new ei("cancelled-popup-request"),e.g||null),e.f=n,e.v=r,e.g=s,e.c=fc(e.i,e,t,c,s)}))})).then((function(e){return c&&or(c),e?Hr(e):null})).s((function(e){throw c&&or(c),e})),sl(e,i,o)}function ol(e,t,n,r,i){if(!Tr())return et(new ei("operation-not-supported-in-this-environment"));if(e.h&&!i)return et(e.h);var o=null,a=Nr(e.uid+":::");return r=r().then((function(){if(al(e),!i)return e.G().then((function(){}))})).then((function(){return e.ca=a,Hc(e)})).then((function(t){return e.da&&(t=(t=e.da).b.set(ll,e.A(),t.a)),t})).then((function(){return pc(e.i,t,n,a,e.tenantId)})).s((function(t){if(o=t,e.da)return hl(e.da);throw o})).then((function(){if(o)throw o})),sl(e,r,i)}function al(e){if(!e.i||!e.J){if(e.i&&!e.J)throw new ei("internal-error");throw new ei("auth-domain-config-required")}}function sl(e,t,n){var r=function(e,t,n){return e.h&&!n?(t.cancel(),et(e.h)):t.s((function(t){throw!t||"auth/user-disabled"!=t.code&&"auth/user-token-expired"!=t.code||(e.h||e.dispatchEvent(new Mc("userInvalidated")),e.h=t),t}))}(e,t,n);return e.I.push(r),r.ka((function(){z(e.I,r)})),r}function ul(e){if(!e.apiKey)return null;var t={apiKey:e.apiKey,authDomain:e.authDomain,appName:e.appName},n={};if(!(e.stsTokenManager&&e.stsTokenManager.accessToken&&e.stsTokenManager.expirationTime))return null;n[Pa]=e.stsTokenManager.accessToken,n.refreshToken=e.stsTokenManager.refreshToken||null,n.expiresIn=(e.stsTokenManager.expirationTime-x())/1e3;var r=new Rc(t,n,e);return e.providerData&&V(e.providerData,(function(e){e&&$c(r,Hr(e))})),e.redirectEventId&&(r.ca=e.redirectEventId),r}function cl(e){this.a=e,this.b=ku()}vc.prototype.reset=function(){this.b=null,this.a&&(this.a.cancel(),this.a=null)},vc.prototype.h=function(e,t){if(e){this.reset(),this.g=!0;var n=e.c,r=e.b,i=e.a&&"auth/web-storage-unsupported"==e.a.code,o=e.a&&"auth/operation-not-supported-in-this-environment"==e.a.code;this.i=!(!i&&!o),"unknown"!=n||i||o?e.a?(_c(this,!0,null,e.a),Ze()):t.Ba(n,r)?function(e,t,n){n=n.Ba(t.c,t.b);var r=t.g,i=t.f,o=t.i,a=t.R(),s=!!t.c.match(/Redirect$/);n(r,i,a,o).then((function(t){_c(e,s,t,null)})).s((function(t){_c(e,s,null,t)}))}(this,e,t):et(new ei("invalid-auth-event")):(_c(this,!1,null,null),Ze())}else et(new ei("invalid-auth-event"))},vc.prototype.oa=function(){var e=this;return new Ke((function(t,n){e.b?e.b().then(t,n):(e.f.push(t),e.c.push(n),function(e){var t=new ei("timeout");e.a&&e.a.cancel(),e.a=pn(lc.get()).then((function(){e.b||(e.g=!0,_c(e,!0,null,t))}))}(e))}))},Cc.prototype.h=function(e,t){if(e){var n=e.c,r=e.b;e.a?(t.ja(e.c,null,e.a,e.b),Ze()):t.Ba(n,r)?function(e,t){var n=e.b,r=e.c;t.Ba(r,n)(e.g,e.f,e.R(),e.i).then((function(e){t.ja(r,e,null,n)})).s((function(e){t.ja(r,null,e,n)}))}(e,t):et(new ei("invalid-auth-event"))}else et(new ei("invalid-auth-event"))},Sc.prototype.confirm=function(e){return e=Co(this.verificationId,e),this.a(e)},Ic.prototype.start=function(){this.a=this.c,function e(t,n){t.stop(),t.b=pn(function(e,t){return t?(e.a=e.c,e.g()):(t=e.a,e.a*=2,e.a>e.f&&(e.a=e.f),t)}(t,n)).then((function(){return function(){var e=u.document,t=null;return Mr()||!e?Ze():new Ke((function(n){t=function(){Mr()&&(e.removeEventListener("visibilitychange",t,!1),n())},e.addEventListener("visibilitychange",t,!1)})).s((function(n){throw e.removeEventListener("visibilitychange",t,!1),n}))}()})).then((function(){return t.h()})).then((function(){e(t,!0)})).s((function(n){t.i(n)&&e(t,!1)}))}(this,!0)},Ic.prototype.stop=function(){this.b&&(this.b.cancel(),this.b=null)},kc.prototype.A=function(){return{apiKey:this.f.c,refreshToken:this.a,accessToken:this.b,expirationTime:this.c}},kc.prototype.getToken=function(e){return e=!!e,this.b&&!this.a?et(new ei("user-token-expired")):e||!this.b||x()>this.c-3e4?this.a?Lc(this,{grant_type:"refresh_token",refresh_token:this.a}):Ze(null):Ze({accessToken:this.b,expirationTime:this.c,refreshToken:this.a})},Dc.prototype.A=function(){return{lastLoginAt:this.b,createdAt:this.a}},I(Mc,Ft),I(Rc,un),Rc.prototype.ua=function(e){this.ga=e,Wa(this.a,e)},Rc.prototype.ha=function(){return this.ga},Rc.prototype.Ca=function(){return G(this.P)},Rc.prototype.Ja=function(){this.w.b&&(this.w.stop(),this.w.start())},Wr(Rc.prototype,"providerId","firebase"),(t=Rc.prototype).reload=function(){var e=this;return sl(this,Gc(this).then((function(){return Zc(e).then((function(){return Hc(e)})).then(Kc)})))},t.dc=function(e){return this.G(e).then((function(e){return new xc(e)}))},t.G=function(e){var t=this;return sl(this,Gc(this).then((function(){return t.b.getToken(e)})).then((function(e){if(!e)throw new ei("internal-error");return e.accessToken!=t.ma&&(Uc(t,e.accessToken),t.dispatchEvent(new Mc("tokenChanged"))),Xc(t,"refreshToken",e.refreshToken),e.accessToken})))},t.zc=function(e){if(!(e=e.users)||!e.length)throw new ei("internal-error");qc(this,{uid:(e=e[0]).localId,displayName:e.displayName,photoURL:e.photoUrl,email:e.email,emailVerified:!!e.emailVerified,phoneNumber:e.phoneNumber,lastLoginAt:e.lastLoginAt,createdAt:e.createdAt,tenantId:e.tenantId});for(var t=function(e){return(e=e.providerUserInfo)&&e.length?W(e,(function(e){return new Oc(e.rawId,e.providerId,e.email,e.displayName,e.photoUrl,e.phoneNumber)})):[]}(e),n=0;n<t.length;n++)$c(this,t[n]);Xc(this,"isAnonymous",!(this.email&&e.passwordHash||this.providerData&&this.providerData.length))},t.Ac=function(e){return Br("firebase.User.prototype.reauthenticateAndRetrieveDataWithCredential is deprecated. Please use firebase.User.prototype.reauthenticateWithCredential instead."),this.hb(e)},t.hb=function(e){var t=this,n=null;return sl(this,e.f(this.a,this.uid).then((function(e){return el(t,e),n=nl(t,e,"reauthenticate"),t.h=null,t.reload()})).then((function(){return n})),!0)},t.rc=function(e){return Br("firebase.User.prototype.linkAndRetrieveDataWithCredential is deprecated. Please use firebase.User.prototype.linkWithCredential instead."),this.fb(e)},t.fb=function(e){var t=this,n=null;return sl(this,tl(this,e.providerId).then((function(){return t.G()})).then((function(n){return e.b(t.a,n)})).then((function(e){return n=nl(t,e,"link"),rl(t,e)})).then((function(){return n})))},t.sc=function(e,t){var n=this;return sl(this,tl(this,"phone").then((function(){return Ec(Bc(n),e,t,S(n.fb,n))})))},t.Bc=function(e,t){var n=this;return sl(this,Ze().then((function(){return Ec(Bc(n),e,t,S(n.hb,n))})),!0)},t.rb=function(e){var t=this;return sl(this,this.G().then((function(n){return t.a.rb(n,e)})).then((function(e){return el(t,e),t.reload()})))},t.Sc=function(e){var t=this;return sl(this,this.G().then((function(n){return e.b(t.a,n)})).then((function(e){return el(t,e),t.reload()})))},t.sb=function(e){var t=this;return sl(this,this.G().then((function(n){return t.a.sb(n,e)})).then((function(e){return el(t,e),t.reload()})))},t.tb=function(e){if(void 0===e.displayName&&void 0===e.photoURL)return Gc(this);var t=this;return sl(this,this.G().then((function(n){return t.a.tb(n,{displayName:e.displayName,photoUrl:e.photoURL})})).then((function(e){return el(t,e),Xc(t,"displayName",e.displayName||null),Xc(t,"photoURL",e.photoUrl||null),V(t.providerData,(function(e){"password"===e.providerId&&(Wr(e,"displayName",t.displayName),Wr(e,"photoURL",t.photoURL))})),Hc(t)})).then(Kc))},t.Qc=function(e){var t=this;return sl(this,Zc(this).then((function(n){return H(Qc(t),e)?function(e,t,n){return Ls(e,cs,{idToken:t,deleteProvider:n})}(t.a,n,[e]).then((function(e){var n={};return V(e.providerUserInfo||[],(function(e){n[e.providerId]=!0})),V(Qc(t),(function(e){n[e]||Yc(t,e)})),n[_o.PROVIDER_ID]||Wr(t,"phoneNumber",null),Hc(t)})):Hc(t).then((function(){throw new ei("no-such-provider")}))})))},t.delete=function(){var e=this;return sl(this,this.G().then((function(t){return Ls(e.a,us,{idToken:t})})).then((function(){e.dispatchEvent(new Mc("userDeleted"))}))).then((function(){for(var t=0;t<e.I.length;t++)e.I[t].cancel("app-deleted");Pc(e,null),jc(e,null),e.I=[],e.B=!0,Wc(e),Wr(e,"refreshToken",null),e.i&&uc(e.i,e)}))},t.xb=function(e,t){return!!("linkViaPopup"==e&&(this.g||null)==t&&this.f||"reauthViaPopup"==e&&(this.g||null)==t&&this.f||"linkViaRedirect"==e&&(this.ca||null)==t||"reauthViaRedirect"==e&&(this.ca||null)==t)},t.ja=function(e,t,n,r){"linkViaPopup"!=e&&"reauthViaPopup"!=e||r!=(this.g||null)||(n&&this.v?this.v(n):t&&!n&&this.f&&this.f(t),this.c&&(this.c.cancel(),this.c=null),delete this.f,delete this.v)},t.Ba=function(e,t){return"linkViaPopup"==e&&t==(this.g||null)?S(this.Bb,this):"reauthViaPopup"==e&&t==(this.g||null)?S(this.Cb,this):"linkViaRedirect"==e&&(this.ca||null)==t?S(this.Bb,this):"reauthViaRedirect"==e&&(this.ca||null)==t?S(this.Cb,this):null},t.tc=function(e){var t=this;return il(this,"linkViaPopup",e,(function(){return tl(t,e.providerId).then((function(){return Hc(t)}))}),!1)},t.Cc=function(e){return il(this,"reauthViaPopup",e,(function(){return Ze()}),!0)},t.uc=function(e){var t=this;return ol(this,"linkViaRedirect",e,(function(){return tl(t,e.providerId)}),!1)},t.Dc=function(e){return ol(this,"reauthViaRedirect",e,(function(){return Ze()}),!0)},t.Bb=function(e,t,n,r){var i=this;this.c&&(this.c.cancel(),this.c=null);var o=null;return sl(this,this.G().then((function(n){return ts(i.a,{requestUri:e,postBody:r,sessionId:t,idToken:n})})).then((function(e){return o=nl(i,e,"link"),rl(i,e)})).then((function(){return o})))},t.Cb=function(e,t,n,r){var i=this;this.c&&(this.c.cancel(),this.c=null);var o=null;return sl(this,Ze().then((function(){return Qi(ns(i.a,{requestUri:e,sessionId:t,postBody:r,tenantId:n}),i.uid)})).then((function(e){return o=nl(i,e,"reauthenticate"),el(i,e),i.h=null,i.reload()})).then((function(){return o})),!0)},t.jb=function(e){var t=this,n=null;return sl(this,this.G().then((function(t){return n=t,void 0===e||$(e)?{}:Ti(new pi(e))})).then((function(e){return t.a.jb(n,e)})).then((function(e){if(t.email!=e)return t.reload()})).then((function(){})))},t.toJSON=function(){return this.A()},t.A=function(){var e={uid:this.uid,displayName:this.displayName,photoURL:this.photoURL,email:this.email,emailVerified:this.emailVerified,phoneNumber:this.phoneNumber,isAnonymous:this.isAnonymous,tenantId:this.tenantId,providerData:[],apiKey:this.l,appName:this.m,authDomain:this.o,stsTokenManager:this.b.A(),redirectEventId:this.ca||null};return this.metadata&&J(e,this.metadata.A()),V(this.providerData,(function(t){e.providerData.push(function(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}(t))})),e};var ll={name:"redirectUser",C:"session"};function hl(e){return Lu(e.b,ll,e.a)}function dl(e){this.a=e,this.b=ku(),this.c=null,this.f=function(e){var t=ml("local"),n=ml("session"),r=ml("none");return function(e,t,n){var r=Nu(t,n),i=Au(e,t.C);return e.get(t,n).then((function(o){var a=null;try{a=Ar(u.localStorage.getItem(r))}catch(s){}if(a&&!o)return u.localStorage.removeItem(r),e.set(t,a,n);a&&o&&"localStorage"!=i.type&&u.localStorage.removeItem(r)}))}(e.b,t,e.a).then((function(){return e.b.get(n,e.a)})).then((function(i){return i?n:e.b.get(r,e.a).then((function(n){return n?r:e.b.get(t,e.a).then((function(n){return n?t:e.b.get(fl,e.a).then((function(e){return e?ml(e):t}))}))}))})).then((function(t){return e.c=t,pl(e,t.C)})).s((function(){e.c||(e.c=t)}))}(this),this.b.addListener(ml("local"),this.a,S(this.g,this))}function pl(e,t){var n,r=[];for(n in xu)xu[n]!==t&&r.push(Lu(e.b,ml(xu[n]),e.a));return r.push(Lu(e.b,fl,e.a)),function(e){return new Ke((function(t,n){var r=e.length,i=[];if(r)for(var o=function(e,n){r--,i[e]=n,0==r&&t(i)},a=function(e){n(e)},s=0;s<e.length;s++)tt(e[s],E(o,s),a);else t(i)}))}(r)}dl.prototype.g=function(){var e=this,t=ml("local");bl(this,(function(){return Ze().then((function(){return e.c&&"local"!=e.c.C?e.b.get(t,e.a):null})).then((function(n){if(n)return pl(e,"local").then((function(){e.c=t}))}))}))};var fl={name:"persistence",C:"session"};function ml(e){return{name:"authUser",C:e}}function gl(e,t){return bl(e,(function(){return e.b.set(e.c,t.A(),e.a)}))}function vl(e){return bl(e,(function(){return Lu(e.b,e.c,e.a)}))}function yl(e,t){return bl(e,(function(){return e.b.get(e.c,e.a).then((function(e){return e&&t&&(e.authDomain=t),ul(e||{})}))}))}function bl(e,t){return e.f=e.f.then(t,t),e.f}function wl(e){if(this.l=!1,Wr(this,"settings",new Tc),Wr(this,"app",e),!kl(this).options||!kl(this).options.apiKey)throw new ei("invalid-api-key");e=r.a.SDK_VERSION?br(r.a.SDK_VERSION):null,this.b=new Ma(kl(this).options&&kl(this).options.apiKey,Di(Ni),e),this.O=[],this.m=[],this.J=[],this.Ub=r.a.INTERNAL.createSubscribe(S(this.oc,this)),this.W=void 0,this.Vb=r.a.INTERNAL.createSubscribe(S(this.pc,this)),xl(this,null),this.h=new dl(kl(this).options.apiKey+":"+kl(this).name),this.w=new cl(kl(this).options.apiKey+":"+kl(this).name),this.Y=Dl(this,function(e){var t=kl(e).options.authDomain,n=function(e){var t=function(e,t){return e.b.get(ll,e.a).then((function(e){return e&&t&&(e.authDomain=t),ul(e||{})}))}(e.w,kl(e).options.authDomain).then((function(t){return(e.B=t)&&(t.da=e.w),hl(e.w)}));return Dl(e,t)}(e).then((function(){return yl(e.h,t)})).then((function(t){return t?(t.da=e.w,e.B&&(e.B.ca||null)==(t.ca||null)?t:t.reload().then((function(){return gl(e.h,t).then((function(){return t}))})).s((function(n){return"auth/network-request-failed"==n.code?t:vl(e.h)}))):null})).then((function(t){xl(e,t||null)}));return Dl(e,n)}(this)),this.i=Dl(this,function(e){return e.Y.then((function(){return Sl(e)})).s((function(){})).then((function(){if(!e.l)return e.ma()})).s((function(){})).then((function(){if(!e.l){e.ga=!0;var t=e.h;t.b.addListener(ml("local"),t.a,e.ma)}}))}(this)),this.ga=!1,this.ma=S(this.Nc,this),this.ub=S(this.aa,this),this.wa=S(this.bc,this),this.xa=S(this.mc,this),this.Ja=S(this.nc,this),this.a=null,function(e){var t=kl(e).options.authDomain,n=kl(e).options.apiKey;t&&Tr()&&(e.Tb=e.Y.then((function(){if(!e.l){if(e.a=gc(t,n,kl(e).name),sc(e.a,e),Al(e)&&zc(Al(e)),e.B){zc(e.B);var r=e.B;r.ua(e.ha()),Pc(r,e),Fc(r=e.B,e.I),jc(r,e),e.B=null}return e.a}})))}(this),this.INTERNAL={},this.INTERNAL.delete=S(this.delete,this),this.INTERNAL.logFramework=S(this.vc,this),this.o=0,un.call(this),function(e){Object.defineProperty(e,"lc",{get:function(){return this.ha()},set:function(e){this.ua(e)},enumerable:!1}),e.Z=null,Object.defineProperty(e,"ti",{get:function(){return this.R()},set:function(e){this.nb(e)},enumerable:!1}),e.P=null}(this),this.I=[]}function _l(e){Ft.call(this,"languageCodeChanged"),this.g=e}function Cl(e){Ft.call(this,"frameworkChanged"),this.c=e}function Tl(e){return e.Tb||et(new ei("auth-domain-config-required"))}function Sl(e){if(!Tr())return et(new ei("operation-not-supported-in-this-environment"));var t=Tl(e).then((function(){return e.a.oa()})).then((function(e){return e?Hr(e):null}));return Dl(e,t)}function El(e,t){var n={};return n.apiKey=kl(e).options.apiKey,n.authDomain=kl(e).options.authDomain,n.appName=kl(e).name,e.Y.then((function(){return function(e,t,n,r){var i=new Rc(e,t);return n&&(i.da=n),r&&Fc(i,r),i.reload().then((function(){return i}))}(n,t,e.w,e.Ca())})).then((function(t){return Al(e)&&t.uid==Al(e).uid?(Jc(Al(e),t),e.aa(t)):(xl(e,t),zc(t),e.aa(t))})).then((function(){Ll(e)}))}function xl(e,t){Al(e)&&(function(e,t){q(e.O,(function(e){return e==t}))}(Al(e),e.ub),Jt(Al(e),"tokenChanged",e.wa),Jt(Al(e),"userDeleted",e.xa),Jt(Al(e),"userInvalidated",e.Ja),Wc(Al(e))),t&&(t.O.push(e.ub),$t(t,"tokenChanged",e.wa),$t(t,"userDeleted",e.xa),$t(t,"userInvalidated",e.Ja),0<e.o&&Vc(t)),Wr(e,"currentUser",t),t&&(t.ua(e.ha()),Pc(t,e),Fc(t,e.I),jc(t,e))}function Il(e,t){var n=null,r=null;return Dl(e,t.then((function(t){return n=To(t),r=Fi(t),El(e,t)})).then((function(){return Hr({user:Al(e),credential:n,additionalUserInfo:r,operationType:"signIn"})})))}function kl(e){return e.app}function Al(e){return e.currentUser}function Nl(e){return Al(e)&&Al(e)._lat||null}function Ll(e){if(e.ga){for(var t=0;t<e.m.length;t++)e.m[t]&&e.m[t](Nl(e));if(e.W!==e.getUid()&&e.J.length)for(e.W=e.getUid(),t=0;t<e.J.length;t++)e.J[t]&&e.J[t](Nl(e))}}function Dl(e,t){return e.O.push(t),t.ka((function(){z(e.O,t)})),t}function Ol(){}function Ml(){this.a={},this.b=1e12}dl.prototype.mb=function(e){var t=null,n=this;return function(e){var t=new ei("invalid-persistence-type"),n=new ei("unsupported-persistence-type");e:{for(r in xu)if(xu[r]==e){var r=!0;break e}r=!1}if(!r||"string"!=typeof e)throw t;switch(pr()){case"ReactNative":if("session"===e)throw n;break;case"Node":if("none"!==e)throw n;break;default:if(!Cr()&&"none"!==e)throw n}}(e),bl(this,(function(){return e!=n.c.C?n.b.get(n.c,n.a).then((function(r){return t=r,pl(n,e)})).then((function(){if(n.c=ml(e),t)return n.b.set(n.c,t,n.a)})):Ze()}))},I(wl,un),I(_l,Ft),I(Cl,Ft),(t=wl.prototype).mb=function(e){return Dl(this,e=this.h.mb(e))},t.ua=function(e){this.Z===e||this.l||(this.Z=e,Wa(this.b,this.Z),this.dispatchEvent(new _l(this.ha())))},t.ha=function(){return this.Z},t.Tc=function(){var e=u.navigator;this.ua(e&&(e.languages&&e.languages[0]||e.language||e.userLanguage)||null)},t.vc=function(e){this.I.push(e),Ua(this.b,r.a.SDK_VERSION?br(r.a.SDK_VERSION,this.I):null),this.dispatchEvent(new Cl(this.I))},t.Ca=function(){return G(this.I)},t.nb=function(e){this.P===e||this.l||(this.P=e,this.b.b=this.P)},t.R=function(){return this.P},t.toJSON=function(){return{apiKey:kl(this).options.apiKey,authDomain:kl(this).options.authDomain,appName:kl(this).name,currentUser:Al(this)&&Al(this).A()}},t.xb=function(e,t){switch(e){case"unknown":case"signInViaRedirect":return!0;case"signInViaPopup":return this.g==t&&!!this.f;default:return!1}},t.ja=function(e,t,n,r){"signInViaPopup"==e&&this.g==r&&(n&&this.v?this.v(n):t&&!n&&this.f&&this.f(t),this.c&&(this.c.cancel(),this.c=null),delete this.f,delete this.v)},t.Ba=function(e,t){return"signInViaRedirect"==e||"signInViaPopup"==e&&this.g==t&&this.f?S(this.ac,this):null},t.ac=function(e,t,n,r){var i=this;e={requestUri:e,postBody:r,sessionId:t,tenantId:n},this.c&&(this.c.cancel(),this.c=null);var o=null,a=null,s=es(i.b,e).then((function(e){return o=To(e),a=Fi(e),e}));return Dl(this,e=i.Y.then((function(){return s})).then((function(e){return El(i,e)})).then((function(){return Hr({user:Al(i),credential:o,additionalUserInfo:a,operationType:"signIn"})})))},t.Lc=function(e){if(!Tr())return et(new ei("operation-not-supported-in-this-environment"));var t=this,n=Pi(e.providerId),i=Nr(),o=null;(!xr()||hr())&&kl(this).options.authDomain&&e.isOAuthProvider&&(o=Ks(kl(this).options.authDomain,kl(this).options.apiKey,kl(this).name,"signInViaPopup",e,null,i,r.a.SDK_VERSION||null,null,null,this.R()));var a=ar(o,n&&n.sa,n&&n.ra);return Dl(this,n=Tl(this).then((function(n){return hc(n,a,"signInViaPopup",e,i,!!o,t.R())})).then((function(){return new Ke((function(e,n){t.ja("signInViaPopup",null,new ei("cancelled-popup-request"),t.g),t.f=e,t.v=n,t.g=i,t.c=fc(t.a,t,"signInViaPopup",a,i)}))})).then((function(e){return a&&or(a),e?Hr(e):null})).s((function(e){throw a&&or(a),e})))},t.Mc=function(e){if(!Tr())return et(new ei("operation-not-supported-in-this-environment"));var t=this;return Dl(this,Tl(this).then((function(){return function(e){return bl(e,(function(){return e.b.set(fl,e.c.C,e.a)}))}(t.h)})).then((function(){return pc(t.a,"signInViaRedirect",e,void 0,t.R())})))},t.oa=function(){var e=this;return Sl(this).then((function(t){return e.a&&bc(e.a.b),t})).s((function(t){throw e.a&&bc(e.a.b),t}))},t.Rc=function(e){if(!e)return et(new ei("null-user"));if(this.P!=e.tenantId)return et(new ei("tenant-id-mismatch"));var t=this,n={};n.apiKey=kl(this).options.apiKey,n.authDomain=kl(this).options.authDomain,n.appName=kl(this).name;var r=function(e,t,n,r){t=t||{apiKey:e.l,authDomain:e.o,appName:e.m};var i=e.b,o={};return o[Pa]=i.b,o.refreshToken=i.a,o.expiresIn=(i.c-x())/1e3,t=new Rc(t,o),n&&(t.da=n),r&&Fc(t,r),Jc(t,e),t}(e,n,t.w,t.Ca());return Dl(this,this.i.then((function(){if(kl(t).options.apiKey!=e.l)return r.reload()})).then((function(){return Al(t)&&e.uid==Al(t).uid?(Jc(Al(t),e),t.aa(e)):(xl(t,r),zc(r),t.aa(r))})).then((function(){Ll(t)})))},t.pb=function(){var e=this;return Dl(this,this.i.then((function(){return e.a&&bc(e.a.b),Al(e)?(xl(e,null),vl(e.h).then((function(){Ll(e)}))):Ze()})))},t.Nc=function(){var e=this;return yl(this.h,kl(this).options.authDomain).then((function(t){if(!e.l){var n;if(n=Al(e)&&t){n=Al(e).uid;var r=t.uid;n=null!=n&&""!==n&&null!=r&&""!==r&&n==r}if(n)return Jc(Al(e),t),Al(e).G();(Al(e)||t)&&(xl(e,t),t&&(zc(t),t.da=e.w),e.a&&sc(e.a,e),Ll(e))}}))},t.aa=function(e){return gl(this.h,e)},t.bc=function(){Ll(this),this.aa(Al(this))},t.mc=function(){this.pb()},t.nc=function(){this.pb()},t.oc=function(e){var t=this;this.addAuthTokenListener((function(){e.next(Al(t))}))},t.pc=function(e){var t=this;!function(e,t){e.J.push(t),Dl(e,e.i.then((function(){!e.l&&H(e.J,t)&&e.W!==e.getUid()&&(e.W=e.getUid(),t(Nl(e)))})))}(this,(function(){e.next(Al(t))}))},t.xc=function(e,t,n){var r=this;return this.ga&&Promise.resolve().then((function(){y(e)?e(Al(r)):y(e.next)&&e.next(Al(r))})),this.Ub(e,t,n)},t.wc=function(e,t,n){var r=this;return this.ga&&Promise.resolve().then((function(){r.W=r.getUid(),y(e)?e(Al(r)):y(e.next)&&e.next(Al(r))})),this.Vb(e,t,n)},t.cc=function(e){var t=this;return Dl(this,this.i.then((function(){return Al(t)?Al(t).G(e).then((function(e){return{accessToken:e}})):null})))},t.Hc=function(e){var t=this;return this.i.then((function(){return Il(t,Ls(t.b,xs,{token:e}))})).then((function(e){var n=e.user;return Xc(n,"isAnonymous",!1),t.aa(n),e}))},t.Ic=function(e,t){var n=this;return this.i.then((function(){return Il(n,Ls(n.b,Is,{email:e,password:t}))}))},t.Xb=function(e,t){var n=this;return this.i.then((function(){return Il(n,Ls(n.b,as,{email:e,password:t}))}))},t.Sa=function(e){var t=this;return this.i.then((function(){return Il(t,e.na(t.b))}))},t.Gc=function(e){return Br("firebase.auth.Auth.prototype.signInAndRetrieveDataWithCredential is deprecated. Please use firebase.auth.Auth.prototype.signInWithCredential instead."),this.Sa(e)},t.ob=function(){var e=this;return this.i.then((function(){var t=Al(e);if(t&&t.isAnonymous){var n=Hr({providerId:null,isNewUser:!1});return Hr({user:t,credential:null,additionalUserInfo:n,operationType:"signIn"})}return Il(e,e.b.ob()).then((function(t){var n=t.user;return Xc(n,"isAnonymous",!0),e.aa(n),t}))}))},t.getUid=function(){return Al(this)&&Al(this).uid||null},t.Wb=function(e){this.addAuthTokenListener(e),this.o++,0<this.o&&Al(this)&&Vc(Al(this))},t.Ec=function(e){var t=this;V(this.m,(function(n){n==e&&t.o--})),0>this.o&&(this.o=0),0==this.o&&Al(this)&&Wc(Al(this)),this.removeAuthTokenListener(e)},t.addAuthTokenListener=function(e){var t=this;this.m.push(e),Dl(this,this.i.then((function(){t.l||H(t.m,e)&&e(Nl(t))})))},t.removeAuthTokenListener=function(e){q(this.m,(function(t){return t==e}))},t.delete=function(){this.l=!0;for(var e=0;e<this.O.length;e++)this.O[e].cancel("app-deleted");return this.O=[],this.h&&(e=this.h).b.removeListener(ml("local"),e.a,this.ma),this.a&&(uc(this.a,this),bc(this.a.b)),Promise.resolve()},t.$b=function(e){return Dl(this,function(e,t){return Ls(e,ss,{identifier:t,continueUri:Sr()?nr():"http://localhost"}).then((function(e){return e.signinMethods||[]}))}(this.b,e))},t.qc=function(e){return!!vo(e)},t.lb=function(e,t){var n=this;return Dl(this,Ze().then((function(){var e=new pi(t);if(!e.c)throw new ei("argument-error",gi+" must be true when sending sign in link to email");return Ti(e)})).then((function(t){return n.b.lb(e,t)})).then((function(){})))},t.Uc=function(e){return this.Ma(e).then((function(e){return e.data.email}))},t.ab=function(e,t){return Dl(this,this.b.ab(e,t).then((function(){})))},t.Ma=function(e){return Dl(this,this.b.Ma(e).then((function(e){return new qr(e)})))},t.Ya=function(e){return Dl(this,this.b.Ya(e).then((function(){})))},t.kb=function(e,t){var n=this;return Dl(this,Ze().then((function(){return void 0===t||$(t)?{}:Ti(new pi(t))})).then((function(t){return n.b.kb(e,t)})).then((function(){})))},t.Kc=function(e,t){return Dl(this,Ec(this,e,t,S(this.Sa,this)))},t.Jc=function(e,t){var n=this;return Dl(this,Ze().then((function(){var r=t||nr(),i=go(e,r);if(!(r=vo(r)))throw new ei("argument-error","Invalid email link!");if(r.tenantId!==n.R())throw new ei("tenant-id-mismatch");return n.Sa(i)})))},Ol.prototype.render=function(){},Ol.prototype.reset=function(){},Ol.prototype.getResponse=function(){},Ol.prototype.execute=function(){};var Rl=null;function Pl(e,t){return(t=Fl(t))&&e.a[t]||null}function Fl(e){return(e=void 0===e?1e12:e)?e.toString():null}function jl(e,t){this.g=!1,this.c=t,this.a=this.b=null,this.h="invisible"!==this.c.size,this.f=qn(e);var n=this;this.i=function(){n.execute()},this.h?this.execute():$t(this.f,"click",this.i)}function Bl(e){if(e.g)throw Error("reCAPTCHA mock was already deleted!")}function Vl(){}Ml.prototype.render=function(e,t){return this.a[this.b.toString()]=new jl(e,t),this.b++},Ml.prototype.reset=function(e){var t=Pl(this,e);e=Fl(e),t&&e&&(t.delete(),delete this.a[e])},Ml.prototype.getResponse=function(e){return(e=Pl(this,e))?e.getResponse():null},Ml.prototype.execute=function(e){(e=Pl(this,e))&&e.execute()},jl.prototype.getResponse=function(){return Bl(this),this.b},jl.prototype.execute=function(){Bl(this);var e=this;this.a||(this.a=setTimeout((function(){e.b=function(){for(var e=50,t=[];0<e;)t.push("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(62*Math.random()))),e--;return t.join("")}();var t=e.c.callback,n=e.c["expired-callback"];if(t)try{t(e.b)}catch(r){}e.a=setTimeout((function(){if(e.a=null,e.b=null,n)try{n()}catch(r){}e.h&&e.execute()}),6e4)}),500))},jl.prototype.delete=function(){Bl(this),this.g=!0,clearTimeout(this.a),this.a=null,Jt(this.f,"click",this.i)},Vl.prototype.g=function(){return Rl||(Rl=new Ml),Ze(Rl)},Vl.prototype.c=function(){};var Wl=null;function Ul(){this.b=u.grecaptcha?1/0:0,this.f=null,this.a="__rcb"+Math.floor(1e6*Math.random()).toString()}var Hl=new Z(ne,"https://www.google.com/recaptcha/api.js?onload=%{onload}&render=explicit&hl=%{hl}"),zl=new Or(3e4,6e4);Ul.prototype.g=function(e){var t=this;return new Ke((function(n,r){var i=setTimeout((function(){r(new ei("network-request-failed"))}),zl.get());!u.grecaptcha||e!==t.f&&!t.b?(u[t.a]=function(){if(u.grecaptcha){t.f=e;var o=u.grecaptcha.render;u.grecaptcha.render=function(e,n){return e=o(e,n),t.b++,e},clearTimeout(i),n(u.grecaptcha)}else clearTimeout(i),r(new ei("internal-error"));delete u[t.a]},Ze(Ia(ae(Hl,{onload:t.a,hl:e||""}))).s((function(){clearTimeout(i),r(new ei("internal-error","Unable to load external reCAPTCHA dependencies!"))}))):(clearTimeout(i),n(u.grecaptcha))}))},Ul.prototype.c=function(){this.b--};var ql=null;function Kl(e,t,n,r,i,o,a){if(Wr(this,"type","recaptcha"),this.c=this.f=null,this.B=!1,this.u=t,this.g=null,a?(Wl||(Wl=new Vl),a=Wl):(ql||(ql=new Ul),a=ql),this.m=a,this.a=n||{theme:"light",type:"image"},this.h=[],this.a[$l])throw new ei("argument-error","sitekey should not be provided for reCAPTCHA as one is automatically provisioned for the current project.");if(this.i="invisible"===this.a[Yl],!u.document)throw new ei("operation-not-supported-in-this-environment","RecaptchaVerifier is only supported in a browser HTTP/HTTPS environment with DOM support.");if(!qn(t)||!this.i&&qn(t).hasChildNodes())throw new ei("argument-error","reCAPTCHA container is either not found or already contains inner elements!");this.o=new Ma(e,o||null,i||null),this.v=r||function(){return null};var s=this;this.l=[];var c=this.a[Gl];this.a[Gl]=function(e){if(Xl(s,e),"function"==typeof c)c(e);else if("string"==typeof c){var t=_r(c,u);"function"==typeof t&&t(e)}};var l=this.a[Ql];this.a[Ql]=function(){if(Xl(s,null),"function"==typeof l)l();else if("string"==typeof l){var e=_r(l,u);"function"==typeof e&&e()}}}var Gl="callback",Ql="expired-callback",$l="sitekey",Yl="size";function Xl(e,t){for(var n=0;n<e.l.length;n++)try{e.l[n](t)}catch(r){}}function Jl(e,t){return e.h.push(t),t.ka((function(){z(e.h,t)})),t}function Zl(e){if(e.B)throw new ei("internal-error","RecaptchaVerifier instance has been destroyed.")}function eh(e,t,n){var i=!1;try{this.b=n||r.a.app()}catch(s){throw new ei("argument-error","No firebase.app.App instance is currently initialized.")}if(!this.b.options||!this.b.options.apiKey)throw new ei("invalid-api-key");n=this.b.options.apiKey;var o=this,a=null;try{a=this.b.auth().Ca()}catch(s){}try{i=this.b.auth().settings.appVerificationDisabledForTesting}catch(s){}a=r.a.SDK_VERSION?br(r.a.SDK_VERSION,a):null,Kl.call(this,n,e,t,(function(){try{var e=o.b.auth().ha()}catch(t){e=null}return e}),a,Di(Ni),i)}function th(e,t,n,r){e:{n=Array.prototype.slice.call(n);for(var i=0,o=!1,a=0;a<t.length;a++)if(t[a].optional)o=!0;else{if(o)throw new ei("internal-error","Argument validator encountered a required argument after an optional argument.");i++}if(o=t.length,n.length<i||o<n.length)r="Expected "+(i==o?1==i?"1 argument":i+" arguments":i+"-"+o+" arguments")+" but got "+n.length+".";else{for(i=0;i<n.length;i++)if(o=t[i].optional&&void 0===n[i],!t[i].N(n[i])&&!o){if(t=t[i],0>i||i>=nh.length)throw new ei("internal-error","Argument validator received an unsupported number of arguments.");n=nh[i],r=(r?"":n+" argument ")+(t.name?'"'+t.name+'" ':"")+"must be "+t.M+".";break e}r=null}}if(r)throw new ei("argument-error",e+" failed: "+r)}(t=Kl.prototype).Da=function(){var e=this;return this.f?this.f:this.f=Jl(this,Ze().then((function(){if(Sr()&&!dr())return cr();throw new ei("operation-not-supported-in-this-environment","RecaptchaVerifier is only supported in a browser HTTP/HTTPS environment.")})).then((function(){return e.m.g(e.v())})).then((function(t){return e.g=t,Ls(e.o,vs,{})})).then((function(t){e.a[$l]=t.recaptchaSiteKey})).s((function(t){throw e.f=null,t})))},t.render=function(){Zl(this);var e=this;return Jl(this,this.Da().then((function(){if(null===e.c){var t=e.u;if(!e.i){var n=qn(t);t=Qn("DIV"),n.appendChild(t)}e.c=e.g.render(t,e.a)}return e.c})))},t.verify=function(){Zl(this);var e=this;return Jl(this,this.render().then((function(t){return new Ke((function(n){var r=e.g.getResponse(t);if(r)n(r);else{e.l.push((function t(r){r&&(function(e,t){q(e.l,(function(e){return e==t}))}(e,t),n(r))})),e.i&&e.g.execute(e.c)}}))})))},t.reset=function(){Zl(this),null!==this.c&&this.g.reset(this.c)},t.clear=function(){Zl(this),this.B=!0,this.m.c();for(var e=0;e<this.h.length;e++)this.h[e].cancel("RecaptchaVerifier instance has been destroyed.");if(!this.i){e=qn(this.u);for(var t;t=e.firstChild;)e.removeChild(t)}},I(eh,Kl);var nh="First Second Third Fourth Fifth Sixth Seventh Eighth Ninth".split(" ");function rh(e,t){return{name:e||"",M:"a valid string",optional:!!t,N:c}}function ih(e,t){return{name:e||"",M:"a boolean",optional:!!t,N:l}}function oh(e,t){return{name:e||"",M:"a valid object",optional:!!t,N:b}}function ah(e,t){return{name:e||"",M:"a function",optional:!!t,N:y}}function sh(e,t){return{name:e||"",M:"null",optional:!!t,N:m}}function uh(e){return{name:e?e+"Credential":"credential",M:e?"a valid "+e+" credential":"a valid credential",optional:!1,N:function(t){if(!t)return!1;var n=!e||t.providerId===e;return!(!t.na||!n)}}}function ch(){return{name:"applicationVerifier",M:"an implementation of firebase.auth.ApplicationVerifier",optional:!1,N:function(e){return!!(e&&c(e.type)&&y(e.verify))}}}function lh(e,t,n,r){return{name:n||"",M:e.M+" or "+t.M,optional:!!r,N:function(n){return e.N(n)||t.N(n)}}}function hh(e,t){for(var n in t){var r=t[n].name;e[r]=fh(r,e[n],t[n].j)}}function dh(e,t){for(var n in t){var r=t[n].name;r!==n&&Object.defineProperty(e,r,{get:E((function(e){return this[e]}),n),set:E((function(e,t,n,r){th(e,[n],[r],!0),this[t]=r}),r,n,t[n].Za),enumerable:!0})}}function ph(e,t,n,r){e[t]=fh(t,n,r)}function fh(e,t,n){function r(){var e=Array.prototype.slice.call(arguments);return th(o,n,e),t.apply(this,e)}if(!n)return t;var i,o=function(e){return(e=e.split("."))[e.length-1]}(e);for(i in t)r[i]=t[i];for(i in t.prototype)r.prototype[i]=t.prototype[i];return r}hh(wl.prototype,{Ya:{name:"applyActionCode",j:[rh("code")]},Ma:{name:"checkActionCode",j:[rh("code")]},ab:{name:"confirmPasswordReset",j:[rh("code"),rh("newPassword")]},Xb:{name:"createUserWithEmailAndPassword",j:[rh("email"),rh("password")]},$b:{name:"fetchSignInMethodsForEmail",j:[rh("email")]},oa:{name:"getRedirectResult",j:[]},qc:{name:"isSignInWithEmailLink",j:[rh("emailLink")]},wc:{name:"onAuthStateChanged",j:[lh(oh(),ah(),"nextOrObserver"),ah("opt_error",!0),ah("opt_completed",!0)]},xc:{name:"onIdTokenChanged",j:[lh(oh(),ah(),"nextOrObserver"),ah("opt_error",!0),ah("opt_completed",!0)]},kb:{name:"sendPasswordResetEmail",j:[rh("email"),lh(oh("opt_actionCodeSettings",!0),sh(null,!0),"opt_actionCodeSettings",!0)]},lb:{name:"sendSignInLinkToEmail",j:[rh("email"),oh("actionCodeSettings")]},mb:{name:"setPersistence",j:[rh("persistence")]},Gc:{name:"signInAndRetrieveDataWithCredential",j:[uh()]},ob:{name:"signInAnonymously",j:[]},Sa:{name:"signInWithCredential",j:[uh()]},Hc:{name:"signInWithCustomToken",j:[rh("token")]},Ic:{name:"signInWithEmailAndPassword",j:[rh("email"),rh("password")]},Jc:{name:"signInWithEmailLink",j:[rh("email"),rh("emailLink",!0)]},Kc:{name:"signInWithPhoneNumber",j:[rh("phoneNumber"),ch()]},Lc:{name:"signInWithPopup",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},Mc:{name:"signInWithRedirect",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},Rc:{name:"updateCurrentUser",j:[lh({name:"user",M:"an instance of Firebase User",optional:!1,N:function(e){return!!(e&&e instanceof Rc)}},sh(),"user")]},pb:{name:"signOut",j:[]},toJSON:{name:"toJSON",j:[rh(null,!0)]},Tc:{name:"useDeviceLanguage",j:[]},Uc:{name:"verifyPasswordResetCode",j:[rh("code")]}}),dh(wl.prototype,{lc:{name:"languageCode",Za:lh(rh(),sh(),"languageCode")},ti:{name:"tenantId",Za:lh(rh(),sh(),"tenantId")}}),wl.Persistence=xu,wl.Persistence.LOCAL="local",wl.Persistence.SESSION="session",wl.Persistence.NONE="none",hh(Rc.prototype,{delete:{name:"delete",j:[]},dc:{name:"getIdTokenResult",j:[ih("opt_forceRefresh",!0)]},G:{name:"getIdToken",j:[ih("opt_forceRefresh",!0)]},rc:{name:"linkAndRetrieveDataWithCredential",j:[uh()]},fb:{name:"linkWithCredential",j:[uh()]},sc:{name:"linkWithPhoneNumber",j:[rh("phoneNumber"),ch()]},tc:{name:"linkWithPopup",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},uc:{name:"linkWithRedirect",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},Ac:{name:"reauthenticateAndRetrieveDataWithCredential",j:[uh()]},hb:{name:"reauthenticateWithCredential",j:[uh()]},Bc:{name:"reauthenticateWithPhoneNumber",j:[rh("phoneNumber"),ch()]},Cc:{name:"reauthenticateWithPopup",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},Dc:{name:"reauthenticateWithRedirect",j:[{name:"authProvider",M:"a valid Auth provider",optional:!1,N:function(e){return!!(e&&e.providerId&&e.hasOwnProperty&&e.hasOwnProperty("isOAuthProvider"))}}]},reload:{name:"reload",j:[]},jb:{name:"sendEmailVerification",j:[lh(oh("opt_actionCodeSettings",!0),sh(null,!0),"opt_actionCodeSettings",!0)]},toJSON:{name:"toJSON",j:[rh(null,!0)]},Qc:{name:"unlink",j:[rh("provider")]},rb:{name:"updateEmail",j:[rh("email")]},sb:{name:"updatePassword",j:[rh("password")]},Sc:{name:"updatePhoneNumber",j:[uh("phone")]},tb:{name:"updateProfile",j:[oh("profile")]}}),hh(Ml.prototype,{execute:{name:"execute"},render:{name:"render"},reset:{name:"reset"},getResponse:{name:"getResponse"}}),hh(Ol.prototype,{execute:{name:"execute"},render:{name:"render"},reset:{name:"reset"},getResponse:{name:"getResponse"}}),hh(Ke.prototype,{ka:{name:"finally"},s:{name:"catch"},then:{name:"then"}}),dh(Tc.prototype,{appVerificationDisabled:{name:"appVerificationDisabledForTesting",Za:ih("appVerificationDisabledForTesting")}}),hh(Sc.prototype,{confirm:{name:"confirm",j:[rh("verificationCode")]}}),ph(Gi,"fromJSON",(function(e){e=c(e)?JSON.parse(e):e;for(var t,n=[eo,fo,bo,Xi],r=0;r<n.length;r++)if(t=n[r](e))return t;return null}),[lh(rh(),oh(),"json")]),ph(mo,"credential",(function(e,t){return new po(e,t)}),[rh("email"),rh("password")]),hh(po.prototype,{A:{name:"toJSON",j:[rh(null,!0)]}}),hh(io.prototype,{ya:{name:"addScope",j:[rh("scope")]},Ga:{name:"setCustomParameters",j:[oh("customOAuthParameters")]}}),ph(io,"credential",oo,[lh(rh(),oh(),"token")]),ph(mo,"credentialWithLink",go,[rh("email"),rh("emailLink")]),hh(ao.prototype,{ya:{name:"addScope",j:[rh("scope")]},Ga:{name:"setCustomParameters",j:[oh("customOAuthParameters")]}}),ph(ao,"credential",so,[lh(rh(),oh(),"token")]),hh(uo.prototype,{ya:{name:"addScope",j:[rh("scope")]},Ga:{name:"setCustomParameters",j:[oh("customOAuthParameters")]}}),ph(uo,"credential",co,[lh(rh(),lh(oh(),sh()),"idToken"),lh(rh(),sh(),"accessToken",!0)]),hh(lo.prototype,{Ga:{name:"setCustomParameters",j:[oh("customOAuthParameters")]}}),ph(lo,"credential",ho,[lh(rh(),oh(),"token"),rh("secret",!0)]),hh(ro.prototype,{ya:{name:"addScope",j:[rh("scope")]},credential:{name:"credential",j:[lh(rh(),lh(oh(),sh()),"optionsOrIdToken"),lh(rh(),sh(),"accessToken",!0)]},Ga:{name:"setCustomParameters",j:[oh("customOAuthParameters")]}}),hh(Ji.prototype,{A:{name:"toJSON",j:[rh(null,!0)]}}),hh($i.prototype,{A:{name:"toJSON",j:[rh(null,!0)]}}),ph(_o,"credential",Co,[rh("verificationId"),rh("verificationCode")]),hh(_o.prototype,{Wa:{name:"verifyPhoneNumber",j:[rh("phoneNumber"),ch()]}}),hh(yo.prototype,{A:{name:"toJSON",j:[rh(null,!0)]}}),hh(ei.prototype,{toJSON:{name:"toJSON",j:[rh(null,!0)]}}),hh(Lo.prototype,{toJSON:{name:"toJSON",j:[rh(null,!0)]}}),hh(No.prototype,{toJSON:{name:"toJSON",j:[rh(null,!0)]}}),hh(eh.prototype,{clear:{name:"clear",j:[]},render:{name:"render",j:[]},verify:{name:"verify",j:[]}}),ph(ii,"parseLink",di,[rh("link")]),function(){if(void 0===r.a||!r.a.INTERNAL||!r.a.INTERNAL.registerComponent)throw Error("Cannot find the firebase namespace; be sure to include firebase-app.js before this library.");var e={ActionCodeInfo:{Operation:{EMAIL_SIGNIN:Kr,PASSWORD_RESET:"PASSWORD_RESET",RECOVER_EMAIL:"RECOVER_EMAIL",VERIFY_EMAIL:"VERIFY_EMAIL"}},Auth:wl,AuthCredential:Gi,Error:ei};ph(e,"EmailAuthProvider",mo,[]),ph(e,"FacebookAuthProvider",io,[]),ph(e,"GithubAuthProvider",ao,[]),ph(e,"GoogleAuthProvider",uo,[]),ph(e,"TwitterAuthProvider",lo,[]),ph(e,"OAuthProvider",ro,[rh("providerId")]),ph(e,"SAMLAuthProvider",no,[rh("providerId")]),ph(e,"PhoneAuthProvider",_o,[{name:"auth",M:"an instance of Firebase Auth",optional:!0,N:function(e){return!!(e&&e instanceof wl)}}]),ph(e,"RecaptchaVerifier",eh,[lh(rh(),{name:"",M:"an HTML element",optional:!1,N:function(e){return!!(e&&e instanceof Element)}},"recaptchaContainer"),oh("recaptchaParameters",!0),{name:"app",M:"an instance of Firebase App",optional:!0,N:function(e){return!!(e&&e instanceof r.a.app.App)}}]),ph(e,"ActionCodeURL",ii,[]),r.a.INTERNAL.registerComponent({name:"auth",instanceFactory:function(e){return new wl(e=e.getProvider("app").getImmediate())},multipleInstances:!1,serviceProps:e,instantiationMode:"LAZY",type:"PUBLIC"}),r.a.INTERNAL.registerComponent({name:"auth-internal",instanceFactory:function(e){return{getUid:S((e=e.getProvider("auth").getImmediate()).getUid,e),getToken:S(e.cc,e),addAuthTokenListener:S(e.Wb,e),removeAuthTokenListener:S(e.Ec,e)}},multipleInstances:!1,instantiationMode:"LAZY",type:"PRIVATE"}),r.a.registerVersion("@firebase/auth","0.13.3"),r.a.INTERNAL.extendNamespace({User:Rc})}()}).apply(void 0!==e?e:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})}).call(this,n("yLpj"))},vRfx:function(e,t,n){"use strict";var r=n("q1tI"),i=n.n(r),o=n("ARus"),a=(n("gEbY"),n("bdgK"));var s=function(e){var t,n;function r(){return e.apply(this,arguments)||this}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var s=r.prototype;return s.componentDidMount=function(){this.definePlaying(),this.addResizeListener(),this.forceUpdate()},s.componentWillReceiveProps=function(e,t){var n=this;this.setState({img:e.image}),setTimeout((function(){return n.forceUpdate()}),0)},s.getPane=function(){return"undefined"!=typeof document&&document.getElementById(this.props.id+"_img")},s.definePlaying=function(){Object.defineProperty(HTMLMediaElement.prototype,"playing",{configurable:!0,get:function(){return!!(this.currentTime>0&&!this.paused&&!this.ended&&this.readyState>2)}})},s.addResizeListener=function(){var e=this;new a.a((function(){e.forceUpdate()})).observe(this.getPane())},s.onPaneClick=function(e){this.getPane().currentTime>0&&(e.preventDefault(),this.getPane().pause()),0!==this.getPane().currentTime&&this.addAnnotation(this.newAnnotation(e.nativeEvent))},s.addAnnotation=function(e){this.props.setAnnotations(this.props.image.annotations.filter((function(e){return!!e.comment})).concat(e))},s.newAnnotation=function(e){return{x:e.offsetX/this.getXScale(),y:e.offsetY/this.getYScale(),time:this.getPane().currentTime,id:Math.random()}},s.getXScale=function(){return this.getScale("Width")},s.getYScale=function(){return this.getScale("Height")},s.getScale=function(e){var t=this.getPane();return t["offset"+e]/(t["natural"+e]||(0===t["video"+e]?1:t["video"+e]))},s.render=function(){var e=this;return[i.a.createElement("div",{style:this.props.style,className:"annocontainer",id:"annotationcontainer"},!!this.props.time&&i.a.createElement("div",{className:"videotimestamp"},this.props.time),"video"===this.props.image.resource_type?i.a.createElement("video",{crossOrigin:"anonymous",onTimeUpdate:function(){return e.props.setTime(e.getPane().currentTime)},alt:"curimg",id:this.props.id+"_img",controls:!0,onClick:function(t){return e.onPaneClick(t)},src:this.props.image.secure_url,poster:this.props.image.src}):i.a.createElement("img",{alt:this.props.id+"_img",id:this.props.id+"_img",onClick:function(t){return e.onPaneClick(t)},src:this.props.image.src}),this.getPane()&&this.props.image.annotations.map((function(t,n){return i.a.createElement(o.a,{key:t.id,getPane:function(){return e.getPane()},remove:function(){t.comment="",e.props.save()},onSave:function(){return e.props.save()},onMove:function(n){n.x=Math.max(n.x,15),n.y=Math.max(n.y,15),n.x=Math.min(n.x,e.getPane().offsetWidth-15),n.y=Math.min(n.y,e.getPane().offsetHeight-15),t.x=n.x/e.getXScale(e.getPane()),t.y=n.y/e.getYScale(e.getPane()),e.props.save()},onChange:function(n){t.comment=n,e.forceUpdate()},comment:t.comment,annotation:t,pos:{x:t.x*e.getXScale(),y:t.y*e.getYScale()}})})))]},r}(i.a.Component);t.a=s},voZr:function(e,t,n){"use strict";var r=n("emib"),i=n("QPJK"),o=n("939K"),a=n("Jegl"),s=n("8wc8"),u=n("rj/q"),c=n("96qb"),l=n("xa9o"),h=n("1Llc"),d=n("kiRH"),p=n("gx6d"),f=n("chL8").f,m=n("rjfK").f,g=n("Y++M"),v=n("dSuk"),y="prototype",b="Wrong index!",w=r.ArrayBuffer,_=r.DataView,C=r.Math,T=r.RangeError,S=r.Infinity,E=w,x=C.abs,I=C.pow,k=C.floor,A=C.log,N=C.LN2,L=i?"_b":"buffer",D=i?"_l":"byteLength",O=i?"_o":"byteOffset";function M(e,t,n){var r,i,o,a=new Array(n),s=8*n-t-1,u=(1<<s)-1,c=u>>1,l=23===t?I(2,-24)-I(2,-77):0,h=0,d=e<0||0===e&&1/e<0?1:0;for((e=x(e))!=e||e===S?(i=e!=e?1:0,r=u):(r=k(A(e)/N),e*(o=I(2,-r))<1&&(r--,o*=2),(e+=r+c>=1?l/o:l*I(2,1-c))*o>=2&&(r++,o/=2),r+c>=u?(i=0,r=u):r+c>=1?(i=(e*o-1)*I(2,t),r+=c):(i=e*I(2,c-1)*I(2,t),r=0));t>=8;a[h++]=255&i,i/=256,t-=8);for(r=r<<t|i,s+=t;s>0;a[h++]=255&r,r/=256,s-=8);return a[--h]|=128*d,a}function R(e,t,n){var r,i=8*n-t-1,o=(1<<i)-1,a=o>>1,s=i-7,u=n-1,c=e[u--],l=127&c;for(c>>=7;s>0;l=256*l+e[u],u--,s-=8);for(r=l&(1<<-s)-1,l>>=-s,s+=t;s>0;r=256*r+e[u],u--,s-=8);if(0===l)l=1-a;else{if(l===o)return r?NaN:c?-S:S;r+=I(2,t),l-=a}return(c?-1:1)*r*I(2,l-t)}function P(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]}function F(e){return[255&e]}function j(e){return[255&e,e>>8&255]}function B(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function V(e){return M(e,52,8)}function W(e){return M(e,23,4)}function U(e,t,n){m(e[y],t,{get:function(){return this[n]}})}function H(e,t,n,r){var i=p(+n);if(i+t>e[D])throw T(b);var o=e[L]._b,a=i+e[O],s=o.slice(a,a+t);return r?s:s.reverse()}function z(e,t,n,r,i,o){var a=p(+n);if(a+t>e[D])throw T(b);for(var s=e[L]._b,u=a+e[O],c=r(+i),l=0;l<t;l++)s[u+l]=c[o?l:t-l-1]}if(a.ABV){if(!c((function(){w(1)}))||!c((function(){new w(-1)}))||c((function(){return new w,new w(1.5),new w(NaN),"ArrayBuffer"!=w.name}))){for(var q,K=(w=function(e){return l(this,w),new E(p(e))})[y]=E[y],G=f(E),Q=0;G.length>Q;)(q=G[Q++])in w||s(w,q,E[q]);o||(K.constructor=w)}var $=new _(new w(2)),Y=_[y].setInt8;$.setInt8(0,2147483648),$.setInt8(1,2147483649),!$.getInt8(0)&&$.getInt8(1)||u(_[y],{setInt8:function(e,t){Y.call(this,e,t<<24>>24)},setUint8:function(e,t){Y.call(this,e,t<<24>>24)}},!0)}else w=function(e){l(this,w,"ArrayBuffer");var t=p(e);this._b=g.call(new Array(t),0),this[D]=t},_=function(e,t,n){l(this,_,"DataView"),l(e,w,"DataView");var r=e[D],i=h(t);if(i<0||i>r)throw T("Wrong offset!");if(i+(n=void 0===n?r-i:d(n))>r)throw T("Wrong length!");this[L]=e,this[O]=i,this[D]=n},i&&(U(w,"byteLength","_l"),U(_,"buffer","_b"),U(_,"byteLength","_l"),U(_,"byteOffset","_o")),u(_[y],{getInt8:function(e){return H(this,1,e)[0]<<24>>24},getUint8:function(e){return H(this,1,e)[0]},getInt16:function(e){var t=H(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=H(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return P(H(this,4,e,arguments[1]))},getUint32:function(e){return P(H(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return R(H(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return R(H(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){z(this,1,e,F,t)},setUint8:function(e,t){z(this,1,e,F,t)},setInt16:function(e,t){z(this,2,e,j,t,arguments[2])},setUint16:function(e,t){z(this,2,e,j,t,arguments[2])},setInt32:function(e,t){z(this,4,e,B,t,arguments[2])},setUint32:function(e,t){z(this,4,e,B,t,arguments[2])},setFloat32:function(e,t){z(this,4,e,W,t,arguments[2])},setFloat64:function(e,t){z(this,8,e,V,t,arguments[2])}});v(w,"ArrayBuffer"),v(_,"DataView"),s(_[y],a.VIEW,!0),t.ArrayBuffer=w,t.DataView=_},wRvv:function(e,t){e.exports=["aaa","aarp","abarth","abb","abbott","abbvie","abc","able","abogado","abudhabi","ac","academy","accenture","accountant","accountants","aco","actor","ad","adac","ads","adult","ae","aeg","aero","aetna","af","afamilycompany","afl","africa","ag","agakhan","agency","ai","aig","aigo","airbus","airforce","airtel","akdn","al","alfaromeo","alibaba","alipay","allfinanz","allstate","ally","alsace","alstom","am","americanexpress","americanfamily","amex","amfam","amica","amsterdam","analytics","android","anquan","anz","ao","aol","apartments","app","apple","aq","aquarelle","ar","arab","aramco","archi","army","arpa","art","arte","as","asda","asia","associates","at","athleta","attorney","au","auction","audi","audible","audio","auspost","author","auto","autos","avianca","aw","aws","ax","axa","az","azure","ba","baby","baidu","banamex","bananarepublic","band","bank","bar","barcelona","barclaycard","barclays","barefoot","bargains","baseball","basketball","bauhaus","bayern","bb","bbc","bbt","bbva","bcg","bcn","bd","be","beats","beauty","beer","bentley","berlin","best","bestbuy","bet","bf","bg","bh","bharti","bi","bible","bid","bike","bing","bingo","bio","biz","bj","black","blackfriday","blockbuster","blog","bloomberg","blue","bm","bms","bmw","bn","bnpparibas","bo","boats","boehringer","bofa","bom","bond","boo","book","booking","bosch","bostik","boston","bot","boutique","box","br","bradesco","bridgestone","broadway","broker","brother","brussels","bs","bt","budapest","bugatti","build","builders","business","buy","buzz","bv","bw","by","bz","bzh","ca","cab","cafe","cal","call","calvinklein","cam","camera","camp","cancerresearch","canon","capetown","capital","capitalone","car","caravan","cards","care","career","careers","cars","casa","case","caseih","cash","casino","cat","catering","catholic","cba","cbn","cbre","cbs","cc","cd","ceb","center","ceo","cern","cf","cfa","cfd","cg","ch","chanel","channel","charity","chase","chat","cheap","chintai","christmas","chrome","church","ci","cipriani","circle","cisco","citadel","citi","citic","city","cityeats","ck","cl","claims","cleaning","click","clinic","clinique","clothing","cloud","club","clubmed","cm","cn","co","coach","codes","coffee","college","cologne","com","comcast","commbank","community","company","compare","computer","comsec","condos","construction","consulting","contact","contractors","cooking","cookingchannel","cool","coop","corsica","country","coupon","coupons","courses","cpa","cr","credit","creditcard","creditunion","cricket","crown","crs","cruise","cruises","csc","cu","cuisinella","cv","cw","cx","cy","cymru","cyou","cz","dabur","dad","dance","data","date","dating","datsun","day","dclk","dds","de","deal","dealer","deals","degree","delivery","dell","deloitte","delta","democrat","dental","dentist","desi","design","dev","dhl","diamonds","diet","digital","direct","directory","discount","discover","dish","diy","dj","dk","dm","dnp","do","docs","doctor","dog","domains","dot","download","drive","dtv","dubai","duck","dunlop","dupont","durban","dvag","dvr","dz","earth","eat","ec","eco","edeka","edu","education","ee","eg","email","emerck","energy","engineer","engineering","enterprises","epson","equipment","er","ericsson","erni","es","esq","estate","esurance","et","etisalat","eu","eurovision","eus","events","exchange","expert","exposed","express","extraspace","fage","fail","fairwinds","faith","family","fan","fans","farm","farmers","fashion","fast","fedex","feedback","ferrari","ferrero","fi","fiat","fidelity","fido","film","final","finance","financial","fire","firestone","firmdale","fish","fishing","fit","fitness","fj","fk","flickr","flights","flir","florist","flowers","fly","fm","fo","foo","food","foodnetwork","football","ford","forex","forsale","forum","foundation","fox","fr","free","fresenius","frl","frogans","frontdoor","frontier","ftr","fujitsu","fujixerox","fun","fund","furniture","futbol","fyi","ga","gal","gallery","gallo","gallup","game","games","gap","garden","gay","gb","gbiz","gd","gdn","ge","gea","gent","genting","george","gf","gg","ggee","gh","gi","gift","gifts","gives","giving","gl","glade","glass","gle","global","globo","gm","gmail","gmbh","gmo","gmx","gn","godaddy","gold","goldpoint","golf","goo","goodyear","goog","google","gop","got","gov","gp","gq","gr","grainger","graphics","gratis","green","gripe","grocery","group","gs","gt","gu","guardian","gucci","guge","guide","guitars","guru","gw","gy","hair","hamburg","hangout","haus","hbo","hdfc","hdfcbank","health","healthcare","help","helsinki","here","hermes","hgtv","hiphop","hisamitsu","hitachi","hiv","hk","hkt","hm","hn","hockey","holdings","holiday","homedepot","homegoods","homes","homesense","honda","horse","hospital","host","hosting","hot","hoteles","hotels","hotmail","house","how","hr","hsbc","ht","hu","hughes","hyatt","hyundai","ibm","icbc","ice","icu","id","ie","ieee","ifm","ikano","il","im","imamat","imdb","immo","immobilien","in","inc","industries","infiniti","info","ing","ink","institute","insurance","insure","int","intel","international","intuit","investments","io","ipiranga","iq","ir","irish","is","ismaili","ist","istanbul","it","itau","itv","iveco","jaguar","java","jcb","jcp","je","jeep","jetzt","jewelry","jio","jll","jm","jmp","jnj","jo","jobs","joburg","jot","joy","jp","jpmorgan","jprs","juegos","juniper","kaufen","kddi","ke","kerryhotels","kerrylogistics","kerryproperties","kfh","kg","kh","ki","kia","kim","kinder","kindle","kitchen","kiwi","km","kn","koeln","komatsu","kosher","kp","kpmg","kpn","kr","krd","kred","kuokgroup","kw","ky","kyoto","kz","la","lacaixa","lamborghini","lamer","lancaster","lancia","land","landrover","lanxess","lasalle","lat","latino","latrobe","law","lawyer","lb","lc","lds","lease","leclerc","lefrak","legal","lego","lexus","lgbt","li","liaison","lidl","life","lifeinsurance","lifestyle","lighting","like","lilly","limited","limo","lincoln","linde","link","lipsy","live","living","lixil","lk","llc","loan","loans","locker","locus","loft","lol","london","lotte","lotto","love","lpl","lplfinancial","lr","ls","lt","ltd","ltda","lu","lundbeck","lupin","luxe","luxury","lv","ly","ma","macys","madrid","maif","maison","makeup","man","management","mango","map","market","marketing","markets","marriott","marshalls","maserati","mattel","mba","mc","mckinsey","md","me","med","media","meet","melbourne","meme","memorial","men","menu","merckmsd","metlife","mg","mh","miami","microsoft","mil","mini","mint","mit","mitsubishi","mk","ml","mlb","mls","mm","mma","mn","mo","mobi","mobile","moda","moe","moi","mom","monash","money","monster","mormon","mortgage","moscow","moto","motorcycles","mov","movie","movistar","mp","mq","mr","ms","msd","mt","mtn","mtr","mu","museum","mutual","mv","mw","mx","my","mz","na","nab","nadex","nagoya","name","nationwide","natura","navy","nba","nc","ne","nec","net","netbank","netflix","network","neustar","new","newholland","news","next","nextdirect","nexus","nf","nfl","ng","ngo","nhk","ni","nico","nike","nikon","ninja","nissan","nissay","nl","no","nokia","northwesternmutual","norton","now","nowruz","nowtv","np","nr","nra","nrw","ntt","nu","nyc","nz","obi","observer","off","office","okinawa","olayan","olayangroup","oldnavy","ollo","om","omega","one","ong","onl","online","onyourside","ooo","open","oracle","orange","org","organic","origins","osaka","otsuka","ott","ovh","pa","page","panasonic","paris","pars","partners","parts","party","passagens","pay","pccw","pe","pet","pf","pfizer","pg","ph","pharmacy","phd","philips","phone","photo","photography","photos","physio","pics","pictet","pictures","pid","pin","ping","pink","pioneer","pizza","pk","pl","place","play","playstation","plumbing","plus","pm","pn","pnc","pohl","poker","politie","porn","post","pr","pramerica","praxi","press","prime","pro","prod","productions","prof","progressive","promo","properties","property","protection","pru","prudential","ps","pt","pub","pw","pwc","py","qa","qpon","quebec","quest","qvc","racing","radio","raid","re","read","realestate","realtor","realty","recipes","red","redstone","redumbrella","rehab","reise","reisen","reit","reliance","ren","rent","rentals","repair","report","republican","rest","restaurant","review","reviews","rexroth","rich","richardli","ricoh","rightathome","ril","rio","rip","rmit","ro","rocher","rocks","rodeo","rogers","room","rs","rsvp","ru","rugby","ruhr","run","rw","rwe","ryukyu","sa","saarland","safe","safety","sakura","sale","salon","samsclub","samsung","sandvik","sandvikcoromant","sanofi","sap","sarl","sas","save","saxo","sb","sbi","sbs","sc","sca","scb","schaeffler","schmidt","scholarships","school","schule","schwarz","science","scjohnson","scor","scot","sd","se","search","seat","secure","security","seek","select","sener","services","ses","seven","sew","sex","sexy","sfr","sg","sh","shangrila","sharp","shaw","shell","shia","shiksha","shoes","shop","shopping","shouji","show","showtime","shriram","si","silk","sina","singles","site","sj","sk","ski","skin","sky","skype","sl","sling","sm","smart","smile","sn","sncf","so","soccer","social","softbank","software","sohu","solar","solutions","song","sony","soy","space","sport","spot","spreadbetting","sr","srl","ss","st","stada","staples","star","statebank","statefarm","stc","stcgroup","stockholm","storage","store","stream","studio","study","style","su","sucks","supplies","supply","support","surf","surgery","suzuki","sv","swatch","swiftcover","swiss","sx","sy","sydney","symantec","systems","sz","tab","taipei","talk","taobao","target","tatamotors","tatar","tattoo","tax","taxi","tc","tci","td","tdk","team","tech","technology","tel","telefonica","temasek","tennis","teva","tf","tg","th","thd","theater","theatre","tiaa","tickets","tienda","tiffany","tips","tires","tirol","tj","tjmaxx","tjx","tk","tkmaxx","tl","tm","tmall","tn","to","today","tokyo","tools","top","toray","toshiba","total","tours","town","toyota","toys","tr","trade","trading","training","travel","travelchannel","travelers","travelersinsurance","trust","trv","tt","tube","tui","tunes","tushu","tv","tvs","tw","tz","ua","ubank","ubs","ug","uk","unicom","university","uno","uol","ups","us","uy","uz","va","vacations","vana","vanguard","vc","ve","vegas","ventures","verisign","versicherung","vet","vg","vi","viajes","video","vig","viking","villas","vin","vip","virgin","visa","vision","vistaprint","viva","vivo","vlaanderen","vn","vodka","volkswagen","volvo","vote","voting","voto","voyage","vu","vuelos","wales","walmart","walter","wang","wanggou","watch","watches","weather","weatherchannel","webcam","weber","website","wed","wedding","weibo","weir","wf","whoswho","wien","wiki","williamhill","win","windows","wine","winners","wme","wolterskluwer","woodside","work","works","world","wow","ws","wtc","wtf","xbox","xerox","xfinity","xihuan","xin","कॉम","セール","佛山","ಭಾರತ","慈善","集团","在线","한국","ଭାରତ","大众汽车","点看","คอม","ভাৰত","ভারত","八卦","موقع","বাংলা","公益","公司","香格里拉","网站","移动","我爱你","москва","қаз","католик","онлайн","сайт","联通","срб","бг","бел","קום","时尚","微博","淡马锡","ファッション","орг","नेट","ストア","삼성","சிங்கப்பூர்","商标","商店","商城","дети","мкд","ею","ポイント","新闻","工行","家電","كوم","中文网","中信","中国","中國","娱乐","谷歌","భారత్","ලංකා","電訊盈科","购物","クラウド","ભારત","通販","भारतम्","भारत","भारोत","网店","संगठन","餐厅","网络","ком","укр","香港","诺基亚","食品","飞利浦","台湾","台灣","手表","手机","мон","الجزائر","عمان","ارامكو","ایران","العليان","اتصالات","امارات","بازار","موريتانيا","پاکستان","الاردن","بارت","بھارت","المغرب","ابوظبي","السعودية","ڀارت","كاثوليك","سودان","همراه","عراق","مليسيا","澳門","닷컴","政府","شبكة","بيتك","عرب","გე","机构","组织机构","健康","ไทย","سورية","招聘","рус","рф","珠宝","تونس","大拿","みんな","グーグル","ευ","ελ","世界","書籍","ഭാരതം","ਭਾਰਤ","网址","닷넷","コム","天主教","游戏","vermögensberater","vermögensberatung","企业","信息","嘉里大酒店","嘉里","مصر","قطر","广东","இலங்கை","இந்தியா","հայ","新加坡","فلسطين","政务","xxx","xyz","yachts","yahoo","yamaxun","yandex","ye","yodobashi","yoga","yokohama","you","youtube","yt","yun","za","zappos","zara","zero","zip","zm","zone","zuerich","zw"]},wj3C:function(e,t,n){"use strict";n("sc67"),n("OeI1"),n("Ll4R"),n("n7j8"),n("Ggvi"),n("xJgp"),n("AqHK"),n("YbXK"),n("6kNP"),n("rzGZ"),n("Dq+y"),n("8npG"),n("pJf4"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r,i,o=n("mrSG"),a=n("zVF4"),s=n("S+S0"),u=n("q/0M"),c=((r={})["no-app"]="No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()",r["bad-app-name"]="Illegal App name: '{$appName}",r["duplicate-app"]="Firebase App named '{$appName}' already exists",r["app-deleted"]="Firebase App named '{$appName}' already deleted",r["invalid-app-argument"]="firebase.{$appName}() takes either no argument or a Firebase App instance.",r),l=new a.ErrorFactory("app","Firebase",c),h="@firebase/app",d="0.5.0",p="[DEFAULT]",f=((i={})[h]="fire-core",i["@firebase/analytics"]="fire-analytics",i["@firebase/auth"]="fire-auth",i["@firebase/database"]="fire-rtdb",i["@firebase/functions"]="fire-fn",i["@firebase/installations"]="fire-iid",i["@firebase/messaging"]="fire-fcm",i["@firebase/performance"]="fire-perf",i["@firebase/remote-config"]="fire-rc",i["@firebase/storage"]="fire-gcs",i["@firebase/firestore"]="fire-fst",i["fire-js"]="fire-js",i["firebase-wrapper"]="fire-js-all",i),m=new u.Logger("@firebase/app"),g=function(){function e(e,t,n){var r,i,u=this;this.firebase_=n,this.isDeleted_=!1,this.name_=t.name,this.automaticDataCollectionEnabled_=t.automaticDataCollectionEnabled||!1,this.options_=a.deepCopy(e),this.container=new s.ComponentContainer(t.name),this._addComponent(new s.Component("app",(function(){return u}),"PUBLIC"));try{for(var c=o.__values(this.firebase_.INTERNAL.components.values()),l=c.next();!l.done;l=c.next()){var h=l.value;this._addComponent(h)}}catch(d){r={error:d}}finally{try{l&&!l.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}}return Object.defineProperty(e.prototype,"automaticDataCollectionEnabled",{get:function(){return this.checkDestroyed_(),this.automaticDataCollectionEnabled_},set:function(e){this.checkDestroyed_(),this.automaticDataCollectionEnabled_=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),e.prototype.delete=function(){var e=this;return new Promise((function(t){e.checkDestroyed_(),t()})).then((function(){return e.firebase_.INTERNAL.removeApp(e.name_),Promise.all(e.container.getProviders().map((function(e){return e.delete()})))})).then((function(){e.isDeleted_=!0}))},e.prototype._getService=function(e,t){return void 0===t&&(t=p),this.checkDestroyed_(),this.container.getProvider(e).getImmediate({identifier:t})},e.prototype._removeServiceInstance=function(e,t){void 0===t&&(t=p),this.container.getProvider(e).clearInstance(t)},e.prototype._addComponent=function(e){try{this.container.addComponent(e)}catch(t){m.debug("Component "+e.name+" failed to register with FirebaseApp "+this.name,t)}},e.prototype._addOrOverwriteComponent=function(e){this.container.addOrOverwriteComponent(e)},e.prototype.checkDestroyed_=function(){if(this.isDeleted_)throw l.create("app-deleted",{appName:this.name_})},e}();g.prototype.name&&g.prototype.options||g.prototype.delete||console.log("dc");var v="7.6.0";var y=function e(){var t=function(e){var t={},n=new Map,r={__esModule:!0,initializeApp:function(n,i){void 0===i&&(i={});if("object"!=typeof i||null===i){i={name:i}}var o=i;void 0===o.name&&(o.name=p);var s=o.name;if("string"!=typeof s||!s)throw l.create("bad-app-name",{appName:String(s)});if(a.contains(t,s))throw l.create("duplicate-app",{appName:s});var u=new e(n,o,r);return t[s]=u,u},app:i,registerVersion:function(e,t,n){var r,i=null!==(r=f[e])&&void 0!==r?r:e;n&&(i+="-"+n);var o=i.match(/\s|\//),a=t.match(/\s|\//);if(o||a){var c=['Unable to register library "'+i+'" with version "'+t+'":'];return o&&c.push('library name "'+i+'" contains illegal characters (whitespace or "/")'),o&&a&&c.push("and"),a&&c.push('version name "'+t+'" contains illegal characters (whitespace or "/")'),void m.warn(c.join(" "))}u(new s.Component(i+"-version",(function(){return{library:i,version:t}}),"VERSION"))},apps:null,SDK_VERSION:v,INTERNAL:{registerComponent:u,removeApp:function(e){delete t[e]},components:n,useAsService:function(e,t){if("serverAuth"===t)return null;return t}}};function i(e){if(e=e||p,!a.contains(t,e))throw l.create("no-app",{appName:e});return t[e]}function u(s){var u,c,h=s.name;if(n.has(h))return m.debug("There were multiple attempts to register component "+h+"."),"PUBLIC"===s.type?r[h]:null;if(n.set(h,s),"PUBLIC"===s.type){var d=function(e){if(void 0===e&&(e=i()),"function"!=typeof e[h])throw l.create("invalid-app-argument",{appName:h});return e[h]()};void 0!==s.serviceProps&&a.deepExtend(d,s.serviceProps),r[h]=d,e.prototype[h]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=this._getService.bind(this,h);return n.apply(this,s.multipleInstances?e:[])}}try{for(var p=o.__values(Object.keys(t)),f=p.next();!f.done;f=p.next()){var g=f.value;t[g]._addComponent(s)}}catch(v){u={error:v}}finally{try{f&&!f.done&&(c=p.return)&&c.call(p)}finally{if(u)throw u.error}}return"PUBLIC"===s.type?r[h]:null}return r.default=r,Object.defineProperty(r,"apps",{get:function(){return Object.keys(t).map((function(e){return t[e]}))}}),i.App=e,r}(g);return t.INTERNAL=o.__assign(o.__assign({},t.INTERNAL),{createFirebaseNamespace:e,extendNamespace:function(e){a.deepExtend(t,e)},createSubscribe:a.createSubscribe,ErrorFactory:a.ErrorFactory,deepExtend:a.deepExtend}),t}(),b=function(){function e(e){this.container=e}return e.prototype.getPlatformInfoString=function(){return this.container.getProviders().map((function(e){if(function(e){var t,n=e.getComponent();return"VERSION"===(null===(t=n)||void 0===t?void 0:t.type)}(e)){var t=e.getImmediate();return t.library+"/"+t.version}return null})).filter((function(e){return e})).join(" ")},e}();if(a.isBrowser()&&void 0!==self.firebase){m.warn("\n    Warning: Firebase is already defined in the global scope. Please make sure\n    Firebase library is only loaded once.\n  ");var w=self.firebase.SDK_VERSION;w&&w.indexOf("LITE")>=0&&m.warn("\n    Warning: You are trying to load Firebase while using Firebase Performance standalone script.\n    You should load Firebase Performance with this instance of Firebase to avoid loading duplicate code.\n    ")}var _=y.initializeApp;y.initializeApp=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return a.isNode()&&m.warn('\n      Warning: This is a browser-targeted Firebase bundle but it appears it is being\n      run in a Node environment.  If running in a Node environment, make sure you\n      are using the bundle specified by the "main" field in package.json.\n      \n      If you are using Webpack, you can specify "main" as the first item in\n      "resolve.mainFields":\n      https://webpack.js.org/configuration/resolve/#resolvemainfields\n      \n      If using Rollup, use the rollup-plugin-node-resolve plugin and specify "main"\n      as the first item in "mainFields", e.g. [\'main\', \'module\'].\n      https://github.com/rollup/rollup-plugin-node-resolve\n      '),_.apply(void 0,e)};var C=y;!function(e,t){e.INTERNAL.registerComponent(new s.Component("platform-logger",(function(e){return new b(e)}),"PRIVATE")),e.registerVersion(h,d,t),e.registerVersion("fire-js","")}(C),t.default=C,t.firebase=C},x7I3:function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"ErrorCode",(function(){return cr})),n.d(t,"EventType",(function(){return lr})),n.d(t,"WebChannel",(function(){return hr})),n.d(t,"XhrIo",(function(){return dr})),n.d(t,"createWebChannelTransport",(function(){return ur}));n("lFjb"),n("Ll4R"),n("sC2a"),n("R48M"),n("YBKJ"),n("HXzo"),n("JHok"),n("1dPr"),n("sc67"),n("n7j8"),n("q8oJ"),n("C9fy"),n("8npG"),n("HQhv");var r,i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{},o=o||{},a=i;function s(e){return"string"==typeof e}function u(e){return"number"==typeof e}function c(e,t){e=e.split("."),t=t||a;for(var n=0;n<e.length;n++)if(null==(t=t[e[n]]))return null;return t}function l(){}function h(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var n=Object.prototype.toString.call(e);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof e.length&&void 0!==e.splice&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==e.call&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===e.call)return"object";return t}function d(e){return"array"==h(e)}function p(e){var t=h(e);return"array"==t||"object"==t&&"number"==typeof e.length}function f(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var m="closure_uid_"+(1e9*Math.random()>>>0),g=0;function v(e,t,n){return e.call.apply(e.bind,arguments)}function y(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function b(e,t,n){return(b=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?v:y).apply(null,arguments)}function w(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}var _=Date.now||function(){return+new Date};function C(e,t){function n(){}n.prototype=t.prototype,e.N=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.xb=function(e,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return t.prototype[n].apply(e,i)}}function T(){this.j=this.j,this.i=this.i}T.prototype.j=!1,T.prototype.la=function(){if(!this.j&&(this.j=!0,this.G(),0))this[m]||(this[m]=++g)},T.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var S=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if(s(e))return s(t)&&1==t.length?e.indexOf(t,0):-1;for(var n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},E=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){for(var r=e.length,i=s(e)?e.split(""):e,o=0;o<r;o++)o in i&&t.call(n,i[o],o,e)};function x(e){return Array.prototype.concat.apply([],arguments)}function I(e){var t=e.length;if(0<t){for(var n=Array(t),r=0;r<t;r++)n[r]=e[r];return n}return[]}function k(e){return/^[\s\xa0]*$/.test(e)}var A,N=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function L(e,t){return-1!=e.indexOf(t)}function D(e,t){return e<t?-1:e>t?1:0}e:{var O=a.navigator;if(O){var M=O.userAgent;if(M){A=M;break e}}A=""}function R(e,t,n){for(var r in e)t.call(n,e[r],r,e)}function P(e){var t,n={};for(t in e)n[t]=e[t];return n}var F="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function j(e,t){for(var n,r,i=1;i<arguments.length;i++){for(n in r=arguments[i])e[n]=r[n];for(var o=0;o<F.length;o++)n=F[o],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function B(e){return B[" "](e),e}B[" "]=l;var V,W,U=L(A,"Opera"),H=L(A,"Trident")||L(A,"MSIE"),z=L(A,"Edge"),q=z||H,K=L(A,"Gecko")&&!(L(A.toLowerCase(),"webkit")&&!L(A,"Edge"))&&!(L(A,"Trident")||L(A,"MSIE"))&&!L(A,"Edge"),G=L(A.toLowerCase(),"webkit")&&!L(A,"Edge");function Q(){var e=a.document;return e?e.documentMode:void 0}e:{var $="",Y=(W=A,K?/rv:([^\);]+)(\)|;)/.exec(W):z?/Edge\/([\d\.]+)/.exec(W):H?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(W):G?/WebKit\/(\S+)/.exec(W):U?/(?:Version)[ \/]?(\S+)/.exec(W):void 0);if(Y&&($=Y?Y[1]:""),H){var X=Q();if(null!=X&&X>parseFloat($)){V=String(X);break e}}V=$}var J,Z={};function ee(e){return function(e,t){var n=Z;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e)}(e,(function(){for(var t=0,n=N(String(V)).split("."),r=N(String(e)).split("."),i=Math.max(n.length,r.length),o=0;0==t&&o<i;o++){var a=n[o]||"",s=r[o]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;t=D(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||D(0==a[2].length,0==s[2].length)||D(a[2],s[2]),a=a[3],s=s[3]}while(0==t)}return 0<=t}))}var te=a.document;J=te&&H?Q()||("CSS1Compat"==te.compatMode?parseInt(V,10):5):void 0;var ne=!H||9<=Number(J),re=H&&!ee("9"),ie=function(){if(!a.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{a.addEventListener("test",l,t),a.removeEventListener("test",l,t)}catch(n){}return e}();function oe(e,t){this.type=e,this.a=this.target=t,this.Ia=!0}function ae(e,t){if(oe.call(this,e?e.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.a=t,t=e.relatedTarget){if(K){e:{try{B(t.nodeName);var i=!0;break e}catch(o){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType=s(e.pointerType)?e.pointerType:se[e.pointerType]||"",this.c=e,e.defaultPrevented&&this.b()}}oe.prototype.b=function(){this.Ia=!1},C(ae,oe);var se={2:"touch",3:"pen",4:"mouse"};ae.prototype.b=function(){ae.N.b.call(this);var e=this.c;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,re)try{(e.ctrlKey||112<=e.keyCode&&123>=e.keyCode)&&(e.keyCode=-1)}catch(t){}};var ue="closure_listenable_"+(1e6*Math.random()|0),ce=0;function le(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.da=i,this.key=++ce,this.X=this.Z=!1}function he(e){e.X=!0,e.listener=null,e.proxy=null,e.src=null,e.da=null}function de(e){this.src=e,this.a={},this.b=0}function pe(e,t){var n=t.type;if(n in e.a){var r,i=e.a[n],o=S(i,t);(r=0<=o)&&Array.prototype.splice.call(i,o,1),r&&(he(t),0==e.a[n].length&&(delete e.a[n],e.b--))}}function fe(e,t,n,r){for(var i=0;i<e.length;++i){var o=e[i];if(!o.X&&o.listener==t&&o.capture==!!n&&o.da==r)return i}return-1}de.prototype.add=function(e,t,n,r,i){var o=e.toString();(e=this.a[o])||(e=this.a[o]=[],this.b++);var a=fe(e,t,r,i);return-1<a?(t=e[a],n||(t.Z=!1)):((t=new le(t,this.src,o,!!r,i)).Z=n,e.push(t)),t};var me="closure_lm_"+(1e6*Math.random()|0),ge={};function ve(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,o){if(d(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,o);return null}return r=Ee(r),t&&t[ue]?t.Aa(n,r,f(i)?!!i.capture:!!i,o):ye(t,n,r,!0,i,o)}(e,t,n,r,i);if(d(t)){for(var o=0;o<t.length;o++)ve(e,t[o],n,r,i);return null}return n=Ee(n),e&&e[ue]?e.za(t,n,f(r)?!!r.capture:!!r,i):ye(e,t,n,!1,r,i)}function ye(e,t,n,r,i,o){if(!t)throw Error("Invalid event type");var a=f(i)?!!i.capture:!!i;if(a&&!ne)return null;var s=Te(e);if(s||(e[me]=s=new de(e)),(n=s.add(t,n,r,a,o)).proxy)return n;if(r=function(){var e=Ce,t=ne?function(n){return e.call(t.src,t.listener,n)}:function(n){if(!(n=e.call(t.src,t.listener,n)))return n};return t}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)ie||(i=a),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(we(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function be(e){if(!u(e)&&e&&!e.X){var t=e.src;if(t&&t[ue])pe(t.c,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(we(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Te(t))?(pe(n,e),0==n.b&&(n.src=null,t[me]=null)):he(e)}}}function we(e){return e in ge?ge[e]:ge[e]="on"+e}function _e(e,t){var n=e.listener,r=e.da||e.src;return e.Z&&be(e),n.call(r,t)}function Ce(e,t){return!!e.X||(ne?_e(e,new ae(t,this)):_e(e,t=new ae(t||c("window.event"),this)))}function Te(e){return(e=e[me])instanceof de?e:null}var Se="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ee(e){return"function"==h(e)?e:(e[Se]||(e[Se]=function(t){return e.handleEvent(t)}),e[Se])}function xe(){T.call(this),this.c=new de(this),this.J=this,this.B=null}function Ie(e,t,n,r){if(!(t=e.c.a[String(t)]))return!0;t=t.concat();for(var i=!0,o=0;o<t.length;++o){var a=t[o];if(a&&!a.X&&a.capture==n){var s=a.listener,u=a.da||a.src;a.Z&&pe(e.c,a),i=!1!==s.call(u,r)&&i}}return i&&0!=r.Ia}C(xe,T),xe.prototype[ue]=!0,(r=xe.prototype).addEventListener=function(e,t,n,r){ve(this,e,t,n,r)},r.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,o){if(d(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,o);else i=f(i)?!!i.capture:!!i,r=Ee(r),t&&t[ue]?(t=t.c,(n=String(n).toString())in t.a&&(-1<(r=fe(a=t.a[n],r,i,o))&&(he(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.a[n],t.b--)))):t&&(t=Te(t))&&(n=t.a[n.toString()],t=-1,n&&(t=fe(n,r,i,o)),(r=-1<t?n[t]:null)&&be(r))}(this,e,t,n,r)},r.dispatchEvent=function(e){var t,n=this.B;if(n)for(t=[];n;n=n.B)t.push(n);n=this.J;var r=e.type||e;if(s(e))e=new oe(e,n);else if(e instanceof oe)e.target=e.target||n;else{var i=e;j(e=new oe(r,n),i)}if(i=!0,t)for(var o=t.length-1;0<=o;o--){var a=e.a=t[o];i=Ie(a,r,!0,e)&&i}if(i=Ie(a=e.a=n,r,!0,e)&&i,i=Ie(a,r,!1,e)&&i,t)for(o=0;o<t.length;o++)i=Ie(a=e.a=t[o],r,!1,e)&&i;return i},r.G=function(){if(xe.N.G.call(this),this.c){var e,t=this.c;for(e in t.a){for(var n=t.a[e],r=0;r<n.length;r++)he(n[r]);delete t.a[e],t.b--}}this.B=null},r.za=function(e,t,n,r){return this.c.add(String(e),t,!1,n,r)},r.Aa=function(e,t,n,r){return this.c.add(String(e),t,!0,n,r)};var ke=a.JSON.stringify;function Ae(e,t){this.c=e,this.f=t,this.b=0,this.a=null}function Ne(){this.b=this.a=null}Ae.prototype.get=function(){if(0<this.b){this.b--;var e=this.a;this.a=e.next,e.next=null}else e=this.c();return e};var Le,De=new Ae((function(){return new Me}),(function(e){e.reset()}));function Oe(){var e=je,t=null;return e.a&&(t=e.a,e.a=e.a.next,e.a||(e.b=null),t.next=null),t}function Me(){this.next=this.b=this.a=null}function Re(e){a.setTimeout((function(){throw e}),0)}function Pe(e,t){Le||function(){var e=a.Promise.resolve(void 0);Le=function(){e.then(Be)}}(),Fe||(Le(),Fe=!0),je.add(e,t)}Ne.prototype.add=function(e,t){var n=De.get();n.set(e,t),this.b?this.b.next=n:this.a=n,this.b=n},Me.prototype.set=function(e,t){this.a=e,this.b=t,this.next=null},Me.prototype.reset=function(){this.next=this.b=this.a=null};var Fe=!1,je=new Ne;function Be(){for(var e;e=Oe();){try{e.a.call(e.b)}catch(n){Re(n)}var t=De;t.f(e),100>t.b&&(t.b++,e.next=t.a,t.a=e)}Fe=!1}function Ve(e,t){xe.call(this),this.b=e||1,this.a=t||a,this.f=b(this.fb,this),this.g=_()}function We(e){e.ba=!1,e.L&&(e.a.clearTimeout(e.L),e.L=null)}function Ue(e,t,n){if("function"==h(e))n&&(e=b(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=b(e.handleEvent,e)}return 2147483647<Number(t)?-1:a.setTimeout(e,t||0)}function He(e,t,n){T.call(this),this.f=null!=n?b(e,n):e,this.c=t,this.b=b(this.$a,this),this.a=[]}function ze(e){e.U=Ue(e.b,e.c),e.f.apply(null,e.a)}function qe(e){T.call(this),this.b=e,this.a={}}C(Ve,xe),(r=Ve.prototype).ba=!1,r.L=null,r.fb=function(){if(this.ba){var e=_()-this.g;0<e&&e<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-e):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(We(this),this.start()))}},r.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=_())},r.G=function(){Ve.N.G.call(this),We(this),delete this.a},C(He,T),(r=He.prototype).ea=!1,r.U=null,r.Ta=function(e){this.a=arguments,this.U?this.ea=!0:ze(this)},r.G=function(){He.N.G.call(this),this.U&&(a.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},r.$a=function(){this.U=null,this.ea&&(this.ea=!1,ze(this))},C(qe,T);var Ke=[];function Ge(e,t,n,r){d(n)||(n&&(Ke[0]=n.toString()),n=Ke);for(var i=0;i<n.length;i++){var o=ve(t,n[i],r||e.handleEvent,!1,e.b||e);if(!o)break;e.a[o.key]=o}}function Qe(e){R(e.a,(function(e,t){this.a.hasOwnProperty(t)&&be(e)}),e),e.a={}}function $e(){}qe.prototype.G=function(){qe.N.G.call(this),Qe(this)},qe.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Ye=new xe;function Xe(e){oe.call(this,"serverreachability",e)}function Je(e){Ye.dispatchEvent(new Xe(Ye,e))}function Ze(e){oe.call(this,"statevent",e)}function et(e){Ye.dispatchEvent(new Ze(Ye,e))}function tt(e){oe.call(this,"timingevent",e)}function nt(e,t){if("function"!=h(e))throw Error("Fn must not be null and must be a function");return a.setTimeout((function(){e()}),t)}C(Xe,oe),C(Ze,oe),C(tt,oe);var rt={NO_ERROR:0,gb:1,nb:2,mb:3,jb:4,lb:5,ob:6,La:7,TIMEOUT:8,rb:9},it={ib:"complete",vb:"success",Ma:"error",La:"abort",tb:"ready",ub:"readystatechange",TIMEOUT:"timeout",pb:"incrementaldata",sb:"progress",kb:"downloadprogress",wb:"uploadprogress"};function ot(){}function at(e){var t;return(t=e.a)||(t=e.a={}),t}function st(){}ot.prototype.a=null;var ut,ct={OPEN:"a",hb:"b",Ma:"c",qb:"d"};function lt(){oe.call(this,"d")}function ht(){oe.call(this,"c")}function dt(){}function pt(e,t,n){this.g=e,this.W=t,this.V=n||1,this.I=new qe(this),this.O=ft,e=q?125:void 0,this.P=new Ve(e),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}C(lt,oe),C(ht,oe),C(dt,ot),ut=new dt;var ft=45e3,mt={},gt={};function vt(e,t,n){e.F=1,e.f=Ut(Rt(t)),e.l=n,e.H=!0,bt(e,null)}function yt(e,t,n,r){e.F=1,e.f=Ut(Rt(t)),e.l=null,e.H=n,bt(e,r)}function bt(e,t){e.v=_(),Ct(e),e.D=Rt(e.f),Wt(e.D,"t",e.V),e.A=0,e.a=e.g.$(e.g.Y()?t:null),0<e.J&&(e.B=new He(b(e.Ja,e,e.a),e.J)),Ge(e.I,e.a,"readystatechange",e.cb),t=e.h?P(e.h):{},e.l?(e.w||(e.w="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.a.ca(e.D,e.w,e.l,t)):(e.w="GET",e.a.ca(e.D,e.w,null,t)),Je(1)}function wt(e,t,n){for(var r=!0;!e.m&&e.A<n.length;){var i=_t(e,n);if(i==gt){4==t&&(e.c=4,et(14),r=!1);break}if(i==mt){e.c=4,et(15),r=!1;break}It(e,i)}4==t&&0==n.length&&(e.c=1,et(16),r=!1),e.b=e.b&&r,r||(xt(e),Et(e))}function _t(e,t){var n=e.A,r=t.indexOf("\n",n);return-1==r?gt:(n=Number(t.substring(n,r)),isNaN(n)?mt:(r+=1)+n>t.length?gt:(t=t.substr(r,n),e.A=r+n,t))}function Ct(e){e.R=_()+e.O,Tt(e,e.O)}function Tt(e,t){if(null!=e.i)throw Error("WatchDog timer not null");e.i=nt(b(e.ab,e),t)}function St(e){e.i&&(a.clearTimeout(e.i),e.i=null)}function Et(e){e.g.Ca()||e.m||e.g.na(e)}function xt(e){St(e);var t=e.B;t&&"function"==typeof t.la&&t.la(),e.B=null,We(e.P),Qe(e.I),e.a&&(t=e.a,e.a=null,t.abort(),t.la())}function It(e,t){try{e.g.Fa(e,t),Je(4)}catch(n){}}function kt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(p(e)||s(e))E(e,t,void 0);else{if(e.K&&"function"==typeof e.K)var n=e.K();else if(e.C&&"function"==typeof e.C)n=void 0;else if(p(e)||s(e)){n=[];for(var r=e.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,e)n[r++]=i;i=(r=function(e){if(e.C&&"function"==typeof e.C)return e.C();if(s(e))return e.split("");if(p(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length;for(var o=0;o<i;o++)t.call(void 0,r[o],n&&n[o],e)}}function At(e,t){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof At)for(n=e.K(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Nt(e,t){Dt(e.b,t)&&(delete e.b[t],e.c--,e.a.length>2*e.c&&Lt(e))}function Lt(e){if(e.c!=e.a.length){for(var t=0,n=0;t<e.a.length;){var r=e.a[t];Dt(e.b,r)&&(e.a[n++]=r),t++}e.a.length=n}if(e.c!=e.a.length){var i={};for(n=t=0;t<e.a.length;)Dt(i,r=e.a[t])||(e.a[n++]=r,i[r]=1),t++;e.a.length=n}}function Dt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(r=pt.prototype).setTimeout=function(e){this.O=e},r.cb=function(e){e=e.target;var t=this.B;t&&3==Rn(e)?t.Ta():this.Ja(e)},r.Ja=function(e){try{if(e==this.a)e:{var t=Rn(this.a),n=this.a.ya(),r=this.a.T();if(!(3>t||3==t&&!q&&!this.a.aa())){this.m||4!=t||7==n||Je(8==n||0>=r?3:2),St(this);var i=this.a.T();this.o=i;var o=this.a.aa();if(this.b=200==i){if(this.S&&!this.s){t:{if(this.a){var a=Pn(this.a,"X-HTTP-Initial-Response");if(a&&!k(a)){var s=a;break t}}s=null}if(!s){this.b=!1,this.c=3,et(12),xt(this),Et(this);break e}this.s=!0,It(this,s)}this.H?(wt(this,t,o),q&&this.b&&3==t&&(Ge(this.I,this.P,"tick",this.bb),this.P.start())):It(this,o),4==t&&xt(this),this.b&&!this.m&&(4==t?this.g.na(this):(this.b=!1,Ct(this)))}else 400==i&&0<o.indexOf("Unknown SID")?(this.c=3,et(12)):(this.c=0,et(13)),xt(this),Et(this)}}}catch(u){}},r.bb=function(){if(this.a){var e=Rn(this.a),t=this.a.aa();this.A<t.length&&(St(this),wt(this,e,t),this.b&&4!=e&&Ct(this))}},r.cancel=function(){this.m=!0,xt(this)},r.ab=function(){this.i=null;var e=_();0<=e-this.R?(2!=this.F&&(Je(3),et(17)),xt(this),this.c=2,Et(this)):Tt(this,this.R-e)},(r=At.prototype).C=function(){Lt(this);for(var e=[],t=0;t<this.a.length;t++)e.push(this.b[this.a[t]]);return e},r.K=function(){return Lt(this),this.a.concat()},r.get=function(e,t){return Dt(this.b,e)?this.b[e]:t},r.set=function(e,t){Dt(this.b,e)||(this.c++,this.a.push(e)),this.b[e]=t},r.forEach=function(e,t){for(var n=this.K(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);e.call(t,o,i,this)}};var Ot=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Mt(e,t){var n;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,e instanceof Mt?(this.h=void 0!==t?t:e.h,Pt(this,e.f),this.j=e.j,Ft(this,e.b),jt(this,e.i),this.a=e.a,Bt(this,nn(e.c)),this.g=e.g):e&&(n=String(e).match(Ot))?(this.h=!!t,Pt(this,n[1]||"",!0),this.j=Ht(n[2]||""),Ft(this,n[3]||"",!0),jt(this,n[4]),this.a=Ht(n[5]||"",!0),Bt(this,n[6]||"",!0),this.g=Ht(n[7]||"")):(this.h=!!t,this.c=new Xt(null,this.h))}function Rt(e){return new Mt(e)}function Pt(e,t,n){e.f=n?Ht(t,!0):t,e.f&&(e.f=e.f.replace(/:$/,""))}function Ft(e,t,n){e.b=n?Ht(t,!0):t}function jt(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.i=t}else e.i=null}function Bt(e,t,n){t instanceof Xt?(e.c=t,function(e,t){t&&!e.f&&(Jt(e),e.c=null,e.a.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(Zt(this,t),tn(this,n,e))}),e)),e.f=t}(e.c,e.h)):(n||(t=zt(t,$t)),e.c=new Xt(t,e.h))}function Vt(e,t,n){e.c.set(t,n)}function Wt(e,t,n){d(n)||(n=[String(n)]),tn(e.c,t,n)}function Ut(e){return Vt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^_()).toString(36)),e}function Ht(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function zt(e,t,n){return s(e)?(e=encodeURI(e).replace(t,qt),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function qt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Mt.prototype.toString=function(){var e=[],t=this.f;t&&e.push(zt(t,Kt,!0),":");var n=this.b;return(n||"file"==t)&&(e.push("//"),(t=this.j)&&e.push(zt(t,Kt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&e.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&e.push("/"),e.push(zt(n,"/"==n.charAt(0)?Qt:Gt,!0))),(n=this.c.toString())&&e.push("?",n),(n=this.g)&&e.push("#",zt(n,Yt)),e.join("")},Mt.prototype.resolve=function(e){var t=Rt(this),n=!!e.f;n?Pt(t,e.f):n=!!e.j,n?t.j=e.j:n=!!e.b,n?Ft(t,e.b):n=null!=e.i;var r=e.a;if(n)jt(t,e.i);else if(n=!!e.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var i=t.a.lastIndexOf("/");-1!=i&&(r=t.a.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(L(i,"./")||L(i,"/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],a=0;a<i.length;){var s=i[a++];"."==s?r&&a==i.length&&o.push(""):".."==s?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&a==i.length&&o.push("")):(o.push(s),r=!0)}r=o.join("/")}else r=i}return n?t.a=r:n=""!==e.c.toString(),n?Bt(t,nn(e.c)):n=!!e.g,n&&(t.g=e.g),t};var Kt=/[#\/\?@]/g,Gt=/[#\?:]/g,Qt=/[#\?]/g,$t=/[#\?@]/g,Yt=/#/g;function Xt(e,t){this.b=this.a=null,this.c=e||null,this.f=!!t}function Jt(e){e.a||(e.a=new At,e.b=0,e.c&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var o=e[n].substring(0,r);i=e[n].substring(r+1)}else o=e[n];t(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.c,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function Zt(e,t){Jt(e),t=rn(e,t),Dt(e.a.b,t)&&(e.c=null,e.b-=e.a.get(t).length,Nt(e.a,t))}function en(e,t){return Jt(e),t=rn(e,t),Dt(e.a.b,t)}function tn(e,t,n){Zt(e,t),0<n.length&&(e.c=null,e.a.set(rn(e,t),I(n)),e.b+=n.length)}function nn(e){var t=new Xt;return t.c=e.c,e.a&&(t.a=new At(e.a),t.b=e.b),t}function rn(e,t){return t=String(t),e.f&&(t=t.toLowerCase()),t}function on(e){this.a=e,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function an(e){var t=e.a.F.a;if(null!=t)et(4),t?(et(10),Qn(e.a,e,!1)):(et(11),Qn(e.a,e,!0));else{e.b=new pt(e,void 0,void 0),e.b.h=e.h,t=Zn(t=e.a,t.Y()?e.f:null,e.i),et(4),Wt(t,"TYPE","xmlhttp");var n=e.a.j,r=e.a.I;n&&r&&Vt(t,n,r),yt(e.b,t,!1,e.f)}}function sn(){this.a=this.b=null}function un(){this.a=new At}function cn(e){var t=typeof e;return"object"==t&&e||"function"==t?"o"+(e[m]||(e[m]=++g)):t.charAt(0)+e}function ln(e,t){this.b=e,this.a=t}function hn(e){this.g=e||dn,a.PerformanceNavigationTiming?e=0<(e=a.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):e=!!(a.ka&&a.ka.Da&&a.ka.Da()&&a.ka.Da().yb),this.f=e?this.g:1,this.a=null,1<this.f&&(this.a=new un),this.b=null,this.c=[]}(r=Xt.prototype).add=function(e,t){Jt(this),this.c=null,e=rn(this,e);var n=this.a.get(e);return n||this.a.set(e,n=[]),n.push(t),this.b+=1,this},r.forEach=function(e,t){Jt(this),this.a.forEach((function(n,r){E(n,(function(n){e.call(t,n,r,this)}),this)}),this)},r.K=function(){Jt(this);for(var e=this.a.C(),t=this.a.K(),n=[],r=0;r<t.length;r++)for(var i=e[r],o=0;o<i.length;o++)n.push(t[r]);return n},r.C=function(e){Jt(this);var t=[];if(s(e))en(this,e)&&(t=x(t,this.a.get(rn(this,e))));else{e=this.a.C();for(var n=0;n<e.length;n++)t=x(t,e[n])}return t},r.set=function(e,t){return Jt(this),this.c=null,en(this,e=rn(this,e))&&(this.b-=this.a.get(e).length),this.a.set(e,[t]),this.b+=1,this},r.get=function(e,t){return e&&0<(e=this.C(e)).length?String(e[0]):t},r.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var e=[],t=this.a.K(),n=0;n<t.length;n++){var r=t[n],i=encodeURIComponent(String(r));r=this.C(r);for(var o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),e.push(a)}}return this.c=e.join("&")},C((function(){}),(function(){})),(r=on.prototype).M=null,r.$=function(e){return this.a.$(e)},r.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},r.Ca=function(){return!1},r.Fa=function(e,t){if(this.c=e.o,0==this.M){if(!this.a.o&&(e=e.a)){var n=Pn(e,"X-Client-Wire-Protocol");this.l=n||null,this.a.j&&(e=Pn(e,"X-HTTP-Session-Id"))&&(this.a.I=e)}if(t){try{var r=this.a.ja.a.parse(t)}catch(i){return(t=this.a).m=this.c,void Xn(t,2)}this.f=r[0]}else(t=this.a).m=this.c,Xn(t,2)}else 1==this.M&&(this.g?et(6):"11111"==t?(et(5),this.g=!0,(!H||10<=Number(J))&&(this.c=200,this.b.cancel(),et(11),Qn(this.a,this,!0))):(et(7),this.g=!1))},r.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,an(this)):1==this.M&&(this.g?(et(11),Qn(this.a,this,!0)):(et(10),Qn(this.a,this,!1)));else{0==this.M?et(8):1==this.M&&et(9);var e=this.a;e.m=this.c,Xn(e,2)}},r.Y=function(){return this.a.Y()},r.ma=function(){return this.a.ma()},un.prototype.add=function(e){this.a.set(cn(e),e)},un.prototype.C=function(){return this.a.C()};var dn=10;function pn(e,t){!e.a&&(L(t,"spdy")||L(t,"quic")||L(t,"h2"))&&(e.f=e.g,e.a=new un,e.b&&(vn(e,e.b),e.b=null))}function fn(e){return!!e.b||!!e.a&&e.a.a.c>=e.f}function mn(e){return e.b?1:e.a?e.a.a.c:0}function gn(e,t){return e.b?e=e.b==t:e.a?(t=cn(t),e=Dt(e.a.a.b,t)):e=!1,e}function vn(e,t){e.a?e.a.add(t):e.b=t}function yn(e,t){var n;e.b&&e.b==t?e.b=null:((n=e.a)&&(n=cn(t),n=Dt(e.a.a.b,n)),n&&Nt(e.a.a,cn(t)))}function bn(e){if(null!=e.b)return e.c.concat(e.b.j);if(null!=e.a&&0!=e.a.a.c){var t=e.c;return E(e.a.C(),(function(e){t=t.concat(e.j)})),t}return I(e.c)}function wn(){}function _n(){this.a=new wn}function Cn(e,t,n){var r=n||"";try{kt(e,(function(e,n){var i=e;f(e)&&(i=ke(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(i){throw t.push(r+"type="+encodeURIComponent("_badmap")),i}}function Tn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(o){}}hn.prototype.cancel=function(){this.c=bn(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(E(this.a.C(),(function(e){e.cancel()})),function(e){e.b={},e.a.length=0,e.c=0}(this.a.a))},wn.prototype.stringify=function(e){return a.JSON.stringify(e,void 0)},wn.prototype.parse=function(e){return a.JSON.parse(e,void 0)};var Sn=a.JSON.parse;function En(e){xe.call(this),this.headers=new At,this.H=e||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=xn,this.D=this.F=!1}C(En,xe);var xn="",In=/^https?$/i,kn=["POST","PUT"];function An(e){return"content-type"==e.toLowerCase()}function Nn(e,t){e.b=!1,e.a&&(e.g=!0,e.a.abort(),e.g=!1),e.f=t,e.h=5,Ln(e),On(e)}function Ln(e){e.v||(e.v=!0,e.dispatchEvent("complete"),e.dispatchEvent("error"))}function Dn(e){if(e.b&&void 0!==o&&(!e.s[1]||4!=Rn(e)||2!=e.T()))if(e.l&&4==Rn(e))Ue(e.Ea,0,e);else if(e.dispatchEvent("readystatechange"),4==Rn(e)){e.b=!1;try{var t,n=e.T();e:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break e;default:r=!1}if(!(t=r)){var i;if(i=0===n){var s=String(e.A).match(Ot)[1]||null;if(!s&&a.self&&a.self.location){var u=a.self.location.protocol;s=u.substr(0,u.length-1)}i=!In.test(s?s.toLowerCase():"")}t=i}if(t)e.dispatchEvent("complete"),e.dispatchEvent("success");else{e.h=6;try{var c=2<Rn(e)?e.a.statusText:""}catch(l){c=""}e.f=c+" ["+e.T()+"]",Ln(e)}}finally{On(e)}}}function On(e,t){if(e.a){Mn(e);var n=e.a,r=e.s[0]?l:null;e.a=null,e.s=null,t||e.dispatchEvent("ready");try{n.onreadystatechange=r}catch(i){}}}function Mn(e){e.a&&e.D&&(e.a.ontimeout=null),e.m&&(a.clearTimeout(e.m),e.m=null)}function Rn(e){return e.a?e.a.readyState:0}function Pn(e,t){return e.a?e.a.getResponseHeader(t):null}function Fn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}if(r)return e;if(n=function(e){var t="";return R(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}(n),s(e)){if(t=encodeURIComponent(String(t)),t+=n=null!=n?"="+encodeURIComponent(String(n)):""){if(0>(n=e.indexOf("#"))&&(n=e.length),0>(r=e.indexOf("?"))||r>n){r=n;var i=""}else i=e.substring(r+1,n);n=(e=[e.substr(0,r),i,e.substr(n)])[1],e[1]=t?n?n+"&"+t:t:n,e=e[0]+(e[1]?"?"+e[1]:"")+e[2]}return e}return Vt(e,t,n),e}function jn(e){this.f=[],this.F=new sn,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Qa=this.P=0,this.Oa=!!c("internalChannelParams.failFast",e),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Na=c("internalChannelParams.baseRetryDelayMs",e)||5e3,this.Ra=c("internalChannelParams.retryDelaySeedMs",e)||1e4,this.Pa=c("internalChannelParams.forwardChannelMaxRetries",e)||2,this.qa=c("internalChannelParams.forwardChannelRequestTimeoutMs",e)||2e4,this.Ka=e&&e.zb||void 0,this.D=void 0,this.R=e&&e.supportsCrossDomainXhr||!1,this.H="",this.b=new hn(e&&e.concurrentRequestLimit),this.ja=new _n,this.o=!e||void 0===e.backgroundChannelTest||e.backgroundChannelTest,(this.W=e&&e.fastHandshake||!1)&&!this.o&&(this.o=!0),e&&e.forceLongPolling&&(this.oa=!1),this.fa=void 0}function Bn(e){if(Vn(e),3==e.u){var t=e.P++,n=Rt(e.B);Vt(n,"SID",e.H),Vt(n,"RID",t),Vt(n,"TYPE","terminate"),zn(e,n),(t=new pt(e,t,void 0)).F=2,t.f=Ut(Rt(n)),n=!1,a.navigator&&a.navigator.sendBeacon&&(n=a.navigator.sendBeacon(t.f.toString(),"")),!n&&a.Image&&((new Image).src=t.f,n=!0),n||(t.a=t.g.$(null),t.a.ca(t.f)),t.v=_(),Ct(t)}Jn(e)}function Vn(e){e.w&&(e.w.abort(),e.w=null),e.a&&(e.a.cancel(),e.a=null),e.l&&(a.clearTimeout(e.l),e.l=null),$n(e),e.b.cancel(),e.h&&(u(e.h)&&a.clearTimeout(e.h),e.h=null)}function Wn(e,t){e.f.push(new ln(e.Qa++,t)),3==e.u&&Un(e)}function Un(e){fn(e.b)||e.h||(e.h=!0,Pe(e.Ha,e),e.A=0)}function Hn(e,t){var n;n=t?t.W:e.P++;var r=Rt(e.B);Vt(r,"SID",e.H),Vt(r,"RID",n),Vt(r,"AID",e.O),zn(e,r),e.g&&e.i&&Fn(r,e.g,e.i),n=new pt(e,n,e.A+1),null===e.g&&(n.h=e.i),t&&(e.f=t.j.concat(e.f)),t=qn(e,n,1e3),n.setTimeout(Math.round(.5*e.qa)+Math.round(.5*e.qa*Math.random())),vn(e.b,n),vt(n,r,t)}function zn(e,t){e.c&&kt({},(function(e,n){Vt(t,n,e)}))}function qn(e,t,n){n=Math.min(e.f.length,n);var r=e.c?b(e.c.Sa,e.c,e):null;e:for(var i=e.f,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,l=i[u].a;if(0>(c-=o))o=Math.max(0,i[u].b-100),s=!1;else try{Cn(l,a,"req"+c+"_")}catch(h){r&&r(l)}}if(s){r=a.join("&");break e}}return e=e.f.splice(0,n),t.j=e,r}function Kn(e){e.a||e.l||(e.S=1,Pe(e.Ga,e),e.v=0)}function Gn(e){return!(e.a||e.l||3<=e.v)&&(e.S++,e.l=nt(b(e.Ga,e),Yn(e,e.v)),e.v++,!0)}function Qn(e,t,n){var r=t.l;r&&pn(e.b,r),e.ia=e.oa&&n,e.m=t.c,e.B=Zn(e,null,e.ha),Un(e)}function $n(e){null!=e.s&&(a.clearTimeout(e.s),e.s=null)}function Yn(e,t){var n=e.Na+Math.floor(Math.random()*e.Ra);return e.ma()||(n*=2),n*t}function Xn(e,t){if(2==t){var n=null;e.c&&(n=null);var r=b(e.eb,e);n||(n=new Mt("//www.google.com/images/cleardot.gif"),a.location&&"http"==a.location.protocol||Pt(n,"https"),Ut(n)),function(e,t){var n=new $e;if(a.Image){var r=new Image;r.onload=w(Tn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=w(Tn,n,r,"TestLoadImage: error",!1,t),r.onabort=w(Tn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=w(Tn,n,r,"TestLoadImage: timeout",!1,t),a.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}(n.toString(),r)}else et(2);e.u=0,e.c&&e.c.ta(t),Jn(e),Vn(e)}function Jn(e){e.u=0,e.m=-1,e.c&&(0==bn(e.b).length&&0==e.f.length||(e.b.c.length=0,I(e.f),e.f.length=0),e.c.sa())}function Zn(e,t,n){var r=function(e){return e instanceof Mt?Rt(e):new Mt(e,void 0)}(n);if(""!=r.b)t&&Ft(r,t+"."+r.b),jt(r,r.i);else{var i,o=a.location;i=t?t+"."+o.hostname:o.hostname,r=function(e,t,n,r){var i=new Mt(null,void 0);return e&&Pt(i,e),t&&Ft(i,t),n&&jt(i,n),r&&(i.a=r),i}(o.protocol,i,+o.port,n)}return e.V&&R(e.V,(function(e,t){Vt(r,t,e)})),t=e.j,n=e.I,t&&n&&Vt(r,t,n),Vt(r,"VER",e.wa),zn(e,r),r}function er(){}function tr(){if(H&&!(10<=Number(J)))throw Error("Environmental error: no available transport.")}function nr(e,t){xe.call(this),this.a=new jn(t),this.g=e,this.m=t&&t.testUrl?t.testUrl:function(e){for(var t=arguments[0],n=1;n<arguments.length;n++){var r,i=arguments[n];if(0==i.lastIndexOf("/",0))t=i;else(r=""==t)||(r=0<=(r=t.length-1)&&t.indexOf("/",r)==r),t+=r?i:"/"+i}return t}(this.g,"test"),this.b=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.a.i=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.xa&&(e?e["X-WebChannel-Client-Profile"]=t.xa:e={"X-WebChannel-Client-Profile":t.xa}),this.a.J=e,(e=t&&t.httpHeadersOverwriteParam)&&!k(e)&&(this.a.g=e),this.l=t&&t.supportsCrossDomainXhr||!1,this.h=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!k(t)&&(this.a.j=t,null!==(e=this.b)&&t in e&&(t in(e=this.b)&&delete e[t])),this.f=new or(this)}function rr(e){lt.call(this);var t=e.__sm__;if(t){e:{for(var n in t){e=n;break e}e=void 0}(this.c=e)?(e=this.c,this.data=null!==t&&e in t?t[e]:void 0):this.data=t}else this.data=e}function ir(){ht.call(this),this.status=1}function or(e){this.a=e}(r=En.prototype).ca=function(e,t,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+e);t=t?t.toUpperCase():"GET",this.A=e,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?at(this.H):at(ut),this.a.onreadystatechange=b(this.Ea,this);try{this.w=!0,this.a.open(t,String(e),!0),this.w=!1}catch(o){return void Nn(this,o)}e=n||"";var i=new At(this.headers);r&&kt(r,(function(e,t){i.set(t,e)})),r=function(e){e:{for(var t=An,n=e.length,r=s(e)?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e)){t=i;break e}t=-1}return 0>t?null:s(e)?e.charAt(t):e[t]}(i.K()),n=a.FormData&&e instanceof a.FormData,!(0<=S(kn,t))||r||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach((function(e,t){this.a.setRequestHeader(t,e)}),this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Mn(this),0<this.o&&((this.D=function(e){return H&&ee(9)&&u(e.timeout)&&void 0!==e.ontimeout}(this.a))?(this.a.timeout=this.o,this.a.ontimeout=b(this.Ba,this)):this.m=Ue(this.Ba,this.o,this)),this.l=!0,this.a.send(e),this.l=!1}catch(o){Nn(this,o)}},r.Ba=function(){void 0!==o&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},r.abort=function(e){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=e||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),On(this))},r.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),On(this,!0)),En.N.G.call(this)},r.Ea=function(){this.j||(this.w||this.l||this.g?Dn(this):this.Za())},r.Za=function(){Dn(this)},r.T=function(){try{return 2<Rn(this)?this.a.status:-1}catch(W){return-1}},r.aa=function(){try{return this.a?this.a.responseText:""}catch(W){return""}},r.Ua=function(e){if(this.a){var t=this.a.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),Sn(t)}},r.ya=function(){return this.h},r.Xa=function(){return s(this.f)?this.f:String(this.f)},(r=jn.prototype).wa=8,r.u=1,r.Ca=function(){return 0==this.u},r.Ha=function(e){if(this.h)if(this.h=null,1==this.u){if(!e){this.P=Math.floor(1e5*Math.random());var t,n=new pt(this,e=this.P++,void 0),r=this.i;if(this.J&&(r?j(r=P(r),this.J):r=this.J),null===this.g&&(n.h=r),this.W)e:{for(var i=t=0;i<this.f.length;i++){var o=this.f[i];if(void 0===(o="__data__"in o.a&&s(o=o.a.__data__)?o.length:void 0))break;if(4096<(t+=o)){t=i;break e}if(4096===t||i===this.f.length-1){t=i+1;break e}}t=1e3}else t=1e3;t=qn(this,n,t),Vt(i=Rt(this.B),"RID",e),Vt(i,"CVER",22),this.o&&this.j&&Vt(i,"X-HTTP-Session-Id",this.j),zn(this,i),this.g&&r&&Fn(i,this.g,r),vn(this.b,n),this.W?(Vt(i,"$req",t),Vt(i,"SID","null"),n.S=!0,vt(n,i,null)):vt(n,i,t),this.u=2}}else 3==this.u&&(e?Hn(this,e):0==this.f.length||fn(this.b)||Hn(this))},r.Ga=function(){this.l=null,this.a=new pt(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var e=Rt(this.pa);Vt(e,"RID","rpc"),Vt(e,"SID",this.H),Vt(e,"CI",this.ia?"0":"1"),Vt(e,"AID",this.O),zn(this,e),Vt(e,"TYPE","xmlhttp"),this.g&&this.i&&Fn(e,this.g,this.i),this.D&&this.a.setTimeout(this.D),yt(this.a,e,!0,this.ga)},r.Fa=function(e,t){if(0!=this.u&&(this.a==e||gn(this.b,e)))if(this.m=e.o,!e.s&&gn(this.b,e)&&3==this.u){try{var n=this.ja.a.parse(t)}catch(o){n=null}if(d(n)&&3==n.length){if(0==(t=n)[0]){e:if(!this.l){if(this.a){if(!(this.a.v+3e3<e.v))break e;$n(this),this.a.cancel(),this.a=null}Gn(this),et(18)}}else this.ra=t[1],0<this.ra-this.O&&37500>t[2]&&this.ia&&0==this.v&&!this.s&&(this.s=nt(b(this.Ya,this),6e3));if(1>=mn(this.b)&&this.fa){try{this.fa()}catch(o){}this.fa=void 0}}else Xn(this,11)}else if((e.s||this.a==e)&&$n(this),!k(t))for(t=n=this.ja.a.parse(t),n=0;n<t.length;n++){var r=t[n];if(this.O=r[0],r=r[1],2==this.u)if("c"==r[0]){this.H=r[1],this.ga=r[2];var i=r[3];null!=i&&(this.wa=i),null!=(r=r[5])&&u(r)&&0<r&&(this.D=1.5*r),this.o&&(r=e.a)&&((i=Pn(r,"X-Client-Wire-Protocol"))&&pn(this.b,i),this.j&&(r=Pn(r,"X-HTTP-Session-Id")))&&(this.I=r,Vt(this.B,this.j,r)),this.u=3,this.c&&this.c.va(),r=e,this.pa=Zn(this,this.Y()?this.ga:null,this.ha),r.s?(yn(this.b,r),(i=this.D)&&r.setTimeout(i),r.i&&(St(r),Ct(r)),this.a=r):Kn(this),0<this.f.length&&Un(this)}else"stop"!=r[0]&&"close"!=r[0]||Xn(this,7);else 3==this.u&&("stop"==r[0]||"close"==r[0]?"stop"==r[0]?Xn(this,7):Bn(this):"noop"!=r[0]&&this.c&&this.c.ua(r),this.v=0)}},r.Ya=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,Gn(this),et(19))},r.na=function(e){var t=null;if(this.a==e){$n(this),this.a=null;var n=2}else{if(!gn(this.b,e))return;t=e.j,yn(this.b,e),n=1}if(this.m=e.o,0!=this.u)if(e.b)1==n?(t=_()-e.v,Ye.dispatchEvent(new tt(Ye,e.l?e.l.length:0,t,this.A)),Un(this)):Kn(this);else{var r=e.c;if(3==r||0==r&&0<this.m||!(1==n&&function(e,t){return!(mn(e.b)>=e.b.f-(e.h?1:0))&&(e.h?(e.f=t.j.concat(e.f),!0):!(1==e.u||2==e.u||e.A>=(e.Oa?0:e.Pa))&&(e.h=nt(b(e.Ha,e,t),Yn(e,e.A)),e.A++,!0))}(this,e)||2==n&&Gn(this)))switch(t&&0<t.length&&(e=this.b,e.c=e.c.concat(t)),r){case 1:Xn(this,5);break;case 4:Xn(this,10);break;case 3:Xn(this,6);break;default:Xn(this,2)}}},r.eb=function(e){et(e?2:1)},r.$=function(e){if(e&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(e=new En(this.Ka)).F=this.R,e},r.ma=function(){return!!this.c&&!0},r.Y=function(){return this.R},(r=er.prototype).va=function(){},r.ua=function(){},r.ta=function(){},r.sa=function(){},r.Sa=function(){},tr.prototype.a=function(e,t){return new nr(e,t)},C(nr,xe),(r=nr.prototype).addEventListener=function(e,t,n,r){nr.N.addEventListener.call(this,e,t,n,r)},r.removeEventListener=function(e,t,n,r){nr.N.removeEventListener.call(this,e,t,n,r)},r.Va=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var e=this.a,t=this.m,n=this.g,r=this.b||void 0;et(0),e.ha=n,e.V=r||{},e.o&&(e.F.b=[],e.F.a=!1),e.w=new on(e),null===e.g&&(e.w.h=e.i),n=t,e.g&&e.i&&(n=Fn(t,e.g,e.i)),(e=e.w).i=n,t=Zn(e.a,null,e.i),et(3),null!=(n=e.a.F.b)?(e.f=n[0],e.M=1,an(e)):(Wt(t,"MODE","init"),!e.a.o&&e.a.j&&Wt(t,"X-HTTP-Session-Id",e.a.j),e.b=new pt(e,void 0,void 0),e.b.h=e.h,yt(e.b,t,!1,null),e.M=0)},r.close=function(){Bn(this.a)},r.Wa=function(e){if(s(e)){var t={};t.__data__=e,Wn(this.a,t)}else this.h?((t={}).__data__=ke(e),Wn(this.a,t)):Wn(this.a,e)},r.G=function(){this.a.c=null,delete this.f,Bn(this.a),delete this.a,nr.N.G.call(this)},C(rr,lt),C(ir,ht),C(or,er),or.prototype.va=function(){this.a.dispatchEvent("a")},or.prototype.ua=function(e){this.a.dispatchEvent(new rr(e))},or.prototype.ta=function(e){this.a.dispatchEvent(new ir(e))},or.prototype.sa=function(){this.a.dispatchEvent("b")};var ar=w((function(e,t){function n(){}n.prototype=e.prototype;var r=new n;return e.apply(r,Array.prototype.slice.call(arguments,1)),r}),tr);tr.prototype.createWebChannel=tr.prototype.a,nr.prototype.send=nr.prototype.Wa,nr.prototype.open=nr.prototype.Va,nr.prototype.close=nr.prototype.close,rt.NO_ERROR=0,rt.TIMEOUT=8,rt.HTTP_ERROR=6,it.COMPLETE="complete",st.EventType=ct,ct.OPEN="a",ct.CLOSE="b",ct.ERROR="c",ct.MESSAGE="d",xe.prototype.listen=xe.prototype.za,En.prototype.listenOnce=En.prototype.Aa,En.prototype.getLastError=En.prototype.Xa,En.prototype.getLastErrorCode=En.prototype.ya,En.prototype.getStatus=En.prototype.T,En.prototype.getResponseJson=En.prototype.Ua,En.prototype.getResponseText=En.prototype.aa,En.prototype.send=En.prototype.ca;var sr={createWebChannelTransport:ar,ErrorCode:rt,EventType:it,WebChannel:st,XhrIo:En},ur=sr.createWebChannelTransport,cr=sr.ErrorCode,lr=sr.EventType,hr=sr.WebChannel,dr=sr.XhrIo;t.default=sr}.call(this,n("yLpj"))},y8fO:function(e,t){e.exports=/[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/},ys0W:function(e,t,n){var r=n("QPJK"),i=n("2mBY"),o=n("5SQf"),a=n("BnbX").f;e.exports=function(e){return function(t){for(var n,s=o(t),u=i(s),c=u.length,l=0,h=[];c>l;)n=u[l++],r&&!a.call(s,n)||h.push(e?[n,s[n]]:s[n]);return h}}},"zEh/":function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));n("6kNP"),n("8npG");function r(e,t,n,r,i){return new Promise((function(o,a){console.log(r);var s=new XMLHttpRequest,u=new FormData;u.append("file",e.files[0]),s.open("POST","https://api.cloudinary.com/v1_1/hvioxpubt/upload?upload_preset=ml_default",!0),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.upload.onprogress=function(e){var t=Math.ceil(e.loaded/e.total*100);i&&i(t)},s.onreadystatechange=function(e){if(4===s.readyState&&200===s.status){var n=JSON.parse(s.responseText);t(n),o()}},u.append("tags","browser_upload"),n&&u.append("folder",n),r&&u.append("public_id",r),s.send(u),s.onerror=a}))}},zTTH:function(e,t,n){"use strict";var r=n("P8UN"),i=n("Wadk")(6),o="findIndex",a=!0;o in[]&&Array(1)[o]((function(){a=!1})),r(r.P+r.F*a,"Array",{findIndex:function(e){return i(this,e,arguments.length>1?arguments[1]:void 0)}}),n("Dq1/")(o)},zVF4:function(e,t,n){"use strict";(function(e){n("AqHK"),n("n7j8"),n("PZd/"),n("JHok"),n("HQhv"),n("sC2a"),n("rzGZ"),n("Dq+y"),n("Ggvi"),n("LagC"),n("pJf4"),n("q8oJ"),n("C9fy"),n("6kNP"),n("8npG"),n("MIFh"),n("R48M"),Object.defineProperty(t,"__esModule",{value:!0});var r=n("mrSG"),i={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},o=function(e,t){if(!e)throw a(t)},a=function(e){return new Error("Firebase Database ("+i.SDK_VERSION+") INTERNAL ASSERT FAILED: "+e)},s=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},u={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],i=0;i<e.length;i+=3){var o=e[i],a=i+1<e.length,s=a?e[i+1]:0,u=i+2<e.length,c=u?e[i+2]:0,l=o>>2,h=(3&o)<<4|s>>4,d=(15&s)<<2|c>>6,p=63&c;u||(p=64,a||(d=64)),r.push(n[l],n[h],n[d],n[p])}return r.join("")},encodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){for(var t=[],n=0,r=0;n<e.length;){var i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){var o=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&o)}else if(i>239&&i<365){var a=((7&i)<<18|(63&(o=e[n++]))<<12|(63&(s=e[n++]))<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(a>>10)),t[r++]=String.fromCharCode(56320+(1023&a))}else{o=e[n++];var s=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&s)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray:function(e,t){this.init_();for(var n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],i=0;i<e.length;){var o=n[e.charAt(i++)],a=i<e.length?n[e.charAt(i)]:0,s=++i<e.length?n[e.charAt(i)]:64,u=++i<e.length?n[e.charAt(i)]:64;if(++i,null==o||null==a||null==s||null==u)throw Error();var c=o<<2|a>>4;if(r.push(c),64!==s){var l=a<<4&240|s>>2;if(r.push(l),64!==u){var h=s<<6&192|u;r.push(h)}}}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},c=function(e){try{return u.decodeString(e,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};function l(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:return new Date(t.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(var n in t)t.hasOwnProperty(n)&&(e[n]=l(e[n],t[n]));return e}var h=function(){function e(){var e=this;this.reject=function(){},this.resolve=function(){},this.promise=new Promise((function(t,n){e.resolve=t,e.reject=n}))}return e.prototype.wrapCallback=function(e){var t=this;return function(n,r){n?t.reject(n):t.resolve(r),"function"==typeof e&&(t.promise.catch((function(){})),1===e.length?e(n):e(n,r))}},e}();function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var p="FirebaseError",f=function(e){function t(n,r){var i=e.call(this,r)||this;return i.code=n,i.name=p,Object.setPrototypeOf(i,t.prototype),Error.captureStackTrace&&Error.captureStackTrace(i,m.prototype.create),i}return r.__extends(t,e),t}(Error),m=function(){function e(e,t,n){this.service=e,this.serviceName=t,this.errors=n}return e.prototype.create=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=t[0]||{},i=this.service+"/"+e,o=this.errors[e],a=o?g(o,r):"Error",s=this.serviceName+": "+a+" ("+i+").",u=new f(i,s),c=0,l=Object.keys(r);c<l.length;c++){var h=l[c];"_"!==h.slice(-1)&&(h in u&&console.warn('Overwriting FirebaseError base field "'+h+'" can cause unexpected behavior.'),u[h]=r[h])}return u},e}();function g(e,t){return e.replace(v,(function(e,n){var r=t[n];return null!=r?r.toString():"<"+n+"?>"}))}var v=/\{\$([^}]+)}/g;function y(e){return JSON.parse(e)}var b=function(e){var t={},n={},r={},i="";try{var o=e.split(".");t=y(c(o[0])||""),n=y(c(o[1])||""),i=o[2],r=n.d||{},delete n.d}catch(a){}return{header:t,claims:n,data:r,signature:i}};var w=function(){function e(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(var e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}return e.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},e.prototype.compress_=function(e,t){t||(t=0);var n=this.W_;if("string"==typeof e)for(var r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(r=16;r<80;r++){var i=n[r-3]^n[r-8]^n[r-14]^n[r-16];n[r]=4294967295&(i<<1|i>>>31)}var o,a,s=this.chain_[0],u=this.chain_[1],c=this.chain_[2],l=this.chain_[3],h=this.chain_[4];for(r=0;r<80;r++){r<40?r<20?(o=l^u&(c^l),a=1518500249):(o=u^c^l,a=1859775393):r<60?(o=u&c|l&(u|c),a=2400959708):(o=u^c^l,a=3395469782);i=(s<<5|s>>>27)+o+h+a+n[r]&4294967295;h=l,l=c,c=4294967295&(u<<30|u>>>2),u=s,s=i}this.chain_[0]=this.chain_[0]+s&4294967295,this.chain_[1]=this.chain_[1]+u&4294967295,this.chain_[2]=this.chain_[2]+c&4294967295,this.chain_[3]=this.chain_[3]+l&4294967295,this.chain_[4]=this.chain_[4]+h&4294967295},e.prototype.update=function(e,t){if(null!=e){void 0===t&&(t=e.length);for(var n=t-this.blockSize,r=0,i=this.buf_,o=this.inbuf_;r<t;){if(0===o)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if("string"==typeof e){for(;r<t;)if(i[o]=e.charCodeAt(r),++r,++o===this.blockSize){this.compress_(i),o=0;break}}else for(;r<t;)if(i[o]=e[r],++r,++o===this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=t}},e.prototype.digest=function(){var e=[],t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var n=this.blockSize-1;n>=56;n--)this.buf_[n]=255&t,t/=256;this.compress_(this.buf_);var r=0;for(n=0;n<5;n++)for(var i=24;i>=0;i-=8)e[r]=this.chain_[n]>>i&255,++r;return e},e}();var _=function(){function e(e,t){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then((function(){e(n)})).catch((function(e){n.error(e)}))}return e.prototype.next=function(e){this.forEachObserver((function(t){t.next(e)}))},e.prototype.error=function(e){this.forEachObserver((function(t){t.error(e)})),this.close(e)},e.prototype.complete=function(){this.forEachObserver((function(e){e.complete()})),this.close()},e.prototype.subscribe=function(e,t,n){var r,i=this;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");void 0===(r=function(e,t){if("object"!=typeof e||null===e)return!1;for(var n=0,r=t;n<r.length;n++){var i=r[n];if(i in e&&"function"==typeof e[i])return!0}return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:n}).next&&(r.next=C),void 0===r.error&&(r.error=C),void 0===r.complete&&(r.complete=C);var o=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((function(){try{i.finalError?r.error(i.finalError):r.complete()}catch(e){}})),this.observers.push(r),o},e.prototype.unsubscribeOne=function(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},e.prototype.forEachObserver=function(e){if(!this.finalized)for(var t=0;t<this.observers.length;t++)this.sendOne(t,e)},e.prototype.sendOne=function(e,t){var n=this;this.task.then((function(){if(void 0!==n.observers&&void 0!==n.observers[e])try{t(n.observers[e])}catch(r){"undefined"!=typeof console&&console.error&&console.error(r)}}))},e.prototype.close=function(e){var t=this;this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then((function(){t.observers=void 0,t.onNoObservers=void 0})))},e}();function C(){}function T(e,t,n){var r="";switch(t){case 1:r=n?"first":"First";break;case 2:r=n?"second":"Second";break;case 3:r=n?"third":"Third";break;case 4:r=n?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}var i=e+" failed: ";return i+=r+" argument "}t.CONSTANTS=i,t.Deferred=h,t.ErrorFactory=m,t.FirebaseError=f,t.Sha1=w,t.assert=o,t.assertionError=a,t.async=function(e,t){return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];Promise.resolve(!0).then((function(){e.apply(void 0,n)})).catch((function(e){t&&t(e)}))}},t.base64=u,t.base64Decode=c,t.base64Encode=function(e){var t=s(e);return u.encodeByteArray(t,!0)},t.contains=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.createSubscribe=function(e,t){var n=new _(e,t);return n.subscribe.bind(n)},t.decode=b,t.deepCopy=function(e){return l(void 0,e)},t.deepExtend=l,t.errorPrefix=T,t.getUA=d,t.isAdmin=function(e){var t=b(e).claims;return"object"==typeof t&&!0===t.admin},t.isBrowser=function(){return"object"==typeof self&&self.self===self},t.isEmpty=function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},t.isMobileCordova=function(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())},t.isNode=function(){try{return"[object process]"===Object.prototype.toString.call(e.process)}catch(t){return!1}},t.isNodeSdk=function(){return!0===i.NODE_CLIENT||!0===i.NODE_ADMIN},t.isReactNative=function(){return"object"==typeof navigator&&"ReactNative"===navigator.product},t.isValidFormat=function(e){var t=b(e).claims;return!!t&&"object"==typeof t&&t.hasOwnProperty("iat")},t.isValidTimestamp=function(e){var t=b(e).claims,n=Math.floor((new Date).getTime()/1e3),r=0,i=0;return"object"==typeof t&&(t.hasOwnProperty("nbf")?r=t.nbf:t.hasOwnProperty("iat")&&(r=t.iat),i=t.hasOwnProperty("exp")?t.exp:r+86400),!!n&&!!r&&!!i&&n>=r&&n<=i},t.issuedAtTime=function(e){var t=b(e).claims;return"object"==typeof t&&t.hasOwnProperty("iat")?t.iat:null},t.jsonEval=y,t.map=function(e,t,n){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t.call(n,e[i],i,e));return r},t.querystring=function(e){for(var t=[],n=function(e,n){Array.isArray(n)?n.forEach((function(n){t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))})):t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))},r=0,i=Object.entries(e);r<i.length;r++){var o=i[r];n(o[0],o[1])}return t.length?"&"+t.join("&"):""},t.querystringDecode=function(e){var t={};return e.replace(/^\?/,"").split("&").forEach((function(e){if(e){var n=e.split("=");t[n[0]]=n[1]}})),t},t.safeGet=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0},t.stringLength=function(e){for(var t=0,n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t++:r<2048?t+=2:r>=55296&&r<=56319?(t+=4,n++):t+=3}return t},t.stringToByteArray=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var i=e.charCodeAt(r);if(i>=55296&&i<=56319){var a=i-55296;r++,o(r<e.length,"Surrogate pair missing trail surrogate."),i=65536+(a<<10)+(e.charCodeAt(r)-56320)}i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):i<65536?(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},t.stringify=function(e){return JSON.stringify(e)},t.validateArgCount=function(e,t,n,r){var i;if(r<t?i="at least "+t:r>n&&(i=0===n?"none":"no more than "+n),i)throw new Error(e+" failed: Was called with "+r+(1===r?" argument.":" arguments.")+" Expects "+i+".")},t.validateCallback=function(e,t,n,r){if((!r||n)&&"function"!=typeof n)throw new Error(T(e,t,r)+"must be a valid function.")},t.validateContextObject=function(e,t,n,r){if((!r||n)&&("object"!=typeof n||null===n))throw new Error(T(e,t,r)+"must be a valid context object.")},t.validateNamespace=function(e,t,n,r){if((!r||n)&&"string"!=typeof n)throw new Error(T(e,t,r)+"must be a valid firebase namespace.")}}).call(this,n("yLpj"))}}]);
//# sourceMappingURL=component---src-pages-collaboration-text-js-393253c2b7fe72919d8d.js.map